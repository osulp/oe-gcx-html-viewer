require({cache:{"Mapping/modules/Markers/Marker":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"Mapping/modules/Markers/MarkersModule":function(){var i,d=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});define(["require","exports","geocortex/framework/application/ModuleBase","geocortex/framework/utils/ArrayUtils","geocortex/framework/utils/utils","geocortex/infrastructure/GeometryUtils","geocortex/infrastructure/MatrixUtils","geocortex/essentials/utilities/GraphicsLayerUtilities","geocortex/infrastructure/GraphicsLayerUtils","geocortex/infrastructure/GraphicsLayerIds"],function(e,t,r,i,h,a,u,n,s,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var p,c=(p=r.ModuleBase,d(l,p),l.prototype.initialize=function(e){p.prototype.initialize.call(this,e),e.markers&&(this._markerConfigurations=e.markers)},l.prototype._registerCommandsAndEvents=function(){this.app.command("ShowMarkers").register(this,this._executeShowMarkers),this.app.command("HideMarkers").register(this,this._executeHideMarkers),this.app.command("AddMarker").register(this,this._executeAddMarker),this.app.command("UpdateMarker").register(this,this._executeUpdateMarker),this.app.command("RemoveMarker").register(this,this._executeRemoveMarker)},l.prototype._executeShowMarkers=function(e){this._setMarkersVisibility(!0,e||l.MARKER_GRAPHICS_LAYER_ID)},l.prototype._executeHideMarkers=function(e){this._setMarkersVisibility(!1,e||l.MARKER_GRAPHICS_LAYER_ID)},l.prototype._executeAddMarker=function(t){if("string"==typeof t){var e=i.firstOrDefault(this._markerConfigurations,function(e){return e.id===t});if(!e)return void this.app.trace.warning("Could not find marker with ID '{0}'.".format(t));this._addMarker(e)}else this._addMarker(t)},l.prototype._executeUpdateMarker=function(e){var t=this._getMarkerById(e.id);if(t){if(e.iconUri){if(!e.iconWidth||!e.iconHeight)return void this.app.trace.warning("Could not update the marker symbol because the required 'iconWidth' and 'iconHeight' was not supplied.");var r=new esri.symbol.PictureMarkerSymbol(e.iconUri,e.iconWidth,e.iconHeight);if(!r)return void this.app.trace.warning("Could not update the marker symbol. Invalid icon configuration.");t.graphic.setSymbol(r)}if(e.symbolJson){var i=esri.symbol.fromJson(e.symbolJson);if(!i)return void this.app.trace.warning("Could not update the marker symbol. Invalid json object.");t.graphic.setSymbol(i)}e.center&&this._updateGraphicCenter(t.graphic,e.center),e.geometry&&t.graphic.setGeometry(e.geometry);var a=this._getEsriMarkerSymbol(t.graphic);if(!h.isNullOrUndefined(e.angle)&&a)if(t===this._selectedMarker&&e.angle!=a.angle){var o=this._getGraphicCenter(t.graphic),n=this._moveable.shape,s=n.getTransform(),p=this._calculateRotationMatrix(a.angle,o),c=dojox.gfx.matrix.translate(s.dx-p.dx,s.dy-p.dy),l=this._calculateRotationMatrix(e.angle,o);l.dx=l.dx+c.dx,l.dy=l.dy+c.dy,a.setAngle(e.angle),n.setTransform(l)}else a.setAngle(e.angle),t.graphic.setSymbol(a);null!=e.visible&&(t.graphic.visible=e.visible),null!=e.draggable&&(t.draggable=e.draggable),this.app.event("MarkerUpdatedEvent").publish(t.graphic)}else this.app.trace.warning("Could not find marker with ID '{0}'.".format(e.id))},l.prototype._executeRemoveMarker=function(e){var t=this._getMarkerById(e);if(t){var r=this._getMarkersLayer(t.graphicsLayerId?t.graphicsLayerId:l.MARKER_GRAPHICS_LAYER_ID);t.graphic&&r.remove(t.graphic);var i=this._activeMarkers.indexOf(t);i<0||this._activeMarkers.splice(i,1)}else this.app.trace.warning("Could not find marker with ID '{0}'.".format(e))},l.prototype._setMarkersVisibility=function(e,t){this._getMarkersLayer(t||l.MARKER_GRAPHICS_LAYER_ID).setVisibility(e)},l.prototype._addMarker=function(t){var e;if(0<this._activeMarkers.filter(function(e){return e.id===t.id}).length&&(this.app.trace.warning("Removing previous marker with ID '{0}'. ".format(t.id)),this._executeRemoveMarker(t.id)),t.symbolJson)e=esri.symbol.fromJson(t.symbolJson);else if(t.iconUri){if(!t.iconWidth||!t.iconHeight)return void this.app.trace.warning("Could not create the marker symbol because the required 'iconWidth' and 'iconHeight' was not supplied.");e=new esri.symbol.PictureMarkerSymbol(t.iconUri,t.iconWidth,t.iconHeight)}if(e){var r=t.geometry||t.center;!r||r instanceof esri.geometry.Geometry||(r=esri.geometry.fromJson(r)),r=r||this._map.extent.getCenter();var i={};i[l.MARKER_ATTRIBUTE_ID]=t.id;var a=new esri.Graphic(r,e,i),o=t.graphicsLayerId?t.graphicsLayerId:l.MARKER_GRAPHICS_LAYER_ID;o!==l.MARKER_GRAPHICS_LAYER_ID&&n.addToGraphicsLayerIdsToExclude([s.ExcludeFromEnum.ExportApplyStateName,s.ExcludeFromEnum.ExportMapTaskName,s.ExcludeFromEnum.WebMapName],o),this._getMarkersLayer(o).add(a),this._activeMarkers.push({id:t.id,draggable:!1!==t.draggable,graphic:a,graphicsLayerId:o})}else this.app.trace.warning("Could not create the marker symbol.")},l.prototype._getGraphicCenter=function(e){return a.getMiddle(e.geometry)},l.prototype._updateGraphicCenter=function(e,t){var r=this._map.toScreen(this._getGraphicCenter(e)),i=this._map.toScreen(t),a=i.x-r.x,o=i.y-r.y;this._updateGraphicPosition(e,a,o)},l.prototype._updateGraphicPosition=function(e,t,r){if(e)switch(e.geometry.type){case"point":var i=e.geometry;i=this._offsetPoint(i,t,r),e.setGeometry(i);break;case"multipoint":for(var a=e.geometry,o=0;o<a.points.length;o++){var n=a.getPoint(o);n=this._offsetPoint(n,t,r),a.setPoint(o,n)}e.setGeometry(a);break;case"polyline":case"polygon":var s=u.MatrixUtils.translate(e.geometry,this._map,t,r);e.setGeometry(s.geometry);break;case"extent":var p=e.geometry,c=p.getCenter(),l=this._offsetPoint(c,t,r),h=l.x-c.x,d=l.y-c.y;p.xmin+=h,p.ymin+=d,p.xmax+=h,p.ymax+=d,e.setGeometry(p)}},l.prototype._offsetPoint=function(e,t,r){var i=this._map.toScreen(e);return this._map.toMap(i.offset(t,r))},l.prototype._getMarkersLayer=function(e){return this._markersLayer=this.app.map.getLayer(e),this._markersLayer||(this._markersLayer=s.getInternalGraphicsLayer(o.MARKER_GRAPHICS_LAYER_ID,this.app,s.GraphicsLayerType.Pushpin),this._attachEventHandlers(this._markersLayer)),this._markersLayer},l.prototype._attachEventHandlers=function(e){var i=this;dojo.on(e,"click",function(e){i.app.event("MarkerClickedEvent").publish(i._getPointerEventFromAGSMouseEvent(e)),"function"==typeof e.preventDefault&&"function"==typeof e.stopPropagation&&(e.preventDefault(),e.stopPropagation())}),dojo.on(e,"mouse-down",function(e){var t=i._getPointerEventFromAGSMouseEvent(e);i.app.event("MarkerPointerDownEvent").publish(t);var r=i._getMarkerById(t.id);r.draggable&&i._handleMarkerDragStart(r,e)}),dojo.on(e,"mouse-up",function(e){i.app.event("MarkerPointerUpEvent").publish(i._getPointerEventFromAGSMouseEvent(e))})},l.prototype._getPointerEventFromAGSMouseEvent=function(e){var t=e.graphic.attributes[l.MARKER_ATTRIBUTE_ID];return{id:t,graphic:this._getMarkerById(t).graphic,mapPoint:e.mapPoint,screenPoint:e.screenPoint,button:e.button}},l.prototype._handleMarkerDragStart=function(e,t){var r=this;if(e.draggable){var i=e.graphic.getShape();this._moveable=new dojox.gfx.Moveable(i),this._selectedMarker=e,this._map.disableMapNavigation();var a=this._getGraphicCenter(e.graphic);this._moveable.mover=new dojox.gfx.Mover(this._moveable.shape,t,this._moveable),this._dragOffset={x:t.screenPoint.x-this._moveable.mover.lastX,y:t.screenPoint.y-this._moveable.mover.lastY,initialCenter:a},this._moveable.onMoved=function(e){r._onMoveableMoved(e)},this._moveable.onMoveStop=function(e){r._onMoveableMoveStop(e)},this.app.event("MarkerDragStartEvent").publish({id:e.id,centerPoint:a,mapPoint:t.mapPoint,screenPoint:t.screenPoint})}},l.prototype._onMoveableMoved=function(e){this.app.event("MarkerDragEvent").publish(this._getDragEventFromMover(e))},l.prototype._onMoveableMoveStop=function(e){if(e&&this._selectedMarker&&this._moveable){var t=this._getDragEventFromMover(e),r=this._getGraphicCenter(this._selectedMarker.graphic),i=this._dragOffset.initialCenter,a=e.shape,o=a.getTransform(),n=this._getEsriMarkerSymbol(this._selectedMarker.graphic);if(n&&0!==n.angle){var s=this._calculateRotationMatrix(n.angle,r);o.dx=o.dx-s.dx,o.dy=o.dy-s.dy,a.setTransform(s)}else a.setTransform(null);r.x==i.x&&r.y==i.y&&this._updateGraphicPosition(this._selectedMarker.graphic,o.dx,o.dy),this.app.event("MarkerDragEndEvent").publish(t),this._map.enableMapNavigation(),this._selectedMarker=null,this._moveable.destroy(),this._moveable=null}},l.prototype._getDragEventFromMover=function(e){var t=this._getGraphicCenter(this._selectedMarker.graphic),r=0,i=0;this._dragOffset&&(r=this._dragOffset.x,i=this._dragOffset.y);var a=new esri.geometry.ScreenPoint(e.lastX+r,e.lastY+i),o=this._map.toMap(a);return{id:this._selectedMarker.id,centerPoint:t,mapPoint:o,screenPoint:a}},l.prototype._getMarkerById=function(t){var e=i.firstOrDefault(this._activeMarkers,function(e){return e.id===t});return e||(this.app.trace.warning("Could not find marker with ID '{0}'.".format(t)),null)},l.prototype._calculateRotationMatrix=function(e,t){var r=this.app.map.toScreen(t);return dojox.gfx.matrix.rotategAt(e,r.x,r.y)},l.prototype._getEsriMarkerSymbol=function(e){return e.symbol instanceof esri.symbol.MarkerSymbol?e.symbol:null},l.MARKER_ATTRIBUTE_ID="id",l.MARKER_GRAPHICS_LAYER_ID=o.MARKER_GRAPHICS_LAYER_ID,l);function l(e,t){var r=p.call(this,e,t)||this;return r._markersLayer=null,r._markerConfigurations=[],r._activeMarkers=[],r._selectedMarker=null,r._moveable=null,r.app.map?r._map=r.app.map:r.app.eventRegistry.event("MapLoadedEvent").once(r,function(){r._map=r.app.map}),r._registerCommandsAndEvents(),r}t.MarkersModule=c})},"Mapping/modules/Markers/MarkersModuleConfig":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})}}}),require({cache:{}}),define(["Mapping/modules/Markers/MarkersModule"],function(e){!function(e,t,r){if("string"==typeof e&&(r=t,t=e),void 0!==r)for(var i=t.split("."),a=null,o=window,n=0,s=i.length;n<s;n++)a=i[n],n==s-1?o[a]=r:o[a]||(o[a]={}),o=o[a];else console.warn("Undefined shim for: "+t)}(e,"geocortex.essentialsHtmlViewer.mapping.modules.markers.MarkersModule",e.MarkersModule)});