function shim(e,t,r){if("string"==typeof e&&(r=t,t=e),"undefined"==typeof r)return void console.warn("Undefined shim for: "+t);for(var i=t.split("."),a=null,o=window,n=0,s=i.length;n<s;n++)a=i[n],n==s-1?o[a]=r:o[a]||(o[a]={}),o=o[a]}require({cache:{"Mapping/modules/Markers/Marker":function(){define(["require","exports"],function(e,t){"use strict"})},"Mapping/modules/Markers/MarkersModule":function(){define(["require","exports","geocortex/framework/application/ModuleBase","geocortex/framework/utils/ArrayUtils","geocortex/framework/utils/utils","geocortex/infrastructure/GeometryUtils","geocortex/infrastructure/MatrixUtils","geocortex/essentials/utilities/GraphicsLayerUtilities","geocortex/infrastructure/GraphicsLayerUtils","geocortex/infrastructure/GraphicsLayerIds"],function(e,t,r,i,a,o,n,s,p,c){"use strict";var h=function(e){function t(t,r){var i=e.call(this,t,r)||this;return i._markersLayer=null,i._markerConfigurations=[],i._activeMarkers=[],i._selectedMarker=null,i._moveable=null,i.app.map?i._map=i.app.map:i.app.eventRegistry.event("MapLoadedEvent").once(i,function(){i._map=i.app.map}),i._registerCommandsAndEvents(),i}return __extends(t,e),t.prototype.initialize=function(t){e.prototype.initialize.call(this,t),t.markers&&(this._markerConfigurations=t.markers)},t.prototype._registerCommandsAndEvents=function(){this.app.command("ShowMarkers").register(this,this._executeShowMarkers),this.app.command("HideMarkers").register(this,this._executeHideMarkers),this.app.command("AddMarker").register(this,this._executeAddMarker),this.app.command("UpdateMarker").register(this,this._executeUpdateMarker),this.app.command("RemoveMarker").register(this,this._executeRemoveMarker)},t.prototype._executeShowMarkers=function(e){this._setMarkersVisibility(!0,e?e:t.MARKER_GRAPHICS_LAYER_ID)},t.prototype._executeHideMarkers=function(e){this._setMarkersVisibility(!1,e?e:t.MARKER_GRAPHICS_LAYER_ID)},t.prototype._executeAddMarker=function(e){if("string"==typeof e){var t=i.firstOrDefault(this._markerConfigurations,function(t){return t.id===e});if(!t)return void this.app.trace.warning("Could not find marker with ID '{0}'.".format(e));this._addMarker(t)}else this._addMarker(e)},t.prototype._executeUpdateMarker=function(e){var t=this._getMarkerById(e.id);if(!t)return void this.app.trace.warning("Could not find marker with ID '{0}'.".format(e.id));if(e.iconUri){if(!e.iconWidth||!e.iconHeight)return void this.app.trace.warning("Could not update the marker symbol because the required 'iconWidth' and 'iconHeight' was not supplied.");var r=new esri.symbol.PictureMarkerSymbol(e.iconUri,e.iconWidth,e.iconHeight);if(!r)return void this.app.trace.warning("Could not update the marker symbol. Invalid icon configuration.");t.graphic.setSymbol(r)}if(e.symbolJson){var i=esri.symbol.fromJson(e.symbolJson);if(!i)return void this.app.trace.warning("Could not update the marker symbol. Invalid json object.");t.graphic.setSymbol(i)}e.center&&this._updateGraphicCenter(t.graphic,e.center),e.geometry&&t.graphic.setGeometry(e.geometry);var o=this._getEsriMarkerSymbol(t.graphic);if(!a.isNullOrUndefined(e.angle)&&o)if(t===this._selectedMarker&&e.angle!=o.angle){var n=this._getGraphicCenter(t.graphic),s=this._moveable.shape,p=s.getTransform(),c=this._calculateRotationMatrix(o.angle,n),h=dojox.gfx.matrix.translate(p.dx-c.dx,p.dy-c.dy),l=this._calculateRotationMatrix(e.angle,n);l.dx=l.dx+h.dx,l.dy=l.dy+h.dy,o.setAngle(e.angle),s.setTransform(l)}else o.setAngle(e.angle),t.graphic.setSymbol(o);null!=e.visible&&(t.graphic.visible=e.visible),null!=e.draggable&&(t.draggable=e.draggable),this.app.event("MarkerUpdatedEvent").publish(t.graphic)},t.prototype._executeRemoveMarker=function(e){var r=this._getMarkerById(e);if(!r)return void this.app.trace.warning("Could not find marker with ID '{0}'.".format(e));var i=this._getMarkersLayer(r.graphicsLayerId?r.graphicsLayerId:t.MARKER_GRAPHICS_LAYER_ID);r.graphic&&i.remove(r.graphic);var a=this._activeMarkers.indexOf(r);a<0||this._activeMarkers.splice(a,1)},t.prototype._setMarkersVisibility=function(e,r){this._getMarkersLayer(r?r:t.MARKER_GRAPHICS_LAYER_ID).setVisibility(e)},t.prototype._addMarker=function(e){this._activeMarkers.filter(function(t){return t.id===e.id}).length>0&&(this.app.trace.warning("Removing previous marker with ID '{0}'. ".format(e.id)),this._executeRemoveMarker(e.id));var r;if(e.symbolJson)r=esri.symbol.fromJson(e.symbolJson);else if(e.iconUri){if(!e.iconWidth||!e.iconHeight)return void this.app.trace.warning("Could not create the marker symbol because the required 'iconWidth' and 'iconHeight' was not supplied.");r=new esri.symbol.PictureMarkerSymbol(e.iconUri,e.iconWidth,e.iconHeight)}if(!r)return void this.app.trace.warning("Could not create the marker symbol.");var i=e.geometry||e.center;!i||i instanceof esri.geometry.Geometry||(i=esri.geometry.fromJson(i)),i||(i=this._map.extent.getCenter());var a={};a[t.MARKER_ATTRIBUTE_ID]=e.id;var o=new esri.Graphic(i,r,a),n=e.graphicsLayerId?e.graphicsLayerId:t.MARKER_GRAPHICS_LAYER_ID;n!==t.MARKER_GRAPHICS_LAYER_ID&&s.addToGraphicsLayerIdsToExclude([p.ExcludeFromEnum.ExportApplyStateName,p.ExcludeFromEnum.ExportMapTaskName,p.ExcludeFromEnum.WebMapName],n),this._getMarkersLayer(n).add(o),this._activeMarkers.push({id:e.id,draggable:e.draggable!==!1,graphic:o,graphicsLayerId:n})},t.prototype._getGraphicCenter=function(e){return o.getMiddle(e.geometry)},t.prototype._updateGraphicCenter=function(e,t){var r=this._map.toScreen(this._getGraphicCenter(e)),i=this._map.toScreen(t),a=i.x-r.x,o=i.y-r.y;this._updateGraphicPosition(e,a,o)},t.prototype._updateGraphicPosition=function(e,t,r){if(e)switch(e.geometry.type){case"point":var i=e.geometry;i=this._offsetPoint(i,t,r),e.setGeometry(i);break;case"multipoint":for(var a=e.geometry,o=0;o<a.points.length;o++){var s=a.getPoint(o);s=this._offsetPoint(s,t,r),a.setPoint(o,s)}e.setGeometry(a);break;case"polyline":case"polygon":var p=n.MatrixUtils.translate(e.geometry,this._map,t,r);e.setGeometry(p.geometry);break;case"extent":var c=e.geometry,h=c.getCenter(),l=this._offsetPoint(h,t,r),d=l.x-h.x,u=l.y-h.y;c.xmin+=d,c.ymin+=u,c.xmax+=d,c.ymax+=u,e.setGeometry(c)}},t.prototype._offsetPoint=function(e,t,r){var i=this._map.toScreen(e);return this._map.toMap(i.offset(t,r))},t.prototype._getMarkersLayer=function(e){return this._markersLayer=this.app.map.getLayer(e),this._markersLayer||(this._markersLayer=p.getInternalGraphicsLayer(c.MARKER_GRAPHICS_LAYER_ID,this.app,p.GraphicsLayerType.Pushpin),this._attachEventHandlers(this._markersLayer)),this._markersLayer},t.prototype._attachEventHandlers=function(e){var t=this;dojo.on(e,"click",function(e){t.app.event("MarkerClickedEvent").publish(t._getPointerEventFromAGSMouseEvent(e)),"function"==typeof e.preventDefault&&"function"==typeof e.stopPropagation&&(e.preventDefault(),e.stopPropagation())}),dojo.on(e,"mouse-down",function(e){var r=t._getPointerEventFromAGSMouseEvent(e);t.app.event("MarkerPointerDownEvent").publish(r);var i=t._getMarkerById(r.id);i.draggable&&t._handleMarkerDragStart(i,e)}),dojo.on(e,"mouse-up",function(e){t.app.event("MarkerPointerUpEvent").publish(t._getPointerEventFromAGSMouseEvent(e))})},t.prototype._getPointerEventFromAGSMouseEvent=function(e){var r=e.graphic.attributes[t.MARKER_ATTRIBUTE_ID],i=this._getMarkerById(r),a={id:r,graphic:i.graphic,mapPoint:e.mapPoint,screenPoint:e.screenPoint,button:e.button};return a},t.prototype._handleMarkerDragStart=function(e,t){var r=this;if(e.draggable){var i=e.graphic.getShape();this._moveable=new dojox.gfx.Moveable(i),this._selectedMarker=e,this._map.disableMapNavigation();var a=this._getGraphicCenter(e.graphic);this._moveable.mover=new dojox.gfx.Mover(this._moveable.shape,t,this._moveable),this._dragOffset={x:t.screenPoint.x-this._moveable.mover.lastX,y:t.screenPoint.y-this._moveable.mover.lastY,initialCenter:a},this._moveable.onMoved=function(e){r._onMoveableMoved(e)},this._moveable.onMoveStop=function(e){r._onMoveableMoveStop(e)},this.app.event("MarkerDragStartEvent").publish({id:e.id,centerPoint:a,mapPoint:t.mapPoint,screenPoint:t.screenPoint})}},t.prototype._onMoveableMoved=function(e){this.app.event("MarkerDragEvent").publish(this._getDragEventFromMover(e))},t.prototype._onMoveableMoveStop=function(e){var t=this._getDragEventFromMover(e),r=this._getGraphicCenter(this._selectedMarker.graphic),i=this._dragOffset.initialCenter,a=e.shape,o=a.getTransform(),n=this._getEsriMarkerSymbol(this._selectedMarker.graphic);if(n&&0!==n.angle){var s=this._calculateRotationMatrix(n.angle,r);o.dx=o.dx-s.dx,o.dy=o.dy-s.dy,a.setTransform(s)}else a.setTransform(null);r.x==i.x&&r.y==i.y&&this._updateGraphicPosition(this._selectedMarker.graphic,o.dx,o.dy),this.app.event("MarkerDragEndEvent").publish(t),this._map.enableMapNavigation(),this._selectedMarker=null,this._moveable.destroy(),this._moveable=null},t.prototype._getDragEventFromMover=function(e){var t=this._getGraphicCenter(this._selectedMarker.graphic),r=0,i=0;this._dragOffset&&(r=this._dragOffset.x,i=this._dragOffset.y);var a=new esri.geometry.ScreenPoint(e.lastX+r,e.lastY+i),o=this._map.toMap(a),n={id:this._selectedMarker.id,centerPoint:t,mapPoint:o,screenPoint:a};return n},t.prototype._getMarkerById=function(e){var t=i.firstOrDefault(this._activeMarkers,function(t){return t.id===e});return t?t:(this.app.trace.warning("Could not find marker with ID '{0}'.".format(e)),null)},t.prototype._calculateRotationMatrix=function(e,t){var r=this.app.map.toScreen(t);return dojox.gfx.matrix.rotategAt(e,r.x,r.y)},t.prototype._getEsriMarkerSymbol=function(e){return e.symbol instanceof esri.symbol.MarkerSymbol?e.symbol:null},t}(r.ModuleBase);h.MARKER_ATTRIBUTE_ID="id",h.MARKER_GRAPHICS_LAYER_ID=c.MARKER_GRAPHICS_LAYER_ID,t.MarkersModule=h})},"Mapping/modules/Markers/MarkersModuleConfig":function(){define(["require","exports"],function(e,t){"use strict"})}}}),define(["Mapping/modules/Markers/MarkersModule"],function(e){shim(e,"geocortex.essentialsHtmlViewer.mapping.modules.markers.MarkersModule",e.MarkersModule)});