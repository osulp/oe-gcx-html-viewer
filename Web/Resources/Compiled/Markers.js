!function(){require({cache:{"Mapping/modules/Markers/Marker":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"Mapping/modules/Markers/MarkersModule":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();define(["require","exports","geocortex/framework/application/ModuleBase","geocortex/framework/utils/ArrayUtils","geocortex/framework/utils/utils","geocortex/infrastructure/GeometryUtils","geocortex/infrastructure/MatrixUtils","geocortex/essentials/utilities/GraphicsLayerUtilities","geocortex/infrastructure/GraphicsLayerUtils","geocortex/infrastructure/GraphicsLayerIds"],function(t,r,i,a,o,n,s,p,c,l){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var h=function(t){function r(e,r){var i=t.call(this,e,r)||this;return i._markersLayer=null,i._markerConfigurations=[],i._activeMarkers=[],i._selectedMarker=null,i._moveable=null,i.app.map?i._map=i.app.map:i.app.eventRegistry.event("MapLoadedEvent").once(i,function(){i._map=i.app.map}),i._registerCommandsAndEvents(),i}return e(r,t),r.prototype.initialize=function(e){t.prototype.initialize.call(this,e),e.markers&&(this._markerConfigurations=e.markers)},r.prototype._registerCommandsAndEvents=function(){this.app.command("ShowMarkers").register(this,this._executeShowMarkers),this.app.command("HideMarkers").register(this,this._executeHideMarkers),this.app.command("AddMarker").register(this,this._executeAddMarker),this.app.command("UpdateMarker").register(this,this._executeUpdateMarker),this.app.command("RemoveMarker").register(this,this._executeRemoveMarker)},r.prototype._executeShowMarkers=function(e){this._setMarkersVisibility(!0,e||r.MARKER_GRAPHICS_LAYER_ID)},r.prototype._executeHideMarkers=function(e){this._setMarkersVisibility(!1,e||r.MARKER_GRAPHICS_LAYER_ID)},r.prototype._executeAddMarker=function(e){if("string"==typeof e){var t=a.firstOrDefault(this._markerConfigurations,function(t){return t.id===e});if(!t)return void this.app.trace.warning("Could not find marker with ID '{0}'.".format(e));this._addMarker(t)}else this._addMarker(e)},r.prototype._executeUpdateMarker=function(e){var t=this._getMarkerById(e.id);if(t){if(e.iconUri){if(!e.iconWidth||!e.iconHeight)return void this.app.trace.warning("Could not update the marker symbol because the required 'iconWidth' and 'iconHeight' was not supplied.");var r=new esri.symbol.PictureMarkerSymbol(e.iconUri,e.iconWidth,e.iconHeight);if(!r)return void this.app.trace.warning("Could not update the marker symbol. Invalid icon configuration.");t.graphic.setSymbol(r)}if(e.symbolJson){var i=esri.symbol.fromJson(e.symbolJson);if(!i)return void this.app.trace.warning("Could not update the marker symbol. Invalid json object.");t.graphic.setSymbol(i)}e.center&&this._updateGraphicCenter(t.graphic,e.center),e.geometry&&t.graphic.setGeometry(e.geometry);var a=this._getEsriMarkerSymbol(t.graphic);if(!o.isNullOrUndefined(e.angle)&&a)if(t===this._selectedMarker&&e.angle!=a.angle){var n=this._getGraphicCenter(t.graphic),s=this._moveable.shape,p=s.getTransform(),c=this._calculateRotationMatrix(a.angle,n),l=dojox.gfx.matrix.translate(p.dx-c.dx,p.dy-c.dy),h=this._calculateRotationMatrix(e.angle,n);h.dx=h.dx+l.dx,h.dy=h.dy+l.dy,a.setAngle(e.angle),s.setTransform(h)}else a.setAngle(e.angle),t.graphic.setSymbol(a);null!=e.visible&&(t.graphic.visible=e.visible),null!=e.draggable&&(t.draggable=e.draggable),this.app.event("MarkerUpdatedEvent").publish(t.graphic)}else this.app.trace.warning("Could not find marker with ID '{0}'.".format(e.id))},r.prototype._executeRemoveMarker=function(e){var t=this._getMarkerById(e);if(t){var i=this._getMarkersLayer(t.graphicsLayerId?t.graphicsLayerId:r.MARKER_GRAPHICS_LAYER_ID);t.graphic&&i.remove(t.graphic);var a=this._activeMarkers.indexOf(t);a<0||this._activeMarkers.splice(a,1)}else this.app.trace.warning("Could not find marker with ID '{0}'.".format(e))},r.prototype._setMarkersVisibility=function(e,t){this._getMarkersLayer(t||r.MARKER_GRAPHICS_LAYER_ID).setVisibility(e)},r.prototype._addMarker=function(e){this._activeMarkers.filter(function(t){return t.id===e.id}).length>0&&(this.app.trace.warning("Removing previous marker with ID '{0}'. ".format(e.id)),this._executeRemoveMarker(e.id));var t;if(e.symbolJson)t=esri.symbol.fromJson(e.symbolJson);else if(e.iconUri){if(!e.iconWidth||!e.iconHeight)return void this.app.trace.warning("Could not create the marker symbol because the required 'iconWidth' and 'iconHeight' was not supplied.");t=new esri.symbol.PictureMarkerSymbol(e.iconUri,e.iconWidth,e.iconHeight)}if(t){var i=e.geometry||e.center;!i||i instanceof esri.geometry.Geometry||(i=esri.geometry.fromJson(i)),i||(i=this._map.extent.getCenter());var a={};a[r.MARKER_ATTRIBUTE_ID]=e.id;var o=new esri.Graphic(i,t,a),n=e.graphicsLayerId?e.graphicsLayerId:r.MARKER_GRAPHICS_LAYER_ID;n!==r.MARKER_GRAPHICS_LAYER_ID&&p.addToGraphicsLayerIdsToExclude([c.ExcludeFromEnum.ExportApplyStateName,c.ExcludeFromEnum.ExportMapTaskName,c.ExcludeFromEnum.WebMapName],n),this._getMarkersLayer(n).add(o),this._activeMarkers.push({id:e.id,draggable:!1!==e.draggable,graphic:o,graphicsLayerId:n})}else this.app.trace.warning("Could not create the marker symbol.")},r.prototype._getGraphicCenter=function(e){return n.getMiddle(e.geometry)},r.prototype._updateGraphicCenter=function(e,t){var r=this._map.toScreen(this._getGraphicCenter(e)),i=this._map.toScreen(t),a=i.x-r.x,o=i.y-r.y;this._updateGraphicPosition(e,a,o)},r.prototype._updateGraphicPosition=function(e,t,r){if(e)switch(e.geometry.type){case"point":var i=e.geometry;i=this._offsetPoint(i,t,r),e.setGeometry(i);break;case"multipoint":for(var a=e.geometry,o=0;o<a.points.length;o++){var n=a.getPoint(o);n=this._offsetPoint(n,t,r),a.setPoint(o,n)}e.setGeometry(a);break;case"polyline":case"polygon":var p=s.MatrixUtils.translate(e.geometry,this._map,t,r);e.setGeometry(p.geometry);break;case"extent":var c=e.geometry,l=c.getCenter(),h=this._offsetPoint(l,t,r),d=h.x-l.x,u=h.y-l.y;c.xmin+=d,c.ymin+=u,c.xmax+=d,c.ymax+=u,e.setGeometry(c)}},r.prototype._offsetPoint=function(e,t,r){var i=this._map.toScreen(e);return this._map.toMap(i.offset(t,r))},r.prototype._getMarkersLayer=function(e){return this._markersLayer=this.app.map.getLayer(e),this._markersLayer||(this._markersLayer=c.getInternalGraphicsLayer(l.MARKER_GRAPHICS_LAYER_ID,this.app,c.GraphicsLayerType.Pushpin),this._attachEventHandlers(this._markersLayer)),this._markersLayer},r.prototype._attachEventHandlers=function(e){var t=this;dojo.on(e,"click",function(e){t.app.event("MarkerClickedEvent").publish(t._getPointerEventFromAGSMouseEvent(e)),"function"==typeof e.preventDefault&&"function"==typeof e.stopPropagation&&(e.preventDefault(),e.stopPropagation())}),dojo.on(e,"mouse-down",function(e){var r=t._getPointerEventFromAGSMouseEvent(e);t.app.event("MarkerPointerDownEvent").publish(r);var i=t._getMarkerById(r.id);i.draggable&&t._handleMarkerDragStart(i,e)}),dojo.on(e,"mouse-up",function(e){t.app.event("MarkerPointerUpEvent").publish(t._getPointerEventFromAGSMouseEvent(e))})},r.prototype._getPointerEventFromAGSMouseEvent=function(e){var t=e.graphic.attributes[r.MARKER_ATTRIBUTE_ID];return{id:t,graphic:this._getMarkerById(t).graphic,mapPoint:e.mapPoint,screenPoint:e.screenPoint,button:e.button}},r.prototype._handleMarkerDragStart=function(e,t){var r=this;if(e.draggable){var i=e.graphic.getShape();this._moveable=new dojox.gfx.Moveable(i),this._selectedMarker=e,this._map.disableMapNavigation();var a=this._getGraphicCenter(e.graphic);this._moveable.mover=new dojox.gfx.Mover(this._moveable.shape,t,this._moveable),this._dragOffset={x:t.screenPoint.x-this._moveable.mover.lastX,y:t.screenPoint.y-this._moveable.mover.lastY,initialCenter:a},this._moveable.onMoved=function(e){r._onMoveableMoved(e)},this._moveable.onMoveStop=function(e){r._onMoveableMoveStop(e)},this.app.event("MarkerDragStartEvent").publish({id:e.id,centerPoint:a,mapPoint:t.mapPoint,screenPoint:t.screenPoint})}},r.prototype._onMoveableMoved=function(e){this.app.event("MarkerDragEvent").publish(this._getDragEventFromMover(e))},r.prototype._onMoveableMoveStop=function(e){if(e&&this._selectedMarker&&this._moveable){var t=this._getDragEventFromMover(e),r=this._getGraphicCenter(this._selectedMarker.graphic),i=this._dragOffset.initialCenter,a=e.shape,o=a.getTransform(),n=this._getEsriMarkerSymbol(this._selectedMarker.graphic);if(n&&0!==n.angle){var s=this._calculateRotationMatrix(n.angle,r);o.dx=o.dx-s.dx,o.dy=o.dy-s.dy,a.setTransform(s)}else a.setTransform(null);r.x==i.x&&r.y==i.y&&this._updateGraphicPosition(this._selectedMarker.graphic,o.dx,o.dy),this.app.event("MarkerDragEndEvent").publish(t),this._map.enableMapNavigation(),this._selectedMarker=null,this._moveable.destroy(),this._moveable=null}},r.prototype._getDragEventFromMover=function(e){var t=this._getGraphicCenter(this._selectedMarker.graphic),r=0,i=0;this._dragOffset&&(r=this._dragOffset.x,i=this._dragOffset.y);var a=new esri.geometry.ScreenPoint(e.lastX+r,e.lastY+i),o=this._map.toMap(a);return{id:this._selectedMarker.id,centerPoint:t,mapPoint:o,screenPoint:a}},r.prototype._getMarkerById=function(e){var t=a.firstOrDefault(this._activeMarkers,function(t){return t.id===e});return t||(this.app.trace.warning("Could not find marker with ID '{0}'.".format(e)),null)},r.prototype._calculateRotationMatrix=function(e,t){var r=this.app.map.toScreen(t);return dojox.gfx.matrix.rotategAt(e,r.x,r.y)},r.prototype._getEsriMarkerSymbol=function(e){return e.symbol instanceof esri.symbol.MarkerSymbol?e.symbol:null},r}(i.ModuleBase);h.MARKER_ATTRIBUTE_ID="id",h.MARKER_GRAPHICS_LAYER_ID=l.MARKER_GRAPHICS_LAYER_ID,r.MarkersModule=h})},"Mapping/modules/Markers/MarkersModuleConfig":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})}}}),require({cache:{}}),define(["Mapping/modules/Markers/MarkersModule"],function(e){!function(e,t,r){if("string"==typeof e&&(r=t,t=e),void 0!==r)for(var i=t.split("."),a=null,o=window,n=0,s=i.length;n<s;n++)a=i[n],n==s-1?o[a]=r:o[a]||(o[a]={}),o=o[a];else console.warn("Undefined shim for: "+t)}(e,"geocortex.essentialsHtmlViewer.mapping.modules.markers.MarkersModule",e.MarkersModule)})}();