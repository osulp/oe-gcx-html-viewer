!function(){var t="<input type='text' title='autocomplete' data-binding='{aria-label: @language-querybuilder-autocomplete-view}{@value: value}{@var: autoCompleteInput}{@event-focus: autoComplete_focus}{@event-blur: autoComplete_blur}' />",r="<div class='list-queries-view'>    <div class='panel-group panel-scroll-container no-item box-container' data-binding='{@hidden: queries}'>        <p data-binding='{@hidden: isFilterBuilder}{@text: @language-querybuilder-savedqueries-browse-no-items}'></p>        <p class='description' data-binding='{@hidden: isFilterBuilder}{@text: @language-querybuilder-savedqueries-browse-no-items-desc}'></p>        <p data-binding='{@visible: isFilterBuilder}{@text: @language-querybuilder-savedfilters-browse-no-items}'></p>        <p class='description' data-binding='{@visible: isFilterBuilder}{@text: @language-querybuilder-savedfilters-browse-no-items-desc}'></p>    </div>    <div class='results-list' data-binding='{@visible: queries}'>        <ul class='gcx-list-menu' data-binding='{@source: resultsPage}'>            <li class='gcx-list-item has-action-1 query-items' data-binding='{@template-for: resultsPage}'>                <button class='gcx-list-button' data-binding='{@disabled: disabled}{@event-click: handleQueryClick}'>                    <strong class='gcx-list-label' data-binding='{@text: displayName}'></strong>                    <span class='gcx-list-desc' data-binding='{@visible: adminDefined}{@text: @language-saved-admin-defined}'></span>                    <div class='gcx-list-desc'>                        <span data-binding='{@text: @language-querybuilder-layer-label}'></span>                        <span data-binding='{@source: layer}'>                            <span data-binding='{@template-for: layer}{@text: displayName}'></span>                        </span>                    </div>                    <div class='gcx-list-desc'>                        <span data-binding='{@text: @language-querybuilder-extent-label}'></span>                        <span data-binding='{@text: selectedSpatialFilterName}'></span>                    </div>                </button>                <button class='gcx-action-button icon chevron-right-24' data-binding='{title: @language-querybuilder-actions-tooltip}{@event-click: handleQueryActions}'></button>            </li>        </ul>    </div>    \x3c!-- BEGIN: Paging Controls --\x3e    <div class='paging-control has-pages' data-binding='{@visible: queries}{@widget: PagingControlsWidget}{@widget-context: @context}{@widget-required: false}'></div>    \x3c!-- END: Paging Controls --\x3e</div>",i="<div class='no-item' data-binding='{@hidden: visibleMenuItems}{@text: @language-menu-no-items}'></div><ul class='list-menu has-icon' data-binding='{@visible: visibleMenuItems}{@source: visibleMenuItems}'>    <li class='list-menu-item' data-binding='{@template-for: visibleMenuItems}'>        <button class='list-menu-button' data-binding='{@enabled: canExecute}{@event-onmouseover: getDescription}{@event-onclick: handleMenuItemClick}'>            <img class='list-menu-icon' data-binding='{src: iconUri}{@visible: iconUri}' alt=' ' />            <span class='list-menu-details'>                <strong class='list-menu-name' data-binding='{@text: text}'></strong>                <span class='list-menu-desc' data-binding='{@visible: description}{@text: description}'></span>            </span>        </button>    </li></ul>",a="<div class='save-selection-view'>    <label>        <span data-binding='{@text: @language-common-save-as}'></span>        <input type='text' data-binding='{@value: name}{title: @language-querybuilder-name-title}{@event-oninput: handleInputChanged}' />    </label>    <div class='form-validation' data-binding='{@visible: inputErrorMessage}'>        <span class='field-validation-error' data-binding='{@text: inputErrorMessage}'></span>    </div>    <div class='form-btns'>        <button class='button save-button' data-binding='{@event-click: handleSaveClick}{@text: @language-common-save}{@disabled: inputErrorMessage}'></button>        <button class='button cancel-button' data-binding='{@event-click: handleCancelClick}{@text: @language-common-cancel}'></button>    </div></div>",s="<div class='query-actions-widget' data-binding='{@disabled: isFilterBuilder}{@widget: QueryActionsWidget}{@widget-context: displayedQuery}{@widget-required: false}'    data-menu-template='Mapping/infrastructure/menus/MenuView.html'></div><div class='simple-query-builder'>    <div data-binding='{@hidden: noAvailableLayers}'>        <div class='query-builder-form gcx-sticky-content has-footer' data-binding='{@event-keydown: form_keydown}{@var: htmlForm}{@event-submit: form_submit}'>            <div class='form-item' data-binding='{@hidden: nestingLevelTooDeep}'>                <label>                    <span data-binding='{@text: @language-querybuilder-data-source}'></span>                    <select data-binding='{@value: selectedLayerUniqueId}'>                        <optgroup data-binding='{@visible: areQueryableLayers}{@source: layers}{label: @language-querybuilder-query-layers}'>                            <option data-binding='{@template-for: layers}{@text: displayName}{value: uniqueId}' />                        </optgroup>                        <optgroup data-binding='{@visible: areQueryableTables}{@source: tables}{label: @language-querybuilder-query-tables}'>                            <option data-binding='{@template-for: tables}{@text: displayName}{value: uniqueId}' />                        </optgroup>                    </select>                </label>            </div>            <div class='form-item' data-binding='{@hidden: selectedLayerIsTable}'>                <label>                    <span data-binding='{@text: @language-querybuilder-spatial-filter}'></span>                    <select data-binding='{@source: spatialFilters}{@value: selectedSpatialFilter}{@event-onchange: onFilterSelected}'>                        <option data-binding='{@template-for: spatialFilters}{@text: name}{value: val}' />                    </select>                </label>            </div>            <div data-binding='{@visible: filterAlreadyApplied}'>                <div data-binding='{@text: @language-querybuilder-filter-already-applied}'></div>            </div>            <div class='info-message' data-binding='{@visible: nestingLevelTooDeep}'>                <span data-binding='{@text: @language-querybuilder-nesting-level-too-deep}'></span>            </div>            <div class='query-conditions-area' data-binding='{@visible: notDisabled}'>                <div class='find-results' data-binding='{@text: infoText}'></div>                <div data-binding='{@source: displayedQuery}{@template: Mapping/modules/QueryBuilder/Templates/QueryBuilderRoot.html}'></div>            </div>            \x3c!-- For debugging --\x3e            <div class='clear' data-binding='{@visible: isDebug}'>                <h4>Debug</h4>                <hr />                <div data-binding='{@source: displayedQuery}'>                    <textarea data-binding='{@template-for: displayedQuery}{@value: _debugWhereClause}{@visible: isDebug}{aria-label: @language-querybuilder-debug-displayed-query-label}' style='width: 100%;'></textarea>\x3c!-- For debugging --\x3e                </div>            </div>        </div>        <div class='form-btns gcx-sticky-footer'>            <button class='jimu-btn button' data-binding='{@event-onclick: clearResultsButton_click}{@visible: isQueryAndAwab}{@text: @language-querybuilder-clear}'></button>            <button class='jimu-btn button' data-binding='{@event-onclick: clearFilterButton_click}{@visible: isFilterBuilder}{@text: @language-querybuilder-clear}'></button>            <button type='submit' class='jimu-btn button' data-binding='{@event-onclick: actionButton_click}{@visible: isQueryBuilder}{@text: @language-querybuilder-search}'></button>            <button type='submit' class='jimu-btn button' data-binding='{@event-onclick: actionButton_click}{@visible: isFilterBuilder}{@text: @language-querybuilder-filter}{@disabled: disabled}{@class-disabled: disabled}'></button>            <button class='jimu-btn button' data-binding='{@event-onclick: cancelButton_click}{@visible: isQueryBuilder}{@text: @language-querybuilder-cancel}'></button>            <button class='jimu-btn button' data-binding='{@event-onclick: cancelButton_click}{@visible: isFilterBuilder}{@text: @language-querybuilder-cancel}'></button>        </div>    </div>    <div data-binding='{@visible: noAvailableLayers}{@text: noAvailableLayersText}'></div>    <div class='autocomplete-container'></div></div>",n="<div class='query-item'>    <div class='query-item-inputs'>        <label class='query-row-input'>            <span class='hidden-label' data-binding='{@text: @language-querybuilder-select-filter-label}'></span>            <select data-binding='{@source: fields}{@value: selectedFieldName}{title: @language-querybuilder-select-filter}'>                <option data-binding='{@template-for: fields}{@text: alias}{value: name}' />            </select>        </label>        <label class='query-row-input'>            <span class='hidden-label' data-binding='{@text: @language-querybuilder-select-operator-label}'></span>            <select data-binding='{@source: operators}{@value: selectedOperator}{title: @language-querybuilder-select-operator}'>                <option data-binding='{@template-for: operators}{@text: name}{value: value}' />            </select>        </label>        <label class='query-row-input'>            <span class='hidden-label'>TestLabel</span>            <span class='auto-complete' data-binding='{@widget: AutoComplete}{@widget-context: @context}{@visible: showTextInput}'></span>            <span class='date-picker' data-binding='{@widget: DatePicker}{@widget-context: @context}{@visible: showDateTimeInput}'></span>            <select class='coded-value-picker value-selector' data-binding='{@visible: showCodedValueDomainInput}{@source: codedValues}{@value: codedDomainValue}{aria-label: @language-querybuilder-coded-value}'>                <option data-binding='{@template-for: codedValues}{@text: name}{value: val}' />            </select>            <input class='value-selector' disabled='disabled' type='text' data-binding='{@visible: showDisabledInput}{@class-disabled: showDisabledInput}{aria-label: @language-querybuilder-select-value}' />        </label>    </div>    <button class='query-row-delete' data-binding='{@event-onclick: removeQueryClause_click}{@class-disabled: deleteDisabled}{title: @language-common-delete}'></button></div><div class='conjunction' data-binding='{@hidden: isLast}'>    <div class='conjunction-text and' data-binding='{@text: @language-querybuilder-and}{@visible: isAnd}'></div>    <div class='conjunction-text or' data-binding='{@text: @language-querybuilder-or}{@visible: isOr}'></div></div>",o="<div class='query-subgroup'>    <div class='logical-operators' data-binding='{@var: radioButtons}'>        <label class='logical-operator-toggle'>            <input type='radio' value='and' data-binding='{name: radioButtonGroup}{@event-onchange: handleRadioClick}'/>            <span class='label' data-binding='{@text: @language-querybuilder-logical-toggle-and}'></span>        </label>        <label class='logical-operator-toggle'>            <input type='radio' value='or' data-binding='{name: radioButtonGroup}{@event-onchange: handleRadioClick}'/>            <span class='label' data-binding='{@text: @language-querybuilder-logical-toggle-or}'></span>        </label>    </div>    <ul class='query-group' data-binding='{@source: queryItems}{@template-selector: type}'>        <li data-binding='{@template-select: queryItem}{@template: Mapping/modules/QueryBuilder/Templates/QueryBuilderItem.html}'></li>        <li data-binding='{@template-select: queryGroup}{@template: Mapping/modules/QueryBuilder/Templates/QueryBuilderItemGroup.html}'></li>    </ul>    <ul class='add-buttons'>        <li>            <button class='text-button' data-binding='{@event-onclick: addQueryClause_click}{@text: @language-querybuilder-add-condition}'></button>        </li>        <li>            <button class='text-button' data-binding='{@hidden: hasParent}{@event-onclick: addNestedQuery_click}{@text: @language-querybuilder-add-subgroup}'></button>        </li>    </ul></div><div class='conjunction' data-binding='{@hidden: isLast}'>    <div class='conjunction-text and' data-binding='{@text: @language-querybuilder-and}{@visible: isAnd}'></div>    <div class='conjunction-text or' data-binding='{@text: @language-querybuilder-or}{@visible: isOr}'></div></div>",l="<div class='logical-operators main-level-toggle' role='radiogroup' data-binding='{aria-label: @language-querybuilder-radio-group-label}@var: radioButtons}'>     <label class='logical-operator-toggle'>        <input type='radio' value='and' data-binding='{name: radioButtonGroup}{@event-onchange: handleRadioClick}' />        <span class='label' data-binding='{@text: @language-querybuilder-logical-toggle-and}'></span>    </label>    <label class='logical-operator-toggle'>        <input type='radio' value='or' data-binding='{name: radioButtonGroup}{@event-onchange: handleRadioClick}' />        <span class='label' data-binding='{@text: @language-querybuilder-logical-toggle-or}'></span>    </label></div><ul class='query-group main-level-group' data-binding='{@source: queryItems}{@template-selector: type}'>    <li class='query-item' data-binding='{@template-select: queryItem}{@template: Mapping/modules/QueryBuilder/Templates/QueryBuilderItem.html}'></li>    <li data-binding='{@template-select: queryGroup}{@template: Mapping/modules/QueryBuilder/Templates/QueryBuilderItemGroup.html}'></li></ul><ul class='add-buttons main-level-add'>    <li>        <button class='text-button' data-binding='{@event-onclick: addQueryClause_click}{@text: @language-querybuilder-add-condition}'></button>    </li>    <li>        <button class='text-button' data-binding='{@hidden: hasParent}{@event-onclick: addNestedQuery_click}{@text: @language-querybuilder-add-subgroup}'></button>    </li></ul>";function d(e,t,r){if("string"==typeof e&&(r=t,t=e),void 0!==r)for(var i=t.split("."),a=null,s=window,n=0,o=i.length;n<o;n++)a=i[n],n==o-1?s[a]=r:s[a]||(s[a]={}),s=s[a];else console.warn("Undefined shim for: "+t)}require({cache:{"Mapping/modules/QueryBuilder/AutoCompleteView":function(){var i,n=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});define(["require","exports","geocortex/framework/ui/ViewBase"],function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a,i=(a=r.ViewBase,n(s,a),s.prototype.activated=function(){a.prototype.activated.call(this)},s.prototype.attach=function(e){var r=this,i=this;a.prototype.attach.call(this,e),$(this.autoCompleteInput).autocomplete({minLength:0,source:function(e,t){r.getSuggestions(e,t)},appendTo:e.appendTo,position:{my:"right top",at:"right bottom",using:function(e){var t=$(this);t.css("top",e.top),t.css("right",t.offsetParent().innerWidth()-(e.left+t.outerWidth())),t.css("left","auto")}}}).on("autocompleteselect",function(e,t){return i.viewModel.value.set(t.item.value),!0}),$(this.autoCompleteInput).data("autocomplete")._resizeMenu=function(){var e=this.menu.element;this.options&&this.options.appendTo?(e.css("max-width",$(this.options.appendTo).width()),e.css("min-width",this.element.outerWidth()-6)):e.outerWidth(this.element.outerWidth())}},s.prototype.getSuggestions=function(e,t){this.viewModel.queryClause.getSuggestions().then(t,function(e){t(e)})},s.prototype.dispose=function(){$(this.autoCompleteInput).remove()},s.prototype.autoComplete_focus=function(e,t,r){$(t).val()||$(t).autocomplete("search","")},s.prototype.autoComplete_blur=function(e,t,r){$(t).autocomplete("widget").hide()},s);function s(e,t){return a.call(this,e,t)||this}t.AutoCompleteView=i})},"Mapping/modules/QueryBuilder/AutoCompleteViewModel":function(){var i,o=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});define(["require","exports","geocortex/framework/ui/ViewModelBase","geocortex/framework/observables"],function(e,t,r,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a,s=(a=r.ViewModelBase,o(n,a),n);function n(){var e=null!==a&&a.apply(this,arguments)||this;return e.value=new i.Observable,e}t.AutoCompleteViewModel=s})},"Mapping/modules/QueryBuilder/Formatters":function(){var i,k=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});define(["require","exports","./QueryOperator","geocortex/infrastructure/FormatUtils","geocortex/infrastructure/NumberFormat","geocortex/framework/utils/utils","geocortex/essentials/MapServiceConstants"],function(e,t,o,i,a,r,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=(l.getFormatter=function(e){return 0<=e.dataProvider.search(/^Db2$/i)?new c(this.settings):0<=e.dataProvider.search(/^FileGdb$/i)?new h(this.settings):0<=e.dataProvider.search(/^Informix$/i)?new v(this.settings):0<=e.dataProvider.search(/^MsAccess$/i)?new w(this.settings):0<=e.dataProvider.search(/^Oracle$/i)?new _(this.settings):0<=e.dataProvider.search(/^PostgreSql/i)?new O(this.settings):0<=e.dataProvider.search(/^Shapefile/i)?new D(this.settings):0<=e.dataProvider.search(/^SqlServer/i)?new N(this.settings):e.serviceLayerInfo.serviceType===s.MapServiceType.WMS||e.serviceLayerInfo.serviceType===s.MapServiceType.WFS?new R(this.settings):e.serviceLayerInfo.serviceType===s.MapServiceType.STREAM?new T(this.settings):new u(this.settings)},l.settings={},l);function l(e){l.settings=e}t.QueryFormatterFactory=n;var u=(d.prototype.wildcard=function(){return this._settings.wildcard||"%"},d.prototype.dateQueryFormat=function(){return this._settings.dateQueryFormat||"DATE '{0:yyyy-MM-dd}'"},d.prototype.textComparisonQueryFormat=function(){return this._settings.textComparisonQueryFormat||"LOWER({0}) LIKE LOWER({1})"},d.prototype.numberToTextComparisonQueryFormat=function(){return this._settings.numberToTextComparisonQueryFormat||"CAST({0} AS VARCHAR(50)) LIKE '{1}'"},d.prototype.doesNotContainQueryFormat=function(){return this._settings.doesNotContainQueryFormat||"LOWER({0}) NOT LIKE LOWER({1})"},d.prototype.supportsTimeOfDay=function(){return!r.isNullOrUndefined(this._settings.queryProviderSupportsTimeOfDay)&&this._settings.queryProviderSupportsTimeOfDay},d.prototype.format=function(e,t,r,i){var a=[o.QueryOperator.Equals,o.QueryOperator.NotEquals,o.QueryOperator.LessThan,o.QueryOperator.LessThanEquals,o.QueryOperator.GreaterThan,o.QueryOperator.GreaterThanEquals],s=[o.QueryOperator.Contains,o.QueryOperator.DoesNotContain,o.QueryOperator.StartsWith,o.QueryOperator.EndsWith],n=[o.QueryOperator.IsNull,o.QueryOperator.IsNotNull];return 0<=dojo.indexOf(a,t)?this.formatComparison(e,t,r):0<=dojo.indexOf(s,t)?i&&t!==o.QueryOperator.Equals&&t!==o.QueryOperator.NotEquals?this.formatCodedDomainPatternMatch(e,t,r,i):this.formatPatternMatch(e,t,r):0<=dojo.indexOf(n,t)?this.formatNull(e,t):void 0},d.prototype.formatComparison=function(e,t,r){var i=this.formatField(e),a=this.formatComparisonOperator(t),s=this.formatValue(e,r);return"{0} {1} {2}".format(i,a,s)},d.prototype.formatPatternMatch=function(e,t,r){return t===o.QueryOperator.DoesNotContain?this.doesNotContainQueryFormat().format(this.formatField(e),this.formatValue(e,this.formatPattern(t,r))):e.isNumeric()?this.numberToTextComparisonQueryFormat().format(this.formatField(e),this.formatPattern(t,this.formatValue(e,r))):this.textComparisonQueryFormat().format(this.formatField(e),this.formatValue(e,this.formatPattern(t,r)))},d.prototype.formatCodedDomainPatternMatch=function(e,t,r,i){var a="";return t===o.QueryOperator.Contains?a=i.filter(function(e){return-1<e.name.toString().toLowerCase().indexOf(r.toLowerCase())}).map(function(e){return"'"+e.val+"'"}).join(","):t===o.QueryOperator.DoesNotContain?a=i.filter(function(e){return-1===e.name.toString().toLowerCase().indexOf(r.toLowerCase())}).map(function(e){return"'"+e.val+"'"}).join(","):t===o.QueryOperator.StartsWith?a=i.filter(function(e){return e.name.toString().toLowerCase().startsWith(r.toLowerCase())}).map(function(e){return"'"+e.val+"'"}).join(","):t===o.QueryOperator.EndsWith&&(a=i.filter(function(e){return e.name.toString().toLowerCase().endsWith(r.toLowerCase())}).map(function(e){return"'"+e.val+"'"}).join(",")),0<a.length?"{0} IN ({1})".format(this.formatField(e),a):"1 = 2"},d.prototype.formatPattern=function(e,t){var r;switch(e){case o.QueryOperator.Contains:case o.QueryOperator.DoesNotContain:r="{0}{1}{0}";break;case o.QueryOperator.StartsWith:r="{1}{0}";break;case o.QueryOperator.EndsWith:r="{0}{1}";break;default:throw new Error("Invalid pattern matching operator.")}return r.format(this.wildcard(),t)},d.prototype.formatNull=function(e,t){if(t===o.QueryOperator.IsNull)return"{0} IS NULL".format(this.formatField(e));if(t===o.QueryOperator.IsNotNull)return"{0} IS NOT NULL".format(this.formatField(e));throw new Error("Invalid operator.")},d.prototype.formatField=function(e){return e.name},d.prototype.formatComparisonOperator=function(e){switch(e){case o.QueryOperator.Equals:return"=";case o.QueryOperator.NotEquals:return"<>";case o.QueryOperator.LessThan:return"<";case o.QueryOperator.LessThanEquals:return"<=";case o.QueryOperator.GreaterThan:return">";case o.QueryOperator.GreaterThanEquals:return">=";default:throw new Error("Invalid binary comparison operator.")}},d.prototype.formatValue=function(e,t){return e.isNumeric()?this.formatNumericValue(t):e.isDate()?this.formatDateValue(t):this.formatTextValue(t)},d.prototype.formatNumericValue=function(e){var t=e||"",r=i.parseNumber(e);return r&&(t=i.formatNumber(r,a.NumberFormat.ROUND_TRIP)),t},d.prototype.formatDateValue=function(e){var t=e||"",r=i.parseDate(t);return r&&(t=this.dateQueryFormat().replace(/\{0:([^}]+)\}/,function(e,t){return i.formatDate(r,t)})),t.trim()},d.prototype.formatTextValue=function(e){var t=e||"";return t=t.replace("'","''"),"'{0}'".format(t.trim())},d);function d(e){this._settings=e||{}}t.QueryFormatter=u;var p,c=(k(y,p=u),y.prototype.supportsTimeOfDay=function(){return!0},y.prototype.dateQueryFormat=function(){return"TO_DATE('{0:yyyy-MM-dd HH:mm:ss}','YYYY-MM-DD HH24:MI:SS')"},y);function y(e){return p.call(this,e)||this}t.Db2QueryFormatter=c;var g,h=(k(m,g=u),m.prototype.supportsTimeOfDay=function(){return!0},m.prototype.dateQueryFormat=function(){return"DATE '{0:yyyy-MM-dd HH:mm:ss}'"},m);function m(e){return g.call(this,e)||this}t.FileGdbQueryFormatter=h;var f,v=(k(b,f=u),b.prototype.supportsTimeOfDay=function(){return!0},b.prototype.dateQueryFormat=function(){return"'{0:yyyy-MM-dd HH:mm:ss}'"},b);function b(e){return f.call(this,e)||this}t.InformixQueryFormatter=v;var Q,w=(k(S,Q=u),S.prototype.supportsTimeOfDay=function(){return!0},S.prototype.dateQueryFormat=function(){return"#{0:MM-dd-yyyy HH:mm:ss}#"},S.prototype.wildcard=function(){return"*"},S);function S(e){return Q.call(this,e)||this}t.MsAccessQueryFormatter=w;var I,_=(k(C,I=u),C.prototype.supportsTimeOfDay=function(){return!0},C.prototype.dateQueryFormat=function(){return"TO_DATE('{0:yyyy-MM-dd HH:mm:ss}','YYYY-MM-DD HH24:MI:SS')"},C);function C(e){return I.call(this,e)||this}t.OracleQueryFormatter=_;var F,O=(k(x,F=u),x.prototype.supportsTimeOfDay=function(){return!0},x.prototype.dateQueryFormat=function(){return"TIMESTAMP '{0:yyyy-MM-dd HH:mm:ss}'"},x);function x(e){return F.call(this,e)||this}t.PostgreSqlQueryFormatter=O;var q,D=(k(L,q=u),L.prototype.supportsTimeOfDay=function(){return!1},L.prototype.dateQueryFormat=function(){return"DATE '{0:yyyy-MM-dd}'"},L);function L(e){return q.call(this,e)||this}t.ShapefileQueryFormatter=D;var A,N=(k(M,A=u),M.prototype.supportsTimeOfDay=function(){return!0},M.prototype.dateQueryFormat=function(){return"'{0:yyyy-MM-dd HH:mm:ss}'"},M);function M(e){return A.call(this,e)||this}t.SqlServerQueryFormatter=N;var E,R=(k(B,E=u),B.prototype.textComparisonQueryFormat=function(){return"{0} LIKE {1}"},B.prototype.doesNotContainQueryFormat=function(){return"{0} NOT LIKE {1}"},B);function B(e){return E.call(this,e)||this}t.GeocortexOwsQueryFormatter=R;var V,T=(k(P,V=u),P.prototype.textComparisonQueryFormat=function(){return"{0} LIKE {1}"},P.prototype.doesNotContainQueryFormat=function(){return"{0} NOT LIKE {1}"},P);function P(e){return V.call(this,e)||this}t.StreamLayerQueryFormatter=T})},"Mapping/modules/QueryBuilder/NameValuePair":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"Mapping/modules/QueryBuilder/Query":function(){var i,v=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});define(["require","exports","geocortex/framework/observables","./QueryBase","./QueryClause","geocortex/framework/utils/utils","geocortex/infrastructure/gis/AppInfo","geocortex/infrastructure/TaskUtils","geocortex/framework/utils/ArrayUtils","geocortex/essentials/Field","./QueryOperator","./QueryBuilderModule","./QueryErrorHandling","geocortex/infrastructure/PromiseUtils","geocortex/essentials/MapServiceConstants"],function(e,r,a,t,s,i,n,d,o,l,p,u,c,y,g){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.idPrefix="qu_";var h,m=(h=t.QueryBase,v(f,h),f.prototype.execute=function(e,r,t){var i,a=this;this._previousExecuteQuery&&this._previousExecuteQuery.cancel(),i=this.layer.get()&&this.layer.get().gcxLayer?d.getQueryTask(this.layer.get().gcxLayer):d.getQueryTask(this.layer.get().serviceLayerInfo.serviceLayer,this.layer.get().serviceLayerInfo);var s=new esri.tasks.Query;s.where=this.buildWhereClause(t),s.returnGeometry=!0,s.outFields=["*"],s.geometry=this.geometry.get(),s.outSpatialReference=e,this.app.trace.debug("Executing query with where clause: "+s.where),this.app.trace.debug("Query restricted by the following geometry: "+s.geometry);var n=i.execute(s);return(this._previousExecuteQuery=n).then(function(){a._previousExecuteQuery=null,r.publish({layer:a.layer.get(),query:s})},function(e){r.publish({layer:a.layer.get(),query:s,error:e});var t=e;t.layer=a.layer.get(),t.query=s,t.operation="query",a._queryErrorHandler&&a._queryErrorHandler(t)}),n},f.prototype.toString=function(){var e=this._toStringRecursive();return JSON.stringify(e,null,"\t")},f.prototype._toStringRecursive=function(){var e={id:this.id.get(),layer:this.layer.get()?this.layer.get().displayName:"null",clauses:this.queryClauses.get().map(function(e){return e.exportState()}),children:this.children.get().map(function(e){return e._toStringRecursive()}),order:this.queryItems.get().map(function(e){return e.id.get()}),conjunction:this.selectedLogicalOperator.get(),where:this.buildWhereClause(),adminDefined:this.adminDefined};return this.displayName.get()&&(e.displayName=this.displayName.get()),this.selectedSpatialFilter.get()&&(e.selectedSpatialFilter=this.selectedSpatialFilter.get()),this.selectedSpatialFilter.get()&&(e.selectedSpatialFilterName=this.selectedSpatialFilterName.get()),e},f.prototype.exportState=function(){if(this.layer.get()){var e={id:this.id.get(),layer:this.app.project.convert.fromGcxLayer(this.layer.get().gcxLayer),clauses:this.queryClauses.get().map(function(e){return e.exportState()}),children:this.children.get().map(function(e){return e.exportState()}),order:this.queryItems.get().map(function(e){return e.id.get()}),conjunction:this.selectedLogicalOperator.get(),where:this.buildWhereClause(),adminDefined:this.adminDefined};return this.displayName.get()&&(e.displayName=this.displayName.get()),this.selectedSpatialFilter.get()&&(e.selectedSpatialFilter=this.selectedSpatialFilter.get()),this.selectedSpatialFilterName.get()&&(e.selectedSpatialFilterName=this.selectedSpatialFilterName.get()),e}},f.prototype.applyState=function(i,e){var a=this;if(i)return(!this._isRestoringStatePromise||this._isRestoringStatePromise&&this._isRestoringStatePromise.isFulfilled())&&(this._isRestoringStatePromise=Promise.resolve()),e&&e!==u.latestProjectSerialVersion&&this._convertLegacyState(i,e),this.clearQuery(),this.id.set(i.id),this.adminDefined=i.adminDefined,this.selectedLogicalOperator.set(i.conjunction),this.displayName.set(i.hasOwnProperty("displayName")?i.displayName:null),this.selectedSpatialFilter.set(i.hasOwnProperty("selectedSpatialFilter")?i.selectedSpatialFilter:u.SpatialFilterOptions.None),this.selectedSpatialFilterName.set(i.hasOwnProperty("selectedSpatialFilterName")?i.selectedSpatialFilterName:""),this._attemptLayerRestore(i.layer),this._isRestoringStatePromise=this._isRestoringStatePromise.then(function(){return a.refreshFields()}).then(function(){return a._attemptClauseRestore(i.clauses,e)}).then(function(){return a._attemptChildRestore(i.children,e)}).then(function(){for(var e=i.order.length-1;0<=e;e--)for(var t=0;t<a.queryItems.get().length;t++){var r=a.queryItems.getAt(t);if(i.order[e]===r.id.get()){a.queryItems.removeAt(t),a.queryItems.insertItem(0,r),0<a.queryItems.length()&&a.queryItems.getAt(0).isLast.set(!1),a.queryItems.getAt(0).selectedLogicalOperator&&a.queryItems.getAt(0).selectedLogicalOperator.pulse();break}}0<a.queryItems.length()&&a.queryItems.getAt(a.queryItems.length()-1).isLast.set(!0)}).then(function(){return a.isModified.set(!1),a}).catch(function(e){throw e.code===c.ERRCODES.LAYERMISSINGERROR&&((e=e).queryState=i,e.query=a),a._queryErrorHandler&&a._queryErrorHandler(e),a.isModified.set(!1),e}),this._isRestoringStatePromise},f.prototype._attemptLayerRestore=function(t){var e=n.AppInfo.fromGeocortexApp(this.app);if(e&&e.mapInfo){var r=e.mapInfo.getLayerInfos().filter(function(e){return e.queryable&&e.displayName&&e.url}),i=o.firstOrDefault(r,function(e){return-1<e.url.indexOf(t.serviceLayer?t.serviceLayer.url:t.layerUrl)&&e.id===t.id.toString()});if(!i){var a=e.mapInfo.getTableInfos().filter(function(e){return e.queryable&&e.displayName&&e.url});if(!(i=o.firstOrDefault(a,function(e){return e.url.indexOf(t.serviceLayer?t.serviceLayer.url:t.layerUrl)&&e.id===t.id.toString()})))return;this.layerIsTable.set(!0)}this.layer.set(i)}},f.prototype._attemptClauseRestore=function(e,r){var i=this,t=e.map(function(e){var t=new s.QueryClause(i.app,i.libraryId,i);try{t.applyState(e,i._fields,r)}catch(e){return i._queryErrorHandler&&i._queryErrorHandler(e),null}return t});return t=t.filter(function(e){return!!e}),this.addQueryClauses(t)},f.prototype._attemptChildRestore=function(e,r){var i=this,t=e.map(function(){return new f(i.app,i.libraryId,{layer:i.layer.get(),layerIsTable:!1,logicalOperator:"AND"})}),a=this.addChildren(t);return y.PromiseUtils.mapSkipRejected(e,function(e,t){return a[t].applyState(e,r).catch(function(e){throw i.removeChildren([a[t]]),e})},{concurrency:1/0},!0)},f.prototype._convertLegacyState=function(e,t){switch(t){case 1:e.hasOwnProperty("id")||(e.id=r.idPrefix+i.alphaNumericToken()),e.hasOwnProperty("children")||(e.children=new Array),e.hasOwnProperty("order")||(e.order=new Array),e.hasOwnProperty("conjunction")||(e.conjunction=this.defaultLogicalOperator.get()),e.hasOwnProperty("adminDefined")||(e.adminDefined=!1),e.hasOwnProperty("displayName")||(e.displayName=""),e.hasOwnProperty("selectedSpatialFilter")||(e.selectedSpatialFilter=u.SpatialFilterOptions.None);break;default:this.app.trace.warning("Cannot convert this version of legacy queryState. Loading this legacy query may fail.")}},f.getStateFilter=function(e){return{id:!0,layer:e.project.filter.layer,clauses:{item:s.QueryClause.getStateFilter()},children:!0,order:!0,conjunction:!0,where:!0,adminDefined:!0,displayName:!0,selectedSpatialFilter:!0,selectedSpatialFilterName:!0}},f.prototype.setErrorHandler=function(t,r,i){this._queryErrorHandler=function(e){return i.apply(t,[r,e])}},f.prototype.removeErrorHandler=function(){this._queryErrorHandler=null},f.appendExpression=function(e,t,r){var i=e;return t&&0<t.length&&(i=e&&0<e.length?"("+e+") "+r+" ("+t+")":t),i},f.prototype.getSuggestions=function(n){var o=this;if(0===this.numSuggestions||n.layer.serviceLayerInfo.serviceType===g.MapServiceType.STREAM){var e=new dojo.Deferred;return e.resolve(new Array),e}if(0<n.codedValues.getLength()){var t=new dojo.Deferred,r=n.getAllPossibleCodedValues();return t.resolve(r.map(function(e){return e.name})),t}var l=new dojo.Deferred;l.id=this.counter++;var i=f.appendExpression(n.format(p.QueryOperator.StartsWith),this.layer.get().getDefinitionExpression(),p.Conjunctions.and)||"1 = 1",a=d.getQueryTask(this.layer.get().gcxLayer),s=new esri.tasks.Query;this.geometry.get()||-1!==n.selectedField.name.indexOf(".")||(s.returnDistinctValues=!0),s.where=i,s.returnGeometry=!1,s.outFields=[n.selectedField.name],this.geometry.get()&&(s.geometry=this.geometry.get());var u=a.execute(s);return u.id=this.counter++,u.then(function(e){for(var t={},r=new Array,i=0,a=e.features;i<a.length;i++){var s=a[i].attributes[n.selectedField.name]+"";if(f._isNullOrWhiteSpace(s)||t.hasOwnProperty(s)||(t[s]=s,r.push(s)),r.length===o.numSuggestions)break}r.sort(),r=r.map(function(e){return n.selectedField.formatValue(e)}),l.resolve(r)},function(e){o.app.trace.error("Could not retrieve suggestions for "+n.selectedField.name,e);var t=e;return t.layer=o.layer.get(),t.query=s,t.operation="get suggestions",o._queryErrorHandler&&o._queryErrorHandler(t),l.errback(e)}),l},f._isNullOrWhiteSpace=function(e){return!e||0===e.length||0<=e.search(/^\s+$/g)},f.prototype.addChildren=function(e){var i=this;return e.map(function(e,t,r){e.layer.sync(i.layer),e.layerIsTable.sync(i.layerIsTable),e.defaultLogicalOperator.sync(i.defaultLogicalOperator),e.hasParent.set(!0),e.parentQuery=i,e.parentLogicalOperator.sync(i.selectedLogicalOperator),e.numSuggestions=i.numSuggestions,e._queryErrorHandler=i._queryErrorHandler,e.isModified.bind(i,function(e){e&&i.isModified.set(!0)}),i.children.addItem(e),i.queryItems.addItem(e)}),this.isModified.set(!0),e},f.prototype.removeChildren=function(e){for(var t=this,r=[],i=0,a=this.children.get();i<a.length;i++)for(var s=a[i],n=0,o=e;n<o.length;n++){var l=o[n];s.id.get()===l.id.get()&&r.push(s)}r.forEach(function(e){t.children.removeItem(e),t.queryItems.removeItem(e)}),this.isModified.set(!0)},f.prototype.addQueryClauses=function(i){var a=this;return Promise.resolve().then(function(){for(var e=0,t=i;e<t.length;e++){var r=t[e];try{if(0===a._fields.length&&a.layer&&a.layer.get()&&a.layer.get().name&&a.layer.get().fields&&0<a.layer.get().fields.length)return void a.app.trace.warning("Layer "+a.layer.get().name+" does not have any fields");r.setFields(a._fields)}catch(e){a._queryErrorHandler&&a._queryErrorHandler(e)}r.updateCodedDomainValues(),a.queryClauses.addItem(r),a.queryItems.addItem(r)}return a.isModified.set(!0),1!==a.queryClauses.length()||a.hasParent.get()?0<a.queryClauses.length()&&a.queryClauses.getAt(0).deleteDisabled.set(!1):a.queryClauses.getAt(0).deleteDisabled.set(!0),i},function(e){if(e.code!==c.ERRCODES.LAYERFIELDERROR)throw e;var t=e;return t.code=c.ERRCODES.ADDQUERYCLAUSEERROR,t.clauses=i,a._queryErrorHandler&&a._queryErrorHandler(e),[]})},f.prototype.removeQueryClause=function(e){e.dispose(),this.queryClauses.removeItem(e),this.queryItems.removeItem(e),this.isModified.set(!0),1!==this.queryClauses.length()||this.hasParent.get()?0<this.queryClauses.length()&&this.queryClauses.getAt(0).deleteDisabled.set(!1):this.queryClauses.getAt(0).deleteDisabled.set(!0)},f.prototype._disposeAllClauses=function(){this.queryClauses.get().forEach(function(e){return e.dispose()}),this.queryClauses.clear(),this.queryItems.clear(),this.children.get().forEach(function(e){e._disposeAllClauses()}),this.removeChildren(this.children.get())},f.prototype.buildWhereClause=function(e){void 0===e&&(e=!1);var t="";return t=this._buildInnerWhereClause(),e&&(t=f.appendExpression(t,this.layer.get().getDefinitionExpression(),p.Conjunctions.and)),this._debugWhereClause.set(t),t},f.prototype._buildInnerWhereClause=function(){for(var r=this,i="",e=0;e<this.queryClauses.length();e++){var t=this.queryClauses.getAt(e).format();t&&(0<i.length&&(i+=" "+this.selectedLogicalOperator.get()+" "),i+=t)}return this.children.get().forEach(function(e){var t=e._buildInnerWhereClause();t&&(i?i+=" "+r.selectedLogicalOperator.get()+" "+t+" ":i=t)}),i||this.hasParent.get()||(i="1 = 1"),i=i&&"("+i+")"},f.prototype.pulseCodedDomainValues=function(){for(var e=0;e<this.queryClauses.length();e++)this.queryClauses.getAt(e).codedDomainValue.pulse();this.children.get().forEach(function(e){e.pulseCodedDomainValues()})},f.prototype.updateCodedDomainValues=function(){for(var e=0;e<this.queryClauses.length();e++)this.queryClauses.getAt(e).updateCodedDomainValues();this.children.get().forEach(function(e){e.updateCodedDomainValues()})},f.prototype.refreshFields=function(){var r=this;return this.layer.get()?new Promise(function(e,t){r.layer.get().getFields().then(e,t)}).then(function(e){r._fields=e.filter(function(e){return dojo.indexOf(f._excludedFieldTypes,e.type)<0&&e.isVisible}),r._fields=r._fields.sort(function(e,t){var r=(e.alias||"").toLocaleLowerCase(),i=(t.alias||"").toLocaleLowerCase();return r===i?0:r<i?-1:1})},function(e){var t=e;throw t.code=c.ERRCODES.LAYERFIELDERROR,t.queryClause=null,t.missingFieldName=null,t.allFields=r._fields,r._queryErrorHandler&&r._queryErrorHandler(t),e}):Promise.resolve()},f.prototype.getNewInstance=function(t){var r=this,e=new f(this.app,this.libraryId,{logicalOperator:"AND",layer:this.layer.get(),layerIsTable:!1});return this.exportState()?e.applyState(this.exportState(),u.latestProjectSerialVersion).then(function(e){return e._queryErrorHandler=r._queryErrorHandler,t&&e.refreshId(),e},function(e){return r.app.trace.error("Could not get new instance of query"),r._queryErrorHandler&&r._queryErrorHandler(e),Promise.reject(e)}):Promise.resolve(e)},f.prototype._generateId=function(){return r.idPrefix+i.alphaNumericToken()},f.prototype.clearQuery=function(){this._disposeAllClauses(),this.layer.set(null),this._fields=[],this.selectedLogicalOperator.set(this.defaultLogicalOperator.get()),this.layerIsTable.set(!1),this.displayName.set(null),this.isModified.set(!1)},f.prototype.refreshId=function(){this.id.set(this._generateId())},f._excludedFieldTypes=[l.EsriFieldTypes.esriFieldTypeBlob,l.EsriFieldTypes.esriFieldTypeGeometry,l.EsriFieldTypes.esriFieldTypeGlobalID,l.EsriFieldTypes.esriFieldTypeGUID],f);function f(e,t,r){var i=h.call(this,e,t)||this;return i.isModified=new a.Observable(!1),i.displayName=new a.Observable(null),i.queryClauses=new a.ObservableCollection,i.layerIsTable=new a.Observable(!1),i.layer=new a.Observable(null),i.layerId=new a.Observable(null),i.selectedLogicalOperator=new a.Observable(null),i.logicalOperators=new a.ObservableCollection,i._debugWhereClause=new a.Observable(null),i.radioButtons=null,i.radioButtonGroup=new a.Observable(null),i.queryItems=new a.ObservableCollection,i.children=new a.ObservableCollection,i.hasParent=new a.Observable(!1),i.parentLogicalOperator=new a.Observable(null),i.defaultLogicalOperator=new a.Observable(p.Conjunctions.and),i.numSuggestions=10,i.geometry=new a.Observable(null),i.selectedSpatialFilter=new a.Observable,i.selectedSpatialFilterName=new a.Observable,i.adminDefined=!1,i.counter=0,i._isRestoringStatePromise=null,i._fields=new Array,i.type="queryGroup",i.layerIsTable.set(r.layerIsTable),i.layer.set(r.hasOwnProperty("layer")?r.layer:null),i.layerId.set(r.hasOwnProperty("layer")&&r.layer?r.layer.uniqueId:null),i.selectedLogicalOperator.set(r.hasOwnProperty("logicalOperator")&&r.logicalOperator?r.logicalOperator:i.defaultLogicalOperator.get()),i.selectedLogicalOperator.bind(i,function(e){i.isModified.set(!0),i.app.event("_logicalOperatorChanged").publish(i.id,e)}),i.layerId.syncTransform(i.layer,function(e){return e&&e.uniqueId?e.uniqueId:null}),i.displayName.set(r.hasOwnProperty("displayName")?r.displayName:null),i.id.set(r.hasOwnProperty("id")?r.id:i._generateId()),i.selectedSpatialFilter.set(r.hasOwnProperty("spatialFilter")?r.spatialFilter:0),i.logicalOperators=new a.ObservableCollection([{name:i.app.getResource(i.libraryId,"language-querybuilder-and-operator"),val:"and"},{name:i.app.getResource(i.libraryId,"language-querybuilder-or-operator"),val:"or"}]),i.id.bind(i,function(e){var t="radioButtonGroup"+e;i.radioButtonGroup.set(t)}),i.id.pulse(),i.parentLogicalOperator.bind(i,function(){i.isAnd.set(i.parentLogicalOperator.get()===p.Conjunctions.and),i.isOr.set(i.parentLogicalOperator.get()===p.Conjunctions.or)}),i.queryItems.bind(i,function(e){switch(e.type){case"remove":var t=i.queryItems.length();e.rangeEnd===t-1&&1<t&&i.queryItems.getAt(t-2).isLast.set(!0);break;case"insert":case"append":0<i.queryItems.length()&&i.queryItems.getAt(i.queryItems.length()-1).isLast.set(!0),1<i.queryItems.length()&&i.queryItems.getAt(i.queryItems.length()-2).isLast.set(!1)}}),i._queryErrorHandler=function(e){i.app.trace.error(e.message)},i}r.Query=m})},"Mapping/modules/QueryBuilder/QueryBase":function(){define(["require","exports","geocortex/framework/observables"],function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});function i(e,t){this.id=new r.Observable(null),this.isLast=new r.Observable(!1),this.isAnd=new r.Observable(null),this.isOr=new r.Observable(null),this.app=e,this.libraryId=t}t.QueryBase=i})},"Mapping/modules/QueryBuilder/QueryBuilderModule":function(){var i,f=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),v=this&&this.__spreadArrays||function(){for(var e=0,t=0,r=arguments.length;t<r;t++)e+=arguments[t].length;var i=Array(e),a=0;for(t=0;t<r;t++)for(var s=arguments[t],n=0,o=s.length;n<o;n++,a++)i[a]=s[n];return i};define(["require","exports","geocortex/framework/application/ModuleBase","./QueryCollection","./Query","./QueryClause","./QueryErrorHandling","geocortex/infrastructure/commandArgs/AddStatusArgs","geocortex/infrastructure/gis/AppInfo","./QueryOperator","geocortex/framework/utils/utils","geocortex/infrastructure/PromiseUtils"],function(e,s,t,r,l,u,n,a,i,d,p,o){"use strict";var c,y;Object.defineProperty(s,"__esModule",{value:!0}),(y=c=s.SpatialFilterOptions||(s.SpatialFilterOptions={}))[y.None=0]="None",y[y.CurrentExtent=1]="CurrentExtent",y[y.Drawings=2]="Drawings",s.latestProjectSerialVersion=2;var g,h=(g=t.ModuleBase,f(m,g),m.prototype.initialize=function(e){if((e=e||{}).hasOwnProperty("queryStatusRegion")&&(this._queryStatusRegion=e.queryStatusRegion),e.hasOwnProperty("filterStatusRegion")&&(this._filterStatusRegion=e.filterStatusRegion),e.hasOwnProperty("defaultLogicalOperator")&&null!=e.defaultLogicalOperator&&"string"==typeof e.defaultLogicalOperator){var t=e.defaultLogicalOperator.toLowerCase();void 0===d.Conjunctions[t]||null===d.Conjunctions[t]?this.app.trace.warning('Invalid default conjunction "'+t+'" given. Using '+d.Conjunctions.and+" as the default"):this.defaultLogicalOperator=d.Conjunctions[t]}return this._registerCommands(),this._initializeCollections()},m.prototype._initializeCollections=function(){var a=this;return this._queryStore=new r.QueryCollection(this.app,this.libraryId,{persistent:!1,sourceName:"SavedQueries"}),this._queryStore.isFilterCollection=!1,this._filterStore=new r.QueryCollection(this.app,this.libraryId,{persistent:!1,sourceName:"SavedFilters"}),this._filterStore.isFilterCollection=!0,Promise.all([this._queryStore.initialize(),this._filterStore.initialize()]).then(function(){return a._queryStore.setCollectionChangedEvent(a.app.event("SavedQueriesChangedEvent")),a._filterStore.setCollectionChangedEvent(a.app.event("SavedFiltersChangedEvent")),a.app.event("SavedQueriesChangedEvent").subscribe(a,function(){a.app.trace.debug("Query Collection changed"),a.app.trace.debug("The list of queries follows: "),a._queryStore.getAllQueries().forEach(function(e,t){var r=function(e){e.layer=null,e.children.forEach(r)},i=e.exportState();i&&r(i),a.app.trace.debug("Query: "+t+" \n"+JSON.stringify(i,null,2))})}),a.app.event("SavedFiltersChangedEvent").subscribe(a,function(){a.app.trace.debug("Filter Collection changed"),a.app.trace.debug("The list of filters follows: "),a._filterStore.getAllQueries().forEach(function(e,t){var r=function(e){e.layer=null,e.children.forEach(r)},i=e.exportState();i&&r(i),a.app.trace.debug("Filter: "+t+" \n"+JSON.stringify(i,null,2))})}),a._retrieveSiteQueries()}).then(function(e){return o.PromiseUtils.mapSkipRejected(e,function(e){return e.adminDefined=!0,o.PromiseUtils.allSkipRejected([e.getNewInstance().then(function(e){return e.setErrorHandler(a,!1,n.handleQueryErrors),a._queryStore.addQuery(e)}),Promise.resolve().then(function(){e.setErrorHandler(a,!0,n.handleQueryErrors),a._filterStore.addQuery(e)})],!0)},{concurrency:1/0},!0)})},m.prototype._registerCommands=function(){var a=this;this.app.command("AddQueryStatus").register(this,function(e,t){return a.addStatus(!1,e,t)}),this.app.command("AddFilterStatus").register(this,function(e,t){return a.addStatus(!0,e,t)}),this.app.command("RemoveQueryStatus").register(this,function(){return a.removeStatus(!1)}),this.app.command("RemoveFilterStatus").register(this,function(){return a.removeStatus(!0)}),this.app.command("_getAllSavedQueries").register(this,function(e){return a._getAllQueries(!1,e)}),this.app.command("_getAllSavedFilters").register(this,function(e){return a._getAllQueries(!0,e)}),this.app.command("_getSavedQueryById").register(this,function(e,t,r){return a._getQueryById(!1,e,t,r)}),this.app.command("_getSavedFilterById").register(this,function(e,t,r){return a._getQueryById(!0,e,t,r)}),this.app.command("_getSavedQueryByName").register(this,function(e,t,r){return a._getQueryByName(!1,e,t,r)}),this.app.command("_getSavedFilterByName").register(this,function(e,t,r){return a._getQueryByName(!0,e,t,r)}),this.app.command("RemoveSavedQuery").register(this,function(e,t){return a._removeQuery(!1,e,t)}),this.app.command("RemoveSavedFilter").register(this,function(e,t){return a._removeQuery(!0,e,t)}),this.app.command("RemoveSavedQueryById").register(this,function(e){return a._removeQueryById(!1,e)}),this.app.command("RemoveSavedFilterById").register(this,function(e){return a._removeQueryById(!0,e)}),this.app.command("_updateSavedQueryById").register(this,function(e,t,r,i){return a._updateQueryById(!1,e,t,r,i)}),this.app.command("_updateSavedFilterById").register(this,function(e,t,r,i){return a._updateQueryById(!0,e,t,r,i)}),this.app.command("ClearSavedQueries").register(this,function(){return a._clearQueries(!1)}),this.app.command("ClearSavedFilters").register(this,function(){return a._clearQueries(!0)}),this.app.command("_addSavedQuery").register(this,function(e,t,r){return a._addQuery(!1,e,t,r)}),this.app.command("_addSavedFilter").register(this,function(e,t,r){return a._addQuery(!0,e,t,r)})},m.prototype._retrieveSiteQueries=function(){var t=this;return this.app.waitUntilSiteServiceLayersLoaded().then(function(){var e=i.AppInfo.fromGeocortexApp(t.app).mapInfo.getLayerInfos().filter(function(e){return e.queryable&&!!e.displayName&&!!e.url});return o.PromiseUtils.mapSkipRejected(e,function(e){return t._retrieveQueriesForLayer(e)},{concurrency:1/0},!0)}).then(function(e){return 0!==e.length?e.reduce(function(e,t){return e.concat(t)}):[]}).catch(function(e){return t.app.trace.error("An unknown error occured while retrieving queries defined for the site.\n\n                                    No queries were loaded.\n\n                                    Please contact your administrator to fix this issue."),[]})},m.prototype._retrieveQueriesForLayer=function(r){var i=this,e=r.gcxLayer.queries||[];return o.PromiseUtils.mapSkipRejected(e,function(e){if(!i._isValidQueryGroupObject(e.query))throw new Error("Could not parse the following query. Reason: Invalid query object\n\n                                        "+JSON.stringify(e.query,null,2));var t=i._configureQueryStateRecursive(e.query,r,e.id,e.displayName);return new l.Query(i.app,i.libraryId,{layer:r,layerIsTable:!1,logicalOperator:"and"}).applyState(t,s.latestProjectSerialVersion)},{concurrency:1/0},!0)},m.prototype._configureQueryStateRecursive=function(e,r,t,i){var a=this,s={id:t,layer:this.app.project.convert.fromGcxLayer(r.gcxLayer),clauses:[],children:[],order:[],conjunction:e.conjunction,where:"",adminDefined:!1,displayName:i,selectedSpatialFilter:c.None,selectedSpatialFilterName:this.getResource("language-querybuilder-spatial-filter-all")},n=[],o=[];if(e.items.forEach(function(e){if(a._isValidClauseObject(e)){void 0===e.value&&(e.value=null);var t={id:u.idPrefix+p.alphaNumericToken(),field:e.field,operator:d.QueryOperator[e.operator].toString(),value:e.value};o.push(t)}else a._isValidQueryGroupObject(e)?n.push(e):a.app.trace.error("Could not parse the following query item. It is not an instance of a clause or sub-query\n\n                                        "+JSON.stringify(e,null,2))}),0===o.length)throw new Error("Query must have at least one valid query clause");return s.clauses=o,s.children=n.map(function(e){var t=l.idPrefix+p.alphaNumericToken();return a._configureQueryStateRecursive(e,r,t,i)}),s},m.prototype._isValidClauseObject=function(e){return void 0!==e.field&&null!==e.field&&"string"==typeof e.field&&void 0!==e.operator&&null!==e.operator&&"string"==typeof e.operator&&void 0!==d.QueryOperator[e.operator]&&("string"==typeof e.value||null===e.value||void 0===e.value)},m.prototype._isValidQueryGroupObject=function(e){return void 0!==e.conjunction&&null!==e.conjunction&&"string"==typeof e.conjunction&&(e.conjunction=e.conjunction.toLowerCase(),void 0!==d.Conjunctions[e.conjunction]&&null!==d.Conjunctions[e.conjunction]||(e.conjunction=null),e.items instanceof Array)},m.prototype._getAllQueries=function(t,r){try{r((t?this._filterStore:this._queryStore).getAllQueries())}catch(e){var i=e;i.code=n.ERRCODES.RETRIEVECOLLECTIONERROR,n.handleQueryErrors.call(this,t,i),r([])}},m.prototype._getQueryById=function(e,t,r,i){try{var a=(e?this._filterStore:this._queryStore).getQueryById(t);if(null!=a)return r(a);var s=new Error("Query with id "+t+" not found");return s.code=n.ERRCODES.NOTFOUND,s.id=t,i(s)}catch(e){return i(e)}},m.prototype._getQueryByName=function(e,t,r,i){try{var a=(e?this._filterStore:this._queryStore).getQueryByName(t);if(null!==a)return r(a);var s=new Error("Query with name "+t+" not found");return s.code=n.ERRCODES.NOTFOUND,s.name=t,!!i&&i(s)}catch(e){return!!i&&i(e)}},m.prototype._removeQuery=function(t,r,e){var i=this,a=t?this.getResource("language-querybuilder-delete-prompt-filter"):this.getResource("language-querybuilder-delete-prompt-query"),s=t?this.getResource("language-querybuilder-delete-prompt-title-filter").format(r.displayName.get()):this.getResource("language-querybuilder-delete-prompt-title-query").format(r.displayName.get());e&&!0===e.removeLayerFlag?this._removeQueryById(t,r.id.get()):this.app.command("Confirm").execute(a,s,function(e){e&&i._removeQueryById(t,r.id.get())})},m.prototype._removeQueryById=function(r,i){var a=this;(r?this._filterStore:this._queryStore).removeQueryById(i).then(function(e){if(null===e){var t=new Error("Query with id "+i+" not found");throw t.code=n.ERRCODES.NOTFOUND,t.id=i,t}a.app.command(r?"AddFilterStatus":"AddQueryStatus").execute(a.app.getResource(a.libraryId,"language-querybuilder-notification-removed").format(r?"filter":"query",e.displayName.get()))}).catch(function(e){n.handleQueryErrors.call(a,r,e),a.app.command(r?"AddFilterStatus":"AddQueryStatus").execute(a.app.getResource(a.libraryId,"language-querybuilder-error-removing").format(r?"filter":"query",{error:!0}))})},m.prototype._updateQueryById=function(t,e,r,i,a){var s=this;try{(t?this._filterStore:this._queryStore).updateQueryById(e,r).then(function(e){return s.app.command(t?"AddFilterStatus":"AddQueryStatus").execute(s.app.getResource(s.libraryId,"language-querybuilder-notification-updated").format(t?"filter":"query",e.displayName.get())),!!i&&i(e)},function(e){throw e})}catch(e){return!!a&&a(e)}},m.prototype._addQuery=function(t,e,r,i){var a=this;try{(t?this._filterStore:this._queryStore).addQuery(e).then(function(e){return a.app.command(t?"AddFilterStatus":"AddQueryStatus").execute(a.app.getResource(a.libraryId,"language-querybuilder-notification-saved").format(t?"filter":"query",e.displayName.get())),!!r&&r(e)},function(e){return!!i&&i(e)})}catch(e){return!!i&&i(e)}},m.prototype._clearQueries=function(t){var r=this;(t?this._filterStore:this._queryStore).clear().then(function(){r.app.command(t?"AddFilterStatus":"AddQueryStatus").execute(r.app.getResource(r.libraryId,"language-querybuilder-notification-clear").format(t?"filter":"query"))},function(e){r.app.command(t?"AddFilterStatus":"AddQueryStatus").execute(r.app.getResource(r.libraryId,"language-querybuilder-error-clearing").format(t?"filter":"query",{error:!0}))})},m.prototype.addStatus=function(e,t,r){var i=new a.AddStatusArgs(t);i.timeoutMS=0,i.regionName=e?this._filterStatusRegion:this._queryStatusRegion,i.id=e?"FilterStatusMessageView":"QueryStatusMessageView",e?this.app.command("RemoveFilterStatus").execute():this.app.command("RemoveQueryStatus").execute(),this.app.command("AddStatus").execute(i)},m.prototype.removeStatus=function(e){this.app.command("RemoveStatus").execute(e?"FilterStatusMessageView":"QueryStatusMessageView")},m.prototype.getStateFilter=function(){return{queries:{item:l.Query.getStateFilter(this.app)},filters:{item:l.Query.getStateFilter(this.app)},savedQueries:{item:l.Query.getStateFilter(this.app)},savedFilters:{item:l.Query.getStateFilter(this.app)}}},m.prototype.exportState=function(){var i=this,a={queries:[],savedQueries:[],filters:[],savedFilters:[],serialVersion:2};a.savedQueries=this._queryStore.getAllQueries().map(function(e){return e.exportState()}),a.savedQueries=a.savedQueries.filter(function(e){return!e.adminDefined}),a.savedFilters=this._filterStore.getAllQueries().map(function(e){return e.exportState()}),a.savedFilters=a.savedFilters.filter(function(e){return!e.adminDefined});var e=["_ExportQueryBuilderState","_ExportFilterBuilderState"].map(function(r){return new Promise(function(t,e){return i.app.command(r).execute(a,t,function(e){return i.app.trace.error("Could not export query or filter builder state"),t(a)})})});return Promise.all(e).then(function(){return a})},m.prototype.applyState=function(r){var a=this;r.serialVersion!==s.latestProjectSerialVersion&&this.convertLegacyState(r);var e={state:r,completePromises:[]};return this.app.waitUntilAllLibrariesLoaded().then(function(){var e=a._queryStore.getAllQueries().filter(function(e){return!e.adminDefined}),t=a._filterStore.getAllQueries().filter(function(e){return!e.adminDefined}),r=e.map(function(e){return a._queryStore.removeQueryById(e.id.get())}),i=t.map(function(e){return a._filterStore.removeQueryById(e.id.get())});return Promise.all(v(r,i))}).then(function(){a._queryStore.disableCollectionChangedEvent(),a._filterStore.disableCollectionChangedEvent();var e=a._restoreCollection(a._queryStore,r.savedQueries),t=a._restoreCollection(a._filterStore,r.savedFilters);return Promise.all([e,t])}).then(function(){return a.app.command("_ApplyQueryBuilderState").execute(e),a.app.command("_ApplyFilterBuilderState").execute(e),Promise.all(e.completePromises)}).then(function(){a._queryStore.enableCollectionChangedEvent(),a._filterStore.enableCollectionChangedEvent(),a._queryStore.bindingEvent.publish(),a._filterStore.bindingEvent.publish()}).return()},m.prototype._restoreCollection=function(i,e){var a=this;return o.PromiseUtils.mapSkipRejected(e,function(e){var t,r=new l.Query(a.app,a.libraryId,{layer:null,layerIsTable:!1,logicalOperator:"AND"});return r.setErrorHandler(a,!1,n.handleQueryErrors),r.applyState(e,s.latestProjectSerialVersion).then(function(e){return t=e,i.addQuery(e)}).catch(function(e){if(e.code===n.ERRCODES.DUPLICATE)return t.displayName.set(t.displayName.get()+" "+a.app.getResource(a.libraryId,"language-querybuilder-duplicate-name-resolution-postfix")),a.app.command(i.isFilterCollection?"RemoveFilterStatus":"RemoveQueryStatus").execute(),i.addQuery(t);throw e})},{concurrency:1/0},!0)},m.prototype.convertLegacyState=function(e){switch(e.serialVersion){case 1:e.savedQueries=[],e.savedFilters=[];break;default:this.app.trace.warning("Could not convert legacy state of query builder module. Legacy version unknown")}},m);function m(e,t){var r=g.call(this,e,t)||this;return r.defaultLogicalOperator=d.Conjunctions.and,r._queryStatusView=null,r._filterStatusView=null,r}s.QueryBuilderModule=h})},"Mapping/modules/QueryBuilder/QueryBuilderState":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"Mapping/modules/QueryBuilder/QueryClause":function(){var i,Q=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});define(["require","exports","geocortex/forms/items/DatePickerFormItem","./AutoCompleteViewModel","geocortex/framework/observables","./QueryOperatorDescription","./QueryOperator","geocortex/infrastructure/FormatUtils","geocortex/infrastructure/DateFormat","geocortex/essentials/Field","geocortex/essentials/utilities/TimeZoneUtils","./QueryBase","./Query","./QueryErrorHandling","./Formatters","geocortex/framework/utils/utils","./QueryBuilderModule"],function(e,a,s,n,o,l,y,p,c,g,h,t,m,r,f,u,i){"use strict";Object.defineProperty(a,"__esModule",{value:!0}),a.idPrefix="qc_";var d,v=(d=t.QueryBase,Q(b,d),b.prototype.format=function(e){var t=f.QueryFormatterFactory.getFormatter(this.layer);e=e||parseInt(this.selectedOperator.get(),10);var r=this.fieldValue.get();if(!r&&e!==y.QueryOperator.IsNull&&e!==y.QueryOperator.IsNotNull)return"";var i="",a=p.parseDate(r,c.DateFormat.ROUND_TRIP);if(this.selectedField&&this.selectedField.type===g.EsriFieldTypes.esriFieldTypeDate&&a&&!isNaN(a.getTime())){var s=this.layer&&this.layer.gcxLayer?h.getTimeZoneFromLayer(this.layer.gcxLayer):null,n=this.layer&&this.layer.gcxLayer?h.getDisplayTimeZoneFromMapService(this.layer.gcxLayer.mapService):null;if(e===y.QueryOperator.Equals||e===y.QueryOperator.NotEquals){var o=new Date(a.getFullYear(),a.getMonth(),a.getDate(),0,0,0),l=new Date(a.getFullYear(),a.getMonth(),a.getDate()+1,0,0,0);o=h.correctDatesToQueryInDatabaseTime(o,s,n),l=h.correctDatesToQueryInDatabaseTime(l,s,n);var u=p.formatDate(o,c.DateFormat.ROUND_TRIP),d=p.formatDate(l,c.DateFormat.ROUND_TRIP);i=e===y.QueryOperator.Equals?m.Query.appendExpression(t.format(this.selectedField,y.QueryOperator.GreaterThanEquals,u),t.format(this.selectedField,y.QueryOperator.LessThan,d),y.Conjunctions.and):m.Query.appendExpression(t.format(this.selectedField,y.QueryOperator.LessThan,u),t.format(this.selectedField,y.QueryOperator.GreaterThanEquals,d),y.Conjunctions.or)}else a=h.correctDatesToQueryInDatabaseTime(a,s,n),r=p.formatDate(a,c.DateFormat.ROUND_TRIP),i=t.format(this.selectedField,e,r)}else i=this.selectedField.isCodedValueDomain()&&e!==y.QueryOperator.Equals&&e!==y.QueryOperator.NotEquals?t.format(this.selectedField,e,r,this.getAllPossibleCodedValues()):t.format(this.selectedField,e,r);return i},b.prototype.exportState=function(){return{id:this.id.get(),field:this.selectedFieldName.get(),operator:this.selectedOperator.get(),value:this.fieldValue.get()}},b.prototype.applyState=function(t,e,r){r&&r!==i.latestProjectSerialVersion&&this.convertLegacyState(t,r),this.id.set(t.id);try{this.setFields(e)}catch(e){throw e.missingFieldName=t.field,e}this.selectedFieldName.set(t.field),this.updateCodedDomainValues(),this.selectedOperator.set(t.operator),b._isCodedValueDomain(this.selectedField)?(this.codedDomainValue.set(t.value),this.autoCompleteViewModel.value.set(t.value)):this.selectedField&&this.selectedField.isDate()?this.datePickerFormItem.date.set(p.parseDate(t.value)):this.autoCompleteViewModel.value.set(t.value)},b.prototype.convertLegacyState=function(e,t){switch(t){case 1:e.id=a.idPrefix+u.alphaNumericToken();break;default:this.app.trace.warning("Legacy queryClause serialVersion not recognized. Creating the queryClause may fail.")}},b.getStateFilter=function(){return{id:!0,field:!0,operator:!0,value:!0}},b.prototype.getSuggestions=function(){return this.parentQuery.getSuggestions(this)},b.prototype._fieldChanged=function(){var t=this,e=this.fields.get().filter(function(e){return e.name===t.selectedFieldName.get()})[0];if(e){this.selectedField=e,this.parentQuery.isModified.set(!0),this._codedDomainSelectionBinding&&this.codedDomainValue.unbind(this._codedDomainSelectionBinding),this._autocompleteSelectionBinding&&this.autoCompleteViewModel.value.unbind(this._autocompleteSelectionBinding),this.operators.clear(),b._isCodedValueDomain(e)?(this.operators.addItem(l.QueryOperatorDescription.Equals),this.operators.addItem(l.QueryOperatorDescription.NotEquals),this.operators.addItem(l.QueryOperatorDescription.Contains),this.operators.addItem(l.QueryOperatorDescription.DoesNotContain),this.operators.addItem(l.QueryOperatorDescription.StartsWith),this.operators.addItem(l.QueryOperatorDescription.EndsWith)):e.isNumeric()||e.isDate()?(this.operators.addItem(l.QueryOperatorDescription.Equals),this.operators.addItem(l.QueryOperatorDescription.NotEquals),this.operators.addItem(l.QueryOperatorDescription.LessThan),this.operators.addItem(l.QueryOperatorDescription.LessThanEquals),this.operators.addItem(l.QueryOperatorDescription.GreaterThan),this.operators.addItem(l.QueryOperatorDescription.GreaterThanEquals)):e.isText()&&(this.operators.addItem(l.QueryOperatorDescription.Contains),this.operators.addItem(l.QueryOperatorDescription.DoesNotContain),this.operators.addItem(l.QueryOperatorDescription.StartsWith),this.operators.addItem(l.QueryOperatorDescription.EndsWith),this.operators.addItem(l.QueryOperatorDescription.Equals),this.operators.addItem(l.QueryOperatorDescription.NotEquals)),e.nullable&&(this.operators.addItem(l.QueryOperatorDescription.IsNull),this.operators.addItem(l.QueryOperatorDescription.IsNotNull)),this.selectedOperator.set(this.operators.getAt(0).value.toString());var r=parseInt(this.selectedOperator.get(),10);this._updateInputVisibility(e,r),this.parentQuery.updateCodedDomainValues(),b._isCodedValueDomain(this.selectedField)?(this._codedDomainSelectionBinding=this.codedDomainValue.bind(this,function(e){t.showCodedValueDomainInput.get()&&t.fieldValue.set(e)}),this._autocompleteSelectionBinding=this.autoCompleteViewModel.value.bind(this,function(e){t.showCodedValueDomainInput.get()||t.fieldValue.set(e)}),this.fieldValue.set(this.codedDomainValue.get())):this.selectedField.isDate()?this.fieldValue.syncTransform(this.datePickerFormItem.date,function(e){return p.formatDate(t.datePickerFormItem.date.get(),c.DateFormat.ROUND_TRIP)}):this.fieldValue.sync(this.autoCompleteViewModel.value)}},b.prototype.setFields=function(e){this.fields.set(e),this.parentQuery.isModified.set(!0);var t=new Error("Could not find selected field from given fields.");t.queryClause=this,t.code=r.ERRCODES.LAYERFIELDERROR,0<this.fields.length()&&!this.selectedFieldName.get()?this.selectedFieldName.set(this.fields.getAt(0).name):0===this.fields.length()?(t.missingFieldName=this.selectedFieldName.get(),t.allFields=[],this.selectedFieldName.set(null)):this.selectedFieldName.get()&&-1===this.fields.get().map(function(e){return e.name}).indexOf(this.selectedFieldName.get())&&(t.missingFieldName=this.selectedFieldName.get(),t.allFields=e,this.selectedFieldName.set(this.fields.getAt(0).name))},b.prototype.updateCodedDomainValues=function(){var t=this;if(this.codedValues.clear(),this.selectedField){if(this.selectedField.isCodedValueDomain())for(var e=0,r=this.selectedField.getCodedValueDomain().codedValues;e<r.length;e++){var i=r[e];this.codedValues.addItem({name:i.name,val:i.code.toString()})}if(this.selectedField.hasSubtypeCodedValueDomains()){for(var a=this.selectedField.getSubtypeCodedValueDomains(),s=0,n=null,o=0;o<this.parentQuery.queryClauses.length();o++){var l=this.parentQuery.queryClauses.getAt(o);l!==this&&l.selectedField&&l.selectedField.isTypeField&&(n=l,s++)}if(1===s&&this.parentQuery.selectedLogicalOperator.get()===y.Conjunctions.and){var u=n.codedDomainValue.get();if(n.selectedOperator.get()===y.QueryOperator.Equals.toString())(p=a[u])&&0<p.codedValues.length&&p.codedValues.forEach(function(e){t.codedValues.addItem({name:e.name,val:e.code.toString()})});else for(var d in a)d!==u&&a.hasOwnProperty(d)&&(p=a[d]).codedValues.forEach(function(e){t.codedValues.addItem({name:e.name,val:e.code.toString()})})}else for(var d in a){var p;a.hasOwnProperty(d)&&(p=a[d]).codedValues.forEach(function(e){t.codedValues.addItem({name:e.name,val:e.code.toString()})})}}if(this.parentQuery.isModified.set(!0),0<this.codedValues.length()){var c=!(this._settingCodedDomainValue=!0);for(o=0;o<this.codedValues.getLength();o++)this.codedValues.getAt(o).val===this.codedDomainValue.get()&&(c=!0,this.codedDomainValue.pulse());c||this.codedDomainValue.set(this.codedValues.getAt(0).val),this._settingCodedDomainValue=!1}}},b.prototype.getAllPossibleCodedValues=function(){var t=[];t.push.apply(t,this.selectedField.getCodedValueDomain().codedValues);for(var e=this.selectedField.getSubtypeCodedValueDomains(),r=0,i=Object.keys(e);r<i.length;r++){var a=e[i[r]];t.push.apply(t,a.codedValues.filter(function(e){return-1===t.indexOf(e)}))}return t.map(function(e){return{name:e.name,val:e.code}})},b.prototype._updateInputVisibility=function(e,t){this.showTextInput.set(!1),this.showDateTimeInput.set(!1),this.showCodedValueDomainInput.set(!1),this.showDisabledInput.set(!1),t===y.QueryOperator.IsNotNull||t===y.QueryOperator.IsNull?this.showDisabledInput.set(!0):e.isDate()?this.showDateTimeInput.set(!0):!b._isCodedValueDomain(e)||t!==y.QueryOperator.Equals&&t!==y.QueryOperator.NotEquals?this.showTextInput.set(!0):this.showCodedValueDomainInput.set(!0)},b.prototype._operatorChanged=function(){if(this.selectedField){var e=this.selectedField;e.isTypeField&&this.parentQuery.updateCodedDomainValues();var t=parseInt(this.selectedOperator.get(),10);this._updateInputVisibility(e,t),this.parentQuery.isModified.set(!0)}},b._isCodedValueDomain=function(e){return!!e&&(e.isCodedValueDomain()||e.hasSubtypeCodedValueDomains())},b.prototype.dispose=function(){this._codedDomainSelectionBinding&&this.codedDomainValue.unbind(this._codedDomainSelectionBinding),this._autocompleteSelectionBinding&&this.autoCompleteViewModel.value.unbind(this._autocompleteSelectionBinding),this.selectedFieldName.unbind(this._selectedFieldNameBindingToken),this.selectedOperator.unbind(this._selectedOperatorBindingToken),this.codedDomainValue.unbind(this._codedDomainValueBindingToken),this.fieldValue.removeSync(),this.presentableFieldName.removeSync(),this.presentableFieldValue.removeSync(),this.presentableOperator.removeSync(),this.autoCompleteView&&this.autoCompleteView.dispose()},b);function b(e,t,r){var i=d.call(this,e,t)||this;return i._settingCodedDomainValue=!1,i.fields=new o.ObservableCollection,i.fieldValue=new o.Observable,i.codedDomainValue=new o.Observable,i.operators=new o.ObservableCollection,i.selectedFieldName=new o.Observable,i.selectedOperator=new o.Observable,i.deleteDisabled=new o.Observable(!1),i.codedValues=new o.ObservableCollection,i.presentableFieldName=new o.Observable,i.presentableOperator=new o.Observable,i.presentableFieldValue=new o.Observable,i.presentableFieldValueIsEmptyText=new o.Observable,i.logicalOperator=new o.Observable,i.showTextInput=new o.Observable,i.showDateTimeInput=new o.Observable,i.showCodedValueDomainInput=new o.Observable,i.showDisabledInput=new o.Observable,i.id.set(a.idPrefix+u.alphaNumericToken()),i.type="queryItem",i.autoCompleteViewModel=new n.AutoCompleteViewModel(e,t),(i.autoCompleteViewModel.queryClause=i).datePickerFormItem=new s.DatePickerFormItem(null),i.datePickerFormItem.nullable.set(!1),i.layer=r.layer.get(),i.parentQuery=r,i.templateType="single-item",i.selectedOperator.set(y.QueryOperator.Equals.toString()),i._selectedFieldNameBindingToken=i.selectedFieldName.bind(i,i._fieldChanged),i._selectedOperatorBindingToken=i.selectedOperator.bind(i,i._operatorChanged),i._codedDomainValueBindingToken=i.codedDomainValue.bind(i,function(e){!i._settingCodedDomainValue&&i.selectedField.isTypeField&&i.parentQuery.updateCodedDomainValues()}),i.fieldValue.bind(i,function(){i.parentQuery.isModified.set(!0)}),i.presentableFieldName.syncTransform(i.selectedFieldName,function(e){var t=i.fields.get().filter(function(e){return e.name===i.selectedFieldName.get()})[0];return t?t.alias:""}),i.presentableFieldValue.syncTransform(i.fieldValue,function(e){if(e){i.presentableFieldValueIsEmptyText.set(!1);var t=p.parseDate(e,c.DateFormat.ROUND_TRIP);if(i.selectedField&&i.selectedField.type===g.EsriFieldTypes.esriFieldTypeDate&&t&&!isNaN(t.getTime()))return f.QueryFormatterFactory.getFormatter(i.parentQuery.layer.get()).supportsTimeOfDay()?p.formatDate(t,c.DateFormat.DATE_TIME_SHORT):p.formatDate(t,c.DateFormat.DATE_SHORT);if(b._isCodedValueDomain(i.selectedField))for(var r=0;r<i.codedValues.length();r++)if(i.codedValues.getAt(r).val===i.codedDomainValue.get())return i.codedValues.getAt(r).name;return i.selectedField.isNumeric()?i.selectedField.formatValue(e):"'{0}'".format(e)}return i.presentableFieldValueIsEmptyText.set(!0),i.app.getResource(i.libraryId,"language-querybuilder-any-value")}),i.presentableOperator.syncTransform(i.selectedOperator,function(e){return l.QueryOperatorDescription.FromQueryOperator(parseInt(e,10)).name}),i.logicalOperator.bind(i,function(){i.isAnd.set(i.logicalOperator.get()===y.Conjunctions.and),i.isOr.set(i.logicalOperator.get()===y.Conjunctions.or)}),i.logicalOperator.sync(i.parentQuery.selectedLogicalOperator),i.parentQuery.selectedLogicalOperator.bind(i,function(){i.updateCodedDomainValues()}),i}a.QueryClause=v})},"Mapping/modules/QueryBuilder/QueryCollection":function(){define(["require","exports","geocortex/framework/observables","./Query","geocortex/framework/utils/utils","geocortex/framework/events/Event","./QueryErrorHandling","./QueryBuilderModule","geocortex/infrastructure/PromiseUtils"],function(e,t,a,i,s,n,o,l,u){"use strict";var r;Object.defineProperty(t,"__esModule",{value:!0}),t.Sources={Project:"project",AdministratorDefined:"adminDef",CurrentSession:"curSession"},(r=t.Operations||(t.Operations={}))[r.CREATE=0]="CREATE",r[r.UPDATE=1]="UPDATE",r[r.DELETE=2]="DELETE";var d=(p.prototype.initialize=function(){return this._initializeData()},p.prototype._initializeData=function(){var r=this;return Promise.all([this._retrieveLocalQueries()]).then(function(e){var t=[];return e.forEach(function(e){t.push.apply(t,e)}),u.PromiseUtils.mapSkipRejected(t,function(e){return r.getQueryByName(e.displayName.get()),null!==e&&e.displayName.set(e.displayName.get().concat("_duplicate")),r.addQuery(e)},{concurrency:1/0},!0)})},p.prototype._retrieveLocalQueries=function(){var r=this;return this.store?this.app.store.get(this.queryStorageKey).then(function(e){var t=[];if(e)try{t=JSON.parse(e)}catch(e){r.app.trace.error("Unable to parse user queries",e)}return u.PromiseUtils.mapSkipRejected(t,function(e){var t=new i.Query(r.app,r.libraryId,{layer:null,layerIsTable:!1,logicalOperator:"AND"});return t.setErrorHandler(r,r.isFilterCollection,o.handleQueryErrors),t.applyState(e,l.latestProjectSerialVersion)},{concurrency:1/0},!0)},function(e){return r.app.trace.error("Could not retrieve user queries from storage"),new Array}):Promise.resolve(new Array)},p.prototype._save=function(e){var r=this;if(this.store){var i=JSON.stringify(this._queries.get().map(function(e){return e.exportState()}));return new Promise(function(e,t){r.store.set(r.queryStorageKey,i,function(e,t){r._bindingEventDisabled||r.bindingEvent.publish()},function(e){r.app.trace.error("Could not save QueryCollection",e),t(e)})})}return this._bindingEventDisabled||(void 0!==e?this.bindingEvent.publish(e):this.bindingEvent.publish()),Promise.resolve()},p.prototype.setCollectionChangedEvent=function(e){this.bindingEvent=e},p.prototype.disableCollectionChangedEvent=function(){this._bindingEventDisabled=!0},p.prototype.enableCollectionChangedEvent=function(){this._bindingEventDisabled=!1},p.prototype.getAllQueries=function(){return this._queries.get()},p.prototype.getQueryById=function(t){var e=this._queries.get().filter(function(e){return e.id.get()===t});return 1<=e.length?(1<e.length&&this.app.trace.warning("multiple queries with the same id "+t+" found. Returning the first result"),e[0]):null},p.prototype.getQueryByName=function(t){var e=this._queries.get().filter(function(e){return e.displayName.get()===t});return 1<=e.length?(1<e.length&&this.app.trace.warning("multiple queries with the same name "+t+" found. Returning the first result"),e[0]):null},p.prototype.removeQueryById=function(t){var e=this._queries.get().filter(function(e){return e.id.get()===t});return 1<=e.length?(1<e.length&&this.app.trace.warning("multiple queries with the same id "+t+" found. Removing the first result"),this._queries.removeItem(e[0]),this._save().then(function(){return e[0]})):null},p.prototype.updateQueryById=function(e,t){if(t){var r=this.getQueryById(e);if(r){var i=this._queries.indexOf(r);return this._queries.removeItem(r),t.id.set(e),this._queries.insertItem(i,t),this._save().then(function(){return t})}}},p.prototype.addQuery=function(t){if(t)return 1<=this._queries.get().filter(function(e){return!(!t.displayName.get()||!e.displayName.get())&&e.displayName.get()===t.displayName.get()}).length?void this.app.trace.error("Cannot add duplicate query "+t.displayName.get()+" to collection."):(this._queries.addItem(t),this._save(0).then(function(){return t}))},p.prototype.getQueriesByLayer=function(t){return this._queries.get().filter(function(e){return!!e.layer.get()&&e.layer.get().uniqueId===t.uniqueId})},p.prototype.removeQueriesByLayer=function(e){var t=this,r=this.getQueriesByLayer(e);return r.forEach(function(e){return t._queries.removeItem(e)}),this._save().then(function(){return r})},p.prototype.clear=function(){return this._queries.clear(),this._save()},p.prototype.length=function(){return this._queries.length()},p);function p(e,t,r){if(this.queryStorageKey="QC",this.isFilterCollection=!1,this.id="QC-"+s.alphaNumericToken(),this.app=e,this.libraryId=t,r.persistent){var i=new Error;i.message="Persistent queries not supported",this.app.trace.error("Persistent queries not supported",i)}else this.store=null;this.sourceName=r.sourceName?r.sourceName:null,this.queryStorageKey+="-"+(this.sourceName?this.sourceName:"unknown"),this._queries=new a.ObservableCollection,this.bindingEvent=new n.Event("placeholderForQueryCollectionChanged",e)}t.QueryCollection=d})},"Mapping/modules/QueryBuilder/QueryErrorHandling":function(){define(["require","exports"],function(e,t){"use strict";var y,r;Object.defineProperty(t,"__esModule",{value:!0}),(r=y=t.ERRCODES||(t.ERRCODES={}))[r.NOTFOUND=0]="NOTFOUND",r[r.DUPLICATE=1]="DUPLICATE",r[r.LAYERMISSINGERROR=2]="LAYERMISSINGERROR",r[r.LAYERFIELDERROR=3]="LAYERFIELDERROR",r[r.SAVINGERROR=4]="SAVINGERROR",r[r.EXECUTIONFAILURE=5]="EXECUTIONFAILURE",r[r.ADDQUERYCLAUSEERROR=6]="ADDQUERYCLAUSEERROR",r[r.NONAMEGIVENERROR=7]="NONAMEGIVENERROR",r[r.RETRIEVECOLLECTIONERROR=8]="RETRIEVECOLLECTIONERROR",r[r.UPDATEQUERYERROR=9]="UPDATEQUERYERROR",t.handleQueryErrors=function(e,t){var r=t;if(void 0!==r.displayStatus&&null!==r.displayStatus&&typeof r.displayStatus==typeof!0||(r.displayStatus=!0),!r.handled){switch(r.handled=!0,r.code){case y.LAYERMISSINGERROR:var i=t;this.app.trace.error("Could not load "+(e?"filter":"query")+" because layer "+i.layerName+" is missing. The list of layers follows in debug mode if it has been retrieved.",t);var a="";i.allLayers&&i.allLayers.forEach(function(e){a+=e.name+" \n"}),this.app.trace.debug(a),r.displayStatus&&this.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(this.app.getResource(this.libraryId,"language-querybuilder-error-data-source-missing").format(e?"filter":"query",i.queryState.displayName,i.layerName),{error:!0});break;case y.LAYERFIELDERROR:var s=t,n=void 0;n=s.missingFieldName?(this.app.trace.error("Could not restore queryClause with id "+s.queryClause.id.get()+": The field "+s.missingFieldName+" is missing.\n                    The full list of fields follows the queryClause has follows: \n"+s.allFields.map(function(e){return e.name}),t),this.app.getResource(this.libraryId,"language-querybuilder-error-field-missing").format(e?"filter":"query",s.missingFieldName)):(this.app.trace.error("Could not restore a queryClause for an unknown reason.",t),this.app.getResource(this.libraryId,"language-querybuilder-error-restore-clause-unknown")),r.displayStatus&&this.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(n,{error:!0});case y.NOTFOUND:var o=r;this.app.trace.error("Could not find "+(e?"filter":"query")+" with id "+o.id+" and name "+o.queryName);var l=this.app.getResource(this.libraryId,"language-querybuilder-error-not-found").format(e?"filter":"query");o.queryName&&(l+=" with name "+o.queryName),r.displayStatus&&this.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(l,{error:!0});break;case y.DUPLICATE:var u=r;this.app.trace.error("Could not add "+(e?"filter":"query")+" with duplicate name "+u.queryName),r.displayStatus&&this.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(this.app.getResource(this.libraryId,"language-querybuilder-error-saving-duplicate").format(e?"filter":"query",u.queryName),{error:!0});break;case y.SAVINGERROR:var d=r;this.app.trace.error("Error saving "+(e?"filter":"query")+" with name "+d.queryName),r.displayStatus&&this.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(this.app.getResource(this.libraryId,"language-querybuilder-error-saving").format(e?"filter":"query",d.queryName),{error:!0});break;case y.ADDQUERYCLAUSEERROR:var p=r;this.app.trace.error("Error adding "+p.clauses.length+" "+(e?"filter":"query")+" clauses\n                Following is the clause information in debug logging mode"),this.app.trace.debug(p.clauses.map(function(e){return e.exportState().toString()})),r.displayStatus&&this.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(this.app.getResource(this.libraryId,"language-querybuilder-error-add-query-clause").format(e?"filter":"query",p.clauses.length),{error:!0});break;case y.NONAMEGIVENERROR:this.app.trace.error("A name must be provided to rename a query"),r.displayStatus&&this.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(this.app.getResource(this.libraryId,"language-querybuilder-error-no-name").format(e?"filter":"query"),{error:!0});break;case y.RETRIEVECOLLECTIONERROR:this.app.trace.error("Could not retrieve queries for list of saved "+(e?"filters":"queries")),r.displayStatus&&this.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(this.app.getResource(this.libraryId,"language-querybuilder-error-retrieve-queries").format(e?"filter":"query"),{error:!0});break;case y.UPDATEQUERYERROR:var c=void 0;c=r.adminDefined?this.app.getResource(this.libraryId,"language-querybuilder-error-update-query-admin"):this.app.getResource(this.libraryId,"language-querybuilder-error-update-query-unknown"),this.app.trace.error("Could not update saved "+(e?"filter":"query")),r.displayStatus&&this.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(c.format(e?"filter":"query"),{error:!0});break;default:r.displayStatus&&this.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(t.message,{error:!0})}this.app.debugMode&&console.error(t.stack)}}})},"Mapping/modules/QueryBuilder/QueryOperator":function(){define(["require","exports"],function(e,t){"use strict";var r;Object.defineProperty(t,"__esModule",{value:!0}),(r=t.QueryOperator||(t.QueryOperator={}))[r.Equals=0]="Equals",r[r.NotEquals=1]="NotEquals",r[r.GreaterThan=2]="GreaterThan",r[r.GreaterThanEquals=3]="GreaterThanEquals",r[r.LessThan=4]="LessThan",r[r.LessThanEquals=5]="LessThanEquals",r[r.Contains=6]="Contains",r[r.DoesNotContain=7]="DoesNotContain",r[r.StartsWith=8]="StartsWith",r[r.EndsWith=9]="EndsWith",r[r.IsNull=10]="IsNull",r[r.IsNotNull=11]="IsNotNull",t.Conjunctions={and:"and",or:"or"}})},"Mapping/modules/QueryBuilder/QueryOperatorDescription":function(){define(["require","exports","./QueryOperator"],function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=(a.FromQueryOperator=function(e){for(var t in a)if(a[t].value==e)return a[t];return null},a.initializeStaticValues=function(e,t){this.Equals=new a(r.QueryOperator.Equals,e.getResource(t,"language-querybuilder-operator-equals")),this.NotEquals=new a(r.QueryOperator.NotEquals,e.getResource(t,"language-querybuilder-operator-not-equals")),this.GreaterThan=new a(r.QueryOperator.GreaterThan,e.getResource(t,"language-querybuilder-operator-greater-than")),this.GreaterThanEquals=new a(r.QueryOperator.GreaterThanEquals,e.getResource(t,"language-querybuilder-operator-greater-than-equal-to")),this.LessThan=new a(r.QueryOperator.LessThan,e.getResource(t,"language-querybuilder-operator-less-than")),this.LessThanEquals=new a(r.QueryOperator.LessThanEquals,e.getResource(t,"language-querybuilder-operator-less-than-equal-to")),this.Contains=new a(r.QueryOperator.Contains,e.getResource(t,"language-querybuilder-operator-contains")),this.DoesNotContain=new a(r.QueryOperator.DoesNotContain,e.getResource(t,"language-querybuilder-operator-does-not-contain")),this.StartsWith=new a(r.QueryOperator.StartsWith,e.getResource(t,"language-querybuilder-operator-starts-with")),this.EndsWith=new a(r.QueryOperator.EndsWith,e.getResource(t,"language-querybuilder-operator-ends-with")),this.IsNull=new a(r.QueryOperator.IsNull,e.getResource(t,"language-querybuilder-operator-null")),this.IsNotNull=new a(r.QueryOperator.IsNotNull,e.getResource(t,"language-querybuilder-operator-not-null"))},a);function a(e,t){this.value=e,this.name=t}t.QueryOperatorDescription=i})},"Mapping/modules/QueryBuilder/SimpleQueryBuilderView":function(){var i,y=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});define(["require","exports","geocortex/framework/ui/ViewBase","geocortex/framework-ui/ViewContainer/ViewContainerView","geocortex/forms/items/TimePickerFormItem","./AutoCompleteView","geocortex/framework/resourceManager","./Formatters","geocortex/framework/observables","geocortex/essentials/MapServiceConstants"],function(e,t,r,a,l,u,d,p,i,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var c,n=(c=r.ViewBase,y(o,c),o.prototype.attach=function(e){var r=this;this._isFilterBuilder.set("filter"===this.configuration.mode),c.prototype.attach.call(this,e),this._isFilterBuilder.sync(e.isFilterBuilder),this.viewModel.initializeFromViewConfig(this.configuration),this.attachQuery(),this.app.event("_deattachingQuery").subscribe(this,function(){r.deattachQuery()}),this.app.event("_newQueryAttached").subscribe(this,function(){r.attachQuery()}),this.app.event("_logicalOperatorChanged").subscribe(this,this.handleLogicalOperatorChanged),this._observableTokenDictionary.displayedQueryIsSaved=this.viewModel.displayedQueryIsSaved.bind(this,function(e){var t=r._getQueryTitle(r.viewModel.displayedQuery.get().displayName.get(),r.viewModel.displayedQueryIsSaved.get());t=r._getModifiedStatusTitle(t,r.viewModel.displayedQuery.get().isModified.get(),r.viewModel.displayedQueryIsSaved.get()),r.title.set(t)}),this._initialized||(dojo.connect(this.viewModel,"event_queryClausesRemoving",this,this.viewModel_queryClausesRemoving),this.bindAutoCompleteEvents(),this._initialized=!0),this._registerCommandsAndEvents()},o.prototype.activated=function(){this._processedInitialDefaultFilter||(this.viewModel.checkForExistingFilter(),this._processedInitialDefaultFilter=!0),this.viewModel.refreshQueryGeometry()},o.prototype.deattachQuery=function(){this.viewModel.displayedQuery.get()&&(this._observableTokenDictionary.isModifed&&this.viewModel.displayedQuery.get().isModified.unbind(this._observableTokenDictionary.isModifed),this._observableTokenDictionary.displayName&&this.viewModel.displayedQuery.get().displayName.unbind(this._observableTokenDictionary.displayName))},o.prototype.attachQuery=function(){var r=this;this.viewModel.displayedQuery.get()&&(this._observableTokenDictionary.isModified=this.viewModel.displayedQuery.get().isModified.bind(this,function(e){r.title.set(r._getModifiedStatusTitle(r.title.get(),e,r.viewModel.displayedQueryIsSaved.get()))}),this._observableTokenDictionary.displayName=this.viewModel.displayedQuery.get().displayName.bind(this,function(e){var t=r._getQueryTitle(e,r.viewModel.displayedQueryIsSaved.get());t=r._getModifiedStatusTitle(t,r.viewModel.displayedQuery.get().isModified.get(),r.viewModel.displayedQueryIsSaved.get()),r.title.set(t)}))},o.prototype.deactivated=function(){this._isFilterBuilder.get()?this.app.command("RemoveFilterStatus").execute():this.app.command("RemoveQueryStatus").execute(),this.viewModel.extentChangeHandle&&this.viewModel.extentChangeHandle.remove()},o.prototype._getQueryTitle=function(e,t){var r;if(e&&0<e.length)if(t){var i=": "+e;r=this.app.getResource(this.libraryId,this.viewModel.isFilterBuilder.get()?"language-querybuilder-simple-filter-title-saved":"language-querybuilder-simple-title-saved").concat(i)}else r=this.app.getResource(this.libraryId,this.viewModel.isFilterBuilder.get()?"language-querybuilder-simple-filter-title":"language-querybuilder-simple-title");else r=this.app.getResource(this.libraryId,this.viewModel.isFilterBuilder.get()?"language-querybuilder-simple-filter-title":"language-querybuilder-simple-title");return r},o.prototype._getModifiedStatusTitle=function(e,t,r){if(t&&r){if(!e.endsWith(" *"))return e.concat(" *")}else if(e.endsWith(" *"))return e.slice(0,-1*" *".length);return e},o.prototype._registerCommandsAndEvents=function(){var t,r=this;this.app.command(this.viewModel.isFilterBuilder.get()?"DisplayFilter":"DisplayQuery").register(this,this._executeDisplayQuery);var e=this.app.viewManager.getRegionForViewId(this.id);if(e){var i=e.ownerView;i instanceof a.ViewContainerView&&(t=i)}t?this.app.event("ViewContainerDeactivatedEvent").subscribe(this,function(e){e.id===t.id&&r.app.command(r.viewModel.isFilterBuilder.get()?"RemoveFilterStatus":"RemoveQueryStatus").execute()}):this.app.trace.warning((this.viewModel.isFilterBuilder.get()?"Filter":"Query")+" Builder could\n                                    not find enclosing container for view: "+this.id+".\n\n                                    Status messages will NOT be dismissed when this ViewContainer is deactivated."),this.app.event("ViewActivatedEvent").subscribe(this,function(e){if(!r._activatingView){if(r._activatingView=!0,e.id===(r._isFilterBuilder.get()?"SimpleFilterBuilderContainerView":"SimpleQueryBuilderContainerView")){var t=e.childRegions.filter(function(e){return e.name===(r._isFilterBuilder.get()?"SimpleFilterBuilderContainerRegion":"SimpleQueryBuilderContainerRegion")});1===t.length?0===t[0].activeViews.length&&r.app.viewManager.activateView(r):r.app.trace.error("Could not find region containing views for the\n                                                "+(r._isFilterBuilder.get()?"filter":"query")+" builder. No view may be\n                                                hosted in the panel. Please reopen the "+(r._isFilterBuilder.get()?"filter":"query")+"\n                                                tool.")}r._activatingView=!1}})},o.prototype._executeDisplayQuery=function(t,e){var r=this;this.viewModel.queryExists(t.id.get()).then(function(e){return r.viewModel.displayedQueryIsSaved.set(e),r.viewModel.applyDisplayedQueryState(t.exportState())}).then(function(){r.viewModel.selectedLayerUniqueId.set(r.viewModel.displayedQuery.get().layerId.get()),r.viewModel.displayedQuery.get().isModified.set(!1),r.app.viewManager.activateView(r),e&&e()}).catch(function(e){r.app.trace.error("Could not display the given query with id "+t.id.get()+" and name "+t.displayName.get()+" as it could not be loaded")})},o.prototype.form_keydown=function(e){if(50<(new Date).getTime()-(this._lastAutoCompleteTime?this._lastAutoCompleteTime.getTime():0)&&13===e.keyCode){var t=$(e.target);if(0<=t.prop("tagName").search(/^input$/i)&&0<=t.prop("type").search(/^text$/i))return this.performAction(),!1}return!0},o.prototype.form_submit=function(){return!1},o.prototype.bindAutoCompleteEvents=function(){var t=this;$(this.htmlForm).on("autocompleteselect","input.ui-autocomplete-input",function(e){t._lastAutoCompleteTime=new Date})},o.prototype.handleRadioClick=function(e,t,r){"or"===t.value?r.selectedLogicalOperator.set("or"):r.selectedLogicalOperator.set("and")},o.prototype.handleLogicalOperatorChanged=function(e,t){"or"===t?$("[name=radioButtonGroup"+e.get()+"][value=or]").prop("checked",!0):$("[name=radioButtonGroup"+e.get()+"][value=and]").prop("checked",!0)},o.prototype.addQueryClause_click=function(e,t,r){this.viewModel.addQueryClause(r).then(function(){$(".query-clause-row").last().find("input, select").first().focus()})},o.prototype.addNestedQuery_click=function(e,t,r){this.viewModel.addNestedQuery(r)},o.prototype.removeQueryClause_click=function(e,t,r){null===r.parentQuery.parentQuery||void 0===r.parentQuery.parentQuery?1<r.parentQuery.queryClauses.length()&&this.viewModel.removeQueryClause(r):1<r.parentQuery.queryClauses.length()?this.viewModel.removeQueryClause(r):this.viewModel.removeNestedQuery(r.parentQuery)},o.prototype.actionButton_click=function(){this.performAction()},o.prototype.clearFilterButton_click=function(){this.viewModel.disabled.set(!1);var e=this.viewModel.displayedQuery.get().layer.get();e.setDefinitionExpression(this.viewModel.defaultLayerFilters[e.uniqueId]),e.serviceLayerInfo.serviceType===s.MapServiceType.STREAM&&e.serviceLayerInfo.serviceLayer.setGeometryDefinition(null)},o.prototype.clearResultsButton_click=function(){this.event_clearResultsButtonClicked()},o.prototype.cancelButton_click=function(){this.app.viewManager.deactivateView(this)},o.prototype.externalfilterButton_click=function(){this.viewModel.displayedQuery.get().layer.get().setDefinitionExpression("1 = 2")},o.prototype.event_clearResultsButtonClicked=function(){},o.prototype.onFilterSelected=function(){this.viewModel.refreshQueryGeometry()},o.prototype.performAction=function(){this.viewModel.isQueryBuilder.get()?this.viewModel.executeQuery(this.viewModel.displayedQuery.get()):(this.viewModel.executeFilter(this.viewModel.displayedQuery.get()),this.app.event("FilterBuilderLayerDefinitionAppliedEvent").publish({gcxlayer:this.viewModel.displayedQuery.get().layer.get().gcxLayer}))},o.prototype.resolveWidget=function(e,t,r){if(c.prototype.resolveWidget.call(this,e,t),!e)return null;switch(e){case"QueryActionsWidget":return this.app.menuRegistry.createMenuWidget(this,t,r,this.libraryId,this._isFilterBuilder.get()?"FilterBuilderActions":"QueryBuilderActions");case"DatePicker":var i=p.QueryFormatterFactory.getFormatter(this.viewModel.displayedQuery.get().layer.get());t.datePickerFormItem.includeTimePicker.set(i.supportsTimeOfDay());var a=new l.TimePickerFormItem(null);t.datePickerFormItem.timePickerItem=a;var s=this.app.viewManager.createView({markupResource:"Mapping/infrastructure/ui/components/Forms/DatePickerFormItemView.html",libraryId:"Mapping.Infrastructure",typeName:"geocortex.essentialsHtmlViewer.mapping.infrastructure.ui.components.Forms.DatePickerFormItemView",isVisible:!0});return s.attach(t.datePickerFormItem),t.datePickerView=s;case"AutoComplete":var n=new u.AutoCompleteView(this.app,this.libraryId),o=document.createElement("span");return dojo.html.set(o,d.resourceManager.fetch("Mapping/modules/QueryBuilder/AutoCompleteView.html",this.libraryId)),n.root=o,t.autoCompleteViewModel.appendTo="."+this.id+" .autocomplete-container",n.attach(t.autoCompleteViewModel),t.autoCompleteView=n;default:return null}},o.prototype.viewModel_queryClausesRemoving=function(e){for(var t=0,r=e;t<r.length;t++)(s=r[t]).datePickerView&&$(s.datePickerView.root).find("input, button, select").off();for(var i=0,a=e;i<a.length;i++){var s;(s=a[i]).autoCompleteView&&$(s.autoCompleteView.root).find("input").off()}},o);function o(e,t){var r=c.call(this,e,t)||this;return r._isFilterBuilder=new i.Observable(!1),r._initialized=!1,r._activatingView=!1,r._observableTokenDictionary={},r._processedInitialDefaultFilter=!1,r}t.SimpleQueryBuilderView=n})},"Mapping/modules/QueryBuilder/SimpleQueryBuilderViewModel":function(){var i,x=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});define(["require","exports","geocortex/infrastructure/FeatureSetCollection","geocortex/infrastructure/FeatureSet","geocortex/framework/ui/ViewModelBase","geocortex/framework-ui/FilterableCollection","geocortex/framework/observables","./QueryClause","./QueryOperator","./Formatters","geocortex/infrastructure/gis/AppInfo","./QueryOperatorDescription","./Query","geocortex/infrastructure/ArrayUtils","geocortex/infrastructure/TaskUtils","geocortex/infrastructure/gis/ServiceLayerInfo","geocortex/infrastructure/GeometryUtils","./QueryCollection","./QueryErrorHandling","./QueryBuilderModule","geocortex/infrastructure/PromiseUtils","geocortex/essentials/MapServiceConstants","geocortex/framework/utils/utils","geocortex/infrastructure/MapUtils","geocortex/essentials/StreamLayerService"],function(e,t,r,l,i,a,s,n,o,u,d,p,c,y,g,h,m,f,v,b,Q,w,S,I,_){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var C,F=(C=i.ViewModelBase,x(O,C),O.prototype.attachQuery=function(e){var t,r=this;this.displayedQuery.get()&&(this._observableTokenDictionary.hasOwnProperty("spatialFilter")&&this.selectedSpatialFilter.unbind(this._observableTokenDictionary.spatialFilter),this._observableTokenDictionary.hasOwnProperty("layerId")&&this.selectedLayerUniqueId.unbind(this._observableTokenDictionary.layerId),this._observableTokenDictionary.hasOwnProperty("saveQueryCanExecute")&&this.displayedQuery.get().isModified.unbind(this._observableTokenDictionary.saveQueryCanExecute),this.displayedQuery.get().selectedSpatialFilter.removeSync(),this.displayedQuery.get().selectedSpatialFilterName.removeSync(),this.displayedQuery.get().defaultLogicalOperator.removeSync(),this.displayedQuery.get().removeErrorHandler(),t=this.displayedQuery.get().numSuggestions),this.app.event("_deattachingQuery").publish(),this.displayedQuery.set(e),this.displayedQuery.get().selectedLogicalOperator.pulse(),this.displayedQuery.get().setErrorHandler(this,this.isFilterBuilder.get(),v.handleQueryErrors),this._observableTokenDictionary.spatialFilter=this.selectedSpatialFilter.bind(this,function(e){r.displayedQuery.get().isModified.set(!0),"string"==typeof e&&(e=parseInt(e,10));for(var t=0;t<r.spatialFilters.length();t++)r.spatialFilters.getAt(t).val===e&&r.selectedSpatialFilterName.set(r.spatialFilters.getAt(t).name)}),this._observableTokenDictionary.saveQueryCanExecute=this.displayedQuery.get().isModified.bind(this,function(){r.app.command(r.isFilterBuilder.get()?"ShowSaveFilterDialog":"ShowSaveQueryDialog").raiseCanExecuteChanged()}),this._observableTokenDictionary.layerId=this.selectedLayerUniqueId.bind(this,function(){r.layerIdChanged().then(function(){null!==r.displayedQuery.get().layer.get()&&r.displayedQuery.get().buildWhereClause()})}),this.displayedQuery.get().selectedSpatialFilter.sync(this.selectedSpatialFilter),this.displayedQuery.get().selectedSpatialFilterName.sync(this.selectedSpatialFilterName),this.displayedQuery.get().defaultLogicalOperator.sync(this.defaultLogicalOperator),this.displayedQuery.get().numSuggestions=t,this.app.event("_newQueryAttached").publish()},O.prototype.initialize=function(e){var t=this;e&&(this.config=e),this.app.waitUntilApplicationReady().then(function(){t._initializingPromise||(t._initializingPromise=t.app.waitUntilSiteServiceLayersLoaded().then(function(){var e=d.AppInfo.fromGeocortexApp(t.app);t.initializeQueryBuilder(e),t.registerCommandsAndEvents()}))})},O.prototype.initializeFromViewConfig=function(e){e&&(this.config=e);var t=new c.Query(this.app,this.libraryId,{layer:null,layerIsTable:!1,logicalOperator:null});this.attachQuery(t),this.queryFormatterFactory=new u.QueryFormatterFactory(this.config),this.isDebug.set(!!this.app.debugMode),this.isAwab.set(this.app.isArcGisWebApp),p.QueryOperatorDescription.initializeStaticValues(this.app,this.libraryId);var r="filter"!==this.config.mode;if(this.isQueryBuilder.set(r),this.isFilterBuilder.set(!r),this.isQueryAndAwab.set(this.isAwab.get()&&r),this.displayedQuery.get().setErrorHandler(this,this.isFilterBuilder.get(),v.handleQueryErrors),r?this.noAvailableLayersText.set(this.app.getResource(this.libraryId,"language-querybuilder-no-valid-query-layers")):this.noAvailableLayersText.set(this.app.getResource(this.libraryId,"language-querybuilder-no-valid-filter-layers")),e.hasOwnProperty("defaultLogicalOperator")&&null!=e.defaultLogicalOperator&&"string"==typeof e.defaultLogicalOperator){var i=e.defaultLogicalOperator.toLowerCase();void 0===o.Conjunctions[i]||null===o.Conjunctions[i]?(this.displayedQuery.get().selectedLogicalOperator.set(this.defaultLogicalOperator.get()),this.app.trace.warning('Invalid default conjunction "'+i+'" given. Using '+this.defaultLogicalOperator.get()+" as the default")):(this.defaultLogicalOperator.set(o.Conjunctions[i]),this.displayedQuery.get().selectedLogicalOperator.set(o.Conjunctions[i]))}e.hasOwnProperty("numberOfSuggestions")&&null!=e.numberOfSuggestions&&("number"!=typeof(i=e.numberOfSuggestions)||i<0?(this.displayedQuery.get().numSuggestions=10,this.app.trace.warning('Invalid number of suggestions "'+i+'" given. Using '+this.displayedQuery.get().numSuggestions+" as the default")):this.displayedQuery.get().numSuggestions=i)},O.prototype.initializeQueryBuilder=function(e){this._appInfo=e,this._allLayers.clear();var t=e.mapInfo.getLayerInfos().filter(function(e){return(e.queryable||e.serviceLayerInfo.serviceType===w.MapServiceType.STREAM)&&!!e.displayName});t=y.ArrayUtils.sortBy(t,function(e){return e.displayName}),this._allLayers.set(t);var r=e.mapInfo.getTableInfos().filter(function(e){return e.queryable&&!!e.displayName&&!!e.url});this._allTables.set(r),this._checkUseableLayers(),this.layers.setSource(this._allLayers),this.tables.setSource(this._allTables),this.layers.setFilter(function(e){return e&&(!e.gcxLayer||e.gcxLayer.inActiveTheme)}),0<this.layers.length()&&this.layers.getAt(0)?this.selectedLayerUniqueId.set(this.layers.getAt(0).uniqueId):0<this.tables.length()&&this.tables.getAt(0)?this.selectedLayerUniqueId.set(this.tables.getAt(0).uniqueId):0===this.layers.length()&&0===this.tables.length()&&this.noAvailableLayers.set(!0),this._handleNewServiceLayers(e.mapInfo.serviceLayers),this.refreshSpatialFilterOptions(),this.displayedQuery.get().isModified.set(!1)},O.prototype.registerCommandsAndEvents=function(){var i=this;this.isQueryBuilder.get()&&this.app.command("RunQuery").register(this,this.executeQuery),this.isQueryBuilder.get()&&this.app.command("RunFilter").register(this,this._executeRunFilter),this.app.command(this.isFilterBuilder.get()?"ShowSaveFilterDialog":"ShowSaveQueryDialog"),this.app.command(this.isFilterBuilder.get()?"ShowSaveFilterDialog":"ShowSaveQueryDialog").canExecute=function(){return!(!i.displayedQueryIsSaved.get()||i.displayedQuery.get().adminDefined)&&i.displayedQuery.get().isModified.get()},this.app.command(this.isFilterBuilder.get()?"ShowSaveFilterDialog":"ShowSaveQueryDialog").raiseCanExecuteChanged(),this.app.command(this.isFilterBuilder.get()?"_ExportFilterBuilderState":"_ExportQueryBuilderState").register(this,function(e,t,r){i.exportState(e),t(e)}),this.app.command(this.isFilterBuilder.get()?"_ApplyFilterBuilderState":"_ApplyQueryBuilderState").register(this,function(e){e.completePromises.push(i.applyState(e.state))}),this.app.event(this.isFilterBuilder.get()?"SavedFiltersChangedEvent":"SavedQueriesChangedEvent").subscribe(this,function(e){if(void 0===e||0!==e){var t=i._isRestoringStatePromise.then(function(){return i.getCopyOfSavedQuery(i.displayedQuery.get().id.get())}).then(function(e){e?i.applyDisplayedQueryState(e.exportState()).then(function(){i.displayedQueryIsSaved.set(!0)}):i.displayedQueryIsSaved.set(!1)}),r=Q.PromiseUtils.mapSkipRejected(i.volatileQueries.getAllQueries(),function(t){return i.getCopyOfSavedQuery(t.id.get()).then(function(e){return e?i.volatileQueries.updateQueryById(t.id.get(),e):void 0}).catch(function(e){throw e.displayStatus=!1,e})},{concurrency:1/0},!0);return Q.PromiseUtils.allSkipRejected([t,r],!0)}}),this._appInfo.mapInfo.markupLayer.bind(this,this.markupLayerChanged),this.markupLayerChanged(this._appInfo.mapInfo.markupLayer.get());var e="layer-add";this._mapTokenDictionary[e]||(this._mapTokenDictionary[e]=this._appInfo.map.on(e,function(e){i.layerAdded(e)}));var t="layer-remove";this._mapTokenDictionary[t]||(this._mapTokenDictionary[t]=this._appInfo.map.on(t,function(e){i.layerRemoved(e)}));var r="MapServiceLayersChangedEvent";this._gcxTokenDictionary[r]||(this._gcxTokenDictionary[r]=this.app.event("MapServiceLayersChangedEvent").subscribe(this,function(e){e&&e.serviceLayer&&(i.layerRemoved({layer:e.serviceLayer}),i.layerAdded({layer:e.serviceLayer}))}));var a="LayerThemeChangedEvent";this._gcxTokenDictionary[a]||(this._gcxTokenDictionary[a]=this.app.event(a).subscribe(this,function(e){i.layers.refresh();var t=0===i.layers.length();i.noAvailableLayers.set(t),i.layers.indexOf(i.displayedQuery.get().layer.get())<0?i.selectedLayerUniqueId.set(i.layers.length()?i.layers.getAt(0).uniqueId:null):i.selectedLayerUniqueId.pulse()}))},O.prototype.getCopyOfSavedQuery=function(r){var i=this;return new Promise(function(t,e){i.app.command(i.isFilterBuilder.get()?"_getSavedFilterById":"_getSavedQueryById").execute(r,function(e){e.getNewInstance().then(function(e){return t(e)})},function(e){return t(null)})})},O.prototype.queryExists=function(r){var i=this;return new Promise(function(t,e){i.app.command(i.isFilterBuilder.get()?"_getSavedFilterById":"_getSavedQueryById").execute(r,function(e){return t(!0)},function(e){return t(!1)})})},O.prototype.executeQuery=function(s){var n=this,o=s.isModified.get();this.refreshQueryGeometry(s).then(function(e){s.isModified.set(o);var r=n.getFsc(n.app.featureSetManager);r.clear(),n.app.featureSetManager.openCollection(r.id);var i,t=s.execute(n.app.map.spatialReference,n.app.event("QueryCompletedEvent"),!0),a=s.layer.get().gcxLayer;new Promise(t.then).then(function(e){i=new esri.tasks.FeatureSet(e),a.mapService.serviceLayer instanceof esri.layers.FeatureLayer&&(i.features=i.features.map(function(e){return I.findFeatureInMap(e,n.app.site,a.mapService.serviceLayer)||e}))}).then(function(e){return a.getFeatureLayer()}).then(function(e){var t=new l.FeatureSet({esriFeatureSet:i,layer:a,featureLayer:e,app:n.app});t.displayName.set(n.app.getResource(n.libraryId,"language-querybuilder-feature-set-display-name").format(s.layer.get().displayName)),r.featureSets.addItem(t),t.resolveDataLinks(function(e){n.app.event("FeatureChangedEvent").publish(e)}),n.app.featureSetManager.closeCollection(r.id),n.app.command("AddResultsStatus").execute(n.app.getResource(n.libraryId,"language-querybuilder-notification-run-query").format(s.displayName.get()||"Query",s.layer.get().displayName))}).catch(function(e){n.app.trace.error(e),n.app.featureSetManager.closeCollection(r.id)})})},O.prototype._executeRunFilter=function(e){this.executeFilter(e,!0)},O.prototype.executeFilter=function(n,o){var l=this;void 0===o&&(o=!1);var u=n.isModified.get();this.getGeometryFilter(n.selectedSpatialFilter.get()).then(function(e){var r=n.layer.get(),t=e.get();if(n.isModified.set(u),null!==t&&r.serviceLayerInfo.serviceType!==w.MapServiceType.STREAM)l.buildSpatiallyFilteredWhereClause(n,t).then(function(e){l.app.trace.debug("Executing filter with query.buildWhereClause() clause: "+n.buildWhereClause()),l.app.trace.debug("Filter restricted by the following spatial filter: "+e);var t=l._getCompleteWhereClause(r,e);r.setDefinitionExpression(t)});else{r.setDefinitionExpression(l._getCompleteWhereClause(r,n.buildWhereClause()));var i=void 0;if(r.serviceLayerInfo.serviceType===w.MapServiceType.STREAM){var a=r.serviceLayerInfo.serviceLayer;t?(t.getExtent?i=t.getExtent():t instanceof esri.geometry.Extent&&(i=t),a.setGeometryDefinition(i)):a.setGeometryDefinition(null),a.refresh()}l.app.command("ShowMap").execute()}function s(){return l.app.command("AddFilterStatus").execute(l.app.getResource(l.libraryId,"language-querybuilder-notification-run-filter").format(n.displayName.get()||"Filter",n.layer.get().displayName))}o?l.app.command("DisplayFilter").execute(n,function(){s()}):s()})},O.prototype.addNestedQuery=function(t){var r=this,e=new c.Query(this.app,this.libraryId,{layer:t.layer.get(),layerIsTable:t.layerIsTable.get(),logicalOperator:this.defaultLogicalOperator.get()}),i=[];return i.push(new n.QueryClause(this.app,this.libraryId,e),new n.QueryClause(this.app,this.libraryId,e)),e.refreshFields().then(function(){return e.addQueryClauses(i)}).then(function(){return Promise.resolve(t.addChildren([e])[0])}).then(function(e){return e.selectedLogicalOperator.pulse(),Promise.resolve(e)}).catch(function(e){return r.displayedQuery.get().id.get()===t.id.get()&&r.displayedQueryIsSaved.get()?e.displayStatus=!0:e.displayStatus=!1,Promise.reject(e)})},O.prototype.removeNestedQuery=function(e){this._removeNestedQueryRecursive(e,this.displayedQuery.get())},O.prototype._getCompleteWhereClause=function(e,t){return this.defaultLayerFilters[e.uniqueId]?c.Query.appendExpression(this.defaultLayerFilters[e.uniqueId],t,o.Conjunctions.and):t},O.prototype._removeNestedQueryRecursive=function(e,t){if(t.children.contains(e)){var r=[];return r.push(e),t.removeChildren(r),!0}for(var i=0;i<t.children.length();i++)if(this._removeNestedQueryRecursive(e,t.children.getAt(i)))return!0;return!1},O.prototype.getFsc=function(e){if(this._fsc)return e.getCollectionById(this._fsc.id)||e.addCollection(this._fsc),this._fsc;var t=new r.FeatureSetCollection;return e.addCollection(t),t.displayName.set(this.app.getResource(this.libraryId,"language-querybuilder-feature-set-collection-display-name")),t.sourceName="QueryBuilder",this._fsc=t},O.prototype.refreshSpatialFilterOptions=function(){if(this.displayedQuery.get().isModified.set(!1),0===this.spatialFilters.length()&&(this.spatialFilters.addItem({name:this.getResource("language-querybuilder-spatial-filter-all"),val:b.SpatialFilterOptions.None}),this.spatialFilters.addItem({name:this.getResource("language-querybuilder-spatial-filter-current-extent"),val:b.SpatialFilterOptions.CurrentExtent}),this.selectedSpatialFilter.set(b.SpatialFilterOptions.None)),null==this.config.allowDrawingsAsSpatialFilter&&(this.config.allowDrawingsAsSpatialFilter=!0),this.config.allowDrawingsAsSpatialFilter){var e=this._appInfo.mapInfo.markupLayer.get();e&&0<e.graphics.length&&2===this.spatialFilters.length()?this.spatialFilters.addItem({name:this.getResource("language-querybuilder-spatial-filter-polygons"),val:b.SpatialFilterOptions.Drawings}):e&&0!==e.graphics.length||3!==this.spatialFilters.length()||(this.spatialFilters.removeAt(2),this.selectedSpatialFilter.get()===b.SpatialFilterOptions.Drawings&&this.selectedSpatialFilter.set(b.SpatialFilterOptions.None))}this._updateSpatialFilterOption(this.selectedSpatialFilter.get())},O.prototype._updateSpatialFilterOption=function(e){"string"==typeof e&&(e=parseInt(e,10));for(var t=0;t<this.spatialFilters.length();t++)this.spatialFilters.getAt(t).val===e&&(this.selectedSpatialFilter.set(e),this.selectedSpatialFilterName.set(this.spatialFilters.getAt(t).name));return this.selectedSpatialFilter.pulse(),this.app.trace.debug("Could not verify spatial filter option for query with name "+this.displayedQuery.get().displayName.get()+". Option "+e+" not available")},O.prototype.exportState=function(e){var i=this,a=[];if(this.displayedQuery.get().layer.get()){var t=void 0;if(this.displayedQuery.get().adminDefined){var r=this.displayedQuery.get().id.get();this.displayedQuery.get().refreshId(),t=this.displayedQuery.get().exportState(),this.displayedQuery.get().id.set(r),t.adminDefined=!1}else t=this.displayedQuery.get().exportState();a.push(t)}this.volatileQueries.getAllQueries().forEach(function(e){if(e.id.get()!==i.displayedQuery.get().id.get()){var t=void 0;if(e.adminDefined){var r=e.id.get();e.refreshId(),t=e.exportState(),e.id.set(r),t.adminDefined=!1}else t=e.exportState();a.push(t)}}),this.isFilterBuilder.get()?e.filters=a.filter(function(e){return i._layerExistsInMap(e)}):e.queries=a.filter(function(e){return i._layerExistsInMap(e)})},O.prototype._layerExistsInMap=function(e){if(e.layer&&e.layer.serviceLayer&&e.layer.serviceLayer.id){var t=e.layer.serviceLayer.id;if(this.app.site.essentialsMap.getMap().getLayer(t))return!0}return!1},O.prototype.applyState=function(t){var r=this;return(!this._isRestoringStatePromise||this._isRestoringStatePromise&&this._isRestoringStatePromise.isFulfilled())&&(this._isRestoringStatePromise=Promise.resolve(null)),this._isRestoringStatePromise=this._isRestoringStatePromise.then(function(){return r.volatileQueries.clear()}).then(function(){var e=r.isFilterBuilder.get()?t.filters:t.queries;if(e&&e.length)return r._restoreQueryStates(e,t.serialVersion)}).then(function(e){return r._loadQueriesIntoModel(e)}).then(function(){return Promise.resolve()}).catch(function(e){return Promise.reject(e)}),this._isRestoringStatePromise},O.prototype._restoreQueryStates=function(e,r){var i=this;return Q.PromiseUtils.mapSkipRejected(e,function(e){var t=new c.Query(i.app,i.libraryId,{layer:null,layerIsTable:!1,logicalOperator:o.Conjunctions.and});return t.setErrorHandler(i,i.isFilterBuilder.get(),v.handleQueryErrors),t.applyState(e,r).timeout(1e3)},{concurrency:1/0},!0)},O.prototype._loadQueriesIntoModel=function(t){var r=this;return Q.PromiseUtils.mapSkipRejected(t,function(e){return 0<t.length&&e===t[0]&&e&&e.layerId?(r.selectedLayerUniqueId.set(e.layerId.get()),r.infoText.set(r.getResource("language-querybuilder-find-in-layer").format(e.layer.get().displayName)),r.applyDisplayedQueryState(e.exportState())):r.volatileQueries.addQuery(e)},{concurrency:1/0},!0)},O.prototype.applyDisplayedQueryState=function(r,e){var i=this;(!this._isRestoringQueryStatePromise||this._isRestoringQueryStatePromise&&this._isRestoringQueryStatePromise.isFulfilled())&&(this._isRestoringQueryStatePromise=Promise.resolve(null));var t=new c.Query(this.app,this.libraryId,{layer:null,layerIsTable:!1,logicalOperator:null});return this._isRestoringQueryStatePromise=this._isRestoringQueryStatePromise.then(function(){return i.attachQuery(t)}).then(function(){return i.displayedQuery.get().applyState(r,e)}).then(function(e){if(i.disabled.set(!1),i.nestingLevelTooDeep.set(!1),0<i.displayedQuery.get().children.length())for(var t=0;t<i.displayedQuery.get().children.length();t++)0<i.displayedQuery.get().children.getAt(t).children.length()&&(i.disabled.set(!0),i.nestingLevelTooDeep.set(!0));return i._updateSpatialFilterOption(r.selectedSpatialFilter),i.displayedQuery.get().isModified.set(!1),i.layerIdChanged(),e}),this._isRestoringQueryStatePromise},O.prototype._checkUseableLayers=function(){for(var e=0;e<this._allLayers.getLength();e++){var t=this._allLayers.getAt(e);if(this.isFilterBuilder.get()){if(t&&t.gcxLayer&&0<t.gcxLayer.fields.length&&null!=t.gcxLayer.mapService&&null!==t.gcxLayer.mapService.serviceLayer){if(this._isValidFilterLayer(t.gcxLayer.mapService))continue}else if(t&&t.queryable&&t.serviceLayerInfo&&t.serviceLayerInfo.serviceLayer&&this._isValidFilterLayer(t.serviceLayerInfo))continue}else if(!(S.getProp(t,["gcxLayer","mapService"])instanceof _.StreamLayerService))continue;this._allLayers.removeAt(e),e--}var r=0===this._allLayers.getLength(),i=0===this._allTables.getLength();this.areQueryableLayers.set(!r),this.areQueryableTables.set(!i&&this.isQueryBuilder.get());var a=this.isFilterBuilder.get()&&r||this.isQueryBuilder.get()&&r&&i;this.noAvailableLayers.set(a)},O.prototype._isValidFilterLayer=function(e){if(e.serviceLayer instanceof esri.layers.StreamLayer)return!0;if(e.serviceLayer instanceof esri.layers.FeatureLayer&&e.serviceLayer.url)return!0;if(e.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer){var t=e.serviceLayer;if(null===t.capabilities||-1!==t.capabilities.indexOf("Query"))return!0}return!1},O.prototype._handleNewServiceLayers=function(e){for(var t=this,r=0;r<e.length;r++){var i=e[r];this._removeSub(i.serviceLayer.id);var a=dojo.connect(i.serviceLayer,"setLayerDefinitions",function(e){t._layerDefinitionsSet.call(t,this,e)});a&&(t._subTokenDictionary[i.serviceLayer.id]=a)}},O.prototype._removeSub=function(e){if(this._subTokenDictionary.hasOwnProperty(e)){var t=this._subTokenDictionary[e];t&&t.remove(),delete this._subTokenDictionary[e]}},O.prototype._layerDefinitionsSet=function(e,t){for(var r=0;r<t.length;++r){var i=t[r];this.displayedQuery.get().layer.get()&&this.displayedQuery.get().layer.get().serviceLayerInfo.serviceLayer===e&&this.displayedQuery.get().layerId.get()===i+""&&this.displayedQuery.get().buildWhereClause()!==t[i]&&(this.filterAlreadyApplied.set(!0),this.disabled.set(!0))}},O.prototype.markupLayerChanged=function(e){for(var t=this,r=0;r<this._graphicsLayerSubscriptions.length;r++)this._graphicsLayerSubscriptions[r].remove();e&&(this._graphicsLayerSubscriptions.push(e.on("graphic-add",function(){t.refreshSpatialFilterOptions()})),this._graphicsLayerSubscriptions.push(e.on("graphic-remove",function(){t.refreshSpatialFilterOptions()})))},O.prototype.layerIdChanged=function(){var r=this;return null===this.selectedLayerUniqueId.get()||void 0===this.selectedLayerUniqueId.get()?Promise.resolve():this.displayedQuery.get().layerId.get()&&this.selectedLayerUniqueId.get()===this.displayedQuery.get().layerId.get()?Promise.resolve():this.app.project.isLoading&&this._isRestoringStatePromise.isFulfilled()?Promise.resolve():this._isRestoringStatePromise&&!this._isRestoringStatePromise.isFulfilled()?Promise.resolve():(this._isUpdatingLayerId||(this._isUpdatingLayerId=Promise.resolve()),this.app.command("ScreenReaderNarrate").execute(this.app.getResource(this.libraryId,"language-querybuilder-WCAG-data-source-changed")),this._isUpdatingLayerId=this._isUpdatingLayerId.then(function(){return r._saveCurrentQuery()}).then(function(){r.disabled.set(!1);var e=r._findLayerOrTable(r.selectedLayerUniqueId.get());if(r.infoText.set(""),r.selectedSpatialFilter.set(b.SpatialFilterOptions.None),r.displayedQuery.get().refreshId(),e)return r.displayedQuery.get().layer.set(e),r._loadLayerQuery(e)}).then(function(){return r.queryExists(r.displayedQuery.get().id.get())}).then(function(e){r.displayedQueryIsSaved.set(e),r.displayedQuery.get().isModified.set(!1),r.infoText.set(r.getResource("language-querybuilder-find-in-layer").format(r.displayedQuery.get().layer.get().displayName)),r.checkForExistingFilter()}).catch(function(e){var t=e;t.handled||((t=t||new Error).message+="\nPoint of Failure: Could not change LayerId",v.handleQueryErrors.call(r,r.isFilterBuilder.get(),t)),r._isUpdatingLayerId=Promise.resolve()}),this._isUpdatingLayerId)},O.prototype.checkForExistingFilter=function(){this.isFilterBuilder.get()&&this.displayedQuery.get()&&this.displayedQuery.get().layer.get()&&this.displayedQuery.get().layer.get().getDefinitionExpression()&&(this._isEquivalentExpression(this._getCompleteWhereClause(this.displayedQuery.get().layer.get(),this.displayedQuery.get().buildWhereClause()),this.displayedQuery.get().layer.get().getDefinitionExpression())||(this.defaultLayerFilters[this.displayedQuery.get().layer.get().uniqueId]=this.displayedQuery.get().layer.get().getDefinitionExpression()))},O.prototype._saveCurrentQuery=function(){var t=this;return this._isSavingVolatileQuery||(this._isSavingVolatileQuery=Promise.resolve()),this._isSavingVolatileQuery=this._isSavingVolatileQuery.then(function(){return!t.displayedQuery.get().layer.get()||t._isRestoringStatePromise&&!t._isRestoringStatePromise.isFulfilled()?void 0:t.volatileQueries.removeQueriesByLayer(t.displayedQuery.get().layer.get()).then(function(){return t.displayedQuery.get().getNewInstance()}).then(function(e){return t.volatileQueries.addQuery(e)})}).catch(function(e){t.app.trace.error("Error in saving volatile query state"),t.app.trace.error(e)}),this._isSavingVolatileQuery},O.prototype._loadLayerQuery=function(t){var r=this,e=this.volatileQueries.getQueriesByLayer(t);return 0<e.length?(1!==e.length&&this.app.trace.warning("Multiple queries are saved for the layer with name "+t.displayName+". Loading the first..."),this.applyDisplayedQueryState(e[0].exportState()).then(function(e){return r.volatileQueries.removeQueriesByLayer(t)}).catch(function(e){return r.buildBlankQuery(t)})):this.buildBlankQuery(t)},O.prototype._findLayerOrTable=function(e){this.selectedLayerIsTable.set(!1);for(var t=0;t<this.layers.length();t++)if(this.layers.getAt(t).uniqueId===e)return this.layers.getAt(t);if(-1!==this._getTableIndex(e)){var r=this._getTableIndex(e);return this.displayedQuery.get().layerIsTable.set(!0),this.selectedLayerIsTable.set(!0),this.tables.getAt(r)}},O.prototype._isEquivalentExpression=function(e,t){return!((e&&"1 = 1"!==e||t&&"1 = 1"!==t)&&e!==t)},O.prototype._getTableIndex=function(e){for(var t=0;t<this.tables.length();t++)if(this.tables.getAt(t).uniqueId===e)return t;return-1},O.prototype.layerAdded=function(e){if(!(e&&e.layer instanceof esri.layers.GraphicsLayer)||e.layer instanceof esri.layers.FeatureLayer){var t=null,r=[];this.app.isArcGisWebApp||(this._appInfo=d.AppInfo.fromGeocortexApp(this.app),(t=this._appInfo.mapInfo.findMapServiceById(e.layer.id))&&(r=t.layers.filter(function(e){return!(!e.gcxLayer||!e.gcxLayer.queryable)}))),t||(r=(t=h.ServiceLayerInfo.fromEsriLayer(e.layer)).layers),0<r.length&&(r=y.ArrayUtils.sortBy(r,function(e){return e.displayName}));for(var i=this._allLayers.length()-1,a=r.length-1;0<=i&&0<=a;)this._allLayers.getAt(i).displayName<=r[a].displayName?(this._allLayers.insertItem(i+1,r[a]),a--):i--;for(;0<=a;)this._allLayers.insertItem(0,r[a]),a--;this._handleNewServiceLayers([t]),this._checkUseableLayers(),this.layers.refresh(),this.selectedLayerUniqueId.set(this.layers.length()?this.layers.getAt(0).uniqueId:null),this.selectedLayerUniqueId.pulse()}},O.prototype.layerRemoved=function(t){var r=this;this._allLayers.removeWhere(function(e){return e.serviceLayerInfo.serviceLayer===t.layer}),this._removeSub(t.layer.id),this.displayedQuery.get().layer.get()&&this.displayedQuery.get().layer.get().serviceLayerInfo&&this.displayedQuery.get().layer.get().serviceLayerInfo&&this.displayedQuery.get().layer.get().serviceLayerInfo&&t.layer&&this.displayedQuery.get().layer.get().serviceLayerInfo.serviceLayer===t.layer&&(0<this.layers.length()?this.buildBlankQuery(this.layers.getAt(0)):0<this.tables.length()?this.buildBlankQuery(this.tables.getAt(0)):this.buildBlankQuery(null)),this.displayedQuery.get().layer.get()&&this.infoText.set(this.getResource("language-querybuilder-find-in-layer").format(this.displayedQuery.get().layer.get().displayName)),new Promise(function(e,t){return r.app.command(r.isFilterBuilder.get()?"_getAllSavedFilters":"_getAllSavedQueries").execute(e)}).then(function(e){return Q.PromiseUtils.mapSkipRejected(e,function(e){e.layer.get().serviceLayerInfo.serviceLayer===t.layer&&r.app.command(r.isFilterBuilder.get()?"RemoveSavedFilter":"RemoveSavedQuery").execute(e,{removeLayerFlag:!0})})}),this._checkUseableLayers()},O.prototype.addQueryClause=function(e){var t=new n.QueryClause(this.app,this.libraryId,e);return e.addQueryClauses([t])},O.prototype.removeQueryClause=function(e){e.parentQuery.removeQueryClause(e),e.selectedField&&e.selectedField.isTypeField&&(e.parentQuery.updateCodedDomainValues(),e.parentQuery.pulseCodedDomainValues())},O.prototype.clearAllQueries=function(){var e=this;return this.volatileQueries.clear(),this.disabled.set(!1),this.nestingLevelTooDeep.set(!1),this.displayedQuery.get().refreshId(),this.buildBlankQuery(this.displayedQuery.get().layer.get()).then(function(){return e.layerIdChanged()}).then(function(){e.displayedQueryIsSaved.set(!1),e.displayedQuery.get().isModified.set(!1),e.app.command(e.isFilterBuilder.get()?"RemoveFilterStatus":"RemoveQueryStatus").execute()})},O.prototype.buildBlankQuery=function(t){var r=this,e=this.defaultLogicalOperator.get()||null,i=new c.Query(this.app,this.libraryId,{layer:t,layerIsTable:!1,logicalOperator:e});return this.attachQuery(i),this.displayedQuery.get().refreshFields().then(function(){if(t){var e=new n.QueryClause(r.app,r.libraryId,r.displayedQuery.get());r.displayedQuery.get().addQueryClauses([e])}}).then(function(){return r.displayedQuery.get()})},O.prototype.buildSpatiallyFilteredWhereClause=function(e,t){var s=this,n=new dojo.Deferred,r=new esri.tasks.Query,o=e.buildWhereClause(),l=e.layer.get(),i=l.gcxLayer?l.gcxLayer:l.serviceLayerInfo.serviceLayer,a=g.getQueryTask(i);return r.geometry=t,r.where=o,a.executeForIds(r).then(function(e){e=e||[];for(var t=null,r=0;r<l.fields.length;r++){var i=l.fields[r];if("esriFieldTypeOID"===i.type){t=i.name;break}}if(null!==t){var a=void 0;a=0!==e.length?"{0} IN ({1})".format(t,e.toString()):"1 = 0",n.resolve(a)}else s.app.trace.error("Could not find objectId property on currently displayed layer "+l.name+" to filter results with. Results not filtered"),n.resolve(o)},function(e){s.app.trace.error("an error occured while executing a query on "+l.name+". The query clause used was "+o,e),n.resolve(o)}),n},O.prototype.getGeometryFilter=function(d){var p=this;return this.extentChangeHandle&&this.extentChangeHandle.remove(),d=parseInt(d.toString(),10),this._updateSpatialFilterOption(d),this.displayedQuery.get().isModified.set(!1),new Promise(function(t,e){if(d===b.SpatialFilterOptions.None)p._currentSpatialFilter.set(null),t(p._currentSpatialFilter);else if(d===b.SpatialFilterOptions.CurrentExtent)p.extentChangeHandle=p._appInfo.map.on("extent-change",function(e){p._currentSpatialFilter.set(p._appInfo.map.extent)}),p._currentSpatialFilter.set(p._appInfo.map.extent),t(p._currentSpatialFilter);else if(d===b.SpatialFilterOptions.Drawings){var r=new Array;if(p.isAwab.get())for(var i=0;i<p._appInfo.mapInfo.getGraphicsLayers().length;i++){var a=p._appInfo.mapInfo.getGraphicsLayers()[i];-1<a.id.indexOf("graphicsLayer")&&r.push(a)}else r.push(p._appInfo.mapInfo.markupLayer.get());var s=[];for(i=0;i<r.length;i++)for(var n=r[i],o=0;o<n.graphics.length;o++){var l=n.graphics[o];if("polygon"===l.geometry.type)s.push(l.geometry);else if("extent"===l.geometry.type){var u=m.extentToPolygon(l.geometry);s.push(u)}}0===s.length?(p._currentSpatialFilter.set(null),t(p._currentSpatialFilter)):p._appInfo.getGeometryService().union(s).then(function(e){p._currentSpatialFilter.set(e),t(p._currentSpatialFilter)},function(e){p._currentSpatialFilter.set(null),t(p._currentSpatialFilter)})}else p.app.trace.warning("Selected spatial Filter not recognized"),p._currentSpatialFilter.set(null),t(p._currentSpatialFilter)})},O.prototype.refreshQueryGeometry=function(t){return void 0===t&&(t=this.displayedQuery.get()),t?this.getGeometryFilter(t.selectedSpatialFilter.get()).then(function(e){return t.geometry=e,t.isModified.set(!0),e}):Promise.resolve(null)},O.prototype.getViewerApp=function(){return this.app},O.prototype.onDestroy=function(){C.prototype.onDestroy.call(this),this._gcxTokenDictionary.LayerThemeChangedEvent&&this.app.event("LayerThemeChangedEvent").unsubscribe(this._gcxTokenDictionary.LayerThemeChangedEvent)},O);function O(e,t){var r=C.call(this,e,t)||this;return r.layers=new a.FilterableCollection,r.tables=new a.FilterableCollection,r.selectedLayerUniqueId=new s.Observable,r.infoText=new s.Observable,r.spatialFilters=new s.ObservableCollection,r.selectedSpatialFilter=new s.Observable(b.SpatialFilterOptions.None),r.selectedSpatialFilterName=new s.Observable,r.defaultLogicalOperator=new s.Observable(o.Conjunctions.and),r.displayedQuery=new s.Observable,r.defaultLayerFilters={},r.isAwab=new s.Observable(!1),r.isGvh=new s.Observable(!1),r.isQueryAndAwab=new s.Observable(!1),r.isDebug=new s.Observable(!1),r.isQueryBuilder=new s.Observable(!0),r.isFilterBuilder=new s.Observable(!1),r.areQueryableTables=new s.Observable(!1),r.areQueryableLayers=new s.Observable(!1),r.showLayerError=new s.Observable(!1),r.disabled=new s.Observable(!1),r.nestingLevelTooDeep=new s.Observable(!1),r.selectedLayerIsTable=new s.Observable(!1),r.filterAlreadyApplied=new s.Observable(!1),r.notDisabled=new s.Observable(!0),r.noAvailableLayers=new s.Observable(!1),r.noAvailableLayersText=new s.Observable(""),r.displayedQueryIsSaved=new s.Observable(!1),r.config={},r._allLayers=new s.ObservableCollection,r._allTables=new s.ObservableCollection,r._isRestoringQueryStatePromise=Promise.resolve(null),r._isRestoringStatePromise=Promise.resolve(null),r._initializingPromise=null,r._subTokenDictionary={},r._gcxTokenDictionary={},r._mapTokenDictionary={},r._observableTokenDictionary={},r._currentSpatialFilter=new s.Observable(null),r._graphicsLayerSubscriptions=new Array,r.isGvh.syncTransform(r.isAwab,function(e){return!e}),r.notDisabled.syncTransform(r.disabled,function(e){return!e}),r.volatileQueries=new f.QueryCollection(e,t,{persistent:!1}),r.volatileQueries.isFilterCollection=r.isFilterBuilder.get(),r}t.SimpleQueryBuilderViewModel=F})},"Mapping/modules/QueryBuilder/SavedQueries/ListQueriesView":function(){var i,o=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});define(["require","exports","geocortex/framework/ui/ViewBase","geocortex/infrastructure/ui/components/PagingControls/PagingControlsViewModel"],function(e,t,r,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n,i=(n=r.ViewBase,o(a,n),a.prototype.attach=function(e){n.prototype.attach.call(this,e),this._registerCommands()},a.prototype.deactivated=function(){this.viewModel.isFilterBuilder.get()?this.app.command("RemoveFilterStatus").execute():this.app.command("RemoveQueryStatus").execute(),this.viewModel.presentableResults.currPageNumber.set(1)},a.prototype.resolveWidget=function(e,t,r){if("PagingControlsWidget"!==e)return n.prototype.resolveWidget.call(this,e,t,r);var i=this.app.viewManager.createView({typeName:"geocortex.essentialsHtmlViewer.mapping.infrastructure.ui.components.PagingControls.PagingControlsView",markupResource:"Mapping/infrastructure/ui/components/PagingControls/PagingControlsView.html",libraryId:"Mapping.Infrastructure",isVisible:!0});if(i){var a=new s.PagingControlsViewModel(this.app,t);i.attach(a)}return i},a.prototype._registerCommands=function(){this.app.command(this.viewModel.isFilterBuilder.get()?"ListFilters":"ListQueries").register(this,this.show)},a.prototype.show=function(e){var t=this;this.viewModel&&this.viewModel.refreshData().then(function(){t.app.viewManager.activateView(t)},function(e){t.app.command(t.viewModel.isFilterBuilder.get()?"AddFilterStatus":"AddQueryStatus").execute(t.app.getResource(t.libraryId,"language-querybuilder-error-retrieve-queries").format(t.viewModel.isFilterBuilder.get()?"filter":"query"),{error:!0})})},a.prototype.handleQueryActions=function(e,t,r){this.app.command(this.viewModel.isFilterBuilder.get()?"ShowFilterActions":"ShowQueryActions").execute(r)},a.prototype.handleQueryClick=function(e,t,r){this.app.command(this.viewModel.isFilterBuilder.get()?"RunFilter":"RunQuery").execute(r)},a);function a(){return null!==n&&n.apply(this,arguments)||this}t.ListQueriesView=i})},"Mapping/modules/QueryBuilder/SavedQueries/ListQueriesViewModel":function(){var i,l=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});define(["require","exports","geocortex/framework/ui/ViewModelBase","geocortex/framework/observables","geocortex/framework-ui/PresentableCollection"],function(e,t,r,i,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s,n=(s=r.ViewModelBase,l(o,s),o.prototype.initialize=function(e){s.prototype.initialize.call(this,e),(e=e||{}).hasOwnProperty("isPaged")&&(this.isPaged=e.isPaged),e.hasOwnProperty("pageSize")&&(this.pageSize=e.pageSize),e.hasOwnProperty("mode")&&("filter"===e.mode?this.isFilterBuilder.set(!0):"query"===e.mode?this.isFilterBuilder.set(!1):this.app.trace.warning('Invalid configuration option for ListQueriesView "mode": '+e.mode+" given.")),this.presentableResults.isPaginated.set(this.isPaged),this.presentableResults.pageSize.set(this.pageSize),this.refreshData(),this._registerListeners()},o.prototype._registerListeners=function(){var e=this;this.app.event(this.isFilterBuilder.get()?"SavedFiltersChangedEvent":"SavedQueriesChangedEvent").subscribe(this,function(){e.refreshData()}),this.app.event("LayerThemeChangedEvent").subscribe(this,function(){e.refreshData()})},o.prototype.refreshData=function(){var i=this;return this._retrieveData().then(function(e){i.queries.clear();var t=e.filter(function(e){return!e.layer.get()||e.layer.get().gcxLayer.inActiveTheme});if(i.isFilterBuilder.get()){var r=t.filter(function(e){return e.layer.get()&&e.layer.get().gcxLayer?i._isValidFilterLayer(e.layer.get().gcxLayer.mapService):!!e.layer.get()&&i._isValidFilterLayer(e.layer.get().serviceLayerInfo)});i.queries.addItems(r)}else i.queries.addItems(t)})},o.prototype._retrieveData=function(){var r=this;return new Promise(function(e,t){return r.app.command(r.isFilterBuilder.get()?"_getAllSavedFilters":"_getAllSavedQueries").execute(e)})},o.prototype._isValidFilterLayer=function(e){if(e.serviceLayer instanceof esri.layers.FeatureLayer&&e.serviceLayer.url)return!0;if(e.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer){var t=e.serviceLayer;if(null===t.capabilities||-1!==t.capabilities.indexOf("Query"))return!0}return!1},o);function o(e,t){var r=s.call(this,e,t)||this;return r.isFilterBuilder=new i.Observable(!1),r.isPaged=!0,r.pageSize=10,r.queries=new i.ObservableCollection,r.presentableResults=new a.PresentableCollection(r.queries),r.resultsPage=r.presentableResults.items,r}t.ListQueriesViewModel=n})},"Mapping/modules/QueryBuilder/SavedQueries/QueryActionsView":function(){var i,l=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});define(["require","exports","geocortex/infrastructure/menus/MenuView"],function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i,a="RENAMEQUERY",s="RENAMEFILTER",n=(i=r.MenuView,l(o,i),o.prototype.attach=function(e){i.prototype.attach.call(this,e),this.viewModel=e,this._registerCommandsAndEvents()},o.prototype.handleMenuItemClick=function(e,t,r){r.menuItem.id!==a&&r.menuItem.id!==s&&this.app.command("DeactivateView").execute(this.id),i.prototype.handleMenuItemClick.call(this,e,t,r)},o.prototype._registerCommandsAndEvents=function(){this.app.command(this.viewModel.isFilterBuilder.get()?"ShowFilterActions":"ShowQueryActions").register(this,this._executeShowQueryActions)},o.prototype._executeShowQueryActions=function(e){e&&(this.title.sync(e.displayName),this.viewModel.menuContext.set(e),this.app.command(this.viewModel.isFilterBuilder.get()?"RenameSavedFilter":"RenameSavedQuery").canExecute=function(){return!e.adminDefined},this.app.command(this.viewModel.isFilterBuilder.get()?"RenameSavedFilter":"RenameSavedQuery").raiseCanExecuteChanged(),this.app.command(this.viewModel.isFilterBuilder.get()?"RemoveSavedFilter":"RemoveSavedQuery").canExecute=function(){return!e.adminDefined},this.app.command(this.viewModel.isFilterBuilder.get()?"RemoveSavedFilter":"RemoveSavedQuery").raiseCanExecuteChanged(),this.app.command("ActivateView").execute(this.id))},o);function o(e,t){return i.call(this,e,t)||this}t.QueryActionsView=n})},"Mapping/modules/QueryBuilder/SavedQueries/QueryActionsViewModel":function(){var i,o=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});define(["require","exports","geocortex/infrastructure/menus/MenuViewModel","geocortex/framework/observables"],function(e,t,r,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a,s=(a=r.MenuViewModel,o(n,a),n.prototype.initialize=function(e){a.prototype.initialize.call(this,e),e.hasOwnProperty("mode")&&("filter"===e.mode?this.isFilterBuilder.set(!0):"query"===e.mode?this.isFilterBuilder.set(!1):this.app.trace.warning('Invalid configuration option for QueryActionsView "mode": '+e.mode+" given."))},n);function n(e,t){var r=a.call(this,e,t)||this;return r.isFilterBuilder=new i.Observable(!1),r.app=e,r.libraryId=t,r}t.QueryActionsViewModel=s})},"Mapping/modules/QueryBuilder/SavedQueries/SaveQueryView":function(){var i,o=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});define(["require","exports","geocortex/framework/ui/ViewBase","geocortex/framework/utils/TimeDelayedOperation"],function(e,t,r,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a,s=(a=r.ViewBase,o(n,a),n.prototype.attach=function(e){var t=this;a.prototype.attach.call(this,e),this.title.set(this.app.getResource(this.libraryId,this.viewModel.isFilterBuilder.get()?"language-querybuilder-save-filter-dialog-title":"language-querybuilder-save-query-dialog-title")),this._keyDownTimer=new i.TimeDelayedAction(this._validationDelayMS,function(){return t.viewModel.validateInput()},this),this._registerCommands()},n.prototype.activated=function(){a.prototype.activated.call(this)},n.prototype.deactivated=function(){a.prototype.deactivated.call(this),this.viewModel.reset()},n.prototype._registerCommands=function(){this.app.command(this.viewModel.isFilterBuilder.get()?"ShowSaveAsFilterDialog":"ShowSaveAsQueryDialog").register(this,this.show),this.app.command(this.viewModel.isFilterBuilder.get()?"ShowSaveFilterDialog":"ShowSaveQueryDialog").register(this,this.save)},n.prototype.handleKeyDown=function(e,t,r){return(e.which?e.which:e.keyCode)===dojo.keys.ENTER&&(this.saveAs(),e.preventDefault()),!0},n.prototype.handleInputChanged=function(e,t,r){this.viewModel.handleInputChanged(),this._keyDownTimer.reset()},n.prototype.handleCancelClick=function(e,t,r){this.app.viewManager.deactivateView(this)},n.prototype.handleSaveClick=function(e,t,r){this.saveAs()},n.prototype.saveAs=function(){var t=this,r=this.viewModel.name.get();this.viewModel.validateInput()&&this.viewModel.saveQuery(r,!0).then(function(e){e&&(t.viewModel.showConfirmationMessage(r),t.app.viewManager.deactivateView(t),t.app.command(t.viewModel.isFilterBuilder.get()?"DisplayFilter":"DisplayQuery").execute(t.viewModel.query))})},n.prototype.save=function(t){var r=this;this.viewModel.query=t,this.viewModel.saveQuery(t.displayName.get(),!1).then(function(e){e&&r.viewModel.showConfirmationMessage(t.displayName.get())})},n.prototype.show=function(e){this.viewModel.query=e,this.viewModel.name.set(e.displayName.get()||""),this.app.viewManager.activateView(this)},n);function n(e,t){var r=a.call(this,e,t)||this;return r._keyDownTimer=null,r._validationDelayMS=300,r}t.SaveQueryView=s})},"Mapping/modules/QueryBuilder/SavedQueries/SaveQueryViewModel":function(){var i,u=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});define(["require","exports","geocortex/framework/ui/ViewModelBase","geocortex/framework/observables","geocortex/framework/utils/utils","./../QueryErrorHandling"],function(e,t,r,i,n,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a,s=(a=r.ViewModelBase,u(l,a),l.prototype.initialize=function(e){a.prototype.initialize.call(this,e),e.hasOwnProperty("mode")&&("filter"===e.mode?this.isFilterBuilder.set(!0):"query"===e.mode?this.isFilterBuilder.set(!1):this.app.trace.warning('Invalid configuration option for ListQueriesView "mode": '+e.mode+" given.")),this.app.command(this.isFilterBuilder.get()?"RenameSavedFilter":"RenameSavedQuery").register(this,this._executeRenameQuery)},l.prototype.saveQuery=function(t,e){var r=this;this._assertNameNotNull(t),t=t.trim();var i=this.queryExists(t);this._existingQuery=!!i;var a=Promise.resolve(!0);if(this._existingQuery){if(i.adminDefined){var s=new Error("Cannot overwrite administrator defined query");return s.adminDefined=!0,s.code=o.ERRCODES.UPDATEQUERYERROR,o.handleQueryErrors.call(this,this.isFilterBuilder.get(),s),Promise.resolve(!1)}e&&(a=this.confirmOverwrite(t))}return a.then(function(e){return r._existingQuery&&e?r.overwriteQuery(t):r._existingQuery?Promise.resolve(!1):r.createQuery(t)})},l.prototype.overwriteQuery=function(r){function s(e){var t=e;return t.adminDefined=!1,t.code=o.ERRCODES.UPDATEQUERYERROR,o.handleQueryErrors.call(n,n.isFilterBuilder.get(),t),!1}var n=this;return r!==this.query.displayName.get()?Promise.all([this.query.getNewInstance(!0),new Promise(function(e,t){return n.app.command(n.isFilterBuilder.get()?"_getSavedFilterByName":"_getSavedQueryByName").execute(r,e,t)})]).then(function(e){var i=e[0],a=e[1];return i.displayName.set(r),i.adminDefined=!1,new Promise(function(t,r){n.app.command(n.isFilterBuilder.get()?"_updateSavedFilterById":"_updateSavedQueryById").execute(a.id.get(),i,function(e){return n.query=e,t(!0)},function(e){return s(e),r(!1)})})}).catch(function(e){return o.handleQueryErrors.call(n,n.isFilterBuilder.get(),e),!1}):this.query.getNewInstance().then(function(e){return function(e){return new Promise(function(t,r){n.app.command(n.isFilterBuilder.get()?"_updateSavedFilterById":"_updateSavedQueryById").execute(e.id.get(),e,function(e){n.query=e,t(!0)},function(e){s(e),r(!1)})})}(e)},o.handleQueryErrors.bind(this))},l.prototype.queryExists=function(e){var t;return this.app.command(this.isFilterBuilder.get()?"_getSavedFilterByName":"_getSavedQueryByName").execute(e,function(e){t=e},function(){t=null}),t},l.prototype.createQuery=function(i){var a=this;return new Promise(function(t,r){a.query.getNewInstance(!0).then(function(e){e.displayName.set(i),e.adminDefined=!1,a.app.command(a.isFilterBuilder.get()?"_addSavedFilter":"_addSavedQuery").execute(e,function(e){a.query=e,t(!0)},function(e){o.handleQueryErrors.call(a,a.isFilterBuilder.get(),e),r(e)})})})},l.prototype.confirmOverwrite=function(e){var r,i,a=this;return i=this.isFilterBuilder.get()?(r=this.app.getResource(this.libraryId,"language-querybuilder-savedfilters-overwrite-prompt").format(e),this.app.getResource(this.libraryId,"language-querybuilder-savedfilters-overwrite-prompt-title").format(e)):(r=this.app.getResource(this.libraryId,"language-querybuilder-savedqueries-overwrite-prompt").format(e),this.app.getResource(this.libraryId,"language-querybuilder-savedqueries-overwrite-prompt-title").format(e)),new Promise(function(e,t){return a.app.command("Confirm").execute(r,i,e)})},l.prototype.showConfirmationMessage=function(e){var t;t=this.isFilterBuilder.get()?this._existingQuery?"language-querybuilder-savedfilters-update-confirmation":"language-querybuilder-savedfilters-create-confirmation":this._existingQuery?"language-querybuilder-savedqueries-update-confirmation":"language-querybuilder-savedqueries-create-confirmation";var r=this.getResource(t).format(e);this.app.command(this.isFilterBuilder.get()?"AddFilterStatus":"AddQueryStatus").execute(r)},l.prototype._executeRenameQuery=function(i){var a,s=this;this.promptForQueryName(i).then(function(e){if(!n.isNullOrUndefined(e)){if(0===e.length){var t=new Error;return t.code=o.ERRCODES.NONAMEGIVENERROR,void o.handleQueryErrors.call(s,s.isFilterBuilder.get(),t)}if(a=e,s.queryExists(e)){var r=new Error;return r.code=o.ERRCODES.DUPLICATE,r.queryName=a,void o.handleQueryErrors.call(s,s.isFilterBuilder.get(),r)}return i.displayName.set(a),void s.app.command(s.isFilterBuilder.get()?"_updateSavedFilterById":"_updateSavedQueryById").execute(i.id.get(),i)}}).catch(function(e){s.app.trace.error(e.message,e)})},l.prototype.promptForQueryName=function(e){var r=this,i=this.getResource("language-querybuilder-rename-prompt-title"),a=this.getResource(this.isFilterBuilder.get()?"language-querybuilder-rename-filter-prompt":"language-querybuilder-rename-query-prompt"),s=e.displayName.get();return new Promise(function(e,t){return r.app.command("Prompt").execute(i,a,s,e)})},l.prototype._assertNameNotNull=function(e){if(n.isNullOrUndefined(e))throw new Error("The query name must be set.")},l.prototype.validateInput=function(){var e=this.name.get()?this.name.get().trim():"";if(String.isNullOrEmpty(e))return this.app.trace.error(this.getResource(this.isFilterBuilder.get()?"language-querybuilder-filter-error-name-required":"language-querybuilder-query-error-name-required")),!1;var t=this.queryExists(e);if(this._existingQuery=!!t,this._existingQuery){if(t.adminDefined){var r="Cannot overwrite administrator defined query";return this.inputErrorMessage.set(r),this.app.trace.error(r),!1}return r=this.getResource(this.isFilterBuilder.get()?"language-querybuilder-filter-error-name-exists":"language-querybuilder-query-error-name-exists").format(e),this.inputErrorMessage.set(r),this.app.trace.error(r),!1}return!0},l.prototype.handleInputChanged=function(){this.inputErrorMessage.get()&&this.name.get()&&!String.isNullOrEmpty(this.name.get().trim())&&this.inputErrorMessage.set("")},l.prototype.reset=function(){this.name.set(""),this.inputErrorMessage.set("")},l);function l(){var e=null!==a&&a.apply(this,arguments)||this;return e.name=new i.Observable(""),e.inputErrorMessage=new i.Observable,e.query=null,e.isFilterBuilder=new i.Observable(!1),e._existingQuery=!1,e}t.SaveQueryViewModel=s})},"url:/Mapping/modules/QueryBuilder/AutoCompleteView.html":t,"url:/Mapping/modules/QueryBuilder/SavedQueries/ListQueriesView.html":r,"url:/Mapping/modules/QueryBuilder/SavedQueries/QueryActionsView.html":i,"url:/Mapping/modules/QueryBuilder/SavedQueries/SaveQueryView.html":a,"url:/Mapping/modules/QueryBuilder/SimpleQueryBuilderView.html":s,"url:/Mapping/modules/QueryBuilder/Templates/QueryBuilderItem.html":n,"url:/Mapping/modules/QueryBuilder/Templates/QueryBuilderItemGroup.html":o,"url:/Mapping/modules/QueryBuilder/Templates/QueryBuilderRoot.html":l}}),require(["geocortex/framework/resourceManager"],function(e){e.resourceManager.register("Mapping","inv","Mapping/modules/QueryBuilder/CSS/common.css","css","LnF1ZXJ5LWdyb3VwLA0KLnF1ZXJ5LWdyb3VwIGxpLA0KLmFkZC1idXR0b25zIHsNCiAgICBwYWRkaW5nOiAwOw0KICAgIG1hcmdpbjogMDsNCiAgICBsaXN0LXN0eWxlOiBub25lOw0KfQ0KDQouc2ltcGxlLXF1ZXJ5LWJ1aWxkZXIgaHIgew0KICAgIG1hcmdpbjogMWVtIDAgMC41ZW07DQp9DQoNCi5zaW1wbGUtcXVlcnktYnVpbGRlciBzZWxlY3QsDQouc2ltcGxlLXF1ZXJ5LWJ1aWxkZXIgaW5wdXQgew0KICAgIGhlaWdodDogMmVtOw0KICAgIG1pbi13aWR0aDogMDsNCiAgICBwYWRkaW5nOiAwOw0KICAgIGZvbnQtd2VpZ2h0OiBub3JtYWw7DQp9DQoNCiAgICAuc2ltcGxlLXF1ZXJ5LWJ1aWxkZXIgaW5wdXQgew0KICAgICAgICBwYWRkaW5nOiAwIDAuM2VtOw0KICAgIH0NCg0KLmxvZ2ljYWwtb3BlcmF0b3JzIHsNCiAgICBtYXJnaW4tYm90dG9tOiAxZW07DQp9DQoNCi5sb2dpY2FsLW9wZXJhdG9yLXRvZ2dsZSB7DQogICAgZGlzcGxheTogYmxvY2s7DQp9DQoNCi50b3VjaCAubG9naWNhbC1vcGVyYXRvci10b2dnbGUgew0KICAgIG1hcmdpbi1ib3R0b206IDAuNWVtOw0KfQ0KDQoubG9naWNhbC1vcGVyYXRvci10b2dnbGUgLmxhYmVsIHsNCiAgICBmb250LXN0eWxlOiBpdGFsaWM7DQogICAgZm9udC1zaXplOiAwLjllbTsNCiAgICBtYXJnaW4tbGVmdDogMC4yNWVtOw0KfQ0KDQoubG9naWNhbC1vcGVyYXRvcnMgaW5wdXQgew0KICAgIGhlaWdodDogaW5pdGlhbDsNCiAgICB2ZXJ0aWNhbC1hbGlnbjogbWlkZGxlOw0KfQ0KDQouc2ltcGxlLXF1ZXJ5LWJ1aWxkZXIgLmhpZGRlbi1sYWJlbCB7DQogICAgaGVpZ2h0OiAwOw0KICAgIGRpc3BsYXk6IGJsb2NrOw0KICAgIHRleHQtaW5kZW50OiAtOTk5OWVtOw0KfQ0KDQoucXVlcnktcm93LWlucHV0IHsNCiAgICBkaXNwbGF5OiBpbmxpbmUtYmxvY2s7DQogICAgdmVydGljYWwtYWxpZ246IG1pZGRsZTsNCiAgICBtaW4td2lkdGg6IDA7DQogICAgd2lkdGg6IGNhbGMoMzMuMzMlIC0gNHB4KTsgLyotNHB4IHRvIGFjY291bnQgZm9yIGlubGluZS1ibG9jayBzcGFjaW5nKi8NCn0NCg0KLnF1ZXJ5LXJvdy1pbnB1dCAuZGF0ZS1waWNrZXIgLmZvcm0tbGFiZWwgew0KICAgIHBhZGRpbmc6IDA7DQp9DQoNCi5xdWVyeS1yb3ctZGVsZXRlIHsNCiAgICBiYWNrZ3JvdW5kLWltYWdlOiB1cmwoIlJlc291cmNlcy9JbWFnZXMvSWNvbnMvZGVsZXRlLTE2LnBuZyIpOw0KICAgIGJhY2tncm91bmQtcmVwZWF0OiBuby1yZXBlYXQ7DQogICAgYmFja2dyb3VuZC1wb3NpdGlvbjogY2VudGVyIGNlbnRlcjsNCiAgICB3aWR0aDogMS44NzVlbTsNCiAgICBoZWlnaHQ6IDEuODc1ZW07DQogICAgdmVydGljYWwtYWxpZ246IG1pZGRsZTsNCiAgICBwb3NpdGlvbjogYWJzb2x1dGU7DQogICAgdG9wOiAwOw0KICAgIHJpZ2h0OiAwOw0KfQ0KDQouY29uanVuY3Rpb24gew0KICAgIGRpc3BsYXk6IGJsb2NrOw0KICAgIHBhZGRpbmc6IDAuNWVtOw0KICAgIHRleHQtYWxpZ246Y2VudGVyOw0KICAgIG1hcmdpbi1ib3R0b206IC0xZW07DQogICAgei1pbmRleDogMTsNCiAgICBwb3NpdGlvbjogcmVsYXRpdmU7DQp9DQoNCi5jb25qdW5jdGlvbi10ZXh0IHsNCiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOw0KICAgIGRpc3BsYXk6IGlubGluZS1ibG9jazsNCiAgICBwYWRkaW5nOiAwLjI1ZW0gMC43NWVtOw0KICAgIGZvbnQtc2l6ZTogMC44NWVtOw0KICAgIGJvcmRlcjogMXB4IHNvbGlkICNDQ0NDQ0M7DQogICAgYmFja2dyb3VuZDogI0RFRjJGRjsNCiAgICBjdXJzb3I6IGRlZmF1bHQ7DQogICAgdXNlci1zZWxlY3Q6IG5vbmU7DQogICAgdHJhbnNpdGlvbjogYm9yZGVyLXJhZGl1cyAwLjJzIGVhc2UtaW47DQp9DQoNCi5jb25qdW5jdGlvbi10ZXh0LmFuZCB7DQogICAgYm9yZGVyLXJhZGl1czogMC4xMjVyZW07DQp9DQoNCi5jb25qdW5jdGlvbi10ZXh0Lm9yIHsNCiAgICBib3JkZXItcmFkaXVzOiAycmVtOw0KfQ0KDQouc2ltcGxlLXF1ZXJ5LWJ1aWxkZXIgLnRleHQtYnV0dG9uIHsNCiAgICBjb2xvcjogIzFBNzJDNDsNCiAgICB0ZXh0LWRlY29yYXRpb246IHVuZGVybGluZTsNCn0NCg0KLnNpbXBsZS1xdWVyeS1idWlsZGVyIC5hZGQtYnV0dG9ucyB7DQogICAgbGlzdC1zdHlsZTogbm9uZTsNCiAgICBtYXJnaW4tdG9wOiAxZW07DQp9DQoNCi5zaW1wbGUtcXVlcnktYnVpbGRlciAuYWRkLWJ1dHRvbnMgbGkgew0KICAgIGRpc3BsYXk6IGlubGluZS1ibG9jazsNCiAgICB2ZXJ0aWNhbC1hbGlnbjogYm90dG9tOw0KICAgIG1hcmdpbi1yaWdodDogMC41ZW07DQp9DQoNCi5xdWVyeS1zdWJncm91cCB7DQogICAgYmFja2dyb3VuZDogI0VFRUVFRTsNCiAgICB3aWR0aDogY2FsYygxMDAlICsgMWVtKTsNCiAgICBwb3NpdGlvbjogcmVsYXRpdmU7DQogICAgcGFkZGluZzogMWVtIDAuNWVtOw0KICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7DQogICAgbGVmdDogLTAuNWVtOw0KICAgIGJveC1zaGFkb3c6IGluc2V0IDAuMTI1ZW0gMC4xMjVlbSAwLjVlbSAwICNDQ0NDQ0M7DQogICAgYm9yZGVyLXJhZGl1czogMC4xMjVyZW07DQogICAgYm9yZGVyOiAxcHggc29saWQgI0Q5RDlEOTsNCn0NCg0KLnF1ZXJ5LWJ1aWxkZXItZm9ybSB7DQogICAgcGFkZGluZzogMCAxZW0gMCAxZW07DQp9DQoNCi5xdWVyeS1pdGVtIHsNCiAgICBwb3NpdGlvbjogcmVsYXRpdmU7DQp9DQoNCi5xdWVyeS1pdGVtLWlucHV0cyB7DQogICAgZGlzcGxheTogYmxvY2s7DQogICAgcGFkZGluZy1yaWdodDogMi4xODhlbTsNCiAgICBtYXJnaW4tdG9wOiAxZW07DQp9DQoNCi5zaW1wbGUtcXVlcnktYnVpbGRlciAuZm9ybS1pdGVtIHsNCiAgICBtYXJnaW4tdG9wOiAwLjVlbTsNCiAgICBwYWRkaW5nOiAwOw0KfQ0KDQoubWFpbi1sZXZlbC1hZGQgew0KICAgIG1hcmdpbi10b3A6IDFlbTsNCn0NCg0KLnF1ZXJ5LXN1Ymdyb3VwICsgLmNvbmp1bmN0aW9uIHsNCiAgICBtYXJnaW4tdG9wOiAtMWVtOw0KfQ0KDQoucXVlcnktY29uZGl0aW9ucy1hcmVhIHsNCiAgICBtYXJnaW4tdG9wOiAwLjVlbTsNCn0NCg0KLmZpbmQtcmVzdWx0cyB7DQogICAgbWFyZ2luLWJvdHRvbTogMC41ZW07DQp9DQoNCi5saXN0LXF1ZXJpZXMtdmlldyAuZ2N4LWxpc3QtZGVzYyB7DQogICAgZm9udC1zdHlsZTogaXRhbGljOw0KICAgIGZvbnQtc2l6ZTogMC45ZW07DQp9DQoNCi5saXN0LXF1ZXJpZXMtdmlldyAucmVzdWx0cy1saXN0IHsNCiAgICBib3R0b206IDUuMjVlbTsNCn0NCg0KLmxpc3QtcXVlcmllcy12aWV3IC5oYXMtcGFnZXMgew0KICAgIGhlaWdodDogNS4yNWVtOw0KfQ0KDQouc2ltcGxlLXF1ZXJ5LWJ1aWxkZXIgLmluZm8tbWVzc2FnZSB7DQogICAgbWFyZ2luLXRvcDogMWVtOw0KfQ0KDQoubGlzdC1xdWVyaWVzLXZpZXcgLmdjeC1saXN0LWxhYmVsew0KICAgIHdoaXRlLXNwYWNlOiBub3JtYWw7DQp9DQoNCi5saXN0LXF1ZXJpZXMtdmlldyAuZ2N4LWxpc3QtZGVzYyB7DQogICAgd2hpdGUtc3BhY2U6IG5vcm1hbDsNCn0NCg0KLlF1ZXJ5QWN0aW9uc1ZpZXcgYnV0dG9uIGltZyB7DQogICAgbWFyZ2luOiAxZW07DQp9DQoNCi5xdWVyeS1pdGVtIC5kYXRlLXBpY2tlciAuZm9ybS1jb250cm9sIHsNCiAgICB3aWR0aDogMTAwJTsNCiAgICBtYXJnaW4tbGVmdDogMGVtOw0KfQ=="),e.resourceManager.register("Mapping","inv","Mapping/modules/QueryBuilder/CSS/small.css","css","LnNpbXBsZS1xdWVyeS1idWlsZGVyIC51aS1hdXRvY29tcGxldGUgew0KICAgIG1heC13aWR0aDogMjU1cHghaW1wb3J0YW50Ow0KfQ=="),e.resourceManager.register("Mapping","inv","Mapping/modules/QueryBuilder/AutoCompleteView.html","html",t),e.resourceManager.register("Mapping","inv","Mapping/modules/QueryBuilder/SavedQueries/ListQueriesView.html","html",r),e.resourceManager.register("Mapping","inv","Mapping/modules/QueryBuilder/SavedQueries/QueryActionsView.html","html",i),e.resourceManager.register("Mapping","inv","Mapping/modules/QueryBuilder/SavedQueries/SaveQueryView.html","html",a),e.resourceManager.register("Mapping","inv","Mapping/modules/QueryBuilder/SimpleQueryBuilderView.html","html",s),e.resourceManager.register("Mapping","inv","Mapping/modules/QueryBuilder/Templates/QueryBuilderItem.html","html",n),e.resourceManager.register("Mapping","inv","Mapping/modules/QueryBuilder/Templates/QueryBuilderItemGroup.html","html",o),e.resourceManager.register("Mapping","inv","Mapping/modules/QueryBuilder/Templates/QueryBuilderRoot.html","html",l)}),require({cache:{}}),define(["Mapping/modules/QueryBuilder/AutoCompleteView","Mapping/modules/QueryBuilder/AutoCompleteViewModel","Mapping/modules/QueryBuilder/Formatters","Mapping/modules/QueryBuilder/Query","Mapping/modules/QueryBuilder/QueryBuilderModule","Mapping/modules/QueryBuilder/QueryClause","Mapping/modules/QueryBuilder/QueryOperator","Mapping/modules/QueryBuilder/QueryOperatorDescription","Mapping/modules/QueryBuilder/SimpleQueryBuilderView","Mapping/modules/QueryBuilder/SimpleQueryBuilderViewModel"],function(e,t,r,i,a,s,n,o,l,u){d(e,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.AutoCompleteView",e.AutoCompleteView),d(t,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.AutoCompleteViewModel",t.AutoCompleteViewModel),d(r,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.QueryFormatterFactory",r.QueryFormatterFactory),d(r,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.QueryFormatter",r.QueryFormatter),d(r,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.Db2QueryFormatter",r.Db2QueryFormatter),d(r,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.FileGdbQueryFormatter",r.FileGdbQueryFormatter),d(r,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.InformixQueryFormatter",r.InformixQueryFormatter),d(r,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.MsAccessQueryFormatter",r.MsAccessQueryFormatter),d(r,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.OracleQueryFormatter",r.OracleQueryFormatter),d(r,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.PostgreSqlQueryFormatter",r.PostgreSqlQueryFormatter),d(r,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.ShapefileQueryFormatter",r.ShapefileQueryFormatter),d(r,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.SqlServerQueryFormatter",r.SqlServerQueryFormatter),d(r,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.GeocortexOwsQueryFormatter",r.GeocortexOwsQueryFormatter),d(i,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.Query",i.Query),d(a,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.QueryBuilderModule",a.QueryBuilderModule),d(s,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.QueryClause",s.QueryClause),d(n,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.QueryOperator",n.QueryOperator),d(o,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.QueryOperatorDescription",o.QueryOperatorDescription),d(l,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.SimpleQueryBuilderView",l.SimpleQueryBuilderView),d(u,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.SimpleQueryBuilderViewModel",u.SimpleQueryBuilderViewModel)})}();