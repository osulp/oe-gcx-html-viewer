function shim(e,t,r){if("string"==typeof e&&(r=t,t=e),"undefined"==typeof r)return void console.warn("Undefined shim for: "+t);for(var i=t.split("."),a=null,n=window,s=0,o=i.length;s<o;s++)a=i[s],s==o-1?n[a]=r:n[a]||(n[a]={}),n=n[a]}require({cache:{"Mapping/modules/QueryBuilder/AutoCompleteView":function(){define(["require","exports","geocortex/framework/ui/ViewBase"],function(e,t,r){"use strict";var i=function(e){function t(t,r){return e.call(this,t,r)||this}return __extends(t,e),t.prototype.activated=function(){e.prototype.activated.call(this)},t.prototype.attach=function(t){var r=this,i=this;e.prototype.attach.call(this,t),$(this.autoCompleteInput).autocomplete({minLength:0,source:function(e,t){r.getSuggestions(e,t)},appendTo:t.appendTo,position:{my:"right top",at:"right bottom",using:function(e){var t=$(this);t.css("top",e.top),t.css("right",t.offsetParent().innerWidth()-(e.left+t.outerWidth())),t.css("left","auto")}}}).on("autocompleteselect",function(e,t){return i.viewModel.value.set(t.item.value),!0}),$(this.autoCompleteInput).data("autocomplete")._resizeMenu=function(){var e=this.menu.element;this.options&&this.options.appendTo?(e.css("max-width",$(this.options.appendTo).width()),e.css("min-width",this.element.outerWidth()-6)):e.outerWidth(this.element.outerWidth())}},t.prototype.getSuggestions=function(e,t){var r=this.viewModel.queryClause.getSuggestions();r.then(t,function(e){t(e)})},t.prototype.dispose=function(){$(this.autoCompleteInput).remove()},t.prototype.autoComplete_focus=function(e,t,r){$(t).val()||$(t).autocomplete("search","")},t.prototype.autoComplete_blur=function(e,t,r){$(t).autocomplete("widget").hide()},t}(r.ViewBase);t.AutoCompleteView=i})},"Mapping/modules/QueryBuilder/AutoCompleteViewModel":function(){define(["require","exports","geocortex/framework/ui/ViewModelBase","geocortex/framework/observables"],function(e,t,r,i){"use strict";var a=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.value=new i.Observable,t}return __extends(t,e),t}(r.ViewModelBase);t.AutoCompleteViewModel=a})},"Mapping/modules/QueryBuilder/Formatters":function(){define(["require","exports","./QueryOperator","geocortex/infrastructure/FormatUtils","geocortex/infrastructure/NumberFormat"],function(e,t,r,i,a){"use strict";var n=function(){function e(t){e.settings=t}return e.getFormatter=function(e){return e.dataProvider.search(/^Db2$/i)>=0?new o(this.settings):e.dataProvider.search(/^FileGdb$/i)>=0?new l(this.settings):e.dataProvider.search(/^Informix$/i)>=0?new u(this.settings):e.dataProvider.search(/^MsAccess$/i)>=0?new d(this.settings):e.dataProvider.search(/^Oracle$/i)>=0?new p(this.settings):e.dataProvider.search(/^PostgreSql/i)>=0?new c(this.settings):e.dataProvider.search(/^Shapefile/i)>=0?new y(this.settings):e.dataProvider.search(/^SqlServer/i)>=0?new h(this.settings):"WMS"==e.serviceLayerInfo.serviceType||"WFS"==e.serviceLayerInfo.serviceType?new g(this.settings):new s(this.settings)},e}();n.settings={},t.QueryFormatterFactory=n;var s=function(){function e(e){this._settings=e||{}}return e.prototype.wildcard=function(){return this._settings.wildcard||"%"},e.prototype.dateQueryFormat=function(){return this._settings.dateQueryFormat||"DATE '{0:yyyy-MM-dd}'"},e.prototype.textComparisonQueryFormat=function(){return this._settings.textComparisonQueryFormat||"LOWER({0}) LIKE LOWER({1})"},e.prototype.numberToTextComparisonQueryFormat=function(){return this._settings.numberToTextComparisonQueryFormat||"CAST({0} AS VARCHAR(50)) LIKE '{1}'"},e.prototype.doesNotContainQueryFormat=function(){return this._settings.doesNotContainQueryFormat||"LOWER({0}) NOT LIKE LOWER({1})"},e.prototype.supportsTimeOfDay=function(){return void 0!=this._settings.queryProviderSupportsTimeOfDay&&this._settings.queryProviderSupportsTimeOfDay},e.prototype.format=function(e,t,i){var a=[r.QueryOperator.Equals,r.QueryOperator.NotEquals,r.QueryOperator.LessThan,r.QueryOperator.LessThanEquals,r.QueryOperator.GreaterThan,r.QueryOperator.GreaterThanEquals],n=[r.QueryOperator.Contains,r.QueryOperator.DoesNotContain,r.QueryOperator.StartsWith,r.QueryOperator.EndsWith],s=[r.QueryOperator.IsNull,r.QueryOperator.IsNotNull];return dojo.indexOf(a,t)>=0?this.formatComparison(e,t,i):dojo.indexOf(n,t)>=0?this.formatPatternMatch(e,t,i):dojo.indexOf(s,t)>=0?this.formatNull(e,t):void 0},e.prototype.formatComparison=function(e,t,r){var i=this.formatField(e),a=this.formatComparisonOperator(t),n=this.formatValue(e,r);return"{0} {1} {2}".format(i,a,n)},e.prototype.formatPatternMatch=function(e,t,i){return t==r.QueryOperator.DoesNotContain?this.doesNotContainQueryFormat().format(this.formatField(e),this.formatValue(e,this.formatPattern(t,i))):e.isNumeric()?this.numberToTextComparisonQueryFormat().format(this.formatField(e),this.formatPattern(t,this.formatValue(e,i))):this.textComparisonQueryFormat().format(this.formatField(e),this.formatValue(e,this.formatPattern(t,i)))},e.prototype.formatPattern=function(e,t){var i;switch(e){case r.QueryOperator.Contains:i="{0}{1}{0}";break;case r.QueryOperator.DoesNotContain:i="{0}{1}{0}";break;case r.QueryOperator.StartsWith:i="{1}{0}";break;case r.QueryOperator.EndsWith:i="{0}{1}";break;default:throw new Error("Invalid pattern matching operator.")}return i.format(this.wildcard(),t)},e.prototype.formatNull=function(e,t){if(t==r.QueryOperator.IsNull)return"{0} IS NULL".format(this.formatField(e));if(t==r.QueryOperator.IsNotNull)return"{0} IS NOT NULL".format(this.formatField(e));throw new Error("Invalid operator.")},e.prototype.formatField=function(e){return e.name},e.prototype.formatComparisonOperator=function(e){switch(e){case r.QueryOperator.Equals:return"=";case r.QueryOperator.NotEquals:return"<>";case r.QueryOperator.LessThan:return"<";case r.QueryOperator.LessThanEquals:return"<=";case r.QueryOperator.GreaterThan:return">";case r.QueryOperator.GreaterThanEquals:return">=";default:throw new Error("Invalid binary comparison operator.")}},e.prototype.formatValue=function(e,t){return e.isNumeric()?this.formatNumericValue(t):e.isDate()?this.formatDateValue(t):this.formatTextValue(t)},e.prototype.formatNumericValue=function(e){var t=e||"",r=i.parseNumber(e);return r&&(t=i.formatNumber(r,a.NumberFormat.ROUND_TRIP)),t},e.prototype.formatDateValue=function(e){var t=e||"",r=i.parseDate(t);return r&&(t=this.dateQueryFormat().replace(/\{0:([^}]+)\}/,function(e,t){return i.formatDate(r,t)})),t.trim()},e.prototype.formatTextValue=function(e){var t=e||"";return t=t.replace("'","''"),"'{0}'".format(t.trim())},e}();t.QueryFormatter=s;var o=function(e){function t(t){return e.call(this,t)||this}return __extends(t,e),t.prototype.supportsTimeOfDay=function(){return!0},t.prototype.dateQueryFormat=function(){return"TO_DATE('{0:yyyy-MM-dd HH:mm:ss}','YYYY-MM-DD HH24:MI:SS')"},t}(s);t.Db2QueryFormatter=o;var l=function(e){function t(t){return e.call(this,t)||this}return __extends(t,e),t.prototype.supportsTimeOfDay=function(){return!0},t.prototype.dateQueryFormat=function(){return"DATE '{0:yyyy-MM-dd HH:mm:ss}'"},t}(s);t.FileGdbQueryFormatter=l;var u=function(e){function t(t){return e.call(this,t)||this}return __extends(t,e),t.prototype.supportsTimeOfDay=function(){return!0},t.prototype.dateQueryFormat=function(){return"'{0:yyyy-MM-dd HH:mm:ss}'"},t}(s);t.InformixQueryFormatter=u;var d=function(e){function t(t){return e.call(this,t)||this}return __extends(t,e),t.prototype.supportsTimeOfDay=function(){return!0},t.prototype.dateQueryFormat=function(){return"#{0:MM-dd-yyyy HH:mm:ss}#"},t.prototype.wildcard=function(){return"*"},t}(s);t.MsAccessQueryFormatter=d;var p=function(e){function t(t){return e.call(this,t)||this}return __extends(t,e),t.prototype.supportsTimeOfDay=function(){return!0},t.prototype.dateQueryFormat=function(){return"TO_DATE('{0:yyyy-MM-dd HH:mm:ss}','YYYY-MM-DD HH24:MI:SS')"},t}(s);t.OracleQueryFormatter=p;var c=function(e){function t(t){return e.call(this,t)||this}return __extends(t,e),t.prototype.supportsTimeOfDay=function(){return!0},t.prototype.dateQueryFormat=function(){return"TIMESTAMP '{0:yyyy-MM-dd HH:mm:ss}'"},t}(s);t.PostgreSqlQueryFormatter=c;var y=function(e){function t(t){return e.call(this,t)||this}return __extends(t,e),t.prototype.supportsTimeOfDay=function(){return!1},t.prototype.dateQueryFormat=function(){return"DATE '{0:yyyy-MM-dd}'"},t}(s);t.ShapefileQueryFormatter=y;var h=function(e){function t(t){return e.call(this,t)||this}return __extends(t,e),t.prototype.supportsTimeOfDay=function(){return!0},t.prototype.dateQueryFormat=function(){return"'{0:yyyy-MM-dd HH:mm:ss}'"},t}(s);t.SqlServerQueryFormatter=h;var g=function(e){function t(t){return e.call(this,t)||this}return __extends(t,e),t.prototype.textComparisonQueryFormat=function(){return"{0} LIKE {1}"},t.prototype.doesNotContainQueryFormat=function(){return"{0} NOT LIKE {1}"},t}(s);t.GeocortexOwsQueryFormatter=g})},"Mapping/modules/QueryBuilder/NameValuePair":function(){define(["require","exports"],function(e,t){"use strict"})},"Mapping/modules/QueryBuilder/Query":function(){define(["require","exports","geocortex/framework/observables","./QueryBase","./QueryClause","geocortex/framework/utils/utils","geocortex/infrastructure/gis/AppInfo","geocortex/infrastructure/TaskUtils","geocortex/framework/utils/ArrayUtils","geocortex/essentials/Field","./QueryOperator","./QueryBuilderModule","./QueryErrorHandling","geocortex/infrastructure/PromiseUtils"],function(e,t,r,i,a,n,s,o,l,u,d,p,c,y){"use strict";t.idPrefix="qu_";var h=function(e){function i(t,i,a){var n=e.call(this,t,i)||this;return n.isModified=new r.Observable((!1)),n.displayName=new r.Observable(null),n.queryClauses=new r.ObservableCollection,n.layerIsTable=new r.Observable((!1)),n.layer=new r.Observable(null),n.layerId=new r.Observable(null),n.selectedLogicalOperator=new r.Observable(null),n.logicalOperators=new r.ObservableCollection,n._debugWhereClause=new r.Observable(null),n.radioButtons=null,n.radioButtonGroup=new r.Observable(null),n.queryItems=new r.ObservableCollection,n.children=new r.ObservableCollection,n.hasParent=new r.Observable((!1)),n.parentLogicalOperator=new r.Observable(null),n.defaultLogicalOperator=new r.Observable(d.Conjunctions.and),n.numSuggestions=10,n.geometry=null,n.selectedSpatialFilter=new r.Observable,n.selectedSpatialFilterName=new r.Observable,n.adminDefined=!1,n.counter=0,n._isRestoringStatePromise=null,n._fields=new Array,n.type="queryGroup",n.layerIsTable.set(a.layerIsTable),n.layer.set(a.hasOwnProperty("layer")?a.layer:null),n.layerId.set(a.hasOwnProperty("layer")&&a.layer?a.layer.uniqueId:null),n.selectedLogicalOperator.set(a.hasOwnProperty("logicalOperator")&&a.logicalOperator?a.logicalOperator:n.defaultLogicalOperator.get()),n.selectedLogicalOperator.bind(n,function(e){n.isModified.set(!0),n.app.event("_logicalOperatorChanged").publish(n.id,e)}),n.layerId.syncTransform(n.layer,function(e){return e&&e.uniqueId?e.uniqueId:null}),n.displayName.set(a.hasOwnProperty("displayName")?a.displayName:null),n.id.set(a.hasOwnProperty("id")?a.id:n._generateId()),n.selectedSpatialFilter.set(a.hasOwnProperty("spatialFilter")?a.spatialFilter:0),n.logicalOperators=new r.ObservableCollection([{name:n.app.getResource(n.libraryId,"language-querybuilder-and-operator"),val:"and"},{name:n.app.getResource(n.libraryId,"language-querybuilder-or-operator"),val:"or"}]),n.id.bind(n,function(e){var t="radioButtonGroup"+e;n.radioButtonGroup.set(t)}),n.id.pulse(),n.parentLogicalOperator.bind(n,function(){n.isAnd.set(n.parentLogicalOperator.get()===d.Conjunctions.and),n.isOr.set(n.parentLogicalOperator.get()===d.Conjunctions.or)}),n.queryItems.bind(n,function(e){switch(e.type){case"remove":var t=n.queryItems.length();e.rangeEnd===t-1&&t>1&&n.queryItems.getAt(t-2).isLast.set(!0);break;case"insert":case"append":n.queryItems.length()>0&&n.queryItems.getAt(n.queryItems.length()-1).isLast.set(!0),n.queryItems.length()>1&&n.queryItems.getAt(n.queryItems.length()-2).isLast.set(!1)}}),n._queryErrorHandler=function(e){console.error(e)},n}return __extends(i,e),i.prototype.execute=function(e,t){var r=this;if(this._previousExecuteQuery&&this._previousExecuteQuery.cancel(),this.layer.get().gcxLayer)var i=o.getQueryTask(this.layer.get().gcxLayer);else var i=o.getQueryTask(this.layer.get().serviceLayerInfo.serviceLayer,this.layer.get().serviceLayerInfo);var a=new esri.tasks.Query;a.where=this.buildWhereClause(),a.returnGeometry=!0,a.outFields=["*"],a.geometry=this.geometry?this.geometry:null,a.outSpatialReference=e,this.app.trace.debug("Executing query with where clause: "+a.where),this.app.trace.debug("Query restricted by the following geometry: "+a.geometry);var n=i.execute(a);return this._previousExecuteQuery=n,n.then(function(){r._previousExecuteQuery=null,t.publish({layer:r.layer.get(),query:a})},function(e){t.publish({layer:r.layer.get(),query:a,error:e});var i=e;i.layer=r.layer.get(),i.query=a,i.operation="query",!!r._queryErrorHandler&&r._queryErrorHandler(i)}),n},i.prototype.toString=function(){var e=this._toStringRecursive();return JSON.stringify(e,null,"\t")},i.prototype._toStringRecursive=function(){var e={id:this.id.get(),layer:this.layer.get()?this.layer.get().displayName:"null",clauses:this.queryClauses.get().map(function(e){return e.exportState()}),children:this.children.get().map(function(e){return e._toStringRecursive()}),order:this.queryItems.get().map(function(e){return e.id.get()}),conjunction:this.selectedLogicalOperator.get(),where:this.buildWhereClause(),adminDefined:this.adminDefined};return!!this.displayName.get()&&(e.displayName=this.displayName.get()),!!this.selectedSpatialFilter.get()&&(e.selectedSpatialFilter=this.selectedSpatialFilter.get()),!!this.selectedSpatialFilterName.get()&&(e.selectedSpatialFilterName=this.selectedSpatialFilterName.get()),e},i.prototype.exportState=function(){var e={id:this.id.get(),layer:this.app.project.convert.fromGcxLayer(this.layer.get().gcxLayer),clauses:this.queryClauses.get().map(function(e){return e.exportState()}),children:this.children.get().map(function(e){return e.exportState()}),order:this.queryItems.get().map(function(e){return e.id.get()}),conjunction:this.selectedLogicalOperator.get(),where:this.buildWhereClause(),adminDefined:this.adminDefined};return!!this.displayName.get()&&(e.displayName=this.displayName.get()),!!this.selectedSpatialFilter.get()&&(e.selectedSpatialFilter=this.selectedSpatialFilter.get()),!!this.selectedSpatialFilterName.get()&&(e.selectedSpatialFilterName=this.selectedSpatialFilterName.get()),e},i.prototype.applyState=function(e,t){var r=this;return(!this._isRestoringStatePromise||this._isRestoringStatePromise&&this._isRestoringStatePromise.isFulfilled())&&(this._isRestoringStatePromise=Promise.resolve()),this._isRestoringStatePromise=this._isRestoringStatePromise.then(function(){return t&&t!==p.latestProjectSerialVersion&&r._convertLegacyState(e,t),r.clearQuery(),r.id.set(e.id),r.adminDefined=e.adminDefined,r.selectedLogicalOperator.set(e.conjunction),r.displayName.set(e.hasOwnProperty("displayName")?e.displayName:null),r.selectedSpatialFilter.set(e.hasOwnProperty("selectedSpatialFilter")?e.selectedSpatialFilter:p.SpatialFilterOptions.None),r.selectedSpatialFilterName.set(e.hasOwnProperty("selectedSpatialFilterName")?e.selectedSpatialFilterName:""),r._attemptLayerRestore(e.layer)}).then(function(){return r.refreshFields()}).then(function(){return r._attemptClauseRestore(e.clauses,t)}).then(function(){return r._attemptChildRestore(e.children,t)}).then(function(){for(var t=e.order.length-1;t>=0;t--)for(var i=0;i<r.queryItems.get().length;i++){var a=r.queryItems.getAt(i);if(e.order[t]===a.id.get()){r.queryItems.removeAt(i),r.queryItems.insertItem(0,a),r.queryItems.length()>0&&r.queryItems.getAt(0).isLast.set(!1),r.queryItems.getAt(0).selectedLogicalOperator&&r.queryItems.getAt(0).selectedLogicalOperator.pulse();break}}r.queryItems.length()>0&&r.queryItems.getAt(r.queryItems.length()-1).isLast.set(!0)}).then(function(){return r.isModified.set(!1),r})["catch"](function(t){throw t.code===c.ERRCODES.LAYERMISSINGERROR&&(t=t,t.queryState=e,t.query=r),!!r._queryErrorHandler&&r._queryErrorHandler(t),r.isModified.set(!1),t}),this._isRestoringStatePromise},i.prototype._attemptLayerRestore=function(e){var t=this;return Promise.resolve().then(function(){return t.app.project.convert.toGcxLayer(e,null)}).then(function(e){var r=s.AppInfo.fromGeocortexApp(t.app).mapInfo.getLayerInfos().filter(function(e){return e.queryable&&!!e.displayName&&!!e.url}),i=l.firstOrDefault(r,function(t){return t.gcxLayer===e});if(!i){for(var a=!1,n=s.AppInfo.fromGeocortexApp(t.app).mapInfo.getTableInfos().filter(function(e){return e.queryable&&!!e.displayName&&!!e.url}),o=0;o<n.length;o++)if(n[o].gcxLayer===e){a=!0,i=n[o];break}if(t.layerIsTable.set(a),!i){var u=new Error;throw u.code=c.ERRCODES.LAYERMISSINGERROR,u.layerName=e.name||e.displayName,u.allLayers=r,u}}t.layer.set(i)})},i.prototype._attemptClauseRestore=function(e,t){var r=this,i=e.map(function(e){var i=new a.QueryClause(r.app,r.libraryId,r);try{i.applyState(e,r._fields,t)}catch(n){return!!r._queryErrorHandler&&r._queryErrorHandler(n),null}return i});return i=i.filter(function(e){return!!e}),this.addQueryClauses(i)},i.prototype._attemptChildRestore=function(e,t){var r=this,a=e.map(function(){return new i(r.app,r.libraryId,{layer:r.layer.get(),layerIsTable:!1,logicalOperator:"AND"})}),n=this.addChildren(a);return y.PromiseUtils.mapSkipRejected(e,function(e,i){return n[i].applyState(e,t)["catch"](function(e){throw r.removeChildren([n[i]]),e})},{concurrency:1/0},!0)},i.prototype._convertLegacyState=function(e,r){switch(r){case 1:!e.hasOwnProperty("id")&&(e.id=t.idPrefix+n.alphaNumericToken()),!e.hasOwnProperty("children")&&(e.children=new Array),!e.hasOwnProperty("order")&&(e.order=new Array),!e.hasOwnProperty("conjunction")&&(e.conjunction=this.defaultLogicalOperator.get()),!e.hasOwnProperty("adminDefined")&&(e.adminDefined=!1),!e.hasOwnProperty("displayName")&&(e.displayName=""),!e.hasOwnProperty("selectedSpatialFilter")&&(e.selectedSpatialFilter=p.SpatialFilterOptions.None);break;default:this.app.trace.warning("Cannot convert this version of legacy queryState. Loading this legacy query may fail.")}},i.getStateFilter=function(e){return{id:!0,layer:e.project.filter.layer,clauses:{item:a.QueryClause.getStateFilter()},children:!0,order:!0,conjunction:!0,where:!0,adminDefined:!0,displayName:!0,selectedSpatialFilter:!0,selectedSpatialFilterName:!0}},i.prototype.setErrorHandler=function(e,t,r){this._queryErrorHandler=function(i){return r.apply(e,[t,i])}},i.prototype.removeErrorHandler=function(){this._queryErrorHandler=null},i._appendExpression=function(e,t,r){var i=e;return t&&t.length>0&&(i=e&&e.length>0?e+" "+r+" "+t:t),i},i.prototype.getSuggestions=function(e){var t=this;if(0===this.numSuggestions){var r=new dojo.Deferred;return r.resolve(new Array),r}var a=new dojo.Deferred;a.id=this.counter++;var n=i._appendExpression(e.format(d.QueryOperator.StartsWith),this.layer.get().getDefinitionExpression(),d.Conjunctions.and)||"1 = 1",s=o.getQueryTask(this.layer.get().gcxLayer),l=new esri.tasks.Query;e.selectedField.name.indexOf(".")===-1&&(l.returnDistinctValues=!0),l.where=n,l.returnGeometry=!1,l.outFields=[e.selectedField.name],this.geometry&&(l.geometry=this.geometry);var u=s.execute(l);return u.id=this.counter++,u.then(function(r){for(var n={},s=new Array,o=0;o<r.features.length;o++){var l=r.features[o].attributes[e.selectedField.name]+"";if(i._isNullOrWhiteSpace(l)||n.hasOwnProperty(l)||(n[l]=l,s.push(l)),s.length==t.numSuggestions)break}s.sort(),s=s.map(function(t){return e.selectedField.formatValue(t)}),a.resolve(s)},function(r){t.app.trace.error("Could not retrieve suggestions for "+e.selectedField.name,r);var i=r;return i.layer=t.layer.get(),i.query=l,i.operation="get suggestions",!!t._queryErrorHandler&&t._queryErrorHandler(i),a.errback(r)}),a},i._isNullOrWhiteSpace=function(e){return!e||0==e.length||e.search(/^\s+$/g)>=0},i.prototype.addChildren=function(e){var t=this;return e.map(function(e,r,i){e.layer.sync(t.layer),e.layerIsTable.sync(t.layerIsTable),e.defaultLogicalOperator.sync(t.defaultLogicalOperator),e.hasParent.set(!0),e.parentQuery=t,e.parentLogicalOperator.sync(t.selectedLogicalOperator),e.numSuggestions=t.numSuggestions,e._queryErrorHandler=t._queryErrorHandler,e.isModified.bind(t,function(e){e&&t.isModified.set(!0)}),t.children.addItem(e),t.queryItems.addItem(e)}),this.isModified.set(!0),e},i.prototype.removeChildren=function(e){for(var t=this,r=[],i=this.children.get(),a=0;a<i.length;a++)for(var n=0;n<e.length;n++)i[a].id.get()===e[n].id.get()&&r.push(i[a]);r.forEach(function(e){t.children.removeItem(e),t.queryItems.removeItem(e)}),this.isModified.set(!0)},i.prototype.addQueryClauses=function(e){var t=this;return Promise.resolve().then(function(){for(var r=0;r<e.length;r++){try{e[r].setFields(t._fields)}catch(i){!!t._queryErrorHandler&&t._queryErrorHandler(i)}e[r].updateCodedDomainValues(),t.queryClauses.addItem(e[r]),t.queryItems.addItem(e[r])}return t.isModified.set(!0),1!==t.queryClauses.length()||t.hasParent.get()?t.queryClauses.length()>0&&t.queryClauses.getAt(0).deleteDisabled.set(!1):t.queryClauses.getAt(0).deleteDisabled.set(!0),e},function(r){if(r.code===c.ERRCODES.LAYERFIELDERROR){var i=r;return i.code=c.ERRCODES.ADDQUERYCLAUSEERROR,i.clauses=e,!!t._queryErrorHandler&&t._queryErrorHandler(r),[]}throw r})},i.prototype.removeQueryClause=function(e){e.dispose(),this.queryClauses.removeItem(e),this.queryItems.removeItem(e),this.isModified.set(!0),1!==this.queryClauses.length()||this.hasParent.get()?this.queryClauses.length()>0&&this.queryClauses.getAt(0).deleteDisabled.set(!1):this.queryClauses.getAt(0).deleteDisabled.set(!0)},i.prototype._disposeAllClauses=function(){this.queryClauses.get().forEach(function(e){return e.dispose()}),this.queryClauses.clear(),this.queryItems.clear(),this.children.get().forEach(function(e){e._disposeAllClauses()}),this.removeChildren(this.children.get())},i.prototype.buildWhereClause=function(){var e=this._buildInnerWhereClause();return e=i._appendExpression(e,this.layer.get().getDefinitionExpression(),d.Conjunctions.and),this._debugWhereClause.set(e),e},i.prototype._buildInnerWhereClause=function(){for(var e=this,t="",r=0;r<this.queryClauses.length();r++){var i=this.queryClauses.getAt(r).format();i&&(t.length>0&&(t+=" "+this.selectedLogicalOperator.get()+" "),t+=i)}return this.children.get().forEach(function(r){var i=r._buildInnerWhereClause();i&&(t?t+=" "+e.selectedLogicalOperator.get()+" "+i+" ":t=i)}),t||this.hasParent.get()||(t="1 = 1"),t&&(t="("+t+")"),t},i.prototype.pulseCodedDomainValues=function(){for(var e=0;e<this.queryClauses.length();e++)this.queryClauses.getAt(e).codedDomainValue.pulse();this.children.get().forEach(function(e){e.pulseCodedDomainValues()})},i.prototype.updateCodedDomainValues=function(){for(var e=0;e<this.queryClauses.length();e++)this.queryClauses.getAt(e).updateCodedDomainValues();this.children.get().forEach(function(e){e.updateCodedDomainValues()})},i.prototype.refreshFields=function(){var e=this;if(!this.layer.get())return Promise.resolve();var t=new Promise(function(t,r){e.layer.get().getFields().then(t,r)});return t.then(function(t){e._fields=t.filter(function(e){return dojo.indexOf(i._excludedFieldTypes,e.type)<0&&e.isVisible}),e._fields=e._fields.sort(function(e,t){var r=(e.alias||"").toLocaleLowerCase(),i=(t.alias||"").toLocaleLowerCase();return r==i?0:r<i?-1:1})},function(t){var r=t;throw r.code=c.ERRCODES.LAYERFIELDERROR,r.queryClause=null,r.missingFieldName=null,r.allFields=e._fields,!!e._queryErrorHandler&&e._queryErrorHandler(r),t})},i.prototype.getNewInstance=function(e){var t=this,r=new i(this.app,this.libraryId,{logicalOperator:"AND",layer:this.layer.get(),layerIsTable:!1});return r.applyState(this.exportState(),p.latestProjectSerialVersion).then(function(r){return r._queryErrorHandler=t._queryErrorHandler,e&&r.refreshId(),r},function(e){return t.app.trace.error("Could not get new instance of query"),!!t._queryErrorHandler&&t._queryErrorHandler(e),Promise.reject(e)})},i.prototype._generateId=function(){return t.idPrefix+n.alphaNumericToken()},i.prototype.clearQuery=function(){this._disposeAllClauses(),this.layer.set(null),this._fields=[],this.selectedLogicalOperator.set(this.defaultLogicalOperator.get()),this.layerIsTable.set(!1),this.displayName.set(null),this.isModified.set(!1)},i.prototype.refreshId=function(){this.id.set(this._generateId())},i}(i.QueryBase);h._excludedFieldTypes=[u.EsriFieldTypes.esriFieldTypeBlob,u.EsriFieldTypes.esriFieldTypeGeometry,u.EsriFieldTypes.esriFieldTypeGlobalID,u.EsriFieldTypes.esriFieldTypeGUID],t.Query=h})},"Mapping/modules/QueryBuilder/QueryBase":function(){define(["require","exports","geocortex/framework/observables"],function(e,t,r){"use strict";var i=function(){function e(e,t){this.id=new r.Observable(null),this.isLast=new r.Observable((!1)),this.isAnd=new r.Observable(null),this.isOr=new r.Observable(null),this.app=e,this.libraryId=t}return e}();t.QueryBase=i})},"Mapping/modules/QueryBuilder/QueryBuilderModule":function(){define(["require","exports","geocortex/framework/application/ModuleBase","./QueryCollection","./Query","./QueryClause","./QueryErrorHandling","geocortex/infrastructure/commandArgs/AddStatusArgs","geocortex/infrastructure/gis/AppInfo","./QueryOperator","geocortex/framework/utils/utils","geocortex/infrastructure/PromiseUtils"],function(e,t,r,i,a,n,s,o,l,u,d,p){"use strict";var c;!function(e){e[e.None=0]="None",e[e.CurrentExtent=1]="CurrentExtent",e[e.Drawings=2]="Drawings"}(c=t.SpatialFilterOptions||(t.SpatialFilterOptions={})),t.latestProjectSerialVersion=2;var y=function(e){function r(t,r){var i=e.call(this,t,r)||this;return i.defaultLogicalOperator=u.Conjunctions.and,i._queryStatusView=null,i._filterStatusView=null,i}return __extends(r,e),r.prototype.initialize=function(e){if(e=e||{},e.hasOwnProperty("queryStatusRegion")&&(this._queryStatusRegion=e.queryStatusRegion),e.hasOwnProperty("filterStatusRegion")&&(this._filterStatusRegion=e.filterStatusRegion),e.hasOwnProperty("defaultLogicalOperator")&&null!=e.defaultLogicalOperator&&"string"==typeof e.defaultLogicalOperator){var t=e.defaultLogicalOperator.toLowerCase();void 0===u.Conjunctions[t]||null===u.Conjunctions[t]?this.app.trace.warning('Invalid default conjunction "'+t+'" given. Using '+u.Conjunctions.and+" as the default"):this.defaultLogicalOperator=u.Conjunctions[t]}return this._registerCommands(),this._initializeCollections()},r.prototype._initializeCollections=function(){var e=this;return this._queryStore=new i.QueryCollection(this.app,this.libraryId,{persistent:!1,sourceName:"SavedQueries"}),this._queryStore.isFilterCollection=!1,this._filterStore=new i.QueryCollection(this.app,this.libraryId,{persistent:!1,sourceName:"SavedFilters"}),this._filterStore.isFilterCollection=!0,Promise.all([this._queryStore.initialize(),this._filterStore.initialize()]).then(function(){return e._queryStore.setCollectionChangedEvent(e.app.event("SavedQueriesChangedEvent")),e._filterStore.setCollectionChangedEvent(e.app.event("SavedFiltersChangedEvent")),e.app.event("SavedQueriesChangedEvent").subscribe(e,function(){e.app.trace.debug("Query Collection changed"),e.app.trace.debug("The list of queries follows: "),e._queryStore.getAllQueries().forEach(function(t,r){var i=function(e){e.layer=null,e.children.forEach(i)},a=t.exportState();i(a),e.app.trace.debug("Query: "+r+" \n"+JSON.stringify(a,null,2))})}),e.app.event("SavedFiltersChangedEvent").subscribe(e,function(){e.app.trace.debug("Filter Collection changed"),e.app.trace.debug("The list of filters follows: "),e._filterStore.getAllQueries().forEach(function(t,r){var i=function(e){e.layer=null,e.children.forEach(i)},a=t.exportState();i(a),e.app.trace.debug("Filter: "+r+" \n"+JSON.stringify(a,null,2))})}),e._retrieveSiteQueries()}).then(function(t){return p.PromiseUtils.mapSkipRejected(t,function(t){return t.adminDefined=!0,p.PromiseUtils.allSkipRejected([t.getNewInstance().then(function(t){return t.setErrorHandler(e,!1,s.handleQueryErrors),e._queryStore.addQuery(t)}),Promise.resolve().then(function(){t.setErrorHandler(e,!0,s.handleQueryErrors),e._filterStore.addQuery(t)})],!0)},{concurrency:1/0},!0)})},r.prototype._registerCommands=function(){var e=this;this.app.command("AddQueryStatus").register(this,function(t,r){return e.addStatus(!1,t,r)}),this.app.command("AddFilterStatus").register(this,function(t,r){return e.addStatus(!0,t,r)}),this.app.command("RemoveQueryStatus").register(this,function(){return e.removeStatus(!1)}),this.app.command("RemoveFilterStatus").register(this,function(){return e.removeStatus(!0)}),this.app.command("_getAllSavedQueries").register(this,function(t){return e._getAllQueries(!1,t)}),this.app.command("_getAllSavedFilters").register(this,function(t){return e._getAllQueries(!0,t)}),this.app.command("_getSavedQueryById").register(this,function(t,r,i){return e._getQueryById(!1,t,r,i)}),this.app.command("_getSavedFilterById").register(this,function(t,r,i){return e._getQueryById(!0,t,r,i)}),this.app.command("_getSavedQueryByName").register(this,function(t,r,i){return e._getQueryByName(!1,t,r,i)}),this.app.command("_getSavedFilterByName").register(this,function(t,r,i){return e._getQueryByName(!0,t,r,i)}),this.app.command("RemoveSavedQuery").register(this,function(t,r){return e._removeQuery(!1,t,r)}),this.app.command("RemoveSavedFilter").register(this,function(t,r){return e._removeQuery(!0,t,r)}),this.app.command("RemoveSavedQueryById").register(this,function(t){return e._removeQueryById(!1,t)}),this.app.command("RemoveSavedFilterById").register(this,function(t){return e._removeQueryById(!0,t)}),this.app.command("_updateSavedQueryById").register(this,function(t,r,i,a){return e._updateQueryById(!1,t,r,i,a)}),this.app.command("_updateSavedFilterById").register(this,function(t,r,i,a){return e._updateQueryById(!0,t,r,i,a)}),this.app.command("ClearSavedQueries").register(this,function(){return e._clearQueries(!1)}),this.app.command("ClearSavedFilters").register(this,function(){return e._clearQueries(!0)}),this.app.command("_addSavedQuery").register(this,function(t,r,i){return e._addQuery(!1,t,r,i)}),this.app.command("_addSavedFilter").register(this,function(t,r,i){return e._addQuery(!0,t,r,i)})},r.prototype._retrieveSiteQueries=function(){var e=this;return this.app.waitUntilSiteServiceLayersLoaded().then(function(){var t=l.AppInfo.fromGeocortexApp(e.app).mapInfo.getLayerInfos().filter(function(e){return e.queryable&&!!e.displayName&&!!e.url});return p.PromiseUtils.mapSkipRejected(t,function(t){return e._retrieveQueriesForLayer(t)},{concurrency:1/0},!0)}).then(function(e){var t;return t=0!==e.length?e.reduce(function(e,t){return e.concat(t)}):[]})["catch"](function(t){return e.app.trace.error("An unknown error occured while retrieving queries defined for the site.\n\n                                    No queries were loaded.\n\n                                    Please contact your administrator to fix this issue."),console.error(t),[]})},r.prototype._retrieveQueriesForLayer=function(e){var r=this,i=e.gcxLayer.queries||[];return p.PromiseUtils.mapSkipRejected(i,function(i){if(!r._isValidQueryGroupObject(i.query))throw new Error("Could not parse the following query. Reason: Invalid query object\n\n                                        "+JSON.stringify(i.query,null,2));var n=r._configureQueryStateRecursive(i.query,e,i.id,i.displayName),s=new a.Query(r.app,r.libraryId,{layer:e,layerIsTable:!1,logicalOperator:"and"});return s.applyState(n,t.latestProjectSerialVersion)},{concurrency:1/0},!0)},r.prototype._configureQueryStateRecursive=function(e,t,r,i){var s=this,o=this.app.project.convert.fromGcxLayer(t.gcxLayer),l={id:r,layer:o,clauses:[],children:[],order:[],conjunction:e.conjunction,where:"",adminDefined:!1,displayName:i,selectedSpatialFilter:c.None,selectedSpatialFilterName:this.getResource("language-querybuilder-spatial-filter-all")},p=[],y=[];if(e.items.forEach(function(e){if(s._isValidClauseObject(e)){
void 0===e.value&&(e.value=null);var t={id:n.idPrefix+d.alphaNumericToken(),field:e.field,operator:u.QueryOperator[e.operator].toString(),value:e.value};y.push(t)}else s._isValidQueryGroupObject(e)?p.push(e):s.app.trace.error("Could not parse the following query item. It is not an instance of a clause or sub-query\n\n                                        "+JSON.stringify(e,null,2))}),0==y.length)throw new Error("Query must have at least one valid query clause");return l.clauses=y,l.children=p.map(function(e){var r=a.idPrefix+d.alphaNumericToken();return s._configureQueryStateRecursive(e,t,r,i)}),l},r.prototype._isValidClauseObject=function(e){return void 0!==e.field&&null!==e.field&&"string"==typeof e.field&&(void 0!==e.operator&&null!==e.operator&&"string"==typeof e.operator&&void 0!==u.QueryOperator[e.operator]&&("string"==typeof e.value||null===e.value||void 0===e.value))},r.prototype._isValidQueryGroupObject=function(e){return void 0!==e.conjunction&&null!==e.conjunction&&"string"==typeof e.conjunction&&(e.conjunction=e.conjunction.toLowerCase(),void 0!==u.Conjunctions[e.conjunction]&&null!==u.Conjunctions[e.conjunction]||(e.conjunction=null),e.items instanceof Array)},r.prototype._getAllQueries=function(e,t){try{var r=(e?this._filterStore:this._queryStore).getAllQueries();t(r)}catch(i){var a=i;a.code=s.ERRCODES.RETRIEVECOLLECTIONERROR,s.handleQueryErrors.call(this,e,a),t([])}},r.prototype._getQueryById=function(e,t,r,i){try{var a=(e?this._filterStore:this._queryStore).getQueryById(t);if(null==a){var n=new Error("Query with id "+t+" not found");return n.code=s.ERRCODES.NOTFOUND,n.id=t,i(n)}return r(a)}catch(o){return i(o)}},r.prototype._getQueryByName=function(e,t,r,i){try{var a=(e?this._filterStore:this._queryStore).getQueryByName(t);if(null===a){var n=new Error("Query with name "+t+" not found");return n.code=s.ERRCODES.NOTFOUND,n.name=t,!!i&&i(n)}return r(a)}catch(o){return!!i&&i(o)}},r.prototype._removeQuery=function(e,t,r){var i=this,a=this.getResource("language-querybuilder-delete-prompt"),n=this.getResource("language-querybuilder-delete-prompt-title").format(t.displayName.get());r&&r.removeLayerFlag===!0?this._removeQueryById(e,t.id.get()):this.app.command("Confirm").execute(a,n,function(r){r&&i._removeQueryById(e,t.id.get())})},r.prototype._removeQueryById=function(e,t){var r=this,i=(e?this._filterStore:this._queryStore).removeQueryById(t);i.then(function(i){if(null===i){var a=new Error("Query with id "+t+" not found");throw a.code=s.ERRCODES.NOTFOUND,a.id=t,a}r.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(r.app.getResource(r.libraryId,"language-querybuilder-notification-removed").format(e?"filter":"query",i.displayName.get()))})["catch"](function(t){s.handleQueryErrors.call(r,e,t),r.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(r.app.getResource(r.libraryId,"language-querybuilder-error-removing").format(e?"filter":"query",{error:!0}))})},r.prototype._updateQueryById=function(e,t,r,i,a){var n=this;try{var s=(e?this._filterStore:this._queryStore).updateQueryById(t,r);s.then(function(t){return n.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(n.app.getResource(n.libraryId,"language-querybuilder-notification-updated").format(e?"filter":"query",t.displayName.get())),!!i&&i(t)},function(e){throw e})}catch(o){return!!a&&a(o)}},r.prototype._addQuery=function(e,t,r,i){var a=this;try{var n=(e?this._filterStore:this._queryStore).addQuery(t);n.then(function(t){return a.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(a.app.getResource(a.libraryId,"language-querybuilder-notification-saved").format(e?"filter":"query",t.displayName.get())),!!r&&r(t)},function(e){return!!i&&i(e)})}catch(s){return!!i&&i(s)}},r.prototype._clearQueries=function(e){var t=this,r=(e?this._filterStore:this._queryStore).clear();r.then(function(){t.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(t.app.getResource(t.libraryId,"language-querybuilder-notification-clear").format(e?"filter":"query"))},function(r){t.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(t.app.getResource(t.libraryId,"language-querybuilder-error-clearing").format(e?"filter":"query",{error:!0}))})},r.prototype.addStatus=function(e,t,r){var i=new o.AddStatusArgs(t);i.timeoutMS=0,i.regionName=e?this._filterStatusRegion:this._queryStatusRegion,i.id=e?"FilterStatusMessageView":"QueryStatusMessageView",e?this.app.command("RemoveFilterStatus").execute():this.app.command("RemoveQueryStatus").execute(),this.app.command("AddStatus").execute(i)},r.prototype.removeStatus=function(e){this.app.command("RemoveStatus").execute(e?"FilterStatusMessageView":"QueryStatusMessageView")},r.prototype.getStateFilter=function(){return{queries:{item:a.Query.getStateFilter(this.app)},filters:{item:a.Query.getStateFilter(this.app)},savedQueries:{item:a.Query.getStateFilter(this.app)},savedFilters:{item:a.Query.getStateFilter(this.app)}}},r.prototype.exportState=function(){var e=this,t={queries:[],savedQueries:[],filters:[],savedFilters:[],serialVersion:2};t.savedQueries=this._queryStore.getAllQueries().map(function(e){return e.exportState()}),t.savedQueries=t.savedQueries.filter(function(e){return!e.adminDefined}),t.savedFilters=this._filterStore.getAllQueries().map(function(e){return e.exportState()}),t.savedFilters=t.savedFilters.filter(function(e){return!e.adminDefined});var r=["_ExportQueryBuilderState","_ExportFilterBuilderState"].map(function(r){return new Promise(function(i,a){return e.app.command(r).execute(t,i,function(r){return e.app.trace.error("Could not export query or filter builder state"),i(t)})})}),i=Promise.all(r).then(function(){return t});return i},r.prototype.applyState=function(e){var r=this;e.serialVersion!==t.latestProjectSerialVersion&&this.convertLegacyState(e);var i={state:e,completePromises:[]};return this.app.waitUntilAllLibrariesLoaded().then(function(){var e=r._queryStore.getAllQueries().filter(function(e){return!e.adminDefined}),t=r._filterStore.getAllQueries().filter(function(e){return!e.adminDefined}),i=e.map(function(e){return r._queryStore.removeQueryById(e.id.get())}),a=t.map(function(e){return r._filterStore.removeQueryById(e.id.get())});return Promise.all(i.concat(a))}).then(function(){r._queryStore.disableCollectionChangedEvent(),r._filterStore.disableCollectionChangedEvent();var t=r._restoreCollection(r._queryStore,e.savedQueries),i=r._restoreCollection(r._filterStore,e.savedFilters);return Promise.all([t,i])}).then(function(){return r.app.command("_ApplyQueryBuilderState").execute(i),r.app.command("_ApplyFilterBuilderState").execute(i),Promise.all(i.completePromises)}).then(function(){r._queryStore.enableCollectionChangedEvent(),r._filterStore.enableCollectionChangedEvent(),r._queryStore.bindingEvent.publish(),r._filterStore.bindingEvent.publish()})["return"]()},r.prototype._restoreCollection=function(e,r){var i=this;return p.PromiseUtils.mapSkipRejected(r,function(r){var n=new a.Query(i.app,i.libraryId,{layer:null,layerIsTable:!1,logicalOperator:"AND"});n.setErrorHandler(i,!1,s.handleQueryErrors);var o;return n.applyState(r,t.latestProjectSerialVersion).then(function(t){return o=t,e.addQuery(t)})["catch"](function(t){if(t.code===s.ERRCODES.DUPLICATE)return o.displayName.set(o.displayName.get()+" "+i.app.getResource(i.libraryId,"language-querybuilder-duplicate-name-resolution-postfix")),i.app.command(e.isFilterCollection?"RemoveFilterStatus":"RemoveQueryStatus").execute(),e.addQuery(o);throw t})},{concurrency:1/0},!0)},r.prototype.convertLegacyState=function(e){switch(e.serialVersion){case 1:e.savedQueries=[],e.savedFilters=[];break;default:this.app.trace.warning("Could not convert legacy state of query builder module. Legacy version unknown")}},r}(r.ModuleBase);t.QueryBuilderModule=y})},"Mapping/modules/QueryBuilder/QueryBuilderState":function(){define(["require","exports"],function(e,t){"use strict"})},"Mapping/modules/QueryBuilder/QueryClause":function(){define(["require","exports","geocortex/forms/items/DatePickerFormItem","./AutoCompleteViewModel","geocortex/framework/observables","./QueryOperatorDescription","./QueryOperator","geocortex/infrastructure/FormatUtils","geocortex/infrastructure/DateFormat","geocortex/essentials/Field","geocortex/infrastructure/TimeZoneUtils","./QueryBase","./QueryErrorHandling","./Formatters","geocortex/framework/utils/utils","./QueryBuilderModule"],function(e,t,r,i,a,n,s,o,l,u,d,p,c,y,h,g){"use strict";t.idPrefix="qc_";var m=function(e){function p(d,c,g){var m=e.call(this,d,c)||this;return m._settingCodedDomainValue=!1,m.fields=new a.ObservableCollection,m.fieldValue=new a.Observable,m.codedDomainValue=new a.Observable,m.operators=new a.ObservableCollection,m.selectedFieldName=new a.Observable,m.selectedOperator=new a.Observable,m.deleteDisabled=new a.Observable((!1)),m.codedValues=new a.ObservableCollection,m.presentableFieldName=new a.Observable,m.presentableOperator=new a.Observable,m.presentableFieldValue=new a.Observable,m.presentableFieldValueIsEmptyText=new a.Observable,m.logicalOperator=new a.Observable,m.showTextInput=new a.Observable,m.showDateTimeInput=new a.Observable,m.showCodedValueDomainInput=new a.Observable,m.showDisabledInput=new a.Observable,m.id.set(t.idPrefix+h.alphaNumericToken()),m.type="queryItem",m.autoCompleteViewModel=new i.AutoCompleteViewModel(d,c),m.autoCompleteViewModel.queryClause=m,m.datePickerFormItem=new r.DatePickerFormItem(null),m.datePickerFormItem.nullable.set(!1),m.layer=g.layer.get(),m.parentQuery=g,m.templateType="single-item",m.selectedOperator.set(s.QueryOperator.Equals.toString()),m._selectedFieldNameBindingToken=m.selectedFieldName.bind(m,m._fieldChanged),m._selectedOperatorBindingToken=m.selectedOperator.bind(m,m._operatorChanged),m._codedDomainValueBindingToken=m.codedDomainValue.bind(m,function(e){!m._settingCodedDomainValue&&m.selectedField.isTypeField&&m.parentQuery.updateCodedDomainValues()}),m.fieldValue.bind(m,function(){m.parentQuery.isModified.set(!0)}),m.presentableFieldName.syncTransform(m.selectedFieldName,function(e){var t=m.fields.get().filter(function(e){return e.name==m.selectedFieldName.get()})[0];return t?t.alias:""}),m.presentableFieldValue.syncTransform(m.fieldValue,function(e){if(e){m.presentableFieldValueIsEmptyText.set(!1);var t=o.parseDate(e,l.DateFormat.ROUND_TRIP);if(m.selectedField&&m.selectedField.type===u.EsriFieldTypes.esriFieldTypeDate&&t&&!isNaN(t.getTime())){var r=y.QueryFormatterFactory.getFormatter(m.parentQuery.layer.get());return r.supportsTimeOfDay()?o.formatDate(t,l.DateFormat.DATE_TIME_SHORT):o.formatDate(t,l.DateFormat.DATE_SHORT)}if(p._isCodedValueDomain(m.selectedField))for(var i=0;i<m.codedValues.length();i++)if(m.codedValues.getAt(i).val===m.codedDomainValue.get())return m.codedValues.getAt(i).name;return m.selectedField.isNumeric()?m.selectedField.formatValue(e):"'{0}'".format(e)}return m.presentableFieldValueIsEmptyText.set(!0),m.app.getResource(m.libraryId,"language-querybuilder-any-value")}),m.presentableOperator.syncTransform(m.selectedOperator,function(e){return n.QueryOperatorDescription.FromQueryOperator(parseInt(e)).name}),m.logicalOperator.bind(m,function(){m.isAnd.set(m.logicalOperator.get()===s.Conjunctions.and),m.isOr.set(m.logicalOperator.get()===s.Conjunctions.or)}),m.logicalOperator.sync(m.parentQuery.selectedLogicalOperator),m}return __extends(p,e),p.prototype.format=function(e){var t=y.QueryFormatterFactory.getFormatter(this.layer);e=e||parseInt(this.selectedOperator.get());var r=this.fieldValue.get();if(!r&&e!=s.QueryOperator.IsNull&&e!=s.QueryOperator.IsNotNull)return"";var i=o.parseDate(r,l.DateFormat.ROUND_TRIP);if(this.selectedField&&this.selectedField.type===u.EsriFieldTypes.esriFieldTypeDate&&i&&!isNaN(i.getTime())){var a=this.layer&&this.layer.gcxLayer?d.getTimeZoneFromLayer(this.layer.gcxLayer):null,n=this.layer&&this.layer.gcxLayer?d.getDisplayTimeZoneFromMapService(this.layer.gcxLayer.mapService):null;i=d.correctDatesToQueryInDatabaseTime(i,a,n),r=o.formatDate(i,l.DateFormat.ROUND_TRIP)}return t.format(this.selectedField,e,r)},p.prototype.exportState=function(){return{id:this.id.get(),field:this.selectedFieldName.get(),operator:this.selectedOperator.get(),value:this.fieldValue.get()}},p.prototype.applyState=function(e,t,r){r&&r!==g.latestProjectSerialVersion&&this.convertLegacyState(e,r),this.id.set(e.id);try{this.setFields(t)}catch(i){var a=i;throw a.missingFieldName=e.field,i}this.selectedFieldName.set(e.field),this.updateCodedDomainValues(),this.selectedOperator.set(e.operator),p._isCodedValueDomain(this.selectedField)?this.codedDomainValue.set(e.value):this.selectedField.isDate()?this.datePickerFormItem.date.set(o.parseDate(e.value)):this.autoCompleteViewModel.value.set(e.value)},p.prototype.convertLegacyState=function(e,r){switch(r){case 1:e.id=t.idPrefix+h.alphaNumericToken();break;default:this.app.trace.warning("Legacy queryClause serialVersion not recognized. Creating the queryClause may fail.")}},p.getStateFilter=function(){return{id:!0,field:!0,operator:!0,value:!0}},p.prototype.getSuggestions=function(){return this.parentQuery.getSuggestions(this)},p.prototype._fieldChanged=function(){var e=this,t=this.fields.get().filter(function(t){return t.name==e.selectedFieldName.get()})[0];if(t){this.selectedField=t,this.parentQuery.isModified.set(!0),this.operators.clear(),p._isCodedValueDomain(t)?(this.operators.addItem(n.QueryOperatorDescription.Equals),this.operators.addItem(n.QueryOperatorDescription.NotEquals)):t.isNumeric()||t.isDate()?(this.operators.addItem(n.QueryOperatorDescription.Equals),this.operators.addItem(n.QueryOperatorDescription.NotEquals),this.operators.addItem(n.QueryOperatorDescription.LessThan),this.operators.addItem(n.QueryOperatorDescription.LessThanEquals),this.operators.addItem(n.QueryOperatorDescription.GreaterThan),this.operators.addItem(n.QueryOperatorDescription.GreaterThanEquals)):t.isText()&&(this.operators.addItem(n.QueryOperatorDescription.Contains),this.operators.addItem(n.QueryOperatorDescription.DoesNotContain),this.operators.addItem(n.QueryOperatorDescription.StartsWith),this.operators.addItem(n.QueryOperatorDescription.EndsWith),this.operators.addItem(n.QueryOperatorDescription.Equals),this.operators.addItem(n.QueryOperatorDescription.NotEquals)),t.nullable&&(this.operators.addItem(n.QueryOperatorDescription.IsNull),this.operators.addItem(n.QueryOperatorDescription.IsNotNull)),this.selectedOperator.set(this.operators.getAt(0).value.toString());var r=parseInt(this.selectedOperator.get());this._updateInputVisibility(t,r),this.parentQuery.updateCodedDomainValues(),p._isCodedValueDomain(this.selectedField)?this.fieldValue.sync(this.codedDomainValue):this.selectedField.isDate()?this.fieldValue.syncTransform(this.datePickerFormItem.date,function(t){return o.formatDate(e.datePickerFormItem.date.get(),l.DateFormat.ROUND_TRIP)}):this.fieldValue.sync(this.autoCompleteViewModel.value)}},p.prototype.setFields=function(e){this.fields.set(e),this.parentQuery.isModified.set(!0);var t=new Error("Could not find selected field from given fields.");if(t.queryClause=this,t.code=c.ERRCODES.LAYERFIELDERROR,this.fields.length()>0&&!this.selectedFieldName.get())this.selectedFieldName.set(this.fields.getAt(0).name);else{if(0==this.fields.length())throw t.missingFieldName=this.selectedFieldName.get(),t.allFields=[],this.selectedFieldName.set(null),t;if(this.selectedFieldName.get()&&this.fields.get().map(function(e){return e.name}).indexOf(this.selectedFieldName.get())===-1)throw t.missingFieldName=this.selectedFieldName.get(),t.allFields=e,this.selectedFieldName.set(this.fields.getAt(0).name),t}},p.prototype.updateCodedDomainValues=function(){var e=this;if(this.codedValues.clear(),this.selectedField){if(this.selectedField.isCodedValueDomain())for(var t=0;t<this.selectedField.getCodedValueDomain().codedValues.length;t++){var r=this.selectedField.getCodedValueDomain().codedValues[t];this.codedValues.addItem({name:r.name,val:r.code.toString()})}else if(this.selectedField.hasSubtypeCodedValueDomains()){for(var i=this.selectedField.getSubtypeCodedValueDomains(),a=0,n=null,t=0;t<this.parentQuery.queryClauses.length();t++){var o=this.parentQuery.queryClauses.getAt(t);o!==this&&o.selectedField&&o.selectedField.isTypeField&&(n=o,a++)}if(1===a){var l=n.codedDomainValue.get();if(n.selectedOperator.get()===s.QueryOperator.Equals.toString()){var u=i[l];u&&u.codedValues.forEach(function(t){e.codedValues.addItem({name:t.name,val:t.code.toString()})})}else for(var d in i)if(d!==l&&i.hasOwnProperty(d)){var u=i[d];u.codedValues.forEach(function(t){e.codedValues.addItem({name:t.name,val:t.code.toString()})})}}else for(var d in i)if(i.hasOwnProperty(d)){var u=i[d];u.codedValues.forEach(function(t){e.codedValues.addItem({name:t.name,val:t.code.toString()})})}}if(this.parentQuery.isModified.set(!0),this.codedValues.length()>0){this._settingCodedDomainValue=!0;for(var p=!1,t=0;t<this.codedValues.getLength();t++)this.codedValues.getAt(t).val===this.codedDomainValue.get()&&(p=!0,this.codedDomainValue.pulse());p||this.codedDomainValue.set(this.codedValues.getAt(0).val),this._settingCodedDomainValue=!1}}},p.prototype._updateInputVisibility=function(e,t){this.showTextInput.set(!1),this.showDateTimeInput.set(!1),this.showCodedValueDomainInput.set(!1),this.showDisabledInput.set(!1),t==s.QueryOperator.IsNotNull||t==s.QueryOperator.IsNull?this.showDisabledInput.set(!0):e.isDate()?this.showDateTimeInput.set(!0):p._isCodedValueDomain(e)?this.showCodedValueDomainInput.set(!0):this.showTextInput.set(!0)},p.prototype._operatorChanged=function(){var e=this.selectedField;e.isTypeField&&this.parentQuery.updateCodedDomainValues();var t=parseInt(this.selectedOperator.get());this._updateInputVisibility(e,t),this.parentQuery.isModified.set(!0)},p._isCodedValueDomain=function(e){return e.isCodedValueDomain()||e.hasSubtypeCodedValueDomains()},p.prototype.dispose=function(){this.selectedFieldName.unbind(this._selectedFieldNameBindingToken),this.selectedOperator.unbind(this._selectedOperatorBindingToken),this.codedDomainValue.unbind(this._codedDomainValueBindingToken),this.fieldValue.removeSync(),this.presentableFieldName.removeSync(),this.presentableFieldValue.removeSync(),this.presentableOperator.removeSync(),this.autoCompleteView&&this.autoCompleteView.dispose()},p}(p.QueryBase);t.QueryClause=m})},"Mapping/modules/QueryBuilder/QueryCollection":function(){define(["require","exports","geocortex/framework/observables","./Query","geocortex/framework/utils/utils","geocortex/framework/events/Event","./QueryErrorHandling","./QueryBuilderModule","geocortex/infrastructure/PromiseUtils"],function(e,t,r,i,a,n,s,o,l){"use strict";t.Sources={Project:"project",AdministratorDefined:"adminDef",CurrentSession:"curSession"};var u;!function(e){e[e.CREATE=0]="CREATE",e[e.UPDATE=1]="UPDATE",e[e.DELETE=2]="DELETE"}(u=t.Operations||(t.Operations={}));var d=function(){function e(e,t,i){if(this.queryStorageKey="QC",this.isFilterCollection=!1,this.id="QC-"+a.alphaNumericToken(),this.app=e,this.libraryId=t,i.persistent){var s="Persistent queries not supported",o=new Error;throw o.message=s,this.app.trace.error("Persistent queries not supported",o),o}this.store=null,this.sourceName=i.sourceName?i.sourceName:null,this.queryStorageKey+="-"+(this.sourceName?this.sourceName:"unknown"),this._queries=new r.ObservableCollection,this.bindingEvent=new n.Event("placeholderForQueryCollectionChanged",e)}return e.prototype.initialize=function(){return this._initializeData()},e.prototype._initializeData=function(){var e=this;return Promise.all([this._retrieveLocalQueries()]).then(function(t){var r=[];return t.forEach(function(e){r.push.apply(r,e)}),l.PromiseUtils.mapSkipRejected(r,function(t){e.getQueryByName(t.displayName.get());if(null!==t){t.displayName.set(t.displayName.get().concat("_duplicate"))}return e.addQuery(t)},{concurrency:1/0},!0)})},e.prototype._retrieveLocalQueries=function(){var e=this;return this.store?this.app.store.get(this.queryStorageKey).then(function(t){var r=[];if(t)try{r=JSON.parse(t)}catch(a){e.app.trace.error("Unable to parse user queries",a)}return l.PromiseUtils.mapSkipRejected(r,function(t){var r=new i.Query(e.app,e.libraryId,{layer:null,layerIsTable:!1,logicalOperator:"AND"});return r.setErrorHandler(e,e.isFilterCollection,s.handleQueryErrors),r.applyState(t,o.latestProjectSerialVersion)},{concurrency:1/0},!0)},function(t){return e.app.trace.error("Could not retrieve user queries from storage"),new Array}):Promise.resolve(new Array)},e.prototype._save=function(e){var t=this;if(this.store){var r=JSON.stringify(this._queries.get().map(function(e){return e.exportState()}));return new Promise(function(e,i){t.store.set(t.queryStorageKey,r,function(e,r){t._bindingEventDisabled||t.bindingEvent.publish()},function(e){t.app.trace.error("Could not save QueryCollection",e),i(e)})})}return this._bindingEventDisabled||(void 0!==e?this.bindingEvent.publish(e):this.bindingEvent.publish()),Promise.resolve()},e.prototype.setCollectionChangedEvent=function(e){this.bindingEvent=e},e.prototype.disableCollectionChangedEvent=function(){this._bindingEventDisabled=!0},e.prototype.enableCollectionChangedEvent=function(){this._bindingEventDisabled=!1},e.prototype.getAllQueries=function(){return this._queries.get()},e.prototype.getQueryById=function(e){var t=this._queries.get().filter(function(t){return t.id.get()===e});return t.length>=1?(t.length>1&&this.app.trace.warning("multiple queries with the same id "+e+" found. Returning the first result"),t[0]):null},e.prototype.getQueryByName=function(e){var t=this._queries.get().filter(function(t){return t.displayName.get()===e});return t.length>=1?(t.length>1&&this.app.trace.warning("multiple queries with the same name "+e+" found. Returning the first result"),t[0]):null},e.prototype.removeQueryById=function(e){var t=this._queries.get().filter(function(t){return t.id.get()===e});return t.length>=1?(t.length>1&&this.app.trace.warning("multiple queries with the same id "+e+" found. Removing the first result"),this._queries.removeItem(t[0]),this._save().then(function(){return t[0]})):null},e.prototype.updateQueryById=function(e,t){var r=this.getQueryById(e);if(null==r){var i=new Error;throw i.adminDefined=!1,i.code=s.ERRCODES.UPDATEQUERYERROR,i}var a=this._queries.indexOf(r);return this._queries.removeItem(r),t.id.set(e),this._queries.insertItem(a,t),this._save().then(function(){return t})},e.prototype.addQuery=function(e){var t=this._queries.get().filter(function(t){return!(!e.displayName.get()||!t.displayName.get())&&t.displayName.get()===e.displayName.get()});if(t.length>=1){var r=new Error("Cannot add duplicate query to collection");throw r.code=s.ERRCODES.DUPLICATE,r.queryName=e.displayName.get(),r}return this._queries.addItem(e),this._save(0).then(function(){return e})},e.prototype.getQueriesByLayer=function(e){return this._queries.get().filter(function(t){return t.layer.get().uniqueId===e.uniqueId})},e.prototype.removeQueriesByLayer=function(e){var t=this,r=this.getQueriesByLayer(e);return r.forEach(function(e){return t._queries.removeItem(e)}),this._save().then(function(){return r})},e.prototype.clear=function(){return this._queries.clear(),this._save()},e.prototype.length=function(){return this._queries.length()},e}();t.QueryCollection=d})},"Mapping/modules/QueryBuilder/QueryErrorHandling":function(){define(["require","exports"],function(e,t){"use strict";function r(e,t){var r=t;if(void 0!==r.displayStatus&&null!==r.displayStatus&&typeof r.displayStatus==typeof!0||(r.displayStatus=!0),!r.handled){switch(r.handled=!0,r.code){case i.LAYERMISSINGERROR:var a=t;this.app.trace.error("Could not load "+(e?"filter":"query")+" because layer "+a.layerName+" is missing. The list of layers follows in debug mode if it has been retrieved.",t);var n="";a.allLayers&&a.allLayers.forEach(function(e){n+=e.name+" \n"}),this.app.trace.debug(n),r.displayStatus&&this.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(this.app.getResource(this.libraryId,"language-querybuilder-error-data-source-missing").format(e?"filter":"query",a.queryState.displayName,a.layerName),{error:!0});break;case i.LAYERFIELDERROR:var s,o=t;o.missingFieldName?(this.app.trace.error("Could not restore queryClause with id "+o.queryClause.id.get()+": The field "+o.missingFieldName+" is missing.\n                    The full list of fields follows the queryClause has follows: \n"+o.allFields.map(function(e){return e.name}),t),s=this.app.getResource(this.libraryId,"language-querybuilder-error-field-missing").format(e?"filter":"query",o.missingFieldName)):(this.app.trace.error("Could not restore a queryClause for an unknown reason.",t),s=this.app.getResource(this.libraryId,"language-querybuilder-error-restore-clause-unknown")),r.displayStatus&&this.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(s,{error:!0});case i.NOTFOUND:var l=r;this.app.trace.error("Could not find "+(e?"filter":"query")+" with id "+l.id+" and name "+l.queryName);var u=this.app.getResource(this.libraryId,"language-querybuilder-error-not-found").format(e?"filter":"query");l.queryName&&(u+=" with name "+l.queryName),r.displayStatus&&this.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(u,{error:!0});break;case i.DUPLICATE:var d=r;this.app.trace.error("Could not add "+(e?"filter":"query")+" with duplicate name "+d.queryName),r.displayStatus&&this.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(this.app.getResource(this.libraryId,"language-querybuilder-error-saving-duplicate").format(e?"filter":"query",d.queryName),{error:!0});break;case i.SAVINGERROR:var p=r;this.app.trace.error("Error saving "+(e?"filter":"query")+" with name "+p.queryName),r.displayStatus&&this.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(this.app.getResource(this.libraryId,"language-querybuilder-error-saving").format(e?"filter":"query",p.queryName),{error:!0});break;case i.ADDQUERYCLAUSEERROR:var c=r;this.app.trace.error("Error adding "+c.clauses.length+" "+(e?"filter":"query")+" clauses\n                Following is the clause information in debug logging mode"),this.app.trace.debug(c.clauses.map(function(e){return e.exportState().toString()})),r.displayStatus&&this.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(this.app.getResource(this.libraryId,"language-querybuilder-error-add-query-clause").format(e?"filter":"query",c.clauses.length),{error:!0});break;case i.NONAMEGIVENERROR:this.app.trace.error("A name must be provided to rename a query"),r.displayStatus&&this.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(this.app.getResource(this.libraryId,"language-querybuilder-error-no-name").format(e?"filter":"query"),{error:!0});break;case i.RETRIEVECOLLECTIONERROR:this.app.trace.error("Could not retrieve queries for list of saved "+(e?"filters":"queries")),r.displayStatus&&this.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(this.app.getResource(this.libraryId,"language-querybuilder-error-retrieve-queries").format(e?"filter":"query"),{error:!0});break;case i.UPDATEQUERYERROR:var y,h=r;y=h.adminDefined?this.app.getResource(this.libraryId,"language-querybuilder-error-update-query-admin"):this.app.getResource(this.libraryId,"language-querybuilder-error-update-query-unknown"),this.app.trace.error("Could not update saved "+(e?"filter":"query")),r.displayStatus&&this.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(y.format(e?"filter":"query"),{error:!0});break;default:this.app.trace.error((e?"Filter":"Query")+" Builder: An unknown error occured.",t),r.displayStatus&&this.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(this.app.getResource(this.libraryId,"language-querybuilder-savedqueries-error-message").format(e?"filter":"query"),{error:!0})}this.app.debugMode&&console.error(t.stack)}}var i;!function(e){e[e.NOTFOUND=0]="NOTFOUND",e[e.DUPLICATE=1]="DUPLICATE",e[e.LAYERMISSINGERROR=2]="LAYERMISSINGERROR",e[e.LAYERFIELDERROR=3]="LAYERFIELDERROR",e[e.SAVINGERROR=4]="SAVINGERROR",e[e.EXECUTIONFAILURE=5]="EXECUTIONFAILURE",e[e.ADDQUERYCLAUSEERROR=6]="ADDQUERYCLAUSEERROR",e[e.NONAMEGIVENERROR=7]="NONAMEGIVENERROR",e[e.RETRIEVECOLLECTIONERROR=8]="RETRIEVECOLLECTIONERROR",e[e.UPDATEQUERYERROR=9]="UPDATEQUERYERROR"}(i=t.ERRCODES||(t.ERRCODES={})),t.handleQueryErrors=r})},"Mapping/modules/QueryBuilder/QueryOperator":function(){define(["require","exports"],function(e,t){"use strict";var r;!function(e){e[e.Equals=0]="Equals",e[e.NotEquals=1]="NotEquals",e[e.GreaterThan=2]="GreaterThan",e[e.GreaterThanEquals=3]="GreaterThanEquals",e[e.LessThan=4]="LessThan",e[e.LessThanEquals=5]="LessThanEquals",e[e.Contains=6]="Contains",e[e.DoesNotContain=7]="DoesNotContain",e[e.StartsWith=8]="StartsWith",e[e.EndsWith=9]="EndsWith",e[e.IsNull=10]="IsNull",e[e.IsNotNull=11]="IsNotNull"}(r=t.QueryOperator||(t.QueryOperator={})),t.Conjunctions={and:"and",or:"or"}})},"Mapping/modules/QueryBuilder/QueryOperatorDescription":function(){define(["require","exports","./QueryOperator"],function(e,t,r){"use strict";var i=function(){function e(e,t){this.value=e,this.name=t}return e.FromQueryOperator=function(t){for(var r in e)if(e[r].value==t)return e[r];return null},e.initializeStaticValues=function(t,i){this.Equals=new e(r.QueryOperator.Equals,t.getResource(i,"language-querybuilder-operator-equals")),this.NotEquals=new e(r.QueryOperator.NotEquals,t.getResource(i,"language-querybuilder-operator-not-equals")),this.GreaterThan=new e(r.QueryOperator.GreaterThan,t.getResource(i,"language-querybuilder-operator-greater-than")),this.GreaterThanEquals=new e(r.QueryOperator.GreaterThanEquals,t.getResource(i,"language-querybuilder-operator-greater-than-equal-to")),this.LessThan=new e(r.QueryOperator.LessThan,t.getResource(i,"language-querybuilder-operator-less-than")),this.LessThanEquals=new e(r.QueryOperator.LessThanEquals,t.getResource(i,"language-querybuilder-operator-less-than-equal-to")),this.Contains=new e(r.QueryOperator.Contains,t.getResource(i,"language-querybuilder-operator-contains")),this.DoesNotContain=new e(r.QueryOperator.DoesNotContain,t.getResource(i,"language-querybuilder-operator-does-not-contain")),this.StartsWith=new e(r.QueryOperator.StartsWith,t.getResource(i,"language-querybuilder-operator-starts-with")),this.EndsWith=new e(r.QueryOperator.EndsWith,t.getResource(i,"language-querybuilder-operator-ends-with")),this.IsNull=new e(r.QueryOperator.IsNull,t.getResource(i,"language-querybuilder-operator-null")),this.IsNotNull=new e(r.QueryOperator.IsNotNull,t.getResource(i,"language-querybuilder-operator-not-null"))},e}();t.QueryOperatorDescription=i})},"Mapping/modules/QueryBuilder/SimpleQueryBuilderView":function(){define(["require","exports","geocortex/framework/ui/ViewBase","geocortex/framework-ui/ViewContainer/ViewContainerView","geocortex/forms/items/TimePickerFormItem","./AutoCompleteView","geocortex/framework/resourceManager","./Formatters","geocortex/framework/observables"],function(e,t,r,i,a,n,s,o,l){"use strict";var u="QueryBuilderActions",d="FilterBuilderActions",p=function(e){function t(t,r){var i=e.call(this,t,r)||this;return i._isFilterBuilder=new l.Observable((!1)),i._initialized=!1,i._activatingView=!1,i._observableTokenDictionary={},i}return __extends(t,e),t.prototype.attach=function(t){var r=this;this._isFilterBuilder.set("filter"===this.configuration.mode),e.prototype.attach.call(this,t),this._isFilterBuilder.sync(t.isFilterBuilder),this.viewModel.initializeFromViewConfig(this.configuration),this.attachQuery(),this.app.event("_deattachingQuery").subscribe(this,function(){r.deattachQuery()}),this.app.event("_newQueryAttached").subscribe(this,function(){r.attachQuery()}),this.app.event("_logicalOperatorChanged").subscribe(this,this.handleLogicalOperatorChanged),this._observableTokenDictionary.displayedQueryIsSaved=this.viewModel.displayedQueryIsSaved.bind(this,function(e){var t=r._getQueryTitle(r.viewModel.displayedQuery.get().displayName.get(),r.viewModel.displayedQueryIsSaved.get());t=r._getModifiedStatusTitle(t,r.viewModel.displayedQuery.get().isModified.get(),r.viewModel.displayedQueryIsSaved.get()),
r.title.set(t)}),this._initialized||(dojo.connect(this.viewModel,"event_queryClausesRemoving",this,this.viewModel_queryClausesRemoving),this.bindAutoCompleteEvents(),this._initialized=!0),this._registerCommandsAndEvents()},t.prototype.deattachQuery=function(){this.viewModel.displayedQuery.get()&&(this._observableTokenDictionary.isModifed&&this.viewModel.displayedQuery.get().isModified.unbind(this._observableTokenDictionary.isModifed),this._observableTokenDictionary.displayName&&this.viewModel.displayedQuery.get().displayName.unbind(this._observableTokenDictionary.displayName))},t.prototype.attachQuery=function(){var e=this;this.viewModel.displayedQuery.get()&&(this._observableTokenDictionary.isModified=this.viewModel.displayedQuery.get().isModified.bind(this,function(t){e.title.set(e._getModifiedStatusTitle(e.title.get(),t,e.viewModel.displayedQueryIsSaved.get()))}),this._observableTokenDictionary.displayName=this.viewModel.displayedQuery.get().displayName.bind(this,function(t){var r=e._getQueryTitle(t,e.viewModel.displayedQueryIsSaved.get());r=e._getModifiedStatusTitle(r,e.viewModel.displayedQuery.get().isModified.get(),e.viewModel.displayedQueryIsSaved.get()),e.title.set(r)}))},t.prototype.deactivated=function(){this._isFilterBuilder.get()?this.app.command("RemoveFilterStatus").execute():this.app.command("RemoveQueryStatus").execute()},t.prototype._getQueryTitle=function(e,t){var r;if(e&&e.length>0)if(t){var i="Saved ",a=this.app.getResource(this.libraryId,this.viewModel.isFilterBuilder.get()?"language-querybuilder-simple-filter-title":"language-querybuilder-simple-title"),n=": "+e;r=i.concat(a,n)}else r=this.app.getResource(this.libraryId,this.viewModel.isFilterBuilder.get()?"language-querybuilder-simple-filter-title":"language-querybuilder-simple-title");else r=this.app.getResource(this.libraryId,this.viewModel.isFilterBuilder.get()?"language-querybuilder-simple-filter-title":"language-querybuilder-simple-title");return r},t.prototype._getModifiedStatusTitle=function(e,t,r){var i=" *";if(t&&r){if(!e.endsWith(i))return e.concat(i)}else if(e.endsWith(i))return e.slice(0,-1*i.length);return e},t.prototype._registerCommandsAndEvents=function(){var e=this;this.app.command(this.viewModel.isFilterBuilder.get()?"DisplayFilter":"DisplayQuery").register(this,this._executeDisplayQuery);var t,r=this.app.viewManager.getRegionForViewId(this.id);if(r){var a=r.ownerView;a instanceof i.ViewContainerView&&(t=a)}this.app.event("ViewContainerViewClosedEvent").subscribe(this,function(t){t&&t.viewId===e.id&&e.viewModel.clearAllQueries()}),t?this.app.event("ViewContainerDeactivatedEvent").subscribe(this,function(r){r.id===t.id&&e.app.command(e.viewModel.isFilterBuilder.get()?"RemoveFilterStatus":"RemoveQueryStatus").execute()}):this.app.trace.warning((this.viewModel.isFilterBuilder.get()?"Filter":"Query")+" Builder could\n                                    not find enclosing container for view: "+this.id+".\n\n                                    Status messages will NOT be dismissed when this ViewContainer is deactivated."),this.app.event("ViewActivatedEvent").subscribe(this,function(t){if(!e._activatingView){if(e._activatingView=!0,t.id===(e._isFilterBuilder.get()?"SimpleFilterBuilderContainerView":"SimpleQueryBuilderContainerView")){var r=t.childRegions.filter(function(t){return t.name===(e._isFilterBuilder.get()?"SimpleFilterBuilderContainerRegion":"SimpleQueryBuilderContainerRegion")});if(1===r.length){var i=r[0];0===i.activeViews.length&&e.app.viewManager.activateView(e)}else e.app.trace.error("Could not find region containing views for the \n                                                "+(e._isFilterBuilder.get()?"filter":"query")+" builder. No view may be \n                                                hosted in the panel. Please reopen the "+(e._isFilterBuilder.get()?"filter":"query")+" \n                                                tool.")}e._activatingView=!1}})},t.prototype._executeDisplayQuery=function(e,t){var r=this;this.viewModel.queryExists(e.id.get()).then(function(t){return r.viewModel.displayedQueryIsSaved.set(t),r.viewModel.applyDisplayedQueryState(e.exportState())}).then(function(e){r.viewModel.selectedLayerUniqueId.set(r.viewModel.displayedQuery.get().layerId.get()),r.viewModel.displayedQuery.get().isModified.set(!1),r.app.viewManager.activateView(r),!!t&&t()})["catch"](function(t){r.app.trace.error("Could not display the given query with id "+e.id.get()+" and name "+e.displayName.get()+" as it could not be loaded")})},t.prototype.form_keydown=function(e){var t=(new Date).getTime()-(this._lastAutoCompleteTime?this._lastAutoCompleteTime.getTime():0);if(t>50&&13==e.keyCode){var r=$(e.target);if(r.prop("tagName").search(/^input$/i)>=0&&r.prop("type").search(/^text$/i)>=0)return this.performAction(),!1}return!0},t.prototype.form_submit=function(){return!1},t.prototype.bindAutoCompleteEvents=function(){var e=this;$(this.htmlForm).on("autocompleteselect","input.ui-autocomplete-input",function(t){e._lastAutoCompleteTime=new Date})},t.prototype.handleRadioClick=function(e,t,r){"or"===t.value?r.selectedLogicalOperator.set("or"):r.selectedLogicalOperator.set("and")},t.prototype.handleLogicalOperatorChanged=function(e,t){"or"===t?$("[name=radioButtonGroup"+e.get()+"][value=or]").prop("checked",!0):$("[name=radioButtonGroup"+e.get()+"][value=and]").prop("checked",!0)},t.prototype.addQueryClause_click=function(e,t,r){this.viewModel.addQueryClause(r).then(function(){$(".query-clause-row").last().find("input, select").first().focus()})},t.prototype.addNestedQuery_click=function(e,t,r){this.viewModel.addNestedQuery(r)},t.prototype.removeQueryClause_click=function(e,t,r){null===r.parentQuery.parentQuery||void 0===r.parentQuery.parentQuery?r.parentQuery.queryClauses.length()>1&&this.viewModel.removeQueryClause(r):r.parentQuery.queryClauses.length()>1?this.viewModel.removeQueryClause(r):this.viewModel.removeNestedQuery(r.parentQuery)},t.prototype.actionButton_click=function(){this.performAction()},t.prototype.clearFilterButton_click=function(){this.viewModel.disabled.set(!1),this.viewModel.displayedQuery.get().layer.get().setDefinitionExpression(null)},t.prototype.clearResultsButton_click=function(){this.event_clearResultsButtonClicked()},t.prototype.cancelButton_click=function(){this.app.viewManager.deactivateView(this),this.viewModel.clearAllQueries()},t.prototype.externalfilterButton_click=function(){this.viewModel.displayedQuery.get().layer.get().setDefinitionExpression("1 = 2")},t.prototype.event_clearResultsButtonClicked=function(){},t.prototype.addLayerButton_click=function(){this._addedLayer||(this._addedLayer=new esri.layers.ArcGISDynamicMapServiceLayer("http://agsdemos2.geocortex.com/arcgis/rest/services/BeaverCounty/BeaverCounty_Wells/MapServer"),this.app.map.addLayer(this._addedLayer))},t.prototype.removeLayerButton_click=function(){this._addedLayer&&(this.app.map.removeLayer(this._addedLayer),this._addedLayer=null)},t.prototype.performAction=function(){this.viewModel.isQueryBuilder.get()?this.viewModel.executeQuery(this.viewModel.displayedQuery.get()):(this.viewModel.executeFilter(this.viewModel.displayedQuery.get()),this.app.event("FilterBuilderLayerDefinitionAppliedEvent").publish({gcxlayer:this.viewModel.displayedQuery.get().layer.get().gcxLayer}))},t.prototype.resolveWidget=function(t,r,i){if(e.prototype.resolveWidget.call(this,t,r),!t)return null;switch(t){case"QueryActionsWidget":return this.app.menuRegistry.createMenuWidget(this,r,i,this.libraryId,this._isFilterBuilder.get()?d:u);case"DatePicker":var l=o.QueryFormatterFactory.getFormatter(this.viewModel.displayedQuery.get().layer.get());r.datePickerFormItem.includeTimePicker.set(l.supportsTimeOfDay());var p=new a.TimePickerFormItem(null);r.datePickerFormItem.timePickerItem=p;var c=this.app.viewManager.createView({markupResource:"Mapping/infrastructure/ui/components/Forms/DatePickerFormItemView.html",libraryId:"Mapping.Infrastructure",typeName:"geocortex.essentialsHtmlViewer.mapping.infrastructure.ui.components.Forms.DatePickerFormItemView",isVisible:!0});return c.attach(r.datePickerFormItem),r.datePickerView=c,c;case"AutoComplete":var y=new n.AutoCompleteView(this.app),h=document.createElement("span");return dojo.html.set(h,s.resourceManager.fetch("Mapping/modules/QueryBuilder/AutoCompleteView.html",this.libraryId)),y.root=h,r.autoCompleteViewModel.appendTo="."+this.id+" .autocomplete-container",y.attach(r.autoCompleteViewModel),r.autoCompleteView=y,y;default:return null}},t.prototype.viewModel_queryClausesRemoving=function(e){for(var t=0;t<e.length;t++)e[t].datePickerView&&$(e[t].datePickerView.root).find("input, button, select").off();for(var t=0;t<e.length;t++)e[t].autoCompleteView&&$(e[t].autoCompleteView.root).find("input").off()},t}(r.ViewBase);t.SimpleQueryBuilderView=p})},"Mapping/modules/QueryBuilder/SimpleQueryBuilderViewModel":function(){define(["require","exports","geocortex/infrastructure/FeatureSetCollection","geocortex/infrastructure/FeatureSet","geocortex/framework/ui/ViewModelBase","geocortex/framework-ui/FilterableCollection","geocortex/framework/observables","./QueryClause","./QueryOperator","./Formatters","geocortex/infrastructure/gis/AppInfo","./QueryOperatorDescription","./Query","geocortex/infrastructure/ArrayUtils","geocortex/infrastructure/TaskUtils","geocortex/infrastructure/gis/ServiceLayerInfo","geocortex/infrastructure/GeometryUtils","./QueryCollection","./QueryErrorHandling","./QueryBuilderModule","geocortex/infrastructure/PromiseUtils"],function(e,t,r,i,a,n,s,o,l,u,d,p,c,y,h,g,m,f,v,b,Q){"use strict";var w=function(e){function t(t,r){var i=e.call(this,t,r)||this;i.layers=new n.FilterableCollection,i.tables=new n.FilterableCollection,i.selectedLayerUniqueId=new s.Observable,i.infoText=new s.Observable,i.spatialFilters=new s.ObservableCollection,i.selectedSpatialFilter=new s.Observable(b.SpatialFilterOptions.None),i.selectedSpatialFilterName=new s.Observable,i.defaultLogicalOperator=new s.Observable(l.Conjunctions.and),i.displayedQuery=new s.Observable,i.isAwab=new s.Observable((!1)),i.isGvh=new s.Observable((!1)),i.isQueryAndAwab=new s.Observable((!1)),i.isDebug=new s.Observable((!1)),i.isQueryBuilder=new s.Observable((!0)),i.isFilterBuilder=new s.Observable((!1)),i.areQueryableTables=new s.Observable((!1)),i.areQueryableLayers=new s.Observable((!1)),i.showLayerError=new s.Observable((!1)),i.disabled=new s.Observable((!1)),i.nestingLevelTooDeep=new s.Observable((!1)),i.selectedLayerIsTable=new s.Observable((!1)),i.filterAlreadyApplied=new s.Observable((!1)),i.notDisabled=new s.Observable((!0)),i.noAvailableLayers=new s.Observable((!1)),i.noAvailableLayersText=new s.Observable(""),i.displayedQueryIsSaved=new s.Observable((!1)),i.config={},i._allLayers=new s.ObservableCollection,i._allTables=new s.ObservableCollection,i._isRestoringQueryStatePromise=Promise.resolve(null),i._isRestoringStatePromise=Promise.resolve(null),i._initializingPromise=null,i._subTokenDictionary={},i._gcxTokenDictionary={},i._mapTokenDictionary={},i._observableTokenDictionary={},i._graphicsLayerSubscriptions=new Array,i.isGvh.syncTransform(i.isAwab,function(e){return!e}),i.notDisabled.syncTransform(i.disabled,function(e){return!e});var a=new c.Query(t,r,{layer:null,layerIsTable:!1,logicalOperator:null});return i.attachQuery(a),i.volatileQueries=new f.QueryCollection(t,r,{persistent:!1}),i.volatileQueries.isFilterCollection=i.isFilterBuilder.get(),i}return __extends(t,e),t.prototype.attachQuery=function(e){var t,r=this;this.displayedQuery.get()&&(this._observableTokenDictionary.hasOwnProperty("spatialFilter")&&this.selectedSpatialFilter.unbind(this._observableTokenDictionary.spatialFilter),this._observableTokenDictionary.hasOwnProperty("layerId")&&this.selectedLayerUniqueId.unbind(this._observableTokenDictionary.layerId),this._observableTokenDictionary.hasOwnProperty("saveQueryCanExecute")&&this.displayedQuery.get().isModified.unbind(this._observableTokenDictionary.saveQueryCanExecute),this.displayedQuery.get().selectedSpatialFilter.removeSync(),this.displayedQuery.get().selectedSpatialFilterName.removeSync(),this.displayedQuery.get().defaultLogicalOperator.removeSync(),this.displayedQuery.get().removeErrorHandler(),t=this.displayedQuery.get().numSuggestions),this.app.event("_deattachingQuery").publish(),this.displayedQuery.set(e),this.displayedQuery.get().selectedLogicalOperator.pulse(),this.displayedQuery.get().setErrorHandler(this,this.isFilterBuilder.get(),v.handleQueryErrors),this._observableTokenDictionary.spatialFilter=this.selectedSpatialFilter.bind(this,function(e){r.displayedQuery.get().isModified.set(!0),"string"==typeof e&&(e=parseInt(e));for(var t=0;t<r.spatialFilters.length();t++)r.spatialFilters.getAt(t).val===e&&r.selectedSpatialFilterName.set(r.spatialFilters.getAt(t).name)}),this._observableTokenDictionary.saveQueryCanExecute=this.displayedQuery.get().isModified.bind(this,function(){r.app.command(r.isFilterBuilder.get()?"ShowSaveFilterDialog":"ShowSaveQueryDialog").raiseCanExecuteChanged()}),this._observableTokenDictionary.layerId=this.selectedLayerUniqueId.bind(this,function(){r.layerIdChanged().then(function(){null!==r.displayedQuery.get().layer.get()&&r.displayedQuery.get().buildWhereClause()})}),this.displayedQuery.get().selectedSpatialFilter.sync(this.selectedSpatialFilter),this.displayedQuery.get().selectedSpatialFilterName.sync(this.selectedSpatialFilterName),this.displayedQuery.get().defaultLogicalOperator.sync(this.defaultLogicalOperator),this.displayedQuery.get().numSuggestions=t,this.app.event("_newQueryAttached").publish()},t.prototype.initialize=function(e){var t=this;e&&(this.config=e),this._initializingPromise||(this._initializingPromise=this.app.waitUntilSiteServiceLayersLoaded().then(function(){var e=d.AppInfo.fromGeocortexApp(t.app);t.initializeQueryBuilder(e),t.registerCommandsAndEvents()}))},t.prototype.initializeFromViewConfig=function(e){e&&(this.config=e),this.queryFormatterFactory=new u.QueryFormatterFactory(this.config),this.isDebug.set(this.app.debugMode),this.isAwab.set(this.app.isArcGisWebApp),p.QueryOperatorDescription.initializeStaticValues(this.app,this.libraryId);var t="filter"!=this.config.mode;if(this.isQueryBuilder.set(t),this.isFilterBuilder.set(!t),this.isQueryAndAwab.set(this.isAwab.get()&&t),this.displayedQuery.get().setErrorHandler(this,this.isFilterBuilder.get(),v.handleQueryErrors),t?this.noAvailableLayersText.set(this.app.getResource(this.libraryId,"language-querybuilder-no-valid-query-layers")):this.noAvailableLayersText.set(this.app.getResource(this.libraryId,"language-querybuilder-no-valid-filter-layers")),e.hasOwnProperty("defaultLogicalOperator")&&null!=e.defaultLogicalOperator&&"string"==typeof e.defaultLogicalOperator){var r=e.defaultLogicalOperator.toLowerCase();void 0===l.Conjunctions[r]||null===l.Conjunctions[r]?(this.displayedQuery.get().selectedLogicalOperator.set(this.defaultLogicalOperator.get()),this.app.trace.warning('Invalid default conjunction "'+r+'" given. Using '+this.defaultLogicalOperator.get()+" as the default")):(this.defaultLogicalOperator.set(l.Conjunctions[r]),this.displayedQuery.get().selectedLogicalOperator.set(l.Conjunctions[r]))}if(e.hasOwnProperty("numberOfSuggestions")&&null!=e.numberOfSuggestions){var r=e.numberOfSuggestions;"number"!=typeof r||r<0?(this.displayedQuery.get().numSuggestions=10,this.app.trace.warning('Invalid number of suggestions "'+r+'" given. Using '+this.displayedQuery.get().numSuggestions+" as the default")):this.displayedQuery.get().numSuggestions=r}},t.prototype.initializeQueryBuilder=function(e){this._appInfo=e,this._allLayers.clear();var t=e.mapInfo.getLayerInfos().filter(function(e){return e.queryable&&!!e.displayName&&!!e.url});t=y.ArrayUtils.sortBy(t,function(e){return e.displayName}),this._allLayers.set(t);var r=e.mapInfo.getTableInfos().filter(function(e){return e.queryable&&!!e.displayName&&!!e.url});this._allTables.set(r),this._checkUseableLayers(),this.layers.setSource(this._allLayers),this.tables.setSource(this._allTables),this.layers.setFilter(function(e){return e&&(!e.gcxLayer||e.gcxLayer.inActiveTheme)}),this.layers.length()>0&&this.layers.getAt(0)?this.selectedLayerUniqueId.set(this.layers.getAt(0).uniqueId):this.tables.length()>0&&this.tables.getAt(0)?this.selectedLayerUniqueId.set(this.tables.getAt(0).uniqueId):0===this.layers.length()&&0===this.tables.length()&&this.noAvailableLayers.set(!0),this._handleNewServiceLayers(e.mapInfo.serviceLayers),this.refreshSpatialFilterOptions(),this.displayedQuery.get().isModified.set(!1)},t.prototype.registerCommandsAndEvents=function(){var e=this;this.isQueryBuilder.get()&&this.app.command("RunQuery").register(this,this.executeQuery),this.isQueryBuilder.get()&&this.app.command("RunFilter").register(this,this.executeFilter),this.app.command(this.isFilterBuilder.get()?"ShowSaveFilterDialog":"ShowSaveQueryDialog"),this.app.command(this.isFilterBuilder.get()?"ShowSaveFilterDialog":"ShowSaveQueryDialog").canExecute=function(){return!(!e.displayedQueryIsSaved.get()||e.displayedQuery.get().adminDefined)&&e.displayedQuery.get().isModified.get()},this.app.command(this.isFilterBuilder.get()?"ShowSaveFilterDialog":"ShowSaveQueryDialog").raiseCanExecuteChanged(),this.app.command(this.isFilterBuilder.get()?"_ExportFilterBuilderState":"_ExportQueryBuilderState").register(this,function(t,r,i){e.exportState(t),r(t)}),this.app.command(this.isFilterBuilder.get()?"_ApplyFilterBuilderState":"_ApplyQueryBuilderState").register(this,function(t){t.completePromises.push(e.applyState(t.state))}),this.app.event(this.isFilterBuilder.get()?"SavedFiltersChangedEvent":"SavedQueriesChangedEvent").subscribe(this,function(t){if(void 0===t||0!==t){var r=e._isRestoringStatePromise.then(function(){return e.getCopyOfSavedQuery(e.displayedQuery.get().id.get())}).then(function(t){t?e.applyDisplayedQueryState(t.exportState()).then(function(){e.displayedQueryIsSaved.set(!0)}):e.displayedQueryIsSaved.set(!1)}),i=Q.PromiseUtils.mapSkipRejected(e.volatileQueries.getAllQueries(),function(t){return e.getCopyOfSavedQuery(t.id.get()).then(function(r){return r?e.volatileQueries.updateQueryById(t.id.get(),r):void 0})["catch"](function(e){throw e.displayStatus=!1,e})},{concurrency:1/0},!0);return Q.PromiseUtils.allSkipRejected([r,i],!0)}}),this._appInfo.mapInfo.markupLayer.bind(this,this.markupLayerChanged),this.markupLayerChanged(this._appInfo.mapInfo.markupLayer.get());var t="layer-add";this._mapTokenDictionary[t]||(this._mapTokenDictionary[t]=this._appInfo.map.on(t,function(t){e.layerAdded(t)}));var r="layer-remove";this._mapTokenDictionary[r]||(this._mapTokenDictionary[r]=this._appInfo.map.on(r,function(t){e.layerRemoved(t)}));var i="MapServiceLayersChangedEvent";this._gcxTokenDictionary[i]||(this._gcxTokenDictionary[i]=this.app.event("MapServiceLayersChangedEvent").subscribe(this,function(t){t&&t.serviceLayer&&(e.layerRemoved({layer:t.serviceLayer}),e.layerAdded({layer:t.serviceLayer}))}));var a="LayerThemeChangedEvent";this._gcxTokenDictionary[a]||(this._gcxTokenDictionary[a]=this.app.event(a).subscribe(this,function(t){e.layers.refresh();var r=0===e.layers.length();e.noAvailableLayers.set(r),e.layers.indexOf(e.displayedQuery.get().layer.get())<0?e.selectedLayerUniqueId.set(e.layers.length()?e.layers.getAt(0).uniqueId:null):e.selectedLayerUniqueId.pulse()}))},t.prototype.getCopyOfSavedQuery=function(e){var t=this;return new Promise(function(r,i){t.app.command(t.isFilterBuilder.get()?"_getSavedFilterById":"_getSavedQueryById").execute(e,function(e){e.getNewInstance().then(function(e){return r(e)})},function(e){return r(null)})})},t.prototype.queryExists=function(e){var t=this;return new Promise(function(r,i){t.app.command(t.isFilterBuilder.get()?"_getSavedFilterById":"_getSavedQueryById").execute(e,function(e){return r(!0)},function(e){return r(!1)})})},t.prototype.executeQuery=function(e){var t=this,r=e.isModified.get();this.refreshQueryGeometry(e).then(function(a){e.isModified.set(r);var n=t.getFsc(t.app.featureSetManager);n.clear(),t.app.featureSetManager.openCollection(n.id);var s=e.execute(t.app.map.spatialReference,t.app.event("QueryCompletedEvent"));s.then(function(r){var a=new esri.tasks.FeatureSet(r),s=new i.FeatureSet({esriFeatureSet:a,layer:e.layer.get().gcxLayer,app:t.app});s.displayName.set(t.app.getResource(t.libraryId,"language-querybuilder-feature-set-display-name").format(e.layer.get().displayName)),n.featureSets.addItem(s),s.resolveDataLinks(function(e){t.app.event("FeatureChangedEvent").publish(e)}),t.app.featureSetManager.closeCollection(n.id),t.app.command("AddResultsStatus").execute(t.app.getResource(t.libraryId,"language-querybuilder-notification-run-query").format(e.displayName.get()||"Query",e.layer.get().displayName))},function(e){t.app.trace.error(e),t.app.featureSetManager.closeCollection(n.id)})})},t.prototype.executeFilter=function(e){var t=this,r=e.isModified.get();this.getGeometryFilter(e.selectedSpatialFilter.get()).then(function(i){e.isModified.set(r),null!==i?t.buildSpatiallyFilteredWhereClause(e,i).then(function(r){t.app.trace.debug("Executing filter with query.buildWhereClause() clause: "+e.buildWhereClause()),t.app.trace.debug("Filter restricted by the following spatial filter: "+r),e.layer.get().setDefinitionExpression(r)}):(e.layer.get().setDefinitionExpression(e.buildWhereClause()),t.app.command("ShowMap").execute()),t.app.command("DisplayFilter").execute(e,function(){t.app.command("AddFilterStatus").execute(t.app.getResource(t.libraryId,"language-querybuilder-notification-run-filter").format(e.displayName.get()||"Filter",e.layer.get().displayName))})})},t.prototype.addNestedQuery=function(e){var t=this,r=new c.Query(this.app,this.libraryId,{layer:e.layer.get(),layerIsTable:e.layerIsTable.get(),logicalOperator:this.defaultLogicalOperator.get()}),i=[];return i.push(new o.QueryClause(this.app,this.libraryId,r),new o.QueryClause(this.app,this.libraryId,r)),r.refreshFields().then(function(){return r.addQueryClauses(i)}).then(function(){return Promise.resolve(e.addChildren([r])[0])}).then(function(e){return e.selectedLogicalOperator.pulse(),Promise.resolve(e)})["catch"](function(r){return t.displayedQuery.get().id.get()===e.id.get()&&t.displayedQueryIsSaved.get()?r.displayStatus=!0:r.displayStatus=!1,Promise.reject(r)})},t.prototype.removeNestedQuery=function(e){this._removeNestedQueryRecursive(e,this.displayedQuery.get())},t.prototype._removeNestedQueryRecursive=function(e,t){if(t.children.contains(e)){var r=[];return r.push(e),t.removeChildren(r),!0}for(var i=0;i<t.children.length();i++){var a=this._removeNestedQueryRecursive(e,t.children.getAt(i));if(a)return!0}return!1},t.prototype.getFsc=function(e){if(this._fsc)return this._fsc;var t=new r.FeatureSetCollection;return e.addCollection(t),t.displayName.set(this.app.getResource(this.libraryId,"language-querybuilder-feature-set-collection-display-name")),t.sourceName="QueryBuilder",this._fsc=t,t},t.prototype.refreshSpatialFilterOptions=function(){if(this.displayedQuery.get().isModified.set(!1),0==this.spatialFilters.length()&&(this.spatialFilters.addItem({name:this.getResource("language-querybuilder-spatial-filter-all"),val:b.SpatialFilterOptions.None}),this.spatialFilters.addItem({name:this.getResource("language-querybuilder-spatial-filter-current-extent"),val:b.SpatialFilterOptions.CurrentExtent}),this.selectedSpatialFilter.set(b.SpatialFilterOptions.None)),void 0==this.config.allowDrawingsAsSpatialFilter&&(this.config.allowDrawingsAsSpatialFilter=!0),this.config.allowDrawingsAsSpatialFilter){var e=this._appInfo.mapInfo.markupLayer.get();e&&e.graphics.length>0&&2==this.spatialFilters.length()?this.spatialFilters.addItem({name:this.getResource("language-querybuilder-spatial-filter-polygons"),val:b.SpatialFilterOptions.Drawings}):e&&0!=e.graphics.length||3!=this.spatialFilters.length()||(this.spatialFilters.removeAt(2),this.selectedSpatialFilter.get()==b.SpatialFilterOptions.Drawings&&this.selectedSpatialFilter.set(b.SpatialFilterOptions.None))}this._updateSpatialFilterOption(this.selectedSpatialFilter.get())},t.prototype._updateSpatialFilterOption=function(e){"string"==typeof e&&(e=parseInt(e));for(var t=0;t<this.spatialFilters.length();t++)this.spatialFilters.getAt(t).val===e&&(this.selectedSpatialFilter.set(e),this.selectedSpatialFilterName.set(this.spatialFilters.getAt(t).name));return this.selectedSpatialFilter.pulse(),this.app.trace.debug("Could not verify spatial filter option for query with name "+this.displayedQuery.get().displayName.get()+". Option "+e+" not available")},t.prototype.exportState=function(e){var t=this,r=[];if(this.displayedQuery.get().layer.get()){var i;if(this.displayedQuery.get().adminDefined){var a=this.displayedQuery.get().id.get();this.displayedQuery.get().refreshId(),i=this.displayedQuery.get().exportState(),this.displayedQuery.get().id.set(a),i.adminDefined=!1}else i=this.displayedQuery.get().exportState();r.push(i)}this.volatileQueries.getAllQueries().forEach(function(e){if(e.id.get()!==t.displayedQuery.get().id.get()){var i;if(e.adminDefined){var a=e.id.get();e.refreshId(),i=e.exportState(),e.id.set(a),i.adminDefined=!1}else i=e.exportState();r.push(i)}}),this.isFilterBuilder.get()?e.filters=r:e.queries=r},t.prototype.applyState=function(e){var t=this;return(!this._isRestoringStatePromise||this._isRestoringStatePromise&&this._isRestoringStatePromise.isFulfilled())&&(this._isRestoringStatePromise=Promise.resolve(null)),this._isRestoringStatePromise=this._isRestoringStatePromise.then(function(){return t.volatileQueries.clear()}).then(function(){var r=t.isFilterBuilder.get()?e.filters:e.queries;if(r&&r.length)return t._restoreQueryStates(r,e.serialVersion)}).then(function(e){return t._loadQueriesIntoModel(e)}).then(function(){return Promise.resolve()})["catch"](function(e){return Promise.reject(e)}),this._isRestoringStatePromise},t.prototype._restoreQueryStates=function(e,t){var r=this;return Q.PromiseUtils.mapSkipRejected(e,function(e){var i=new c.Query(r.app,r.libraryId,{layer:null,layerIsTable:!1,logicalOperator:l.Conjunctions.and});return i.setErrorHandler(r,r.isFilterBuilder.get(),v.handleQueryErrors),i.applyState(e,t).timeout(1e3)},{concurrency:1/0},!0)},t.prototype._loadQueriesIntoModel=function(e){var t=this;return Q.PromiseUtils.mapSkipRejected(e,function(r){if(e.length>0&&r===e[0]&&r&&r.layerId){t.selectedLayerUniqueId.set(r.layerId.get()),t.infoText.set(t.getResource("language-querybuilder-find-in-layer").format(r.layer.get().displayName));"An error occurred while loading the "+(t.isFilterBuilder?"filter":"query")+"\n                                    with name "+r.displayName.get()+" for the layer "+r.layer.get().displayName;return t.applyDisplayedQueryState(r.exportState())}return t.volatileQueries.addQuery(r)},{concurrency:1/0},!0)},t.prototype.applyDisplayedQueryState=function(e,t){var r=this;(!this._isRestoringQueryStatePromise||this._isRestoringQueryStatePromise&&this._isRestoringQueryStatePromise.isFulfilled())&&(this._isRestoringQueryStatePromise=Promise.resolve(null));var i=new c.Query(this.app,this.libraryId,{layer:null,layerIsTable:!1,logicalOperator:null});return this._isRestoringQueryStatePromise=this._isRestoringQueryStatePromise.then(function(){return r.attachQuery(i)}).then(function(){return r.displayedQuery.get().applyState(e,t)}).then(function(t){if(r.disabled.set(!1),r.nestingLevelTooDeep.set(!1),r.displayedQuery.get().children.length()>0)for(var i=0;i<r.displayedQuery.get().children.length();i++){var a=r.displayedQuery.get().children.getAt(i);a.children.length()>0&&(r.disabled.set(!0),r.nestingLevelTooDeep.set(!0))}return r._updateSpatialFilterOption(e.selectedSpatialFilter),r.displayedQuery.get().isModified.set(!1),r.layerIdChanged(),t}),this._isRestoringQueryStatePromise},t.prototype._checkUseableLayers=function(){for(var e=0;e<this._allLayers.getLength();e++){var t=this._allLayers.getAt(e);if(t&&t.gcxLayer&&h.canQueryLayer(t.gcxLayer)&&t.gcxLayer.fields.length>0&&null!=t.gcxLayer.mapService&&null!==t.gcxLayer.mapService.serviceLayer){if(!this.isFilterBuilder.get()||this._isValidFilterLayer(t.gcxLayer.mapService))continue}else if(t&&t.queryable&&t.serviceLayerInfo&&t.serviceLayerInfo.serviceLayer&&t.serviceLayerInfo.serviceLayer.url&&(!this.isFilterBuilder.get()||this._isValidFilterLayer(t.serviceLayerInfo)))continue;this._allLayers.removeAt(e),e--}var r=0===this._allLayers.getLength(),i=0===this._allTables.getLength();this.areQueryableLayers.set(!r),this.areQueryableTables.set(!i&&this.isQueryBuilder.get());var a=this.isFilterBuilder.get()&&r||this.isQueryBuilder.get()&&r&&i;this.noAvailableLayers.set(a)},t.prototype._isValidFilterLayer=function(e){if(e.serviceLayer instanceof esri.layers.FeatureLayer&&e.serviceLayer.url)return!0;if(e.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer){var t=e.serviceLayer;if(null===t.capabilities||t.capabilities.indexOf("Query")!==-1)return!0}return!1},t.prototype._handleNewServiceLayers=function(e){for(var t=this,r=0;r<e.length;r++){var i=e[r];this._removeSub(i.serviceLayer.id);var a=dojo.connect(i.serviceLayer,"setLayerDefinitions",function(e){t._layerDefinitionsSet.call(t,this,e)});a&&(t._subTokenDictionary[i.serviceLayer.id]=a)}},t.prototype._removeSub=function(e){if(this._subTokenDictionary.hasOwnProperty(e)){var t=this._subTokenDictionary[e];t&&t.remove(),delete this._subTokenDictionary[e]}},t.prototype._layerDefinitionsSet=function(e,t){for(var r=0;r<t.length;++r){var i=t[r];this.displayedQuery.get().layer.get()&&this.displayedQuery.get().layer.get().serviceLayerInfo.serviceLayer==e&&this.displayedQuery.get().layerId.get()==i+""&&this.displayedQuery.get().buildWhereClause()!=t[i]&&(this.filterAlreadyApplied.set(!0),this.disabled.set(!0))}},t.prototype.markupLayerChanged=function(e){for(var t=this,r=0;r<this._graphicsLayerSubscriptions.length;r++){var i=this._graphicsLayerSubscriptions[r];i.remove()}e&&(this._graphicsLayerSubscriptions.push(e.on("graphic-add",function(){t.refreshSpatialFilterOptions()})),this._graphicsLayerSubscriptions.push(e.on("graphic-remove",function(){t.refreshSpatialFilterOptions()})))},t.prototype.layerIdChanged=function(){var e=this;return null===this.selectedLayerUniqueId.get()||void 0===this.selectedLayerUniqueId.get()?Promise.resolve():this.displayedQuery.get().layerId.get()&&this.selectedLayerUniqueId.get()===this.displayedQuery.get().layerId.get()?Promise.resolve():this.app.project.isLoading&&this._isRestoringStatePromise.isFulfilled()?Promise.resolve():this._isRestoringStatePromise&&!this._isRestoringStatePromise.isFulfilled()?Promise.resolve():(this._isUpdatingLayerId||(this._isUpdatingLayerId=Promise.resolve()),this.app.command("ScreenReaderNarrate").execute(this.app.getResource(this.libraryId,"language-querybuilder-WCAG-data-source-changed")),this._isUpdatingLayerId=this._isUpdatingLayerId.then(function(){return e._saveCurrentQuery()}).then(function(){e.disabled.set(!1),e.event_queryClausesRemoving(e.displayedQuery.get().queryClauses.get());var t=e._findLayerOrTable(e.selectedLayerUniqueId.get());if(e.infoText.set(""),e.selectedSpatialFilter.set(b.SpatialFilterOptions.None),e.displayedQuery.get().refreshId(),t)return e.displayedQuery.get().layer.set(t),e._loadLayerQuery(t)}).then(function(){return e.queryExists(e.displayedQuery.get().id.get())}).then(function(t){e.displayedQueryIsSaved.set(t),e.displayedQuery.get().isModified.set(!1),e.infoText.set(e.getResource("language-querybuilder-find-in-layer").format(e.displayedQuery.get().layer.get().displayName)),e.isFilterBuilder.get()&&e.displayedQuery.get()&&e.displayedQuery.get().layer.get()&&e.displayedQuery.get().layer.get().getDefinitionExpression()&&(e._isEquivalentExpression(e.displayedQuery.get().buildWhereClause(),e.displayedQuery.get().layer.get().getDefinitionExpression())||e.disabled.set(!0))})["catch"](function(t){var r=t;r.handled||(r||(r=new Error),r.message+="\nPoint of Failure: Could not change LayerId",v.handleQueryErrors.call(e,e.isFilterBuilder.get(),r)),e._isUpdatingLayerId=Promise.resolve();
}),this._isUpdatingLayerId)},t.prototype._saveCurrentQuery=function(){var e=this;return this._isSavingVolatileQuery||(this._isSavingVolatileQuery=Promise.resolve()),this._isSavingVolatileQuery=this._isSavingVolatileQuery.then(function(){return!e.displayedQuery.get().layer.get()||e._isRestoringStatePromise&&!e._isRestoringStatePromise.isFulfilled()?void 0:e.volatileQueries.removeQueriesByLayer(e.displayedQuery.get().layer.get()).then(function(){return e.displayedQuery.get().getNewInstance()}).then(function(t){return e.volatileQueries.addQuery(t)})})["catch"](function(t){e.app.trace.error("Error in saving volatile query state"),console.error(t)}),this._isSavingVolatileQuery},t.prototype._loadLayerQuery=function(e){var t=this,r=this.volatileQueries.getQueriesByLayer(e);return r.length>0?(1!=r.length&&this.app.trace.warning("Multiple queries are saved for the layer with name "+e.displayName+". Loading the first..."),this.applyDisplayedQueryState(r[0].exportState()).then(function(r){return t.volatileQueries.removeQueriesByLayer(e)})["catch"](function(r){return t.buildBlankQuery(e)})):this.buildBlankQuery(e)},t.prototype._findLayerOrTable=function(e){this.selectedLayerIsTable.set(!1);for(var t=0;t<this.layers.length();t++)if(this.layers.getAt(t).uniqueId==e)return this.layers.getAt(t);if(this._getTableIndex(e)!==-1){var r=this._getTableIndex(e);return this.displayedQuery.get().layerIsTable.set(!0),this.selectedLayerIsTable.set(!0),this.tables.getAt(r)}},t.prototype._isEquivalentExpression=function(e,t){var r=!e||"1 = 1"==e,i=!t||"1 = 1"==t;return!(!r||!i)||e==t},t.prototype._getTableIndex=function(e){for(var t=0;t<this.tables.length();t++)if(this.tables.getAt(t).uniqueId===e)return t;return-1},t.prototype.layerAdded=function(e){if(!(e&&e.layer instanceof esri.layers.GraphicsLayer)||e.layer instanceof esri.layers.FeatureLayer){var t=null,r=[];this.app.isArcGisWebApp||(this._appInfo=d.AppInfo.fromGeocortexApp(this.app),t=this._appInfo.mapInfo.findMapServiceById(e.layer.id),t&&(r=t.layers.filter(function(e){return!(!e.gcxLayer||!e.gcxLayer.queryable)}))),t||(t=g.ServiceLayerInfo.fromEsriLayer(e.layer),r=t.layers),r.length>0&&(r=y.ArrayUtils.sortBy(r,function(e){return e.displayName}));for(var i=this._allLayers.length()-1,a=r.length-1;i>=0&&a>=0;){var n=this._allLayers.getAt(i).displayName,s=r[a].displayName;s>=n?(this._allLayers.insertItem(i+1,r[a]),a--):i--}for(;a>=0;)this._allLayers.insertItem(0,r[a]),a--;this._handleNewServiceLayers([t]),this._checkUseableLayers(),this.layers.refresh(),this.selectedLayerUniqueId.set(this.layers.length()?this.layers.getAt(0).uniqueId:null),this.selectedLayerUniqueId.pulse()}},t.prototype.layerRemoved=function(e){var t=this;this._allLayers.removeWhere(function(t){return t.serviceLayerInfo.serviceLayer==e.layer}),this._removeSub(e.layer.id),this.displayedQuery.get().layer.get()&&this.displayedQuery.get().layer.get().serviceLayerInfo&&this.displayedQuery.get().layer.get().serviceLayerInfo&&this.displayedQuery.get().layer.get().serviceLayerInfo&&e.layer&&this.displayedQuery.get().layer.get().serviceLayerInfo.serviceLayer==e.layer&&(this.layers.length()>0?this.buildBlankQuery(this.layers.getAt(0)):this.tables.length()>0?this.buildBlankQuery(this.tables.getAt(0)):this.buildBlankQuery(null)),this.displayedQuery.get().layer.get()&&this.infoText.set(this.getResource("language-querybuilder-find-in-layer").format(this.displayedQuery.get().layer.get().displayName));var r=new Promise(function(e,r){return t.app.command(t.isFilterBuilder.get()?"_getAllSavedFilters":"_getAllSavedQueries").execute(e)});r.then(function(r){return Q.PromiseUtils.mapSkipRejected(r,function(r){r.layer.get().serviceLayerInfo.serviceLayer===e.layer&&t.app.command(t.isFilterBuilder.get()?"RemoveSavedFilter":"RemoveSavedQuery").execute(r,{removeLayerFlag:!0})})}),this._checkUseableLayers()},t.prototype.addQueryClause=function(e){var t=new o.QueryClause(this.app,this.libraryId,e);return e.addQueryClauses([t])},t.prototype.removeQueryClause=function(e){this.event_queryClausesRemoving([e]),e.parentQuery.removeQueryClause(e),e.selectedField&&e.selectedField.isTypeField&&(e.parentQuery.updateCodedDomainValues(),e.parentQuery.pulseCodedDomainValues())},t.prototype.clearAllQueries=function(){var e=this;return this.volatileQueries.clear(),this.disabled.set(!1),this.nestingLevelTooDeep.set(!1),this.displayedQuery.get().refreshId(),this.buildBlankQuery(this.displayedQuery.get().layer.get()).then(function(){return e.layerIdChanged()}).then(function(){e.displayedQueryIsSaved.set(!1),e.displayedQuery.get().isModified.set(!1),e.app.command(e.isFilterBuilder.get()?"RemoveFilterStatus":"RemoveQueryStatus").execute()})},t.prototype.buildBlankQuery=function(e){var t=this,r=this.defaultLogicalOperator.get()||null,i=new c.Query(this.app,this.libraryId,{layer:e,layerIsTable:!1,logicalOperator:r});return this.attachQuery(i),this.displayedQuery.get().refreshFields().then(function(){if(e){var r=new o.QueryClause(t.app,t.libraryId,t.displayedQuery.get());t.displayedQuery.get().addQueryClauses([r])}}).then(function(){return t.displayedQuery.get()})},t.prototype.buildSpatiallyFilteredWhereClause=function(e,t){var r=this,i=new dojo.Deferred,a=new esri.tasks.Query,n=e.buildWhereClause(),s=e.layer.get(),o=s.gcxLayer?s.gcxLayer:s.serviceLayerInfo.serviceLayer,l=h.getQueryTask(o);return a.geometry=t,a.where=n,l.executeForIds(a).then(function(e){e=e||[];for(var t=null,a=0;a<s.fields.length;a++){var o=s.fields[a];if("esriFieldTypeOID"===o.type){t=o.name;break}}if(null!==t){var l="{0} IN ({1})".format(t,e.toString());i.resolve(l)}else r.app.trace.error("Could not find objectId property on currently displayed layer "+s.name+" to filter results with. Results not filtered"),i.resolve(n)},function(e){r.app.trace.error("an error occured while executing a query on "+s.name+". The query clause used was "+n,e),i.resolve(n)}),i},t.prototype.getGeometryFilter=function(e){this._updateSpatialFilterOption(e),this.displayedQuery.get().isModified.set(!1);var t=new dojo.Deferred;if(e==b.SpatialFilterOptions.None)return t.resolve(null),t;if(e==b.SpatialFilterOptions.CurrentExtent)return t.resolve(this._appInfo.map.extent),t;if(e==b.SpatialFilterOptions.Drawings){var r=new Array;if(this.isAwab.get())for(var i=0;i<this._appInfo.mapInfo.getGraphicsLayers().length;i++){var a=this._appInfo.mapInfo.getGraphicsLayers()[i];a.id.indexOf("graphicsLayer")>-1&&r.push(a)}else r.push(this._appInfo.mapInfo.markupLayer.get());for(var n=[],i=0;i<r.length;i++)for(var s=r[i],o=0;o<s.graphics.length;o++){var l=s.graphics[o];if("polygon"==l.geometry.type)n.push(l.geometry);else if("extent"==l.geometry.type){var u=m.extentToPolygon(l.geometry);n.push(u)}}if(0==n.length)t.resolve(null);else{var d=this._appInfo.getGeometryService();d.union(n).then(function(e){t.resolve(e)},function(e){t.resolve(null)})}return t}return this.app.trace.warning("Selected spatial Filter not recognized"),t.resolve(null),t},t.prototype.refreshQueryGeometry=function(e){return this.getGeometryFilter(e.selectedSpatialFilter.get()).then(function(t){return e.geometry=t?t:null,e.isModified.set(!0),t})},t.prototype.getViewerApp=function(){return this.app},t.prototype.event_queryClausesRemoving=function(e){},t.prototype.onDestroy=function(){e.prototype.onDestroy.call(this),this._gcxTokenDictionary.LayerThemeChangedEvent&&this.app.event("LayerThemeChangedEvent").unsubscribe(this._gcxTokenDictionary.LayerThemeChangedEvent)},t}(a.ViewModelBase);t.SimpleQueryBuilderViewModel=w})},"Mapping/modules/QueryBuilder/SavedQueries/ListQueriesView":function(){define(["require","exports","geocortex/framework/ui/ViewBase","geocortex/infrastructure/ui/components/PagingControls/PagingControlsViewModel"],function(e,t,r,i){"use strict";var a=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.attach=function(t){e.prototype.attach.call(this,t),this._registerCommands()},t.prototype.deactivated=function(){this.viewModel.isFilterBuilder.get()?this.app.command("RemoveFilterStatus").execute():this.app.command("RemoveQueryStatus").execute(),this.viewModel.presentableResults.currPageNumber.set(1)},t.prototype.resolveWidget=function(t,r,a){if("PagingControlsWidget"===t){var n=this.app.viewManager.createView({typeName:"geocortex.essentialsHtmlViewer.mapping.infrastructure.ui.components.PagingControls.PagingControlsView",markupResource:"Mapping/infrastructure/ui/components/PagingControls/PagingControlsView.html",libraryId:"Mapping.Infrastructure",isVisible:!0});if(n){var s=new i.PagingControlsViewModel(this.app,r);n.attach(s)}return n}return e.prototype.resolveWidget.call(this,t,r,a)},t.prototype._registerCommands=function(){this.app.command(this.viewModel.isFilterBuilder.get()?"ListFilters":"ListQueries").register(this,this.show)},t.prototype.show=function(e){var t=this;this.viewModel&&this.viewModel.refreshData().then(function(){t.app.viewManager.activateView(t)},function(e){t.app.command(t.viewModel.isFilterBuilder.get()?"AddFilterStatus":"AddQueryStatus").execute(t.app.getResource(t.libraryId,"language-querybuilder-error-retrieve-queries").format(t.viewModel.isFilterBuilder.get()?"filter":"query"),{error:!0})})},t.prototype.handleQueryActions=function(e,t,r){this.app.command(this.viewModel.isFilterBuilder.get()?"ShowFilterActions":"ShowQueryActions").execute(r)},t.prototype.handleQueryClick=function(e,t,r){this.app.command(this.viewModel.isFilterBuilder.get()?"RunFilter":"RunQuery").execute(r)},t}(r.ViewBase);t.ListQueriesView=a})},"Mapping/modules/QueryBuilder/SavedQueries/ListQueriesViewModel":function(){define(["require","exports","geocortex/framework/ui/ViewModelBase","geocortex/framework/observables","geocortex/framework-ui/PresentableCollection"],function(e,t,r,i,a){"use strict";var n=function(e){function t(t,r){var n=e.call(this,t,r)||this;return n.isFilterBuilder=new i.Observable((!1)),n.isPaged=!0,n.pageSize=10,n.queries=new i.ObservableCollection,n.presentableResults=new a.PresentableCollection(n.queries),n.resultsPage=n.presentableResults.items,n}return __extends(t,e),t.prototype.initialize=function(t){e.prototype.initialize.call(this,t),t=t||{},t.hasOwnProperty("isPaged")&&(this.isPaged=t.isPaged),t.hasOwnProperty("pageSize")&&(this.pageSize=t.pageSize),t.hasOwnProperty("mode")&&("filter"===t.mode?this.isFilterBuilder.set(!0):"query"===t.mode?this.isFilterBuilder.set(!1):this.app.trace.warning('Invalid configuration option for ListQueriesView "mode": '+t.mode+" given.")),this.presentableResults.isPaginated.set(this.isPaged),this.presentableResults.pageSize.set(this.pageSize),this.refreshData(),this._registerListeners()},t.prototype._registerListeners=function(){var e=this;this.app.event(this.isFilterBuilder.get()?"SavedFiltersChangedEvent":"SavedQueriesChangedEvent").subscribe(this,function(){e.refreshData()}),this.app.event("LayerThemeChangedEvent").subscribe(this,function(){e.refreshData()})},t.prototype.refreshData=function(){var e=this;return this._retrieveData().then(function(t){e.queries.clear();var r=t.filter(function(e){return e.layer.get().gcxLayer.inActiveTheme});if(e.isFilterBuilder.get()){var i=r.filter(function(t){return t.layer&&t.layer.get().gcxLayer?e._isValidFilterLayer(t.layer.get().gcxLayer.mapService):!!t.layer&&e._isValidFilterLayer(t.layer.get().serviceLayerInfo)});e.queries.addItems(i)}else e.queries.addItems(r)})},t.prototype._retrieveData=function(){var e=this;return new Promise(function(t,r){return e.app.command(e.isFilterBuilder.get()?"_getAllSavedFilters":"_getAllSavedQueries").execute(t)})},t.prototype._isValidFilterLayer=function(e){if(e.serviceLayer instanceof esri.layers.FeatureLayer&&e.serviceLayer.url)return!0;if(e.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer){var t=e.serviceLayer;if(null===t.capabilities||t.capabilities.indexOf("Query")!==-1)return!0}return!1},t}(r.ViewModelBase);t.ListQueriesViewModel=n})},"Mapping/modules/QueryBuilder/SavedQueries/QueryActionsView":function(){define(["require","exports","geocortex/infrastructure/menus/MenuView"],function(e,t,r){"use strict";var i={OPEN:"OPENQUERY",RENAME:"RENAMEQUERY",RUN:"RUNQUERY",DELETE:"DELETEQUERY"},a={OPEN:"OPENFILTER",RENAME:"RENAMEFILTER",RUN:"RUNFILTER",DELETE:"DELETEFILTER"},n=function(e){function t(t,r){return e.call(this,t,r)||this}return __extends(t,e),t.prototype.attach=function(t){e.prototype.attach.call(this,t),this.viewModel=t,this._registerCommandsAndEvents()},t.prototype.handleMenuItemClick=function(t,r,n){n.menuItem.id!==i.RENAME&&n.menuItem.id!==a.RENAME&&this.app.command("DeactivateView").execute(this.id),e.prototype.handleMenuItemClick.call(this,t,r,n)},t.prototype._registerCommandsAndEvents=function(){this.app.command(this.viewModel.isFilterBuilder.get()?"ShowFilterActions":"ShowQueryActions").register(this,this._executeShowQueryActions)},t.prototype._executeShowQueryActions=function(e){e&&(this.title.sync(e.displayName),this.viewModel.menuContext.set(e),this.app.command(this.viewModel.isFilterBuilder.get()?"RenameSavedFilter":"RenameSavedQuery").canExecute=function(){return!e.adminDefined},this.app.command(this.viewModel.isFilterBuilder.get()?"RenameSavedFilter":"RenameSavedQuery").raiseCanExecuteChanged(),this.app.command(this.viewModel.isFilterBuilder.get()?"RemoveSavedFilter":"RemoveSavedQuery").canExecute=function(){return!e.adminDefined},this.app.command(this.viewModel.isFilterBuilder.get()?"RemoveSavedFilter":"RemoveSavedQuery").raiseCanExecuteChanged(),this.app.command("ActivateView").execute(this.id))},t}(r.MenuView);t.QueryActionsView=n})},"Mapping/modules/QueryBuilder/SavedQueries/QueryActionsViewModel":function(){define(["require","exports","geocortex/infrastructure/menus/MenuViewModel","geocortex/framework/observables"],function(e,t,r,i){"use strict";var a=function(e){function t(t,r){var a=e.call(this,t,r)||this;return a.isFilterBuilder=new i.Observable((!1)),a.app=t,a.libraryId=r,a}return __extends(t,e),t.prototype.initialize=function(t){e.prototype.initialize.call(this,t),t.hasOwnProperty("mode")&&("filter"===t.mode?this.isFilterBuilder.set(!0):"query"===t.mode?this.isFilterBuilder.set(!1):this.app.trace.warning('Invalid configuration option for QueryActionsView "mode": '+t.mode+" given."))},t}(r.MenuViewModel);t.QueryActionsViewModel=a})},"Mapping/modules/QueryBuilder/SavedQueries/SaveQueryView":function(){define(["require","exports","geocortex/framework/ui/ViewBase","geocortex/framework/utils/TimeDelayedOperation"],function(e,t,r,i){"use strict";var a=function(e){function t(t,r){var i=e.call(this,t,r)||this;return i._keyDownTimer=null,i._validationDelayMS=300,i}return __extends(t,e),t.prototype.attach=function(t){var r=this;e.prototype.attach.call(this,t),this.title.set(this.app.getResource(this.libraryId,this.viewModel.isFilterBuilder.get()?"language-querybuilder-save-filter-dialog-title":"language-querybuilder-save-query-dialog-title")),this._keyDownTimer=new i.TimeDelayedAction(this._validationDelayMS,function(){return r.viewModel.validateInput()},this),this._registerCommands()},t.prototype.activated=function(){e.prototype.activated.call(this)},t.prototype.deactivated=function(){e.prototype.deactivated.call(this),this.viewModel.reset()},t.prototype._registerCommands=function(){this.app.command(this.viewModel.isFilterBuilder.get()?"ShowSaveAsFilterDialog":"ShowSaveAsQueryDialog").register(this,this.show),this.app.command(this.viewModel.isFilterBuilder.get()?"ShowSaveFilterDialog":"ShowSaveQueryDialog").register(this,this.save)},t.prototype.handleKeyDown=function(e,t,r){var i=e.which?e.which:e.keyCode;return i===dojo.keys.ENTER&&(this.saveAs(),e.preventDefault()),!0},t.prototype.handleInputChanged=function(e,t,r){this.viewModel.handleInputChanged(),this._keyDownTimer.reset()},t.prototype.handleCancelClick=function(e,t,r){this.app.viewManager.deactivateView(this)},t.prototype.handleSaveClick=function(e,t,r){this.saveAs()},t.prototype.saveAs=function(){var e=this,t=this.viewModel.name.get(),r=!0;this.viewModel.validateInput().then(function(){return e.viewModel.saveQuery(t,r)}).then(function(r){r&&(e.viewModel.showConfirmationMessage(t),e.app.viewManager.deactivateView(e),e.app.command(e.viewModel.isFilterBuilder.get()?"DisplayFilter":"DisplayQuery").execute(e.viewModel.query))})},t.prototype.save=function(e){var t=this;this.viewModel.query=e;var r=!1;this.viewModel.saveQuery(e.displayName.get(),r).then(function(r){r&&t.viewModel.showConfirmationMessage(e.displayName.get())})},t.prototype.show=function(e){this.viewModel.query=e,this.viewModel.name.set(e.displayName.get()||""),this.app.viewManager.activateView(this)},t}(r.ViewBase);t.SaveQueryView=a})},"Mapping/modules/QueryBuilder/SavedQueries/SaveQueryViewModel":function(){define(["require","exports","geocortex/framework/ui/ViewModelBase","geocortex/framework/observables","geocortex/framework/utils/utils","./../QueryErrorHandling"],function(e,t,r,i,a,n){"use strict";var s=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.name=new i.Observable(""),t.inputErrorMessage=new i.Observable,t.query=null,t.isFilterBuilder=new i.Observable((!1)),t._existingQuery=!1,t}return __extends(t,e),t.prototype.initialize=function(t){e.prototype.initialize.call(this,t),t.hasOwnProperty("mode")&&("filter"===t.mode?this.isFilterBuilder.set(!0):"query"===t.mode?this.isFilterBuilder.set(!1):this.app.trace.warning('Invalid configuration option for ListQueriesView "mode": '+t.mode+" given.")),this.app.command(this.isFilterBuilder.get()?"RenameSavedFilter":"RenameSavedQuery").register(this,this._executeRenameQuery)},t.prototype.saveQuery=function(e,t){var r=this;return Promise["try"](function(){return r._assertNameNotNull(e),e=e.trim(),r.queryExists(e).then(function(i){if(r._existingQuery=!!i,r._existingQuery){if(i.adminDefined){var a=new Error("Cannot overwrite administrator defined query");return a.adminDefined=!0,a.code=n.ERRCODES.UPDATEQUERYERROR,n.handleQueryErrors.call(r,r.isFilterBuilder.get(),a),!1}if(t)return r.confirmOverwrite(e)}return!0}).then(function(t){return r._existingQuery&&t?r.overwriteQuery(e):r._existingQuery?Promise.resolve(!1):r.createQuery(e)})})["catch"](function(e){return n.handleQueryErrors.call(r,r.isFilterBuilder.get(),e),!1})},t.prototype.overwriteQuery=function(e){var t=this,r=function(e){var r=e;return r.adminDefined=!1,r.code=n.ERRCODES.UPDATEQUERYERROR,n.handleQueryErrors.call(t,t.isFilterBuilder.get(),r),!1};if(e===this.query.displayName.get()){var i=function(e){return new Promise(function(i,a){t.app.command(t.isFilterBuilder.get()?"_updateSavedFilterById":"_updateSavedQueryById").execute(e.id.get(),e,function(e){t.query=e,i(!0)},function(e){r(e),a(!1)})})};return this.query.getNewInstance().then(function(e){return i(e)},n.handleQueryErrors.bind(this))}return Promise.all([this.query.getNewInstance(!0),new Promise(function(r,i){return t.app.command(t.isFilterBuilder.get()?"_getSavedFilterByName":"_getSavedQueryByName").execute(e,r,i)})]).then(function(i){var a=i[0],n=i[1];return a.displayName.set(e),a.adminDefined=!1,new Promise(function(e,i){t.app.command(t.isFilterBuilder.get()?"_updateSavedFilterById":"_updateSavedQueryById").execute(n.id.get(),a,function(r){return t.query=r,e(!0)},function(e){return r(e),i(!1)})})})["catch"](function(e){return n.handleQueryErrors.call(t,t.isFilterBuilder.get(),e),!1})},t.prototype.queryExists=function(e){var t=this;return new Promise(function(r,i){t.app.command(t.isFilterBuilder.get()?"_getSavedFilterByName":"_getSavedQueryByName").execute(e,function(e){r(e)},function(){r(null)})})},t.prototype.createQuery=function(e){var t=this;return new Promise(function(r,i){t.query.getNewInstance(!0).then(function(a){a.displayName.set(e),a.adminDefined=!1,t.app.command(t.isFilterBuilder.get()?"_addSavedFilter":"_addSavedQuery").execute(a,function(e){t.query=e,r(!0)},function(e){n.handleQueryErrors.call(t,t.isFilterBuilder.get(),e),i(e)})})})},t.prototype.confirmOverwrite=function(e){var t=this,r=this.app.getResource(this.libraryId,"language-querybuilder-savedqueries-overwrite-prompt").format(e),i=this.app.getResource(this.libraryId,"language-querybuilder-savedqueries-overwrite-prompt-title").format(e);return this.isFilterBuilder.get()?(r=this.app.getResource(this.libraryId,"language-querybuilder-savedfilters-overwrite-prompt").format(e),i=this.app.getResource(this.libraryId,"language-querybuilder-savedfilters-overwrite-prompt-title").format(e)):(r=this.app.getResource(this.libraryId,"language-querybuilder-savedqueries-overwrite-prompt").format(e),i=this.app.getResource(this.libraryId,"language-querybuilder-savedqueries-overwrite-prompt-title").format(e)),new Promise(function(e,a){return t.app.command("Confirm").execute(r,i,e)})},t.prototype.showConfirmationMessage=function(e){var t;t=this.isFilterBuilder.get()?this._existingQuery?"language-querybuilder-savedfilters-update-confirmation":"language-querybuilder-savedfilters-create-confirmation":this._existingQuery?"language-querybuilder-savedqueries-update-confirmation":"language-querybuilder-savedqueries-create-confirmation";var r=this.getResource(t).format(e);this.app.command(this.isFilterBuilder.get()?"AddFilterStatus":"AddQueryStatus").execute(r)},t.prototype._executeRenameQuery=function(e){var t,r=this;this.promptForQueryName(e).then(function(i){if(!a.isNullOrUndefined(i)){if(0===i.length){var s=new Error;return s.code=n.ERRCODES.NONAMEGIVENERROR,void n.handleQueryErrors.call(r,r.isFilterBuilder.get(),s)}return t=i,r.queryExists(i).then(function(i){if(i){var a=new Error;return a.code=n.ERRCODES.DUPLICATE,a.queryName=t,void n.handleQueryErrors.call(r,r.isFilterBuilder.get(),a)}return e.displayName.set(t),void r.app.command(r.isFilterBuilder.get()?"_updateSavedFilterById":"_updateSavedQueryById").execute(e.id.get(),e)})}})["catch"](function(e){throw r.app.trace.error(e.message,e),e})},t.prototype.promptForQueryName=function(e){var t=this,r=this.getResource("language-querybuilder-rename-prompt-title"),i=this.getResource(this.isFilterBuilder.get()?"language-querybuilder-rename-filter-prompt":"language-querybuilder-rename-query-prompt"),a=e.displayName.get(),n=new Promise(function(e,n){return t.app.command("Prompt").execute(r,i,a,e)});return n},t.prototype._assertNameNotNull=function(e){if(a.isNullOrUndefined(e))throw new Error("The query name must be set.")},t.prototype.validateInput=function(){var e=this;if(this._validateInputPromise)return this._validateInputPromise;var t=this.name.get()?this.name.get().trim():"";return this._validateInputPromise=Promise.resolve().then(function(){if(String.isNullOrEmpty(t))throw new Error(e.getResource(e.isFilterBuilder.get()?"language-querybuilder-filter-error-name-required":"language-querybuilder-query-error-name-required"))}).then(function(){return e.queryExists(t)}).then(function(r){if(e._existingQuery=!!r,e._existingQuery){if(r.adminDefined){var i=new Error("Cannot overwrite administrator defined query");return i.adminDefined=!0,i.code=n.ERRCODES.UPDATEQUERYERROR,n.handleQueryErrors.call(e,e.isFilterBuilder.get(),i),!1}throw new Error(e.getResource(e.isFilterBuilder.get()?"language-querybuilder-filter-error-name-exists":"language-querybuilder-query-error-name-exists").format(t))}return!0})["catch"](function(t){return e.inputErrorMessage.set(t.message),Promise.reject(t)})["finally"](function(){e._validateInputPromise=null})},t.prototype.handleInputChanged=function(){this.inputErrorMessage.get()&&this.name.get()&&!String.isNullOrEmpty(this.name.get().trim())&&this.inputErrorMessage.set("")},t.prototype.reset=function(){this.name.set(""),this.inputErrorMessage.set("")},t}(r.ViewModelBase);t.SaveQueryViewModel=s})},"url:/Mapping/modules/QueryBuilder/AutoCompleteView.html":'<input type="text" data-binding="{@value: value}{@var: autoCompleteInput}{@event-focus: autoComplete_focus}{@event-blur: autoComplete_blur}" />\r\n',"url:/Mapping/modules/QueryBuilder/SimpleQueryBuilderView.html":'<div class="query-actions-widget" data-binding="{@disabled: isFilterBuilder}{@widget: QueryActionsWidget}{@widget-context: displayedQuery}{@widget-required: false}"\r\n    data-menu-template="Mapping/infrastructure/menus/MenuView.html"></div>\r\n\r\n<div class="simple-query-builder">\r\n    <div data-binding="{@hidden: noAvailableLayers}">\r\n        <form class="query-builder-form gcx-sticky-content has-footer" data-binding="{@event-keydown: form_keydown}{@var: htmlForm}{@event-submit: form_submit}">\r\n            <div class="form-item" data-binding="{@hidden: nestingLevelTooDeep}">\r\n                <label>\r\n                    <span data-binding="{@text: @language-querybuilder-data-source}"></span>\r\n                    <select id="selectlayer" data-binding="{@value: selectedLayerUniqueId}">\r\n                        <optgroup data-binding="{@visible: areQueryableLayers}{@source: layers}{label: @language-querybuilder-query-layers}">\r\n                            <option data-binding="{@template-for: layers}{@text: displayName}{value: uniqueId}" />\r\n                        </optgroup>\r\n                        <optgroup data-binding="{@visible: areQueryableTables}{@source: tables}{label: @language-querybuilder-query-tables}">\r\n                            <option data-binding="{@template-for: tables}{@text: displayName}{value: uniqueId}" />\r\n                        </optgroup>\r\n                    </select>\r\n                </label>\r\n            </div>\r\n            <div class="form-item" data-binding="{@hidden: selectedLayerIsTable}">\r\n                <label>\r\n                    <span data-binding="{@text: @language-querybuilder-spatial-filter}"></span>\r\n                    <select data-binding="{@source: spatialFilters}{@value: selectedSpatialFilter}">\r\n                        <option data-binding="{@template-for: spatialFilters}{@text: name}{value: val}" />\r\n                    </select>\r\n                </label>\r\n            </div>\r\n            <div data-binding="{@visible: filterAlreadyApplied}">\r\n                <div data-binding="{@text: @language-querybuilder-filter-already-applied}"></div>\r\n            </div>\r\n            <div class="info-message" data-binding="{@visible: nestingLevelTooDeep}">\r\n                <span data-binding="{@text: @language-querybuilder-nesting-level-too-deep}"></span>\r\n            </div>\r\n            <div class="query-conditions-area" data-binding="{@visible: notDisabled}">\r\n                <div class="find-results" data-binding="{@text: infoText}"></div>\r\n                <div data-binding="{@source: displayedQuery}{@template: Mapping/modules/QueryBuilder/Templates/QueryBuilderRoot.html}"></div>\r\n            </div>\r\n\r\n            <!-- For debugging -->\r\n            <div class="clear" data-binding="{@visible: isDebug}">\r\n                <h4>Debug</h4>\r\n                <hr />\r\n                <div data-binding="{@source: displayedQuery}">\r\n                    <textarea data-binding="{@template-for: displayedQuery}{@value: _debugWhereClause}{@visible: isDebug}" style="width: 100%;"></textarea><!-- For debugging -->\r\n                </div>\r\n            </div>\r\n        </form>\r\n        <div class="form-btns gcx-sticky-footer">\r\n            <button class="jimu-btn button" data-binding="{@event-onclick: clearResultsButton_click}{@visible: isQueryAndAwab}{@text: @language-querybuilder-clear}"></button>\r\n            <button class="jimu-btn button" data-binding="{@event-onclick: clearFilterButton_click}{@visible: isFilterBuilder}{@text: @language-querybuilder-clear}"></button>\r\n            <button type="submit" class="jimu-btn button" data-binding="{@event-onclick: actionButton_click}{@visible: isQueryBuilder}{@text: @language-querybuilder-search}"></button>\r\n            <button type="submit" class="jimu-btn button" data-binding="{@event-onclick: actionButton_click}{@visible: isFilterBuilder}{@text: @language-querybuilder-filter}{@disabled: disabled}{@class-disabled: disabled}"></button>\r\n            <button class="jimu-btn button" data-binding="{@event-onclick: cancelButton_click}{@visible: isQueryBuilder}{@text: @language-querybuilder-cancel}"></button>\r\n            <button class="jimu-btn button" data-binding="{@event-onclick: cancelButton_click}{@visible: isFilterBuilder}{@text: @language-querybuilder-cancel}"></button>\r\n        </div>\r\n    </div>\r\n    <div data-binding="{@visible: noAvailableLayers}{@text: noAvailableLayersText}"></div>\r\n    <div class="autocomplete-container"></div>\r\n</div>\r\n',"url:/Mapping/modules/QueryBuilder/SavedQueries/ListQueriesView.html":'<div class="list-queries-view">\r\n    <div class="panel-group panel-scroll-container no-item box-container" data-binding="{@hidden: queries}">\r\n        <p data-binding="{@hidden: isFilterBuilder}{@text: @language-querybuilder-savedqueries-browse-no-items}"></p>\r\n        <p class="description" data-binding="{@hidden: isFilterBuilder}{@text: @language-querybuilder-savedqueries-browse-no-items-desc}"></p>\r\n\r\n        <p data-binding="{@visible: isFilterBuilder}{@text: @language-querybuilder-savedfilters-browse-no-items}"></p>\r\n        <p class="description" data-binding="{@visible: isFilterBuilder}{@text: @language-querybuilder-savedfilters-browse-no-items-desc}"></p>\r\n    </div>\r\n\r\n    <div class="results-list" data-binding="{@visible: queries}">\r\n        <ul class="gcx-list-menu" data-binding="{@source: resultsPage}">\r\n            <li class="gcx-list-item has-action-1 query-items" data-binding="{@template-for: resultsPage}">\r\n                <button class="gcx-list-button" data-binding="{@disabled: disabled}{@event-click: handleQueryClick}">\r\n                    <strong class="gcx-list-label" data-binding="{@text: displayName}"></strong>\r\n                    <span class="gcx-list-desc" data-binding="{@visible: adminDefined}{@text: @language-saved-admin-defined}"></span>\r\n                    <div class="gcx-list-desc">\r\n                        <span data-binding="{@text: @language-querybuilder-layer-label}"></span>\r\n                        <span data-binding="{@source: layer}">\r\n                            <span data-binding="{@template-for: layer}{@text: displayName}"></span>\r\n                        </span>\r\n                    </div>\r\n                    <div class="gcx-list-desc">\r\n                        <span data-binding="{@text: @language-querybuilder-extent-label}"></span>\r\n\r\n                        <span data-binding="{@text: selectedSpatialFilterName}"></span>\r\n                    </div>\r\n                </button>\r\n                <button class="gcx-action-button icon chevron-right-24" data-binding="{title: @language-querybuilder-actions-tooltip}{@event-click: handleQueryActions}"></button>\r\n            </li>\r\n        </ul>\r\n    </div>\r\n\r\n    <!-- BEGIN: Paging Controls -->\r\n    <div class="paging-control has-pages" data-binding="{@visible: queries}{@widget: PagingControlsWidget}{@widget-context: @context}{@widget-required: false}"></div>\r\n    <!-- END: Paging Controls -->\r\n</div>',"url:/Mapping/modules/QueryBuilder/SavedQueries/QueryActionsView.html":'<div class="no-item" data-binding="{@hidden: visibleMenuItems}{@text: @language-menu-no-items}"></div>\r\n\r\n<ul class="list-menu has-icon" data-binding="{@visible: visibleMenuItems}{@source: visibleMenuItems}">\r\n    <li class="list-menu-item" data-binding="{@template-for: visibleMenuItems}">\r\n        <button class="list-menu-button" data-binding="{@enabled: canExecute}{@event-onmouseover: getDescription}{@event-onclick: handleMenuItemClick}">\r\n            <img class="list-menu-icon" data-binding="{src: iconUri}{@visible: iconUri}" alt=" " />\r\n            <span class="list-menu-details">\r\n                <strong class="list-menu-name" data-binding="{@text: text}"></strong>\r\n                <span class="list-menu-desc" data-binding="{@visible: description}{@text: description}"></span>\r\n            </span>\r\n        </button>\r\n    </li>\r\n</ul>',
"url:/Mapping/modules/QueryBuilder/SavedQueries/SaveQueryView.html":'<div class="save-selection-view">\r\n    <label>\r\n        <span data-binding="{@text: @language-common-save-as}"></span>\r\n        <input type="text" data-binding="{@value: name}{title: @language-querybuilder-name-title}{@event-oninput: handleInputChanged}" />\r\n    </label>\r\n    <div class="form-validation" data-binding="{@visible: inputErrorMessage}">\r\n        <span class="field-validation-error" data-binding="{@text: inputErrorMessage}"></span>\r\n    </div>\r\n    <div class="form-btns">\r\n        <button class="button save-button" data-binding="{@event-click: handleSaveClick}{@text: @language-common-save}{@disabled: inputErrorMessage}"></button>\r\n        <button class="button cancel-button" data-binding="{@event-click: handleCancelClick}{@text: @language-common-cancel}"></button>\r\n    </div>\r\n</div>',"url:/Mapping/modules/QueryBuilder/Templates/QueryBuilderItem.html":'<div class="query-item">\r\n    <div class="query-item-inputs">\r\n        <label class="query-row-input">\r\n            <span class="hidden-label" data-binding="{@text: @language-querybuilder-select-filter-label}"></span>\r\n            <select data-binding="{@source: fields}{@value: selectedFieldName}{title: @language-querybuilder-select-filter}">\r\n                <option data-binding="{@template-for: fields}{@text: alias}{value: name}" />\r\n            </select>\r\n        </label>\r\n        <label class="query-row-input">\r\n            <span class="hidden-label" data-binding="{@text: @language-querybuilder-select-operator-label}"></span>\r\n            <select data-binding="{@source: operators}{@value: selectedOperator}{title: @language-querybuilder-select-operator}">\r\n                <option data-binding="{@template-for: operators}{@text: name}{value: value}" />\r\n            </select>\r\n        </label>\r\n        <label class="query-row-input">\r\n            <span class="hidden-label">TestLabel</span>\r\n            <span class="auto-complete" data-binding="{@widget: AutoComplete}{@widget-context: @context}{@visible: showTextInput}"></span>\r\n            <span class="date-picker" data-binding="{@widget: DatePicker}{@widget-context: @context}{@visible: showDateTimeInput}"></span>\r\n            <select class="coded-value-picker value-selector" data-binding="{@visible: showCodedValueDomainInput}{@source: codedValues}{@value: codedDomainValue}{title: @language-querybuilder-coded-value}">\r\n                <option data-binding="{@template-for: codedValues}{@text: name}{value: val}" />\r\n            </select>\r\n            <input class="value-selector" disabled="disabled" type="text" data-binding="{@visible: showDisabledInput}{@class-disabled: showDisabledInput}" />\r\n        </label>\r\n    </div>\r\n    <button class="query-row-delete" data-binding="{@event-onclick: removeQueryClause_click}{@class-disabled: deleteDisabled}{title: @language-common-delete}"></button>\r\n</div>\r\n<div class="conjunction" data-binding="{@hidden: isLast}">\r\n    <div class="conjunction-text and" data-binding="{@text: @language-querybuilder-and}{@visible: isAnd}"></div>\r\n    <div class="conjunction-text or" data-binding="{@text: @language-querybuilder-or}{@visible: isOr}"></div>\r\n</div>\r\n',"url:/Mapping/modules/QueryBuilder/Templates/QueryBuilderItemGroup.html":'<div class="query-subgroup">\r\n    <div class="logical-operators" data-binding="{@var: radioButtons}">\r\n        <label class="logical-operator-toggle">\r\n            <input type="radio" value="and" data-binding="{name: radioButtonGroup}{@event-onchange: handleRadioClick}"/>\r\n            <span class="label" data-binding="{@text: @language-querybuilder-logical-toggle-and}"></span>\r\n        </label>\r\n        <label class="logical-operator-toggle">\r\n            <input type="radio" value="or" data-binding="{name: radioButtonGroup}{@event-onchange: handleRadioClick}"/>\r\n            <span class="label" data-binding="{@text: @language-querybuilder-logical-toggle-or}"></span>\r\n        </label>\r\n    </div>\r\n    <ul class="query-group" data-binding="{@source: queryItems}{@template-selector: type}">\r\n        <li data-binding="{@template-select: queryItem}{@template: Mapping/modules/QueryBuilder/Templates/QueryBuilderItem.html}"></li>\r\n        <li data-binding="{@template-select: queryGroup}{@template: Mapping/modules/QueryBuilder/Templates/QueryBuilderItemGroup.html}"></li>\r\n    </ul>\r\n    <ul class="add-buttons">\r\n        <li>\r\n            <button class="text-button" data-binding="{@event-onclick: addQueryClause_click}{@text: @language-querybuilder-add-condition}"></button>\r\n        </li>\r\n        <li>\r\n            <button class="text-button" data-binding="{@hidden: hasParent}{@event-onclick: addNestedQuery_click}{@text: @language-querybuilder-add-subgroup}"></button>\r\n        </li>\r\n    </ul>\r\n</div>\r\n<div class="conjunction" data-binding="{@hidden: isLast}">\r\n    <div class="conjunction-text and" data-binding="{@text: @language-querybuilder-and}{@visible: isAnd}"></div>\r\n    <div class="conjunction-text or" data-binding="{@text: @language-querybuilder-or}{@visible: isOr}"></div>\r\n</div>',"url:/Mapping/modules/QueryBuilder/Templates/QueryBuilderRoot.html":'<div class="logical-operators main-level-toggle" data-binding="{@var: radioButtons}">\r\n    <label class="logical-operator-toggle">\r\n        <input type="radio" value="and" data-binding="{name: radioButtonGroup}{@event-onchange: handleRadioClick}" />\r\n        <span class="label" data-binding="{@text: @language-querybuilder-logical-toggle-and}"></span>\r\n    </label>\r\n    <label class="logical-operator-toggle">\r\n        <input type="radio" value="or" data-binding="{name: radioButtonGroup}{@event-onchange: handleRadioClick}" />\r\n        <span class="label" data-binding="{@text: @language-querybuilder-logical-toggle-or}"></span>\r\n    </label>\r\n</div>\r\n<ul class="query-group main-level-group" data-binding="{@source: queryItems}{@template-selector: type}">\r\n    <li class="query-item" data-binding="{@template-select: queryItem}{@template: Mapping/modules/QueryBuilder/Templates/QueryBuilderItem.html}"></li>\r\n    <li data-binding="{@template-select: queryGroup}{@template: Mapping/modules/QueryBuilder/Templates/QueryBuilderItemGroup.html}"></li>\r\n</ul>\r\n<ul class="add-buttons main-level-add">\r\n    <li>\r\n        <button class="text-button" data-binding="{@event-onclick: addQueryClause_click}{@text: @language-querybuilder-add-condition}"></button>\r\n    </li>\r\n    <li>\r\n        <button class="text-button" data-binding="{@hidden: hasParent}{@event-onclick: addNestedQuery_click}{@text: @language-querybuilder-add-subgroup}"></button>\r\n    </li>\r\n</ul>'}}),define(["Mapping/modules/QueryBuilder/AutoCompleteView","Mapping/modules/QueryBuilder/AutoCompleteViewModel","Mapping/modules/QueryBuilder/Formatters","Mapping/modules/QueryBuilder/Query","Mapping/modules/QueryBuilder/QueryBuilderModule","Mapping/modules/QueryBuilder/QueryClause","Mapping/modules/QueryBuilder/QueryOperator","Mapping/modules/QueryBuilder/QueryOperatorDescription","Mapping/modules/QueryBuilder/SimpleQueryBuilderView","Mapping/modules/QueryBuilder/SimpleQueryBuilderViewModel"],function(e,t,r,i,a,n,s,o,l,u){shim(e,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.AutoCompleteView",e.AutoCompleteView),shim(t,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.AutoCompleteViewModel",t.AutoCompleteViewModel),shim(r,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.QueryFormatterFactory",r.QueryFormatterFactory),shim(r,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.QueryFormatter",r.QueryFormatter),shim(r,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.Db2QueryFormatter",r.Db2QueryFormatter),shim(r,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.FileGdbQueryFormatter",r.FileGdbQueryFormatter),shim(r,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.InformixQueryFormatter",r.InformixQueryFormatter),shim(r,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.MsAccessQueryFormatter",r.MsAccessQueryFormatter),shim(r,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.OracleQueryFormatter",r.OracleQueryFormatter),shim(r,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.PostgreSqlQueryFormatter",r.PostgreSqlQueryFormatter),shim(r,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.ShapefileQueryFormatter",r.ShapefileQueryFormatter),shim(r,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.SqlServerQueryFormatter",r.SqlServerQueryFormatter),shim(r,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.GeocortexOwsQueryFormatter",r.GeocortexOwsQueryFormatter),shim(i,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.Query",i.Query),shim(a,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.QueryBuilderModule",a.QueryBuilderModule),shim(n,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.QueryClause",n.QueryClause),shim(s,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.QueryOperator",s.QueryOperator),shim(o,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.QueryOperatorDescription",o.QueryOperatorDescription),shim(l,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.SimpleQueryBuilderView",l.SimpleQueryBuilderView),shim(u,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.SimpleQueryBuilderViewModel",u.SimpleQueryBuilderViewModel)});