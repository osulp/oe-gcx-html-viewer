!function(){require({cache:{"Mapping/modules/Pushpins/PushpinsModule":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function s(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(s.prototype=i.prototype,new s)}}();define(["require","exports","geocortex/framework/application/ModuleBase","geocortex/framework/observables","geocortex/infrastructure/Feature","geocortex/infrastructure/GeometryUtils","geocortex/infrastructure/MapUtils","geocortex/infrastructure/commandArgs/PushpinArgs","geocortex/essentials/utilities/GraphicsLayerUtilities","geocortex/infrastructure/GraphicsLayerUtils","geocortex/infrastructure/GraphicsLayerIds"],function(t,i,s,n,a,r,o,p,u,h,c){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var l=function(t){function i(e,s){var a=t.call(this,e,s)||this;return a.FEATURE_PROPERTY="__Feature__",a.TAG_PROPERTY="__Tag__",a._handles=null,a._cachedSymbol=null,a._defaultPushpinSymbol=null,a._pushpinsLayer=null,a._initializePromise=null,a._activeViewId=null,a._imageUrlErrors={},a._graphicInEditMode=null,a.initialized=!1,a.enabled=!0,a.pushpinsRemainVisible=!0,a.pushpinMarkerUri=i.DEFAULT_PUSHPIN_MARKER_URI,a.pushpinMarkerWidth=32,a.pushpinMarkerHeight=32,a.offsetX=0,a.offsetY=16,a._handles={appEvents:null,mapEvents:null,fsEvents:[]},a.featureSetCollection=new n.Observable,a.featureSetCollection.bind(a,a._handleCollectionChanged),a._defaultPushpinSymbol=new esri.symbol.PictureMarkerSymbol(i.DEFAULT_PUSHPIN_MARKER_URI,32,32),a._defaultPushpinSymbol.setOffset(0,16),a._registerCommands(),a}return e(i,t),i.prototype.initialize=function(e){var s=this;t.prototype.initialize.call(this,e),e&&(e.hasOwnProperty("pushpinsEnabled")&&(this.enabled=!!e.pushpinsEnabled),e.hasOwnProperty("pushpinsRemainVisible")&&(this.pushpinsRemainVisible=!!e.pushpinsRemainVisible),e.hasOwnProperty("pushpinMarkerUri")&&(this.pushpinMarkerUri=e.pushpinMarkerUri),e.hasOwnProperty("pushpinMarkerWidth")&&(this.pushpinMarkerWidth=parseInt(e.pushpinMarkerWidth)),e.hasOwnProperty("pushpinMarkerHeight")&&(this.pushpinMarkerHeight=parseInt(e.pushpinMarkerHeight)),e.hasOwnProperty("offsetX")&&(this.offsetX=parseInt(e.offsetX)),e.hasOwnProperty("offsetY")&&(this.offsetY=parseInt(e.offsetY)),e.hasOwnProperty("eventMappings")&&(this.eventMappings=e.eventMappings||{}),u.addToGraphicsLayerIdsToExclude([h.ExcludeFromEnum.ExportApplyStateName,h.ExcludeFromEnum.WebMapName],i.PUSHPINS_GRAPHICS_LAYER_ID)),this._initializePromise=this._getPushpinSymbolAsync(this.pushpinMarkerUri,this.pushpinMarkerWidth,this.pushpinMarkerHeight,this.offsetX,this.offsetY).then(function(e){s._cachedSymbol=e||s._defaultPushpinSymbol,s.initialized=!0,s.app.command("AddPushpin").raiseCanExecuteChanged(),s.app.command("AddPushpins").raiseCanExecuteChanged(),s.app.command("RemovePushpin").raiseCanExecuteChanged(),s.app.command("RemovePushpins").raiseCanExecuteChanged()}),this.app.command("ShowPushpins").raiseCanExecuteChanged(),this.app.command("HidePushpins").raiseCanExecuteChanged(),this.app.command("AddPushpin").raiseCanExecuteChanged(),this.app.command("AddPushpins").raiseCanExecuteChanged(),this.app.command("RemovePushpin").raiseCanExecuteChanged(),this.app.command("RemovePushpins").raiseCanExecuteChanged(),this.enabled?this.app.command("EnablePushpins").execute():this.app.command("DisablePushpins").execute()},i.prototype.getStateFilter=function(){return{enabled:!0,visible:!0,results:this.app.project.filter.featureSetCollection,pushpins:{item:this.app.project.filter.feature},resultsView:!0}},i.prototype.isReady=function(){return this.enabled&&this.initialized},i.prototype._registerCommands=function(){var e=this;this.app.command("EnablePushpins").register(this,this._executeEnablePushpins),this.app.command("DisablePushpins").register(this,this._executeDisablePushpins),this.app.command("ShowPushpins").register(this,this._executeShowPushpins,this.isReady),this.app.command("HidePushpins").register(this,this._executeHidePushpins,this.isReady),this.app.command("AddPushpin").register(this,this._addPushpin,this.isReady),this.app.command("AddPushpins").register(this,this._executeAddPushpins,this.isReady),this.app.command("RemovePushpin").register(this,this._executeRemovePushpin,this.isReady),this.app.command("RemovePushpins").register(this,this._executeRemovePushpins,this.isReady),this.app.event("GraphicEditActivatedEvent").subscribe(this,function(t){e._graphicInEditMode=t.graphic}),this.app.event("GraphicEditDeactivatedEvent").subscribe(this,function(t){e._graphicInEditMode=null})},i.prototype._subscribeAll=function(){var e=this;if(this._unsubscribeAll(),this._handles.appEvents=[],this._connectAppEvent("FSMCollectionRemovedEvent",this._fsmCollectionRemovedEventHandler),this._connectAppEvent("ResultsViewOpenedEvent",function(t){e._trackView(t),e.app.command("ShowPushpins").execute()}),this.pushpinsRemainVisible?this._connectAppEvent("ResultsViewClosedEvent",function(t){t&&t.id===e._activeViewId&&e.app.command("HidePushpins").execute()}):this._connectAppEvent("ResultsViewCollapsedEvent",function(t){t&&t.id===e._activeViewId&&e.app.command("HidePushpins").execute()}),this.eventMappings)for(var t in this.eventMappings)if(this.eventMappings.hasOwnProperty(t)){var i=this._wireUpConfiguredEventHandler(t,this.eventMappings[t]);this._handles.appEvents.push({eventName:t,token:i})}this._connectAppEvent("FeatureDeletedEvent",function(t){t&&e._executeRemovePushpin(t)}),this._connectAppEvent("GraphicRemovedEvent",function(t){if(t&&t.graphic){var i=t.graphic;e._executeRemovePushpin(i)}})},i.prototype._unsubscribeAll=function(){this._disconnectFeatureSetChanges(),this._disconnectAppEvents()},i.prototype._trackView=function(e){e&&(this._activeViewId=e.id)},i.prototype._executeEnablePushpins=function(){this.enabled=!0,this._subscribeAll(),this.app.command("ShowPushpins").raiseCanExecuteChanged(),this.app.command("HidePushpins").raiseCanExecuteChanged(),this.app.command("AddPushpin").raiseCanExecuteChanged(),this.app.command("AddPushpins").raiseCanExecuteChanged(),this.app.command("RemovePushpin").raiseCanExecuteChanged(),this.app.command("RemovePushpins").raiseCanExecuteChanged()},i.prototype._executeDisablePushpins=function(){if(this.enabled=!1,this._unsubscribeAll(),this.app.map){var e=this._getPushpinsLayer();this._clearPushpinsLayer(e),e.hide()}this.app.command("ShowPushpins").raiseCanExecuteChanged(),this.app.command("HidePushpins").raiseCanExecuteChanged(),this.app.command("AddPushpin").raiseCanExecuteChanged(),this.app.command("AddPushpins").raiseCanExecuteChanged(),this.app.command("RemovePushpin").raiseCanExecuteChanged(),this.app.command("RemovePushpins").raiseCanExecuteChanged()},i.prototype._executeShowPushpins=function(){this._setPushpinsVisibility(!0)},i.prototype._executeHidePushpins=function(){this._setPushpinsVisibility(!1)},i.prototype._executeAddPushpins=function(e){var t=this.app.featureSetManager.getCollectionById(e);this.featureSetCollection.set(t)},i.prototype._executeRemovePushpins=function(){this.featureSetCollection.set(null)},i.prototype._setPushpinsVisibility=function(e){this._getPushpinsLayer().setVisibility(e),this.app.command("ShowPushpins").raiseCanExecuteChanged(),this.app.command("HidePushpins").raiseCanExecuteChanged()},i.prototype._connectAppEvent=function(e,t){var i=this.app.event(e).subscribe(this,t);this._handles.appEvents.push({eventName:e,token:i})},i.prototype._disconnectAppEvents=function(){if(this._handles.appEvents)for(var e=0;e<this._handles.appEvents.length;e++){var t=this._handles.appEvents[e];this.app.event(t.eventName).unsubscribe(t.token)}this._handles.appEvents=null},i.prototype._connectMapEvents=function(e){var t=this;this._handles.mapEvents=[e.on("layer-add-result",function(e){t.initialized&&t.enabled&&e.layer&&t._pushpinsLayer&&e.layer.id!==t._pushpinsLayer.id&&t._movePushpinsToFront()}),e.on("layer-remove",function(e){t.initialized&&t.enabled&&e.layer&&t._pushpinsLayer&&e.layer.id!==t._pushpinsLayer.id&&t._movePushpinsToFront()}),e.on("layers-reordered",function(e){t.initialized&&t.enabled&&t._movePushpinsToFront()})]},i.prototype._disconnectMapEvents=function(){this._handles.mapEvents&&dojo.forEach(this._handles.mapEvents,function(e,t){e.remove()}),this._handles.mapEvents=null},i.prototype._connectFeatureSetChanges=function(e){for(var t=this,i=0;i<e.featureSets.getLength();i++){var s=e.id,n=e.featureSets.getAt(i),a=n&&n.features;if(!this._handles.fsEvents.some(function(e){return e.collection===a})){var r=a.bind(this,function(e){return t._featureSetChanged(s,e)});this._handles.fsEvents.push({collection:a,token:r})}}},i.prototype._disconnectFeatureSetChanges=function(e){for(var t=e?e.featureSets.getRange(0):null,i=0;i<this._handles.fsEvents.length;i++){var s=this._handles.fsEvents[i];!s.collection||t&&t.some(function(e){return e.features===s.collection})||(s.collection.unbind(s.token),this._handles.fsEvents.splice(i,1),i--)}},i.prototype._movePushpinsToFront=function(){if(this._pushpinsLayer){var e=this.app.map.graphicsLayerIds.length-1;null!=this.app.map.getLayer(this._pushpinsLayer.id)&&this.app.map.graphicsLayerIds[e]!==this._pushpinsLayer.id&&(this._disconnectMapEvents(),this.app.map.reorderLayer(this._pushpinsLayer,e),this._connectMapEvents(this.app.map))}},i.prototype._wireUpConfiguredEventHandler=function(e,t){var i=this;return this.app.event(e).subscribe(this,function(e){var s=null;e&&(e instanceof esri.Graphic?s=i._getBackingFeature(e):e instanceof a.Feature&&(s=e)),i._executeMappedCommands(t,s)})},i.prototype._executeMappedCommands=function(e,t){if("string"==typeof e)this.app.command(e).execute(t);else if(e instanceof Array)for(var i=0;i<e.length;i++)this.app.command(e[i]).execute(t)},i.prototype._getPushpinsLayer=function(){return this._pushpinsLayer||(this._pushpinsLayer=h.getInternalGraphicsLayer(i.PUSHPINS_GRAPHICS_LAYER_ID,this.app,h.GraphicsLayerType.Pushpin),this._attachMouseEventHandlers(this._pushpinsLayer),this._pushpinsLayer.hide()),this._pushpinsLayer},i.prototype._attachMouseEventHandlers=function(e){var t=this,i=e.getNode();$(i).on("click",function(e){t._getGraphicFromJQueryEvent(e,function(i){t.app.event("PushpinClickedEvent").publish(i),"function"==typeof e.preventDefault&&"function"==typeof e.stopPropagation&&(e.preventDefault(),e.stopPropagation())})}),$(i).on("mousedown",function(e){t._getGraphicFromJQueryEvent(e,function(i){0==e.button?t.app.event("PushpinMouseLeftButtonDownEvent").publish(i):2==e.button&&t.app.event("PushpinMouseRightButtonDownEvent").publish(i)})}),$(i).on("mouseup",function(e){t._getGraphicFromJQueryEvent(e,function(i){0==e.button?t.app.event("PushpinMouseLeftButtonUpEvent").publish(i):2==e.button&&t.app.event("PushpinMouseRightButtonUpEvent").publish(i)})}),$(i).on("mouseenter",function(e){t._getGraphicFromJQueryEvent(e,function(e){t.app.event("PushpinMouseEnterEvent").publish(e)})}),$(i).on("mouseleave",function(e){t._getGraphicFromJQueryEvent(e,function(e){t.app.event("PushpinMouseLeaveEvent").publish(e)})}),this._linkBehaviorsToEvents()},i.prototype._linkBehaviorsToEvents=function(){var e=this;this.app.event("PushpinClickedEvent").subscribe(this,function(t){var i=t.attributes[e.FEATURE_PROPERTY];i&&i.esriFeature.get()&&i.esriFeature.get().attributes&&e.app.behavior("PushpinClickedBehavior").run(t.attributes[e.FEATURE_PROPERTY])}),this.app.event("PushpinMouseLeftButtonDownEvent").subscribe(this,function(t){var i=t.attributes[e.FEATURE_PROPERTY];i&&i.esriFeature.get()&&i.esriFeature.get().attributes&&e.app.behavior("PushpinMouseLeftButtonDownBehavior").run(t.attributes[e.FEATURE_PROPERTY])}),this.app.event("PushpinMouseRightButtonDownEvent").subscribe(this,function(t){var i=t.attributes[e.FEATURE_PROPERTY];i&&i.esriFeature.get()&&i.esriFeature.get().attributes&&e.app.behavior("PushpinMouseRightButtonDownBehavior").run(t.attributes[e.FEATURE_PROPERTY])}),this.app.event("PushpinMouseLeftButtonUpEvent").subscribe(this,function(t){var i=t.attributes[e.FEATURE_PROPERTY];i&&i.esriFeature.get()&&i.esriFeature.get().attributes&&e.app.behavior("PushpinMouseLeftButtonUpBehavior").run(t.attributes[e.FEATURE_PROPERTY])}),this.app.event("PushpinMouseRightButtonUpEvent").subscribe(this,function(t){var i=t.attributes[e.FEATURE_PROPERTY];i&&i.esriFeature.get()&&i.esriFeature.get().attributes&&e.app.behavior("PushpinMouseRightButtonUpBehavior").run(t.attributes[e.FEATURE_PROPERTY])}),this.app.event("PushpinMouseEnterEvent").subscribe(this,function(t){var i=t.attributes[e.FEATURE_PROPERTY];i&&i.esriFeature.get()&&i.esriFeature.get().attributes&&e.app.behavior("PushpinMouseEnterBehavior").run(t.attributes[e.FEATURE_PROPERTY])}),this.app.event("PushpinMouseLeaveEvent").subscribe(this,function(t){var i=t.attributes[e.FEATURE_PROPERTY];i&&i.esriFeature.get()&&i.esriFeature.get().attributes&&e.app.behavior("PushpinMouseLeaveBehavior").run(t.attributes[e.FEATURE_PROPERTY])})},i.prototype._getGraphicFromJQueryEvent=function(e,t){if(e.originalEvent){var i=e.originalEvent.graphic;null!==i&&void 0!==i||!e.originalEvent.srcElement||(i=e.originalEvent.srcElement.e_graphic),-1!=$.inArray(i,this._pushpinsLayer.graphics)&&t(i)}},i.prototype._handleCollectionChanged=function(e){if(!this.app.project.isLoading&&(this._clearPushpinsLayer(),this._disconnectFeatureSetChanges(e),e&&e.featureSets.getLength()>0)){if(!1===e.getExtendedPropertyByName("ShowPushpins"))return;for(var t=0;t<e.featureSets.getLength();t++)this._addPushpinsForFS(e.featureSets.getAt(t));this._orderPushpinCollection(),this._connectFeatureSetChanges(e)}},i.prototype._featureSetChanged=function(e,t){if(!this.app.project.isLoading&&this.isReady()&&this.featureSetCollection.get()&&e&&e==this.featureSetCollection.get().id)if("append"===t.type||"insert"===t.type){for(var i=t.rangeStart;i<=t.rangeEnd;i++){var s=t.sender.getAt(i);this._addPushpin(s)}this._orderPushpinCollection()}else if("remove"===t.type||"clear"===t.type){var n=this.featureSetCollection.get().featureSets;setTimeout(function(){return n.pulse()},0)}},i.prototype._fsmCollectionRemovedEventHandler=function(e){this.app.project.isLoading||this.featureSetCollection.get()&&e&&e.featureSetCollectionId&&e.featureSetCollectionId==this.featureSetCollection.get().id&&(this._disconnectFeatureSetChanges(),this._clearPushpinsLayer(),this.featureSetCollection.set(null))},i.prototype._addPushpinsForFS=function(e){if(e&&e.features)for(var t=0;t<e.features.getLength();t++)this._addPushpin(e.features.getAt(t))},i.prototype._addPushpin=function(e,t){if(void 0===t&&(t=!1),e){var i,s;if(p.isPushpinArgs(e)?(i=e.feature,s=e.tag):(i=e,s="Default"),(!i||!i.esriFeature.get()||i.esriFeature.get()!==this._graphicInEditMode)&&(this.isReady()||t)&&i&&i.esriFeature.get()&&i.hasValidGeometry.get()){var n=r.getMiddle(i.esriFeature.get().geometry);if(n){var a=new esri.Graphic(n,this._cachedSymbol,{});a.attributes[this.FEATURE_PROPERTY]=i,a.attributes[this.TAG_PROPERTY]=s,this._getPushpinsLayer().add(a)}}}},i.prototype._executeRemovePushpin=function(e){var t=this;if(e){var i,s;p.isPushpinArgs(e)?(i=e.feature,s=e.tag):(i=e,s="Default");var n=i instanceof a.Feature?i.esriFeature.get():i;if(this.isReady()&&n){var r=this._getPushpinsLayer();r.graphics.filter(function(e){return function(e){var a=e.attributes[t.FEATURE_PROPERTY];return e.attributes[t.TAG_PROPERTY]===s&&(a===i||!!o.esriFeaturesEqual(n,a.esriFeature.get()))}(e)}).forEach(function(e){return t._removePushpin(e,r)})}}},i.prototype._getBackingFeature=function(e){return e&&e.getLayer()&&e.getLayer().id===i.PUSHPINS_GRAPHICS_LAYER_ID&&e.attributes&&e.attributes.hasOwnProperty(this.FEATURE_PROPERTY)?e.attributes[this.FEATURE_PROPERTY]:null},i.prototype._orderPushpinCollection=function(){var e=this._getPushpinsLayer().graphics.slice(0);e&&e.length>0&&(e.sort(function(e,t){var i=e.geometry,s=t.geometry;return null==i&&null==s?0:null==i?s.y-0||0-s.x:null==s?0-i.y||i.x-0:s.y-i.y||i.x-s.x}),dojo.forEach(e,function(e,t){var i=e?e.getShape():null;i&&"function"==typeof i.moveToFront&&i.moveToFront()}))},i.prototype._getPushpinSymbolAsync=function(e,t,i,s,n){var a=this,r=new dojo.Deferred;return this._cachedSymbol&&this._cachedSymbol.url===e&&this._cachedSymbol.width===t&&this._cachedSymbol.height===i&&this._cachedSymbol.xoffset===s&&this._cachedSymbol.yoffset===n?r.resolve(this._cachedSymbol):this._checkImageExists(e).then(function(o){var p=null;o&&o.exists?(p=new esri.symbol.PictureMarkerSymbol(o.url,t||a.pushpinMarkerWidth,i||a.pushpinMarkerHeight)).setOffset(s||a.offsetX,n||a.offsetY):(a.app.trace.warning("Could not load pushpin image at {0}. The default marker image will be used.".format(e)),p=a._defaultPushpinSymbol),r.resolve(p)},function(t){a.app.trace.warning("Could not load pushpin image at {0}. The default marker image will be used.".format(e)),r.resolve(a._defaultPushpinSymbol)}),r},i.prototype._checkImageExists=function(e){var t=this,i=new dojo.Deferred;if(!e||this._imageUrlErrors[e])i.resolve({url:e,exists:!1});else{var s=new Image;s.onload=function(){i.resolve({url:e,exists:!0})},s.onerror=function(){t._imageUrlErrors[e]=!0,i.resolve({url:e,exists:!1})},s.src=e,s.complete&&(s.onload=null,i.resolve({url:e,exists:!0}))}return i},i.prototype._clearPushpinsLayer=function(e){var t=this,i=e||this._getPushpinsLayer();i&&(i.graphics.forEach(function(e){return t._removePushpin(e,i)}),i.clear())},i.prototype._removePushpin=function(e,t){e.attributes[this.FEATURE_PROPERTY]=null,e.attributes[this.TAG_PROPERTY]=null,t.remove(e)},i}(s.ModuleBase);l.DEFAULT_PUSHPIN_MARKER_URI="Resources/Images/Pushpins/map-marker-red-32.png",l.PUSHPINS_GRAPHICS_LAYER_ID=c.PUSHPINS_LAYER_ID,i.PushpinsModule=l})},"Mapping/modules/Pushpins/PushpinsState":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})}}}),require({cache:{}}),define(["Mapping/modules/Pushpins/PushpinsModule"],function(e){!function(e,t,i){if("string"==typeof e&&(i=t,t=e),void 0!==i)for(var s=t.split("."),n=null,a=window,r=0,o=s.length;r<o;r++)n=s[r],r==o-1?a[n]=i:a[n]||(a[n]={}),a=a[n];else console.warn("Undefined shim for: "+t)}(e,"geocortex.essentialsHtmlViewer.mapping.modules.pushpins.PushpinsModule",e.PushpinsModule)})}();