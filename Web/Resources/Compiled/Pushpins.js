require({cache:{"Mapping/modules/Pushpins/PushpinsModule":function(){var s,f=this&&this.__extends||(s=function(e,t){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}s(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)});define(["require","exports","geocortex/framework/application/ModuleBase","geocortex/framework/observables","geocortex/infrastructure/Feature","geocortex/infrastructure/GeometryUtils","geocortex/infrastructure/MapUtils","geocortex/infrastructure/commandArgs/PushpinArgs","geocortex/essentials/utilities/GraphicsLayerUtilities","geocortex/infrastructure/GraphicsLayerUtils","geocortex/infrastructure/GraphicsLayerIds"],function(e,t,i,s,r,o,p,u,n,a,h){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var c,l=(c=i.ModuleBase,f(d,c),d.prototype.initialize=function(e){var t=this;c.prototype.initialize.call(this,e),e&&(e.hasOwnProperty("pushpinsEnabled")&&(this.enabled=!!e.pushpinsEnabled),e.hasOwnProperty("pushpinsRemainVisible")&&(this.pushpinsRemainVisible=!!e.pushpinsRemainVisible),e.hasOwnProperty("pushpinMarkerUri")&&(this.pushpinMarkerUri=e.pushpinMarkerUri),e.hasOwnProperty("pushpinMarkerWidth")&&(this.pushpinMarkerWidth=parseInt(e.pushpinMarkerWidth,10)),e.hasOwnProperty("pushpinMarkerHeight")&&(this.pushpinMarkerHeight=parseInt(e.pushpinMarkerHeight,10)),e.hasOwnProperty("offsetX")&&(this.offsetX=parseInt(e.offsetX,10)),e.hasOwnProperty("offsetY")&&(this.offsetY=parseInt(e.offsetY,10)),e.hasOwnProperty("eventMappings")&&(this.eventMappings=e.eventMappings||{}),n.addToGraphicsLayerIdsToExclude([a.ExcludeFromEnum.ExportApplyStateName,a.ExcludeFromEnum.WebMapName],d.PUSHPINS_GRAPHICS_LAYER_ID)),this._initializePromise=this._getPushpinSymbolAsync(this.pushpinMarkerUri,this.pushpinMarkerWidth,this.pushpinMarkerHeight,this.offsetX,this.offsetY).then(function(e){t._cachedSymbol=e||t._defaultPushpinSymbol,t.initialized=!0,t.app.command("AddPushpin").raiseCanExecuteChanged(),t.app.command("AddPushpins").raiseCanExecuteChanged(),t.app.command("RemovePushpin").raiseCanExecuteChanged(),t.app.command("RemovePushpins").raiseCanExecuteChanged()}),this.app.command("ShowPushpins").raiseCanExecuteChanged(),this.app.command("HidePushpins").raiseCanExecuteChanged(),this.app.command("AddPushpin").raiseCanExecuteChanged(),this.app.command("AddPushpins").raiseCanExecuteChanged(),this.app.command("RemovePushpin").raiseCanExecuteChanged(),this.app.command("RemovePushpins").raiseCanExecuteChanged(),this.enabled?this.app.command("EnablePushpins").execute():this.app.command("DisablePushpins").execute()},d.prototype.getStateFilter=function(){return{enabled:!0,visible:!0,results:this.app.project.filter.featureSetCollection,pushpins:{item:this.app.project.filter.feature},resultsView:!0}},d.prototype.isReady=function(){return this.enabled&&(this.initialized||!!this._initializePromise)},d.prototype._registerCommands=function(){var t=this;this.app.command("EnablePushpins").register(this,this._executeEnablePushpins),this.app.command("DisablePushpins").register(this,this._executeDisablePushpins),this.app.command("ShowPushpins").register(this,this._executeShowPushpins,this.isReady),this.app.command("HidePushpins").register(this,this._executeHidePushpins,this.isReady),this.app.command("AddPushpin").register(this,this._addPushpin,this.isReady),this.app.command("AddPushpins").register(this,this._executeAddPushpins,this.isReady),this.app.command("RemovePushpin").register(this,this._executeRemovePushpin,this.isReady),this.app.command("RemovePushpins").register(this,this._executeRemovePushpins,this.isReady),this.app.event("GraphicEditActivatedEvent").subscribe(this,function(e){t._graphicInEditMode=e.graphic}),this.app.event("GraphicEditDeactivatedEvent").subscribe(this,function(e){t._graphicInEditMode=null})},d.prototype._subscribeAll=function(){var i=this;if(this._unsubscribeAll(),this._handles.appEvents=[],this._connectAppEvent("FSMCollectionRemovedEvent",this._fsmCollectionRemovedEventHandler),this._connectAppEvent("ResultsViewOpenedEvent",function(e){i._trackView(e),i.app.command("ShowPushpins").execute()}),this.pushpinsRemainVisible?this._connectAppEvent("ResultsViewClosedEvent",function(e){e&&e.id===i._activeViewId&&i.app.command("HidePushpins").execute()}):this._connectAppEvent("ResultsViewCollapsedEvent",function(e){e&&e.id===i._activeViewId&&i.app.command("HidePushpins").execute()}),this.eventMappings)for(var e in this.eventMappings)if(this.eventMappings.hasOwnProperty(e)){var t=this._wireUpConfiguredEventHandler(e,this.eventMappings[e]);this._handles.appEvents.push({eventName:e,token:t})}this._connectAppEvent("FeatureDeletedEvent",function(e){e&&i._executeRemovePushpin(e)}),this._connectAppEvent("GraphicRemovedEvent",function(e){if(e&&e.graphic){var t=e.graphic;i._executeRemovePushpin(t)}})},d.prototype._unsubscribeAll=function(){this._disconnectFeatureSetChanges(),this._disconnectAppEvents()},d.prototype._trackView=function(e){e&&(this._activeViewId=e.id)},d.prototype._executeEnablePushpins=function(){this.enabled=!0,this._subscribeAll(),this.app.command("ShowPushpins").raiseCanExecuteChanged(),this.app.command("HidePushpins").raiseCanExecuteChanged(),this.app.command("AddPushpin").raiseCanExecuteChanged(),this.app.command("AddPushpins").raiseCanExecuteChanged(),this.app.command("RemovePushpin").raiseCanExecuteChanged(),this.app.command("RemovePushpins").raiseCanExecuteChanged()},d.prototype._executeDisablePushpins=function(){if(this.enabled=!1,this._unsubscribeAll(),this.app.map){var e=this._getPushpinsLayer();this._clearPushpinsLayer(e),e.hide()}this.app.command("ShowPushpins").raiseCanExecuteChanged(),this.app.command("HidePushpins").raiseCanExecuteChanged(),this.app.command("AddPushpin").raiseCanExecuteChanged(),this.app.command("AddPushpins").raiseCanExecuteChanged(),this.app.command("RemovePushpin").raiseCanExecuteChanged(),this.app.command("RemovePushpins").raiseCanExecuteChanged()},d.prototype._executeShowPushpins=function(){this._setPushpinsVisibility(!0)},d.prototype._executeHidePushpins=function(){this._setPushpinsVisibility(!1)},d.prototype._executeAddPushpins=function(e){var t=this.app.featureSetManager.getCollectionById(e);this.featureSetCollection.set(t)},d.prototype._executeRemovePushpins=function(){this.featureSetCollection.set(null)},d.prototype._setPushpinsVisibility=function(e){this._getPushpinsLayer().setVisibility(e),this.app.command("ShowPushpins").raiseCanExecuteChanged(),this.app.command("HidePushpins").raiseCanExecuteChanged()},d.prototype._connectAppEvent=function(e,t){var i=this.app.event(e).subscribe(this,t);this._handles.appEvents.push({eventName:e,token:i})},d.prototype._disconnectAppEvents=function(){if(this._handles.appEvents)for(var e=0,t=this._handles.appEvents;e<t.length;e++){var i=t[e];this.app.event(i.eventName).unsubscribe(i.token)}this._handles.appEvents=null},d.prototype._connectMapEvents=function(e){var t=this;this._handles.mapEvents=[e.on("layer-add-result",function(e){t.initialized&&t.enabled&&e.layer&&t._pushpinsLayer&&e.layer.id!==t._pushpinsLayer.id&&t._movePushpinsToFront()}),e.on("layer-remove",function(e){t.initialized&&t.enabled&&e.layer&&t._pushpinsLayer&&e.layer.id!==t._pushpinsLayer.id&&t._movePushpinsToFront()}),e.on("layers-reordered",function(e){t.initialized&&t.enabled&&t._movePushpinsToFront()})]},d.prototype._disconnectMapEvents=function(){this._handles.mapEvents&&dojo.forEach(this._handles.mapEvents,function(e,t){e.remove()}),this._handles.mapEvents=null},d.prototype._connectFeatureSetChanges=function(a){for(var r=this,e=function(e){var t=a.id,i=a.featureSets.getAt(e),s=i&&i.features;if(!o._handles.fsEvents.some(function(e){return e.collection===s})){var n=s.bind(o,function(e){return r._featureSetChanged(t,e)});o._handles.fsEvents.push({collection:s,token:n})}},o=this,t=0;t<a.featureSets.getLength();t++)e(t)},d.prototype._disconnectFeatureSetChanges=function(e){for(var i,s=e?e.featureSets.getRange(0):null,t=function(e){var t=n._handles.fsEvents[e];!t.collection||s&&s.some(function(e){return e.features===t.collection})||(t.collection.unbind(t.token),n._handles.fsEvents.splice(e,1),e--),i=e},n=this,a=0;a<this._handles.fsEvents.length;a++)t(a),a=i},d.prototype._movePushpinsToFront=function(){if(this._pushpinsLayer){var e=this.app.map.graphicsLayerIds.length-1;null!=this.app.map.getLayer(this._pushpinsLayer.id)&&this.app.map.graphicsLayerIds[e]!==this._pushpinsLayer.id&&(this._disconnectMapEvents(),this.app.map.reorderLayer(this._pushpinsLayer,e),this._connectMapEvents(this.app.map))}},d.prototype._wireUpConfiguredEventHandler=function(e,i){var s=this;return this.app.event(e).subscribe(this,function(e){var t=null;e&&(e instanceof esri.Graphic?t=s._getBackingFeature(e):e instanceof r.Feature&&(t=e)),s._executeMappedCommands(i,t)})},d.prototype._executeMappedCommands=function(e,t){if("string"==typeof e)this.app.command(e).execute(t);else if(e instanceof Array)for(var i=0,s=e;i<s.length;i++){var n=s[i];this.app.command(n).execute(t)}},d.prototype._getPushpinsLayer=function(){return this._pushpinsLayer||(this._pushpinsLayer=a.getInternalGraphicsLayer(d.PUSHPINS_GRAPHICS_LAYER_ID,this.app,a.GraphicsLayerType.Pushpin),this._attachMouseEventHandlers(this._pushpinsLayer),this._pushpinsLayer.hide()),this._pushpinsLayer},d.prototype._attachMouseEventHandlers=function(e){var i=this,t=e.getNode();$(t).on("click",function(t){i._getGraphicFromJQueryEvent(t,function(e){i.app.event("PushpinClickedEvent").publish(e),"function"==typeof t.preventDefault&&"function"==typeof t.stopPropagation&&(t.preventDefault(),t.stopPropagation())})}),$(t).on("mousedown",function(t){i._getGraphicFromJQueryEvent(t,function(e){0===t.button?i.app.event("PushpinMouseLeftButtonDownEvent").publish(e):2===t.button&&i.app.event("PushpinMouseRightButtonDownEvent").publish(e)})}),$(t).on("mouseup",function(t){i._getGraphicFromJQueryEvent(t,function(e){0===t.button?i.app.event("PushpinMouseLeftButtonUpEvent").publish(e):2===t.button&&i.app.event("PushpinMouseRightButtonUpEvent").publish(e)})}),$(t).on("mouseenter",function(e){i._getGraphicFromJQueryEvent(e,function(e){i.app.event("PushpinMouseEnterEvent").publish(e)})}),$(t).on("mouseleave",function(e){i._getGraphicFromJQueryEvent(e,function(e){i.app.event("PushpinMouseLeaveEvent").publish(e)})}),this._linkBehaviorsToEvents()},d.prototype._linkBehaviorsToEvents=function(){var i=this;this.app.event("PushpinClickedEvent").subscribe(this,function(e){var t=e.attributes[i.FEATURE_PROPERTY];t&&t.esriFeature.get()&&t.esriFeature.get().attributes&&i.app.behavior("PushpinClickedBehavior").run(e.attributes[i.FEATURE_PROPERTY])}),this.app.event("PushpinMouseLeftButtonDownEvent").subscribe(this,function(e){var t=e.attributes[i.FEATURE_PROPERTY];t&&t.esriFeature.get()&&t.esriFeature.get().attributes&&i.app.behavior("PushpinMouseLeftButtonDownBehavior").run(e.attributes[i.FEATURE_PROPERTY])}),this.app.event("PushpinMouseRightButtonDownEvent").subscribe(this,function(e){var t=e.attributes[i.FEATURE_PROPERTY];t&&t.esriFeature.get()&&t.esriFeature.get().attributes&&i.app.behavior("PushpinMouseRightButtonDownBehavior").run(e.attributes[i.FEATURE_PROPERTY])}),this.app.event("PushpinMouseLeftButtonUpEvent").subscribe(this,function(e){var t=e.attributes[i.FEATURE_PROPERTY];t&&t.esriFeature.get()&&t.esriFeature.get().attributes&&i.app.behavior("PushpinMouseLeftButtonUpBehavior").run(e.attributes[i.FEATURE_PROPERTY])}),this.app.event("PushpinMouseRightButtonUpEvent").subscribe(this,function(e){var t=e.attributes[i.FEATURE_PROPERTY];t&&t.esriFeature.get()&&t.esriFeature.get().attributes&&i.app.behavior("PushpinMouseRightButtonUpBehavior").run(e.attributes[i.FEATURE_PROPERTY])}),this.app.event("PushpinMouseEnterEvent").subscribe(this,function(e){var t=e.attributes[i.FEATURE_PROPERTY];t&&t.esriFeature.get()&&t.esriFeature.get().attributes&&i.app.behavior("PushpinMouseEnterBehavior").run(e.attributes[i.FEATURE_PROPERTY])}),this.app.event("PushpinMouseLeaveEvent").subscribe(this,function(e){var t=e.attributes[i.FEATURE_PROPERTY];t&&t.esriFeature.get()&&t.esriFeature.get().attributes&&i.app.behavior("PushpinMouseLeaveBehavior").run(e.attributes[i.FEATURE_PROPERTY])})},d.prototype._getGraphicFromJQueryEvent=function(e,t){if(e.originalEvent){var i=e.originalEvent.graphic;null==i&&e.originalEvent.srcElement&&(i=e.originalEvent.srcElement.e_graphic),-1!==$.inArray(i,this._pushpinsLayer.graphics)&&t(i)}},d.prototype._handleCollectionChanged=function(e){if(!this.app.project.isLoading&&(this._clearPushpinsLayer(),this._disconnectFeatureSetChanges(e),e&&0<e.featureSets.getLength())){if(!1===e.getExtendedPropertyByName("ShowPushpins"))return;for(var t=0;t<e.featureSets.getLength();t++)this._addPushpinsForFS(e.featureSets.getAt(t));this._orderPushpinCollection(),this._connectFeatureSetChanges(e)}},d.prototype._featureSetChanged=function(e,t){if(!this.app.project.isLoading&&this.isReady()&&this.featureSetCollection.get()&&e&&e===this.featureSetCollection.get().id)if("append"===t.type||"insert"===t.type){for(var i=t.rangeStart;i<=t.rangeEnd;i++){var s=t.sender.getAt(i);this._addPushpin(s)}this._orderPushpinCollection()}else if("remove"===t.type||"clear"===t.type){var n=this.featureSetCollection.get().featureSets;setTimeout(function(){return n.pulse()},0)}},d.prototype._fsmCollectionRemovedEventHandler=function(e){this.app.project.isLoading||this.featureSetCollection.get()&&e&&e.featureSetCollectionId&&e.featureSetCollectionId===this.featureSetCollection.get().id&&(this._disconnectFeatureSetChanges(),this._clearPushpinsLayer(),this.featureSetCollection.set(null))},d.prototype._addPushpinsForFS=function(e){if(e&&e.features)for(var t=0;t<e.features.getLength();t++)this._addPushpin(e.features.getAt(t))},d.prototype._addPushpin=function(e,t){var i,s,n=this;if(void 0===t&&(t=!1),e)if(this.initialized||!this._initializePromise){if(s=u.isPushpinArgs(e)?(i=e.feature,e.tag):(i=e,"Default"),(!i||!i.esriFeature.get()||i.esriFeature.get()!==this._graphicInEditMode)&&(this.isReady()||t)&&i&&i.esriFeature.get()&&i.hasValidGeometry.get()){var a=o.getMiddle(i.esriFeature.get().geometry);if(a){var r=new esri.Graphic(a,this._cachedSymbol,{});r.attributes[this.FEATURE_PROPERTY]=i,r.attributes[this.TAG_PROPERTY]=s,this._getPushpinsLayer().add(r)}}}else this._initializePromise.then(function(){return n._addPushpin(e,t)})},d.prototype._executeRemovePushpin=function(e){var i=this;if(e){var s,n;n=u.isPushpinArgs(e)?(s=e.feature,e.tag):(s=e,"Default");var a=s instanceof r.Feature?s.esriFeature.get():s;if(this.isReady()&&a){var t=this._getPushpinsLayer();t.graphics.filter(function(e){return function(e){var t=e.attributes[i.FEATURE_PROPERTY];return e.attributes[i.TAG_PROPERTY]===n&&(t===s||!!p.esriFeaturesEqual(a,t.esriFeature.get()))}(e)}).forEach(function(e){return i._removePushpin(e,t)})}}},d.prototype._getBackingFeature=function(e){return e&&e.getLayer()&&e.getLayer().id===d.PUSHPINS_GRAPHICS_LAYER_ID&&e.attributes&&e.attributes.hasOwnProperty(this.FEATURE_PROPERTY)?e.attributes[this.FEATURE_PROPERTY]:null},d.prototype._orderPushpinCollection=function(){var e=this._getPushpinsLayer().graphics.slice(0);e&&0<e.length&&(e.sort(function(e,t){var i=e.geometry,s=t.geometry;return null==i&&null==s?0:null==i?s.y-0||0-s.x:null==s?0-i.y||i.x-0:s.y-i.y||i.x-s.x}),dojo.forEach(e,function(e,t){var i=e?e.getShape():null;i&&"function"==typeof i.moveToFront&&i.moveToFront()}))},d.prototype._getPushpinSymbolAsync=function(i,s,n,a,r){var o=this,p=new dojo.Deferred;return this._cachedSymbol&&this._cachedSymbol.url===i&&this._cachedSymbol.width===s&&this._cachedSymbol.height===n&&this._cachedSymbol.xoffset===a&&this._cachedSymbol.yoffset===r?p.resolve(this._cachedSymbol):this._checkImageExists(i).then(function(e){var t=null;e&&e.exists?(t=new esri.symbol.PictureMarkerSymbol(e.url,s||o.pushpinMarkerWidth,n||o.pushpinMarkerHeight)).setOffset(a||o.offsetX,r||o.offsetY):(o.app.trace.warning("Could not load pushpin image at {0}. The default marker image will be used.".format(i)),t=o._defaultPushpinSymbol),p.resolve(t)},function(e){o.app.trace.warning("Could not load pushpin image at {0}. The default marker image will be used.".format(i)),p.resolve(o._defaultPushpinSymbol)}),p},d.prototype._checkImageExists=function(e){var t=this,i=new dojo.Deferred;if(!e||this._imageUrlErrors[e])i.resolve({url:e,exists:!1});else{var s=new Image;s.onload=function(){i.resolve({url:e,exists:!0})},s.onerror=function(){t._imageUrlErrors[e]=!0,i.resolve({url:e,exists:!1})},s.src=e,s.complete&&(s.onload=null,i.resolve({url:e,exists:!0}))}return i},d.prototype._clearPushpinsLayer=function(e){var t=this,i=e||this._getPushpinsLayer();i&&(i.graphics.forEach(function(e){return t._removePushpin(e,i)}),i.clear())},d.prototype._removePushpin=function(e,t){e.attributes[this.FEATURE_PROPERTY]=null,e.attributes[this.TAG_PROPERTY]=null,t.remove(e)},d.DEFAULT_PUSHPIN_MARKER_URI="Resources/Images/Pushpins/map-marker-red-32.png",d.PUSHPINS_GRAPHICS_LAYER_ID=h.PUSHPINS_LAYER_ID,d);function d(e,t){var i=c.call(this,e,t)||this;return i.FEATURE_PROPERTY="__Feature__",i.TAG_PROPERTY="__Tag__",i._handles=null,i._cachedSymbol=null,i._defaultPushpinSymbol=null,i._pushpinsLayer=null,i._initializePromise=null,i._activeViewId=null,i._imageUrlErrors={},i._graphicInEditMode=null,i.initialized=!1,i.enabled=!0,i.pushpinsRemainVisible=!0,i.pushpinMarkerUri=d.DEFAULT_PUSHPIN_MARKER_URI,i.pushpinMarkerWidth=32,i.pushpinMarkerHeight=32,i.offsetX=0,i.offsetY=16,i._handles={appEvents:null,mapEvents:null,fsEvents:[]},i.featureSetCollection=new s.Observable,i.featureSetCollection.bind(i,i._handleCollectionChanged),i._defaultPushpinSymbol=new esri.symbol.PictureMarkerSymbol(d.DEFAULT_PUSHPIN_MARKER_URI,32,32),i._defaultPushpinSymbol.setOffset(0,16),i._registerCommands(),i}t.PushpinsModule=l})},"Mapping/modules/Pushpins/PushpinsState":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})}}}),require({cache:{}}),define(["Mapping/modules/Pushpins/PushpinsModule"],function(e){!function(e,t,i){if("string"==typeof e&&(i=t,t=e),void 0!==i)for(var s=t.split("."),n=null,a=window,r=0,o=s.length;r<o;r++)n=s[r],r==o-1?a[n]=i:a[n]||(a[n]={}),a=a[n];else console.warn("Undefined shim for: "+t)}(e,"geocortex.essentialsHtmlViewer.mapping.modules.pushpins.PushpinsModule",e.PushpinsModule)});