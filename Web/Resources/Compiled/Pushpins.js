function shim(e,t,i){if("string"==typeof e&&(i=t,t=e),"undefined"==typeof i)return void console.warn("Undefined shim for: "+t);for(var s=t.split("."),n=null,a=window,r=0,p=s.length;r<p;r++)n=s[r],r==p-1?a[n]=i:a[n]||(a[n]={}),a=a[n]}require({cache:{"Mapping/modules/Pushpins/PushpinsModule":function(){define(["require","exports","geocortex/framework/application/ModuleBase","geocortex/framework/observables","geocortex/infrastructure/Feature","geocortex/infrastructure/GeometryUtils","geocortex/infrastructure/MapUtils","geocortex/infrastructure/commandArgs/PushpinArgs","geocortex/essentials/utilities/GraphicsLayerUtilities","geocortex/infrastructure/GraphicsLayerUtils","geocortex/infrastructure/GraphicsLayerIds"],function(e,t,i,s,n,a,r,p,o,u,h){"use strict";var c=function(e){function t(i,n){var a=e.call(this,i,n)||this;return a.FEATURE_PROPERTY="__Feature__",a.TAG_PROPERTY="__Tag__",a._handles=null,a._cachedSymbol=null,a._defaultPushpinSymbol=null,a._pushpinsLayer=null,a._initializePromise=null,a._activeViewId=null,a._imageUrlErrors={},a._graphicInEditMode=null,a.initialized=!1,a.enabled=!0,a.pushpinsRemainVisible=!0,a.pushpinMarkerUri=t.DEFAULT_PUSHPIN_MARKER_URI,a.pushpinMarkerWidth=32,a.pushpinMarkerHeight=32,a.offsetX=0,a.offsetY=16,a._handles={appEvents:null,mapEvents:null,fsEvents:[]},a.featureSetCollection=new s.Observable,a.featureSetCollection.bind(a,a._handleCollectionChanged),a._defaultPushpinSymbol=new esri.symbol.PictureMarkerSymbol(t.DEFAULT_PUSHPIN_MARKER_URI,32,32),a._defaultPushpinSymbol.setOffset(0,16),a._registerCommands(),a}return __extends(t,e),t.prototype.initialize=function(i){var s=this;e.prototype.initialize.call(this,i),i&&(i.hasOwnProperty("pushpinsEnabled")&&(this.enabled=!!i.pushpinsEnabled),i.hasOwnProperty("pushpinsRemainVisible")&&(this.pushpinsRemainVisible=!!i.pushpinsRemainVisible),i.hasOwnProperty("pushpinMarkerUri")&&(this.pushpinMarkerUri=i.pushpinMarkerUri),i.hasOwnProperty("pushpinMarkerWidth")&&(this.pushpinMarkerWidth=parseInt(i.pushpinMarkerWidth)),i.hasOwnProperty("pushpinMarkerHeight")&&(this.pushpinMarkerHeight=parseInt(i.pushpinMarkerHeight)),i.hasOwnProperty("offsetX")&&(this.offsetX=parseInt(i.offsetX)),i.hasOwnProperty("offsetY")&&(this.offsetY=parseInt(i.offsetY)),i.hasOwnProperty("eventMappings")&&(this.eventMappings=i.eventMappings||{}),o.addToGraphicsLayerIdsToExclude([u.ExcludeFromEnum.ExportApplyStateName,u.ExcludeFromEnum.WebMapName],t.PUSHPINS_GRAPHICS_LAYER_ID)),this._initializePromise=this._getPushpinSymbolAsync(this.pushpinMarkerUri,this.pushpinMarkerWidth,this.pushpinMarkerHeight,this.offsetX,this.offsetY).then(function(e){s._cachedSymbol=e||s._defaultPushpinSymbol,s.initialized=!0,s.app.command("AddPushpin").raiseCanExecuteChanged(),s.app.command("AddPushpins").raiseCanExecuteChanged(),s.app.command("RemovePushpin").raiseCanExecuteChanged(),s.app.command("RemovePushpins").raiseCanExecuteChanged()}),this.app.command("ShowPushpins").raiseCanExecuteChanged(),this.app.command("HidePushpins").raiseCanExecuteChanged(),this.app.command("AddPushpin").raiseCanExecuteChanged(),this.app.command("AddPushpins").raiseCanExecuteChanged(),this.app.command("RemovePushpin").raiseCanExecuteChanged(),this.app.command("RemovePushpins").raiseCanExecuteChanged(),this.enabled?this.app.command("EnablePushpins").execute():this.app.command("DisablePushpins").execute()},t.prototype.getStateFilter=function(){return{enabled:!0,visible:!0,results:this.app.project.filter.featureSetCollection,pushpins:{item:this.app.project.filter.feature},resultsView:!0}},t.prototype.isReady=function(){return this.enabled&&this.initialized},t.prototype._registerCommands=function(){var e=this;this.app.command("EnablePushpins").register(this,this._executeEnablePushpins),this.app.command("DisablePushpins").register(this,this._executeDisablePushpins),this.app.command("ShowPushpins").register(this,this._executeShowPushpins,this.isReady),this.app.command("HidePushpins").register(this,this._executeHidePushpins,this.isReady),this.app.command("AddPushpin").register(this,this._addPushpin,this.isReady),this.app.command("AddPushpins").register(this,this._executeAddPushpins,this.isReady),this.app.command("RemovePushpin").register(this,this._executeRemovePushpin,this.isReady),this.app.command("RemovePushpins").register(this,this._executeRemovePushpins,this.isReady),this.app.event("GraphicEditActivatedEvent").subscribe(this,function(t){e._graphicInEditMode=t.graphic}),this.app.event("GraphicEditDeactivatedEvent").subscribe(this,function(t){e._graphicInEditMode=null})},t.prototype._subscribeAll=function(){var e=this;if(this._unsubscribeAll(),this._handles.appEvents=[],this._connectAppEvent("FSMCollectionRemovedEvent",this._fsmCollectionRemovedEventHandler),this._connectAppEvent("ResultsViewOpenedEvent",function(t){e._trackView(t),e.app.command("ShowPushpins").execute()}),this.pushpinsRemainVisible?this._connectAppEvent("ResultsViewClosedEvent",function(t){t&&t.id===e._activeViewId&&e.app.command("HidePushpins").execute()}):this._connectAppEvent("ResultsViewCollapsedEvent",function(t){t&&t.id===e._activeViewId&&e.app.command("HidePushpins").execute()}),this.eventMappings)for(var t in this.eventMappings)if(this.eventMappings.hasOwnProperty(t)){var i=this._wireUpConfiguredEventHandler(t,this.eventMappings[t]);this._handles.appEvents.push({eventName:t,token:i})}this._connectAppEvent("FeatureDeletedEvent",function(t){t&&e._executeRemovePushpin(t)}),this._connectAppEvent("GraphicRemovedEvent",function(t){if(t&&t.graphic){var i=t.graphic;e._executeRemovePushpin(i)}})},t.prototype._unsubscribeAll=function(){this._disconnectFeatureSetChanges(),this._disconnectAppEvents()},t.prototype._trackView=function(e){e&&(this._activeViewId=e.id)},t.prototype._executeEnablePushpins=function(){this.enabled=!0,this._subscribeAll(),this.app.command("ShowPushpins").raiseCanExecuteChanged(),this.app.command("HidePushpins").raiseCanExecuteChanged(),this.app.command("AddPushpin").raiseCanExecuteChanged(),this.app.command("AddPushpins").raiseCanExecuteChanged(),this.app.command("RemovePushpin").raiseCanExecuteChanged(),this.app.command("RemovePushpins").raiseCanExecuteChanged()},t.prototype._executeDisablePushpins=function(){if(this.enabled=!1,this._unsubscribeAll(),this.app.map){var e=this._getPushpinsLayer();this._clearPushpinsLayer(e),e.hide()}this.app.command("ShowPushpins").raiseCanExecuteChanged(),this.app.command("HidePushpins").raiseCanExecuteChanged(),this.app.command("AddPushpin").raiseCanExecuteChanged(),this.app.command("AddPushpins").raiseCanExecuteChanged(),this.app.command("RemovePushpin").raiseCanExecuteChanged(),this.app.command("RemovePushpins").raiseCanExecuteChanged()},t.prototype._executeShowPushpins=function(){this._setPushpinsVisibility(!0)},t.prototype._executeHidePushpins=function(){this._setPushpinsVisibility(!1)},t.prototype._executeAddPushpins=function(e){var t=this.app.featureSetManager.getCollectionById(e);this.featureSetCollection.set(t)},t.prototype._executeRemovePushpins=function(){this.featureSetCollection.set(null)},t.prototype._setPushpinsVisibility=function(e){this._getPushpinsLayer().setVisibility(e),this.app.command("ShowPushpins").raiseCanExecuteChanged(),this.app.command("HidePushpins").raiseCanExecuteChanged()},t.prototype._connectAppEvent=function(e,t){var i=this.app.event(e).subscribe(this,t);this._handles.appEvents.push({eventName:e,token:i})},t.prototype._disconnectAppEvents=function(){if(this._handles.appEvents)for(var e=0;e<this._handles.appEvents.length;e++){var t=this._handles.appEvents[e];this.app.event(t.eventName).unsubscribe(t.token)}this._handles.appEvents=null},t.prototype._connectMapEvents=function(e){var t=this;this._handles.mapEvents=[e.on("layer-add-result",function(e){t.initialized&&t.enabled&&e.layer&&t._pushpinsLayer&&e.layer.id!==t._pushpinsLayer.id&&t._movePushpinsToFront()}),e.on("layer-remove",function(e){t.initialized&&t.enabled&&e.layer&&t._pushpinsLayer&&e.layer.id!==t._pushpinsLayer.id&&t._movePushpinsToFront()}),e.on("layers-reordered",function(e){t.initialized&&t.enabled&&t._movePushpinsToFront()})]},t.prototype._disconnectMapEvents=function(){this._handles.mapEvents&&dojo.forEach(this._handles.mapEvents,function(e,t){e.remove()}),this._handles.mapEvents=null},t.prototype._connectFeatureSetChanges=function(e){for(var t=this,i=0;i<e.featureSets.getLength();i++){var s=e.id,n=e.featureSets.getAt(i),a=n&&n.features;if(!this._handles.fsEvents.some(function(e){return e.collection===a})){var r=a.bind(this,function(e){return t._featureSetChanged(s,e)});this._handles.fsEvents.push({collection:a,token:r})}}},t.prototype._disconnectFeatureSetChanges=function(e){for(var t=e?e.featureSets.getRange(0):null,i=0;i<this._handles.fsEvents.length;i++){var s=this._handles.fsEvents[i];!s.collection||t&&t.some(function(e){return e.features===s.collection})||(s.collection.unbind(s.token),this._handles.fsEvents.splice(i,1),i--)}},t.prototype._movePushpinsToFront=function(){if(this._pushpinsLayer){var e=this.app.map.graphicsLayerIds.length-1,t=null!=this.app.map.getLayer(this._pushpinsLayer.id);t&&this.app.map.graphicsLayerIds[e]!==this._pushpinsLayer.id&&(this._disconnectMapEvents(),this.app.map.reorderLayer(this._pushpinsLayer,e),this._connectMapEvents(this.app.map))}},t.prototype._wireUpConfiguredEventHandler=function(e,t){var i=this,s=this.app.event(e).subscribe(this,function(e){var s=null;e&&(e instanceof esri.Graphic?s=i._getBackingFeature(e):e instanceof n.Feature&&(s=e)),i._executeMappedCommands(t,s)});return s},t.prototype._executeMappedCommands=function(e,t){if("string"==typeof e)this.app.command(e).execute(t);else if(e instanceof Array)for(var i=0;i<e.length;i++)this.app.command(e[i]).execute(t)},t.prototype._getPushpinsLayer=function(){return this._pushpinsLayer||(this._pushpinsLayer=u.getInternalGraphicsLayer(t.PUSHPINS_GRAPHICS_LAYER_ID,this.app,u.GraphicsLayerType.Pushpin),this._attachMouseEventHandlers(this._pushpinsLayer),this._pushpinsLayer.hide()),this._pushpinsLayer},t.prototype._attachMouseEventHandlers=function(e){var t=this,i=e.getNode();$(i).on("click",function(e){t._getGraphicFromJQueryEvent(e,function(i){t.app.event("PushpinClickedEvent").publish(i),"function"==typeof e.preventDefault&&"function"==typeof e.stopPropagation&&(e.preventDefault(),e.stopPropagation())})}),$(i).on("mousedown",function(e){t._getGraphicFromJQueryEvent(e,function(i){0==e.button?t.app.event("PushpinMouseLeftButtonDownEvent").publish(i):2==e.button&&t.app.event("PushpinMouseRightButtonDownEvent").publish(i)})}),$(i).on("mouseup",function(e){t._getGraphicFromJQueryEvent(e,function(i){0==e.button?t.app.event("PushpinMouseLeftButtonUpEvent").publish(i):2==e.button&&t.app.event("PushpinMouseRightButtonUpEvent").publish(i)})}),$(i).on("mouseenter",function(e){t._getGraphicFromJQueryEvent(e,function(e){t.app.event("PushpinMouseEnterEvent").publish(e)})}),$(i).on("mouseleave",function(e){t._getGraphicFromJQueryEvent(e,function(e){t.app.event("PushpinMouseLeaveEvent").publish(e)})}),this._linkBehaviorsToEvents()},t.prototype._linkBehaviorsToEvents=function(){var e=this;this.app.event("PushpinClickedEvent").subscribe(this,function(t){var i=t.attributes[e.FEATURE_PROPERTY];i&&i.esriFeature.get()&&i.esriFeature.get().attributes&&e.app.behavior("PushpinClickedBehavior").run(t.attributes[e.FEATURE_PROPERTY])}),this.app.event("PushpinMouseLeftButtonDownEvent").subscribe(this,function(t){var i=t.attributes[e.FEATURE_PROPERTY];i&&i.esriFeature.get()&&i.esriFeature.get().attributes&&e.app.behavior("PushpinMouseLeftButtonDownBehavior").run(t.attributes[e.FEATURE_PROPERTY])}),this.app.event("PushpinMouseRightButtonDownEvent").subscribe(this,function(t){var i=t.attributes[e.FEATURE_PROPERTY];i&&i.esriFeature.get()&&i.esriFeature.get().attributes&&e.app.behavior("PushpinMouseRightButtonDownBehavior").run(t.attributes[e.FEATURE_PROPERTY])}),this.app.event("PushpinMouseLeftButtonUpEvent").subscribe(this,function(t){var i=t.attributes[e.FEATURE_PROPERTY];i&&i.esriFeature.get()&&i.esriFeature.get().attributes&&e.app.behavior("PushpinMouseLeftButtonUpBehavior").run(t.attributes[e.FEATURE_PROPERTY])}),this.app.event("PushpinMouseRightButtonUpEvent").subscribe(this,function(t){var i=t.attributes[e.FEATURE_PROPERTY];i&&i.esriFeature.get()&&i.esriFeature.get().attributes&&e.app.behavior("PushpinMouseRightButtonUpBehavior").run(t.attributes[e.FEATURE_PROPERTY])}),this.app.event("PushpinMouseEnterEvent").subscribe(this,function(t){var i=t.attributes[e.FEATURE_PROPERTY];i&&i.esriFeature.get()&&i.esriFeature.get().attributes&&e.app.behavior("PushpinMouseEnterBehavior").run(t.attributes[e.FEATURE_PROPERTY])}),this.app.event("PushpinMouseLeaveEvent").subscribe(this,function(t){var i=t.attributes[e.FEATURE_PROPERTY];i&&i.esriFeature.get()&&i.esriFeature.get().attributes&&e.app.behavior("PushpinMouseLeaveBehavior").run(t.attributes[e.FEATURE_PROPERTY])})},t.prototype._getGraphicFromJQueryEvent=function(e,t){if(e.originalEvent){var i=e.originalEvent.graphic;null!==i&&"undefined"!=typeof i||!e.originalEvent.srcElement||(i=e.originalEvent.srcElement.e_graphic),$.inArray(i,this._pushpinsLayer.graphics)!=-1&&t(i)}},t.prototype._handleCollectionChanged=function(e){if(!this.app.project.isLoading&&(this._clearPushpinsLayer(),this._disconnectFeatureSetChanges(e),e&&e.featureSets.getLength()>0)){var t=e.getExtendedPropertyByName("ShowPushpins");if(t===!1)return;for(var i=0;i<e.featureSets.getLength();i++)this._addPushpinsForFS(e.featureSets.getAt(i));this._orderPushpinCollection(),this._connectFeatureSetChanges(e)}},t.prototype._featureSetChanged=function(e,t){if(!this.app.project.isLoading&&this.isReady()&&this.featureSetCollection.get()&&e&&e==this.featureSetCollection.get().id)if("append"===t.type||"insert"===t.type){for(var i=t.rangeStart;i<=t.rangeEnd;i++){var s=t.sender.getAt(i);this._addPushpin(s)}this._orderPushpinCollection()}else if("remove"===t.type||"clear"===t.type){var n=this.featureSetCollection.get().featureSets;setTimeout(function(){return n.pulse()},0)}},t.prototype._fsmCollectionRemovedEventHandler=function(e){this.app.project.isLoading||this.featureSetCollection.get()&&e&&e.featureSetCollectionId&&e.featureSetCollectionId==this.featureSetCollection.get().id&&(this._disconnectFeatureSetChanges(),this._clearPushpinsLayer(),this.featureSetCollection.set(null))},t.prototype._addPushpinsForFS=function(e){if(e&&e.features)for(var t=0;t<e.features.getLength();t++)this._addPushpin(e.features.getAt(t))},t.prototype._addPushpin=function(e,t){if(void 0===t&&(t=!1),e){var i,s;if(p.isPushpinArgs(e)?(i=e.feature,s=e.tag):(i=e,s="Default"),(!i||!i.esriFeature.get()||i.esriFeature.get()!==this._graphicInEditMode)&&(this.isReady()||t)&&i&&i.esriFeature.get()&&i.hasValidGeometry.get()){var n=a.getMiddle(i.esriFeature.get().geometry);if(n){var r=new esri.Graphic(n,this._cachedSymbol,{});r.attributes[this.FEATURE_PROPERTY]=i,r.attributes[this.TAG_PROPERTY]=s,this._getPushpinsLayer().add(r)}}}},t.prototype._executeRemovePushpin=function(e){var t=this;if(e){var i,s;p.isPushpinArgs(e)?(i=e.feature,s=e.tag):(i=e,s="Default");var a=i instanceof n.Feature?i.esriFeature.get():i;if(this.isReady()&&a){var o=function(e){var n=e.attributes[t.FEATURE_PROPERTY],p=e.attributes[t.TAG_PROPERTY];return p===s&&(n===i||!!r.esriFeaturesEqual(a,n.esriFeature.get()))},u=this._getPushpinsLayer(),h=u.graphics.filter(function(e){return o(e)});h.forEach(function(e){return t._removePushpin(e,u)})}}},t.prototype._getBackingFeature=function(e){return e&&e.getLayer()&&e.getLayer().id===t.PUSHPINS_GRAPHICS_LAYER_ID&&e.attributes&&e.attributes.hasOwnProperty(this.FEATURE_PROPERTY)?e.attributes[this.FEATURE_PROPERTY]:null},t.prototype._orderPushpinCollection=function(){var e=this._getPushpinsLayer().graphics.slice(0);e&&e.length>0&&(e.sort(function(e,t){var i=e.geometry,s=t.geometry;return null==i&&null==s?0:null==i?s.y-0||0-s.x:null==s?0-i.y||i.x-0:s.y-i.y||i.x-s.x}),dojo.forEach(e,function(e,t){var i=e?e.getShape():null;i&&"function"==typeof i.moveToFront&&i.moveToFront()}))},t.prototype._getPushpinSymbolAsync=function(e,t,i,s,n){var a=this,r=new dojo.Deferred;return this._cachedSymbol&&this._cachedSymbol.url===e&&this._cachedSymbol.width===t&&this._cachedSymbol.height===i&&this._cachedSymbol.xoffset===s&&this._cachedSymbol.yoffset===n?r.resolve(this._cachedSymbol):this._checkImageExists(e).then(function(p){var o=null;p&&p.exists?(o=new esri.symbol.PictureMarkerSymbol(p.url,t||a.pushpinMarkerWidth,i||a.pushpinMarkerHeight),o.setOffset(s||a.offsetX,n||a.offsetY)):(a.app.trace.warning("Could not load pushpin image at {0}. The default marker image will be used.".format(e)),o=a._defaultPushpinSymbol),r.resolve(o)},function(t){a.app.trace.warning("Could not load pushpin image at {0}. The default marker image will be used.".format(e)),r.resolve(a._defaultPushpinSymbol)}),r},t.prototype._checkImageExists=function(e){var t=this,i=new dojo.Deferred;if(!e||this._imageUrlErrors[e])i.resolve({url:e,exists:!1});else{var s=new Image;s.onload=function(){i.resolve({url:e,exists:!0})},s.onerror=function(){t._imageUrlErrors[e]=!0,i.resolve({url:e,exists:!1})},s.src=e,s.complete&&(s.onload=null,i.resolve({url:e,exists:!0}))}return i},t.prototype._clearPushpinsLayer=function(e){var t=this,i=e||this._getPushpinsLayer();i&&(i.graphics.forEach(function(e){return t._removePushpin(e,i)}),i.clear())},t.prototype._removePushpin=function(e,t){e.attributes[this.FEATURE_PROPERTY]=null,e.attributes[this.TAG_PROPERTY]=null,t.remove(e)},t}(i.ModuleBase);c.DEFAULT_PUSHPIN_MARKER_URI="Resources/Images/Pushpins/map-marker-red-32.png",c.PUSHPINS_GRAPHICS_LAYER_ID=h.PUSHPINS_LAYER_ID,t.PushpinsModule=c})},"Mapping/modules/Pushpins/PushpinsState":function(){define(["require","exports"],function(e,t){"use strict"})}}}),define(["Mapping/modules/Pushpins/PushpinsModule"],function(e){shim(e,"geocortex.essentialsHtmlViewer.mapping.modules.pushpins.PushpinsModule",e.PushpinsModule)});