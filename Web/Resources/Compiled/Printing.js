!function(){var t="<div class='printing'>    <div class='print-status' data-binding='{@visible: isPrinting}'>        <p data-binding='{@text: @language-is-printing}{@var: isPrintingText}'>...</p>    </div>    <div class='print-create' data-binding='{@hidden: printComplete}'>        <div class='print-status' data-binding='{@hidden: selectedTemplate}'>            <p data-binding='{@text: @language-no-print-template}'></p>        </div>        <div data-binding='{@hidden: isPrinting}{@visible: selectedTemplate}'>            <div data-binding='{@visible:previewIsEnabled}'>                <div class='form-btns' data-binding='{@visible:mobileMode}'>                    <button class='button print-center-button' data-binding='{@event-click: handleReCenterClick}{@text: @language-print-preview-center}'></button>                    <button class='button toggle-preview-button' data-binding='{@hidden: previewIsVisible}{@event-click: handleTogglePreviewClick}{@text: @language-print-show-preview-center}'></button>                    <button class='button toggle-preview-button' data-binding='{@visible: previewIsVisible}{@event-click: handleTogglePreviewClick}{@text: @language-print-hide-preview-center}'></button>                </div>            </div>            <label for='selectTemplate' data-binding='{@text: @language-select-layout}'></label>            <select id='selectTemplate' data-binding='{@source: printTemplates}{@value: selectedTemplate}{@event-onchange: handleTemplateSelectionChanged}'>                <option data-binding='{@template-for: printTemplates}{@text: displayName}{@attach: @context}'></option>            </select>            <label for='outputFormat' data-binding='{@text: @language-output-format}{@visible: outputFormats}'></label>            <select id='outputFormat' data-binding='{@source: outputFormats}{@value: selectedFormat}{@visible: outputFormats}'>                <option data-binding='{@template-for: outputFormats}{@text: @context}{@attach: @context}'></option>            </select>            <label for='resolution' data-binding='{@text: @language-resolution}{@visible: resolutions}'></label>            <select id='resolution' data-binding='{@source: resolutions}{@value: selectedResolution}{@visible: resolutions}'>                <option data-binding='{@template-for: resolutions}{@text: displayName}{@attach: @context}'></option>            </select>            <label for='grids' data-binding='{@text: @language-grid}{@visible: grids}'></label>            <select id='grids' data-binding='{@source: grids}{@value: selectedGrid}{@visible: grids}'>                <option data-binding='{@template-for: grids}{@text: displayName}{@attach: @context}'></option>            </select>            <label for='mapscale' data-binding='{@text: @language-map-scale}{@visible: scales}'></label>            <select id='mapscale' data-binding='{@source: scales}{@value: selectedScale}{@visible: scales}{@event-onchange: handleScaleSelectionChanged}'>                <option data-binding='{@template-for: scales}{@text: displayName}{@attach: @context}'></option>            </select>            <div data-binding='{@source: textFields}'>                <div data-binding='{@template-for: textFields}'>                    <label data-binding='{@hidden: multiline}'>                        <span data-binding='{@text: displayName}'></span>                        <input type='text' data-binding='{@value: value}{@hidden: multiline}' />                    </label>                    <label data-binding='{@visible: multiline}'>                        <span data-binding='{@text: displayName}'></span>                        <textarea cols='20' rows='4' data-binding='{@value: value}{@visible: multiline}'></textarea>                    </label>                </div>            </div>            <label for='printingEmailAddress' data-binding='{@text: @language-printing-email-address}{@visible: supportsEmailNotification}'></label>            <input id='printingEmailAddress' type='text' data-binding='{@value: emailAddress}{@visible: supportsEmailNotification}' />            <div class='form-btns'>                <div data-binding='{@visible:previewIsEnabled}'>                    <label class='print-preview-toggler' data-binding='{@hidden:mobileMode}'>                        <input type='checkbox' data-binding='{@value: printPreviewIsLocked}{disabled: printPreviewLockTogglerIsDisabled}' />                        <span data-binding='{@text: @language-print-preview-lock}'></span>                    </label>                </div>                <button class='button print-button' data-binding='{@event-click: handlePrintClick}{@text: @language-print}'></button>                <button class='button print-cancel-button' data-binding='{@event-click: handleCancelClick}{@text: @language-common-cancel}'></button>            </div>        </div>    </div>    <div class='print-complete' data-binding='{@visible: printComplete}'>        <div data-binding='{@hidden: supportsEmailNotification}'>            <p data-binding='{@text: @language-print-complete-description}'></p>            <div class='form-btns'>                <a class='button print-button' data-binding='{@event-click: handleOpenFileClick}{@text: @language-open-file}' target='_blank' href=''></a>            </div>        </div>        <div data-binding='{@visible: supportsEmailNotification}'>            <p data-binding='{@text: @language-printing-print-request-start-description}'></p>            <div data-binding='{@visible: validEmailAddressSupplied}'>                <p data-binding='{@text: @language-printing-print-request-description}'></p>            </div>            <div data-binding='{@hidden: validEmailAddressSupplied}'>                <p data-binding='{@text: @language-printing-print-request-status-description}'></p>                <div class='form-btns'>                    <a class='button print-button' data-binding='{@event-click: handleOpenFileClick}{@text: @language-printing-print-job-status}' target='_blank' href=''></a>                </div>            </div>        </div>    </div></div>",i="<div class='printing-peephole-container'>    <div class='printing-peephole' data-binding='{@var:peephole}'>        <img class='printing-peephole-img' data-binding='{alt: @language-printing-center-cross}' src='Resources/Images/center-cross-32.png' />    </div></div>";function a(e,t,i){if("string"==typeof e&&(i=t,t=e),void 0!==i)for(var n=t.split("."),a=null,r=window,s=0,o=n.length;s<o;s++)a=n[s],s==o-1?r[a]=i:r[a]||(r[a]={}),r=r[a];else console.warn("Undefined shim for: "+t)}require({cache:{"Mapping/modules/Printing/Printing5Client":function(){var n=this&&this.__awaiter||function(e,s,o,l){return new(o=o||Promise)(function(t,i){function n(e){try{r(l.next(e))}catch(e){i(e)}}function a(e){try{r(l.throw(e))}catch(e){i(e)}}function r(e){e.done?t(e.value):function(t){return t instanceof o?t:new o(function(e){e(t)})}(e.value).then(n,a)}r((l=l.apply(e,s||[])).next())})},d=this&&this.__generator||function(i,n){var a,r,s,e,o={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(a)throw new TypeError("Generator is already executing.");for(;o;)try{if(a=1,r&&(s=2&t[0]?r.return:t[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,t[1])).done)return s;switch(r=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return o.label++,{value:t[1],done:!1};case 5:o.label++,r=t[1],t=[0];continue;case 7:t=o.ops.pop(),o.trys.pop();continue;default:if(!(s=0<(s=o.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){o=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){o.label=t[1];break}if(6===t[0]&&o.label<s[1]){o.label=s[1],s=t;break}if(s&&o.label<s[2]){o.label=s[2],o.ops.push(t);break}s[2]&&o.ops.pop(),o.trys.pop();continue}t=n.call(i,o)}catch(e){t=[6,e],r=0}finally{a=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},c=this&&this.__spreadArrays||function(){for(var e=0,t=0,i=arguments.length;t<i;t++)e+=arguments[t].length;var n=Array(e),a=0;for(t=0;t<i;t++)for(var r=arguments[t],s=0,o=r.length;s<o;s++,a++)n[a]=r[s];return n};define(["require","exports","geocortex/infrastructure/GeometryUtils"],function(p,e,g){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var t=(i.runPrint=function(t,i,s,o){return n(this,void 0,void 0,function(){var n,a,r;return d(this,function(e){switch(e.label){case 0:return(n=t&&t.reportUrl?t.reportUrl:void 0)||Promise.reject(new Error("A report URL is required.")),s||Promise.reject("Report parameters are required"),a=i.site.getTokenFromPrincipal(n,esri.IdentityManagerBase),[4,this._marshalReportParameters(t,s,i,o)];case 1:return r=e.sent(),[2,new Promise(function(t,i){p(["Resources/Scripts/@geocortex/printing-api/index"],function(e){e.PrintManager.runPrint(n,r,a).then(function(e){t(e)}).catch(function(e){i(e)}).error(function(e){i(e)})})})]}})})},i.getMetadata=function(s,o,l){return n(this,void 0,void 0,function(){var n,a,r=this;return d(this,function(e){return s||Promise.resolve([]),n=s.reportUrl,String.isNullOrEmpty(n)&&Promise.resolve([]),a=o.site.getTokenFromPrincipal(n,esri.IdentityManagerBase),[2,new Promise(function(i,t){p(["Resources/Scripts/@geocortex/printing-api/index"],function(e){e.PrintManager.describeTemplate(n,a).then(function(e){r._setMainMapDimensions(s,e);var t=r._marshalTemplateParameters(e);r._addDefaultGrids(s,o,l),i(t)}).catch(function(e){t(e)}).error(function(e){t(e)})})})]})})},i._marshalTemplateParameters=function(e){var t=[];if(!e||!e.parameters)return t;for(var i=0,n=e.parameters;i<n.length;i++){var a=n[i],r={name:a.name,purpose:a.purpose,visible:a.visible,containsMultipleValues:a.containsMultipleValues,containsSingleValue:a.containsSingleValue,description:a.description,value:a.value,values:a.values,valueType:a.valueType};t.push(r)}return t},i._marshalReportParameters=function(s,o,l,p){return n(this,void 0,void 0,function(){var t,i,n,a,r;return d(this,function(e){switch(e.label){case 0:return t=s.templateParameters,i=o.resolution?o.resolution.dpi:96,n=this._marshalTextFieldParameters(t,o.fields),[4,this._marshalMainMapParameters(t,o,p,l)];case 1:return a=e.sent(),r=c(n,a),[2,{dpi:i,parameters:r}]}})})},i._marshalTextFieldParameters=function(e,t){var i=e.filter(function(e){return"Text"===e.purpose}),n=[];if(!t)return n;for(var a=0,r=t;a<r.length;a++)for(var s=r[a],o=0,l=i;o<l.length;o++){var p=l[o];if(s.id===p.name){var d={name:s.id,containsMultipleValues:!1,containsSingleValue:!0,value:s.value};n.push(d)}}return n},i._marshalMainMapParameters=function(e,t,i,n){var a=[];if(i&&i.operationalLayers||Promise.resolve(a),e&&0!==e.filter(function(e){return"_MainMap_itemid"===e.name}).length||Promise.resolve(a),0<e.filter(function(e){return"_MainMap_scale"===e.name}).length){var r={name:"_MainMap_scale",containsSingleValue:!0,value:parseFloat(t.scale.scale)||0};a.push(r)}if(0<e.filter(function(e){return"_MainMap_gridspatialreference"===e.name}).length){var s=void 0;if(t.grid){var o=t.grid.id;if("latLng"===o)s="4326";else if("measured"===o){var l=i.mapOptions.spatialReference;s=l.wkid?""+l.wkid:l.wkt}else s=void 0}else s=void 0;var p={name:"_MainMap_gridspatialreference",containsSingleValue:!0,value:s};a.push(p)}var d={operationalLayers:i.operationalLayers,spatialReference:i.mapOptions.spatialReference},c=t.customExtent;if(!c||isNaN(c.xmin)||isNaN(c.xmax)||isNaN(c.ymin)||isNaN(c.ymax)){var h=i.mapOptions.extent;c=new esri.geometry.Extent({xmin:h.xmin,xmax:h.xmax,ymin:h.ymin,ymax:h.ymax,spatialReference:h.spatialReference})}var u=new esri.SpatialReference(4326);return new Promise(function(i,t){g.projectGeometry(c,u,function(e){var t={$type:"Parameters.WebMap",name:"_MainMap_itemid",item:{type:"Web Map",extent:[[e.xmin,e.ymin],[e.xmax,e.ymax]]},itemData:d};a.push(t),i(a)},function(e){t(e)},n)})},i._addDefaultGrids=function(e,t,i){e&&(e.grids&&0!==e.grids.length||(e.grids=[{id:"measured",displayName:t.getResource(i,"language-printing-measure-units")},{id:"latLng",displayName:t.getResource(i,"language-printing-latitude-longitude")}]))},i._setMainMapDimensions=function(e,t){if(t&&t.controls)for(var i=0,n=t.controls;i<n.length;i++){var a=n[i];"Map"===a.controlType&&"MainMap.MapView"===a.purpose&&(e.mainMapHeight=this._convertMmToInches(a.height),e.mainMapWidth=e.mainMapWidth=this._convertMmToInches(a.width))}},i._convertMmToInches=function(e){return e/25.4},i);function i(){}e.Printing5Client=t})},"Mapping/modules/Printing/PrintingModule":function(){var n,s=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)});define(["require","exports","geocortex/framework/application/ModuleBase"],function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n,a=(n=i.ModuleBase,s(r,n),r);function r(){return null!==n&&n.apply(this,arguments)||this}t.PrintingModule=a})},"Mapping/modules/Printing/PrintingView":function(){var n,p=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)});define(["require","exports","geocortex/framework/ui/ViewBase","geocortex/infrastructure/DistanceConverter","geocortex/essentials/DistanceUnit","geocortex/infrastructure/MapUtils"],function(e,t,i,a,r,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n,s=(n=i.ViewBase,p(l,n),l.prototype.attach=function(e){var t=this;n.prototype.attach.call(this,e),this.viewModel.printPreviewIsLocked.bind(this,this.lockModeHasChanged),this.app.command("PrintMap").register(this,function(){t.viewModel.printComplete.set(!1),t.app.viewManager.activateView(t),t.app.configuration.mobileMode||t.initializePrintPreview()},function(){return t.app.site&&t.app.site.hasPrintTemplates&&t.viewModel.templatesAreInitialized.get()}),this.app.waitUntilApplicationReady().then(function(){t.siteInitializedEvent()})},l.prototype.siteInitializedEvent=function(){var n=this;this.app.site.essentialsMap.units&&this.viewModel.previewIsEnabled.set(a.canConvert(this.app.site.essentialsMap.units.type.replace("_",""),r.DistanceUnitType.INCHES)),this.viewModel.previewIsEnabled.get()&&(this.app.event("PrintTemplateStartedEvent").subscribe(this,this.hidePrintPreview),this.app.event("PrintTemplateCompletedEvent").subscribe(this,this.printTemplateCompletedEvent),this.app.configuration.mobileMode&&this.app.event("DataFrameOpenedEvent").subscribe(this,function(e){n.bottomPanelPercHeight=e;var t=document.body.clientHeight,i=t-t*e;n.adaptMapScale(i)})),this.viewModel.siteInitialized()},l.prototype.initializePrintPreview=function(){this.viewModel.previewIsEnabled.get()&&(this.viewModel.previewIsVisible.get()?this.addGraphicPrintPreview():(this.viewModel.setScales(this.viewModel.selectedTemplate.get()),this.viewModel.printPreviewIsLocked.set(!0),this.viewModel.graphic||this.addGraphicPrintPreview()))},l.prototype.activated=function(){this.viewIsActivated=!0,this.viewModel.printPreviewLockTogglerIsDisabled.set(!1)},l.prototype.deactivated=function(){this.viewIsActivated=!1,this.viewModel.previewIsEnabled.get()&&this.resetPrintPreview(),this.app.configuration.mobileMode||this.app.command("DeactivateView").execute("UnlockedPrintPreviewView")},l.prototype.printTemplateCompletedEvent=function(){this.viewModel.printPreviewIsLocked.get()&&this.addGraphicPrintPreview({scale:this.viewModel.printPreviewScale,extent:this.viewModel.printPreviewExtent})},l.prototype.handleTemplateSelectionChanged=function(e,t,i){this.viewModel.updatePrintTemplate(),this.viewModel.previewIsVisible.get()&&this.viewModel.previewIsEnabled.get()&&this.viewModel.printPreviewIsLocked.get()&&this.addGraphicPrintPreview(),this.app.event("PrintPreviewLayoutChangedEvent").publish()},l.prototype.handleScaleSelectionChanged=function(e,t,i){var n=this;return setTimeout(function(){n.viewModel.previewIsVisible.get()&&n.viewModel.previewIsEnabled.get()&&n.viewModel.printPreviewIsLocked.get()&&n.addGraphicPrintPreview();var e=parseFloat(n.viewModel.selectedScale.get().scale);e?(n.app.command("ZoomToScale").execute(e),n.viewModel.printPreviewLockTogglerIsDisabled.get()&&n.viewModel.printPreviewLockTogglerIsDisabled.set(!1)):(n.viewModel.printPreviewLockTogglerIsDisabled.set(!0),n.viewModel.printPreviewIsLocked.get()&&n.viewModel.printPreviewIsLocked.set(!1)),n.app.event("PrintPreviewScaleChangedEvent").publish()}),!0},l.prototype.handlePrintClick=function(e,t,i){var n=this;this.viewModel.performPrint(),setTimeout(function(){var e=$(n.isPrintingText).parent();$(n.isPrintingText).detach().appendTo(e)},1e3)},l.prototype.handleOpenFileClick=function(e,t,i){return t.href=this.viewModel.url.get(),this.viewModel.printComplete.set(!1),!0},l.prototype.lockModeHasChanged=function(e){this.viewModel.printPreviewIsLocked.get()?this.addGraphicPrintPreview({extent:this.viewModel.printPreviewExtent}):this.hidePrintPreview()},l.prototype.handleReCenterClick=function(e,t,i){this.viewModel.previewIsEnabled.get()&&this.addGraphicPrintPreview({adaptMapScale:this.app.configuration.mobileMode})},l.prototype.handleCancelClick=function(){this.app.viewManager.deactivateView(this)},l.prototype.handleTogglePreviewClick=function(){this.viewModel.previewIsVisible.get()?this.hidePrintPreview():this.viewModel.graphic?this.showPrintPreview():this.addGraphicPrintPreview({adaptMapScale:this.app.configuration.mobileMode})},l.prototype.resetPrintPreview=function(){this.hidePrintPreview(),this.viewModel.graphic=null,this.imageGraphic=null,this.viewModel.printPreviewExtent=null,this.viewModel.printPreviewScale=null},l.prototype.showPrintPreview=function(){this.viewModel.previewIsVisible.set(!0),this.viewModel.graphic&&this.app.map.graphics.add(this.viewModel.graphic),this.imageGraphic&&this.app.map.graphics.add(this.imageGraphic)},l.prototype.hidePrintPreview=function(){this.viewModel.previewIsVisible.set(!1),this.viewModel.graphic&&this.app.map.graphics.remove(this.viewModel.graphic),this.imageGraphic&&this.app.map.graphics.remove(this.imageGraphic)},l.prototype.addGraphicPrintPreview=function(e){e=e||{},this.resetPrintPreview();var t=e.extent?e.extent.getCenter():this.app.map.extent.getCenter(),i=e.scale?e.scale:parseFloat(this.viewModel.selectedScale.get().scale);i||(this.viewModel.printPreviewScale=null);var n,a=this.viewModel.calculateWidthAndHeightFromSelectedPrintTemplate(i);if(this.viewModel.graphic=this.viewModel.getGraphicFromPrintTemplate(t,a.width,a.height),this.app.map.graphics.add(this.viewModel.graphic),this.imageGraphic=new esri.Graphic,this.imageGraphic.setSymbol(this.viewModel.imageSymbol),this.imageGraphic.setGeometry(t),this.app.map.graphics.add(this.imageGraphic),this.imageGraphic.show(),this.viewModel.previewIsVisible.set(!0),this.viewModel.printPreviewExtent=this.viewModel.graphic.geometry.getExtent(),this.viewModel.printPreviewScale=i,this.app.configuration.mobileMode&&this.bottomPanelPercHeight){var r=document.body.clientHeight;n=r-r*this.bottomPanelPercHeight}else this.app.configuration.mobileMode||(n=this.app.map.height);e.adaptMapScale&&n&&this.adaptMapScale(n)},l.prototype.adaptMapScale=function(e){var t=this.app.map.getScale();if(o.getClosestScale(this.app.map,o.ScaleChangeMode.GreaterThan,t+1)!==t+1&&this.viewModel.graphic&&this.viewModel.previewIsVisible.get()){var i=this.viewModel.getGraphicPositionFromExtent(this.viewModel.printPreviewExtent),n=i.width>i.height?i.height:i.width,a=1,r=n/a,s=void 0;if(e<n){for(;e<r;)r/=a=(s=o.getClosestScale(this.app.map,o.ScaleChangeMode.GreaterThan,t+1))/t,t=s;this.app.command("ZoomToScale").execute(s)}}},l);function l(){return null!==n&&n.apply(this,arguments)||this}t.PrintingView=s})},"Mapping/modules/Printing/PrintingViewModel":function(){var n,w=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)});define(["require","exports","geocortex/framework/ui/ViewModelBase","geocortex/framework/observables","geocortex/essentials/TextField","geocortex/essentials/ReportParameters","geocortex/essentials/exportMap/ExportMapParameters","geocortex/essentials/exportMap/ExportMapTask","geocortex/infrastructure/DistanceConverter","geocortex/essentials/DistanceUnit","geocortex/essentials/Report","./Printing5Client","geocortex/framework/utils/ArrayUtils","geocortex/infrastructure/PromiseUtils"],function(e,t,i,l,s,o,p,d,a,r,c,h,u,g){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n,m=(n=i.ViewModelBase,w(v,n),v.prototype.initialize=function(e){var t=this,i=e.previewBackgroundColor||[207,76,64,.3],n=e.previewBorderColor||[128,128,128],a=e.previewBorderThickness||2;this.printPreviewSymbol=new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new esri.Color(n),a),new esri.Color(i));var r=e.previewCenterImageUrl||"Resources/Images/center-cross-32.png";this.imageSymbol=new esri.symbol.PictureMarkerSymbol(r,32,32),this.app.event("PrintPreviewLayoutChangedEvent").once(this,function(){return t.templateSelectionChanged=!0})},v.prototype.siteInitialized=function(){var a,r=this,e=[];if(this.app.site&&this.app.site.hasPrintTemplates){var t=this.app.site.printTemplates.filter(function(e){return e.type!==c.ReportType.MAP_URL_REPORT&&!0===e.visible});this.printTemplates.addItems(t);for(var i=this.printTemplates.getLength()-1;0<=i;i--)(s=this.printTemplates.getAt(i)).isDefault&&this.selectedTemplate.set(s);this.printTemplates.getLength()&&null===this.selectedTemplate.get()&&this.selectedTemplate.set(this.printTemplates.getAt(0)),this.selectedTemplate.get()&&(this.updatePrintTemplate(),this.isMapLoaded.set(!0),this.templatesAreInitialized.set(0<this.printTemplates.get().length),this.app.command("PrintMap").raiseCanExecuteChanged());var n=this.app.site.printTemplates.filter(function(e){return e.type===c.ReportType.MAP_URL_REPORT&&!0===e.visible});for(i=n.length-1;0<=i;i--){var s;if((s=n[i]).reportUrl){var o=this.initializeTemplate(s);e.push(o)}}g.PromiseUtils.allSkipRejected(e).then(function(e){for(var t=function(t){!0===t.isDefault&&(a=t);var e=r.app.site.printTemplates.indexOf(u.firstOrDefault(r.app.site.printTemplates.filter(function(e){return e.url===t.url})));r.printTemplates.insertItem(e,t)},i=0,n=e;i<n.length;i++)t(n[i]);a&&!r.templateSelectionChanged&&(r.selectedTemplate.set(a),r.updatePrintTemplate(),r.isMapLoaded.set(!0),r.templatesAreInitialized.set(0<r.printTemplates.get().length),r.app.command("PrintMap").raiseCanExecuteChanged())})}},v.prototype.performPrint=function(){var t=this;this.isPrinting.set(!0);var i=this.selectedTemplate.get();this.app.command("ScreenReaderNarrate").execute(this.app.getResource(this.libraryId,"language-is-printing"));var n=new o.ReportParameters;if(n.outputFormat=this.selectedFormat.get(),n.resolution=this.selectedResolution.get(),n.grid=this.selectedGrid.get(),n.fields=i.textFields,n.customExtent=this.printPreviewExtent,n.scale=this.selectedScale.get(),n.scale.scale){var e=parseFloat(n.scale.scale);n.scale.scale=e.toFixed(6)}""===n.scale.scale?n.extentType=o.ReportParameters.CURRENT_EXTENT:n.extentType=o.ReportParameters.CUSTOM_EXTENT,this.supportsEmailNotification.get()&&(String.isNullOrEmpty(this.emailAddress.get())?this.validEmailAddressSupplied.set(!1):(n.notificationEmailAddress=this.emailAddress.get(),this.validEmailAddressSupplied.set(!0))),this.app.event("PrintTemplateStartedEvent").publish(i);var a=new p.ExportMapParameters;a.reportParameters=n;var r=new d.ExportMapTask(i);i.type===c.ReportType.MAP_URL_REPORT?(""===n.scale.scale&&(n.scale.scale="0"),r.generateWebMapJson(a).then(function(e){h.Printing5Client.runPrint(i,t.app,n,e).then(function(e){t._printSuccess({href:e})},function(e){return t._printError(e)})})):r.generateMapImageUrl(a).then(function(e){return t._printSuccess(e)},function(e){return t._printError(e)})},v.prototype._printError=function(e){this.app.command("Alert").execute("Print error: "+e.message),this.app.command("ScreenReaderNarrate").execute("Print error: "+e.message),this.app.event("PrintTemplateErrorEvent").publish({name:"PrintTemplateError",message:e.message}),this.isPrinting.set(!1)},v.prototype._printSuccess=function(e){this.isPrinting.set(!1),this.url.set(e.href),this.printComplete.set(!0),this.app.command("ScreenReaderNarrate").execute(this.app.getResource(this.libraryId,"language-print-complete-description")),this.app.command("LogOptimizerEvent").execute("PrintMap",this.selectedTemplate.get().displayName),this.app.event("PrintTemplateCompletedEvent").publish(this.selectedTemplate.get())},v.prototype.updatePrintTemplate=function(){var e=this.selectedTemplate.get();e&&(this.setOutputFormats(e),this.setResolutions(e),this.setGrids(e),this.setScales(e),this.setTextFields(e),this.setEmailNotification(e))},v.prototype.setOutputFormats=function(e){this.outputFormats.clear(),e.supportedOutputFormats&&(this.outputFormats.addItems(e.supportedOutputFormats),e.defaultOutputFormat?this.selectedFormat.set(e.defaultOutputFormat):this.selectedFormat.set(this.outputFormats.getAt(0)))},v.prototype.setResolutions=function(e){this.resolutions.clear(),e.supportedResolutions&&(this.resolutions.addItems(e.supportedResolutions),e.defaultResolution?this.selectedResolution.set(e.defaultResolution):this.selectedResolution.set(this.resolutions.getAt(0)))},v.prototype.setGrids=function(e){if(this.grids.clear(),e.grids&&e.grids.length){var t=this.app.getResource(this.libraryId,"language-printing-none");this.grids.addItem({id:null,displayName:t}),this.grids.addItems(e.grids),e.defaultGrid?this.selectedGrid.set(e.defaultGrid):this.selectedGrid.set(this.grids.getAt(0))}},v.prototype.setScales=function(e){this.scales.clear();var t=this.app.getResource(this.libraryId,"language-printing-current-scale"),i=esri.geometry.getScale(this.app.map),n={displayName:t+" - 1: "+Math.round(i),scale:i.toString()};this.scales.addItem({displayName:t+" - 1: "+Math.round(i),scale:i.toString()});var a={displayName:this.app.getResource(this.libraryId,"language-printing-current-extent"),scale:""};this.scales.addItem(a),e.supportedMapScales&&e.supportedMapScales.length&&this.scales.addItems(e.supportedMapScales),this.selectedScale.set(this.scales.getAt(0)),e.defaultMapScale?this.selectedScale.set(e.defaultMapScale):e.defaultMapScaleName&&("Current Extent"===e.defaultMapScaleName?this.selectedScale.set(a):"Current Scale"===e.defaultMapScaleName&&this.selectedScale.set(n))},v.prototype.setTextFields=function(e){if(this.textFields.clear(),e.textFields&&0<e.textFields.length){for(var t=[],i=0,n=e.textFields;i<n.length;i++){var a=n[i],r={};for(var s in a)if(a.hasOwnProperty(s)){var o=this._setupObservablePrimitive(s,a);r[s]=o}t.push(new l.Observable(r))}this.textFields.addItems(t)}},v.prototype.adjustCustomExtent=function(e,t,i){var n,a=e.getWidth(),r=e.getHeight(),s=a/r,o=t/i;if(o!=s){var l=void 0,p=void 0;o<s?l=(p=a)/o:p=(l=r)*o;var d=e.getCenter(),c=p/2,h=l/2,u=d.x-c,g=d.y-h,m=d.x+c,v=d.y+h;n=new esri.geometry.Extent(u,g,m,v,e.spatialReference)}else n=e;return n},v.prototype.getGraphicFromPrintTemplate=function(e,t,i){var n=new esri.geometry.Polygon(this.app.map.spatialReference),a=new Array;return a.push(new esri.geometry.Point(e.x-t/2,e.y-i/2)),a.push(new esri.geometry.Point(e.x-t/2,e.y+i/2)),a.push(new esri.geometry.Point(e.x+t/2,e.y+i/2)),a.push(new esri.geometry.Point(e.x+t/2,e.y-i/2)),a.push(new esri.geometry.Point(e.x-t/2,e.y-i/2)),n.addRing(a),new esri.Graphic(n,this.printPreviewSymbol)},v.prototype.getGraphicPositionFromExtent=function(e){var t=this.app.map.toScreen(new esri.geometry.Point(e.xmin,e.ymax,this.app.map.spatialReference)),i=this.app.map.toScreen(new esri.geometry.Point(e.xmax,e.ymin,this.app.map.spatialReference));return{top:t.y,left:t.x,width:i.x-t.x,height:i.y-t.y}},v.prototype.calculateWidthAndHeightFromSelectedPrintTemplate=function(e){var t,i;if(e)t=a.convert(this.app.site.essentialsMap.units.type.replace("_",""),this.selectedTemplate.get().mainMapWidth*e,r.DistanceUnitType.INCHES),i=a.convert(this.app.site.essentialsMap.units.type.replace("_",""),this.selectedTemplate.get().mainMapHeight*e,r.DistanceUnitType.INCHES);else{var n=this.adjustCustomExtent(this.app.map.extent,this.selectedTemplate.get().mainMapWidth,this.selectedTemplate.get().mainMapHeight);t=n.getWidth(),i=n.getHeight()}return{width:t,height:i}},v.prototype.calculateExtentFromPrintTemplate=function(e,t){t=t||parseFloat(this.selectedScale.get().scale);var i=this.calculateWidthAndHeightFromSelectedPrintTemplate(t),n=new esri.geometry.Point(e.x-i.width/2,e.y+i.height/2),a=new esri.geometry.Point(e.x+i.width/2,e.y-i.height/2);return new esri.geometry.Extent(n.x,a.y,a.x,n.y,this.app.map.spatialReference)},v.prototype.initializeTemplate=function(n){var a=this;return new Promise(function(t,i){h.Printing5Client.getMetadata(n,a.app,a.libraryId).then(function(e){n.templateParameters=e,n.textFields=a._populateTextFields(e),t(n)}).catch(function(e){a.app.trace.warning(a.app.getResource(a.libraryId,"language-printing-metadata-error").format(n.id,n.reportUrl,e.message)),i(e)})})},v.prototype._setupObservablePrimitive=function(t,i){var n=new l.Observable(i[t]);return n.set=function(e){i[t]=e,n.value=e,n.bindingEvent.publish(e)},n.get=function(){return i[t]},n},v.prototype.setEmailNotification=function(e){this.supportsEmailNotification.set(e.supportsEmailNotification)},v.prototype._populateTextFields=function(e){var t=[];if(!e||0===e.length)return t;for(var i=0,n=e;i<n.length;i++){var a=n[i];if(a.containsSingleValue&&"string"===a.valueType&&"Text"===a.purpose){var r=this._createTextField(a);t.push(r)}}return t},v.prototype._createTextField=function(e){if("string"!==e.valueType)throw new Error("Invalid argument. Expected a string, received type "+e.valueType);var t=e.description,i=e.name,n="";if(e.containsSingleValue&&e.value)n=e.value;else if(e.containsMultipleValues&&e.values){var a=e.values,r=a[Object.keys(a)[0]];n=r||n}return new s.TextField(i,t,n,!1)},v);function v(e,t){var i=n.call(this,e,t)||this;return i.printTemplates=new l.ObservableCollection,i.outputFormats=new l.ObservableCollection,i.resolutions=new l.ObservableCollection,i.scales=new l.ObservableCollection,i.grids=new l.ObservableCollection,i.textFields=new l.ObservableCollection,i.textFied=new l.Observable(null),i.selectedTemplate=new l.Observable(null),i.selectedScale=new l.Observable(null),i.selectedResolution=new l.Observable(null),i.selectedFormat=new l.Observable(null),i.selectedGrid=new l.Observable(null),i.supportsEmailNotification=new l.Observable(!1),i.validEmailAddressSupplied=new l.Observable(!1),i.emailAddress=new l.Observable(null),i.isPrinting=new l.Observable(!1),i.printComplete=new l.Observable(!1),i.isMapLoaded=new l.Observable(!1),i.url=new l.Observable(null),i.previewIsVisible=new l.Observable(!1),i.printPreviewIsLocked=new l.Observable(!0),i.previewIsEnabled=new l.Observable(!1),i.printPreviewLockTogglerIsDisabled=new l.Observable(!1),i.templatesAreInitialized=new l.Observable(!1),i.mobileMode=new l.Observable(i.app.configuration.mobileMode),i.templateSelectionChanged=!1,i}t.PrintingViewModel=m})},"Mapping/modules/Printing/UnlockedPrintPreviewView":function(){var n,s=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)});define(["require","exports","geocortex/framework/ui/ViewBase"],function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n,a=(n=i.ViewBase,s(r,n),r.prototype.attach=function(e){var t=this;n.prototype.attach.call(this,e),this.peephole.style.borderWidth=this.viewModel.printPreviewSymbol.outline.width+"px",this.peephole.style.borderColor=this.viewModel.printPreviewSymbol.outline.color.toCss(!0),this.peephole.style.backgroundColor=this.viewModel.printPreviewSymbol.color.toCss(!0),this.viewModel.printPreviewIsLocked.bind(this,function(e){return t.setPeepholeVisibility(e)})},r.prototype.activated=function(){this.mapZoomStartedToken||(this.mapZoomStartedToken=this.app.event("MapZoomStartedEvent").subscribe(this,this.mapZoomStartedEvent)),this.mapZoomEndedToken||(this.mapZoomEndedToken=this.app.event("MapZoomEndedEvent").subscribe(this,this.handleMapZoomEvent)),this.mapExtentChangedToken||(this.mapExtentChangedToken=this.app.event("MapExtentChangedEvent").subscribe(this,this.setExtentFromPeepholePosition)),this.selectedScaleToken||(this.selectedScaleToken=this.app.event("PrintPreviewScaleChangedEvent").subscribe(this,this.printMapScaleHasChanged)),this.selectedTemplateToken||(this.selectedTemplateToken=this.app.event("PrintPreviewLayoutChangedEvent").subscribe(this,this.handleTemplateSelectionChanged)),this.calculatePeepholeDimensionsFromExtent(this.viewModel.printPreviewExtent)},r.prototype.deactivated=function(){this.mapZoomStartedToken&&(this.app.event("MapZoomStartedEvent").unsubscribe(this.mapZoomStartedToken),this.mapZoomStartedToken=null),this.mapZoomEndedToken&&(this.app.event("MapZoomEndedEvent").unsubscribe(this.mapZoomEndedToken),this.mapZoomEndedToken=null),this.mapExtentChangedToken&&(this.app.event("MapExtentChangedEvent").unsubscribe(this.mapExtentChangedToken),this.mapExtentChangedToken=null),this.selectedScaleToken&&(this.app.event("PrintPreviewScaleChangedEvent").unsubscribe(this.selectedScaleToken),this.selectedScaleToken=null),this.selectedTemplateToken&&(this.app.event("PrintPreviewLayoutChangedEvent").unsubscribe(this.selectedTemplateToken),this.selectedTemplateToken=null)},r.prototype.setPeepholeVisibility=function(e){e?this.app.command("DeactivateView").execute(this.id):this.app.command("ActivateView").execute(this.id)},r.prototype.handleTemplateSelectionChanged=function(){var e=this.viewModel.calculateExtentFromPrintTemplate(this.app.map.extent.getCenter());this.calculatePeepholeDimensionsFromExtent(e)},r.prototype.printMapScaleHasChanged=function(){var e,t=this,i=parseFloat(this.viewModel.selectedScale.get().scale);return i&&i.toFixed(2)!==this.app.map.getScale().toFixed(2)?this.app.event("MapZoomEndedEvent").once(this,function(){e=t.viewModel.calculateExtentFromPrintTemplate(t.app.map.extent.getCenter(),i),t.calculatePeepholeDimensionsFromExtent(e),t.viewModel.printPreviewExtent=e}):(e=i&&i.toFixed(2)===this.app.map.getScale().toFixed(2)?this.viewModel.calculateExtentFromPrintTemplate(this.app.map.extent.getCenter(),i):this.app.map.extent,this.calculatePeepholeDimensionsFromExtent(e),this.viewModel.printPreviewExtent=e),!0},r.prototype.mapZoomStartedEvent=function(){this.peephole.style.opacity="0"},r.prototype.handleMapZoomEvent=function(){var e=parseFloat(this.viewModel.selectedScale.get().scale);if(this.app.map.extent.contains(this.viewModel.printPreviewExtent)&&e){var t=this.viewModel.printPreviewExtent,i=this.viewModel.getGraphicPositionFromExtent(t);this.peephole.style.top=i.top+"px",this.peephole.style.left=i.left+"px",this.peephole.style.width=i.width+"px",this.peephole.style.height=i.height+"px"}else e?this.calculatePeepholeDimensionsFromExtent(this.viewModel.printPreviewExtent):this.calculatePeepholeDimensionsFromExtent(this.app.map.extent);this.peephole.style.opacity="1"},r.prototype.calculatePeepholeDimensionsFromExtent=function(e){var t=this.viewModel.getGraphicPositionFromExtent(e);if(this.app.map.extent.contains(this.viewModel.printPreviewExtent))this.peephole.style.top=t.top+"px",this.peephole.style.left=t.left+"px",this.peephole.style.width=t.width+"px",this.peephole.style.height=t.height+"px";else{var i=this.app.map.toScreen(this.app.map.extent.getCenter()),n=t.width,a=t.height,r=i.y-a/2,s=i.x-n/2;this.peephole.style.top=r+"px",this.peephole.style.left=s+"px",this.peephole.style.width=n+"px",this.peephole.style.height=a+"px",this.setExtentFromPeepholePosition()}},r.prototype.setExtentFromPeepholePosition=function(){var e=parseInt(this.peephole.style.top),t=parseInt(this.peephole.style.left),i=parseInt(this.peephole.style.width),n=parseInt(this.peephole.style.height),a=this.app.map.toMap({x:t,y:e}),r=this.app.map.toMap({x:t+i,y:e+n}),s=new esri.geometry.Extent(a.x,r.y,r.x,a.y,this.app.map.spatialReference);this.viewModel.printPreviewExtent=s},r);function r(e,t){return n.call(this,e,t)||this}t.UnlockedPrintPreviewView=a})},"url:/Mapping/modules/Printing/PrintingView.html":t,"url:/Mapping/modules/Printing/UnlockedPrintPreviewView.html":i}}),require(["geocortex/framework/resourceManager"],function(e){e.resourceManager.register("Mapping","inv","Mapping/modules/Printing/CSS/common.css","css","LnByaW50aW5nIHsNCiAgICBwYWRkaW5nOiAxZW07DQogICAgb3ZlcmZsb3c6IGhpZGRlbjsNCn0NCg0KICAgIC5wcmludGluZyBsYWJlbCB7DQogICAgICAgIGNvbG9yOiAjNjY3NTgwOw0KICAgICAgICBmb250LXNpemU6IDEuMmVtOw0KICAgICAgICBkaXNwbGF5OiBibG9jazsNCiAgICAgICAgbWFyZ2luOiAuNzVlbSAwIDAuMjVlbSAwOw0KICAgIH0NCg0KICAgIC5wcmludGluZyBpbnB1dCwNCiAgICAucHJpbnRpbmcgc2VsZWN0LA0KICAgIC5wcmludGluZyB0ZXh0YXJlYSB7DQogICAgICAgIHdpZHRoOiAxMDAlOw0KICAgIH0NCg0KDQouc2hlbGwtbGFyZ2UgLnByaW50aW5nLXBlZXBob2xlLWNvbnRhaW5lciB7DQogICAgcG9zaXRpb246IGFic29sdXRlOw0KICAgIGhlaWdodDogMTAwJTsNCiAgICB3aWR0aDogMTAwJTsNCiAgICBvdmVyZmxvdzogaGlkZGVuOw0KICAgIHBvaW50ZXItZXZlbnRzOiBub25lOw0KfQ0KDQogICAgLnNoZWxsLWxhcmdlIC5wcmludGluZy1wZWVwaG9sZS1jb250YWluZXIgLnByaW50aW5nLXBlZXBob2xlLA0KICAgIC5zaGVsbC1sYXJnZSAucHJpbnRpbmctcGVlcGhvbGUtY29udGFpbmVyIC5wcmludGluZy1wZWVwaG9sZS1pbWcgew0KICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7DQogICAgfQ0KDQogICAgLnNoZWxsLWxhcmdlIC5wcmludGluZy1wZWVwaG9sZS1jb250YWluZXIgLnByaW50aW5nLXBlZXBob2xlIHsNCiAgICAgICAgYm9yZGVyLXN0eWxlOiBkYXNoZWQ7DQogICAgICAgIC1tb3otYm94LXNpemluZzogYm9yZGVyLWJveDsNCiAgICAgICAgLXdlYmtpdC1ib3gtc2l6aW5nOiBib3JkZXItYm94Ow0KICAgICAgICBib3gtc2l6aW5nOiBib3JkZXItYm94Ow0KICAgIH0NCg0KICAgIC5zaGVsbC1sYXJnZSAucHJpbnRpbmctcGVlcGhvbGUtY29udGFpbmVyIC5wcmludGluZy1wZWVwaG9sZS1pbWcgew0KICAgICAgICB0b3A6IDUwJTsNCiAgICAgICAgbGVmdDogNTAlOw0KICAgICAgICAtbW96LXRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOw0KICAgICAgICAtbXMtdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7DQogICAgICAgIC1vLXRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOw0KICAgICAgICAtd2Via2l0LXRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOw0KICAgICAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsNCiAgICB9DQoNCi5wcmludC1wcmV2aWV3LXRvZ2dsZXIgew0KICAgIHRleHQtYWxpZ246IGxlZnQ7DQp9DQoNCiAgICAucHJpbnQtcHJldmlldy10b2dnbGVyIGlucHV0IHsNCiAgICAgICAgd2lkdGg6IGF1dG87DQogICAgICAgIHZlcnRpY2FsLWFsaWduOiBtaWRkbGU7DQogICAgfQ0K"),e.resourceManager.register("Mapping","inv","Mapping/modules/Printing/PrintingView.html","html",t),e.resourceManager.register("Mapping","inv","Mapping/modules/Printing/UnlockedPrintPreviewView.html","html",i)}),require({cache:{}}),define(["Mapping/modules/Printing/PrintingModule","Mapping/modules/Printing/PrintingView","Mapping/modules/Printing/PrintingViewModel","Mapping/modules/Printing/UnlockedPrintPreviewView"],function(e,t,i,n){a(e,"geocortex.essentialsHtmlViewer.mapping.modules.printing.PrintingModule",e.PrintingModule),a(t,"geocortex.essentialsHtmlViewer.mapping.modules.printing.PrintingView",t.PrintingView),a(i,"geocortex.essentialsHtmlViewer.mapping.modules.printing.PrintingViewModel",i.PrintingViewModel),a(n,"geocortex.essentialsHtmlViewer.mapping.modules.printing.UnlockedPrintPreviewView",n.UnlockedPrintPreviewView)})}();