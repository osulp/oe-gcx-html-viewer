require({cache:{"Mapping/modules/Highlight/HighlightModule":function(){var a,l=this&&this.__extends||(a=function(e,t){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}a(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)});define(["require","exports","geocortex/framework/application/ModuleBase","geocortex/infrastructure/HighlightManager","geocortex/infrastructure/FeatureSet","geocortex/infrastructure/Feature","geocortex/framework/utils/utils"],function(e,t,i,g,a,h,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s,o=(s=i.ModuleBase,l(n,s),n.prototype.initialize=function(e){var t=this;if(s.prototype.initialize.call(this,e),(this.app.highlightManager.config=e).additionalLayers&&(this._additionalLayers=e.additionalLayers),e.geometryGeneralization){var i=e.geometryGeneralization;this._geomGeneralizationInfo={},this._geomGeneralizationInfo.maxDeviationInMeters=r.isNullOrUndefined(i.maxDeviationInMeters)?NaN:parseFloat(i.maxDeviationInMeters.toString()),this._geomGeneralizationInfo.thresholdVertices=r.isNullOrUndefined(i.thresholdVertices)?NaN:parseInt(i.thresholdVertices.toString(),10),this._geomGeneralizationInfo.geometryGeneralizationEnabled=i.geometryGeneralizationEnabled&&!(isNaN(this._geomGeneralizationInfo.maxDeviationInMeters)||isNaN(this._geomGeneralizationInfo.thresholdVertices)),this._geomGeneralizationInfo.geometryGeneralizationEnabled&&this.app.waitUntilSiteInitialized().then(function(){return t.app.highlightManager.setGeometryGeneralizationParams(t._geomGeneralizationInfo.thresholdVertices,t._geomGeneralizationInfo.maxDeviationInMeters)}).then(function(){return t.app.trace.debug("Geometry generalization (using the Ramer–Douglas–Peucker algorithm) enabled for the Highlight module for geometries with more than {0} vertices.".format(t._geomGeneralizationInfo.thresholdVertices))},function(){return t.app.trace.error("Unable to activate geometry generalization for the Highlight module.")})}if(!r.isNullOrUndefined(e.maxHighlightableGeometryVertices)){var a=parseInt(e.maxHighlightableGeometryVertices.toString(),10);isNaN(a)||(this._maxHighlightableGeometryVertices=a),this.app.highlightManager.setMaxHighlightableGeometryVertices(this._maxHighlightableGeometryVertices),dojo.connect(this.app.highlightManager,"onMaxGeometryVerticesExceeded",function(e){return t._onMaxGeometryVerticesExceeded(e)})}this.registerCommands(),this.subscribeEvents(),this._layersReady()?(this._initializeDefaultHighlights(),this.app.highlightManager.applyHighlightConfiguration(g.DEFAULT_HIGHLIGHT_LAYER_NAME)):this.app.event("SiteServiceLayersLoaded").once(this,function(){t._initializeDefaultHighlights(),t.app.highlightManager.applyHighlightConfiguration(g.DEFAULT_HIGHLIGHT_LAYER_NAME)})},n.prototype.registerCommands=function(){this.app.command("HighlightFeature").register(this,this._highlightFeature,this._isReady),this.app.command("HighlightFeatures").register(this,this._highlightFeature,this._isReady),this.app.command("ClearAndHighlightFeatures").register(this,this._clearAndHighlightFeature,this._isReady),this.app.command("ClearHighlights").register(this,this._clearHighlights,this._isReady),this.app.command("ClearFeatureHighlight").register(this,this._clearFeatureHighlight,this._isReady),this.app.command("SetHighlightBorderColor").register(this,this._setHighlightBorderColor),this.app.command("SetHighlightBorderWidth").register(this,this._setHighlightBorderWidth),this.app.command("SetHighlightFillColor").register(this,this._setHighlightFillColor),this.app.command("FocusFeature").register(this,this._focusFeature,this._isReady),this.app.command("ClearFeatureFocus").register(this,this._clearFeatureFocus,this._isReady),this.app.command("SetFocusedBorderColor").register(this,this._setFocusedHighlightBorderColor),this.app.command("SetFocusedFillColor").register(this,this._setFocusedHighlightFillColor),this.app.command("HighlightFeatureSet").register(this,this._highlightFeature,this._isReady),this.app.command("HighlightEsriFeatureSet").register(this,this._highlightFeature,this._isReady),this.app.command("CreateHighlightLayer").register(this,this._createHighlightLayer,this._canCreateHighlightLayer),this.app.command("SetActiveHighlightLayer").register(this,this._setActiveHighlightLayer,this._canSetActiveHighlightLayer),this.app.command("SetActiveHighlightLayerDefault").register(this,this._setActiveHighlightLayerDefault,this._canSetActiveHighlightLayerDefault),this.app.command("RemoveHighlightLayer").register(this,this._removeHighlightLayer,this._canRemoveHighlightLayer),this.app.command("HighlightFeatureDefault").register(this,this._highlightFeatureDefault,this._isReady),this.app.command("ClearDefaultHighlights").register(this,this._clearHighlightsDefault),this.app.command("HighlightFeatureSetTestHarness").register(this,this._highlightFeatureSetTestHarness),this.app.command("HighlightFeatureTestHarness").register(this,this._highlightFeatureTestHarness),this.app.command("_clearSavedGeometryEditHighlightId").register(this,this._executeClearSavedGeometryEditHighlightId)},n.prototype.subscribeEvents=function(){var t=this;this.app.event("LayerVisualizationChangedEvent").subscribe(this,this._refreshHighlights),this.app.command("AddFeatureSetToStarredSelection").postExecute.subscribe(this,this._redrawHighlights),this.app.command("RemoveFeatureSetFromStarredSelection").postExecute.subscribe(this,this._redrawHighlights),this.app.event("MapZoomEndedEvent").subscribe(this,this._redrawHighlights),this.app.event("GeometryEditInvokedEvent").subscribe(this,function(e){t._startEditingHighlightedGraphic(e)}),this.app.event("MarkupEditingStartedEvent").subscribe(this,function(e){t._startEditingHighlightedGraphic(e)}),this.app.event("GeometryEditCompletedEvent").subscribe(this,function(e){e.cancelled?t._editCancelled=e.cancelled:t._editCancelled=!1,!e.cancelled&&e.editedGraphic&&e.originalGraphic?(t._originalEditGeometry=null,e.editedGraphic[g.HIGHLIGHT_ID_PROPERTY]=e.originalGraphic[g.HIGHLIGHT_ID_PROPERTY],t.app.highlightManager.updateHighlightId(e.editedGraphic),t._geometryEditHighlightId=e.editedGraphic[g.HIGHLIGHT_ID_PROPERTY],t._clearHighlights(g.EDITOR_HIGHLIGHT_LAYER_NAME),t._focusFeature({feature:e.editedGraphic,layer:g.EDITOR_HIGHLIGHT_LAYER_NAME}),t._enableHighlight(e.editedGraphic)):(t._originalEditGeometry&&(e.originalGraphic.geometry=t._originalEditGeometry),t._clearHighlights(g.EDITOR_HIGHLIGHT_LAYER_NAME),t._enableHighlight(e.originalGraphic))}),this.app.event("FeatureEditedEvent").subscribe(this,function(e){t._geometryEditHighlightId&&(e.editedFeature[g.HIGHLIGHT_ID_PROPERTY]=t._geometryEditHighlightId)}),this.app.event("_internalEvent.EditorViewDeactivated").subscribe(this,function(e){!t._editCancelled&&e&&e.geometry&&(t._clearHighlights(g.EDITOR_HIGHLIGHT_LAYER_NAME),t._enableHighlight(e))}),this.app.event("GraphicEditingDoneEvent").subscribe(this,function(e){e.old&&e.new&&e.new.geometry&&(e.new[g.HIGHLIGHT_ID_PROPERTY]=e.old[g.HIGHLIGHT_ID_PROPERTY],t._clearHighlights(g.EDITOR_HIGHLIGHT_LAYER_NAME),t._enableHighlight(e.new))})},n.prototype._startEditingHighlightedGraphic=function(e){e&&(this._editCancelled=!1,this._geometryEditHighlightId="",this._originalEditGeometry=null,this._clearHighlights(g.EDITOR_HIGHLIGHT_LAYER_NAME),this._focusFeature({feature:e,layer:g.EDITOR_HIGHLIGHT_LAYER_NAME}),this._suppressHighlight(e),this._originalEditGeometry=esri.geometry.fromJson(e.geometry.toJson()))},n.prototype.getStateFilter=function(){var h=this;return{highlightLayers:function(e){for(var t={},i=0,a=Object.keys(e);i<a.length;i++)t[a[i]]=h.app.project.filter.operationalLayer;return t},activeHighlightLayerName:!0,highlights:{item:{feature:this.app.project.filter.feature,highlightLayer:!0,originalLayer:!0,useDefaultHighlightLayer:!0}}}},n.prototype.exportState=function(){return this.app.highlightManager.exportState()},n.prototype.applyState=function(e){return this.app.highlightManager.applyState(e)},n.prototype._layersReady=function(){if(this.app.site&&this.app.site.essentialsMap&&this.app.site.essentialsMap.mapServices){for(var e=0,t=this.app.site.essentialsMap.mapServices;e<t.length;e++)if(!t[e].serviceLayer.loaded)return!1;return!0}return!1},n.prototype._initializeDefaultHighlights=function(){if(this.app.highlightManager.getOrCreateInternalHighlightLayer(g.DEFAULT_HIGHLIGHT_LAYER_NAME),this._additionalLayers)for(var e=0,t=this._additionalLayers;e<t.length;e++){var i=t[e];this.app.highlightManager.getOrCreateInternalHighlightLayer(i.name,i.hasOwnProperty("fillColor")?i.fillColor:void 0,i.hasOwnProperty("borderColor")?i.borderColor:void 0,!1)}this._setActiveHighlightLayerDefault(),this._isInitialized=!0;for(var a=0,h=["CreateHighlightLayer","SetActiveHighlightLayer","SetActiveHighlightLayerDefault","HighlightEsriFeatureSet","RemoveHighlightLayer","ClearHighlights","HighlightFeatureSet","HighlightFeature"];a<h.length;a++){var r=h[a];this.app.command(r).raiseCanExecuteChanged()}},n.prototype._createHighlightLayer=function(e,t,i,a){this.app.highlightManager.getOrCreateInternalHighlightLayer(e,t,i,!!a)},n.prototype._canCreateHighlightLayer=function(e){return this._isInitialized&&!this.app.project.isLoading&&!this.app.highlightManager.getInternalHighlightLayer(e)},n.prototype._canSetActiveHighlightLayer=function(e){return this._isInitialized&&!this.app.project.isLoading&&!!this.app.highlightManager.getInternalHighlightLayer(e)},n.prototype._setActiveHighlightLayer=function(e){this.app.highlightManager.setActiveHighlightLayer(e)},n.prototype._canSetActiveHighlightLayerDefault=function(){return this._isInitialized&&!this.app.project.isLoading&&!!this.app.highlightManager.getInternalHighlightLayer(g.DEFAULT_HIGHLIGHT_LAYER_NAME)},n.prototype._setActiveHighlightLayerDefault=function(){this.app.highlightManager.setActiveHighlightLayer(g.DEFAULT_HIGHLIGHT_LAYER_NAME)},n.prototype._setHighlightBorderColor=function(e,t){this.app.highlightManager.setHighlightBorderColor(e,t)},n.prototype._setHighlightBorderWidth=function(e,t){this.app.highlightManager.setBorderWidth(e,t)},n.prototype._setHighlightFillColor=function(e,t){this.app.highlightManager.setHighlightFillColor(e,t)},n.prototype._setFocusedHighlightBorderColor=function(e,t){this.app.highlightManager.setFocusedBorderColor(e,t)},n.prototype._setFocusedHighlightFillColor=function(e,t){this.app.highlightManager.setFocusedFillColor(e,t)},n.prototype._removeHighlightLayer=function(e){this.app.highlightManager.removeHighlightLayer(e)},n.prototype._canRemoveHighlightLayer=function(e){return this._isInitialized&&!this.app.project.isLoading&&!!this.app.highlightManager.getInternalHighlightLayer(e)},n.prototype._highlightFeature=function(e){e&&this._highlightFeaturesImpl(e,this.app.highlightManager.highlightFeatures)},n.prototype._clearFeatureHighlight=function(e){e&&this._highlightFeaturesImpl(e,this.app.highlightManager.clearHighlight)},n.prototype._clearHighlights=function(e){this.app.highlightManager.clearHighlights(e||g.DEFAULT_HIGHLIGHT_LAYER_NAME)},n.prototype._clearHighlightsDefault=function(){this.app.highlightManager.clearHighlights(g.DEFAULT_HIGHLIGHT_LAYER_NAME)},n.prototype._clearAndHighlightFeature=function(e){var t=g.DEFAULT_HIGHLIGHT_LAYER_NAME;this.isHighlightFeatureArgs(e)&&(t=e.layer),this._clearHighlights(t),this._highlightFeature(e)},n.prototype._highlightFeatureDefault=function(e){this._clearHighlights(g.DEFAULT_HIGHLIGHT_LAYER_NAME),this._highlightFeature(e)},n.prototype._refreshHighlights=function(){this._isInitialized&&!this.app.project.isLoading&&this.app.highlightManager.refreshHighlights()},n.prototype._redrawHighlights=function(){this._isInitialized&&!this.app.project.isLoading&&this.app.highlightManager.redrawHighlights()},n.prototype._suppressHighlight=function(e){e&&this.app.highlightManager.suppressHighlight(e)},n.prototype._enableHighlight=function(e){e&&this.app.highlightManager.enableHighlight(e)},n.prototype._focusFeature=function(e){e&&this._highlightFeaturesImpl(e,this.app.highlightManager.focusFeatures)},n.prototype._clearFeatureFocus=function(e){e&&this._highlightFeaturesImpl(e,this.app.highlightManager.clearFocus)},n.prototype._highlightFeaturesImpl=function(e,t){var i=g.DEFAULT_HIGHLIGHT_LAYER_NAME;if(t=t.bind(this.app.highlightManager),this.isHighlightFeatureArgs(e)&&(i=e.layer,e=e.feature),$.isArray(e)){if(e[0]instanceof h.Feature||e[0]instanceof esri.Graphic)t(e,i);else if(null==e[0])return}else e instanceof a.FeatureSet?t(e.features.get(),i):e instanceof esri.tasks.FeatureSet?t(e.features,i):e instanceof h.Feature||e instanceof esri.Graphic?t([e],i):this.app.trace.warning("A highlight command was called without passing in any valid features. Nothing will happen.")},n.prototype._isReady=function(){return this._isInitialized},n.prototype._highlightFeatureSetTestHarness=function(e){for(var t=this.app.featureSetManager.getCollectionById(e).featureSets,i=t.bind(this,function(e){if("append"===e.type)for(var t=e.rangeStart;t<e.rangeEnd+1;t++)this.app.command("HighlightFeatureSet").execute(e.sender.getAt(t))}),a=0;a<t.length();a++)this.app.command("HighlightFeatureSet").execute(t[a]);t.unbind(i)},n.prototype._highlightFeatureTestHarness=function(e){var i=this,a=this.app.featureSetManager.getCollectionById(e),t=a.firstFeature();if(t)this.app.command("HighlightFeature").execute(t);else var h=a.featureSets.bind(this,function(e){var t=a.firstFeature();t&&(a.featureSets.unbind(h),i.app.command("HighlightFeature").execute(t))})},n.prototype.isHighlightFeatureArgs=function(e){return!!(e&&e.layer&&e.feature&&(e.feature instanceof h.Feature||$.isArray(e.feature)&&e.feature[0]instanceof h.Feature||e.feature instanceof esri.Graphic||$.isArray(e.feature)&&e.feature[0]instanceof esri.Graphic))},n.prototype._onMaxGeometryVerticesExceeded=function(e){var t=this;if(!this._maxVerticesNotificationDisplayed&&!this._doNotNotifyMaxVerticesAgain){var i=this.getResource("language-highlight-max-geometry-vertices-exceeded-alert"),a=this.getResource("language-highlight-max-geometry-vertices-alert-permanent-dismiss-msg"),h=this.getResource("language-highlight-max-geometry-vertices-exceeded-alert-image-url"),r=this.getResource("language-highlight-max-geometry-vertices-exceeded-alert-alt-text"),g={text:a,callback:function(){t._maxVerticesNotificationDisplayed=!1,t._doNotNotifyMaxVerticesAgain=!0,t.app.command("RemoveNotification").execute(t._geometryNotificationId)}},s={callback:function(){t._maxVerticesNotificationDisplayed=!1}};this._maxVerticesNotificationDisplayed=!0;var o={id:this._geometryNotificationId,text:i.format(this._maxHighlightableGeometryVertices),iconProperties:{uri:h,altText:r},buttons:[g],closeButton:s};this.app.command("DisplayNotification").execute(o)}},n.prototype._executeClearSavedGeometryEditHighlightId=function(){this._geometryEditHighlightId=""},n);function n(){var e=null!==s&&s.apply(this,arguments)||this;return e._isInitialized=!1,e._additionalLayers=null,e._geometryEditHighlightId="",e._editCancelled=!1,e._geomGeneralizationInfo=null,e._maxHighlightableGeometryVertices=0,e._maxVerticesNotificationDisplayed=!1,e._doNotNotifyMaxVerticesAgain=!1,e._geometryNotificationId="___geomMaxVerticesExceeded",e}t.HighlightModule=o})}}}),require({cache:{}}),define(["Mapping/modules/Highlight/HighlightModule"],function(e){!function(e,t,i){if("string"==typeof e&&(i=t,t=e),void 0!==i)for(var a=t.split("."),h=null,r=window,g=0,s=a.length;g<s;g++)h=a[g],g==s-1?r[h]=i:r[h]||(r[h]={}),r=r[h];else console.warn("Undefined shim for: "+t)}(e,"geocortex.essentialsHtmlViewer.mapping.modules.Highlight.HighlightModule",e.HighlightModule)});