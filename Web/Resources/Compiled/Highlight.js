!function(){function e(e,t,i){if("string"==typeof e&&(i=t,t=e),void 0!==i)for(var a=t.split("."),r=null,h=window,g=0,s=a.length;g<s;g++)r=a[g],g==s-1?h[r]=i:h[r]||(h[r]={}),h=h[r];else console.warn("Undefined shim for: "+t)}require({cache:{"Mapping/modules/Highlight/HighlightModule":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function a(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(a.prototype=i.prototype,new a)}}();define(["require","exports","geocortex/framework/application/ModuleBase","geocortex/infrastructure/HighlightManager","geocortex/infrastructure/FeatureSet","geocortex/infrastructure/Feature","geocortex/framework/utils/utils"],function(t,i,a,r,h,g,s){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var o=function(t){function i(){var e=null!==t&&t.apply(this,arguments)||this;return e._isInitialized=!1,e._additionalLayers=null,e._geometryEditHighlightId="",e._editCancelled=!1,e._geomGeneralizationInfo=null,e._maxHighlightableGeometryVertices=0,e._maxVerticesNotificationDisplayed=!1,e._doNotNotifyMaxVerticesAgain=!1,e._geometryNotificationId="___geomMaxVerticesExceeded",e}return e(i,t),i.prototype.initialize=function(e){var i=this;if(t.prototype.initialize.call(this,e),this.app.highlightManager.config=e,e.additionalLayers&&(this._additionalLayers=e.additionalLayers),e.geometryGeneralization){var a=e.geometryGeneralization;this._geomGeneralizationInfo={},this._geomGeneralizationInfo.maxDeviationInMeters=s.isNullOrUndefined(a.maxDeviationInMeters)?NaN:parseFloat(a.maxDeviationInMeters.toString()),this._geomGeneralizationInfo.thresholdVertices=s.isNullOrUndefined(a.thresholdVertices)?NaN:parseInt(a.thresholdVertices.toString(),10),this._geomGeneralizationInfo.geometryGeneralizationEnabled=a.geometryGeneralizationEnabled&&!(isNaN(this._geomGeneralizationInfo.maxDeviationInMeters)||isNaN(this._geomGeneralizationInfo.thresholdVertices)),this._geomGeneralizationInfo.geometryGeneralizationEnabled&&this.app.waitUntilSiteInitialized().then(function(){return i.app.highlightManager.setGeometryGeneralizationParams(i._geomGeneralizationInfo.thresholdVertices,i._geomGeneralizationInfo.maxDeviationInMeters)}).then(function(){return i.app.trace.debug("Geometry generalization (using the Ramer–Douglas–Peucker algorithm) enabled for the Highlight module for geometries with more than {0} vertices.".format(i._geomGeneralizationInfo.thresholdVertices))},function(){return i.app.trace.error("Unable to activate geometry generalization for the Highlight module.")})}if(!s.isNullOrUndefined(e.maxHighlightableGeometryVertices)){var h=parseInt(e.maxHighlightableGeometryVertices.toString(),10);isNaN(h)||(this._maxHighlightableGeometryVertices=h),this.app.highlightManager.setMaxHighlightableGeometryVertices(this._maxHighlightableGeometryVertices),dojo.connect(this.app.highlightManager,"onMaxGeometryVerticesExceeded",function(e){return i._onMaxGeometryVerticesExceeded(e)})}this.registerCommands(),this.subscribeEvents(),this._layersReady()?(this._initializeDefaultHighlights(),this.app.highlightManager.applyHighlightConfiguration(r.DEFAULT_HIGHLIGHT_LAYER_NAME)):this.app.event("SiteServiceLayersLoaded").once(this,function(){i._initializeDefaultHighlights(),i.app.highlightManager.applyHighlightConfiguration(r.DEFAULT_HIGHLIGHT_LAYER_NAME)})},i.prototype.registerCommands=function(){this.app.command("HighlightFeature").register(this,this._highlightFeature,this._isReady),this.app.command("HighlightFeatures").register(this,this._highlightFeature,this._isReady),this.app.command("ClearAndHighlightFeatures").register(this,this._clearAndHighlightFeature,this._isReady),this.app.command("ClearHighlights").register(this,this._clearHighlights,this._isReady),this.app.command("ClearFeatureHighlight").register(this,this._clearFeatureHighlight,this._isReady),this.app.command("SetHighlightBorderColor").register(this,this._setHighlightBorderColor),this.app.command("SetHighlightBorderWidth").register(this,this._setHighlightBorderWidth),this.app.command("SetHighlightFillColor").register(this,this._setHighlightFillColor),this.app.command("FocusFeature").register(this,this._focusFeature,this._isReady),this.app.command("ClearFeatureFocus").register(this,this._clearFeatureFocus,this._isReady),this.app.command("SetFocusedBorderColor").register(this,this._setFocusedHighlightBorderColor),this.app.command("SetFocusedFillColor").register(this,this._setFocusedHighlightFillColor),this.app.command("HighlightFeatureSet").register(this,this._highlightFeature,this._isReady),this.app.command("HighlightEsriFeatureSet").register(this,this._highlightFeature,this._isReady),this.app.command("CreateHighlightLayer").register(this,this._createHighlightLayer,this._canCreateHighlightLayer),this.app.command("SetActiveHighlightLayer").register(this,this._setActiveHighlightLayer,this._canSetActiveHighlightLayer),this.app.command("SetActiveHighlightLayerDefault").register(this,this._setActiveHighlightLayerDefault,this._canSetActiveHighlightLayerDefault),this.app.command("RemoveHighlightLayer").register(this,this._removeHighlightLayer,this._canRemoveHighlightLayer),this.app.command("HighlightFeatureDefault").register(this,this._highlightFeatureDefault,this._isReady),this.app.command("ClearDefaultHighlights").register(this,this._clearHighlightsDefault),this.app.command("HighlightFeatureSetTestHarness").register(this,this._highlightFeatureSetTestHarness),this.app.command("HighlightFeatureTestHarness").register(this,this._highlightFeatureTestHarness),this.app.command("_clearSavedGeometryEditHighlightId").register(this,this._executeClearSavedGeometryEditHighlightId)},i.prototype.subscribeEvents=function(){var e=this;this.app.event("LayerVisualizationChangedEvent").subscribe(this,this._refreshHighlights),this.app.command("AddFeatureSetToStarredSelection").postExecute.subscribe(this,this._redrawHighlights),this.app.command("RemoveFeatureSetFromStarredSelection").postExecute.subscribe(this,this._redrawHighlights),this.app.event("MapZoomEndedEvent").subscribe(this,this._redrawHighlights),this.app.event("GeometryEditInvokedEvent").subscribe(this,function(t){e._startEditingHighlightedGraphic(t)}),this.app.event("MarkupEditingStartedEvent").subscribe(this,function(t){e._startEditingHighlightedGraphic(t)}),this.app.event("GeometryEditCompletedEvent").subscribe(this,function(t){t.cancelled?e._editCancelled=t.cancelled:e._editCancelled=!1,!t.cancelled&&t.editedGraphic&&t.originalGraphic?(e._originalEditGeometry=null,t.editedGraphic[r.HIGHLIGHT_ID_PROPERTY]=t.originalGraphic[r.HIGHLIGHT_ID_PROPERTY],e.app.highlightManager.updateHighlightId(t.editedGraphic),e._geometryEditHighlightId=t.editedGraphic[r.HIGHLIGHT_ID_PROPERTY],e._clearHighlights(r.EDITOR_HIGHLIGHT_LAYER_NAME),e._focusFeature({feature:t.editedGraphic,layer:r.EDITOR_HIGHLIGHT_LAYER_NAME}),e._enableHighlight(t.editedGraphic)):(e._originalEditGeometry&&(t.originalGraphic.geometry=e._originalEditGeometry),e._clearHighlights(r.EDITOR_HIGHLIGHT_LAYER_NAME),e._enableHighlight(t.originalGraphic))}),this.app.event("FeatureEditedEvent").subscribe(this,function(t){e._geometryEditHighlightId&&(t.editedFeature[r.HIGHLIGHT_ID_PROPERTY]=e._geometryEditHighlightId)}),this.app.event("_internalEvent.EditorViewDeactivated").subscribe(this,function(t){!e._editCancelled&&t&&t.geometry&&(e._clearHighlights(r.EDITOR_HIGHLIGHT_LAYER_NAME),e._enableHighlight(t))}),this.app.event("GraphicEditingDoneEvent").subscribe(this,function(t){t.old&&t.new&&t.new.geometry&&(t.new[r.HIGHLIGHT_ID_PROPERTY]=t.old[r.HIGHLIGHT_ID_PROPERTY],e._clearHighlights(r.EDITOR_HIGHLIGHT_LAYER_NAME),e._enableHighlight(t.new))})},i.prototype._startEditingHighlightedGraphic=function(e){e&&(this._editCancelled=!1,this._geometryEditHighlightId="",this._originalEditGeometry=null,this._clearHighlights(r.EDITOR_HIGHLIGHT_LAYER_NAME),this._focusFeature({feature:e,layer:r.EDITOR_HIGHLIGHT_LAYER_NAME}),this._suppressHighlight(e),this._originalEditGeometry=esri.geometry.fromJson(e.geometry.toJson()))},i.prototype.getStateFilter=function(){var e=this;return{highlightLayers:function(t){for(var i={},a=0,r=Object.keys(t);a<r.length;a++)i[r[a]]=e.app.project.filter.operationalLayer;return i},activeHighlightLayerName:!0,highlights:{item:{feature:this.app.project.filter.feature,highlightLayer:!0,originalLayer:!0,useDefaultHighlightLayer:!0}}}},i.prototype.exportState=function(){return this.app.highlightManager.exportState()},i.prototype.applyState=function(e){return this.app.highlightManager.applyState(e)},i.prototype._layersReady=function(){if(this.app.site&&this.app.site.essentialsMap&&this.app.site.essentialsMap.mapServices){for(var e=0,t=this.app.site.essentialsMap.mapServices;e<t.length;e++)if(!t[e].serviceLayer.loaded)return!1;return!0}return!1},i.prototype._initializeDefaultHighlights=function(){if(this.app.highlightManager.getOrCreateInternalHighlightLayer(r.DEFAULT_HIGHLIGHT_LAYER_NAME),this._additionalLayers)for(var e=0,t=this._additionalLayers;e<t.length;e++){var i=t[e];this.app.highlightManager.getOrCreateInternalHighlightLayer(i.name,i.hasOwnProperty("fillColor")?i.fillColor:void 0,i.hasOwnProperty("borderColor")?i.borderColor:void 0,!1)}this._setActiveHighlightLayerDefault(),this._isInitialized=!0;for(var a=0,h=["CreateHighlightLayer","SetActiveHighlightLayer","SetActiveHighlightLayerDefault","HighlightEsriFeatureSet","RemoveHighlightLayer","ClearHighlights","HighlightFeatureSet","HighlightFeature"];a<h.length;a++){var g=h[a];this.app.command(g).raiseCanExecuteChanged()}},i.prototype._createHighlightLayer=function(e,t,i,a){this.app.highlightManager.getOrCreateInternalHighlightLayer(e,t,i,!!a)},i.prototype._canCreateHighlightLayer=function(e){return this._isInitialized&&!this.app.project.isLoading&&!this.app.highlightManager.getInternalHighlightLayer(e)},i.prototype._canSetActiveHighlightLayer=function(e){return this._isInitialized&&!this.app.project.isLoading&&!!this.app.highlightManager.getInternalHighlightLayer(e)},i.prototype._setActiveHighlightLayer=function(e){this.app.highlightManager.setActiveHighlightLayer(e)},i.prototype._canSetActiveHighlightLayerDefault=function(){return this._isInitialized&&!this.app.project.isLoading&&!!this.app.highlightManager.getInternalHighlightLayer(r.DEFAULT_HIGHLIGHT_LAYER_NAME)},i.prototype._setActiveHighlightLayerDefault=function(){this.app.highlightManager.setActiveHighlightLayer(r.DEFAULT_HIGHLIGHT_LAYER_NAME)},i.prototype._setHighlightBorderColor=function(e,t){this.app.highlightManager.setHighlightBorderColor(e,t)},i.prototype._setHighlightBorderWidth=function(e,t){this.app.highlightManager.setBorderWidth(e,t)},i.prototype._setHighlightFillColor=function(e,t){this.app.highlightManager.setHighlightFillColor(e,t)},i.prototype._setFocusedHighlightBorderColor=function(e,t){this.app.highlightManager.setFocusedBorderColor(e,t)},i.prototype._setFocusedHighlightFillColor=function(e,t){this.app.highlightManager.setFocusedFillColor(e,t)},i.prototype._removeHighlightLayer=function(e){this.app.highlightManager.removeHighlightLayer(e)},i.prototype._canRemoveHighlightLayer=function(e){return this._isInitialized&&!this.app.project.isLoading&&!!this.app.highlightManager.getInternalHighlightLayer(e)},i.prototype._highlightFeature=function(e){e&&this._highlightFeaturesImpl(e,this.app.highlightManager.highlightFeatures)},i.prototype._clearFeatureHighlight=function(e){e&&this._highlightFeaturesImpl(e,this.app.highlightManager.clearHighlight)},i.prototype._clearHighlights=function(e){this.app.highlightManager.clearHighlights(e||r.DEFAULT_HIGHLIGHT_LAYER_NAME)},i.prototype._clearHighlightsDefault=function(){this.app.highlightManager.clearHighlights(r.DEFAULT_HIGHLIGHT_LAYER_NAME)},i.prototype._clearAndHighlightFeature=function(e){var t=r.DEFAULT_HIGHLIGHT_LAYER_NAME;this.isHighlightFeatureArgs(e)&&(t=e.layer),this._clearHighlights(t),this._highlightFeature(e)},i.prototype._highlightFeatureDefault=function(e){this._clearHighlights(r.DEFAULT_HIGHLIGHT_LAYER_NAME),this._highlightFeature(e)},i.prototype._refreshHighlights=function(){this._isInitialized&&!this.app.project.isLoading&&this.app.highlightManager.refreshHighlights()},i.prototype._redrawHighlights=function(){this._isInitialized&&!this.app.project.isLoading&&this.app.highlightManager.redrawHighlights()},i.prototype._suppressHighlight=function(e){e&&this.app.highlightManager.suppressHighlight(e)},i.prototype._enableHighlight=function(e){e&&this.app.highlightManager.enableHighlight(e)},i.prototype._focusFeature=function(e){e&&this._highlightFeaturesImpl(e,this.app.highlightManager.focusFeatures)},i.prototype._clearFeatureFocus=function(e){e&&this._highlightFeaturesImpl(e,this.app.highlightManager.clearFocus)},i.prototype._highlightFeaturesImpl=function(e,t){var i=r.DEFAULT_HIGHLIGHT_LAYER_NAME;if(t=t.bind(this.app.highlightManager),this.isHighlightFeatureArgs(e)&&(i=e.layer,e=e.feature),$.isArray(e)){if(e[0]instanceof g.Feature||e[0]instanceof esri.Graphic)t(e,i);else if(null==e[0])return}else e instanceof h.FeatureSet?t(e.features.get(),i):e instanceof esri.tasks.FeatureSet?t(e.features,i):e instanceof g.Feature||e instanceof esri.Graphic?t([e],i):this.app.trace.warning("A highlight command was called without passing in any valid features. Nothing will happen.")},i.prototype._isReady=function(){return this._isInitialized},i.prototype._highlightFeatureSetTestHarness=function(e){for(var t=this.app.featureSetManager.getCollectionById(e).featureSets,i=t.bind(this,function(e){if("append"===e.type)for(var t=e.rangeStart;t<e.rangeEnd+1;t++)this.app.command("HighlightFeatureSet").execute(e.sender.getAt(t))}),a=0;a<t.length();a++)this.app.command("HighlightFeatureSet").execute(t[a]);t.unbind(i)},i.prototype._highlightFeatureTestHarness=function(e){var t=this,i=this.app.featureSetManager.getCollectionById(e),a=i.firstFeature();if(a)this.app.command("HighlightFeature").execute(a);else var r=i.featureSets.bind(this,function(e){var a=i.firstFeature();a&&(i.featureSets.unbind(r),t.app.command("HighlightFeature").execute(a))})},i.prototype.isHighlightFeatureArgs=function(e){return!!(e&&e.layer&&e.feature)&&(!!(e.feature instanceof g.Feature||$.isArray(e.feature)&&e.feature[0]instanceof g.Feature)||!!(e.feature instanceof esri.Graphic||$.isArray(e.feature)&&e.feature[0]instanceof esri.Graphic))},i.prototype._onMaxGeometryVerticesExceeded=function(e){var t=this;if(!this._maxVerticesNotificationDisplayed&&!this._doNotNotifyMaxVerticesAgain){var i=this.getResource("language-highlight-max-geometry-vertices-exceeded-alert"),a=this.getResource("language-highlight-max-geometry-vertices-alert-permanent-dismiss-msg"),r=this.getResource("language-highlight-max-geometry-vertices-exceeded-alert-image-url"),h=this.getResource("language-highlight-max-geometry-vertices-exceeded-alert-alt-text"),g={text:a,callback:function(){t._maxVerticesNotificationDisplayed=!1,t._doNotNotifyMaxVerticesAgain=!0,t.app.command("RemoveNotification").execute(t._geometryNotificationId)}},s={callback:function(){t._maxVerticesNotificationDisplayed=!1}};this._maxVerticesNotificationDisplayed=!0;var o={id:this._geometryNotificationId,text:i.format(this._maxHighlightableGeometryVertices),iconProperties:{uri:r,altText:h},buttons:[g],closeButton:s};this.app.command("DisplayNotification").execute(o)}},i.prototype._executeClearSavedGeometryEditHighlightId=function(){this._geometryEditHighlightId=""},i}(a.ModuleBase);i.HighlightModule=o})}}}),require({cache:{}}),define(["Mapping/modules/Highlight/HighlightModule"],function(t){e(t,"geocortex.essentialsHtmlViewer.mapping.modules.Highlight.HighlightModule",t.HighlightModule)})}();