function shim(e,t,a){if("string"==typeof e&&(a=t,t=e),"undefined"==typeof a)return void console.warn("Undefined shim for: "+t);for(var r=t.split("."),i=null,s=window,n=0,o=r.length;n<o;n++)i=r[n],n==o-1?s[i]=a:s[i]||(s[i]={}),s=s[i]}require({cache:{"Mapping/modules/LayerCatalog/AssemblyProvider":function(){define(["require","exports","./BaseProvider","geocortex/essentials/catalog/LayerCatalogParams","geocortex/essentials/catalog/LayerCatalogDetail","geocortex/essentials/MapService","geocortex/essentials/Layer","geocortex/essentials/MapServiceConstants","./WmsPropertyNames"],function(e,t,a,r,i,s,n,o,l){"use strict";var c=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.smartOrderUserAddedLayers=!0,t.flattenedList=[],t}return __extends(t,e),t.prototype.initialize=function(t){var a=this;e.prototype.initialize.call(this,t),this._registerCommands(),this.app.event("SiteInitializedEvent").subscribe(this,function(e){a.app.command("ShowLayerCatalog").raiseCanExecuteChanged()})},t.prototype._registerCommands=function(){this.app.command("RestoreDynamicLayer").register(this,this.restoreDynamicLayers),this.app.event("ProjectLoadingEvent").subscribe(this,this.executeClearLayerCatalogLayers)},t.prototype.smartOrderUserAddedLayersWhileLoadingProject=function(e,t){var a=e,r=new Array;r.push(t);var i=a.layers,s=this._getOrderedLayerIdArray(i,r);a.add(t),this._setDynamicLayerInfosWithSmartOrderedLayers(a,s)},t.prototype.restoreDynamicLayers=function(e){var t=e.gcxLayerDefinition,a=e.mapService,r=new n.Layer(t.url);r.createFromDefinition(t),r.isUserCreated=!0,r.catalogId=r.id,this.smartOrderUserAddedLayers?this.smartOrderUserAddedLayersWhileLoadingProject(a,r):a.add(r),this.app.event("MapServiceLayersChangedWithResultEvent").publish({mapService:a,newItems:[].concat([r]),oldItems:[].concat([])}),this.app.event("MapServiceLayersChangedEvent").publish(a),e.callback(r)},t.prototype.executeGetLayerCatalog=function(e){this.app.site.getLayerCatalog(new r.LayerCatalogParams,function(){},function(t){e.resolve(t)},function(t){e.reject(t)})},t.prototype.canExecuteGetLayerCatalog=function(){return this.canShowLayerCatalog()},t.prototype.executeGetLayerCatalogDetails=function(e,t){this.app.site.getLayerCatalogDetails(t,function(){},function(t){e.resolve(t)},function(t){e.reject(t)})},t.prototype.canExecuteGetLayerCatalogDetails=function(){return this.canExecuteGetLayerCatalog()},t.prototype.getFlatListAfterFiringGetLayerCatalog=function(e){var t=this;if(this.flattenedList&&this.flattenedList.length>0)e.resolve(this.flattenedList);else{var a=$.Deferred();this.executeGetLayerCatalog(a),a.done(function(a){t.flattenedList=t.getFlatEntries(a.catalogs[0].entries),e.resolve(t.flattenedList)})}},t.prototype.restoreMapService=function(e){var t=this,a=e.serviceLayer;if("WMS"!=a.layerType)return void e.callback(null);var r=new Array,i=a.layers;if(i.length>0)for(var s=0;s<i.length;s++)r.push(i[s].gcxLayerDefinition.catalogId);var n=$.Deferred(),o=$.Deferred(),l=new Array;this.getFlatListAfterFiringGetLayerCatalog(n),n.done(function(a){for(var i=a,s=0;s<r.length;s++){var n=t.getIdForWMSFromDisplayName(i,r[s]);l.push(n)}var c={ids:l};t.app.commandRegistry.command("GetLayerCatalogDetails").execute(o,c),o.done(function(a){t._createNewWmsServices(a.catalogs[0].entries,e.callback)})})},t.prototype.getIdForWMSFromDisplayName=function(e,t){for(var a=0;a<e.length;a++)if(e[a].displayName===t)return e[a].id},t.prototype.getFlatEntries=function(e){var t=new Array;if(e.length>0)for(var a=0;a<e.length;a++)if("folder"===e[a].type){var r=this.getFlatEntries(e[a].entries);if(r.length>0)for(var i=0;i<r.length;i++)t.push(r[i])}else t.push(e[a]);return t},t.prototype.executeApplyLayerCatalogDetails=function(e){if(e&&e.catalogs)for(var t=0;t<e.catalogs.length;t++)if(e.catalogs[t]){var a=e.catalogs[t];this._removeExistingCataLogWmsServices(),this._createNewWmsServices(a.entries),a&&this._createNewDynamicLayers(a)}},t.prototype._createNewDynamicLayers=function(e){var t=e.mapServiceId,a=[],r=new i.LayerCatalogDetail;r.mapServiceId=t;for(var s=0;s<e.entries.length;s++)e.entries[s].isDynamic&&a.push(e.entries[s]);r.entries=a;var n=this.app.site.essentialsMap.findMapServiceById(t);n&&this._addCatalogLayerToMapService(r,n)},t.prototype._addCatalogLayerToMapService=function(e,t){var a=!1,r=[];if(t.id==e.mapServiceId){for(var i=0;i<e.entries.length;i++){var s=e.entries[i],l=t.findLayerById(s.id);l||(l=new n.Layer(t.url+"/layers/"+e.entries[i].id),e.entries[i].visible=!0,l.createFromDefinition(e.entries[i]),l.isUserCreated=!0,l.userLayerType=o.UserLayerType.LAYER_CATALOG,l.includeInLayerList=!0,l.setInActiveTheme(!0),l.catalogId=l.id),r.push(l)}var c=t.layers.filter(function(e){return e.isUserCreated&&r.indexOf(e)<0}),d=r.filter(function(e){return t.layers.indexOf(e)<0});c.forEach(function(e){t.remove(e),a=!0});var p=this._getOrderedLayerIdArray(t.layers,d);return d.forEach(function(e){t.add(e),a=!0}),this.smartOrderUserAddedLayers&&this._setDynamicLayerInfosWithSmartOrderedLayers(t,p),a?(this.app.event("MapServiceLayersChangedWithResultEvent").publish({mapService:t,newItems:[].concat(d),oldItems:[].concat(c)}),this.app.event("MapServiceLayersChangedEvent").publish(t),d):[]}},t.prototype._getOrderedLayerIdArray=function(e,t){var a=this._getLayerIDArrayByGeoTypems(e,["point","multipoint"]),r=this._getLayerIDArrayByGeoTypems(e,["line"]),i=this._getLayerIDArrayByGeoTypems(e,["polygon"]),s=this._getLayerIDArrayByGeoTypems(t,["point","multipoint"]),n=this._getLayerIDArrayByGeoTypems(t,["line"]),o=this._getLayerIDArrayByGeoTypems(t,["polygon"]);return s.concat(a).concat(n).concat(r).concat(o).concat(i)},t.prototype._getLayerIDArrayByGeoTypems=function(e,t){var a=[];return e.forEach(function(e){t.indexOf(e.featureType.toLowerCase())>=0&&a.push(e.id)}),a},t.prototype._setDynamicLayerInfosWithSmartOrderedLayers=function(e,t){var a=e.serviceLayer,r=[],i=[];if(a.dynamicLayerInfos){r=a.dynamicLayerInfos;var i=[];t.forEach(function(e){for(var t=null,a=0;a<r.length;a++)if(r[a].id.toString()===e){t=r[a];break}t&&i.push(t)});var s=a.visibleLayers;a.setDynamicLayerInfos(i,!0),s.length>0?a.setVisibleLayers(s,!0):a.setVisibleLayers(["-1"],!0),a.refresh()}},t.prototype.canExecuteApplyLayerCatalogDetails=function(){return this.canExecuteGetLayerCatalog()},t.prototype.canShowLayerCatalog=function(){return!!(this.app.site&&this.app.site.essentialsMap&&this.app.site.essentialsMap.mapServices&&dojo.some(this.app.site.essentialsMap.mapServices,function(e){return e.hasLayerCatalog}))},t.prototype.executeClearLayerCatalogLayers=function(){this._removeExistingCataLogWmsServices(),this._removeAllCatalogLayersFromMap()},t.prototype.executeGetLayerCatalogMapServiceIds=function(e){for(var t=new Array,a=this.app.site.essentialsMap.mapServices,r=0;r<a.length;r++){var i=a[r];i.hasLayerCatalog&&t.push(i.id)}e.resolve(t)},t.prototype._removeExistingCataLogWmsServices=function(){if(this.app&&this.app.site&&this.app.site.essentialsMap&&this.app.site.essentialsMap.mapServices)for(var e=this.app.site.essentialsMap.mapServices,t=0;t<e.length;t++)if(e[t].isUserCreated&&e[t].hasLayerCatalog&&e[t].mapServiceType===o.MapServiceType.WMS){var a=e[t];this.app.site.essentialsMap.getMap().removeLayer(a.serviceLayer),e.splice(t,1),t--,this.app.eventRegistry.event("MapServiceRemovedEvent").publish(a)}},t.prototype._removeAllCatalogLayersFromMap=function(){if(this.app&&this.app.site&&this.app.site.essentialsMap&&this.app.site.essentialsMap.mapServices)for(var e=this.app.site.essentialsMap.mapServices,t=0;t<e.length;t++){var a=e[t];if(a.hasLayerCatalog){var r=new i.LayerCatalogDetail;r.mapServiceId=a.id,this.app.site.essentialsMap.applyCatalogLayersChange(r)}}},t.prototype._createNewWmsServices=function(e,t){for(var a=new Object,r=0;r<e.length;r++)if(!e[r].isDynamic)for(var i=0;i<e[r].properties.length;i++)if(e[r].properties[i].name===l.WMS_SERVICE_URL){var s=e[r].properties[i].value;a[s]||(a[s]=[]),a[s].push(e[r])}for(var n in a)a.hasOwnProperty(n)&&this._createWmsClosure(n,a,t)},t.prototype._createWmsClosure=function(e,t,a){var r=this,i=new esri.layers.WMSLayer(e),l=dojo.connect(i,"onLoad",function(l){var c=new s.MapService(l.url);c.mapServiceType=o.MapServiceType.WMS,c.serviceLayer=l,c.id=r._getUniqueMapServiceId(),c.catalogId=c.id,c.isUserCreated=!0,c.userLayerType=o.UserLayerType.LAYER_CATALOG,c.hasLayerCatalog=!0,c.drawingBehavior="MapService",c.displayName=l.title,c.configuredVisible=!0,c.serverVersion=l.version,c.includeInLayerList=!0,c.mapServiceFunction=o.MapServiceFunction.OPERATIONAL,c.essentialsMap=r.app.site.essentialsMap,c.serviceUrl=l.url,c._extendWms(),c._handleServiceLayerLoaded(c.serviceLayer),i.visible=!0,i.setImageFormat("image/png"),i.setOpacity(l.opacity);for(var p=[],y=0;y<t[e].length;y++){var u=new n.Layer(e);if(u.mapService=c,u.createFromDefinition(t[e][y]),u.name=r._getWmsLayerName(t[e][y]),u.wmsLayerName=u.name,r._fillEssLayerFromWmsLayerInfo(u,l.layerInfos),u.id=y.toString(),u.includeInLegend=!1,u.isUserCreated=!0,u.userLayerType=o.UserLayerType.LAYER_CATALOG,u.includeInLayerList=!0,u.configuredVisible=!0,u._visible=!0,u.catalogId=u.displayName,t[e][y]&&t[e][y].properties){var h=t[e][y].properties.filter(function(e){return"catalogDisplayName"==e.name})[0];h&&(u.catalogId=h.value)}p.push(u.id),c.layers.push(u)}i.setVisibleLayers(p),c.essentialsMap.getMap().addLayer(i),r.app.site.essentialsMap.mapServices.push(c),i.show(),r.app.eventRegistry.event("MapServiceAddedEvent").publish(c),a&&a(c),d()}),c=dojo.connect(i,"onError",function(e){throw a&&a(null),d(),new Error("Failed to get capabilities for WMS Service.")}),d=function(){dojo.disconnect(l),dojo.disconnect(c)}},t.prototype._fillEssLayerFromWmsLayerInfo=function(e,t){for(var a=this._flattenWmsLayerInfos(t),r=null,i=0;i<a.length;i++)if(a[i].name.toLowerCase()===e.wmsLayerName.toLowerCase()){r=a[i];break}r&&r.hasOwnProperty("extent")&&(e.fullExtent=r.extent)},t.prototype._flattenWmsLayerInfos=function(e){for(var t=[],a=0;a<e.length;a++){t.push(e[a]);var r=this._flattenWmsLayerInfos(e[a].subLayers);if(r.length>0)for(var i=0;i<r.length;i++)t.push(r[i])}return t},t.prototype._getUniqueMapServiceId=function(){var e=this.app.site.essentialsMap.mapServices;if(e){var t=[];if(dojo.forEach(e,function(e){t.push(e.id)}),t.length>0){var a=Math.max.apply(null,t);return a++,a.toString()}}return"0"},t.prototype._getWmsLayerName=function(e){if(e)for(var t=0;t<e.properties.length;t++)if(e.properties[t].name===l.WMS_LAYER_NAME)return e.properties[t].value;return null},t.prototype.executeRemoveLayerCatalogItem=function(e){var t=new Array,a=e.mapService;if(a.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer)a.remove(e),this._hackRefreshModules(a.serviceLayer.id);else if(a.serviceLayer instanceof esri.layers.WMSLayer){if(e.setVisibility(!1),a.layers.splice(a.layers.indexOf(e),1),0==a.layers.length){this.app.site.essentialsMap.mapServices.indexOf(a);return this.app.site.essentialsMap.removeMapService(a),void this.app.event("MapServiceRemoved").publish(a)}this._hackRefreshModules(a.serviceLayer.id)}t.push(e),this.app.event("MapServiceLayersChangedWithResultEvent").publish({mapService:a,newItems:[].concat([]),oldItems:[].concat(t)}),this.app.event("MapServiceLayersChangedEvent").publish(a)},t}(a.BaseProvider);t.AssemblyProvider=c})},"Mapping/modules/LayerCatalog/BaseLayerCatalogView":function(){define(["require","exports","geocortex/framework/ui/ViewBase","geocortex/essentials/catalog/CatalogEntry"],function(e,t,a,r){"use strict";var i=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.minFilterLength=3,t.autocompleteEnabled=!1,t}return __extends(t,e),t.prototype.attach=function(t){if(e.prototype.attach.call(this,t),this.configuration){if(this.configuration.hasOwnProperty("minFilterLength")){var a=parseInt(this.configuration.minFilterLength);a&&(this.minFilterLength=a)}this.configuration.hasOwnProperty("autocompleteEnabled")&&this.configuration.autocompleteEnabled&&(this.autocompleteEnabled=!0)}this.enableAutoComplete(this.autocompleteEnabled)},t.prototype.activated=function(){this.viewModel.ready()},t.prototype.enableAutoComplete=function(e){if(e){var t=this;$("#lc-filter-input").autocomplete({source:this.viewModel.autocompleteValues,minLength:this.minFilterLength,select:function(e,a){a&&a.item&&a.item.value&&(t.viewModel.filterText.set(a.item.value),t.handleSearch(null,null,null))}})}},t.prototype.handleSearch=function(e,t,a){},t.prototype.handleClickOk=function(e,t,a){this.viewModel.applyChanges(),this.app.commandRegistry.command("DeactivateView").execute("LayerCatalogView"),this.app.commandRegistry.command("ShowMap").execute()},t.prototype.handleClickCancel=function(e,t,a){this.app.commandRegistry.command("DeactivateView").execute("LayerCatalogView")},t.prototype._isSpecialChar=function(e){switch(e){case 16:case 17:case 18:case 19:case 20:case 27:case 33:case 34:case 35:case 36:case 37:case 38:case 39:case 40:case 144:case 145:return!0}return!1},t.prototype.handleShowDetails=function(e,t,a){var i=this.viewModel.infoLinkCommandName,s=new r.CatalogEntry;s.id=a.id,s.displayName=a.displayName,s.type=a.type,this.app.commandRegistry.command(i).execute(s)},t}(a.ViewBase);t.BaseLayerCatalogView=i})},"Mapping/modules/LayerCatalog/BaseLayerCatalogViewModel":function(){define(["require","exports","geocortex/framework/ui/ViewModelBase","geocortex/framework/observables","./CatalogEntryViewModel","geocortex/framework-ui/LazyObservable","geocortex/essentials/Layer","geocortex/essentials/catalog/LayerCatalogDetailsParams","geocortex/essentials/LayerHyperlink","./LayerCatalogModule","./WmsPropertyNames","./CatalogEntryType","geocortex/essentials/MapServiceConstants"],function(e,t,a,r,i,s,n,o,l,c,d,p,y){"use strict";var u=function(e){function t(t,a){var i=e.call(this,t,a)||this;return i.autocompleteValues=[],i.catalogCached=!1,i.clearButtonVisible=null,i.filteredCatalog=null,i.filterText=null,i.isBusy=null,i.showSelectedButtonText=null,i.showingAll=null,i.showInfoLink=!1,i.showNoLayersSelectedText=null,i.showMoreLayersText=null,i.showNotFinishedText=null,i.layerCatalogProviderFinished=!0,i.showLayerMessageText=null,i.filteredCatalog=new r.ObservableCollection,i.isBusy=new r.Observable((!1)),i.filterText=new r.Observable(""),i.showSelectedButtonText=new r.Observable(t.getResource(a,"language-layer-catalog-show-selected-button")),i.autocompleteValues=[],i.showNoLayersSelectedText=new r.Observable((!1)),i.showMoreLayersText=new r.Observable((!1)),i.showNotFinishedText=new r.Observable((!1)),i.showingAll=new r.Observable((!0)),i.clearButtonVisible=new r.Observable((!1)),i.showLayerMessageText=new r.Observable((!1)),i}return __extends(t,e),t.prototype.initialize=function(t){var a=this;e.prototype.initialize.call(this,t),dojo.subscribe("CatalogLayersChangedEvent",this,function(e){e&&a.app.event("MapServiceLayersChangedEvent").publish(e)}),this.app.event("OnAddCatalogLayersCommandEvent").subscribe(this,this._handleOnAddCatalogLayersCommandFired),this.app.event("OnAppendCatalogLayersCommandEvent").subscribe(this,this._handleOnAppendCatalogLayersCommandFired),this.app.event("LayerCatalogProviderUpdatedEvent").subscribe(this,this._handleLayerCatalogProviderUpdated),this.app.event("LayerCatalogProviderStartedEvent").subscribe(this,this._handleLayerCatalogProviderStarted),this.app.event("LayerCatalogProviderFinishedEvent").subscribe(this,this._handleLayerCatalogProviderFinished),this.loadConfiguration(t)},t.prototype.ready=function(){this.showMoreLayersText.set(!1),this._updatedLayerCatalogResults=null,this.catalogCached||this._getLayerCatalog(),this._calcShowText()},t.prototype._handleLayerCatalogProviderUpdated=function(e){this.showNotFinishedText.set(!1),this.showMoreLayersText.set(!0),this._updatedLayerCatalogResults=e,this.catalogCached=!1},t.prototype.refreshLayerCatalog=function(){this._updatedLayerCatalogResults&&(this._onLoadBegin(),this._onLoadCompleted(this._updatedLayerCatalogResults),this.ready())},t.prototype._calcShowText=function(){this.layerCatalogProviderFinished?(this.showNotFinishedText.set(!1),this.showLayerMessageText.set(!1)):(this.showNotFinishedText.set(!0),this.showLayerMessageText.set(!0))},t.prototype._handleLayerCatalogProviderStarted=function(){this.layerCatalogProviderFinished=!1},t.prototype._handleLayerCatalogProviderFinished=function(){this.layerCatalogProviderFinished=!0},t.prototype.loadConfiguration=function(e){var t=this;if(e){if(e.hasOwnProperty("infoLink")){var a=e.infoLink;a&&(this.showInfoLink=!!a.enabled,a.hasOwnProperty("command")&&(this.infoLinkCommandName=a.command),a.hasOwnProperty("tooltip")&&(this.infoLinkTooltip=a.tooltip),a.hasOwnProperty("text")&&(this.infoLinkText=a.text),a.hasOwnProperty("iconUri")&&(this.infoLinkIconUri=a.iconUri))}if(e.hasOwnProperty("filterProvider")){var r=e.filterProvider;r&&(this._lazyFilterProvider=new s.LazyObservable(null,function(){var e=dojo.getObject(r.type);if(!e)return void t.app.trace.error(t.id+" can't find layer catalog filter provider typed "+r.type);var a=new e(t.app,r.libraryId||t.libraryId);return a.initialize(r.configuration||{}),a},(!0)))}}},t.prototype.getFilterProvider=function(){return this._lazyFilterProvider?this._lazyFilterProvider.get():null},t.prototype.catalogLayersInLayerList=function(){var e=this,t=$.Deferred(),a=[],r=$.Deferred();this.app.commandRegistry.command("GetLayerCatalogMapServiceIds").execute(r);return r.done(function(r){var i=new Array,s={};e.app.site.essentialsMap.mapServices.forEach(function(e){s[e.id]=e}),r.forEach(function(e){var t=s[e];null!=t&&i.push(t)});for(var n=0;n<i.length;n++)for(var o=i[n],l=0;l<o.layers.length;l++)o.layers[l].isUserCreated&&a.push(o.layers[l]);t.resolve(a)}).fail(function(){t.reject()}),t.promise()},t.prototype.syncAddedLayers=function(){var e=this;this._resetCatalogVisibility(),this.catalogLayersInLayerList().done(function(t){for(var a=[],r=e._getFlattenedEntries(),i=0;i<t.length;i++){var s=e._findEntry(t[i],r);s&&(a.push(s),s.isChecked.set(!0))}for(var i=0;i<a.length;i++)for(var n=0;n<r.length&&a[i]!==r[n];n++);})},t.prototype.uncheckAllEntries=function(){this._resetCatalogVisibility()},t.prototype.applyChanges=function(){var e=this.getCheckedEntries(),t=e.length;if(e&&t>0){for(var a=new o.LayerCatalogDetailsParams,r=0;r<t;r++)a.ids.push(e[r].id);this._getLayerCatalogDetails(a)}else this.app.commandRegistry.command("ClearLayerCatalogLayers").execute()},t.prototype.loadLayerDetails=function(e,t,a){var r=new o.LayerCatalogDetailsParams;r.ids.push(e),this.app.site.getLayerCatalogDetails(r,function(){},function(e){if(e&&e.catalogs){var a=e.catalogs[0];if(a.entries){var r=a.entries[0];if(r){var i=new n.Layer("detailsLayer");if(i.createFromDefinition(r),r.hasOwnProperty("layerHyperlinks"))for(var s=0;s<r.layerHyperlinks.length;s++)i.layerHyperlinks[s]=new l.LayerHyperlink(r.layerHyperlinks[s],i);return void t(i)}}}t(null)},function(e){a(e)})},t.prototype._onLoadCompleted=function(e){if(this.filteredCatalog.clear(),e&&e.catalogs)for(var t=0;t<e.catalogs.length;t++)if(e.catalogs[t]){var a=e.catalogs[t];if(a.entries)for(var r=0;r<a.entries.length;r++){var s=i.CatalogEntryViewModel.fromJson(a.entries[r],this.app,this.libraryId);s&&(s.calculateShowGroupCheckbox(c.LayerCatalogModule.instance.checkboxVisibility,c.LayerCatalogModule.instance.checkboxSuffix),this.filteredCatalog.addItem(s))}}if(this._populateAutocompleteValues(),this.syncAddedLayers(),this.showInfoLink)for(var n=this._getFlattenedEntries(!0),t=0;t<n.length;t++)n[t].infoLinkVisible.set(!0),n[t].infoLinkTooltip.set(this.infoLinkTooltip),n[t].infoLinkText.set(this.infoLinkText),n[t].infoLinkIconUri.set(this.infoLinkIconUri);this.isBusy.set(!1),this.catalogCached=!0},t.prototype._populateAutocompleteValues=function(){for(var e=this._getFlattenedEntries(!0),t=0;t<e.length;t++)this.autocompleteValues.push(e[t].displayName);this.autocompleteValues.sort()},t.prototype._getLayerCatalog=function(){var e=this;this._onLoadBegin();var t=$.Deferred();this.app.commandRegistry.command("GetLayerCatalog").execute(t),t.done(function(t){e._onLoadCompleted(t)}).fail(function(){e._onLoadError(null)})},t.prototype._getLayerCatalogDetails=function(e){var t=this,a=$.Deferred();this.app.commandRegistry.command("GetLayerCatalogDetails").execute(a,e),a.done(function(e){t.app.commandRegistry.command("ApplyLayerCatalogDetails").execute(e)})},t.prototype._onLoadBegin=function(){this.isBusy.set(!0)},t.prototype._handleOnAddCatalogLayersCommandFired=function(e){if(e){var t=[];t=e.split(",");for(var a=new o.LayerCatalogDetailsParams,r=0;r<t.length;r++)a.ids.push(t[r]);this._getLayerCatalogDetails(a)}},t.prototype._handleOnAppendCatalogLayersCommandFired=function(e){var t=this;if(e){var a=[];a=e.split(",");for(var r=new o.LayerCatalogDetailsParams,i=0;i<a.length;i++)r.ids.push(a[i]);this.catalogLayersInLayerList().done(function(e){for(var a=t._getFlattenedEntries(!0),i=0;i<e.length;i++){var s=t._findEntry(e[i],a);if(s){var n=s.id;r.ids.indexOf(n)<0&&r.ids.push(n)}}}),this._getLayerCatalogDetails(r)}},t.prototype._getUniqueMapServiceId=function(){var e=this.app.site.essentialsMap.mapServices;if(e){var t=[];if(dojo.forEach(e,function(e){t.push(e.id)}),t.length>0){var a=Math.max.apply(null,t);return a++,a.toString()}}return"0"},t.prototype._getWmsLayerName=function(e){if(e)for(var t=0;t<e.properties.length;t++)if(e.properties[t].name===d.WMS_LAYER_NAME)return e.properties[t].value;return null},t.prototype._resetCatalogVisibility=function(){for(var e=this._getFlattenedEntries(),t=0;t<e.length;t++)e[t].isChecked.set(!1)},t.prototype._onLoadError=function(e){throw this.isBusy.set(!1),new Error(e.message)},t.prototype.getCheckedEntries=function(){for(var e=[],t=this._getFlattenedEntries(!0),a=0;a<t.length;a++)t[a].isChecked.get()&&e.push(t[a]);return e},t.prototype._getFlattenedEntries=function(e){return e?this._flattenCollection(this.filteredCatalog,!0):this._flattenCollection(this.filteredCatalog,!1)},t.prototype._flattenCollection=function(e,t){for(var a=[],r=0;r<e.get().length;r++)if(e.getAt(r).type===p.FOLDER){t||a.push(e.getAt(r));var i=this._flattenCollection(e.getAt(r).entries,t);if(i.length>0)for(var s=0;s<i.length;s++)a.push(i[s])}else a.push(e.getAt(r));return a},t.prototype._findEntry=function(e,t){var a=null,r=e.id,i=e.catalogId;null!=i&&(r=i);for(var s=0;s<t.length;s++)if(null!=e.wmsLayerName&&e.mapService.mapServiceType==y.MapServiceType.WMS){var n=e.properties.catalogDisplayName?e.properties.catalogDisplayName:e.displayName;if(t[s].displayName===n){a=t[s];break}}else if(t[s].id===r){a=t[s];break}return a},t}(a.ViewModelBase);t.LayerCatalogViewModelBase=u;var h;!function(e){e[e.all=0]="all",e[e.configuredOnly=1]="configuredOnly",e[e.none=2]="none"}(h=t.CheckboxVisibility||(t.CheckboxVisibility={}))})},"Mapping/modules/LayerCatalog/BaseProvider":function(){define(["require","exports","geocortex/geocortex"],function(e,t,a){"use strict";var r=function(){function e(e,t){this.layerListResolved=$.Deferred(),this.app=e,this.libraryId=t}return e.prototype.initialize=function(e){var t=this;this.app.event("LayerListInitializedEvent").once(this,function(e){t.layerList=e,t.layerListResolved.resolve()})},e.geocortexRequest=function(e){var t=$.Deferred();return a.request({url:e,content:{f:"json"},load:t.resolve,error:t.reject,callbackParamName:"Callback"}),t.promise()},e.prototype._geocortexRequest=function(t){return e.geocortexRequest(t)},e.prototype.executeGetLayerCatalog=function(e){e.reject()},e.prototype.canExecuteGetLayerCatalog=function(e){return!1},e.prototype.restoreMapService=function(e){},e.prototype.executeGetLayerCatalogDetails=function(e,t){e.reject()},e.prototype.canExecuteGetLayerCatalogDetails=function(e,t){return!1},e.prototype.executeApplyLayerCatalogDetails=function(e){},e.prototype.canExecuteApplyLayerCatalogDetails=function(e){return!1},e.prototype.executeClearLayerCatalogLayers=function(){},e.prototype.executeGetLayerCatalogMapServiceIds=function(e){e.reject()},e.prototype.canShowLayerCatalog=function(){return!1},e.prototype.getState=function(){return null},e.prototype.reset=function(e){},e.prototype.executeRemoveLayerCatalogItem=function(e){},e.prototype._hackRefreshModules=function(e){var t=this.app.site.getMap(),a=t.getLayer(e);a&&t.removeLayer(a),a._img=null,t.addLayer(a)},e}();t.BaseProvider=r})},"Mapping/modules/LayerCatalog/CatalogEntryType":function(){define(["require","exports"],function(e,t){"use strict";t.FOLDER="folder",t.LAYER="layer"})},"Mapping/modules/LayerCatalog/CatalogEntryViewModel":function(){define(["require","exports","geocortex/framework/ui/ViewModelBase","geocortex/framework/observables","./CatalogEntryType","geocortex/framework/utils/utils","./BaseLayerCatalogViewModel"],function(e,t,a,r,i,s,n){"use strict";var o=function(e){function t(t,a){var i=e.call(this,t,a)||this;return i.libraryId=null,i.id=null,i.expanded=null,i.isChecked=null,i.displayName=null,i.type=null,i.parent=null,i.visible=null,i.entries=null,i.bindingEntries=null,i.allChecked=null,i.someChecked=null,i.infoLinkVisible=null,i.infoLinkTooltip=null,i.infoLinkText=null,i.infoLinkIconUri=null,i.showGroupCheckbox=null,i.folderId=null,i.app=t,i.libraryId=a,i.entries=new r.ObservableCollection,i.isChecked=new r.Observable((!1)),i.allChecked=new r.Observable((!1)),i.someChecked=new r.Observable((!1)),i.expanded=new r.Observable((!1)),i.visible=new r.Observable((!0)),i.isChecked.bind(i,i._handleIsCheckedChanged),i.infoLinkVisible=new r.Observable((!1)),i.infoLinkTooltip=new r.Observable(""),i.infoLinkText=new r.Observable(""),i.infoLinkIconUri=new r.Observable(""),i.folderId=new r.Observable(""),i.showGroupCheckbox=new r.Observable((!1)),i.bindingEntries=new r.ObservableCollection,i.expanded.bind(i,function(e){e?i.bindingEntries.set(i.entries.get()):i.bindingEntries.clear()}),i}return __extends(t,e),t.fromJson=function(e,a,r){if(e.hasOwnProperty("id")&&e.hasOwnProperty("type")&&e.hasOwnProperty("displayName")){var n=new t(a,r);if(n.displayName=e.displayName,n.type=e.type,n.id=e.id,n.type==i.FOLDER&&n.folderId.set("folderItem-{0}".format(s.alphaNumericToken())),e.hasOwnProperty("entries"))for(var o=0;o<e.entries.length;o++){var l=t.fromJson(e.entries[o],a,r);l&&(n.entries.addItem(l),l.parent=n)}return n}return null},t.prototype.calculateShowGroupCheckbox=function(e,t){var a=!1;if(t&&""!=t&&this.displayName.endsWith(t)&&(this.displayName=this.displayName.slice(0,this.displayName.length-t.length),a=!0),this.type==i.FOLDER){var r=e==n.CheckboxVisibility.all||e==n.CheckboxVisibility.configuredOnly&&a;this.showGroupCheckbox.set(r)}this.entries&&this.entries.getItems().forEach(function(a){a.calculateShowGroupCheckbox(e,t)})},t.prototype.toggleAllChildren=function(e){this.entries.getItems().forEach(function(t){t.isChecked.set(e),t.toggleAllChildren(e)})},t.prototype.areAllChildrenChecked=function(){return!(this.entries&&this.entries.length()>0)||this.entries.getItems().every(function(e){return!e.visible.get()||e.isChecked.get()&&e.areAllChildrenChecked()})},t.prototype._handleIsCheckedChanged=function(e){if(this.type===i.FOLDER){var t=dojo.some(this.entries.get(),function(e){return e.isChecked.get()&&e.visible.get()}),a=!1;t&&(a=this.areAllChildrenChecked()),a?(this.allChecked.set(!0),this.someChecked.set(!1)):t?(this.allChecked.set(!1),this.someChecked.set(!0)):(this.allChecked.set(!1),this.someChecked.set(!1)),this.isChecked.get()!=t&&this.isChecked.set(t)}this.parent&&(this.parent.isChecked.set(this.isChecked.get()),this.app.configuration.mobileMode&&this.app.command("ReevaluateAllChecked").execute(this.parent.areAllChildrenChecked()))},t.prototype.filter=function(e){e?this.displayName.toLowerCase().indexOf(e.toLowerCase())>-1&&this.type===i.LAYER?(this.visible.set(!0),this.expandUpTree()):this.visible.set(!1):(this.visible.set(!0),this.expanded.set(!1));for(var t=0;t<this.entries.get().length;t++)this.entries.getAt(t).filter(e);this._setFolderVisibilityBasedOnChildren()},t.prototype.expandUpTree=function(){this.parent&&(this.parent.expanded.get()||this.parent.expanded.set(!0),this.parent.expandUpTree())},t.prototype.expandAll=function(e){this.expanded.set(e);for(var t=0;t<this.entries.get().length;t++)this.entries.getAt(t).expandAll(e)},t.prototype._setFolderVisibilityBasedOnChildren=function(){var e=!1;if(this.type===i.FOLDER){for(var t=0;t<this.entries.get().length;t++)if(this.entries.getAt(t)._setFolderVisibilityBasedOnChildren()){e=!0;break}this.visible.set(e)}else this.visible.get()&&(e=!0);return e},t}(a.ViewModelBase);t.CatalogEntryViewModel=o})},"Mapping/modules/LayerCatalog/DeferredUtils":function(){define(["require","exports"],function(e,t){"use strict";var a=function(){function e(){}return e.createDeferredList=function(e){var t=$.Deferred(),a=[];return $.when.apply($,e).then(function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];for(var i=0;i<e.length;i++)a.push(e[i]);t.resolve(a)}).fail(function(e){t.reject(e)}),t.promise()},e}();t.Deferred=a})},"Mapping/modules/LayerCatalog/Dictionary":function(){define(["require","exports"],function(e,t){"use strict";var a=function(){function e(){this._backingStore={}}return e.prototype.containsKey=function(e){return this._backingStore.hasOwnProperty(e)},e.prototype.get=function(e){return this._backingStore[e]},e.prototype.set=function(e,t){this._backingStore[e]=t},e.prototype.deleteEntry=function(e){delete this._backingStore[e]},e.prototype.values=function(){var e=new Array;for(var t in this._backingStore)e.push(this._backingStore[t]);return e},e.prototype.clear=function(){for(var e in this._backingStore)delete this._backingStore[e]},e.prototype.keys=function(){var e=new Array;for(var t in this._backingStore)e.push(t);return e},e.fromArray=function(t,a){for(var r=new e,i=0;i<t.length;i++){var s=t[i],n=a(s);r.set(n,s)}return r},e}();t.Dictionary=a})},"Mapping/modules/LayerCatalog/EssentialsSiteProvider":function(){define(["require","exports","./BaseProvider","./Dictionary","geocortex/infrastructure/layerList/LayerListItem","geocortex/infrastructure/layerList/LayerListFolderItem","./LayerCatalogConstructor","./DeferredUtils","./MapUtilities","geocortex/essentials/MapServiceConstants","geocortex/infrastructure/commandArgs/AddStatusArgs","geocortex/infrastructure/layerList/LayerListLayerItem","geocortex/infrastructure/gis/ServiceLayerInfo","geocortex/infrastructure/layerList/LayerListMapServiceItem","./LayerCatalogModule"],function(e,t,a,r,i,s,n,o,l,c,d,p,y,u,h){"use strict";var g=function(t){function a(){var e=null!==t&&t.apply(this,arguments)||this;return e._siteUrls=new Array,e._restoredMapServicesPromises=new Array,e._mapServiceCreatedPromises=new Array,e._failedMapServices=new Array,e._failedLayerNames=new Array,e}return __extends(a,t),a.prototype.initialize=function(e){var a=this;t.prototype.initialize.call(this,e),this._layerCatalogFolderInLayerList=!1,this._addedMapServices=new r.Dictionary,this._addedLayerListItems=new r.Dictionary,this._layerListLookup=new r.Dictionary,this._fetchedMapServiceJsons=new r.Dictionary,this._atLeastOneLayerListDeferred=$.Deferred(),this._allLayerListsFinished=$.Deferred(),this._restoredMapServices=new Array;var i,l=new Array;this.app.event("SiteInitializedEvent").subscribe(this,function(e){if(e.layerCatalogs.length>0){for(var t=0;t<e.layerCatalogs.length;t++)a._siteUrls[t]=e.url.replace(e.id,e.layerCatalogs[t].siteId.toString());i=a._siteUrls.map(function(e){return{siteUrl:e,rootFolder:null}})}if(i){a.layerListResolved.done(function(){a._layerListRoot||(a._layerListRoot=new s.LayerListFolderItem("LayerCatalogRoot",a.app.getResource(a.libraryId,"language-layer-catalog-home-text"),a.layerList),a._layerListRoot.isUserCreated=!0,a._layerListRoot.configuredVisible=!0)});var r=0;i.forEach(function(e,t){var i=a._geocortexRequest(e.siteUrl+"/map/layerlist?verbose=true");i.done(function(r){var i=e.rootFolder?[{type:"folder",name:e.rootFolder,items:r.items}]:r.items;a._processLayerListLookup(i,null,t),a._atLeastOneLayerListDeferred.resolve(),a.app.event("LayerCatalogProviderUpdatedEvent").publish(new n.LayerCatalogConstructor(a._layerListLookup));
}),i.always(function(){r+=1,1==r&&a.app.event("LayerCatalogProviderStartedEvent").publish(),r==a._siteUrls.length&&a.app.event("LayerCatalogProviderFinishedEvent").publish()}),l.push(i)}),o.Deferred.createDeferredList(l).done(function(){a._allLayerListsFinished.resolve()}).fail(function(){a._allLayerListsFinished.reject()})}a.app.command("ShowLayerCatalog").raiseCanExecuteChanged()})},a.prototype.restoreMapService=function(t){var a=this,r=$.Deferred();this._restoredMapServicesPromises.push(r),this._getMapServiceJson(t.lookupId).done(function(r){if(r){r.properties.push({name:"layerCatalogLookupId",value:t.lookupId});var i=t.lookupId.split(".")[0],s=a._getSeedSiteUrlFromSiteId(i),n=$.Deferred();a._mapServiceCreatedPromises.push(n);var o=null,d=[];t.layerLookupIds.forEach(function(e){var i=e.indexOf(".",e.indexOf(".")+1);if(i!=-1)var s=e.substring(i+1);if(s){if(o=r.layers.filter(function(e){return e.name==s})[0],!o)return void a._failedMapServices.push(t.lookupId);o.properties.push({name:"layerCatalogLookupId",value:e})}else o=r;o&&d.push(o)}),l.MapUtilities.createMapServiceFromJson(r,s).done(function(r){d.forEach(function(t){var i=r.serviceLayer;if(e(["esri/layers/VectorTileLayer"],function(e){i instanceof e&&l.MapUtilities.addLayerToVectorTiledService(t,r)}),i instanceof esri.layers.WebTiledLayer)l.MapUtilities.addLayerToWebTiledService(t,r);else if(i instanceof esri.layers.ArcGISDynamicMapServiceLayer)r.mapServiceType===c.MapServiceType.TILED&&l.MapUtilities.addLayerToTiledService(t,r),i.supportsDynamicLayers&&(r.supportsDynamicLayers=!0),l.MapUtilities.addLayersWithDynamicDefinitions([t],r),l.MapUtilities.addLayersToDynamicMapService([t],r);else if(i instanceof esri.layers.FeatureLayer&&!(i instanceof esri.layers.StreamLayer))l.MapUtilities.addLayerToFeatureService(t,r);else if(i instanceof esri.layers.WFSLayer);else if(i instanceof esri.layers.WMTSLayer);else if(i instanceof esri.layers.StreamLayer);else if(i instanceof esri.layers.ArcGISImageServiceLayer)l.MapUtilities.addLayerToImageService(t,r);else if(i instanceof esri.layers.ArcGISTiledMapServiceLayer)l.MapUtilities.addLayerToTiledService(t,r);else if(i instanceof esri.virtualearth.VETiledLayer)l.MapUtilities.addLayerToBingService(t,r);else if(i instanceof esri.layers.WMSLayer){var s=r.catalogId.split(".")[0],n=a._getSeedSiteUrlFromSiteId(s);l.MapUtilities.addLayersToWMSService([t],r,n)}}),r.id=t.mapServiceId,r.serviceLayer.id=r.id,a._addedMapServices.get(r.catalogId)?(a.app.site.getMap().removeLayer(r.serviceLayer),a.app.site.essentialsMap.removeMapService(a._addedMapServices.get(r.catalogId)),a.app.site.essentialsMap.mapServices.push(r),a._addedMapServices.set(r.catalogId,r)):(a.app.site.essentialsMap.mapServices.push(r),a._mapServiceEvent(r,"MapServiceAddedEvent")),a._restoredMapServices.push(r),t.callback(r)}).fail(function(){a._failedMapServices.push(t.lookupId),t.callback(null)}).always(function(){n.resolve()})}}).fail(function(){a._failedMapServices.push(t.lookupId),t.callback(null)}).always(function(){r.resolve()})},a.prototype.reset=function(e){var t=this;this._allLayerListsFinished.always(function(){t.addStatus(t.app.getResource(t.libraryId,"language-layer-catalog-restoration-status"),"LayerCatalogRestoration"),o.Deferred.createDeferredList(t._restoredMapServicesPromises).always(function(){o.Deferred.createDeferredList(t._mapServiceCreatedPromises).always(function(){var e=t._addedMapServices.keys();t.executeClearLayerCatalogLayers();var a=t.app.site.getMap();t._restoredMapServices.forEach(function(r){e.indexOf(r.catalogId)>-1&&(t.app.site.essentialsMap.mapServices.push(r),t._mapServiceEvent(r,"MapServiceAddedEvent")),r.serviceLayer instanceof esri.layers.WMSLayer&&r.serviceLayer.setVisibleLayers(r.layers.map(function(e){return e.wmsLayerName})),r.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer&&r.serviceLayer.setVisibleLayers(r.layers.map(function(e){return e.id})),a.addLayer(r.serviceLayer),t._addedMapServices.set(r.catalogId,r),t._createLayerListItems(r)});var r="The following map services fully or partially were unable to be restored: "+t._failedMapServices.join(", ");t._failedMapServices.length>0&&t.app.trace.warning(r),t._restoredMapServices.length=0,t.layerList._processEligibleSingleMapServiceFolders(),t._layerListRoot.refreshOnDemandItemCollection(),t._restoredMapServicesPromises.length=0,t._mapServiceCreatedPromises.length=0,t._failedLayerNames.length=0,t._failedMapServices.length=0,t._layerListRoot.setItemVisibility(!1),setTimeout(function(){t._layerListRoot.setItemVisibility(!0)},100),t.removeStatus("LayerCatalogRestoration")})})})},a.prototype._treeItemCmp=function(e,t){var a=this._layerListLookup.get(e),r=this._layerListLookup.get(t),i=a.siteIndex,s=r.siteIndex;if(i==s){var n=a.order,o=r.order;return n-o}return i-s},a.prototype._processLayerListLookup=function(e,t,a){var r=this;e.forEach(function(e,i){var s,n,o=new Array,l=r._getSeedSiteIdFromUrl(r._siteUrls[a]);if("folder"==e.type){var c=r._generateFolderId(e,t);e.items&&(o=r._generateItemsChildrenIds(e,c,l),r._processLayerListLookup(e.items,c,a));var d=r._layerListLookup.get(c);if(null!=d)return void r._editExistingLookupItem(d,a,i,o);s=c,n=!0}else s=null!=e.layerID?"{0}.{1}.{2}".format(l,e.mapServiceID,e.layerName):"{0}.{1}".format(l,e.mapServiceID),n=!1;if(s){var p={childrenLookupIds:o,siteIndex:a,order:i,parentLookupId:t,displayName:e.name,addedChildrenLookupIds:new Array,isFolder:n};r._layerListLookup.set(s,p)}})},a.prototype._generateItemsChildrenIds=function(e,t,a){var r=e.items.map(function(e){return"folder"==e.type?"{0}.{1}".format(t,e.name):null!=e.layerID?"{0}.{1}.{2}".format(a,e.mapServiceID,e.layerName):"{0}.{1}".format(a,e.mapServiceID)});return r},a.prototype._generateFolderId=function(e,t){var a=e.name;return t&&""!=t&&(a="{0}.{1}".format(t,a)),a},a.prototype._editExistingLookupItem=function(e,t,a,r){t<e.siteIndex&&(e.siteIndex=t,e.order=a),r.forEach(function(t){var a=e.childrenLookupIds.indexOf(t);a>=0||e.childrenLookupIds.push(t)}),e.childrenLookupIds.sort(dojo.hitch(this,this._treeItemCmp))},a.prototype.executeGetLayerCatalog=function(e){var t=this;this.layerListResolved.done(function(){t._atLeastOneLayerListDeferred.done(function(){var a=new n.LayerCatalogConstructor(t._layerListLookup);e.resolve(a)})})},a.prototype.canExecuteGetLayerCatalog=function(){return this.canShowLayerCatalog()},a.prototype.executeGetLayerCatalogDetails=function(e,t){var a=this;this.addStatus(this.app.getResource(this.libraryId,"language-layer-catalog-get-layer-details-status"),"GetLayerDetails");var r=new Array,i=t.ids.filter(function(e){return a._isLookupIdForAMapService(e)}),s=t.ids.filter(function(e){return!a._isLookupIdForAMapService(e)}),n=s.map(function(e){return a._getMapServiceKeyFromLayerLookupId(e)});this._getAndSetMapServiceJsons(n).always(function(){var t=new Array;s.forEach(function(e){var i=e.indexOf(".",e.indexOf(".")+1);if(i!=-1)var s=e.substring(i+1);var n=a._getMapServiceKeyFromLayerLookupId(e),o=a._fetchedMapServiceJsons.get(n);if(o){o.properties.push({name:"layerCatalogLookupId",value:n});var l=o.layers.filter(function(e){return e.name==s})[0];if(l){l.properties.push({name:"layerCatalogLookupId",value:e});var c=$.Deferred();c.resolve(l),r.push(c)}else t.push(e)}else t.push(e)}),i.forEach(function(e){var i=$.Deferred();r.push(i.promise()),a._getMapServiceJson(e).done(function(t){t.properties.push({name:"layerCatalogLookupId",value:e}),i.resolve(t)}).fail(function(){t.push(e),i.resolve(null)})}),o.Deferred.createDeferredList(r).done(function(r){a.removeStatus("GetLayerDetails"),t.length>0&&a.app.command("Alert").execute(a.app.getResource(a.libraryId,"language-layer-catalog-failed-items-error").format(t.join(", "))),e.resolve({catalogs:[{entries:r,mapServiceId:"N/A"}]})})})},a.prototype._getAndSetMapServiceJsons=function(e){var t=this,a=new Array;return e.forEach(function(e){var r=$.Deferred();t._fetchedMapServiceJsons.containsKey(e)||(a.push(r),t._getMapServiceJson(e).done(function(a){t._fetchedMapServiceJsons.set(e,a),r.resolve()}).fail(function(){r.reject()}))}),o.Deferred.createDeferredList(a)},a.prototype._getMapServiceKeyFromLayerLookupId=function(e){if(this._isLookupIdForAMapService(e))return e;var t=e.split("."),a=t[0]+"."+t[1];return a},a.prototype._isLookupIdForAMapService=function(e){var t=e.split(".");return 2==t.length},a.prototype._getMapServiceJson=function(e){var t=$.Deferred(),a=this._getMapServiceRestUrl(e);return this._geocortexRequest(a).done(function(e){t.resolve(e)}).fail(function(){t.reject()}),t.promise()},a.prototype._getMapServiceRestUrl=function(e){var t,a=e.split("."),r=a[0],i=this._getSeedSiteUrlFromSiteId(r),s=a[1];return t="{0}/map/mapservices/{1}?deep=true".format(i,s)},a.prototype.canExecuteGetLayerCatalogDetails=function(){return this.canExecuteGetLayerCatalog()},a.prototype.addStatus=function(e,t){console.log("Adding status:"+t);var a=new d.AddStatusArgs(e,null,null,t,3e4,(!0));this.app.command("AddStatus").execute(a)},a.prototype.removeStatus=function(e){this.app.command("RemoveStatus").execute(e)},a.prototype.executeApplyLayerCatalogDetails=function(e){if(this.addStatus(this.app.getResource(this.libraryId,"language-layer-catalog-updating-layer-list-status"),"UpdatingLayerList"),e&&e.catalogs)for(var t=0;t<e.catalogs.length;t++)if(e.catalogs[t]){for(var a=e.catalogs[t],r=[],i=this._addedLayerListItems.keys(),t=0;t<i.length;t++){var n=this._addedLayerListItems.get(i[t]);n instanceof s.LayerListFolderItem&&r.push(n)}this.layerList._addedFolderReferences.forEach(function(e){r.some(function(t){return t===e})&&e.canAdjustOpacity.set(!1)}),this._removeEntriesIfNecessary(a.entries),this._addEntriesToMap(a.entries)}},a.prototype.executeRemoveLayerCatalogItem=function(e){var t=e.catalogId,a=this.getState(),r=a.layers.filter(function(e){return t.indexOf(e.layerId)<0}).map(function(e){return{properties:[{name:"layerCatalogLookupId",value:e.layerId}]}});this._removeEntriesIfNecessary(r)},a.prototype._removeEntriesIfNecessary=function(e){var t=this,a=new r.Dictionary;if(e.forEach(function(e){if(e){var t=e.properties.filter(function(e){return"layerCatalogLookupId"==e.name})[0];null!=t&&a.set(t.value,t.value)}}),0==e.length)return void this.executeClearLayerCatalogLayers();var i=this._addedMapServices.keys();i.forEach(function(e){var r=t._addedMapServices.get(e),i=t._findLayersToBeRemoved(r,a),s=i.map(function(e){return r.layers[e].catalogId});i.forEach(function(e){r.supportsLayerVisibility()&&r.layers[e].setVisibility(!1),r.layers.splice(e,1)}),s.forEach(function(e){t._removeItemFromLayerList(e)}),0==r.layers.length?t._removeMapService(e):(r.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer||r.serviceLayer instanceof esri.layers.WMSLayer)&&t._hackRefreshModules(r.serviceLayer.id),t._resetMapServiceReferences(r)}),this._layerListRoot.refreshOnDemandItemCollection();var s=this.layerList._addedFolderReferences.filter(function(e){return 0==e.children.length()}),n=s.map(function(e){return t.layerList._addedFolderReferences.indexOf(e)});n.reverse(),n.forEach(function(e){t.layerList._addedFolderReferences.splice(e,1)})},a.prototype._removeMapService=function(e){var t=this._addedMapServices.get(e),a=this.app.site.essentialsMap.mapServices.indexOf(t);a>-1&&this.app.site.essentialsMap.mapServices.splice(a,1),this.app.site.getMap().removeLayer(t.serviceLayer),this._addedMapServices.deleteEntry(e),this.layerList.removeServiceLayer(t.serviceLayer);var r=this.layerList._allMapServiceReferences.filter(function(e){return e.id==t.id})[0],a=this.layerList._allMapServiceReferences.indexOf(r);a>-1&&this.layerList._allMapServiceReferences.splice(a,1)},a.prototype._findLayersToBeRemoved=function(e,t){for(var a=new Array,r=e.layers,i=r.length-1;i>=0;i--){var s=r[i],n=s.catalogId;null!=n&&(t.containsKey(n)||a.push(i))}return a},a.prototype._removeItemFromLayerList=function(e){var t=this._layerListLookup.get(e),a=this._addedLayerListItems.get(e),r=this._addedLayerListItems.get(t.parentLookupId),s=this._layerListLookup.get(t.parentLookupId);if(s&&s.addedChildrenLookupIds.splice(s.addedChildrenLookupIds.indexOf(e),1),a&&(r?r.children.removeItem(a):this._layerListRoot.children.indexOf(a)>=0&&this._layerListRoot.children.removeItem(a),a.type==i.LayerListItemType.LAYER)){var n=a;n.layer&&n.layer.serviceLayerInfo&&(n.layer.serviceLayerInfo.id=null)}this._addedLayerListItems.deleteEntry(e),s&&(0==s.addedChildrenLookupIds.length?this._removeItemFromLayerList(t.parentLookupId):r&&r.refreshOnDemandItemCollection())},a.prototype.executeGetLayerCatalogMapServiceIds=function(e){var t=this,a=this._addedMapServices.keys(),r=new Array;a.forEach(function(e){var a=t._addedMapServices.get(e).id;r.push(a)}),e.resolve(r)},a.prototype.canExecuteApplyLayerCatalogDetails=function(){return this.canExecuteGetLayerCatalog()},a.prototype.canShowLayerCatalog=function(){return this._siteUrls.length>0},a.prototype.executeClearLayerCatalogLayers=function(){var e=this,t=this._addedMapServices.keys();t.forEach(function(t){e.app.event("MapServiceRemovedEvent").publish(e._addedMapServices.get(t)),e._removeMapService(t)});var a=this.layerList._userAddedLayersFolder;if(a){var r=a.children.getItems().filter(function(e){return"LayerCatalogRoot"==e.id.get()})[0],s=a.children.indexOf(r);r&&(a.children.getAt(s).children.clear(),a.children.removeAt(s),a.refreshOnDemandItemCollection())}var t=this._layerListLookup.keys();t.forEach(function(t){var a=e._layerListLookup.get(t);a.addedChildrenLookupIds.length=0}),this._addedLayerListItems.keys().forEach(function(t){var a=e._addedLayerListItems.get(t);if(a.type==i.LayerListItemType.FOLDER){var r=e.layerList._addedFolderReferences.map(function(e){return e.id.get()}).indexOf(a.id.get());e.layerList._addedFolderReferences.splice(r,1)}e._removeItemFromLayerList(t)});var n=this.layerList._addedFolderReferences.map(function(e){return e.id.get()}).indexOf("LayerCatalogRoot");this.layerList._addedFolderReferences.splice(n,1),this._addedLayerListItems.clear();var o=this.layerList.children.indexOf(this._layerListRoot);o>=0&&!this._layerListRoot.children.getLength()&&(this.layerList.children.getAt(o).cleanUp(),this.layerList.children.removeAt(o)),this._layerCatalogFolderInLayerList=!1},a.prototype._addEntriesToMap=function(e){var t=this,a=new Array;e.forEach(function(e){if(e){var r=e.properties.filter(function(e){return"layerCatalogLookupId"==e.name})[0],i=r.value.split("."),s=i[0],n=t._siteUrls.indexOf(t._getSeedSiteUrlFromSiteId(s)),o=i[1],l=!1;if(2==i.length)l=!0;else{var c=a.filter(function(e){return e.mapServiceId==o&&e.siteIndex==n})[0];null==c?l=!0:c.layerJsons.push(e)}if(l){var d={siteIndex:n,siteId:s,mapServiceId:o,layerJsons:[e]};a.push(d)}}});var r=new Array;a.forEach(function(e,a){var i=$.Deferred();r[a]=i.promise(),t._applyLayerCatalogDetailsToMapService(e).always(function(){i.resolve()})}),o.Deferred.createDeferredList(r).always(function(){t.layerList._processEligibleSingleMapServiceFolders(),t._layerListRoot.refreshOnDemandItemCollection(),t.removeStatus("UpdatingLayerList")})},a.prototype._applyLayerCatalogDetailsToMapService=function(t){var a=this,r=$.Deferred(),i=this.app.site.getMap(),s=$.Deferred(),n="{0}.{1}".format(t.siteId,t.mapServiceId),o=this._addedMapServices.get(n);return null!=o?s.resolve(o):this._getNewMapService(n).done(function(e){a._isLayerInLayerList(e.serviceLayer)?(a.app.trace.error("We can't add the same service layer twice to the layer list"),s.reject()):(a.app.site.essentialsMap.mapServices.push(e),a._addedMapServices.set(n,e),s.resolve(e))}).fail(function(){s.reject()}),s.done(function(s){var n=s.serviceLayer,o=t.layerJsons;if(e(["esri/layers/VectorTileLayer"],function(e){n instanceof e&&l.MapUtilities.addLayerToVectorTiledService(o[0],s)}),n instanceof esri.layers.WebTiledLayer)l.MapUtilities.addLayerToWebTiledService(o[0],s);else if(n instanceof esri.layers.ArcGISDynamicMapServiceLayer)s.mapServiceType===c.MapServiceType.TILED&&l.MapUtilities.addLayerToTiledService(o[0],s),n.supportsDynamicLayers&&(s.supportsDynamicLayers=!0),l.MapUtilities.addLayersWithDynamicDefinitions(o,s),l.MapUtilities.addLayersToDynamicMapService(o,s);else if(n instanceof esri.layers.FeatureLayer&&!(n instanceof esri.layers.StreamLayer))l.MapUtilities.addLayerToFeatureService(o[0],s);else if(n instanceof esri.layers.WFSLayer);else if(n instanceof esri.layers.WMTSLayer);else if(n instanceof esri.layers.StreamLayer);else if(n instanceof esri.layers.ArcGISImageServiceLayer)l.MapUtilities.addLayerToImageService(o[0],s);else if(n instanceof esri.layers.ArcGISTiledMapServiceLayer)l.MapUtilities.addLayerToTiledService(o[0],s);else if(n instanceof esri.virtualearth.VETiledLayer)l.MapUtilities.addLayerToBingService(o[0],s);else if(n instanceof esri.layers.WMSLayer){var d=s.catalogId.split(".")[0],p=a._getSeedSiteUrlFromSiteId(d);l.MapUtilities.addLayersToWMSService(o,s,p)}a._mapServiceEvent(s,"MapServiceRemovedEvent"),a._mapServiceEvent(s,"MapServiceAddedEvent"),a._createLayerListItems(s),i.getLayer(s.serviceLayer.id)&&"Dynamic"==s.mapServiceType?a._hackRefreshModules(s.serviceLayer.id):i.addLayer(n),r.resolve()}).fail(function(){r.reject()}),r.promise()},a.prototype._getNewMapService=function(e){var t=this,a=$.Deferred();if(this._fetchedMapServiceJsons.containsKey(e)){var r=this._fetchedMapServiceJsons.get(e),i=e.split(".")[0],s=this._getSeedSiteUrlFromSiteId(i);l.MapUtilities.createMapServiceFromJson(r,s).done(function(e){a.resolve(e)})}else this._getMapServiceJson(e).done(function(r){r.properties.push({name:"layerCatalogLookupId",value:e}),t._fetchedMapServiceJsons.set(e,r);var i=e.split(".")[0],s=t._getSeedSiteUrlFromSiteId(i);l.MapUtilities.createMapServiceFromJson(r,s).done(function(e){a.resolve(e)})});return a.promise()},a.prototype._resetMapServiceReferences=function(e,t){t=t||y.ServiceLayerInfo.fromGcxMapService(e);for(var a=this.layerList._allMapServiceReferences,r=0;r<a.length;r++)t.id==a[r].id&&(a[r]=t);var i=c.MapServiceType;if([i.TILED,i.WEBTILED,i.IMAGE,i.BING,i.VECTORTILE].indexOf(t.serviceType)>-1)for(var s=this.layerList._handledMapServiceReferences,r=0;r<s.length;r++)t.id==s[r].id&&(s[r]=t);for(var n=this.layerList._addedFolderReferences,r=0;r<n.length;r++)for(var o=n[r].containedMapServices,l=0;l<o.length;l++)if(t.id==o[l].id){o[l]=t;break}},a.prototype._isLayerInLayerList=function(e){for(var t=this.layerList.getDescendants(),a=0;a<t.length;a++){var r=t[a];if(r.mapService&&r.mapService.serviceLayer.url===e.url&&!r.mapService.isUserCreated)return!0}return!1},a.prototype._createLayerListItems=function(e){var t=this,a=y.ServiceLayerInfo.fromGcxMapService(e);this._resetMapServiceReferences(null,a);var r=function(e,a){e._applyDeferredInitialVisibility(),e.unbindFromActiveTheme(),e.inActiveTheme.set(!0),t._addToLayerList(e,a)};switch(e.mapServiceType){case c.MapServiceType.TILED:case c.MapServiceType.WEBTILED:case c.MapServiceType.IMAGE:case c.MapServiceType.BING:case c.MapServiceType.VECTORTILE:case c.MapServiceType.WMTS:e.layers[0].catalogId||(e.layers[0].catalogId=e.catalogId);var i=e.layers[0].catalogId;if(null!=i&&!this._addedLayerListItems.containsKey(i)){var s=new u.LayerListMapServiceItem(e.layers[0].id,a,this.layerList);s.setItemVisibility(!0),r(s,i),s.populateMapServicesInParentFolders()}break;case c.MapServiceType.DYNAMIC:case c.MapServiceType.FEATURE:case c.MapServiceType.WMS:case c.MapServiceType.WFS:case c.MapServiceType.STREAM:e.layers[0].catalogId||(e.layers[0].catalogId=e.catalogId),a.layers.forEach(function(e){var a=e.gcxLayer.catalogId;if(null!=a&&!t._addedLayerListItems.containsKey(a)){var i=new p.LayerListLayerItem(e.id,e,t.layerList);i.canNotAssignVisibility.set(!1),r(i,a),t._resetAddedFolderReferences(),i.populateMapServicesInParentFolders()}})}},a.prototype._resetAddedFolderReferences=function(){var e=this,t=new r.Dictionary,a=new r.Dictionary,s=0,n=new Array,o=function(e){n.length=0,e.forEach(function(e){a.set(e,s++);var r=t.get(e);r&&r.children&&r.children.getItems().forEach(function(e){e.type==i.LayerListItemType.FOLDER&&n.push(e.id.get())})}),n.length>0&&o(n.slice())};this.layerList._addedFolderReferences.forEach(function(a){t.set(a.id.get(),a),a.parent&&a.parent!=e.layerList._userAddedLayersFolder||n.push(a.id.get())}),o(n.slice()),this.layerList._addedFolderReferences.sort(function(e,t){return a.get(e.id.get())-a.get(t.id.get())})},a.prototype._mapServiceEvent=function(e,t){var a,r,i,s=this.app.event(t),n=Object.keys(s.subscriptions);for(a=0;a<n.length;a++){var o=s.subscriptions[n[a]];if(o.scope&&o.scope.id&&"module-Mapping-LayerList"===o.scope.id){r=n[a],i=o;break}}r&&s.unsubscribe(r),this.app.event(t).publish(e),s.subscriptions[r]=i},a.prototype._addToLayerList=function(e,t){var a=this._layerListLookup.get(t);a||new Error("Layer list tree structure unable to be built for the following item: "+t),null!=a.parentLookupId?this._addChildToLayerList(e,t):this._addOrphanToLayerList(e,t)},a.prototype._addChildToLayerList=function(e,t){var a=this._layerListLookup.get(t),r=this._addedLayerListItems.get(a.parentLookupId),i=this._layerListLookup.get(a.parentLookupId);if(null==r){var n=h.LayerCatalogModule.instance.checkboxSuffix;n&&""!=n&&i.displayName.endsWith(n)&&(i.displayName=i.displayName.slice(0,i.displayName.length-n.length));var o=new s.LayerListFolderItem(a.parentLookupId,i.displayName,this.layerList);o.isUserCreated=!0,o.children.addItem(e),i.addedChildrenLookupIds.push(t),o.isExpanded.set(!0),o.configuredVisible=!0,o.isVisible.set(!0),this._addToLayerList(o,a.parentLookupId),this._addedLayerListItems.set(a.parentLookupId,o)}else{var l=this._findIndexToInsertChildLayerListItem(i.addedChildrenLookupIds,a);r.children.insertItem(l,e),i.addedChildrenLookupIds.splice(l,0,t),r.refreshOnDemandItemCollection()}this._addedLayerListItems.set(t,e)},a.prototype._addOrphanToLayerList=function(e,t){var a=this,r=this._layerListLookup.get(t);if(0==this._layerListRoot.children.getLength()){var i;this.layerList._userAddedLayersFolder?(i=this.layerList._userAddedLayersFolder,i.children.contains(this._layerListRoot)||i.children.insertItem(0,this._layerListRoot)):(i=this._layerListRoot,this._layerCatalogFolderInLayerList||(this.layerList.children.insertItem(0,i),this._layerCatalogFolderInLayerList=!0)),this._layerListRoot.configuredVisible=!0,this.layerList._addedFolderReferences.map(function(e){return e.id.get()}).indexOf(this._layerListRoot.id.get())>-1||this.layerList._addedFolderReferences.push(this._layerListRoot),this._layerListRoot.isVisible.set(!0),this.layerList._userAddedFolderInitialized=!0}var n=this._layerListLookup.keys(),o=n.filter(function(e){return null==a._layerListLookup.get(e).parentLookupId&&a._addedLayerListItems.containsKey(e)}),l=this._findIndexToInsertChildLayerListItem(o,r);this._layerListRoot.children.insertItem(l,e),this._addedLayerListItems.set(t,e),this._layerListRoot.isExpanded.set(!0),this.layerList._userAddedLayersFolder&&this.layerList._userAddedLayersFolder.isExpanded.set(!0),i&&(i.inActiveTheme.set(!0),i.displayItem.set(!0),i.isExpanded.set(!0),i.isVisible.set(!0),i.parent&&i.parent instanceof s.LayerListFolderItem&&i.parent.refreshOnDemandItemCollection())},a.prototype._findIndexToInsertChildLayerListItem=function(e,t){var a;for(a=0;a<e.length;a++){var r=e[a],i=this._layerListLookup.get(r);if(i.siteIndex>t.siteIndex)break;if(i.siteIndex==t.siteIndex&&i.order>t.order)break}return a},a.prototype.getState=function(){var e=this,t=new Array;return this._addedLayerListItems.keys().forEach(function(a){var r,s,n=e._addedLayerListItems.get(a);n.type==i.LayerListItemType.LAYER&&(r=n.layer.displayName,s=n.layer.gcxLayer.mapService.id),n.type==i.LayerListItemType.MAPSERVICE&&(r=n.mapService.displayName,s=n.mapService.id),r&&s&&t.push({layerId:a,layerDisplayName:r,mapServiceObjectId:s})}),{layers:t}},a.prototype._getSeedSiteIdFromUrl=function(e){return e.substring(e.lastIndexOf("/")+1)},a.prototype._getSeedSiteUrlFromSiteId=function(e){var t=this;return this._siteUrls.filter(function(a){return t._getSeedSiteIdFromUrl(a)==e})[0]},a}(a.BaseProvider);t.EssentialsSiteProvider=g})},"Mapping/modules/LayerCatalog/IProvider":function(){define(["require","exports"],function(e,t){"use strict"})},"Mapping/modules/LayerCatalog/LayerCatalogConstructor":function(){define(["require","exports"],function(e,t){"use strict";var a=function(){function e(e){this.catalogs=new Array,this.catalogs.push(new r(e))}return e}();t.LayerCatalogConstructor=a;var r=function(){function e(e){var t=this;this.mapServiceId="N/A";var a=e.keys();if(a.length>0){this.entries=new Array;var r=a.filter(function(t){return null==e.get(t).parentLookupId});r.sort(function(t,a){var r=e.get(t),i=e.get(a),s=r.siteIndex,n=i.siteIndex;if(s==n){var o=r.order,l=i.order;return o-l}return s-n}),r.forEach(function(a){t.entries.push(new i(a,e))})}}return e}();t.LayerCatalogRoot=r;var i=function(){function e(t,a){var r=this;this.id=t;var i=a.get(t);this.displayName=i.displayName,this.type=i.isFolder?"folder":"layer",i.isFolder&&(this.entries=new Array),i.childrenLookupIds.length>0&&i.childrenLookupIds.forEach(function(t){r.entries.push(new e(t,a))})}return e}();t.LayerCatalogEntry=i})},"Mapping/modules/LayerCatalog/LayerCatalogModule":function(){define(["require","exports","geocortex/framework/application/ModuleBase","./BaseLayerCatalogViewModel","./MapUtilities","geocortex/infrastructure/commands.meta"],function(e,t,a,r,i,s){"use strict";var n=function(e){function t(a,s){var n=e.call(this,a,s)||this;return n._providers=new Array,n.app.site&&n.app.site.isInitialized?n._siteInitialized():n.app.eventRegistry.event("SiteInitializedEvent").subscribe(n,n._siteInitialized),i.MapUtilities.app=n.app,n.checkboxVisibility=r.CheckboxVisibility.none,n.checkboxSuffix=null,t.instance=n,n}return __extends(t,e),t.prototype.initialize=function(e){if(e.hasOwnProperty("layerCatalogProviders")&&dojo.isArray(e.layerCatalogProviders)&&this._loadProviders(e.layerCatalogProviders),e.hasOwnProperty("checkboxes")){var t=e.checkboxes;t.hasOwnProperty("visibility")&&(this.checkboxVisibility=r.CheckboxVisibility[t.visibility]),t.hasOwnProperty("suffix")&&(this.checkboxSuffix=t.suffix)}},t.prototype.getStateFilter=function(){return{layers:{item:this.app.project.filter.object}}},t.prototype.applyState=function(e){var t=this;return this.app.event("ProjectLoadedEvent").once(this,function(){var a=t._providers.filter(function(e){return e.isEnabled&&e.canExecuteApplyLayerCatalogDetails(null)})[0];null!=a&&a.reset(e)}),Promise.resolve()},t.prototype.exportState=function(){var e,t=this._providers.filter(function(e){return e.isEnabled&&e.canExecuteApplyLayerCatalogDetails(null)})[0];return null!=t&&(e=t.getState()),Promise.resolve(e)},t.prototype._loadProviders=function(e){var t=this;e.forEach(function(e){e.libraryId&&!t.app.allLibrariesLoaded?t._loadProviderWhenLibrariesDownloaded(e):t._loadProvider(e)})},t.prototype._loadProviderWhenLibrariesDownloaded=function(e){var t=this,a=this.app.event("ViewerLibrariesDownloadedEvent").subscribe(this,function(){t.app.event("ViewerLibrariesDownloadedEvent").unsubscribe(a),t._loadProvider(e)})},t.prototype._loadProvider=function(e){var t=dojo.getObject(e.type);if(!t)return void this.app.trace.error(this.id+" can't find layer catalog provider typed "+e.type);var a=new t(this.app,e.libraryId||this.libraryId);a.isEnabled=!(e.enabled===!1),a.isEnabled&&a.initialize(e.configuration||{}),this._providers.push(a)},t.prototype._siteInitialized=function(){this.app.commandRegistry.command("GetLayerCatalog").register(this,this._executeGetLayerCatalog,this._canExecuteGetLayerCatalog),this.app.commandRegistry.command("GetLayerCatalogDetails").register(this,this._executeGetLayerCatalogDetails,this._canExecuteGetLayerCatalogDetails),this.app.commandRegistry.command("ApplyLayerCatalogDetails").register(this,this._executeApplyLayerCatalogDetails,this._canExecuteApplyLayerCatalogDetails),this.app.commandRegistry.command("ClearLayerCatalogLayers").register(this,this._executeClearLayerCatalogLayers),this.app.commandRegistry.command("ShowLayerCatalog").register(this,this._executeShowLayerCatalog,this._canExecuteShowLayerCatalog),this.app.commandRegistry.command("GetLayerCatalogMapServiceIds").register(this,this._executeGetLayerCatalogMapServiceIds),this.app.commandRegistry.command("RemoveLayerCatalogItem").register(this,this._executeRemoveLayerCatalogItem),this.app.command("LayerCatalogRestoreMapService").register(this,this.restoreMapService),s.Commands.commandsMetadata.push({name:"ShowLayerCatalog",metadata:{arguments:"none",description:"Shows the layer catalog view.",isHyperlinkable:!0,visibility:"public"}}),this.app.commandRegistry.command("AddCatalogLayers").register(this,this._executeAddCatalogLayers,this._canExecuteAddCatalogLayers),s.Commands.commandsMetadata.push({name:"AddCatalogLayers",metadata:{arguments:"Comma seperated string of layer ids.",description:"Adds catalog layers.",isHyperlinkable:!1,visibility:"public"}}),this.app&&this.app.urlParameters&&this.app.urlParameters.catalogLayers&&this.app.commandRegistry.command("AddCatalogLayers").execute(this.app.urlParameters.catalogLayers),this.app.commandRegistry.command("AppendCatalogLayers").register(this,this._executeAppendCatalogLayers,this._canExecuteAppendCatalogLayers),s.Commands.commandsMetadata.push({name:"AppendCatalogLayers",metadata:{arguments:"Comma seperated string of layer ids.",description:"Appends catalog layers.",isHyperlinkable:!1,visibility:"public"}})},t.prototype.restoreMapService=function(e){var t=this._providers.filter(function(e){return e.isEnabled&&e.canExecuteApplyLayerCatalogDetails(null)})[0];null!=t&&t.restoreMapService(e)},t.prototype._executeGetLayerCatalog=function(e){var t=this._providers.filter(function(e){return e.isEnabled&&e.canExecuteGetLayerCatalog(null)})[0];null!=t&&t.executeGetLayerCatalog(e)},t.prototype._canExecuteGetLayerCatalog=function(){return this._providers.some(function(e){return e.isEnabled&&e.canExecuteGetLayerCatalog(null)})},t.prototype._executeGetLayerCatalogDetails=function(e,t){var a=this._providers.filter(function(e){return e.isEnabled&&e.canExecuteGetLayerCatalog(null)})[0];null!=a&&a.executeGetLayerCatalogDetails(e,t)},t.prototype._canExecuteGetLayerCatalogDetails=function(){return this._providers.some(function(e){return e.isEnabled&&e.canExecuteGetLayerCatalogDetails(null,null)})},t.prototype._executeApplyLayerCatalogDetails=function(e){var t=this._providers.filter(function(e){return e.isEnabled&&e.canExecuteApplyLayerCatalogDetails(null)})[0];null!=t&&t.executeApplyLayerCatalogDetails(e)},t.prototype._canExecuteApplyLayerCatalogDetails=function(){return this._providers.some(function(e){return e.isEnabled&&e.canExecuteApplyLayerCatalogDetails(null)})},t.prototype._executeClearLayerCatalogLayers=function(){var e=this._providers.filter(function(e){return e.isEnabled&&e.canShowLayerCatalog()})[0];null!=e&&e.executeClearLayerCatalogLayers()},t.prototype._executeShowLayerCatalog=function(){this.app.commandRegistry.command("ActivateView").execute("LayerCatalogView")},t.prototype._canExecuteShowLayerCatalog=function(){return this._providers.some(function(e){return e.isEnabled&&e.canShowLayerCatalog()})},t.prototype._executeAddCatalogLayers=function(e){e&&this.app.eventRegistry.event("OnAddCatalogLayersCommandEvent").publish(e)},t.prototype._executeAppendCatalogLayers=function(e){e&&this.app.eventRegistry.event("OnAppendCatalogLayersCommandEvent").publish(e)},t.prototype._canExecuteAddCatalogLayers=function(){return this._canExecuteShowLayerCatalog()},t.prototype._canExecuteAppendCatalogLayers=function(){return this._canExecuteShowLayerCatalog()},t.prototype._executeGetLayerCatalogMapServiceIds=function(e){var t=this._providers.filter(function(e){return e.isEnabled&&e.canShowLayerCatalog()})[0];null!=t&&t.executeGetLayerCatalogMapServiceIds(e)},t.prototype._executeRemoveLayerCatalogItem=function(e){var t=this._providers.filter(function(e){return e.isEnabled&&e.canShowLayerCatalog()})[0];null!=t&&t.executeRemoveLayerCatalogItem(e)},t}(a.ModuleBase);
t.LayerCatalogModule=n})},"Mapping/modules/LayerCatalog/LayerCatalogState":function(){define(["require","exports"],function(e,t){"use strict"})},"Mapping/modules/LayerCatalog/LayerCatalogView":function(){define(["require","exports","./BaseLayerCatalogView"],function(e,t,a){"use strict";var r=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.handleKeyDown=function(e,t,a){var r=e.which?e.which:e.keyCode;return!!this._isSpecialChar(r)||(13===r&&(this.viewModel.filterCatalog(),t.blur()),!0)},t.prototype.handleExpand=function(e,t,a){return this._ignoreHandleExpand?(this._ignoreHandleExpand=!1,!0):void(a&&a.expanded.set(!a.expanded.get()))},t.prototype.handleSelectAllChecked=function(e,t,a){return a.toggleAllChildren(t.checked),this._ignoreHandleExpand=!0,!0},t.prototype.handleLayerChecked=function(e,t,a){a&&a.isChecked.set(!a.isChecked.get())},t.prototype.handleClear=function(e,t,a){this.viewModel.showingAll.get()&&this.viewModel.reset()},t.prototype.handleSearch=function(e,t,a){this.viewModel.filterCatalog()},t.prototype.handleShowSelectedClick=function(){this.viewModel.toggleSelected()},t.prototype.handleRefreshClick=function(){this.viewModel.refreshLayerCatalog()},t}(a.BaseLayerCatalogView);t.LayerCatalogView=r})},"Mapping/modules/LayerCatalog/LayerCatalogViewModel":function(){define(["require","exports","./BaseLayerCatalogViewModel","./CatalogEntryType"],function(e,t,a,r){"use strict";var i=function(e){function t(t,a){return e.call(this,t,a)||this}return __extends(t,e),t.prototype.ready=function(){e.prototype.ready.call(this),this.catalogCached&&(this.reset(),this.syncAddedLayers())},t.prototype.reset=function(){this._clearFilter(),this.showingAll.get()||this.toggleSelected()},t.prototype.filterCatalog=function(){var e=this.filterText.get(),t=this.getFilterProvider();if(t)t.filter(e,this.filteredCatalog);else for(var a=0;a<this.filteredCatalog.get().length;a++)this.filteredCatalog.getAt(a).filter(e)},t.prototype._clearFilter=function(){this.filterText.set(""),this.filterCatalog()},t.prototype.toggleSelected=function(){this.filterText.set(""),this.showingAll.set(!this.showingAll.get());var e="",t=!1;if(this.showingAll.get())this.showNoLayersSelectedText.set(!1),this._clearFilter(),e="language-layer-catalog-show-selected-button";else{this.filterText.set("");for(var a=this._getFlattenedEntries(),i=0;i<a.length;i++){var s=!1;a[i].type===r.LAYER?a[i].isChecked.get()&&(t=!0,s=!0):(a[i].someChecked.get()||a[i].allChecked.get())&&(s=!0),a[i].visible.set(s)}for(var i=0;i<this.filteredCatalog.get().length;i++)(this.filteredCatalog.getAt(i).someChecked.get()||this.filteredCatalog.getAt(i).allChecked.get())&&this.filteredCatalog.getAt(i).expandAll(!0);e="language-layer-catalog-show-all-button",t?this.showNoLayersSelectedText.set(!1):this.showNoLayersSelectedText.set(!0)}t&&!this.showingAll.get()?this.clearButtonVisible.set(!0):this.clearButtonVisible.set(!1),this.showSelectedButtonText.set(this.app.getResource(this.libraryId,e))},t}(a.LayerCatalogViewModelBase);t.LayerCatalogViewModel=i})},"Mapping/modules/LayerCatalog/MapUtilities":function(){define(["require","exports","geocortex/essentials/MapService","geocortex/essentials/Layer","geocortex/geocortex","geocortex/essentials/ServiceHelper","geocortex/essentials/MapServiceConstants","geocortex/essentials/LayerVisibilityEventManager","geocortex/essentials/FeatureLayerService","geocortex/essentials/WFSLayerService","geocortex/essentials/StreamLayerService","geocortex/essentials/utilities/UrlUtilities","geocortex/essentials/RestHelperHTTPService","geocortex/framework/SimplePromise"],function(e,t,a,r,i,s,n,o,l,c,d,p,y,u){"use strict";var h=function(){function t(){}return t.addLayerToWebTiledService=function(e,t){this._addLayerToService(e,t)},t.addLayerToVectorTiledService=function(e,t){this._addLayerToService(e,t)},t.addLayerToTiledService=function(e,t){this._addLayerToService(e,t)},t.addLayerToImageService=function(e,t){this._addLayerToService(e,t)},t.addLayerToBingService=function(e,t){this._addLayerToService(e,t)},t.addLayersToWMSService=function(e,t,a){var r=this;e.forEach(function(e){if(!t.layers.some(function(t){return t.id==e.id})){e.parentLayerId=null;var a=t.url+"/layers/"+e.id,i=r._createGcxLayer(a,e,t,e.name,e.id);i.wmsLayerName=e.nativeID,t.layers.push(i);var s=new esri.layers.WMSLayerInfo({name:i.wmsLayerName,title:i.name});s.styleName=i.styleName,t.serviceLayer.layerInfos.push(s)}});var i=t.layers;if(i&&i.length>0){var s=i.filter(function(e){return 1==e.isVisible()});if(s&&s.length>0){var n=s.map(function(e){return e.wmsLayerName});n&&n.length>0&&t.serviceLayer.setVisibleLayers(n)}}},t.addLayersToWMTSService=function(e,t,a){var r=this;e.forEach(function(e){if(!t.layers.some(function(t){return t.id==e.id})){var a=t.url+"/layers/"+e.id,i=r._createGcxLayer(a,e,t,e.name,e.id);t.layers.push(i)}})},t._addLayerToService=function(e,t){var a,s=this;if("MapService"===e.drawingBehavior&&e.layers&&e.layers.length>0)a=e.layers,a.forEach(function(e){if(!t.layers.some(function(t){return t.id==e.id})){var a=t.url+"/layers/"+e.id,r=s._createGcxLayer(a,e,t,e.name,e.id);t.layers.push(r)}});else{var o=(e.properties.filter(function(e){return"layerCatalogLookupId"==e.name})[0].value,new r.Layer(t.originalUrl));o.id="0",o.isUserCreated=!0,o.userLayerType=n.UserLayerType.LAYER_CATALOG,o.mapService=t,o.catalogId=i._getProperties(e.properties).layerCatalogLookupId,t.layers.push(o)}},t.addLayersWithDynamicDefinitions=function(e,t){var a=this;e.forEach(function(e){if(e.dynamicDefinition&&""!=e.dynamicDefinition&&!t.layers.some(function(t){return t.id==e.id})){var r=t.url+"/layers/"+e.id,i=a._createGcxLayer(r,e,t,e.displayName,e.id);t.add(i)}})},t.addLayersToDynamicMapService=function(e,t){var a=this,r=e.map(function(e){return e.id}),i=r.slice(),s=t.serviceLayer;s.layerInfos.forEach(function(s,n){if(r.indexOf(s.id.toString())>=0){var o=t.layers.filter(function(e){return e.id==s.id.toString()})[0];if(null==o){var l=e.filter(function(e){return e.id==s.id})[0],c=t.url+"/layers/"+l.id,d=a._createGcxLayer(c,l,t,s.name,s.id.toString());d.parentLayerId=null,t.layers.push(d)}else o.isVisible()||i.splice(i.indexOf(s.id.toString()),1)}}),i&&i.length>0?s.setVisibleLayers(i):s.setVisibleLayers(["-1"])},t.addLayerToFeatureService=function(e,t){var a=t.serviceLayer;if(!t.layers.some(function(e){return e.id==a.layerId.toString()})){var r=t.url+"/layers/"+e.id,i=this._createGcxLayer(r,e,t,e.displayName,a.layerId.toString());t.layers.push(i)}},t.addLayerToWFSOrStreamService=function(e,t){var a=this;e.forEach(function(e){if(!t.layers.some(function(t){return t.id==e.id})){var r=t.url+"/layers/"+e.id,i=a._createGcxLayer(r,e,t,e.name,e.id);t.layers.push(i)}})},t._createGcxLayer=function(e,t,a,s,o){var l=(this.app.site.getMap(),new r.Layer(e));t.visible=!0,l.mapService=a,l._configureObject(t),l.catalogId=i._getProperties(t.properties).layerCatalogLookupId,l.includeInLayerList=!0,l.site=this.app.site,l.name=s,l.id=o,l.isInitialized=!0,l.configuredVisible=!0,l.isUserCreated=!0,l.userLayerType=n.UserLayerType.LAYER_CATALOG;for(var c,d=e.split("/"),p=0;p<d.length;p++)if("sites"==d[p]){c=d[p+1];break}return l.iconUri&&(l.iconUri=l.iconUri.replace(this.app.site.id,c)),l},t.getUrlForCreatingServiceLayer=function(e){var t=e.serviceUrl;return e.serviceToken&&(t=y.RestHelperHTTPService.appendTokenToUrl(t,e.serviceToken)),t},t.createMapServiceFromJson=function(t,r){var i,p,u=this,h=$.Deferred(),g=s.ServiceHelper.extractConnectionStringValue,f=g(t.connectionString,"styleUrl"),v=r+"/map/mapservices/"+t.id,L=t.drawingBehavior,m=t.serviceType;if(L===n.DrawingBehavior.MAP_SERVICE){p=new a.MapService(v),p.essentialsMap=this.app.site.essentialsMap,p.createFromDefinition(t);var m=t.serviceType;switch(m){case n.MapServiceType.WEBTILED:var C=g(t.connectionString,"subDomains"),b=[];C&&(b=C.split(","));var S={copyright:t.copyright,id:t.id,subDomains:b};p.subDomains=b,p._processConnectionString(t.connectionString,t),i=new esri.layers.WebTiledLayer(this.getUrlForCreatingServiceLayer(p),S),p.url=v;break;case n.MapServiceType.TILED:p._processConnectionString(t.connectionString,t),i=new esri.layers.ArcGISTiledMapServiceLayer(this.getUrlForCreatingServiceLayer(p)),this._applyAttributionUrl(t,i);break;case n.MapServiceType.DYNAMIC:p._processConnectionString(t.connectionString,t),i=new esri.layers.ArcGISDynamicMapServiceLayer(this.getUrlForCreatingServiceLayer(p)),this._applyAttributionUrl(t,i),p.layerVisibilityEventManager=new o.LayerVisibilityEventManager(p,i),null!=t.format&&i.setImageFormat(t.format.toLowerCase());break;case n.MapServiceType.IMAGE:p._processConnectionString(t.connectionString,t),i=new esri.layers.ArcGISImageServiceLayer(this.getUrlForCreatingServiceLayer(p)),this._applyAttributionUrl(t,i),i.setImageFormat(this._getAgsImageServiceImageFormat(t.imageFormat));break;case n.MapServiceType.VECTORTILE:e(["esri/layers/VectorTileLayer"],function(e){p._processConnectionString(t.connectionString,t);var a=u.getUrlForCreatingServiceLayer(p);if(f&&(a=f,u.app&&u.app.site)){var r=u.app.site.getTokenFromPrincipal(f,n.MapServiceType.VECTORTILE);r&&(a=y.RestHelperHTTPService.appendTokenToUrl(a,r))}i=new e(a)}),this._applyAttributionUrl(t,i);break;case n.MapServiceType.BING:var _,x={};_=g(t.connectionString,"mapStyle"),_&&_.length>0&&(x.mapStyle=_),_=g(t.connectionString,"culture"),_&&_.length>0&&(x.culture=_),_=g(t.connectionString,"key"),_&&_.length>0&&(x.bingMapsKey=_),i=new esri.virtualearth.VETiledLayer(x),p.bingProperties=x,p._processConnectionString(t.connectionString,t);break;case n.MapServiceType.WMS:this._extendWms();p._processConnectionString(t.connectionString,t),i=new esri.layers.WMSLayer(this.getUrlForCreatingServiceLayer(p),{resourceInfo:{extent:this.app.site.essentialsMap.initialExtent,layerInfos:[],version:t.serverVersion},visibleLayers:[]});var w=this.app.site.essentialsMap.spatialReference.wkid;102100==w&&(w=3857),i.spatialReferences.push(w),i.preferredSpatialReference=w,this._applyAttributionUrl(t,i),p.layerVisibilityEventManager=new o.LayerVisibilityEventManager(p,i);var M=null;null!=t.imageFormat&&(M=t.imageFormat.replace(/^image\//,""),M="jpeg"==M?"jpg":M),i.setImageFormat(M),i.show(),this._corsRequest(this.getUrlForCreatingServiceLayer(p)).then(function(){i.refresh()},function(e){i.refresh()});break;case n.MapServiceType.WMTS:p._processConnectionString(t.connectionString,t),this.addLayersToWMTSService(t.layers,p,r),p._createServiceLayer(),i=p.serviceLayer;break;default:h.reject()}}else L===n.DrawingBehavior.FEATURE_LAYER?(p=new l.FeatureLayerService(v),p.createFromDefinition(t),p._configurePropertiesAndrenderer(t),p.essentialsMap=this.app.site.essentialsMap,p._processConnectionString(t.connectionString,t),i=new esri.layers.FeatureLayer(this.getUrlForCreatingServiceLayer(p)),this._applyAttributionUrl(t,i)):L===n.DrawingBehavior.WFS_LAYER?(p=new c.WFSLayerService(v),p.createFromDefinition(t),p.essentialsMap=this.app.site.essentialsMap,p._processConnectionString(t.connectionString,t),this.addLayerToWFSOrStreamService(t.layers,p),p._restWFSConfigObject=t,p._createServiceLayer(),i=p.serviceLayer):L===n.DrawingBehavior.STREAM_LAYER&&(p=new d.StreamLayerService(v),p.createFromDefinition(t),p.essentialsMap=this.app.site.essentialsMap,p._processConnectionString(t.connectionString,t),p._configureStreamSettings(t.streamSettings),p._createServiceLayer(),this.addLayerToWFSOrStreamService(t.layers,p),i=p.serviceLayer);var I=(this.app.site.getMap(),function(){p.serviceLayer=i,p.minScale&&p.serviceLayer.setMinScale(p.minScale),p.minScale&&p.serviceLayer.setMaxScale(p.maxScale),p.disableClientCaching&&p.serviceLayer&&p.serviceLayer.setDisableClientCaching&&p.serviceLayer.setDisableClientCaching(!0),p.isUserCreated=!0,p.userLayerType=n.UserLayerType.LAYER_CATALOG,p.includeInLayerList=!0,i.setOpacity(p.opacity);var e=t.properties.filter(function(e){return"layerCatalogLookupId"==e.name})[0],a=e.value.split("."),r=a[0];p.id="{0}-{1}".format(r,t.id),p.serviceLayer.id=p.id});return i.loaded?(I(),h.resolve(p)):(i.on("load",function(e){I(),h.resolve(p)}),i.on("error",function(e){console.log("Error in initializing layer: {0}".format(e.error)),h.reject()})),h.promise()},t._corsRequest=function(t,a,r){var i=this;return new u.SimplePromise(function(s,n){try{e(["dojo/request"],function(e){a=!!a,r=!!r;var o=e(t,{headers:{"X-Requested-With":null},withCredentials:a});return o.response.then(function(e){return s()},function(e){return r?n(e):s(i._corsRequest(t,!a,!0))})})}catch(o){return console.log("Error in initializing WMS layer: "+o),n(o)}})},t._getAgsImageServiceImageFormat=function(e){if("undefined"==typeof e||null===e||e.length<1)return null;var t=e.toLowerCase();switch(t){case"jpgpng":case"png":case"png8":case"png24":case"png32":case"jpeg":case"jpg":case"gif":case"bmp":case"tiff":return t;default:return null}},t._extendWms=function(){if(!a.MapService._wmsExtended){var e=esri.layers.WMSLayer._meta.hidden.getImageUrl,t=/.*images\/pixel.png$/;esri.layers.WMSLayer.extend({getImageUrl:function(a,r,i,s){function n(e){if(t.test(e))return void s(e);for(var a={},r=0;r<o.layerInfos.length;r++)a[o.layerInfos[r].name]=o.layerInfos[r].styleName;var i=[];for(r=0;r<o.visibleLayers.length;r++)i.push(a[o.visibleLayers[r]]);var n=i.join(","),l=e.substring(e.lastIndexOf("?")+1,e.length),c=dojo.queryToObject(l);if(c.STYLES=n,o.preferredSpatialReference){var d=c.CRS?"CRS":"SRS";c[d]="EPSG:"+o.preferredSpatialReference}o.__gcxWmsImageFormat&&(c.FORMAT=o.__gcxWmsImageFormat);var p=e.substring(0,e.lastIndexOf("?")+1)+dojo.objectToQuery(c);s(p)}var o=this;e.apply(this,[a,r,i,n])}}),a.MapService._wmsExtended=!0}},t._applyAttributionUrl=function(e,t){var a=e.attributionDataUrl,r=e.hasAttributionData;if(a&&""!==a)t.attributionDataUrl=a,t.hasAttributionData=!0;else if(r){t.attributionDataUrl=p.UrlUtilities.simplify(e.url)+"/attribution",t.hasAttributionData=!0;var i=y.RestHelperHTTPService.getTokenForScope(t.attributionDataUrl);i&&(t.attributionDataUrl=y.RestHelperHTTPService.appendTokenToUrl(t.attributionDataUrl,i))}},t}();t.MapUtilities=h})},"Mapping/modules/LayerCatalog/PagedLayerCatalogView":function(){define(["require","exports","./BaseLayerCatalogView"],function(e,t,a){"use strict";var r=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.handleKeyDown=function(e,t,a){var r=e.which?e.which:e.keyCode;if(this._isSpecialChar(r))return!0;if(13===r&&t.value){var i=this.viewModel.filterText.get();this.viewModel.filterCatalog(i),t.blur()}return!0},t.prototype.handleSearch=function(e,t,a){this.viewModel.filterCatalog(this.viewModel.filterText.get())},t.prototype.handleLayerClick=function(e,t,a){a&&a.isChecked.set(!a.isChecked.get())},t.prototype.handleFolderClick=function(e,t,a){return this._ignoreHandleFolderClick?(this._ignoreHandleFolderClick=!1,!0):(this.viewModel.presentableCatalog.attachToCollection(a.entries),this.viewModel.setBackText(this.viewModel.breadcrumb.get()),this.viewModel.setBreadcrumbText(a.displayName),this.viewModel.currentFolderName.set(a.displayName),this.viewModel.backDisabled.set(!1),void this.app.command("FocusOnFirstInputInView").execute(this))},t.prototype.handleSelectAllChecked=function(e,t){if(this.viewModel.resultPage&&this.viewModel.resultPage.getLength()){var a=this.viewModel.resultPage.getAt(0).parent;return a.toggleAllChildren(t.checked),!0}return!1},t.prototype.handleBackClick=function(e,t,a){if(this.viewModel.showingAll.get()){var r=this.viewModel.presentableCatalog.items.getAt(0),i=r.parent;if(i&&i.parent&&i.parent.entries){var s=i.parent;this.viewModel.presentableCatalog.attachToCollection(s.entries),this.viewModel.setBreadcrumbText(s.displayName),this.viewModel.currentFolderName.set(s.displayName),this.viewModel.backDisabled.set(!1),s.parent?this.viewModel.setBackText(s.parent.displayName):this.viewModel.setBackText(this.viewModel.homeText)}else this.viewModel.presentableCatalog.attachToCollection(this.viewModel.filteredCatalog),this.viewModel.setBreadcrumbText(null),this.viewModel.currentFolderName.set(this.viewModel.homeText),this.viewModel.backDisabled.set(!0),this.viewModel.setBackText(this.viewModel.homeText)}else this.viewModel.reset()},t.prototype.handleShowSelectedClick=function(e,t,a){this.viewModel.toggleShowSelection()},t.prototype.handleClear=function(e,t,a){this.viewModel.showingAll.get()&&this.viewModel.reset()},t.prototype.handleRefreshClick=function(){this.viewModel.refreshLayerCatalog()},t}(a.BaseLayerCatalogView);t.PagedLayerCatalogView=r})},"Mapping/modules/LayerCatalog/PagedLayerCatalogViewModel":function(){define(["require","exports","./BaseLayerCatalogViewModel","geocortex/framework-ui/PresentableCollection","geocortex/framework/observables"],function(e,t,a,r,i){"use strict";var s=function(e){function t(t,a){var s=e.call(this,t,a)||this;return s.presentableCatalog=null,s.resultPage=null,s.breadcrumb=null,s.backText=null,s.backDisabled=null,s.homeText=null,s.currentFolderName=null,s.backString=null,s.allChecked=null,s.showGroupCheckbox=null,s.presentableCatalog=new r.PresentableCollection,s.presentableCatalog.attachToCollection(s.filteredCatalog),s.resultPage=s.presentableCatalog.items,s.presentableCatalog.isPaginated.set(!1),s.homeText=t.getResource(a,"language-layer-catalog-home-text"),s.presentableCatalog.pageSize.set(10),s.currentFolderName=new i.Observable(s.homeText),s.backString=new i.Observable(t.getResource(a,"language-layer-catalog-folder-up").format(s.currentFolderName.get())),s.breadcrumb=new i.Observable(s.homeText),s.backDisabled=new i.Observable((!0)),s.backText=new i.Observable(s.homeText),s.allChecked=new i.Observable((!1)),s.showGroupCheckbox=new i.Observable((!1)),s.currentFolderName.bind(s,function(){s.backString.set(t.getResource(a,"language-layer-catalog-folder-up").format(s.currentFolderName.get()))}),s.backDisabled.bind(s,function(){s.resultPage&&s.resultPage.getLength()&&s.resultPage.getAt(0).parent?(s.allChecked.set(s.resultPage.getAt(0).parent.allChecked.get()),s.showGroupCheckbox.set(s.resultPage.getAt(0).parent.showGroupCheckbox.get()&&!s.backDisabled.get())):(s.allChecked.set(!1),s.showGroupCheckbox.set(!1))}),s.app.command("ReevaluateAllChecked").register(s,function(e){s.allChecked.set(e)}),s}return __extends(t,e),t.prototype.ready=function(){e.prototype.ready.call(this),this.catalogCached&&(this.reset(),this.syncAddedLayers())},t.prototype._clearFilter=function(){this.filterText.set("");for(var e=0;e<this.filteredCatalog.get().length;e++)this.filteredCatalog.getAt(e).filter(this.filterText.get())},t.prototype.filterCatalog=function(e){var t=this;if(e){var a,r=this.getFilterProvider();a=r?r.filter(e,this.filteredCatalog):new Promise(function(a,r){for(var i=0;i<t.filteredCatalog.get().length;i++)t.filteredCatalog.getAt(i).filter(e);a()}),a.then(function(){for(var e=new Array,a=t._getFlattenedEntries(!0),r=0;r<a.length;r++)a[r].visible.get()&&e.push(a[r]);t.presentableCatalog.attachToCollection(new i.ObservableCollection(e))})}},t.prototype.reset=function(){this.backDisabled.set(!0),this.filterText.set(""),this._clearFilter(),this.presentableCatalog.attachToCollection(this.filteredCatalog),this.setBreadcrumbText(null),this.setBackText(this.homeText),this.showingAll.set(!0),this.showNoLayersSelectedText.set(!1),this.showSelectedButtonText.set(this.app.getResource(this.libraryId,"language-layer-catalog-show-selected-button")),this.allChecked.set(!1),this.showGroupCheckbox.set(!1),this.currentFolderName.set(this.homeText)},t.prototype.setBreadcrumbText=function(e){e?this.breadcrumb.set(e):this.breadcrumb.set(this.homeText)},t.prototype.setBackText=function(e){var t=20;e&&(e.length>t&&(e=e.substring(0,t),e="< "+e+"..."),this.backText.set(e))},t.prototype.toggleShowSelection=function(){var e=this.getCheckedEntries();if(this.showingAll.get()){for(var t=0;t<e.length;t++)e[t].visible.set(!0);this.showSelectedButtonText.set(this.app.getResource(this.libraryId,"language-layer-catalog-show-all-button")),this.breadcrumb.set(this.app.getResource(this.libraryId,"language-layer-catalog-showing-selected-text")),this.backDisabled.set(!0),this.presentableCatalog.attachToCollection(new i.ObservableCollection(e)),0===e.length&&this.showNoLayersSelectedText.set(!0)}else this.showNoLayersSelectedText.set(!0),this.showSelectedButtonText.set(this.app.getResource(this.libraryId,"language-layer-catalog-show-selected-button")),this.breadcrumb.set(this.homeText),this.backDisabled.set(!0),this.presentableCatalog.attachToCollection(this.filteredCatalog),this.showNoLayersSelectedText.set(!1);this.setBackText(this.homeText),this.showingAll.set(!this.showingAll.get()),this.presentableCatalog.sortCollection()},t}(a.LayerCatalogViewModelBase);t.PagedLayerCatalogViewModel=s})},"Mapping/modules/LayerCatalog/WmsPropertyNames":function(){define(["require","exports"],function(e,t){"use strict";t.WMS_LAYER_NAME="wmsLayerName",t.WMS_SERVICE_URL="wmsServiceUrl",t.WMS_INSERT_POSITION="defaultInsertPosition"})},"url:/Mapping/modules/LayerCatalog/LayerCatalogView.html":'<div class="layer-catalog">\r\n    <div class="lc-filter">\r\n        <div class="lc-search" data-binding="{@noclass-lcSearchDisable: showingAll}">\r\n            <input class="search-field" type="text" id="lc-filter-input" data-binding="{@value: filterText}{@event-keydown: handleKeyDown}{placeholder: @language-layer-catalog-search-placeholder}{@enabled: showingAll}" />\r\n            <button class="clear-button" data-binding="{@event-onclick: handleClear}{title: @language-layer-catalog-clear-filter}"></button>\r\n            <button class="search-button" data-binding="{@event-onclick: handleSearch}{@enabled: showingAll}{title: @language-layer-catalog-search-button}"></button>\r\n        </div>\r\n        <button class="lc-show-selected button-text-link" data-binding="{@event-onclick: handleShowSelectedClick}{@text: showSelectedButtonText}"></button>\r\n    </div>\r\n    <div class="lc-content">\r\n        <div class="lc-status lc-loader" data-binding="{@visible: isBusy}">\r\n            <img src="Resources/Images/loader-small.gif" alt="Loading" border="0" width="24" height="24" />\r\n        </div>\r\n        <div class="lc-entries" data-binding="{@hidden: isBusy}">\r\n            <div class="lc-layers-text" data-binding="{@visible: showLayerMessageText}">\r\n                <span data-binding="{@text: @language-layer-catalog-not-finished}{@visible: showNotFinishedText}"></span>\r\n                <span data-binding="{@text: @language-layer-catalog-more-layers}{@visible: showMoreLayersText}"></span>\r\n                <a href="" data-binding="{@text: @language-layer-catalog-refresh}{@visible: showMoreLayersText}{@event-onclick: handleRefreshClick}"></a>\r\n            </div>\r\n            <span data-binding="{@text: @language-layer-catalog-no-layers-selected}{@visible: showNoLayersSelectedText}"></span>\r\n            <ul class="layer-catalog-items" role="tree" data-binding="{@source: filteredCatalog}{@template-selector: type}">\r\n                <li class="lc-tree" role="treeitem" data-binding="{@template-select: folder}{@template: Mapping/modules/LayerCatalog/Templates/FolderItemTemplate.html}"></li>\r\n                <li class="lc-tree" role="treeitem" data-binding="{@template-select: layer}{@template: Mapping/modules/LayerCatalog/Templates/LayerItemTemplate.html}"></li>\r\n            </ul>\r\n        </div>\r\n        <div class="lc-actions">\r\n            <button class="button" data-binding="{@event-onclick: handleClickOk}{@text: @language-layer-catalog-ok-button}"></button>\r\n            <button class="button" data-binding="{@event-onclick: handleClickCancel}{@text: @language-layer-catalog-cancel-button}"></button>\r\n        </div>\r\n    </div>\r\n</div>\r\n',"url:/Mapping/modules/LayerCatalog/PagedLayerCatalogView.html":'<div class="layer-catalog">\r\n    <!-- Header -->\r\n    <div class="lc-header">\r\n        <div class="middle panel-header">\r\n            <button class="lc-left button-text-link" data-binding="{@event-onclick: handleBackClick}{@class-disabled: backDisabled}">\r\n                <!-- for screen readers -->\r\n                <span data-binding="{aria-label: backString}{@hidden: backDisabled}"></span>\r\n                <span data-binding="{@text: backText}"></span>\r\n            </button>\r\n            <button class="lc-right button-text-link" data-binding="{@event-onclick: handleClickOk}{@text: @language-layer-catalog-done-button}"></button>\r\n            <h2 class="panel-title" data-binding="{@text: breadcrumb}"></h2>\r\n        </div>\r\n        <div class="lc-filter">\r\n            <div class="lc-search" data-binding="{@noclass-lcSearchDisable: showingAll}">\r\n                <input class="search-field" type="text" id="lc-filter-input" data-binding="{@value: filterText}{@event-keydown: handleKeyDown}{placeholder: @language-layer-catalog-search-placeholder}{@enabled: showingAll}" />\r\n                <button class="clear-button" data-binding="{@event-onclick: handleClear}{title: @language-layer-catalog-clear-filter}"></button>\r\n                <button class="search-button" data-binding="{@event-onclick: handleSearch}{@enabled: showingAll}{title: @language-layer-catalog-search-button}"></button>\r\n            </div>\r\n            <button class="lc-show-selected button-text-link" data-binding="{@event-onclick: handleShowSelectedClick}{@text: showSelectedButtonText}"></button>\r\n        </div>\r\n    </div>\r\n    <div class="lc-status lc-loader" data-binding="{@visible: isBusy}">\r\n        <img src="Resources/Images/loader-small.gif" alt="Loading" border="0" width="24" height="24" />\r\n    </div>\r\n    <div class="lc-status no-selection-message" data-binding="{@text: @language-layer-catalog-no-layers-selected}{@noclass-showNone: showNoLayersSelectedText}"></div>\r\n    <!-- Content Body -->\r\n    <div class="lc-layers-text" data-binding="{@visible: showLayerMessageText}">\r\n        <span data-binding="{@text: @language-layer-catalog-not-finished}{@visible: showNotFinishedText}"></span>\r\n        <span data-binding="{@text: @language-layer-catalog-more-layers}{@visible: showMoreLayersText}"></span>\r\n        <a href="" data-binding="{@text: @language-layer-catalog-refresh}{@visible: showMoreLayersText}{@event-onclick: handleRefreshClick}"></a>\r\n    </div>\r\n    <div class="lc-entries">\r\n        <div class="lc-items layer-item catalog-folder-select" data-binding="{@visible: showGroupCheckbox}{checked: allChecked}">\r\n            <label class="layer-item-label">\r\n                <input class="selected-state" type="checkbox" data-binding="{@event-onclick: handleSelectAllChecked}{checked: allChecked}" />\r\n                <span class="lc-item-label" data-binding="{@text: @language-layer-catalog-select-all}"></span>\r\n            </label>\r\n        </div>\r\n        <ul class="lc-items" data-binding="{@source: resultPage}{@template-for: resultPage}{@template-selector: type}">\r\n            <li class="layer-item" data-binding="{@class-layerSelected: isChecked}{@template-select: layer}{@visible: visible}">\r\n                <label class="layer-item-label">\r\n                    <input type="checkbox" class="selected-state selected-state-layer" data-binding="{@class-layerCheckedImage: isChecked}{@value: isChecked}">\r\n                    <span class="lc-item-label" data-binding="{@text: displayName}"></span>\r\n                </label>\r\n                <button class="lc-details" data-binding="{@event-onclick: handleShowDetails}{@visible: infoLinkVisible}"><img data-binding="{alt: infoLinkText}{src: infoLinkIconUri}{title: infoLinkTooltip}" border="0" /></button>\r\n            </li>\r\n            <li class="folder-item chevron-right-24" data-binding="{@template-select: folder}{@event-onclick: handleFolderClick}{@visible: visible}">\r\n                <button class="catalog-item-button" data-binding="{title: @language-layer-catalog-folder-drill-down}">\r\n                    <span class="selected-state selected-state-folder" data-binding="{@class-folderSomeSelectedImage: someChecked}{@class-folderAllSelectedImage: allChecked}"></span>\r\n                    <span class="lc-item-label" data-binding="{@text: displayName}{@event-onclick: handleFolderClick}"></span>\r\n                    <!-- Chrome Vox: Announces when folder is opened -->\r\n                    <span data-binding="{@visible: expanded}{aria-label: @language-layer-catalog-folder-opened}"></span>\r\n                    <span data-binding="{@visible: someChecked}{@text: @language-layer-catalog-selected-some}" class="selected-indicator"></span>\r\n                    <span data-binding="{@visible: allChecked}{@text: @language-layer-catalog-selected-all}" class="selected-indicator"></span>\r\n                </button>\r\n            </li>\r\n        </ul>\r\n        <div class="bottom">\r\n            <button class="cancel-button button" data-binding="{@event-onclick: handleClickCancel}{@text: @language-layer-catalog-cancel-button}"></button>\r\n        </div>\r\n    </div>\r\n</div>',"url:/Mapping/modules/LayerCatalog/Templates/FolderItemTemplate.html":'<!-- Recursive template for folder items. Used in the desktop view -->\r\n<div class="folder-item" data-binding="{@visible: visible}{id: folderId}">\r\n    <div class="folder-item-name" data-binding="{@event-onclick: handleExpand}">\r\n        <button class="catalog-item-button" data-binding="{@event-onclick: handleExpand}">\r\n            <span class="catalog-item-control">\r\n                <!-- Chrome Vox: Announces when folder is open or closed -->\r\n                <span class="expander-button" data-binding="{@class-folder-open: expanded}{aria-label: @language-layer-catalog-folder-toggle-open}{@visible: expanded}"></span>\r\n                <span class="expander-button" data-binding="{@class-folder-open: expanded}{aria-label: @language-layer-catalog-folder-toggle-closed}{@hidden: expanded}"></span>\r\n            </span>\r\n            <span data-binding="{@text: displayName}"></span>\r\n            <span data-binding="{@visible: someChecked}{@text: @language-layer-catalog-selected-some}" class="selected-indicator"></span>\r\n            <span data-binding="{@visible: allChecked}{@text: @language-layer-catalog-selected-all}" class="selected-indicator"></span>\r\n        </button>\r\n        <div class="catalog-folder-select" data-binding="{@visible: expanded}">\r\n            <label class="catalog-item-label" data-binding="{@event-onclick: handleSelectAllChecked}{checked: allChecked}{@visible: showGroupCheckbox}">\r\n                <span class="catalog-item-control">\r\n                    <input type="checkbox" data-binding="{@event-onclick: handleSelectAllChecked}{checked: allChecked}" />\r\n                </span>\r\n                <span class="layer-item">\r\n                    <span class="layer-item-name" data-binding="{@text: @language-layer-catalog-select-all}"></span>\r\n                </span>\r\n            </label>\r\n        </div>\r\n    </div>\r\n\r\n    <ul class="layer-catalog-items" data-binding="{@source: bindingEntries}{@template-selector: type}{@visible: expanded}{aria-labelledby: folderId}">\r\n        <li class="lc-tree" data-binding="{@template-select: layer}{@template: Mapping/modules/LayerCatalog/Templates/LayerItemTemplate.html}"></li>\r\n        <li class="lc-tree" data-binding="{@template-select: folder}{@template: Mapping/modules/LayerCatalog/Templates/FolderItemTemplate.html}"></li>\r\n    </ul>\r\n</div>',"url:/Mapping/modules/LayerCatalog/Templates/LayerItemTemplate.html":'<!-- Template for layer items. Used in Desktop view -->\r\n<div class="catalog-layer-item" data-binding="{@visible: visible}">\r\n    <label class="catalog-item-label">\r\n        <span class="catalog-item-control">\r\n            <input type="checkbox" data-binding="{checked: isChecked}{@event-onchange: handleLayerChecked}" />\r\n        </span>\r\n        <span class="layer-item" data-binding="{@event-onclick: handleLayerChecked}">\r\n            <span class="layer-item-name" data-binding="{@text: displayName}"></span>\r\n        </span>\r\n    </label>\r\n    <button class="lc-details" data-binding="{@event-onclick: handleShowDetails}{@visible: infoLinkVisible}"><img data-binding="{alt: infoLinkText}{src: infoLinkIconUri}{title: infoLinkTooltip}" /></button>\r\n</div>'
}}),define(["Mapping/modules/LayerCatalog/AssemblyProvider","Mapping/modules/LayerCatalog/BaseLayerCatalogView","Mapping/modules/LayerCatalog/BaseLayerCatalogViewModel","Mapping/modules/LayerCatalog/BaseProvider","Mapping/modules/LayerCatalog/CatalogEntryType","Mapping/modules/LayerCatalog/CatalogEntryViewModel","Mapping/modules/LayerCatalog/DeferredUtils","Mapping/modules/LayerCatalog/Dictionary","Mapping/modules/LayerCatalog/EssentialsSiteProvider","Mapping/modules/LayerCatalog/LayerCatalogConstructor","Mapping/modules/LayerCatalog/LayerCatalogModule","Mapping/modules/LayerCatalog/LayerCatalogView","Mapping/modules/LayerCatalog/LayerCatalogViewModel","Mapping/modules/LayerCatalog/MapUtilities","Mapping/modules/LayerCatalog/PagedLayerCatalogView","Mapping/modules/LayerCatalog/PagedLayerCatalogViewModel","Mapping/modules/LayerCatalog/WmsPropertyNames"],function(e,t,a,r,i,s,n,o,l,c,d,p,y,u,h,g,f){shim(e,"geocortex.essentialsHtmlViewer.mapping.modules.layerCatalog.AssemblyProvider",e.AssemblyProvider),shim(t,"geocortex.essentialsHtmlViewer.mapping.modules.layerCatalog.BaseLayerCatalogView",t.BaseLayerCatalogView),shim(a,"geocortex.essentialsHtmlViewer.mapping.modules.layerCatalog.LayerCatalogViewModelBase",a.LayerCatalogViewModelBase),shim(a,"geocortex.essentialsHtmlViewer.mapping.modules.layerCatalog.CheckboxVisibility",a.CheckboxVisibility),shim(r,"geocortex.essentialsHtmlViewer.mapping.modules.layerCatalog.BaseProvider",r.BaseProvider),shim(i,"geocortex.essentialsHtmlViewer.mapping.modules.layerCatalog.CatalogEntryType.FOLDER",i.FOLDER),shim(i,"geocortex.essentialsHtmlViewer.mapping.modules.layerCatalog.CatalogEntryType.LAYER",i.LAYER),shim(s,"geocortex.essentialsHtmlViewer.mapping.modules.layerCatalog.CatalogEntryViewModel",s.CatalogEntryViewModel),shim(n,"geocortex.essentialsHtmlViewer.mapping.modules.layerCatalog.Deferred",n.Deferred),shim(o,"geocortex.essentialsHtmlViewer.mapping.modules.layerCatalog.Dictionary",o.Dictionary),shim(l,"geocortex.essentialsHtmlViewer.mapping.modules.layerCatalog.EssentialsSiteProvider",l.EssentialsSiteProvider),shim(c,"geocortex.essentialsHtmlViewer.mapping.modules.layerCatalog.LayerCatalogConstructor",c.LayerCatalogConstructor),shim(c,"geocortex.essentialsHtmlViewer.mapping.modules.layerCatalog.LayerCatalogRoot",c.LayerCatalogRoot),shim(c,"geocortex.essentialsHtmlViewer.mapping.modules.layerCatalog.LayerCatalogEntry",c.LayerCatalogEntry),shim(d,"geocortex.essentialsHtmlViewer.mapping.modules.layerCatalog.LayerCatalogModule",d.LayerCatalogModule),shim(p,"geocortex.essentialsHtmlViewer.mapping.modules.layerCatalog.LayerCatalogView",p.LayerCatalogView),shim(y,"geocortex.essentialsHtmlViewer.mapping.modules.layerCatalog.LayerCatalogViewModel",y.LayerCatalogViewModel),shim(u,"geocortex.essentialsHtmlViewer.mapping.modules.layerCatalog.MapUtilities",u.MapUtilities),shim(h,"geocortex.essentialsHtmlViewer.mapping.modules.layerCatalog.PagedLayerCatalogView",h.PagedLayerCatalogView),shim(g,"geocortex.essentialsHtmlViewer.mapping.modules.layerCatalog.PagedLayerCatalogViewModel",g.PagedLayerCatalogViewModel),shim(f,"geocortex.essentialsHtmlViewer.mapping.modules.layerCatalog.WmsPropertyNames.WMS_LAYER_NAME",f.WMS_LAYER_NAME),shim(f,"geocortex.essentialsHtmlViewer.mapping.modules.layerCatalog.WmsPropertyNames.WMS_SERVICE_URL",f.WMS_SERVICE_URL),shim(f,"geocortex.essentialsHtmlViewer.mapping.modules.layerCatalog.WmsPropertyNames.WMS_INSERT_POSITION",f.WMS_INSERT_POSITION)});