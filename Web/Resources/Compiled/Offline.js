!function(){function e(e,t,n){if("string"==typeof e&&(n=t,t=e),void 0!==n)for(var i=t.split("."),r=null,a=window,o=0,s=i.length;o<s;o++)r=i[o],o==s-1?a[r]=n:a[r]||(a[r]={}),a=a[r];else console.warn("Undefined shim for: "+t)}require({cache:{"Mapping/modules/Offline/Catalog":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"Mapping/modules/Offline/OfflineModule":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();define(["require","exports","geocortex/framework/application/ModuleBase","geocortex/infrastructure/GeometryUtils","geocortex/essentials/utilities/UrlUtilities"],function(t,n,i,r,a){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var o=function(t){function n(){var e=null!==t&&t.apply(this,arguments)||this;return e._nativeAppHasBeenNotified=!1,e._geocortexSessionExpiryArgs=null,e._tokenRefreshSuspended=!1,e}return e(n,t),n.prototype.initialize=function(e){var n=this;t.prototype.initialize.call(this,e),this.app.isOffline.bind(this,function(e){n._handleOfflineStatusChangeForTokenRefresh(e)}),this.app.nativeManager.isNative()&&this._attachTokenRefreshHooks(),this._registerCommands(),this.app.event("OfflineMapsLoadedEvent").subscribe(this,this._offlineMapsLoadedEventHandler),this.app.event("OfflineMapActivatedEvent").subscribe(this,this._offlineMapActivatedEventHandler),this.app.event("UserSigningOutEvent").subscribe(this,this._onUserSigningOut),this.app.event("FeatureCreatedEvent").subscribe(this,this._refreshSyncInfo),this.app.event("FeatureEditedEvent").subscribe(this,this._refreshSyncInfo),this.app.event("FeatureDeletedEvent").subscribe(this,this._refreshSyncInfo),this.app.event("SitePrincipalUpdated").subscribe(this,this._onPrincipalUpdated)},n.prototype._registerCommands=function(){var e=this;this.app.command("ClearStorageForApplication").register(this,function(t){return e._clearStorage(!1,t)}),this.app.command("ClearStorageForDomain").register(this,function(t){return e._clearStorage(!0,t)}),this.app.command("ResumeOfflineTokenRefresh").register(this,this._handleResumeOfflineTokenRefresh),this.app.command("SignOut").register(this,this._tellNativeUserLoggedOut),this.app.command("SignIn").register(this,this._tellNativeUserLoggingIn)},n.prototype._refreshSyncInfo=function(){this.app.offlineManager.refreshSyncInfo()},n.prototype._tellNativeUserLoggedOut=function(){this.app.nativeManager.message("SignOutNative",{fromViewer:!0})},n.prototype._tellNativeUserLoggingIn=function(){this.app.nativeManager.message("SigningInNative",{fromViewer:!0})},n.prototype._attachTokenRefreshHooks=function(){var e=this;dojo.subscribe("geocortex_sessionExpiring",function(t){e._geocortexSessionExpiryArgs=t,t.handled=!0,t.suspendRefresh(),e._tokenRefreshSuspended=!0,e.app.nativeManager.message("CanReachHost",{url:e.app.site.url}).then(function(n){n.result?t.resumeRefresh()&&(e._tokenRefreshSuspended=!1):e.app.trace.info("Principal expiring offline. Flagged for refresh the next time the user goes online.")})})},n.prototype._handleOfflineStatusChangeForTokenRefresh=function(e){this._geocortexSessionExpiryArgs&&!e&&this._tokenRefreshSuspended&&(this._geocortexSessionExpiryArgs.resumeRefresh(),this._tokenRefreshSuspended=!1)},n.prototype._handleResumeOfflineTokenRefresh=function(){this._handleOfflineStatusChangeForTokenRefresh(!1)},n.prototype._clearStorage=function(e,t){var n=this,i=e?this.app.store.clearAllData:this.app.store.clear,r=function(){i.call(n.app.store,function(){n.app.trace.info("Offline data for this application cleared."),n.app.event("ApplicationStorageClearedEvent").publish();var e=n.getResource("language-offline-data-cleared"),t=n.getResource("language-offline-data-cleared-title");n.app.command("Alert").execute(e,t)},function(e){n.app.trace.info("There was an error clearing offline data.");var t=n.getResource("language-offline-error-clearing-data").format(e);n.app.command("Alert").execute(t)})};t?this.app.command("Confirm").execute(this.getResource("language-clear-storage-confirm"),this.getResource("language-clear-storage"),function(e){e&&r()}):r()},n.prototype._offlineMapsLoadedEventHandler=function(e){var t=this;e.activeOfflineMap&&this.app.waitUntilSiteInitialized().then(function(){var i=new esri.geometry.Polygon(e.activeOfflineMap.content.geometry);t.app.site.essentialsMap.extentManager.setExtentWithPriority(i.getExtent().expand(n._zoomExtentExpandFactor),10)})},n.prototype._offlineMapActivatedEventHandler=function(e){var t=this;if(e.offlineMap&&e.userAction){var i=new esri.geometry.Polygon(e.offlineMap.content.geometry);r.intersects(this.app.map.extent.getCenter(),i).then(function(e){e||t.app.map.setExtent(i.getExtent().expand(n._zoomExtentExpandFactor))})}},n.prototype._onUserSigningOut=function(e){var t=this;this.app.nativeManager.isNative()&&this.app.offlineManager.isOfflineMapActive.get()&&(e.isCancelled=!0,this.app.nativeManager.message("CanReachHost",{url:this.app.site.url}).then(function(e){if(e.result)t.app.offlineManager.getStoreResource(t.app.offlineManager.getActiveOfflineMap(),"__site_").then(function(e){var n=JSON.parse(e||"{}");return n.principal&&(n.principal.isAuthenticated=!1,n.principal.label="Guest",n.principal.expiry=null,n.principal.identities=[],n.principal.tokens={arcgis:{},geocortex:{},site:null}),t.app.offlineManager.setStoreResource(t.app.offlineManager.getActiveOfflineMap(),"__site_",JSON.stringify(n))}).then(function(){t.app.site.signOut()});else{var n=a.UrlUtilities.getUrlComponents(t.app.site.url).hostname;t.app.command("Alert").execute(t.getResource("language-offline-signout-offline").format(n),t.getResource("language-offline-signout-title"))}}).catch(function(e){t.app.command("Alert").execute(t.getResource("language-offline-signout-unexpected-error").format(e.message||e),t.getResource("language-offline-signout-title"))}))},n.prototype._onPrincipalUpdated=function(){this.app.offlineManager.updatePrincipal()},n}(i.ModuleBase);o._zoomExtentExpandFactor=1.5,n.OfflineModule=o})},"Mapping/modules/Offline/OfflineModuleConfig":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})}}}),require(["geocortex/framework/resourceManager"],function(e){e.resourceManager.register("Mapping","inv","Mapping/modules/Offline/CSS/common.css","css","")}),require({cache:{}}),define(["Mapping/modules/Offline/OfflineModule"],function(t){e(t,"geocortex.essentialsHtmlViewer.mapping.modules.offline.OfflineModule",t.OfflineModule)})}();