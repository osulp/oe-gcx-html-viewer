function shim(e,t,o){if("string"==typeof e&&(o=t,t=e),"undefined"==typeof o)return void console.warn("Undefined shim for: "+t);for(var i=t.split("."),n=null,a=window,r=0,s=i.length;r<s;r++)n=i[r],r==s-1?a[n]=o:a[n]||(a[n]={}),a=a[n]}require({cache:{"Mapping/modules/Collaboration/CollaborationModule":function(){define(["require","exports","geocortex/framework/application/ModuleBase"],function(e,t,o){"use strict";var i=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t}(o.ModuleBase);t.CollaborationModule=i})},"Mapping/modules/Collaboration/GraphicsManager":function(){define(["require","exports","geocortex/infrastructure/MapUtils","geocortex/infrastructure/SymbolUtils","geocortex/infrastructure/FormatUtils","geocortex/infrastructure/DateFormat","geocortex/infrastructure/GraphicsLayerUtils","geocortex/infrastructure/GraphicsLayerIds"],function(e,t,o,i,n,a,r,s){"use strict";var l=function(){function e(e,t){var o=this;this._restHandler=null,this._app=null,this._isBuilt=!1,this._graphicBeingDeleted=!1,this.readOnly=!1,this.postedImageSymbol=new esri.symbol.PictureMarkerSymbol("Resources/Images/Pushpins/map-marker-image-24.png",24,24),this._events={},this._app=e,this._restHandler=t,this._app.doWhenMapInitialized(function(){o._graphicsLayer=r.getInternalGraphicsLayer(s.COLLABORATION_LAYER_ID,o._app,r.GraphicsLayerType.Markup,!1);var e={};e.autoEditable=!0,e.displayName=o._app.getResource("Mapping","language-collaboration-clickable-graphics-label-drawing"),e.canChangeStyles=function(e){return o._canEditEventSymbology(e)},e.canDelete=function(e){return o._canEditEventGeometry(e)},e.canEdit=function(e){return o._canEditEventGeometry(e)},e.aliases={_created:o._app.getResource("Mapping","language-collaboration-event-created"),_createdBy:o._app.getResource("Mapping","language-collaboration-event-createdBy"),_message:o._app.getResource("Mapping","language-collaboration-event-message")},o._app.clickableGraphics.register(o._graphicsLayer,e)}),this._app.command("LoadCollaborationMarkupGraphics").register(this,this._executeLoadCollaborationEventGraphics),this._app.command("AddCollaborationFeatures").register(this,this._executeAddCollaborationFeatures,this._canExecuteAddCollaborationFeatures),this._app.command("RemoveCollaborationFeatures").register(this,this._executeRemoveCollaborationFeatures,this._canExecuteRemoveCollaborationFeatures),this._app.command("ClearCollaborationFeatures").register(this,this._executeClearCollaborationFeatures,this._canExecuteClearCollaborationFeatures),this._app.command("HighlightCollaborationFeatures").register(this,this._executeHighlightCollaborationFeatures),this._app.command("EditCollaborationMarkupMessage").register(this,this._executeEditCollaborationMarkupMessage,this._canExecuteEditCollaborationMarkupMessage),this._app.event("GraphicEditingDoneEvent").subscribe(this,this._handleGraphicEditingDoneEvent),this._app.event("GraphicRemovedEvent").subscribe(this,this._handleGraphicRemovedEvent),this._app.event("_deleteClickableFeatureStarted").subscribe(this,this._handleDeleteClickableFeatureStartedEvent)}return e.prototype.buildRoomMarkupState=function(e){var t=this;return e.length?new Promise(function(o,i){t._restHandler.getLatestState({rooms:e,eventTypes:["ShareMarkupEvent","DeleteMarkupEvent","ShareImageEvent"]}).then(function(e){e.events.forEach(function(e){t._executeLoadCollaborationEventGraphics(e)}),t._isBuilt=!0,o()}).caught(function(e){t._app.trace.error("GraphicsManager failed to build the requested graphics state of the map. Error: {0}.".format(e.message)),i(e)})}):Promise.resolve()},e.prototype._executeLoadCollaborationEventGraphics=function(e){e.sourceEvent&&(this._events[e.sourceEvent]?e.roomId===this._events[e.sourceEvent].roomId&&(this._events[e.sourceEvent].deleted=!0,this._events[e.sourceEvent].editInProgress=!1,this._app.event("CollaborationMapEventDeletedEvent").publish(e.sourceEvent),this._app.command("RemoveCollaborationFeatures").execute(e.sourceEvent)):(this._events[e.sourceEvent]={event:null,deleted:!0,roomId:e.roomId},this._app.event("CollaborationMapEventDeletedEvent").publish(e.sourceEvent),this._app.command("RemoveCollaborationFeatures").execute(e.sourceEvent))),this._events[e.id]&&this._events[e.id].editInProgress&&(this._events[e.id].editInProgress=!1),this._events[e.id]&&this._events[e.id].deleted&&e.roomId===this._events[e.id].roomId?(this._app.event("CollaborationMapEventDeletedEvent").publish(e.id),this._events[e.id]={event:e,deleted:!0,roomId:e.roomId}):(this._app.command("AddCollaborationFeatures").execute(e),this._events[e.id]={event:e,deleted:!1,roomId:e.roomId})},e.prototype._executeClearCollaborationFeatures=function(){this._graphicsLayer.clear(),this._isBuilt=!1,this._events={},this._app.command("ClearCollaborationFeatures").raiseCanExecuteChanged(),this._app.command("StopEditingMarkup").execute()},e.prototype._canExecuteClearCollaborationFeatures=function(){return!!this._graphicsLayer.graphics.length},e.prototype._findEventGraphics=function(e){return this._graphicsLayer.graphics.filter(function(t){return t.attributes&&t.attributes._eventId===e})},e.prototype.mapHasGraphicsLoaded=function(e){return this._graphicsLayer.graphics.some(function(t){return t.attributes&&t.attributes._eventId===e})},e.prototype.eventDeleted=function(e){return this._events[e]&&this._events[e].deleted},e.prototype._canExecuteRemoveCollaborationFeatures=function(e){return this.mapHasGraphicsLoaded(e)},e.prototype._executeRemoveCollaborationFeatures=function(e){var t=this;this._findEventGraphics(e).forEach(function(e){t._graphicsLayer.remove(e),t._app.featureSetManager.updateCollectionsOnFeatureDeletion(e)})},e.prototype._loadShareImageGraphic=function(e){var t=esri.geometry.fromJson(e.data.location),o=esri.symbol.fromJson(this.postedImageSymbol.toJson()),i=new esri.Graphic(t,o);return i},e.prototype._loadShareMarkupGraphics=function(e){var t=JSON.parse(JSON.stringify(e.data.markup)),o=new esri.tasks.FeatureSet(t.points||(new esri.tasks.FeatureSet).toJson());o.features=o.features?o.features:[];var i=new esri.tasks.FeatureSet(t.polylines||(new esri.tasks.FeatureSet).toJson());i.features=i.features?i.features:[];var n=new esri.tasks.FeatureSet(t.polygons||(new esri.tasks.FeatureSet).toJson());n.features=n.features?n.features:[];var a=new esri.tasks.FeatureSet(t.rectangles||(new esri.tasks.FeatureSet).toJson());a.features=a.features?a.features:[];var r=o.features.concat(i.features).concat(n.features).concat(a.features);return r.forEach(function(e){if(e.attributes&&e.attributes.__symbol){var t=esri.symbol.fromJson(e.attributes.__symbol);e.setSymbol(t)}}),r},e.prototype._canExecuteAddCollaborationFeatures=function(e){return!this.mapHasGraphicsLoaded(e.id)},e.prototype._executeAddCollaborationFeatures=function(e){var t=this;if(!e)throw new Error("Cannot add Collaboration graphics without an event reference.");var o=[];switch(e.type){case"ShareMarkupEvent":o=this._loadShareMarkupGraphics(e);break;case"ShareImageEvent":o=[this._loadShareImageGraphic(e)]}o.forEach(function(o){t._addCollaborationGraphicAttributes(o,e),t._graphicsLayer.add(o)}),this._events[e.id]={event:e,deleted:!1,roomId:e.roomId},this._app.command("ClearCollaborationFeatures").raiseCanExecuteChanged()},e.prototype._addCollaborationGraphicAttributes=function(e,t){e&&t&&(e.attributes||(e.attributes={}),e.attributes._eventId=t.id,e.attributes._event=t,e.attributes._createdBy=t.createdBy,e.attributes._created=n.formatDate(new Date(Date.parse(t.created)),a.DateFormat.DEFAULT),t.data.message&&(e.attributes._message=t.data.message))},e.prototype._removeCollaborationGraphicAttributes=function(e){e&&e.attributes&&(delete e.attributes._event,delete e.attributes._createdBy,delete e.attributes._created,delete e.attributes._message)},e.prototype._executeHighlightCollaborationFeatures=function(e){var t=this._findEventGraphics(e);if(t.length){var o=esri.graphicsExtent(t),i=this._app.map.extent,n=o.getHeight()*o.getWidth(),a=i.getHeight()*i.getWidth(),r=i.contains(o),s=400*n>=a||0===n;r&&s||this._app.command("ZoomToExtent").execute(o.expand(2)),t.forEach(function(e){var t=e.getNode();t&&dojo.fx.chain([dojo.fadeOut({duration:250,node:t}),dojo.fadeIn({duration:250,node:t})]).play()})}},e.prototype._canExecuteEditCollaborationMarkupMessage=function(e,t){return!this.readOnly&&this._events[e]&&this._events[e].event.isOwner&&"ShareMarkupEvent"===this._events[e].event.type||"ShareImageEvent"===this._events[e].event.type},e.prototype._executeEditCollaborationMarkupMessage=function(e,t){this._events[e].newMessage=t},e.prototype._canEditEventGeometry=function(e){if(this.readOnly||!e||!e.attributes||e.getLayer()!==this._graphicsLayer)return!1;var t=e.attributes._eventId;return t&&this._events[t]&&this._events[t].event&&this._events[t].event.isOwner&&!this._events[t].editInProgress},e.prototype._canEditEventSymbology=function(e){return this._canEditEventGeometry(e)&&"ShareImageEvent"!==this._events[e.attributes._eventId].event.type},e.prototype._messageChanged=function(e){return this._events[e]&&this._events[e].event&&this._events[e].event.data&&void 0!==this._events[e].event.data.message&&this._events[e].event.data.message!==this._events[e].newMessage&&void 0!==this._events[e].newMessage},e.prototype._handleGraphicEditingDoneEvent=function(e){if(e&&e["new"]&&e.old&&e["new"].attributes&&e["new"].getLayer()===this._graphicsLayer&&!this._graphicBeingDeleted){var t=e["new"].attributes._eventId;t&&(o.esriGeometriesEqual(e["new"].geometry,e.old.geometry)&&i.esriSymbolsEqual(e["new"].symbol,e.old.symbol)&&!this._messageChanged(t)||this._eventEdited(t))}},e.prototype._handleDeleteClickableFeatureStartedEvent=function(e){var t=e.esriFeature.get();t&&t.getLayer()===this._graphicsLayer&&t.attributes&&t.attributes._eventId&&(this._graphicBeingDeleted=!0)},e.prototype._handleGraphicRemovedEvent=function(e){if(e.graphic&&e.graphic.attributes&&e.graphic.getLayer()===this._graphicsLayer){var t=e.graphic.attributes._eventId;t&&(this._graphicBeingDeleted=!1,this._eventEdited(t))}},e.prototype._eventDeleted=function(e){var t=this._events[e]?this._events[e].event:null;if(!t)return void this._app.trace.warning("No collaboration event with id {0} has been loaded.".format(e));this._events[e].editInProgress=!0,this._events[e].newMessage=void 0;var o={roomId:t.roomId,type:"DeleteMarkupEvent",data:{}};this._app.command("EditCollaborationEvent").execute(e,o)},e.prototype._eventEdited=function(e){var t=this;if(!(this.readOnly||this._events[e]&&this._events[e].deleted)){var o=this._events[e]?this._events[e].event:null;if(!o)return void this._app.trace.warning("No collaboration event with id {0} has been loaded.".format(e));var i=this._findEventGraphics(o.id);if(!i.length)return void this._eventDeleted(o.id);this._events[e].editInProgress=!0;var n={type:o.type,roomId:o.roomId,data:{}};i.forEach(function(e){return t._removeCollaborationGraphicAttributes(e)});var a=o.data.message;switch(void 0!==this._events[e].newMessage&&(a=this._events[e].newMessage,this._events[e].newMessage=void 0),o.type){case"ShareMarkupEvent":i.forEach(function(e){e.symbol&&(e.attributes||(e.attributes={}),e.attributes.__symbol=e.symbol.toJson())});var r=new esri.tasks.FeatureSet;r.features=i.filter(function(e){return"point"===e.geometry.type});var s=new esri.tasks.FeatureSet;s.features=i.filter(function(e){return"polyline"===e.geometry.type});var l=new esri.tasks.FeatureSet;l.features=i.filter(function(e){return"polygon"===e.geometry.type});var c=new esri.tasks.FeatureSet;c.features=i.filter(function(e){return"rectangle"===e.geometry.type});var d={points:r.toJson(),polylines:s.toJson(),polygons:l.toJson(),rectangles:c.toJson()};n.data={markup:d,message:a},this._app.command("EditCollaborationEvent").execute(o.id,n);break;case"ShareImageEvent":n.attachmentId=o.attachmentId,n.data={location:i[0].geometry.toJson(),message:a},this._app.command("EditCollaborationEvent").execute(o.id,n)}}},e}();t.GraphicsManager=l})},"Mapping/modules/Collaboration/MarkupManager":function(){define(["require","exports","geocortex/infrastructure/SymbolUtils","geocortex/framework/observables","geocortex/infrastructure/tools/DrawMode","geocortex/infrastructure/GeometryUtils","geocortex/infrastructure/GraphicsLayerIds","geocortex/infrastructure/GraphicsLayerUtils"],function(e,t,o,i,n,a,r,s){"use strict";var l=function(){function e(e,t){var n=this;if(this._markupWorkingLayer=null,this._drawingToolNames=[],this._currentPointSymbol=new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE,14,new esri.symbol.SimpleLineSymbol,o.defaultSymbolColor()),this._currentPolylineSymbol=o.defaultLineSymbol(),this._currentPolygonSymbol=o.defaultFillSymbol(),this._photoLocation=null,this._hasMarkup=new i.Observable((!1)),this._editInProgress=new i.Observable((!1)),this.unpostedImageSymbol=new esri.symbol.PictureMarkerSymbol("Resources/Images/Pushpins/map-marker-image-24.png",24,24),this.currentSymbol=null,this.drawingToolSelectedType=new i.Observable(""),this.toolReady=new i.Observable((!1)),this._app=e,!t||!this._app.toolRegistry)throw new Error("No tools were specified. Collaboration markup will be unavailable.");this._drawingToolNames=t.map(function(e){return e.name}),this._app.command("CollaborationDraw").register(this,this._handleDrawFinished),this._app.command("SetCollaborationImageLocation").register(this,this._handleImageLocationFinished),this.drawingToolSelectedType.bind(this,this._handleSelectedToolChangedEvent),this._app.command("ClearCollaborationDrawings").register(this,this._executeClearCollaborationDrawings,this._canExecuteClearCollaborationDrawings),this._hasMarkup.bind(this,function(){return n._syncToolReady()}),this._editInProgress.bind(this,function(){return n._syncToolReady()}),this._app.doWhenMapInitialized(function(){n._markupWorkingLayer=s.getInternalGraphicsLayer(r.COLLABORATION_SCRATCH_LAYER_ID,n._app,s.GraphicsLayerType.Markup,!1)}),this._photoLocation=new esri.Graphic;var a=esri.symbol.fromJson(this.unpostedImageSymbol.toJson());this._photoLocation.setSymbol(a);var l={};l.autoEditable=!0,l.displayName=this._app.getResource("Mapping","language-collaboration-clickable-graphics-label-drawing"),this._app.clickableGraphics.register(this._markupWorkingLayer,l);var c=function(e,t){e===n._markupWorkingLayer&&t()};this._app.event("GraphicRemovedEvent").subscribe(this,function(e){return c(e.graphicLayer,function(){return n._syncHasMarkup()})}),this._app.event("GraphicEditActivatedEvent").subscribe(this,function(e){return c(e.graphic.getLayer(),function(){return n._editInProgress.set(!0)})}),this._app.event("GraphicEditDeactivatedEvent").subscribe(this,function(e){return c(e.graphic.getLayer(),function(){return n._editInProgress.set(!1)})})}return e.prototype.getFeaturesFromDrawingsLayer=function(){var e={points:new esri.tasks.FeatureSet,polylines:new esri.tasks.FeatureSet,polygons:new esri.tasks.FeatureSet,rectangles:new esri.tasks.FeatureSet};return this._markupWorkingLayer.graphics.forEach(function(t){t.symbol&&(t.attributes||(t.attributes={}),t.attributes.__symbol=t.symbol.toJson()),t.geometry instanceof esri.geometry.Point?e.points.features.push(t):t.geometry instanceof esri.geometry.Polygon?e.polygons.features.push(t):t.geometry instanceof esri.geometry.Polyline?e.polylines.features.push(t):t.geometry instanceof esri.geometry.Extent&&e.rectangles.features.push(t)}),e},e.prototype.setPhotoLocation=function(e,t){var o=this;return void 0===t&&(t=!1),new Promise(function(i,n){o.removePhotoLocation(),a.projectGeometry(e,o._app.map.spatialReference,function(e){o._photoLocation.setGeometry(e),o._markupWorkingLayer.add(o._photoLocation),o._syncHasMarkup(),t&&o._app.map.centerAt(e),i(e)},function(e){n(e)},o._app)})},e.prototype.removePhotoLocation=function(){this._markupWorkingLayer.remove(this._photoLocation),this._photoLocation.setGeometry(null),this._syncHasMarkup()},e.prototype.getPhotoLocation=function(){return this._photoLocation.geometry},e.prototype._executeClearCollaborationDrawings=function(){this._markupWorkingLayer.clear(),this._syncHasMarkup()},e.prototype._handleImageLocationFinished=function(e){this.setPhotoLocation(e)},e.prototype._handleDrawFinished=function(e){var t=null;e instanceof esri.geometry.Point?t=this.currentSymbol:e instanceof esri.geometry.Polygon?t=this.currentSymbol:e instanceof esri.geometry.Polyline?t=this.currentSymbol:e instanceof esri.geometry.Extent&&(t=this.currentSymbol);var o=new esri.Graphic(e,t,{});this._markupWorkingLayer.add(o),this._syncHasMarkup()},e.prototype._syncHasMarkup=function(){this._hasMarkup.set(!!this._markupWorkingLayer.graphics.length),this._app.command("ClearCollaborationDrawings").raiseCanExecuteChanged()},e.prototype._syncToolReady=function(){this.toolReady.set(this._hasMarkup.get()&&!this._editInProgress.get())},e.prototype._handleSelectedToolChangedEvent=function(e){switch(e){case n.DrawMode.POINT:this.currentSymbol=this._currentPointSymbol;break;case n.DrawMode.FREEHAND_POLYLINE:case n.DrawMode.LINE:case n.DrawMode.POLYLINE:this.currentSymbol=this._currentPolylineSymbol;break;case n.DrawMode.POLYGON:case n.DrawMode.FREEHAND_POLYGON:case n.DrawMode.CIRCLE:case n.DrawMode.ELLIPSE:case n.DrawMode.EXTENT:case n.DrawMode.RECTANGLE:this.currentSymbol=this._currentPolygonSymbol;break;case null:break;default:throw new Error("{0} draw mode is unhandled.".format(e))}},e.prototype._isConfigured=function(e){return this._drawingToolNames.some(function(t){return t===e})},e.prototype.setCurrentSymbol=function(e){this.currentSymbol=esri.symbol.fromJson(JSON.parse(e)),this.currentSymbol instanceof esri.symbol.SimpleMarkerSymbol?this._currentPointSymbol=this.currentSymbol:this.currentSymbol instanceof esri.symbol.SimpleLineSymbol?this._currentPolylineSymbol=this.currentSymbol:this.currentSymbol instanceof esri.symbol.SimpleFillSymbol&&(this._currentPolygonSymbol=this.currentSymbol)},e.prototype._canExecuteClearCollaborationDrawings=function(){return!!this._markupWorkingLayer.graphics.length},e}();t.MarkupManager=l})},"Mapping/modules/Collaboration/RestHandler":function(){define(["require","exports","geocortex/geocortex","geocortex/essentials/utilities/UrlUtilities"],function(e,t,o,i){"use strict";var n="/../../collaboration",a=function(){function e(e,t){this.eventId=0,this.app=e,this._restEndpoint=t}return e.getCollaborationServiceUrl=function(e){var t=/^(.*?)(\/*)$/.exec(e.site.originalUrl)[1];return i.UrlUtilities.simplify(t+n)},e.prototype.getEventId=function(){var e=this.eventId.toString();return this.eventId++,e},e.prototype.getRooms=function(e){var t=this;return new Promise(function(i,n){var a={usePost:!1},r={options:JSON.stringify(e),token:t.app.site.principal.tokens.site},s={url:t._makeUrl(t._restEndpoint,"Rooms"),content:r,load:function(e){i(e)},error:function(e){n(e)}};o.request(s,a)})},e.prototype.query=function(e){var t=this;return new Promise(function(i,n){var a={usePost:!1},r={url:t._makeUrl(t._restEndpoint,"Events/Query"),content:{options:JSON.stringify(e),token:t.app.site.principal.tokens.site},load:function(e){i(e)},error:function(e){n(e)}};o.request(r,a)})},e.prototype.getLatestState=function(e){var t=this;return new Promise(function(i,n){var a={usePost:!1},r={url:t._makeUrl(t._restEndpoint,"Events/GetLatestState"),content:{options:JSON.stringify(e),token:t.app.site.principal.tokens.site},load:function(e){i(e)},error:function(e){n(e)}};o.request(r,a)})},e.prototype.addEvent=function(e){var t=this;return new Promise(function(i,n){var a={usePost:!0},r={url:t._makeUrl(t._restEndpoint,"Room/{0}/Event/Add".format(e.roomId)),content:{clientEvent:JSON.stringify(e),token:t.app.site.principal.tokens.site},load:function(e){i(e)},error:function(e){n(e)}};o.request(r,a)})},e.prototype.createRoom=function(e){var t=this;return new Promise(function(i,n){var a={usePost:!0},r={url:t._makeUrl(t._restEndpoint,"Rooms/Create"),content:{clientRoom:JSON.stringify(e),token:t.app.site.principal.tokens.site},load:function(e){i(e)},error:function(e){n(e)}};o.request(r,a)})},e.prototype.joinRoom=function(e){var t=this;return new Promise(function(i,n){var a={usePost:!0},r={url:t._makeUrl(t._restEndpoint,"Room/{0}/Join".format(e)),content:{token:t.app.site.principal.tokens.site},load:function(e){i(e)},error:function(e){n(e)}};o.request(r,a)})},e.prototype.leaveRoom=function(e){var t=this;return new Promise(function(i,n){var a={usePost:!0},r={url:t._makeUrl(t._restEndpoint,"Room/{0}/Leave".format(e)),content:{token:t.app.site.principal.tokens.site},load:function(e){i(e)},error:function(e){n(e)}};o.request(r,a)})},e.prototype.copyEvent=function(e,t){var i=this;return new Promise(function(n,a){var r={usePost:!0},s={url:i._makeUrl(i._restEndpoint,"Event/{0}/Copy/{1}".format(e,t)),content:{token:i.app.site.principal.tokens.site},load:function(e){n(e)},error:function(e){a(e)}};o.request(s,r)})},e.prototype.editRoom=function(e,t){var i=this;return new Promise(function(n,a){var r={usePost:!0},s={url:i._makeUrl(i._restEndpoint,"Room/{0}/Edit".format(e)),content:{clientRoom:JSON.stringify(t),token:i.app.site.principal.tokens.site},load:function(e){n(e)},error:function(e){a(e)}};o.request(s,r)})},e.prototype.editEvent=function(e,t){var i=this;return new Promise(function(n,a){var r={usePost:!0},s={url:i._makeUrl(i._restEndpoint,"Event/{0}/Edit".format(e)),content:{clientEvent:JSON.stringify(t),token:i.app.site.principal.tokens.site},load:function(e){n(e)},error:function(e){a(e)}};o.request(s,r)})},e.prototype.getEvent=function(e){var t=this;return new Promise(function(i,n){var a={usePost:!1},r={url:t._makeUrl(t._restEndpoint,"Event/{0}".format(e)),content:{token:t.app.site.principal.tokens.site},load:function(e){i(e)},error:function(e){n(e)}};o.request(r,a)})},e.prototype.checkRoomNameUnique=function(e,t){var i=this;return new Promise(function(n,a){var r={usePost:!1},s={url:i._makeUrl(i._restEndpoint,"Rooms/Names/CheckUniqueness"),content:{roomName:e,appId:t,token:i.app.site.principal.tokens.site},load:function(e){n(e)},error:function(e){a(e)}};o.request(s,r)})},e.prototype.pushRoom=function(e,t,i){var n=this;return new Promise(function(a,r){var s={usePost:!0},l={url:n._makeUrl(n._restEndpoint,"Room/{0}/Push/{1}".format(e,t)),content:{options:JSON.stringify(i),token:n.app.site.principal.tokens.site},load:function(e){a(e)},error:function(e){r(e)}};o.request(l,s)})},e.prototype._makeUrl=function(e,t){return e.endsWith("/")&&(e=e.substring(0,e.length-1)),"{0}/{1}".format(e,t)},e}();t.RestHandler=a})},"Mapping/modules/Collaboration/Events/BaseEventViewModel":function(){define(["require","exports","geocortex/framework/ui/ViewModelBase","geocortex/framework/observables","geocortex/infrastructure/FormatUtils","geocortex/infrastructure/DateFormat"],function(e,t,o,i,n,a){"use strict";var r=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type=new i.Observable(""),t.created=new i.Observable(""),t.createdBy=new i.Observable(""),t.createdByPresentable=new i.Observable(""),t.color=new i.Observable(""),t.roomDisplayName=new i.Observable(""),t}return __extends(t,e),t.prototype._formatName=function(e){return e.lastIndexOf("(")===-1?e.trim():e.slice(0,e.lastIndexOf("(")).trim()},t.prototype._formatDate=function(e){var t=new Date(Date.parse(e)),o=new Date(Date.now()),i=o.getUTCFullYear()===t.getUTCFullYear()&&o.getUTCMonth()===t.getUTCMonth()&&o.getUTCDate()===t.getUTCDate();return i?n.formatDate(t,a.DateFormat.TIME_SHORT):n.formatDate(t,a.DateFormat.DATE_TIME_SHORT)},t.prototype._updateRoom=function(e){this.room.id===e.id&&(this.room.color=e.color,this.room.displayName=e.displayName,this.color.set(this.room.color),this.roomDisplayName.set(this.room.displayName))},t.prototype.onClick=function(){},t.prototype.loadEvent=function(){this.created.set(this._formatDate(this.event.created)),this.createdBy.set(this.event.createdBy),this.createdByPresentable.set(this._formatName(this.event.createdBy)),this.type.set(this.event.type),this.color.set(this.room.color),this.roomDisplayName.set(this.room.displayName),this._roomSubscriptionToken=this.app.event("CollaborationRoomUpdatedEvent").subscribe(this,this._updateRoom)},t.prototype.unloadEvent=function(){this.app.event("CollaborationRoomUpdatedEvent").unsubscribe(this._roomSubscriptionToken)},t}(o.ViewModelBase);t.BaseEventViewModel=r})},"Mapping/modules/Collaboration/Events/EventCopyView":function(){define(["require","exports","geocortex/framework/ui/ViewBase"],function(e,t,o){"use strict";var i=function(e){function t(t,o){var i=e.call(this,t,o)||this;return i._event=null,i.app.command("ActivateEventCopyView").register(i,i._handleShowCopyDialogForEvent),i}return __extends(t,e),t.prototype.cancelClicked=function(){this.app.viewManager.deactivateView(this),this._event=null},t.prototype.copyClicked=function(){this.app.command("CopyCollaborationEvent").execute(this._event,this.viewModel.selectedCopyRoom.get().id),this.app.viewManager.deactivateView(this)},t.prototype._handleShowCopyDialogForEvent=function(e){this._event=e,this.app.viewManager.activateView(this)},t}(o.ViewBase);t.EventCopyView=i})},"Mapping/modules/Collaboration/Events/EventEditView":function(){define(["require","exports","geocortex/framework/ui/ViewBase"],function(e,t,o){"use strict";var i=function(e){function t(t,o){var i=e.call(this,t,o)||this;return i.app.command("ShowEditCollaborationMessageView").register(i,i._executeEditCollaborationMessage,i._canEditCollaborationMessage),i.app.command("ShowEditCollaborationGraphicMessageView").register(i,i._executeEditCollaborationGraphicMessage,i._canEditCollaborationGraphicMessage),i}return __extends(t,e),t.prototype.cancelClicked=function(){this.app.viewManager.deactivateView(this)},t.prototype.editClicked=function(){this.viewModel.editEvent(),this.app.viewManager.deactivateView(this)},t.prototype.saveClicked=function(){this.viewModel.saveEvent(),this.app.viewManager.deactivateView(this)},t.prototype.deactivated=function(){e.prototype.deactivated.call(this),this.app.command("EditCollaborationFeatureMessage").raiseCanExecuteChanged()},t.prototype.exit=function(){this.app.viewManager.deactivateView(this)},t.prototype._canEditCollaborationMessage=function(e){return e&&e.isOwner&&void 0!==e.data.message&&this.viewModel.editableTypes.indexOf(e.type)!==-1},t.prototype._executeEditCollaborationMessage=function(e){this.viewModel.clickableGraphicsMode.set(!1),this.viewModel.loadEvent(e),this.app.viewManager.activateView(this)},t.prototype._canEditCollaborationGraphicMessage=function(e){var t=e.esriFeature.get();if(t&&t.attributes&&t.attributes._event&&"__CollaborationGraphicsLayer"===t.getLayer().id){var o=t.attributes._event;return this.viewModel.event&&o.id!==this.viewModel.event.id&&(this.viewModel.editedMessage=void 0),this.app.command("EditCollaborationMarkupMessage").canExecute(o.id,"")&&this.app.command("ShowEditCollaborationMessageView").canExecute(o)}return!1},t.prototype._executeEditCollaborationGraphicMessage=function(e){var t=e.esriFeature.get();this.viewModel.clickableGraphicsMode.set(!0),this.viewModel.loadEvent(t.attributes._event),this.app.viewManager.activateView(this)},t}(o.ViewBase);t.EventEditView=i})},"Mapping/modules/Collaboration/Events/EventEditViewModel":function(){define(["require","exports","geocortex/framework/ui/ViewModelBase","geocortex/framework/observables"],function(e,t,o,i){"use strict";var n=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.event=null,t.message=new i.Observable(""),t.characterLimit=new i.Observable,t.sendEnabled=new i.Observable((!1)),t.editableTypes=[],t.clickableGraphicsMode=new i.Observable((!1)),t}return __extends(t,e),t.prototype.initialize=function(t){var o=this;e.prototype.initialize.call(this,t);this.app.configModel.moduleConfigs.filter(function(e){return"Collaboration"===e.moduleName})[0];t&&(this.characterLimit.set(t.characterLimit||1e3),this.editableTypes=t.editableTypes||["ShareMarkupEvent","ShareImageEvent"]),this.message.bind(this,function(e){o.clickableGraphicsMode.get()&&void 0!==o.editedMessage?o.sendEnabled.set(e!==o.editedMessage):o.event&&o.event.data&&o.sendEnabled.set(e!==o.event.data.message)})},t.prototype.loadEvent=function(e){void 0!==e.data.message&&(this.event=e,this.clickableGraphicsMode.get()&&void 0!==this.editedMessage?this.message.set(this.editedMessage):this.message.set(e.data.message))},t.prototype.editEvent=function(){this.editedMessage=this.message.get(),this.app.command("EditCollaborationMarkupMessage").execute(this.event.id,this.message.get())},t.prototype.saveEvent=function(){var e=this.event.data.message;if(!this.message.equals(e)){var t=JSON.parse(JSON.stringify(this.event.data));t.message=this.message.get();var o={type:this.event.type,roomId:this.event.roomId,attachmentId:this.event.attachmentId,data:t};this.app.command("EditCollaborationEvent").execute(this.event.id,o)}},t}(o.ViewModelBase);t.EventEditViewModel=n})},"Mapping/modules/Collaboration/Events/BannerEvent/BannerEventView":function(){define(["require","exports","geocortex/framework/ui/ViewBase"],function(e,t,o){"use strict";var i=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.attach=function(t){e.prototype.attach.call(this,t)},t.prototype.handleClick=function(e,t,o){this.viewModel.onClick()},t}(o.ViewBase);t.BannerEventView=i})},"Mapping/modules/Collaboration/Events/BannerEvent/BannerEventViewModel":function(){define(["require","exports","geocortex/framework/observables","../BaseEventViewModel"],function(e,t,o,i){"use strict";var n=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.bannerText=new o.Observable(""),t.bannerTitle=new o.Observable(""),t}return __extends(t,e),t.prototype._formatName=function(e){return e.lastIndexOf("(")===-1?e.trim():e.slice(0,e.lastIndexOf("(")).trim()},t.prototype.loadEvent=function(){e.prototype.loadEvent.call(this),this.bannerText.set(this.app.getResource(this.libraryId,"language-collaboration-no-event-content")),this.bannerTitle.set(this.created.get())},t}(i.BaseEventViewModel);t.BannerEventViewModel=n})},"Mapping/modules/Collaboration/Events/CardEvent/CardEventView":function(){define(["require","exports","geocortex/framework/ui/ViewBase"],function(e,t,o){"use strict";var i=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.toggleSync=!1,t}return __extends(t,e),t.prototype.attach=function(t){e.prototype.attach.call(this,t)},t.prototype.handleClick=function(e,t,o){this.viewModel.onClick()},t.prototype.resolveWidget=function(t,o,i){var n=this;switch(t){case"EventActionsWidget":return this.menuView=this.app.menuRegistry.createMenuWidget(this,o,i),this.viewModel.menuEnabled.syncTransform(this.menuView.viewModel.hasExecutableMenuItems,function(){return n._isMenuEnabled()}),this.menuView;case"EventContentWidget":var a=this.app.viewManager.createView({markupResource:this.viewModel.contentWidgetMarkup,libraryId:this.libraryId,isVisible:!0});return a.parentView=this,a.attach(o),a}return e.prototype.resolveWidget.call(this,t,o,i)},t.prototype.toggleEventMenu=function(e,t,o){var i=this;if(this.viewModel.menuVisible.get())this.viewModel.menuVisible.set(!1),this.app.event("FlyoutDeactivated").publish(this);else{this.viewModel.menuVisible.set(!0),this.app.event("FlyoutActivated").publish(this);var n={view:this.menuView,onOtherInteracted:function(e){e.srcElement!==t&&(i.viewModel.menuVisible.set(!1),i.app.event("FlyoutDeactivated").publish(i))}};this.app.command("TapToDismiss").execute(n)}},t.prototype._isMenuEnabled=function(){return this.menuView.viewModel.hasExecutableMenuItems.get()},t}(o.ViewBase);t.CardEventView=i})},"Mapping/modules/Collaboration/Events/CardEvent/CardEventViewModel":function(){define(["require","exports","geocortex/framework/observables","../BaseEventViewModel"],function(e,t,o,i){"use strict";var n=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.clickable=new o.Observable((!1)),t.isLoading=new o.Observable((!1)),
t.isOwner=new o.Observable((!1)),t.explainerText=new o.Observable(t.app.getResource(t.libraryId,"language-collaboration-default-event-explainer")),t.menuVisible=new o.Observable((!1)),t.menuEnabled=new o.Observable((!1)),t.contentWidgetMarkup="Mapping/modules/Collaboration/EventsCardEvent/CardEventContentView.html",t}return __extends(t,e),t.prototype._formatName=function(t){return this.isOwner.get()?this.app.getResource(this.libraryId,"language-collaboration-event-owner-label"):e.prototype._formatName.call(this,t)},t.prototype.loadEvent=function(){var t=this;e.prototype.loadEvent.call(this),this.isLoading.set(!0),this.isOwner.set(this.event.isOwner),this.explainerText.set(this.explainerText.get().format(this.roomDisplayName.get())),setTimeout(function(){t.isLoading.set(!1)},1e3)},t}(i.BaseEventViewModel);t.CardEventViewModel=n})},"Mapping/modules/Collaboration/Events/DeleteMarkupEvent/DeleteMarkupEventView":function(){define(["require","exports","../BannerEvent/BannerEventView"],function(e,t,o){"use strict";var i=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t}(o.BannerEventView);t.DeleteMarkupEventView=i})},"Mapping/modules/Collaboration/Events/DeleteMarkupEvent/DeleteMarkupEventViewModel":function(){define(["require","exports","../BannerEvent/BannerEventViewModel"],function(e,t,o){"use strict";var i=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.loadEvent=function(){e.prototype.loadEvent.call(this),this.bannerText.set(this.app.getResource(this.libraryId,"language-collaboration-event-drawing-erased-notification").format(this.createdByPresentable.get(),this.roomDisplayName.get())),this.app.command("LoadCollaborationMarkupGraphics").execute(this.event)},t}(o.BannerEventViewModel);t.DeleteMarkupEventViewModel=i})},"Mapping/modules/Collaboration/Events/ImageEvent/ImageEventView":function(){define(["require","exports","../MapEvent/MapEventView"],function(e,t,o){"use strict";var i=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.formElement=null,t.formTokenElement=null,t}return __extends(t,e),t.prototype.handleOpenFullClick=function(e,t,o){this.formTokenElement.value=this.app.site.principal.tokens.site,this.formElement.submit()},t.prototype.onPreviewLoaded=function(){this.app.event("CollaborationImageLoadedEvent").publish(this.viewModel.event)},t}(o.MapEventView);t.ImageEventView=i})},"Mapping/modules/Collaboration/Events/ImageEvent/ImageEventViewModel":function(){define(["require","exports","../MapEvent/MapEventViewModel","geocortex/framework/observables","../../RestHandler"],function(e,t,o,i,n){"use strict";var a="event/{0}/preview",r="event/{0}/open",s=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.previewUrl=new i.Observable(""),t.openUrl=new i.Observable(""),t._previewUrlTemplate="",t._fullUrlTemplate="",t.contentWidgetMarkup="Mapping/modules/Collaboration/Events/ImageEvent/ImageEventContentView.html",t}return __extends(t,e),t.prototype.initialize=function(t){e.prototype.initialize.call(this,t);var o=n.RestHandler.getCollaborationServiceUrl(this.app);t&&(this._previewUrlTemplate=t.previewUrl||"{0}/{1}".format(o,a),this._fullUrlTemplate=t.fullUrl||"{0}/{1}".format(o,r))},t.prototype.onClick=function(){this.deleted.get()||this.app.command("HighlightCollaborationFeatures").execute(this.event.id)},t.prototype.loadEvent=function(){e.prototype.loadEvent.call(this),this.previewUrl.set("{0}?token={1}".format(this._previewUrlTemplate.format(this.event.id),this.app.site.principal.tokens.site)),this.openUrl.set(this._fullUrlTemplate.format(this.event.id))},t}(o.MapEventViewModel);t.ImageEventViewModel=s})},"Mapping/modules/Collaboration/Events/MapEvent/MapEventView":function(){define(["require","exports","../MessageEvent/MessageEventView"],function(e,t,o){"use strict";var i=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.resolveWidget=function(t,o,i){var n=this,a=e.prototype.resolveWidget.call(this,t,o,i);switch(t){case"EventActionsWidget":this.viewModel.menuEnabled.syncTransform(this.viewModel.deleted,function(){return n._isMenuEnabled()})}return a},t.prototype._isMenuEnabled=function(){return e.prototype._isMenuEnabled.call(this)&&!this.viewModel.deleted.get()},t}(o.MessageEventView);t.MapEventView=i})},"Mapping/modules/Collaboration/Events/MapEvent/MapEventViewModel":function(){define(["require","exports","../MessageEvent/MessageEventViewModel","geocortex/framework/observables"],function(e,t,o,i){"use strict";var n=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.deleted=new i.Observable((!1)),t._deleteToken="",t}return __extends(t,e),t.prototype.loadEvent=function(){var t=this;e.prototype.loadEvent.call(this),this._deleteToken=this.app.event("CollaborationMapEventDeletedEvent").subscribe(this,function(e){e===t.event.id&&(t.app.event("CollaborationMapEventDeletedEvent").unsubscribe(t._deleteToken),t.onDelete())}),this.app.command("LoadCollaborationMarkupGraphics").execute(this.event)},t.prototype.unloadEvent=function(){e.prototype.unloadEvent.call(this),this.app.command("RemoveCollaborationFeatures").execute(this.event.id)},t.prototype.onDelete=function(){this.deleted.set(!0),this.clickable.set(!1)},t}(o.MessageEventViewModel);t.MapEventViewModel=n})},"Mapping/modules/Collaboration/Events/MessageEvent/MessageEventView":function(){define(["require","exports","../CardEvent/CardEventView"],function(e,t,o){"use strict";var i=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t}(o.CardEventView);t.MessageEventView=i})},"Mapping/modules/Collaboration/Events/MessageEvent/MessageEventViewModel":function(){define(["require","exports","geocortex/framework/observables","../CardEvent/CardEventViewModel"],function(e,t,o,i){"use strict";var n=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.text=new o.Observable(""),t.contentWidgetMarkup="Mapping/modules/Collaboration/Events/MessageEvent/MessageEventContentView.html",t}return __extends(t,e),t.prototype.loadEvent=function(){e.prototype.loadEvent.call(this),this.text.set(this.event.data.message)},t}(i.CardEventViewModel);t.MessageEventViewModel=n})},"Mapping/modules/Collaboration/Events/ShareMarkupEvent/ShareMarkupEventView":function(){define(["require","exports","../MapEvent/MapEventView"],function(e,t,o){"use strict";var i=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t}(o.MapEventView);t.ShareMarkupEventView=i})},"Mapping/modules/Collaboration/Events/ShareMarkupEvent/ShareMarkupEventViewModel":function(){define(["require","exports","../MapEvent/MapEventViewModel","geocortex/framework/observables"],function(e,t,o,i){"use strict";var n=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.contentWidgetMarkup="Mapping/modules/Collaboration/Events/ShareMarkupEvent/ShareMarkupEventContentView.html",t.previewIcon=new i.Observable(""),t.activeIcon="",t.deletedIcon="",t}return __extends(t,e),t.prototype.initialize=function(t){e.prototype.initialize.call(this,t),t&&t.icons&&(this.activeIcon=t.icons.active||"Resources/Images/Icons/edit-markup-inactive-24.png",this.deletedIcon=t.icons.deleted||"Resources/Images/Icons/close-24.png")},t.prototype.onClick=function(){this.deleted.get()||this.app.command("HighlightCollaborationFeatures").execute(this.event.id)},t.prototype.loadEvent=function(){e.prototype.loadEvent.call(this),this.deleted.get()?this.previewIcon.set(this.deletedIcon):this.previewIcon.set(this.activeIcon)},t.prototype.onDelete=function(){e.prototype.onDelete.call(this),this.previewIcon.set(this.deletedIcon)},t}(o.MapEventViewModel);t.ShareMarkupEventViewModel=n})},"Mapping/modules/Collaboration/Events/UserJoinedEvent/UserJoinedEventView":function(){define(["require","exports","../BannerEvent/BannerEventView"],function(e,t,o){"use strict";var i=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t}(o.BannerEventView);t.UserJoinedEventView=i})},"Mapping/modules/Collaboration/Events/UserJoinedEvent/UserJoinedEventViewModel":function(){define(["require","exports","../BannerEvent/BannerEventViewModel"],function(e,t,o){"use strict";var i=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.loadEvent=function(){e.prototype.loadEvent.call(this),this.bannerText.set(this.app.getResource(this.libraryId,"language-collaboration-event-user-joined").format(this.createdByPresentable.get(),this.roomDisplayName.get()))},t}(o.BannerEventViewModel);t.UserJoinedEventViewModel=i})},"Mapping/modules/Collaboration/Events/UserLeftEvent/UserLeftEventView":function(){define(["require","exports","../BannerEvent/BannerEventView"],function(e,t,o){"use strict";var i=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t}(o.BannerEventView);t.UserLeftEventView=i})},"Mapping/modules/Collaboration/Events/UserLeftEvent/UserLeftEventViewModel":function(){define(["require","exports","../BannerEvent/BannerEventViewModel"],function(e,t,o){"use strict";var i=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.loadEvent=function(){e.prototype.loadEvent.call(this),this.bannerText.set(this.app.getResource(this.libraryId,"language-collaboration-event-user-left").format(this.createdByPresentable.get(),this.roomDisplayName.get()))},t}(o.BannerEventViewModel);t.UserLeftEventViewModel=i})},"Mapping/modules/Collaboration/Rooms/EditRoomView":function(){define(["require","exports","geocortex/framework/ui/ViewBase","geocortex/framework/observables"],function(e,t,o,i){"use strict";var n=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.deleted=new i.Observable((!1)),t._validationActive=new i.Observable((!1)),t._ownershipBinding="",t}return __extends(t,e),t.prototype.attach=function(t){e.prototype.attach.call(this,t)},t.prototype.resolveWidget=function(t,o,i){switch(e.prototype.resolveWidget.call(this,t,o),t){case"GrantEditorWidget":var n=this.app.viewManager.createView({typeName:"geocortex.essentialsHtmlViewer.mapping.infrastructure.documents.GrantEditorView",markupResource:"Mapping/infrastructure/documents/GrantEditorView.html",libraryId:"Mapping.Infrastructure",isVisible:!0});return n&&n.attach(this.viewModel.grantEditorViewModel),n;default:return null}},t.prototype.loadRoom=function(e){var t=this;return this.viewModel.loadRoom(e).then(function(){t.viewModel.mode.equals("edit")&&(t._ownershipBinding=t.viewModel.isOwner.bind(t,t._handleOwnershipChange))})},t.prototype._handleOwnershipChange=function(e){e||(this.viewModel.isOwner&&this.viewModel.isOwner.unbind(this._ownershipBinding),this.app.viewManager.deactivateView(this),this.app.command("DisplayNotification").execute(this.app.getResource(this.libraryId,"language-collaboration-room-menu-lost-room-administrator-privileges")))},t.prototype.deactivated=function(){e.prototype.deactivated.call(this),this.viewModel.isOwner.unbind(this._ownershipBinding),this._validationActive.set(!1),this.viewModel.verificationError.set(""),this.viewModel.savePromise.set(Promise.resolve())},t.prototype.handleSaveClicked=function(e,t,o){this.viewModel.saveRoom(),this.app.viewManager.deactivateView(this)},t.prototype.handleCancelClicked=function(e,t,o){var i=this;if(this.viewModel.dirty){var n=this.app.getResource(this.libraryId,"language-collaboration-room-menu-cancel-confirm"),a=this.app.getResource(this.libraryId,"language-collaboration-room-menu-cancel-confirm-title");this.app.command("Confirm").execute(n,a,function(e){e&&i.app.viewManager.deactivateView(i)})}else this.app.viewManager.deactivateView(this)},t.prototype.handleDeleteClicked=function(e,t,o){var i=this;if(this.viewModel.roomId.get()){var n={displayName:this.viewModel.displayName.get(),active:!1},a=this.app.getResource(this.libraryId,"language-collaboration-room-menu-delete-room-confirm").format(n.displayName),r=this.app.getResource(this.libraryId,"language-collaboration-room-menu-delete-room-confirm-title").format(n.displayName);this.app.command("Confirm").execute(a,r,function(e){e&&(i.app.command("EditCollaborationRoom").execute(i.viewModel.roomId.get(),n),i.deleted.set(!0),i.app.viewManager.deactivateView(i))})}},t.prototype.delayedValidate=function(){var e=this;this._validationActive.set(!0),this.viewModel.validated.set(!1),clearTimeout(this._validationTimer),this._validationTimer=setTimeout(function(){return e.validate()},500)},t.prototype.validate=function(){var e=this;if(this._validationActive.get()){if(this.viewModel.validated.set(!1),this.viewModel.verificationError.set(""),!this.viewModel.displayName.get().trim())return void this.viewModel.verificationError.set(this.app.getResource(this.libraryId,"language-collaboration-room-menu-edit-room-no-name"));if(this.viewModel.mode.equals("create")||!this.viewModel.displayName.equals(this.viewModel.originalName))return void this.app.command("VerifyRoomNameUnique").execute(this.viewModel.displayName.get(),function(t){t.unique?e.viewModel.validated.set(!0):e.viewModel.verificationError.set(e.app.getResource(e.libraryId,"language-collaboration-room-menu-edit-room-existing-name"))});this.viewModel.validated.set(!0)}},t}(o.ViewBase);t.EditRoomView=n})},"Mapping/modules/Collaboration/Rooms/EditRoomViewModel":function(){define(["require","exports","geocortex/framework/ui/ViewModelBase","geocortex/framework/observables","geocortex/infrastructure/documents/GrantEditorViewModel","geocortex/infrastructure/symbology/SymbolColor","geocortex/infrastructure/ColorUtils"],function(e,t,o,i,n,a,r){"use strict";var s=function(e){function t(t,o){var r=e.call(this,t,o)||this;return r.roomId=new i.Observable(""),r.mode=new i.Observable("create"),r.displayName=new i.Observable(""),r.isOwner=new i.Observable((!1)),r.verificationError=new i.Observable(""),r.validated=new i.Observable((!1)),r.savePromise=new i.Observable(Promise.resolve()),r.originalName="",r.dirty=!1,r.color=new i.Observable(new a.SymbolColor("#FFFFFF")),r.colorPicker={color:r.color},r.grantEditorViewModel=new n.GrantEditorViewModel(t,"Mapping.Infrastructure"),r.grantEditorViewModel.initialize({editOwnership:!0}),r.displayName.bind(r,r.setDirty),r.color.bind(r,r.setDirty),r.grantEditorViewModel.monikers.bind(r,r.setDirty),r}return __extends(t,e),t.prototype.setDirty=function(){this.dirty=!0},t.prototype.loadRoom=function(e){var t=this;return e?(this.roomId.set(e.id),this.originalName=e.displayName.get(),this.mode.set("edit"),this.displayName.set(e.displayName.get()),this.color.set(new a.SymbolColor(e.color.get())),this.isOwner=e.isOwner,this.validated.set(!0)):(this.roomId.set(""),this.mode.set("create"),this.displayName.set(""),this.color.set(r.generateRandomColor()),this.validated.set(!1)),this.refresh().then(function(){t.dirty=!1})},t.prototype.saveRoom=function(){var e=this;this.roomId.get()?(this.app.command("EditCollaborationRoom").execute(this.roomId.get(),{displayName:this.displayName.get(),active:!0,color:this.color.get().toHex()}),this.savePromise.set(this._saveRoomGrants(this.roomId.get()))):this.app.command("CreateCollaborationRoom").execute({displayName:this.displayName.get(),active:!0,color:this.color.get().toHex()},function(t){var o=e.grantEditorViewModel.grants;e.savePromise.set(e.grantEditorViewModel.loadById(t.id).then(function(){e.grantEditorViewModel.document.grants=o}).then(function(){e._saveRoomGrants(t.id)})),e.app.command("AutoJoinCollaborationRoom").execute(t.id)})},t.prototype._saveRoomGrants=function(e){var t=this;return Promise.resolve(this.app.site.documentStore.updateById(e,this.grantEditorViewModel.document))["catch"](function(e){t.app.trace.error("Error updating room grants: {0}".format(e.message),e)})},t.prototype.refresh=function(){return this.roomId.get()?this.grantEditorViewModel.loadById(this.roomId.get()):Promise.resolve(this.grantEditorViewModel.reset())},t}(o.ViewModelBase);t.EditRoomViewModel=s})},"Mapping/modules/Collaboration/Rooms/Room":function(){define(["require","exports","geocortex/framework/observables","geocortex/infrastructure/FormatUtils","geocortex/infrastructure/DateFormat"],function(e,t,o,i,n){"use strict";var a=function(){function e(e){this.displayName=new o.Observable(""),this.color=new o.Observable("#333333"),this.members=new o.Observable(0),this.memberNames=new o.ObservableCollection,this.joined=new o.Observable((!1)),this.selected=new o.Observable((!1)),this.isOwner=new o.Observable((!1)),this.isContributor=!1,this.createdPresentable=new o.Observable(""),this.isNew=new o.Observable((!1)),this.id=e.id,this.displayName.set(e.displayName),this.active=e.active,this.isGlobal=e.global,this.color.set(e.color),this.isOwner.set(e.isOwner),this.isContributor=e.isContributor,this.created=e.created,this.createdPresentable.set(i.formatDate(new Date(Date.parse(this.created)),n.DateFormat.DEFAULT)),this.createdBy=e.createdBy,this.selected.sync(this.joined)}return e.prototype.equals=function(e){return this.id===e.id&&this.displayName.get()===e.displayName&&this.color.get()===e.color&&this.isGlobal===e.global&&this.active===e.active&&this.isContributor===e.isContributor&&this.isOwner.get()===e.isOwner&&this.created===e.created&&this.createdBy===e.createdBy},e.prototype.toRestObject=function(){return{id:this.id,displayName:this.displayName.get(),color:this.color.get(),global:this.isGlobal,active:this.active,isContributor:this.isContributor,isOwner:this.isOwner.get(),created:this.created,createdBy:this.createdBy}},e}();t.Room=a})},"Mapping/modules/Collaboration/Rooms/RoomDetailsView":function(){define(["require","exports","geocortex/framework/ui/ViewBase","./EditRoomViewModel"],function(e,t,o,i){"use strict";var n=function(e){function t(t,o){var n=e.call(this,t,o)||this;n.editRoomMenu=n.app.viewManager.createView({title:n.app.getResource(n.libraryId,"language-collaboration-room-menu-edit-room-title"),typeName:"geocortex.essentialsHtmlViewer.mapping.modules.collaboration.EditRoomView",markupResource:"Mapping/modules/Collaboration/Rooms/EditRoomView.html",isVisible:!1,libraryId:n.libraryId,regionName:n.app.configuration.mobileMode?"ModalWindowRegion":"CollaborationContainerRegion"});var a=new i.EditRoomViewModel(n.app,n.libraryId);return n.editRoomMenu.attach(a),n.editRoomMenu.deleted.bind(n,function(e){e&&n.exit()}),n}return __extends(t,e),t.prototype.attach=function(t){e.prototype.attach.call(this,t)},t.prototype.exit=function(){this.app.viewManager.deactivateView(this)},t.prototype.handleEditClicked=function(e,t,o){var i=this;this.editRoomMenu.loadRoom(this.viewModel.room.get()).then(function(){return i.app.viewManager.activateView(i.editRoomMenu)})},t.prototype.handleCloseClicked=function(e,t,o){this.exit()},t}(o.ViewBase);t.RoomDetailsView=n})},"Mapping/modules/Collaboration/Rooms/RoomDetailsViewModel":function(){define(["require","exports","geocortex/framework/ui/ViewModelBase","geocortex/framework/observables"],function(e,t,o,i){"use strict";var n=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.readOnly=new i.Observable((!1)),t.canEdit=new i.Observable((!1)),t.room=new i.Observable(null),t}return __extends(t,e),t.prototype.loadRoom=function(e){var t=this;this.canEdit.removeSync(),this.room.set(e),this.canEdit.syncTransform(e.isOwner,function(e){return!t.readOnly.get()&&e})},t}(o.ViewModelBase);t.RoomDetailsViewModel=n})},"Mapping/modules/Collaboration/Views/BaseCollaborationView":function(){define(["require","exports","geocortex/framework/ui/ViewBase","geocortex/framework/utils/ArrayUtils"],function(e,t,o,i){"use strict";var n=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._currentScroll=0,t}return __extends(t,e),t.prototype.handleSignInClick=function(e,t,o){this.app.command("SignIn").execute(null)},t.prototype.resolveWidget=function(e,t,o){switch(e){case"EventWidget":var n=t,a=i.firstOrDefault(this.viewModel.eventTypes,function(e){return e.name===n.event.type}).widget,r=this.app.viewManager.createView({typeName:a.typeName,markupResource:a.markup,isVisible:!0,libraryId:a.libraryId});return n.initialize(a.configuration),n.loadEvent(),r.attach(n),r;default:return null}},t}(o.ViewBase);t.BaseCollaborationView=n})},"Mapping/modules/Collaboration/Views/BaseCollaborationViewModel":function(){define(["require","exports","geocortex/framework/ui/ViewModelBase","geocortex/framework/observables","../RestHandler","geocortex/framework/config/WidgetConfig","geocortex/framework/utils/ArrayUtils","../GraphicsManager","geocortex/infrastructure/webSocket/WebSocketConnection"],function(e,t,o,i,n,a,r,s,l){"use strict";var c=4.07,d=function(e){function t(t,o){var n=e.call(this,t,o)||this;return n.eventTypes=[],n.rooms=new i.ObservableCollection([]),n.events=new i.ObservableCollection([]),n.selectedRooms=new i.ObservableCollection([]),n.active=new i.Observable((!1)),n.signedIn=new i.Observable((!1)),n.connected=new i.Observable((!1)),n.supported=new i.Observable((!1)),n.enabled=new i.Observable((!1)),n.defaultEventType=null,n._config=null,n._restHandler=null,n._graphicsManager=null,n._applicationScope=null,n}return __extends(t,e),t.prototype.initialize=function(t){var o=this;e.prototype.initialize.call(this,t),this._config=t,this.enabled.set(t.enabled),this.app.event("SiteInitializedEvent").once(this,function(){o._siteInitialized(t)})},t.prototype.selectRooms=function(e){},t.prototype._close=function(e){this.events.get().forEach(function(e){return e.unloadEvent()}),this.events.clear(),this.app.command("ClearCollaborationFeatures").execute()},t.prototype._siteInitialized=function(e){var t=this;if(this.supported.set(this.app.site.getEssentialsVersion()>=c),this.enabled.get()){if(this.supported.get()||this.app.trace.warning("Warning: Your version of essentials is older than 4.7, Collaboration cannot function."),this.active.set(this.supported.get()&&this.enabled.get()),l.WebSocketConnection.hasBrowserSupport()||(this.active.set(!1),this.app.trace.warning("Warning: browser does not support WebSocket. Collaboration cannot function.")),!this.supported.get())return void this.app.trace.warning("Failed to initialize Collaboration: Geocortex Essentials version 4.7 or higher is requred for Collaboration to function.");var o=n.RestHandler.getCollaborationServiceUrl(this.app);if(!e.restEndpoint&&!o)throw this.active.set(!1),new Error("Failed to initialize: no suitable rest endpoint found.");if(this._restHandler=new n.RestHandler(this.app,e.restEndpoint||o),e.applicationId?this._applicationScope=e.applicationId:this._applicationScope=this.app.site.id,this._graphicsManager=new s.GraphicsManager(this.app,this._restHandler),e.icons.photoIcon&&e.icons.photoIcon.iconUrl){var i=new esri.symbol.PictureMarkerSymbol(e.icons.photoIcon.iconUrl,e.icons.photoIcon.width||0,e.icons.photoIcon.height||0);i.setOffset(e.icons.photoIcon.offsetX||0,e.icons.photoIcon.offsetY||0),this._graphicsManager.postedImageSymbol=i}if(!e.eventTypes||!Array.isArray(e.eventTypes))throw this.active.set(!1),new Error("No Event Types defined in configuration, Collaboration View Model can't initialize.");e.eventTypes.forEach(function(o){if(o.widgetId){var i=void 0;if(!e.eventWidgets||!Array.isArray(e.eventWidgets))throw new Error("Event Widget: "+o.widgetId+" not defined in configuration, Collaboration View Model can't initialize.");var n=r.firstOrDefault(e.eventWidgets,function(e){return o.widgetId===e.id});i=new a.WidgetConfig(n.id,n.libraryId),i.typeName=n.type||"geocortex.framework.ui.ViewBase",i.viewModelType=n.viewModelType||"geocortex.framework.ui.ViewModelBase",i.markup=n.markup||null,i.configuration=n.configuration||null;var s={name:o.name,widget:i,visible:o.visible,automatic:o.automatic};t.eventTypes.push(s),o["default"]&&(t.defaultEventType=s)}else t.app.trace.warning("No widgetId property found for event name: {0}".format(o.name||"no name defined"))}),this.app.site.principal.isAuthenticated?this.signedIn.set(!0):this.active.set(!1),this.active.get()&&this.app.event("CollaborationInitializedEvent").publish()}},t.prototype._addEvents=function(e,t){var o=this;void 0===t&&(t=!1);var i=[],n=[];e.forEach(function(e){var t=o._findRoom(e.roomId);if(t){var a=r.firstOrDefault(o.eventTypes,function(t){return t.name===e.type}).widget,s=o.app.instantiateFrameworkObject(a.viewModelType,a.libraryId);s.event=e,s.room={id:t.id,displayName:t.displayName.get(),color:t.color.get(),active:t.active,global:t.isGlobal,isOwner:t.isOwner.get(),isContributor:t.isContributor,created:t.created,createdBy:t.createdBy};var l=o._findEvent(s.event.id);l?n.push(s):i.push(s)}}),t?this.events.addItems(i):this.events.insertItems(0,i.reverse()),n.forEach(function(e){var t=o._findEvent(e.event.id);t.unloadEvent();var i=o.events.indexOf(t);i>-1&&(o.events.removeAt(i),o.events.insertItem(i,e))})},t.prototype._findRoom=function(e){return r.firstOrDefault(this.rooms.get(),function(t){return t.id===e})},t.prototype._findEvent=function(e){return r.firstOrDefault(this.events.get(),function(t){return t.event.id===e})},t}(o.ViewModelBase);t.BaseCollaborationViewModel=d})},"Mapping/modules/Collaboration/Views/AfterAction/AfterActionSelectorView":function(){define(["require","exports","../Collaboration/CollaborationSelectorView"],function(e,t,o){"use strict";var i=function(e){function t(t,o){var i=e.call(this,t,o)||this;return i.roomDetailsMenu.viewModel.readOnly.set(!0),i}return __extends(t,e),t.prototype.handleCreateClicked=function(e,t,o){},t}(o.CollaborationSelectorView);t.AfterActionSelectorView=i})},"Mapping/modules/Collaboration/Views/AfterAction/AfterActionView":function(){define(["require","exports","geocortex/framework-ui/Selector/SelectorViewModel","../BaseCollaborationView"],function(e,t,o,i){"use strict";var n=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.resolveWidget=function(t,i,n){var a=this,r=e.prototype.resolveWidget.call(this,t,i,n);if(r)return r;switch(t){case"Selector":return this._selectorView=this.app.viewManager.createView({viewId:"AfterActionSelectorView",typeName:"geocortex.essentialsHtmlViewer.mapping.modules.collaboration.AfterActionSelectorView",markupResource:"Mapping/modules/Collaboration/Views/AfterAction/AfterActionSelectorView.html",isVisible:!0,libraryId:this.libraryId}),this.selector=new o.SelectorViewModel(this.app,this.libraryId,(!1),(!1)),this.selector.singleSelect=!1,this.selector.setCollection(this.viewModel.rooms,"displayName","Mapping/modules/Collaboration/Views/Collaboration/CollaborationSelectorItemTemplate.html",this.libraryId),this.selector.selectorText.set(this.app.getResource(this.libraryId,"language-after-action-select-label")||this.app.getResource(this.libraryId,"language-integration-selector-text")),this.selector.noItemsText.set(this.app.getResource(this.libraryId,"language-collaboration-no-rooms")),this.selector.openState.bind(this,function(e){e||a.viewModel.selectRooms(a.selector.getSelectedItems().map(function(e){return e.item}))}),this._selectorView.attach(this.selector),this._selectorView;default:return null}},t}(i.BaseCollaborationView);t.AfterActionView=n})},"Mapping/modules/Collaboration/Views/AfterAction/AfterActionViewModel":function(){define(["require","exports","../BaseCollaborationViewModel","../../Rooms/Room"],function(e,t,o,i){"use strict";var n=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.initialize=function(t){e.prototype.initialize.call(this,t),this.app.command("OpenAfterActionPlayback").register(this,this._executeOpenAfterAction,this._canExecuteOpenAfterAction)},t.prototype._siteInitialized=function(t){var o=this;e.prototype._siteInitialized.call(this,t),this.active.get()&&(this._graphicsManager.readOnly=!0,this.app.event("MapTimeExtentChangedEvent").subscribe(this,this._handleMapTimeExtentChangedEvent),this.signedIn.get()&&this._fetchAllRooms().then(function(){o.connected.set(!0)}))},t.prototype.selectRooms=function(e){var t=this;e.sort(function(e,t){return e.id.localeCompare(t.id)});var o=this.selectedRooms.get().filter(function(t){return e.indexOf(t)===-1}).map(function(e){return e.id}),i=e.filter(function(e){return t.selectedRooms.indexOf(e)===-1}).map(function(e){return e.id});return o.length||i.length?(this.app.command("ClearCollaborationDrawings").execute(),this.selectedRooms.set(e),Promise.resolve(this._close(o)).then(function(){return t._graphicsManager.buildRoomMarkupState(i)}).then(function(){return t._open(e)}).caught(function(e){t.app.trace.error("Error during room selection: {0}.".format(e.message),e)})):Promise.resolve()},t.prototype._open=function(e){var t=this;if(!e.length)return Promise.resolve();var o=e.map(function(e){return e.id}),i={rooms:o,pageSize:1e3,activeRoomsOnly:!1,eventTypes:this.eventTypes.filter(function(e){return e.visible}).map(function(e){return e.name})};return this._restHandler.query(i).then(function(e){t._addEvents(e.events)})},t.prototype._fetchAllRooms=function(){var e=this,t={applicationId:this._applicationScope,activeRoomsOnly:!1};return this._restHandler.getRooms(t).then(function(t){var o=[];if(e.rooms.get().forEach(function(i,n){t.map(function(e){return e.id}).indexOf(i.id)<0&&(e.rooms.removeAt(n),e.selectedRooms.get().map(function(e){return e.id}).indexOf(i.id)>-1&&o.push(i.id))}),t.forEach(function(t){var o=new i.Room(t);e.rooms.addItem(o)}),o.length>0){var n=e.selectedRooms.get().filter(function(e){return!o.some(function(t){return e.id===t})});return Promise.resolve(e.selectRooms(n))}e.selectedRooms.pulse()})["catch"](function(t){e.app.trace.error("Failed to retrieve room list from REST endpoint: {0}".format(t.message),t)})},t.prototype._handleMapTimeExtentChangedEvent=function(e){var t=this,o=this.selectedRooms.get().map(function(e){return e.id});if(o.length){var i={rooms:this.selectedRooms.get().map(function(e){return e.id}),dateRange:{start:e.startTime,end:e.endTime},eventTypes:this.eventTypes.filter(function(e){return e.visible}).map(function(e){return e.name}),pageSize:1e3};this._restHandler.query(i).then(function(e){t.app.command("ClearCollaborationFeatures").execute(),t.events.get().forEach(function(e){return e.unloadEvent()}),t.events.clear(),t._addEvents(e.events)})}},t.prototype._executeOpenAfterAction=function(){this.app.command("ActivateView").execute("AfterActionView")},t.prototype._canExecuteOpenAfterAction=function(){return this.enabled.get()},t}(o.BaseCollaborationViewModel);t.AfterActionViewModel=n})},"Mapping/modules/Collaboration/Views/Collaboration/CollaborationMarkupStyleSelectorView":function(){define(["require","exports","geocortex/infrastructure/tools/DrawMode","geocortex/framework/ui/ViewBase","geocortex/infrastructure/symbology/SymbolType"],function(e,t,o,i,n){"use strict";var a=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._markupManager=null,t}return __extends(t,e),t.prototype.attach=function(t){e.prototype.attach.call(this,t)},t.prototype.activated=function(){var t=this;e.prototype.activated.call(this);var i=this.viewModel.getMarkupManager().currentSymbol,a=this.viewModel.getMarkupManager().drawingToolSelectedType.get();switch(a){case o.DrawMode.POINT:this.symbologySettingsWidget.setFeatureType(n.SymbolType.POINT);break;case o.DrawMode.FREEHAND_POLYLINE:case o.DrawMode.LINE:case o.DrawMode.POLYLINE:this.symbologySettingsWidget.setFeatureType(n.SymbolType.POLYLINE);break;case o.DrawMode.POLYGON:case o.DrawMode.FREEHAND_POLYGON:case o.DrawMode.CIRCLE:case o.DrawMode.ELLIPSE:case o.DrawMode.RECTANGLE:case o.DrawMode.EXTENT:this.symbologySettingsWidget.setFeatureType(n.SymbolType.POLYGON);break;default:throw new Error("Symbol for draw mode {0} not supported by the picker.".format(a))}var r=this.app.event("ViewActivatedEvent").subscribe(this,function(e){e===t&&(t.symbologySettingsWidget.setFromSymbol(i),t.app.event("ViewActivatedEvent").unsubscribe(r));
})},t.prototype.closeClicked=function(){this.app.viewManager.deactivateView(this)},t.prototype.applyClicked=function(){this.viewModel.getMarkupManager().setCurrentSymbol(this.symbologySettingsWidget.getSymbol()),this.app.viewManager.deactivateView(this)},t}(i.ViewBase);t.CollaborationMarkupStyleSelectorView=a})},"Mapping/modules/Collaboration/Views/Collaboration/CollaborationSelectorView":function(){define(["require","exports","geocortex/framework-ui/Selector/SelectorView","../../Rooms/RoomDetailsViewModel","../../Rooms/EditRoomViewModel"],function(e,t,o,i,n){"use strict";var a=function(e){function t(t,o){var a=e.call(this,t,o)||this,r=a.app.configuration.mobileMode?"ModalWindowRegion":"CollaborationContainerRegion";a.roomDetailsMenu=a.app.viewManager.createView({title:a.app.getResource(a.libraryId,"language-collaboration-room-details-menu-title"),typeName:"geocortex.essentialsHtmlViewer.mapping.modules.collaboration.RoomDetailsView",markupResource:"Mapping/modules/Collaboration/Rooms/RoomDetailsView.html",isVisible:!1,libraryId:a.libraryId,regionName:r});var s=new i.RoomDetailsViewModel(a.app,a.libraryId);a.roomDetailsMenu.attach(s),a.createRoomMenu=a.app.viewManager.createView({title:a.app.getResource(a.libraryId,"language-collaboration-room-menu-create-room-title"),typeName:"geocortex.essentialsHtmlViewer.mapping.modules.collaboration.EditRoomView",markupResource:"Mapping/modules/Collaboration/Rooms/EditRoomView.html",isVisible:!1,libraryId:a.libraryId,regionName:r});var l=new n.EditRoomViewModel(a.app,a.libraryId);return a.createRoomMenu.attach(l),a}return __extends(t,e),t.prototype.handleShowDetailsClicked=function(e,t,o){this.roomDetailsMenu.viewModel.loadRoom(o),this.app.viewManager.activateView(this.roomDetailsMenu)},t.prototype.handleCreateClicked=function(e,t,o){var i=this;this.createRoomMenu.loadRoom().then(function(){return i.app.viewManager.activateView(i.createRoomMenu)})},t}(o.SelectorView);t.CollaborationSelectorView=a})},"Mapping/modules/Collaboration/Views/Collaboration/CollaborationView":function(){define(["require","exports","geocortex/framework/observables","geocortex/framework-ui/Selector/SelectorViewModel","../BaseCollaborationView"],function(e,t,o,i,n){"use strict";var a=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._unread=0,t._defaultSelectorText=t.app.getResource(t.libraryId,"language-collaboration-select-label")||t.app.getResource(t.libraryId,"language-integration-selector-text"),t._roomTokens={},t}return __extends(t,e),t.prototype.attach=function(t){t&&(e.prototype.attach.call(this,t),this.initialize())},t.prototype.initialize=function(){this.registerCommands(),this.registerEvents()},t.prototype.registerCommands=function(){},t.prototype.registerEvents=function(){var e=this;this.viewModel.events.bind(this,this._processNewEvents),this.viewModel.rooms.bind(this,this._processNewRooms),this.app.event("CollaborationImageLoadedEvent").subscribe(this,this._scrollToBottom),this.eventScroll.onscroll=function(){return e._handleEventFeedScroll()}},t.prototype._processNewEvents=function(e){var t=this,o=!this._scrollToBottom();if(o&&!this.viewModel.isLoadingEvents.get()&&["append","insert","set"].indexOf(e.type)!==-1){var i=this.viewModel.events.getRange(e.rangeStart,e.rangeEnd).filter(function(e){return!t.viewModel.eventTypes.some(function(t){return t.name===e.event.type&&t.automatic})&&!e.event.isOwner}).length;i&&(this._unread+=i,this._unread<1e4?1===this._unread?this.viewModel.unreadEventsMessage.set(this.app.getResource(this.libraryId,"language-collaboration-unread-events-notification-one-post")):this.viewModel.unreadEventsMessage.set(this.app.getResource(this.libraryId,"language-collaboration-unread-events-notification-numbered").format(this._unread)):this.viewModel.unreadEventsMessage.set(this.app.getResource(this.libraryId,"language-collaboration-unread-events-notification")))}},t.prototype._processNewRooms=function(e){var t=this,o=this.viewModel.rooms.getRange(e.rangeStart,e.rangeEnd);["append","insert","set"].indexOf(e.type)!==-1&&(o.forEach(function(e){t._roomTokens[e.id]&&e.selected.unbind(t._roomTokens[e.id]),t._roomTokens[e.id]=e.selected.bind(t,t._handleSelectionChange)}),o.some(function(e){return e.isNew.get()&&!e.isOwner.get()})&&(this.viewModel.hasNewRooms.set(!0),this.viewModel.newRooms+=1,1===this.viewModel.newRooms?this.viewModel.numberNewRooms.set(this.app.getResource(this.libraryId,"language-collaboration-one-new-room-notification")):this.viewModel.numberNewRooms.set(this.app.getResource(this.libraryId,"language-collaboration-new-room-notification").format(this.viewModel.newRooms.toString()))))},t.prototype.resolveWidget=function(t,n,a){var r=this,s=e.prototype.resolveWidget.call(this,t,n,a);if(s)return s;switch(t){case"Selector":return this._selectorView=this.app.viewManager.createView({viewId:"CollaborationSelectorView",typeName:"geocortex.essentialsHtmlViewer.mapping.modules.collaboration.CollaborationSelectorView",markupResource:"Mapping/modules/Collaboration/Views/Collaboration/CollaborationSelectorView.html",isVisible:!0,libraryId:this.libraryId}),this.selector=new i.SelectorViewModel(this.app,this.libraryId,(!1),(!1)),this.selector.singleSelect=!1,this.selector.setCollection(this.viewModel.rooms,"displayName","Mapping/modules/Collaboration/Views/Collaboration/CollaborationSelectorItemTemplate.html",this.libraryId),this.selector.selectorText.set(this._defaultSelectorText),this.selector.noItemsText.set(this.app.getResource(this.libraryId,"language-collaboration-no-rooms")),this.selector.openState.bind(this,function(e){e?r.minimizeControls(!0):(r.selector.items.get().forEach(function(e){return e.item.isNew.set(!1)}),r.viewModel.hasNewRooms.set(!1),r.viewModel.newRooms=0,r.viewModel.numberNewRooms.set(""))}),this._selectorView.attach(this.selector),this._selectorView;case"FilePickerWidget":var l=this.app.viewManager.createView({typeName:"geocortex.essentialsHtmlViewer.mapping.infrastructure.ui.components.Forms.FilePickerFormItemView",markupResource:"Mapping/modules/Collaboration/Views/Collaboration/CollaborationFilePicker.html",isVisible:!0,libraryId:"Mapping.Infrastructure"});return this.viewModel.filePickerWidgetModel.acceptFileTypes=new o.Observable("image/*"),this.viewModel.filePickerWidgetModel.allowMultiple=new o.Observable((!1)),this.viewModel.filePickerWidgetModel.toolTip=new o.Observable(this.app.getResource(this.libraryId,"language-collaboration-event-file-upload-tooltip")),l.attach(this.viewModel.filePickerWidgetModel),l;case"ToolFlyoutWidget":return this._toolSelectorWidget=this.app.viewManager.createView({typeName:"geocortex.framework.ui.ViewBase",markupResource:"Mapping/modules/Collaboration/Views/Collaboration/CollaborationDrawingToolFlyoutView.html",isVisible:!0,libraryId:this.libraryId}),this._toolSelectorWidget.parentView=this,this._toolSelectorWidget.attach(this.viewModel),this._toolSelectorWidget;default:return null}},t.prototype.minimizeControls=function(e){this.app.configuration.mobileMode&&this.viewModel.controlsMinimized.set(e)},t.prototype._handleSelectionChange=function(e){var t=this;clearTimeout(this._selectTimer),this._selectTimer=setTimeout(function(){t.viewModel.selectRooms(t.selector.items.get().map(function(e){return e.item}).filter(function(e){return e.selected.get()}))},e?1e3:250)},t.prototype._calculateScroll=function(){return this.eventScroll.offsetHeight+this.eventScroll.scrollTop-this.eventScroll.scrollHeight},t.prototype._scrollToBottom=function(){return this._currentScroll>=-5&&(this.eventScroll.scrollTop=this.eventScroll.scrollHeight,!0)},t.prototype._handleEventFeedScroll=function(){if(!this.viewModel.isLoadingEvents.get()&&!this.viewModel.controlsMinimized.get()&&this.viewModel.postType.equals("none")&&!this.viewModel.sendEnabled.get()){var e=this._calculateScroll();e>this._currentScroll&&e-this._currentScroll>10?this.minimizeControls(!0):e<this._currentScroll&&this._currentScroll-e>20&&this.minimizeControls(!0)}this._currentScroll=this._calculateScroll(),this._currentScroll>=-50&&(this.viewModel.unreadEventsMessage.set(""),this._unread=0)},t.prototype.handleKeyUp=function(e,t,o){var i=e.which?e.which:e.keyCode;i!==dojo.keys.ENTER||e.altKey||e.shiftKey||!this.viewModel.sendEnabled.get()||this._sendMessage()},t.prototype.handleSendPressed=function(e,t,o){this._sendMessage()},t.prototype._sendMessage=function(){var e=this;this.viewModel.sendEnabled.get()&&this.viewModel.sendEvent().then(function(){e.viewModel.entryText.set(null),e.viewModel.postType.set("none")})},t.prototype.handleInput=function(e,t,o){t.scrollHeight>t.clientHeight?this.viewModel.moveClearButton.set(!0):this.viewModel.moveClearButton.set(!1)},t.prototype.handlePostingRoomSelector=function(e,t,o){e.stopPropagation()},t.prototype.handleEventFeedClick=function(e,t,o){this.selector.openState.get()&&this.selector.openState.set(!1)},t.prototype.handleNewRoomsNotificationClick=function(e,t,o){this.selector.openState.set(!0)},t.prototype.handleNotificationClick=function(e,t,o){this.viewModel.unreadEventsMessage.set(""),this._unread=0,this.eventScroll.scrollTop=this.eventScroll.scrollHeight},t.prototype.handleTextBarClick=function(e,t,o){this.minimizeControls(!1)},t.prototype.handleAttachmentChange=function(e,t,o){var i=this;return this.viewModel.toolReadyToSend.get()&&!this.viewModel.postType.equals("none")?(this.viewModel.postType.lock(),new Promise(function(e,t){i.app.command("Confirm").execute(i.app.getResource(i.libraryId,"language-collaboration-clear-confirm-message"),i.app.getResource(i.libraryId,"language-collaboration-clear-confirm-title"),function(t){if(t){switch(i.viewModel.postType.get()){case"markup":i.app.command("ClearCollaborationDrawings").canExecute()&&i.app.command("ClearCollaborationDrawings").execute();break;case"image":i.viewModel.filePickerWidgetModel.clear(),i.viewModel.resetFilePicker()}i.viewModel.postType.set("none"),e(!0)}e(!1)})}).then(function(e){i.viewModel.postType.unlock(),e?i.viewModel.postType.equals(t.value)?(i.viewModel.postType.set("none"),t.checked=!1):(i.viewModel.postType.set(t.value),t.checked=!0):t.checked=i.viewModel.postType.equals(t.value)}),!1):(this.viewModel.postType.equals(t.value)&&this.viewModel.postType.set("none"),!0)},t.prototype.handleGetHistoricalClicked=function(e,t,o){this.viewModel.getOlderEntries()},t.prototype.handleClearRoomNotification=function(e,t,o){this.viewModel.hasNewRooms.set(!1),this.viewModel.numberNewRooms.set("")},t.prototype.handleClearMessageNotification=function(e,t,o){this.viewModel.unreadEventsMessage.set("")},t.prototype.handleClearClicked=function(e,t,o){var i=this;this.viewModel.toolReadyToSend.get()?this.app.command("Confirm").execute(this.app.getResource(this.libraryId,"language-collaboration-clear-confirm-message"),this.app.getResource(this.libraryId,"language-collaboration-clear-confirm-title"),function(e){if(e){switch(i.viewModel.postType.get()){case"markup":i.app.command("ClearCollaborationDrawings").canExecute()&&i.app.command("ClearCollaborationDrawings").execute();break;case"image":i.viewModel.filePickerWidgetModel.clear(),i.viewModel.resetFilePicker()}i.viewModel.postType.set("none")}}):this.viewModel.postType.set("none")},t.prototype.handleManuallyLocateClick=function(){this.viewModel.toolActive.get()?this.app.command("ClearActiveTool").execute():this.viewModel.activateImageLocator()},t.prototype.handleToolbarItemClick=function(e,t,o){this.viewModel.toolActive.get()?this.app.command("ClearActiveTool").execute():this.viewModel.activateDrawingTool(o)},t.prototype.handleChangeToolFlyout=function(e,t,o){this.app.configuration.mobileMode?(this.app.command("ClearActiveTool").execute(),this.viewModel.selectDrawingTool(o)):this.viewModel.activateDrawingTool(o)},t.prototype.handleOpenToolFlyout=function(e,t,o){var i=this;if(this.viewModel.flyoutVisible.get())this.viewModel.flyoutVisible.set(!1),this.app.event("FlyoutDeactivated").publish(this);else{this.viewModel.flyoutVisible.set(!0),this.app.event("FlyoutActivated").publish(this);var n={view:this._toolSelectorWidget,onOtherInteracted:function(e){e.srcElement!==t&&(i.viewModel.flyoutVisible.set(!1),i.app.event("FlyoutDeactivated").publish(i))}};this.app.command("TapToDismiss").execute(n)}},t.prototype.handleDrawSymbologyClicked=function(e,t,o){this.app.command("ActivateView").execute("CollaborationMarkupStyleSelectorView")},t}(n.BaseCollaborationView);t.CollaborationView=a})},"Mapping/modules/Collaboration/Views/Collaboration/CollaborationViewModel":function(){define(["require","exports","geocortex/framework/observables","../../Rooms/Room","geocortex/forms/items/FilePickerFormItem","../../MarkupManager","geocortex/infrastructure/webSocket/WebSocketConnection","geocortex/essentials/utilities/ExifUtilities","geocortex/essentials/documents/DocumentConstants","geocortex/essentials/documents/BatchRequestBuilder","../BaseCollaborationViewModel","geocortex/essentials/utilities/UrlUtilities","geocortex/framework-ui/LazyObservable"],function(e,t,o,i,n,a,r,s,l,c,d,u,p){"use strict";var h="collaboration/ws",m=function(e){function t(t,i){var a=e.call(this,t,i)||this;return a.entryText=new o.Observable(null),a.contributableRooms=new o.ObservableCollection([]),a.joinedCopyTargets=new o.ObservableCollection([]),a.unjoinedCopyTargets=new o.ObservableCollection([]),a.selectedCopyRoom=new o.Observable(null),a.singleRoomSelected=new o.Observable((!1)),a.firstRoom=new o.Observable(""),a.postingRoom=new o.Observable(null),a.postingRoomColor=new o.Observable("#CCCCCC"),a.postType=new v("none"),a.textPost=new o.Observable((!0)),a.typeCaption=new o.Observable(a.app.getResource(a.libraryId,"language-collaboration-event-type-caption-message")),a.hasMoreEvents=new o.Observable((!1)),a.symbologyToolsAvailable=new o.Observable((!1)),a.drawingToolsVisible=new o.Observable((!1)),a.drawingTools=new o.ObservableCollection,a.selectedDrawingTool=new o.Observable,a.tools=new o.ObservableCollection,a.flyoutVisible=new o.Observable((!1)),a.uploadToolsVisible=new o.Observable((!1)),a.textEntryPlaceholder=new o.Observable(a.app.getResource(a.libraryId,"language-collaboration-chat-entry-placeholder")),a.toolReadyToSend=new p.LazyObservable((!1)),a.toolActive=new o.Observable((!1)),a.filePickerWidgetModel=new n.FilePickerFormItem(null),a.sendEnabled=new o.Observable((!1)),a.characterLimit=new o.Observable,a.clearEnabled=new o.Observable((!1)),a.moveClearButton=new o.Observable((!1)),a.postTextColor=new o.Observable("#000000"),a.controlsMinimized=new o.Observable((!1)),a.autoJoinList=new o.ObservableCollection,a.unreadEventsMessage=new o.Observable(""),a.hasNewRooms=new o.Observable((!1)),a.numberNewRooms=new o.Observable(""),a.canManuallyLocate=new o.Observable((!1)),a.isLoadingEvents=new o.Observable((!1)),a.isSending=new o.Observable((!1)),a.newRooms=0,a._markupManager=null,a._webSocket=null,a._reconnectionState=null,a}return __extends(t,e),t.prototype.initialize=function(t){e.prototype.initialize.call(this,t),this.app.command("OpenCollaboration").register(this,this._executeOpenCollaboration,this._canExecuteOpenCollaboration)},t.prototype._siteInitialized=function(t){var o=this;if(e.prototype._siteInitialized.call(this,t),this.active.get()){if(this.app.event("WebSocketConnectedEvent").subscribe(this,this._handleWebSocketConnectionChanged),this.app.event("WebSocketDisconnectedEvent").subscribe(this,this._handleWebSocketConnectionChanged),this._webSocket=new r.WebSocketConnection(this.app),this._webSocket.isConnected.bind(this,function(e){e?o.app.event("WebSocketConnectedEvent").publish(o._webSocket):o.app.event("WebSocketDisconnectedEvent").publish(o._webSocket)}),this._markupManager=new a.MarkupManager(this.app,t.markupTools),t.icons.unpostedPhotoIcon&&t.icons.unpostedPhotoIcon.iconUrl){var i=new esri.symbol.PictureMarkerSymbol(t.icons.unpostedPhotoIcon.iconUrl,t.icons.unpostedPhotoIcon.width||0,t.icons.unpostedPhotoIcon.height||0);i.setOffset(t.icons.unpostedPhotoIcon.offsetX||0,t.icons.unpostedPhotoIcon.offsetY||0),this._markupManager.unpostedImageSymbol=i}this.postType.bind(this,this._postTypeChanged),this.selectedRooms.bind(this,this._handleSelectedRoomsChanged),this.filePickerWidgetModel.files.bind(this,this._handleUploadFileChanged),this.tools.set(this.app.toolRegistry.createTools(t.tools,!0)),this.selectedDrawingTool.bind(this,function(e){o._markupManager.drawingToolSelectedType.set(e.drawMode)}),this.drawingTools.set(this.app.toolRegistry.createTools(t.markupTools,!0)),this._defaultDrawingTool=this.app.toolRegistry.createTools(t.markupTools.filter(function(e){return e["default"]}),!1)[0]||this.drawingTools.getAt(0),this.selectDrawingTool(this._defaultDrawingTool),this.characterLimit.set(t.characterLimit||1e3),this.numEventsToFetch=t.numEventsToFetch||25,this.autoJoinList.set(t.initialRooms||[]),this.autoJoinList.bind(this,function(e){switch(e.type){case"append":case"insert":case"set":var t=[];o.autoJoinList.getRange(e.rangeStart,e.rangeEnd).forEach(function(e){o.rooms.get().forEach(function(i){i.id===e&&(o.selectedRooms.contains(i)||t.push(i),o.autoJoinList.removeItem(e))})}),t.length>0&&o.selectRooms(o.selectedRooms.get().concat(t))}}),this.app.event("RoomInformationUpdateEvent").subscribe(this,this._handleRoomStatusChanged),this.app.event("RoomActivityEvent").subscribe(this,this._handleRoomEventAddedEvent),this.app.event("RoomsChangedEvent").subscribe(this,this._updateRooms),this.app.event("RoomJoinedConfirmationEvent").subscribe(this,function(){}),this.app.event("RoomLeaveConfirmationEvent").subscribe(this,function(){}),this.app.event("CollaboratorRegisteredEvent").subscribe(this,this._handleCollaboratorRegisteredEvent),this.app.command("WebSocketCommand").register(this,this._executeSendWebSocketCommand),this.app.command("CopyCollaborationEvent").register(this,this._executeCopyCollaborationEvent),this.app.command("ShowCopyDialogForEvent").register(this,this._executeShowCopyDialogForEvent,this._canExecuteShowCopyDialogForEvent),this.app.command("CreateCollaborationEvent").register(this,this._executeCreateCollaborationEvent),this.app.command("GetCollaborationEvent").register(this,this._executeGetCollaborationEvent),this.app.command("EditCollaborationEvent").register(this,this._executeEditCollaborationEvent),this.app.command("EditCollaborationRoom").register(this,this._executeEditCollaborationRoom),this.app.command("CreateCollaborationRoom").register(this,this._executeCreateCollaborationRoom),this.app.command("VerifyRoomNameUnique").register(this,this._executeVerifyRoomNameUnique),this.app.command("EraseMarkupEvent").register(this,this._executeEraseMarkupEvent,this._canExecuteEraseMarkupEvent),this.app.command("PushCollaborationRoom").register(this,this._executePushCollaborationRoom,this._canExecutePushCollaborationRoom),this.app.command("GetCollaborationRooms").register(this,this._executeGetCollaborationRooms,this._canExecuteGetCollaborationRooms),this.app.command("AutoJoinCollaborationRoom").register(this,this._executeAutoJoinCollaborationRoom),this.app.event("ActiveToolChanged").subscribe(this,function(e){var t=e.tool,i=e.previousTool,n=o.drawingTools.contains(i)||o.tools.contains(i),a=o.drawingTools.contains(t)||o.tools.contains(t);null===t&&n&&o.app.configuration.mobileMode&&o.app.command("OpenDataFrame").execute(),a?o.toolActive.set(!0):o.toolActive.set(!1)}),this.entryText.bind(this,this._entryTextChanged),this.toolReadyToSend.bind(this,this._updateSendingEnabled),this.postingRoom.bind(this,this._updateSendingEnabled),this.postingRoom.bind(this,function(e){e&&o.postingRoomColor.sync(e.color)}),this.postTextColor.syncTransform(this.postingRoomColor,this._transformPostTextColor),this.entryText.bind(this,this._updateClearEnabled),this.filePickerWidgetModel.files.bind(this,this._updateClearEnabled),this._markupManager.toolReady.bind(this,this._updateClearEnabled),this.contributableRooms.bind(this,function(e){o.contributableRooms.length?o.controlsMinimized.set(o.app.configuration.mobileMode):o.controlsMinimized.set(!1)});var n=t.webSocketUrl||this._getWebsocketUrl();this._webSocket.connect(n)}},t.prototype.sendEvent=function(){var e=this;return new Promise(function(t,o){var i={roomId:e.postingRoom.get().id};switch(e.postType.get()){case"markup":var n=e._markupManager.getFeaturesFromDrawingsLayer();i.data={markup:{points:n.points.toJson(),polylines:n.polylines.toJson(),polygons:n.polygons.toJson(),rectangles:n.rectangles.toJson()},message:e.entryText.get()},i.type="ShareMarkupEvent",e.app.command("ClearCollaborationDrawings").execute(),e.app.command("CreateCollaborationEvent").execute(i),e.app.command("ClearActiveTool").execute(),t();break;case"image":var a=e.filePickerWidgetModel.files.getAt(0);e._getThumbnailBase64(e._getDataUriFromFile(a),e._config.thumbnailViewSize.height,e._config.thumbnailViewSize.width).then(function(t){var o={location:t},i={contentType:l.ContentType.TEXT,fileType:a.fileType,thumbnail:o},n={document:i,blob:a.fileDataBase64},r=c.writeDocument(n);return e.app.site.documentStore.perform(r,!0)}).then(function(o){i.type="ShareImageEvent",i.attachmentId=o.document.id,i.data={location:e._markupManager.getPhotoLocation().toJson(),message:e.entryText.get()},e.app.command("CreateCollaborationEvent").execute(i),e.resetFilePicker(),t()}).caught(function(t){e.app.trace.error("Failed to write image document: {0}".format(t.message),t),o(t)});break;default:i.data={message:e.entryText.get()},i.type="MessageEvent",e.app.command("CreateCollaborationEvent").execute(i),t()}})},t.prototype.selectDrawingTool=function(e){this.flyoutVisible.set(!1),this.selectedDrawingTool.set(e)},t.prototype.activateDrawingTool=function(e){this.selectDrawingTool(e),this.app.command("SetActiveTool").execute(e.name),this.app.configuration.mobileMode&&this.app.command("CloseDataFrame").execute()},t.prototype.getOlderEntries=function(){var e=this,t={rooms:this.selectedRooms.get().map(function(e){return e.id}),pageSize:this.numEventsToFetch,activeRoomsOnly:!0,getBeforeId:this.events.getAt(0).event.id,eventTypes:this.eventTypes.filter(function(e){return e.visible&&!e.automatic}).map(function(e){return e.name})};this._restHandler.query(t).then(function(t){e._setLoadingEvents(!0),e._addEvents(t.events),e.hasMoreEvents.set(t.resultCount===e.numEventsToFetch)}).caught(function(t){e.app.trace.error("Failed to fetch the previous page of events: {0}.".format(t.message),t)})["finally"](function(){e._setLoadingEvents(!1)})},t.prototype.getMarkupManager=function(){return this._markupManager},t.prototype.activateImageLocator=function(){this.app.command("SetActiveTool").execute("SetCollaborationImageLocation"),this.app.configuration.mobileMode&&this.app.command("CloseDataFrame").execute()},t.prototype.resetFilePicker=function(){this.filePickerWidgetModel.clear();var e;e=this.filePickerWidgetModel.attached_controlId&&this.filePickerWidgetModel.attached_controlId.get?$("input#"+this.filePickerWidgetModel.attached_controlId.get())[0]:$(".chat-controls-input-area input.collaboration-file-input-browser")[0],e&&e instanceof HTMLInputElement&&"file"==e.type&&(e.type="",e.type="file")},t.prototype.selectRooms=function(e){var t=this;e.sort(function(e,t){return e.id.localeCompare(t.id)});var o=this.selectedRooms.get().filter(function(t){return e.indexOf(t)===-1}).map(function(e){return e.id}),i=e.filter(function(e){return t.selectedRooms.indexOf(e)===-1}).map(function(e){return e.id});return o.length||i.length?(this.app.command("ClearCollaborationDrawings").execute(),this.selectedRooms.set(e),0===e.length&&(this.postingRoom.set(null),this.hasMoreEvents.set(!1)),this.contributableRooms.getLength()>0&&this.postingRoom.set(this.contributableRooms.getAt(0)),this._setLoadingEvents(!0),this._leaveRooms(o).then(function(){return t._close(o)}).then(function(){return t._joinRooms(i)}).then(function(o){return t._graphicsManager.buildRoomMarkupState(e.map(function(e){return e.id})).then(function(){return Promise.resolve(o)})}).then(function(o){return t._open(e.concat(o))}).caught(function(e){t.app.trace.error("Error during room selection: {0}.".format(e.message),e)})["finally"](function(){t._setLoadingEvents(!1)})):Promise.resolve()},t.prototype._joinRooms=function(e){var t=this;if(!e.length)return Promise.resolve([]);var o=[];return e.forEach(function(e){o.push(t._restHandler.joinRoom(e))}),Promise.settle(o).then(function(e){var o=[];return e.forEach(function(e){if(e.isFulfilled){var i=t._findRoom(e.value().id);i&&(o.push(i),t.app.command("WebSocketCommand").execute("JoinCollaborationRoom",{id:i.id,token:t.app.site.principal.tokens.site}),i.joined.set(!0))}else t.app.trace.error("Failed to join room: {0}".format(e.reason()))}),o})},t.prototype._leaveRooms=function(e){var t=this;if(!e.length)return Promise.resolve([]);var o=[];return e.forEach(function(e){o.push({roomId:e,promise:t._restHandler.leaveRoom(e)})}),Promise.settle(o.map(function(e){return e.promise})).then(function(e){var i=[];return o.forEach(function(e){if(e.promise.isFulfilled()){var o=t._findRoom(e.roomId);o&&(i.push(o),o.joined.set(!1))}else t.app.trace.warning("Possible permission error when leaving room: {0}".format(e.promise.reason()));t.app.command("WebSocketCommand").execute("LeaveCollaborationRoom",{id:e.roomId,token:t.app.site.principal.tokens.site})}),i})},t.prototype._open=function(e){var t=this;if(!e.length)return Promise.resolve();var o=e.map(function(e){return e.id}),i={rooms:o,pageSize:this.numEventsToFetch,activeRoomsOnly:!0,eventTypes:this.eventTypes.filter(function(e){return e.visible&&!e.automatic}).map(function(e){return e.name})};return this._restHandler.query(i).then(function(e){t._addEvents(e.events),t.hasMoreEvents.set(e.resultCount>=t.numEventsToFetch)})},t.prototype._updateRooms=function(){var e=this,t={applicationId:this._applicationScope,activeRoomsOnly:!0};return this._restHandler.getRooms(t).then(function(t){var o=[],n=[];if(o=e.rooms.get().filter(function(e){return!t.some(function(t){return t.id===e.id})}),o.forEach(function(t){return e.rooms.removeItem(t)}),t.forEach(function(t){var o=e._findRoom(t.id);if(o)o.equals(t)||(o.displayName.set(t.displayName),o.color.set(t.color),o.isGlobal=t.global,o.isContributor=t.isContributor,o.isOwner.set(t.isOwner),e.app.event("CollaborationRoomUpdatedEvent").publish(o.toRestObject()));else{var a=new i.Room(t);a.isNew.set(!0),n.push(a)}}),e.rooms.addItems(n),o.length||n.length){var a=e.selectedRooms.get().filter(function(e){return!o.some(function(t){return t.id===e.id})});return n.forEach(function(t){e.autoJoinList.contains(t.id)&&(a.push(t),e.autoJoinList.removeItem(t.id))}),Promise.resolve(e.selectRooms(a))}e.selectedRooms.pulse(),e.contributableRooms.length()&&null===e.postingRoom.get()&&e.postingRoom.set(e.contributableRooms.getAt(0))})["catch"](function(t){e.app.trace.error("Failed to retrieve room list from REST endpoint: {0}".format(t.message),t)})},t.prototype._postTypeChanged=function(e){var t=this;switch(this.controlsMinimized.set(!1),this.resetFilePicker(),this.app.command("ClearCollaborationDrawings").execute(),this.app.command("ClearActiveTool").execute(),this.toolReadyToSend.removeSync(),this.toolReadyToSend.clear(),e){case"markup":return this.toolReadyToSend.sync(this._markupManager.toolReady),this.toolReadyToSend.delegateGetter=function(){return t._markupManager.toolReady.get()},this.drawingToolsVisible.set(!0),this.uploadToolsVisible.set(!1),this.textPost.set(!1),this.typeCaption.set(this.app.getResource(this.libraryId,"language-collaboration-event-type-caption-markup")),this.textEntryPlaceholder.set(this.app.getResource(this.libraryId,"language-collaboration-chat-entry-placeholder-optional")),this.selectDrawingTool(this._defaultDrawingTool),void(this.app.configuration.mobileMode||this.app.command("SetActiveTool").execute(this.selectedDrawingTool.get().name));case"image":return this.toolReadyToSend.sync(this._markupManager.toolReady),this.toolReadyToSend.delegateGetter=function(){return t._markupManager.toolReady.get()&&!!t.filePickerWidgetModel.files.length},this.uploadToolsVisible.set(!0),this.drawingToolsVisible.set(!1),this.textPost.set(!1),this.typeCaption.set(this.app.getResource(this.libraryId,"language-collaboration-event-type-caption-image")),void this.textEntryPlaceholder.set(this.app.getResource(this.libraryId,"language-collaboration-chat-entry-placeholder-optional"));case"none":this.typeCaption.set(this.app.getResource(this.libraryId,"language-collaboration-event-type-caption-message")),this.toolReadyToSend.set(!1);break;default:this.typeCaption.set(this.app.getResource(this.libraryId,"language-collaboration-event-type-caption-default"))}this.textPost.set(!0),this.toolReadyToSend.delegateGetter=function(){return!1},this.drawingToolsVisible.set(!1),this.uploadToolsVisible.set(!1),this.textEntryPlaceholder.set(this.app.getResource(this.libraryId,"language-collaboration-chat-entry-placeholder"))},t.prototype._entryTextChanged=function(e){this._updateSendingEnabled()},t.prototype._updateSendingEnabled=function(){var e=!this.postType.equals("none"),t=this.entryText.get()&&this.entryText.get().trim();this.sendEnabled.set((t&&!e||this.toolReadyToSend.get()&&e)&&!!this.postingRoom.get())},t.prototype._updateClearEnabled=function(){this.clearEnabled.set(!!this.entryText.get()||this._markupManager.toolReady.get()||!!this.filePickerWidgetModel.files.getLength())},t.prototype._executeCopyCollaborationEvent=function(e,t){var o=this;this._restHandler.copyEvent(e.id,t).caught(function(e){o.app.trace.error("Error while copying room {0}.".format(e.message),e)})},t.prototype._canExecuteShowCopyDialogForEvent=function(e){if(!e)return!0;var t=this.rooms.get().filter(function(t){return t.isContributor&&t.id!==e.roomId}).length;return t>0&&!this._graphicsManager.eventDeleted(e.id)},t.prototype._executeShowCopyDialogForEvent=function(e){var t=this.rooms.get().filter(function(t){return t.isContributor&&t.id!==e.roomId});this.joinedCopyTargets.set(t.filter(function(e){return e.joined.get()})),this.unjoinedCopyTargets.set(t.filter(function(e){return!e.joined.get()})),this.selectedCopyRoom.set(this.joinedCopyTargets.getAt(0)||this.unjoinedCopyTargets.getAt(0)),this.app.command("ActivateEventCopyView").execute(e)},t.prototype._executeSendWebSocketCommand=function(e){for(var t=[],o=1;o<arguments.length;o++)t[o-1]=arguments[o];this._webSocket.command(e).execute(t)},t.prototype._executeCreateCollaborationEvent=function(e){var t=this;this.isSending.set(!0),this._restHandler.addEvent(e),setTimeout(function(){t.isSending.set(!1)},1e3)},t.prototype._executeEditCollaborationEvent=function(e,t,o){this._restHandler.editEvent(e,t).then(o)},t.prototype._executeGetCollaborationEvent=function(e,t){this._restHandler.getEvent(e).then(t)},t.prototype._executeEditCollaborationRoom=function(e,t,o){this._restHandler.editRoom(e,t).then(o)},t.prototype._executeCreateCollaborationRoom=function(e,t){e.applicationId=this._applicationScope,this._restHandler.createRoom(e).then(t)},t.prototype._executeAutoJoinCollaborationRoom=function(e){this.autoJoinList.addItem(e)},t.prototype._executeVerifyRoomNameUnique=function(e,t){this._restHandler.checkRoomNameUnique(e,this._applicationScope).then(t)},t.prototype._executeOpenCollaboration=function(){this.app.command("ActivateView").execute("CollaborationView")},t.prototype._canExecuteOpenCollaboration=function(){return this.enabled.get()},t.prototype._canExecuteEraseMarkupEvent=function(e){return e.isOwner&&!this._graphicsManager.eventDeleted(e.id)&&this.eventTypes.some(function(t){return t.name===e.type&&t.widget.configuration&&!!t.widget.configuration.canDelete})},t.prototype._executeEraseMarkupEvent=function(e){var t=this,o=this.app.getResource(this.libraryId,"language-collaboration-event-erase-markup-confirm-message"),i=this.app.getResource(this.libraryId,"language-collaboration-event-erase-markup-confirm-title");this.app.command("Confirm").execute(o,i,function(o){if(o){var i={roomId:e.roomId,type:"DeleteMarkupEvent",data:{}};t.app.command("EditCollaborationEvent").execute(e.id,i)}})},t.prototype._canExecuteGetCollaborationRooms=function(){
return this.active.get()},t.prototype._executeGetCollaborationRooms=function(e,t){void 0===e&&(e=!0);var o={applicationId:this._applicationScope,activeRoomsOnly:e};this._restHandler.getRooms(o).then(t)},t.prototype._canExecutePushCollaborationRoom=function(){return this.active.get()},t.prototype._executePushCollaborationRoom=function(e,t,o,i){o||(o={rooms:[],eventTypes:["ShareMarkupEvent","DeleteMarkupEvent","ShareImageEvent"]}),this._restHandler.pushRoom(e,t,o).then(i)},t.prototype._handleSelectedRoomsChanged=function(e){if(e.rangeEnd+1-e.rangeStart<e.sender.value.length||"append"===e.type){this.contributableRooms.set(this.selectedRooms.get().filter(function(e){return e.isContributor}));var t=this.selectedRooms.getAt(0);this.firstRoom.set(t?t.displayName.get():"")}else this.contributableRooms.clear(),this.firstRoom.set("");this.singleRoomSelected.set(1===this.selectedRooms.getLength())},t.prototype._handleUploadFileChanged=function(e){var t=this;this.toolReadyToSend.get();var o=".chat-controls .filepicker .form-label";if("clear"===e.type)$(o).removeAttr("style"),this._markupManager.removePhotoLocation(),this.canManuallyLocate.set(!1);else if(this.filePickerWidgetModel.files.get()&&this.filePickerWidgetModel.files.getAt(0)){var i=this.filePickerWidgetModel.files.getAt(0);this.canManuallyLocate.set(!0),this._getThumbnailBase64(this._getDataUriFromFile(i),this._config.previewViewSize.height,this._config.previewViewSize.width).then(function(e){$(o).css("background-image","url("+e+")")});var n=null;try{n=s.ExifUtilities.getExifTagsFromImageBytes(this._base64ToArrayBuffer(i.fileDataBase64,"image/*"))}catch(a){this.app.trace.warning("Failed to fetch Exif tags from the image: {0}".format(a.message))}n&&s.ExifUtilities.getPointFromExif(n)?this._markupManager.setPhotoLocation(s.ExifUtilities.getPointFromExif(n),!0).caught(function(e){t.app.trace.error("Failed to plot the Exif location: {0}".format(e.message),e),t.activateImageLocator()}):this.app.isHttpsMode?this._performPhotoGeolocation().then(function(e){return t._markupManager.setPhotoLocation(e,!0)}).caught(function(e){t.app.trace.error("Failed to geolocate your position: {0}".format(e.message),e),t.activateImageLocator()}):this.activateImageLocator()}},t.prototype._handleWebSocketConnectionChanged=function(e){e.isConnected.get()?this.app.command("WebSocketCommand").execute("RegisterCollaborator",{token:this.app.site.principal.tokens.site,applicationId:this._applicationScope}):(this.connected.set(!1),this.selectedRooms.getLength()>0&&(this._reconnectionState=this.selectedRooms.get().map(function(e){return e.id})))},t.prototype._handleRoomEventAddedEvent=function(e){var t=this;e.data.forEach(function(e){if(t.eventTypes.some(function(t){return e.type===t.name&&t.visible})){if(t.events.getLength()){var o=Date.parse(t.events.getAt(0).event.created),i=Date.parse(e.created);if(i<o)return}t._addEvents([e],!0)}})},t.prototype._handleRoomStatusChanged=function(e){var t=this._findRoom(e.roomId);t&&(t.members.set(e.connectedUsers),t.memberNames.set(e.connectedUserNames))},t.prototype._handleCollaboratorRegisteredEvent=function(){var e=this;if(this._updateRooms().then(function(){e.rooms.get().forEach(function(e){return e.isNew.set(!1)}),e.hasNewRooms.set(!1),e.numberNewRooms.set(""),e.newRooms=0,e.rooms.pulse()}),this._reconnectionState){this._reconnectionState.forEach(function(t){e.app.command("WebSocketCommand").execute("JoinCollaborationRoom",{id:t,token:e.app.site.principal.tokens.site})});var t={rooms:this.selectedRooms.get().map(function(e){return e.id}),getAfterId:this.events.getLength()>0?this.events.getAt(this.events.getLength()-1).event.id:null,eventTypes:this.eventTypes.filter(function(e){return e.visible}).map(function(e){return e.name})};this._restHandler.query(t).then(function(t){e._setLoadingEvents(!0),t.events.forEach(function(t){e._addEvents([t],!0)})}).caught(function(t){e.app.trace.error("Error while fetching rooms list: {0}.".format(t.message),t)})["finally"](function(){e._setLoadingEvents(!1)}),this._reconnectionState=null}this.connected.set(!0)},t.prototype._base64ToArrayBuffer=function(e,t){t=t||e.match(/^data\:([^\;]+)\;base64,/im)[1]||"",e=e.replace(/^data\:([^\;]+)\;base64,/gim,"");for(var o=atob(e),i=o.length,n=new ArrayBuffer(i),a=new Uint8Array(n),r=0;r<i;r++)a[r]=o.charCodeAt(r);return n},t.prototype._getThumbnailBase64=function(e,t,o){var i=this;return new Promise(function(n,a){var r=new Image,s=function(){if(r.height>=t||r.width>=o){var a=i._calculateAspectRatioFit(r.width,r.height,o,t);n(i._imageToDataUri(r,a.width,a.height))}else n(e)},l=function(){a(new Error("Failed to process thumbnail."))};r.onload=s,r.onerror=l,r.src=e})},t.prototype._imageToDataUri=function(e,t,o){var i=document.createElement("canvas"),n=i.getContext("2d");return i.width=t,i.height=o,n.drawImage(e,0,0,t,o),i.toDataURL()},t.prototype._getDataUriFromFile=function(e){return"data:{0};base64,{1}".format(e.fileType,e.fileDataBase64)},t.prototype._calculateAspectRatioFit=function(e,t,o,i){var n=Math.min(o/e,i/t);return{width:e*n,height:t*n}},t.prototype._performPhotoGeolocation=function(){return new Promise(function(e,t){var o=function(t){if(t.coords&&t.coords.latitude&&t.coords.longitude){var o=new esri.geometry.Point(t.coords.longitude,t.coords.latitude,new esri.SpatialReference(4326));e(o)}},i=function(e){t(e)};navigator.geolocation.getCurrentPosition(o,i)})},t.prototype._getWebsocketUrl=function(){var e=u.UrlUtilities.getUrlComponents(this.app.site.url),t=e.protocol.toLowerCase().indexOf("https")>-1?"wss":"ws";return"{0}://{1}/{2}".format(t,e.host,h)},t.prototype._setLoadingEvents=function(e){var t=this;e?this.isLoadingEvents.set(!0):setTimeout(function(){t.isLoadingEvents.set(!1)},1e3)},t.prototype._transformPostTextColor=function(e){"#"===e.charAt(0)&&(e=e.slice(-(e.length-1)));var t=parseInt(e.substr(0,2),16),o=parseInt(e.substr(2,2),16),i=parseInt(e.substr(4,2),16),n=(299*t+587*o+114*i)/1e3;return n>=168?"#000000":"#FFFFFF"},t}(d.BaseCollaborationViewModel);t.CollaborationViewModel=m;var v=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.locked=!1,t}return __extends(t,e),t.prototype.set=function(t){this.locked||e.prototype.set.call(this,t)},t.prototype.lock=function(){this.locked=!0},t.prototype.unlock=function(){this.locked=!1},t}(o.Observable);t.Lockable=v})},"url:/Mapping/modules/Collaboration/Events/EventActionsMenu.html":'<ul class="event-actions-menu" data-binding="{@visible: visibleMenuItems}{@source: visibleMenuItems}">\r\n    <li class="list-menu-item" data-binding="{@template-for: visibleMenuItems}">\r\n        <button class="event-actions-button" data-binding="{@event-onclick: handleMenuItemClick}{@enabled: canExecute}">\r\n            <img class="list-menu-icon" data-binding="{src: iconUri}{title: @language-offline-maps-delete-from-server-title}{alt: @language-offline-maps-delete-from-server-title}" />\r\n            <span class="list-menu-name" data-binding="{title: description}{@text: text}"></span>\r\n        </button>\r\n    </li>\r\n</ul>',"url:/Mapping/modules/Collaboration/Events/EventCopyView.html":'<div class="module">\r\n    <span data-binding="{@text: @language-collaboration-copy-event-room-select}"></span>\r\n    <select class="copy-event-room-selector" data-binding="{@value: selectedCopyRoom}{selected: selectedCopyRoom}">\r\n        <optgroup data-binding="{@source: joinedCopyTargets}{label: @language-collaboration-copy-event-joined-rooms}">\r\n            <option data-binding="{@template-for: joinedCopyTargets}{@text: displayName}{@attach: @context}" />\r\n        </optgroup>\r\n        <optgroup data-binding="{@source: unjoinedCopyTargets}{label: @language-collaboration-copy-event-unjoined-rooms}">\r\n            <option data-binding="{@template-for: unjoinedCopyTargets}{@text: displayName}{@attach: @context}" />\r\n        </optgroup>\r\n    </select>\r\n    <div class="form-btns">\r\n        <button class="button" data-binding="{@event-onclick: copyClicked}{@text: @language-collaboration-copy-event-copy}"></button>\r\n        <button class="button" data-binding="{@event-onclick: cancelClicked}{@text: @language-collaboration-copy-event-cancel}"></button>\r\n    </div>\r\n</div>',"url:/Mapping/modules/Collaboration/Events/EventEditView.html":'<div class="module">\r\n    <!--<span data-binding="{@text: @language-collaboration-edit-event-message}"></span>-->\r\n    <textarea data-binding="{@value: message}{maxLength: characterLimit}"></textarea>\r\n    <div class="form-btns">\r\n        <button class="button" data-binding="{@event-onclick: editClicked}{@text: @language-common-edit}{@enabled: sendEnabled}{@visible: clickableGraphicsMode}"></button>\r\n        <button class="button" data-binding="{@event-onclick: saveClicked}{@text: @language-common-save}{@enabled: sendEnabled}{@hidden: clickableGraphicsMode}"></button>\r\n        <button class="button" data-binding="{@event-onclick: cancelClicked}{@text: @language-common-cancel}"></button>\r\n    </div>\r\n</div>',"url:/Mapping/modules/Collaboration/Events/BannerEvent/BannerEventView.html":'<div class="event-banner-data" data-binding="{@text: bannerText}{title: bannerTitle}"></div>\r\n',"url:/Mapping/modules/Collaboration/Events/CardEvent/CardEventContentView.html":'<div class="event-data-container">\r\n    <div class="event-data" data-binding="{@text: @language-collaboration-no-event-content}"></div>\r\n</div>',"url:/Mapping/modules/Collaboration/Events/CardEvent/CardEventView.html":'<div class="chat-entry-container" data-binding="{@class-user-entry: isOwner}{@event-onclick: handleClick}{@class-clickable: clickable}{@class-cardIsLoading: isLoading}">\r\n    <div class="event-metadata-container menu-enabled">\r\n        <span class="collaboration-event-metadata event-createdby" data-binding="{@text: createdByPresentable}"></span>\r\n        <span class="name-date-separator"> ~</span>\r\n        <span class="collaboration-event-metadata event-created" data-binding="{@text: created}"></span>\r\n    </div>\r\n    <button class="event-menu-button" data-binding="{@event-onclick: toggleEventMenu}{@enabled: menuEnabled}{alt: @language-collaboration-open-event-menu}{title: @language-collaboration-open-event-menu}"></button>\r\n    <div class="event-actions-widget" data-binding="{@visible: menuVisible}{@widget: EventActionsWidget}{@widget-context: @context}{@widget-required: false}"\r\n         data-menu-id="EventActions" data-menu-template="Mapping/modules/Collaboration/Events/EventActionsMenu.html"></div>\r\n    <div class="event-data-container" data-binding="{@widget: EventContentWidget}{@widget-context: @context}{@widget-required: false}{@widget-replace: true}"></div>\r\n    <div class="event-metadata-container lower">\r\n        <div class="room-color-swatch" data-binding="{@style-background-color: color}"></div>\r\n        <span data-binding="{@text: explainerText}"></span>\r\n    </div>\r\n</div>',"url:/Mapping/modules/Collaboration/Events/ImageEvent/ImageEventContentView.html":'<div class="event-data-container">\r\n    <div class="image-event-data" data-binding="{@text: text}"></div>\r\n    <div class="event-image-container">\r\n        <button>\r\n            <img class="event-image" data-binding="{src: previewUrl}{@event-onload: onPreviewLoaded}{@class-erased: deleted}" />\r\n        </button>\r\n        <button class="image-open-full-button" data-binding="{title: @language-collaboration-event-open-image-in-new-tab}{@event-onclick: handleOpenFullClick}"></button>\r\n    </div>\r\n    <div class="markup-meta-text" data-binding="{@text: @language-collaboration-event-image-erased}{@visible: deleted}"></div>\r\n    <form style="display:none;" target="_blank" method="post" data-binding="{action: openUrl}{@var: formElement}">\r\n        <input name="token" type="text" data-binding="{@var: formTokenElement}" />\r\n    </form>\r\n</div>',"url:/Mapping/modules/Collaboration/Events/MessageEvent/MessageEventContentView.html":'<div class="event-data-container" data-binding="{@text: text}"></div>',"url:/Mapping/modules/Collaboration/Events/ShareMarkupEvent/ShareMarkupEventContentView.html":'<div class="event-data-container">\r\n    <button class="markup" data-binding="{@text: text}{@disabled: deleted}"></button>\r\n    <div class="markup-meta-text" data-binding="{@text: @language-collaboration-event-drawing-erased}{@visible: deleted}"></div>\r\n</div>\r\n\r\n',"url:/Mapping/modules/Collaboration/Rooms/EditRoomView.html":'<div class="collaboration-create-room-panel">\r\n    <div class="form-item">\r\n        <label data-binding="{@text: @language-collaboration-room-menu-displayname}"></label>\r\n        <input type="text" data-gcx-action="collaboration-edit-room-displayName" class="display-name-input" data-binding="{@value: displayName}{@event-onblur: validate}{@event-oninput: delayedValidate}" />\r\n    </div>\r\n    <div class="form-item">\r\n        <label data-binding="{@text: @language-collaboration-room-menu-color}"></label>\r\n        <div data-binding="{@widget: ColorPickerWidget}{@widget-context: colorPicker}{@widget-replace: true}"></div>\r\n    </div>\r\n    <div class="form-item">\r\n        <label data-binding="{@text: @language-collaboration-room-menu-permissions}"></label>\r\n        <div data-gcx-action="collaboration-edit-room-grantEditorWidget" data-binding="{@widget: GrantEditorWidget}{@widget-context: @context}{@widget-replace: true}{@visible: isOwner}"></div>\r\n    </div>\r\n    <div class="form-validation" data-binding="{@visible: verificationError}">\r\n        <span class="field-validation-error" data-binding="{@text: verificationError}"></span>\r\n    </div>\r\n    <div class="form-btns">\r\n        <button class="button" data-binding="{@event-onclick: handleDeleteClicked}{@visible: roomId}{@text: @language-collaboration-room-menu-delete}"></button>\r\n        <button class="button" data-binding="{@event-onclick: handleSaveClicked}{@enabled: validated}{@text: @language-collaboration-room-menu-save}"></button>\r\n        <button class="button" data-binding="{@event-onclick: handleCancelClicked}{@text: @language-collaboration-room-menu-cancel}"></button>\r\n    </div>\r\n</div>\r\n',"url:/Mapping/modules/Collaboration/Rooms/RoomDetailsView.html":'<div class="collaboration-create-room-panel">\r\n    <div data-binding="{@source: room}">\r\n        <div data-binding="{@template-for: room}">\r\n            <div class="form-item">\r\n                <label data-binding="{@text: @language-collaboration-room-menu-displayname}"></label>\r\n                <div class="collaboration-room-details-field" data-binding="{@text: displayName}"></div>\r\n            </div>\r\n            <div class="form-item">\r\n                <label data-binding="{@text: @language-collaboration-room-menu-color}"></label>\r\n                <div class="room-color-swatch" data-binding="{@style-background-color: color}"></div>\r\n                <div class="collaboration-room-details-field" data-binding="{@text: color}"></div>\r\n            </div>\r\n            <div class="form-item">\r\n                <label data-binding="{@text: @language-collaboration-room-creator-name}"></label>\r\n                <div class="collaboration-room-details-field" data-binding="{@text: createdBy}"></div>\r\n            </div>\r\n            <div class="form-item">\r\n                <label data-binding="{@text: @language-collaboration-room-created-time}"></label>\r\n                <div class="collaboration-room-details-field" data-binding="{@text: createdPresentable}"></div>\r\n            </div>\r\n            <div class="form-item" data-binding="{@visible: joined}">\r\n                <label>\r\n                    <span data-binding="{@text: @language-collaboration-room-member-names}"></span>\r\n                    <span class="active-member-count" data-binding="{@text: members}"></span>\r\n                </label>\r\n                <ul class="member-name-list" data-binding="{@source: memberNames}">\r\n                    <li data-binding="{@template-for: memberNames}">\r\n                        <span data-binding="{@text: @context}"></span>\r\n                    </li>\r\n                </ul>\r\n            </div>\r\n        </div>\r\n    </div>\r\n    <div class="form-btns">\r\n        <button class="button" data-binding="{@event-onclick: handleEditClicked}{@visible: canEdit}{@text: @language-collaboration-room-menu-edit}"></button>\r\n        <button class="button" data-binding="{@event-onclick: handleCloseClicked}{@text: @language-collaboration-room-menu-close}"></button>\r\n    </div>\r\n</div>\r\n',"url:/Mapping/modules/Collaboration/Views/AfterAction/AfterActionSelectorView.html":'<div class="fui-selector" data-binding="{@class-expanded: openState}">\r\n\r\n    <div class="fui-selector-header" data-binding="{@visible: showSelectorHeader}">\r\n        <button data-binding="{@event-onclick: handleClickSelector}{@text: selectorText}"></button>\r\n    </div>\r\n    <div data-binding="{@visible: openState}">\r\n        <div class="fui-selector-body" data-binding="{@hidden:showNativeSelect}{@class-expanded: openState}">\r\n            <ul class="fui-selector-body-sublist room-item-list" data-binding="{@source: items}{@var: customSelect}">\r\n                <li class="fui-selector-item" data-binding="{@template-for: items}{@widget: SelectorItemWidget}{@widget-context: @context}{@widget-replace: true}" />\r\n            </ul>\r\n        </div>\r\n        <select class="fui-selector-body" data-binding="{@class-expanded: openState}{@visible: showNativeSelect}{@var: selectElement}{@source: items}{@value: _selectedItems}\r\n            {@event-onchange: handleSelectionChange}">\r\n            <option data-binding="{@template-for: items}{@event-onclick: handleClickItem}{@text: displayName}{@attach:@context}"></option>\r\n        </select>\r\n    </div>\r\n</div>\r\n',"url:/Mapping/modules/Collaboration/Views/AfterAction/AfterActionView.html":'<!-- Room Selector-->\r\n<div class="collaboration-sign-in" data-binding="{@hidden: active}">\r\n    <span data-binding="{@visible: supported}">\r\n        <span data-binding="{@visible: enabled}">\r\n            <span class="collaboration-sign-in-link" data-binding="{@hidden: signedIn}{@event-onclick: handleSignInClick}{@text: @language-after-action-not-signed-in}{title: @language-user-sign-in-desc}"></span>\r\n        </span>\r\n        <span data-binding="{@hidden: enabled}{@text: @language-after-action-disabled}"></span>\r\n    </span>\r\n    <span data-binding="{@hidden: supported}{@text: @language-after-action-unsupported}"></span>\r\n</div>\r\n<div class="collaboration-panel" data-binding="{@visible: signedIn}">\r\n    <div class="room-selector">\r\n        <div data-binding="{@widget: Selector}{@widget-replace: true}{@enabled: connected}"></div>\r\n    </div>\r\n\r\n    <!-- Event List-->\r\n    <div class="event-list-container" data-binding="{@class-event-list-container-control-mode: contributableRooms}{@class-loadingEventCards: isLoadingEvents}">\r\n        <div class="collaboration-select-room-prompt" data-binding="{@hidden: selectedRooms}{@text: @language-after-action-room-select-prompt}"></div>\r\n        <div class="event-feed" data-binding="{@visible: selectedRooms}{@var: eventScroll}">\r\n            <ul class="event-list" data-binding="{@source: events}">\r\n                <li class="event-list-item" data-binding="{@template-for: events}">\r\n                    <div data-binding="{@widget: EventWidget}{@widget-context: @context}{@widget-replace: true}"></div>\r\n                </li>\r\n            </ul>\r\n        </div>\r\n    </div>\r\n</div>\r\n',"url:/Mapping/modules/Collaboration/Views/Collaboration/CollaborationDrawingToolFlyoutView.html":'<div class="drawing-multi-tool-dropdown" data-binding="{@visible: flyoutVisible}">\r\n    <ul class="drawing-tool-list" data-binding="{@source: drawingTools}">\r\n        <li data-binding="{@template-for: drawingTools}">\r\n            <button class="drawing-tool-item" data-binding="{@enabled: enabled}{@hidden: hidden}{@class-highlight: isActive}{@event-onclick: handleChangeToolFlyout}">\r\n                <!--{title: tooltip}-->\r\n                <img data-binding="{@visible: iconUri}{src: iconUri}" src="Resources/Images/Icons/Toolbar/icon-blank-24.png" alt="" />\r\n                <span class="drawing-tool-item-label" data-binding="{@text: displayName}"></span>\r\n            </button>\r\n        </li>\r\n    </ul>\r\n</div>',"url:/Mapping/modules/Collaboration/Views/Collaboration/CollaborationFilePicker.html":'<label data-binding="{for: attached_controlId}{@enabled: isSupported}" class="form-label">\r\n    <input class="collaboration-file-input-browser" type="file" data-binding="{id: attached_controlId}{@visible: isSupported}{title: toolTip}{multiple: allowMultiple}{accept: acceptFileTypes}{@event-change: handleChange}" />\r\n</label>',"url:/Mapping/modules/Collaboration/Views/Collaboration/CollaborationMarkupStyleSelectorView.html":'<div class="collaboration-markup-style-selector">\r\n    <div data-binding="{@widget: SymbologySettings}{@widget-replace: true}"></div>\r\n    <div class="form-btns">\r\n        <button class="button" data-binding="{@event-onclick: applyClicked}{@text: @language-collaboration-symbology-apply}"></button>\r\n        <button class="button" data-binding="{@event-onclick: closeClicked}{@text: @language-collaboration-symbology-cancel}"></button>\r\n    </div>\r\n</div>\r\n',"url:/Mapping/modules/Collaboration/Views/Collaboration/CollaborationSelectorItemTemplate.html":'<li class="selector-item single-select">\r\n    <ul class="room-selector-list">\r\n        <li class="room-selector-list-item" data-binding="{@event-onchange: handleClickItem}">\r\n            <span data-binding="{@source: item}">\r\n                <label class="gcx-toggle" data-binding="{@template-for: item}{@style-background-color: color}{@class-new: isNew}{title: @language-collaboration-join-room}">\r\n                    <input class="input-checkbox" type="checkbox" data-binding="{@value: selected}" />\r\n                    <span class="input-label" data-binding="{@text: displayName}"></span>\r\n                </label>\r\n            </span>\r\n        </li>\r\n        <li class="room-selector-buttons" data-binding="{@source: item}{for: id}">\r\n            <span data-binding="{@template-for: item}">\r\n                <span class="member-count" data-binding="{@visible: joined}">\r\n                    <span class="members-icon"></span><span class="members-number" data-binding="{@text: members}"></span>\r\n                </span>\r\n                <button class="room-selector-button" data-binding="{@event-onclick: handleShowDetailsClicked}{title: @language-collaboration-room-details-tooltip}"></button>\r\n            </span>\r\n        </li>\r\n    </ul>\r\n</li>',"url:/Mapping/modules/Collaboration/Views/Collaboration/CollaborationSelectorView.html":'<div class="fui-selector" data-binding="{@class-expanded: openState}">\r\n    <div class="fui-selector-header" data-binding="{@visible: showSelectorHeader}">\r\n        <button data-binding="{@event-onclick: handleClickSelector}{@text: selectorText}"></button>\r\n    </div>\r\n    <div data-binding="{@visible: openState}">\r\n        <div class="fui-selector-body" data-binding="{@hidden:showNativeSelect}{@class-expanded: openState}">\r\n            <ul class="fui-selector-body-sublist room-item-list" data-binding="{@source: items}{@var: customSelect}">\r\n                <li class="fui-selector-item" data-binding="{@template-for: items}{@widget: SelectorItemWidget}{@widget-context: @context}{@widget-replace: true}" />\r\n            </ul>\r\n            <ul class="fui-selector-body-sublist room-selector-actions">\r\n                <li class="fui-selector-item add-room-list-item">\r\n                    <button class="add-room-button" data-binding="{@event-onclick: handleCreateClicked}"><span class="add-label" data-binding="{@text: @language-collaboration-select-create-label}"></span></button>\r\n                </li>\r\n            </ul>\r\n        </div>\r\n        <select class="fui-selector-body" data-binding="{@class-expanded: openState}{@visible: showNativeSelect}{@var: selectElement}{@source: items}{@value: _selectedItems}\r\n            {@event-onchange: handleSelectionChange}">\r\n            <option data-binding="{@template-for: items}{@event-onclick: handleClickItem}{@text: displayName}{@attach:@context}"></option>\r\n        </select>\r\n    </div>\r\n</div>\r\n',"url:/Mapping/modules/Collaboration/Views/Collaboration/CollaborationView.html":'<!-- Room Selector-->\r\n<div class="collaboration-sign-in" data-binding="{@hidden: active}">\r\n    <span data-binding="{@visible: supported}">\r\n        <span data-binding="{@visible: enabled}">\r\n            <span class="collaboration-sign-in-link" data-binding="{@hidden: signedIn}{@event-onclick: handleSignInClick}{@text: @language-collaboration-not-signed-in}{title: @language-user-sign-in-desc}"></span>\r\n        </span>\r\n        <span data-binding="{@hidden: enabled}{@text: @language-collaboration-disabled}"></span>\r\n    </span>\r\n    <span data-binding="{@hidden: supported}{@text: @language-collaboration-unsupported}"></span>\r\n</div>\r\n<div class="collaboration-panel" data-binding="{@visible: active}{@class-single-room: singleRoomSelected}">\r\n    <div class="room-selector" data-binding="{@class-new: hasNewRooms}">\r\n        <div data-binding="{@widget: Selector}{@widget-replace: true}{@enabled: connected}"></div>\r\n        <button class="new-rooms-notification" data-binding="{@noclass-hide: hasNewRooms}{@text: numberNewRooms}{@event-onclick: handleNewRoomsNotificationClick}"></button>\r\n        <button class="notification-clear-button" data-binding="{@noclass-hide: hasNewRooms}{@event-onclick: handleClearRoomNotification}"></button>\r\n    </div>\r\n\r\n    <!-- Event List-->\r\n    <div class="event-list-container" data-binding="{@class-room-selector-open: roomSelectorVisible}{@class-minimized-mode: controlsMinimized}{@class-control-mode: contributableRooms}{@class-loading-events: isLoadingEvents}{@event-onclick: handleEventFeedClick}">\r\n        <div class="collaboration-select-room-prompt" data-binding="{@hidden: selectedRooms}{@text: @language-collaboration-room-select-prompt}"></div>\r\n        <div class="event-feed" data-binding="{@visible: selectedRooms}{@var: eventScroll}">\r\n            <button class="historical-events-button" data-binding="{@text: @language-collaboration-get-historical}{@event-onclick: handleGetHistoricalClicked}{@visible: hasMoreEvents}"></button>\r\n            <ul class="event-list" data-binding="{@source: events}">\r\n                <li class="event-list-item" data-binding="{@template-for: events}">\r\n                    <div data-binding="{@widget: EventWidget}{@widget-context: @context}{@widget-replace: true}"></div>\r\n                </li>\r\n            </ul>\r\n            <button class="collaboration-message-notification" data-binding="{@noclass-hide: unreadEventsMessage}{@text: unreadEventsMessage}{@event-onclick: handleNotificationClick}"></button>\r\n            <button class="notification-clear-button" data-binding="{@noclass-hide: unreadEventsMessage}{@event-onclick: handleClearMessageNotification}"></button>\r\n        </div>\r\n    </div>\r\n\r\n\r\n    <!--Text Entry Controls-->\r\n    <div class="chat-controls" data-binding="{@enabled: connected}{@visible: contributableRooms}{@class-minimized-mode: controlsMinimized}">\r\n        <form class="post-type-selector">\r\n            <ul class="selector-list">\r\n                <li class="list-item text">\r\n                    <input type="radio" id="text-post" name="post-type" value="none" checked="checked" />\r\n                    <label for="text-post" data-binding="{@text: @language-collaboration-chat-entry-selector-label-none}"></label>\r\n                </li>\r\n                <li class="list-item markup">\r\n                    <input type="radio" id="markup-post" name="post-type" value="markup" data-binding="{@event-onclick: handleAttachmentChange}{@value: postType}" />\r\n                    <label for="markup-post" data-binding="{@text: @language-collaboration-chat-entry-selector-label-markup}"></label>\r\n                    <button class="clear-button" data-binding="{@event-onclick: handleClearClicked}{@visible: clearEnabled}{title: @language-collaboration-draw-clear-drawing}"></button>\r\n                </li>\r\n                <li class="list-item image">\r\n                    <input type="radio" id="image-post" name="post-type" value="image" data-binding="{@event-onclick: handleAttachmentChange}{@value: postType}" />\r\n                    <label for="image-post" data-binding="{@text: @language-collaboration-chat-entry-selector-label-image}"></label>\r\n                    <button class="clear-button" data-binding="{@event-onclick: handleClearClicked}{@visible: clearEnabled}{title: @language-collaboration-draw-clear-image}"></button>\r\n                </li>\r\n            </ul>\r\n        </form>\r\n        <div class="chat-controls-input-area">\r\n            <div class="drawing-multi-tool" data-binding="{@visible: drawingToolsVisible}">\r\n                <div class="drawing-multi-tool-item" data-binding="{@source: selectedDrawingTool}{@class-active: toolActive}">\r\n                    <div data-binding="{@template-for: selectedDrawingTool}">\r\n                        <button class="drawing-tool-item" data-binding="{@enabled: enabled}{@class-highlight: isActive}{@event-onclick: handleToolbarItemClick}{aria-label: name}">\r\n                            <!--{title: tooltip}-->\r\n                            <img data-binding="{@visible: iconUri}{src: iconUri}" src="Resources/Images/Icons/Toolbar/icon-blank-24.png" alt="" />\r\n                            <span class="drawing-tool-item-label" data-binding="{@text: displayName}"></span>\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n                <div class="drawing-multi-tool drawing-multi-tool-chooser">\r\n                    <button class="open-flyout-button" data-binding="{@event-onclick: handleOpenToolFlyout}{@attach: selectedDrawingTool}{title: @language-collaboration-chat-entry-drawing-multitool-tooltip}{aria-label: @language-collaboration-chat-entry-drawing-multitool-tooltip}"></button>\r\n                </div>\r\n                <div class="collaboration-multi-tool-dropdown-container" data-binding="{@widget: ToolFlyoutWidget}{@widget-context: @context}">\r\n                </div>\r\n                <button class="style-button button" data-binding="{@event-onclick: handleDrawSymbologyClicked}{@enabled: selectedDrawingTool}{@text: @language-collaboration-chat-entry-drawing-style}{title: @language-collaboration-chat-entry-drawing-style-tooltip}"></button>\r\n            </div>\r\n            <div class="image-upload" data-binding="{@visible: uploadToolsVisible}">\r\n                <div class="filepicker" data-binding="{@widget: FilePickerWidget}{@visible: isVisible}{title: @language-collaboration-chat-image-upload-tooltip}"></div>\r\n                <button class="button location-button" data-binding="{@enabled: canManuallyLocate}{@text: @language-collaboration-chat-image-manually-locate}{title: @language-collaboration-chat-image-manually-locate-tooltip}{@event-onclick: handleManuallyLocateClick}{@class-active: toolActive}"></button>\r\n            </div>\r\n            <textarea class="chat-text-box" rows="3" data-binding="{@event-onclick: handleTextBarClick}{@value: entryText}{placeholder: textEntryPlaceholder}{maxLength: characterLimit}{@event-onkeyup: handleKeyUp}{@event-oninput: handleInput}{@class-text-post: textPost}"></textarea>\r\n        </div>\r\n        <div class="post-container">\r\n            <span class="post-desc" data-binding="{@text: typeCaption}"></span>\r\n            <select class="room-selector" data-binding="{@event-onclick: handlePostingRoomSelector}{@source: contributableRooms}{@value: postingRoom}{@style-border-color: postingRoomColor}">\r\n                <option data-binding="{@template-for: contributableRooms}{@text: displayName}{@attach: @context}" />\r\n            </select>\r\n            <div class="room-name" data-binding="{@text: firstRoom}{@style-border-color: postingRoomColor}{title: firstRoom}"></div>\r\n            <button class="send-button button" data-binding="{@enabled: sendEnabled}{@event-onclick: handleSendPressed}{@text: @language-collaboration-send-button-label}{@style-border-color: postingRoomColor}{@style-background-color: postingRoomColor}{@style-color: postTextColor}{@class-postingEvent: isSending}"></button>\r\n        </div>\r\n    </div>\r\n</div>'
}}),define(["Mapping/modules/Collaboration/Views/Collaboration/CollaborationSelectorView","Mapping/modules/Collaboration/Rooms/RoomDetailsView","Mapping/modules/Collaboration/Rooms/EditRoomView","Mapping/modules/Collaboration/Events/CardEvent/CardEventView","Mapping/modules/Collaboration/Events/MessageEvent/MessageEventView","Mapping/modules/Collaboration/Events/ImageEvent/ImageEventView","Mapping/modules/Collaboration/Events/ShareMarkupEvent/ShareMarkupEventView","Mapping/modules/Collaboration/Events/MessageEvent/MessageEventViewModel","Mapping/modules/Collaboration/Events/ShareMarkupEvent/ShareMarkupEventViewModel","Mapping/modules/Collaboration/Events/ImageEvent/ImageEventViewModel","Mapping/modules/Collaboration/Events/UserLeftEvent/UserLeftEventView","Mapping/modules/Collaboration/Events/UserLeftEvent/UserLeftEventViewModel","Mapping/modules/Collaboration/Events/UserJoinedEvent/UserJoinedEventView","Mapping/modules/Collaboration/Events/UserJoinedEvent/UserJoinedEventViewModel","Mapping/modules/Collaboration/Events/DeleteMarkupEvent/DeleteMarkupEventView","Mapping/modules/Collaboration/Events/DeleteMarkupEvent/DeleteMarkupEventViewModel","Mapping/modules/Collaboration/Views/AfterAction/AfterActionSelectorView"],function(e,t,o,i,n,a,r,s,l,c,d,u,p,h,m,v,g){shim(e,"geocortex.essentialsHtmlViewer.mapping.modules.collaboration.CollaborationSelectorView",e.CollaborationSelectorView),shim(t,"geocortex.essentialsHtmlViewer.mapping.modules.collaboration.RoomDetailsView",t.RoomDetailsView),shim(o,"geocortex.essentialsHtmlViewer.mapping.modules.collaboration.EditRoomView",o.EditRoomView),shim(i,"geocortex.essentialsHtmlViewer.mapping.modules.collaboration.CardEventView",i.CardEventView),shim(n,"geocortex.essentialsHtmlViewer.mapping.modules.collaboration.MessageEventView",n.MessageEventView),shim(a,"geocortex.essentialsHtmlViewer.mapping.modules.collaboration.ImageEventView",a.ImageEventView),shim(r,"geocortex.essentialsHtmlViewer.mapping.modules.collaboration.ShareMarkupEventView",r.ShareMarkupEventView),shim(s,"geocortex.essentialsHtmlViewer.mapping.modules.collaboration.MessageEventViewModel",s.MessageEventViewModel),shim(l,"geocortex.essentialsHtmlViewer.mapping.modules.collaboration.ShareMarkupEventViewModel",l.ShareMarkupEventViewModel),shim(c,"geocortex.essentialsHtmlViewer.mapping.modules.collaboration.ImageEventViewModel",c.ImageEventViewModel),shim(d,"geocortex.essentialsHtmlViewer.mapping.modules.collaboration.UserLeftEventView",d.UserLeftEventView),shim(u,"geocortex.essentialsHtmlViewer.mapping.modules.collaboration.UserLeftEventViewModel",u.UserLeftEventViewModel),shim(p,"geocortex.essentialsHtmlViewer.mapping.modules.collaboration.UserJoinedEventView",p.UserJoinedEventView),shim(h,"geocortex.essentialsHtmlViewer.mapping.modules.collaboration.UserJoinedEventViewModel",h.UserJoinedEventViewModel),shim(m,"geocortex.essentialsHtmlViewer.mapping.modules.collaboration.DeleteMarkupEventView",m.DeleteMarkupEventView),shim(v,"geocortex.essentialsHtmlViewer.mapping.modules.collaboration.DeleteMarkupEventViewModel",v.DeleteMarkupEventViewModel),shim(g,"geocortex.essentialsHtmlViewer.mapping.modules.collaboration.AfterActionSelectorView",g.AfterActionSelectorView)});