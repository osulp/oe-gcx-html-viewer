function shim(e,t,n){if("string"==typeof e&&(n=t,t=e),"undefined"==typeof n)return void console.warn("Undefined shim for: "+t);for(var a=t.split("."),o=null,r=window,i=0,s=a.length;i<s;i++)o=a[i],i==s-1?r[o]=n:r[o]||(r[o]={}),r=r[o]}require({cache:{"Mapping/modules/BarcodeScanner/BarcodeScannerModule":function(){define(["require","exports","geocortex/framework/application/ModuleBase"],function(require,exports,ModuleBase_1){"use strict";var BarcodeScannerModule=function(_super){function BarcodeScannerModule(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(BarcodeScannerModule,_super),BarcodeScannerModule.prototype.initialize=function(e){this._config=e,this.app.command("LaunchBarcodeScannerWithCallback").register(this,this._executeLaunchBarcodeScanner),this.app.event("NativeMessageEvent").subscribe(this,this._handleNativeMessageEvent),this.app.event("_HtmlBarcodeScannerResult").subscribe(this,this._handleHtmlBarcodeScanner)},BarcodeScannerModule.prototype._executeLaunchBarcodeScanner=function(callback){var _this=this;this.lastCallback=callback,this.app.nativeManager.hasNativeCapability("barcodeScanner").then(function(hasNativeBarcodeScanner){var nativeApp=eval("geocortex.GeocortexNativeApp");hasNativeBarcodeScanner&&_this._config.allowNativeScanner!==!1&&nativeApp&&nativeApp.launchBarcodeScanner?nativeApp.launchBarcodeScanner():_this._config.allowHtmlScanner!==!1&&Modernizr.getusermedia&&Modernizr.webworkers?_this.app.command("ActivateView").execute(_this._config.htmlScannerView):(_this.app.trace.warning("Could not launch a QR scanner."),alert(_this.getResource("language-barcode-scanner-unavailable")))})},BarcodeScannerModule.prototype._handleNativeMessageEvent=function(e){"BarcodeScanResult"===e.type&&this.lastCallback&&(this.lastCallback(e.parameters),this.lastCallback=null)},BarcodeScannerModule.prototype._handleHtmlBarcodeScanner=function(e){this.lastCallback&&(this.lastCallback({status:"Success",content:e.value}),this.lastCallback=null)},BarcodeScannerModule}(ModuleBase_1.ModuleBase);exports.BarcodeScannerModule=BarcodeScannerModule})},"Mapping/modules/BarcodeScanner/BarcodeScannerModuleConfig":function(){define(["require","exports"],function(e,t){"use strict"})},"Mapping/modules/BarcodeScanner/BarcodeScannerView":function(){define(["require","exports","geocortex/framework/ui/ViewBase"],function(e,t,n){"use strict";var a=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._outstandingWorkCount=0,t._attachedVideoEventListeners=!1,t}return __extends(t,e),t.prototype.activated=function(){return e.prototype.activated.call(this),this._getUserMedia=navigator.getUserMedia||navigator.mozGetUserMedia||navigator.webkitGetUserMedia||navigator.msGetUserMedia,this._getUserMedia?Worker?(this._startJsqrcodeWorker(),this._startJobWorker(),void this._startVideo()):void this.app.trace.error(this.id+" shown but web workers aren't available.  Barcode and QR code scanning won't work."):void this.app.trace.error(this.id+" shown but getUserMedia isn't available.  Barcode and QR code scanning won't work.")},t.prototype.deactivated=function(){e.prototype.deactivated.call(this),this._stopVideo()},t.prototype._startJsqrcodeWorker=function(){var e=this;if(!this._jsqrcodeWorker){if(!this.configuration.jsqrcodeSource)return void this.app.trace.error(this.id+" shown but jsqrcodeSource is not configured.  QR code scanning won't work.");this._jsqrcodeWorker=new Worker(this.configuration.jsqrcodeSource),this._jsqrcodeWorker.onmessage=function(t){e._outstandingWorkCount--,t.data.success&&(e.app.command("DeactivateView").execute(e.id),e.app.event("_HtmlBarcodeScannerResult").publish({format:"QR",value:t.data.result}))},this._jsqrcodeWorker.onerror=function(t){e.app.trace.error("Error scanning barcode. "+t.message)}}},t.prototype._startJobWorker=function(){var e=this;if(!this._jobWorker){if(!this.configuration.jobDecoderWorkerSource)return void this.app.trace.error(this.id+" shown but jobDecoderWorkerSource is not configured.  Barcode scanning won't work.");this._jobWorker=new Worker(this.configuration.jobDecoderWorkerSource),this._jobWorker.onmessage=function(t){"boolean"==typeof t.data.success&&e._outstandingWorkCount--,t.data.success===!0&&t.data.result.length>0&&(e.app.command("DeactivateView").execute(e.id),e.app.event("_HtmlBarcodeScannerResult").publish({format:t.data.result[0].Format,value:t.data.result[0].Value}))},this._jobWorker.onerror=function(t){e.app.trace.error("Error scanning barcode. "+t.message)}}},t.prototype._startVideo=function(){var e=this;this._attachedVideoEventListeners||(this._attachVideoEventListeners(),this._attachedVideoEventListeners=!0),this._lastSourceInfo?this._startVideoWithSourceInfo(this._lastSourceInfo):MediaStreamTrack&&MediaStreamTrack.getSources?MediaStreamTrack.getSources(function(t){if(t=t.filter(function(e){return"video"===e.kind}),0===t.length)return void e._startVideoWithConstraints({video:!0,audio:!1});if(1===t.length)return void e._startVideoWithSourceInfo(t[0]);var n=t.filter(function(e){return"environment"===e.facing});return n.length>0?void e._startVideoWithSourceInfo(n[0]):(e._sourceInfos=t,e.viewModel.showSourceSwitcher.set(!0),void e._startVideoWithSourceInfo(t[0]))}):this._startVideoWithConstraints({video:!0,audio:!1})},t.prototype._attachVideoEventListeners=function(){var e,t=this,n=0,a=function(){e||(e=setInterval(function(){return t._outstandingWorkCount>0?(n++,void(n%5===0&&t.app.trace.warning(t.id+" skipped processing "+n+" frames in a row."))):(t._outstandingWorkCount<0&&(t.app.trace.error(t.id+" outstanding work count is negative. Work dispatching and results have gone out of sync."),t._outstandingWorkCount=0),n=0,void t._scan())},t.configuration.scanInterval||750))},o=function(){e&&(clearInterval(e),e=null)};this.videoElement.addEventListener("play",a),this.videoElement.addEventListener("playing",a),this.videoElement.addEventListener("abort",o),this.videoElement.addEventListener("ended",o),this.videoElement.addEventListener("pause",o),this.videoElement.addEventListener("waiting",o)},t.prototype._startVideoWithSourceInfo=function(e){this._lastSourceInfo=e,this._startVideoWithConstraints({video:{optional:[{sourceId:e.id}]},audio:!1})},t.prototype._startVideoWithConstraints=function(e){var t=this;this._stopVideo(),this._getUserMedia.call(navigator,e,function(e){t._mediaStream=e;var n=window.URL||window.webkitURL;t.videoElement.src=n?n.createObjectURL(e):e,t.videoElement.play(),t.videoElement.focus()},function(e){t.app.trace.error("Error getting user media. "+e.message)})},t.prototype._stopVideo=function(){if(this.videoElement.pause(),this.videoElement.src="",this._mediaStream){var e=this._mediaStream.getTracks()||[];e.forEach(function(e){return e.stop()}),this._mediaStream=null}},t.prototype._scan=function(){if(!this.videoElement.paused&&!this.videoElement.ended){this._canvasContext||(this._canvasContext=this.canvasElement.getContext("2d")),this._canvasContext.drawImage(this.videoElement,0,0);var e=this.canvasElement.clientWidth,t=this.canvasElement.clientHeight;this.canvasElement.width==e&&this.canvasElement.height==t||(this.canvasElement.width=e,this.canvasElement.height=t);var n=this._canvasContext.getImageData(0,0,e,t);n&&(this._jsqrcodeWorker&&(this._jsqrcodeWorker.postMessage({imageData:n,width:e,height:t}),this._outstandingWorkCount++),this._jobWorker&&(this._jobWorker.postMessage({scan:n.data,scanWidth:e,scanHeight:t}),this._outstandingWorkCount++))}},t.prototype.handleKeyDown=function(e,t,n){var a=e.which?e.which:e.keyCode;a===dojo.keys.ESCAPE&&this.app.command("DeactivateView").execute(this.id)},t.prototype.handleBackClick=function(e,t,n){this.app.command("DeactivateView").execute(this.id)},t.prototype.handleSwitchSource=function(e,t,n){if(!this._sourceInfos)return void this.app.trace.error(this.id+" handleSwitchSource called but source switching is not available.");var a=this._sourceInfos.indexOf(this._lastSourceInfo),o=a+1<this._sourceInfos.length?a+1:0;this._startVideoWithSourceInfo(this._sourceInfos[o])},t}(n.ViewBase);t.BarcodeScannerView=a})},"Mapping/modules/BarcodeScanner/BarcodeScannerViewConfig":function(){define(["require","exports"],function(e,t){"use strict"})},"Mapping/modules/BarcodeScanner/BarcodeScannerViewModel":function(){define(["require","exports","geocortex/framework/ui/ViewModelBase","geocortex/framework/observables"],function(e,t,n,a){"use strict";var o=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.showSourceSwitcher=new a.Observable((!1)),t}return __extends(t,e),t}(n.ViewModelBase);t.BarcodeScannerViewModel=o})},"url:/Mapping/modules/BarcodeScanner/BarcodeScannerView.html":'<video autoplay data-binding="{@var: videoElement}{@event-keydown: handleKeyDown}"></video>\r\n<canvas data-binding="{@var: canvasElement}" style="display: block;" id="qr-canvas"></canvas>\r\n<ul class="camera-controls">\r\n    <li>\r\n        <button class="button" data-binding="{@text: @language-common-cancel}{@event-onclick: handleBackClick}"></button>\r\n    </li>\r\n    <li>\r\n        <button class="button" data-binding="{@text: @language-barcode-scanner-switch}{@visible: showSourceSwitcher}{@event-onclick: handleSwitchSource}"></button>\r\n    </li>\r\n</ul>'}}),define(["Mapping/modules/BarcodeScanner/BarcodeScannerModule","Mapping/modules/BarcodeScanner/BarcodeScannerView","Mapping/modules/BarcodeScanner/BarcodeScannerViewModel"],function(e,t,n){shim(e,"geocortex.essentialsHtmlViewer.mapping.modules.barcodescanner.BarcodeScannerModule",e.BarcodeScannerModule),shim(t,"geocortex.essentialsHtmlViewer.mapping.modules.barcodescanner.BarcodeScannerView",t.BarcodeScannerView),shim(n,"geocortex.essentialsHtmlViewer.mapping.modules.barcodescanner.BarcodeScannerViewModel",n.BarcodeScannerViewModel)});