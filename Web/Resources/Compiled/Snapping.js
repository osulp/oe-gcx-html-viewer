function shim(e,i,t){if("string"==typeof e&&(t=i,i=e),"undefined"==typeof t)return void console.warn("Undefined shim for: "+i);for(var n=i.split("."),a=null,r=window,p=0,s=n.length;p<s;p++)a=n[p],p==s-1?r[a]=t:r[a]||(r[a]={}),r=r[a]}require({cache:{"Mapping/modules/Snapping/EsriSnappingProvider":function(){define(["require","exports","./SnappingInfo","geocortex/infrastructure/ArrayUtils","geocortex/infrastructure/TaskUtils","geocortex/essentials/utilities/GraphicsLayerUtilities","geocortex/infrastructure/GraphicsLayerUtils","geocortex/infrastructure/GraphicsLayerIds"],function(e,i,t,n,a,r,p,s){"use strict";var o=function(){function e(e,i){this._convertedSnappingGraphics=null,this._managedDynamicLayers=[],this._loadedDefaultLayers=[],this._snappingLayerInfos=[],this._paused=!1,this._snappingManagerReference=null,this._active=!1,this._refreshOnNextContinue=!1,this.app=e,this.libraryId=i,this.name="EsriSnappingProvider"}return e.prototype.initialize=function(e){this.providerConfiguration=e,this._convertedSnappingGraphics=p.getInternalGraphicsLayer(s.SNAPPING_GRAPHICS_LAYER_ID,this.app,p.GraphicsLayerType.Pushpin),r.addToGraphicsLayerIdsToExclude([p.ExcludeFromEnum.ExportMapTaskName,p.ExcludeFromEnum.ExportApplyStateName,p.ExcludeFromEnum.WebMapName],s.SNAPPING_GRAPHICS_LAYER_ID),this._handleGraphicsLayer(this._convertedSnappingGraphics),this._listenForGraphicLayers()},e.prototype.activate=function(e){this._threshold=e,this.app.map.enableSnapping(this._getSnappingInitOptions()),this._refreshDynamicSnappingData(),this._active=!0},e.prototype._getSnappingInitOptions=function(){var e={map:this.app.map,alwaysSnap:!0,snapKey:-1,tolerance:this._threshold,snapPointSymbol:new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_PATH,0,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new esri.Color([0,0,0,0]),0),new esri.Color([0,0,0,0])),layerInfos:this._cloneLayerInfos()};return e},e.prototype._cloneLayerInfos=function(){var e=[];return this._loadConfiguredDefaultGraphicsLayers(),this._snappingLayerInfos.forEach(function(i){var n=new t.SnappingInfo(i.layer);n.snapToEdge=i.snapToEdge,n.snapToPoint=i.snapToPoint,n.snapToVertex=i.snapToVertex,e.push(i)}),e},e.prototype.deactivate=function(){this.app.map.disableSnapping(),this._convertedSnappingGraphics.clear(),this._snappingManagerReference&&(this._snappingManagerReference.destroy(),this._snappingManagerReference=null),this._active=!1},e.prototype._snappingWithinMap=function(e){var i=!0;return e.x<this._threshold?i=!1:e.y<this._threshold?i=!1:e.y>this.app.map.height-this._threshold?i=!1:e.x>this.app.map.width-this._threshold&&(i=!1),i},e.prototype.provideSnappingPoint=function(e){var i=this;return new Promise(function(t,n){i._paused&&t(null),i._snappingWithinMap(e)?(i.continueSnapping(),i.app.map.snappingManager.getSnappingPoint(e).then(function(e){t(e?e:null)},function(e){n(e)})):(i.pauseSnapping(),t(null))})},e.prototype.registerLayer=function(e,i){if(!e)throw new Error("Must specify a layer for snapping.");return e.snappable?e.mapService.serviceLayer instanceof esri.layers.GraphicsLayer?(this._handleGraphicsLayer(e.mapService.serviceLayer,i),this._refreshLayerInfos(),!0):e.mapService.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer?(this._handleDynamicLayer(e),!0):(this.app.trace.warning("Cannot snap to layer {0}, must be of Graphic or Dynamic type".format(e.displayName)),!1):(this.app.trace.warning("Cannot snap to layer {0}, must be set as snappable in REST Manager".format(e.displayName)),!1)},e.prototype.unregisterLayer=function(e){e.mapService.serviceLayer instanceof esri.layers.GraphicsLayer?this._handleRemoveGraphicsLayer(e.mapService.serviceLayer):e.mapService.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer&&this._handleRemoveDynamicLayer(e),this._refreshLayerInfos()},e.prototype.getSnappableLayers=function(e){var i=e.mapInfo.getLayerInfos().filter(function(e){return e.gcxLayer.snappable});return i=n.ArrayUtils.sortBy(i,function(e){return e.displayName})},e.prototype.continueSnapping=function(){this._snappingManagerReference&&!this.app.map.snappingManager&&this._paused&&(this.app.map.enableSnapping(this._snappingManagerReference),this._snappingManagerReference=null),this.app.map.snappingManager&&this._paused&&(this.app.map.snappingManager._killOffSnapping(),this.app.map.snappingManager._setUpSnapping(),this.app.map.snappingManager._activateSnapping(),this.app.map.snappingManager._startSelectionLayerQuery(),this._refreshLayerInfos()),this._refreshOnNextContinue&&this._active&&(this._refreshDynamicSnappingData(),this._refreshOnNextContinue=!1),this._paused=!1},e.prototype.pauseSnapping=function(){this.app.map.snappingManager&&(this.app.map.snappingManager._killOffSnapping(),this.app.map.snappingManager._deactivateSnapping(),this.app.map.snappingManager._stopSelectionLayerQuery(),this._snappingManagerReference=this.app.map.snappingManager,this.app.map.snappingManager=null),this._paused=!0},e.prototype._isLayerVisible=function(e){if(!e.isVisible())return!1;if(null!==e.maxScale&&void 0!==e.maxScale&&null!==e.minScale&&void 0!==e.minScale){var i=this.app.map.getScale();if(i<e.maxScale||i>e.minScale)return!1}return!0},e.prototype._handleGraphicsLayer=function(e,i){this._removeInfo(e),this.app.trace.debug("[EsriSnappingProvider] Graphics Layer handled {0}".format(e.id));var n=new t.SnappingInfo(e);i&&(n.snapToEdge=i.edge,n.snapToPoint=i.point,n.snapToVertex=i.vertex),this._snappingLayerInfos.push(n),this._refreshLayerInfos()},e.prototype._listenForGraphicLayers=function(){var e=this;this.app.map.on("layer-add-result",function(i){i&&i.layer&&i.layer instanceof esri.layers.GraphicsLayer&&e._loadConfiguredDefaultGraphicsLayers()})},e.prototype._refreshLayerInfos=function(){this.app.map.snappingManager&&this.app.map.snappingManager.setLayerInfos(this._cloneLayerInfos())},e.prototype._handleRemoveGraphicsLayer=function(e){this._removeInfo(e)},e.prototype._handleDynamicLayer=function(e){this._managedDynamicLayers.indexOf(e)<0&&(this._managedDynamicLayers.push(e),this._active&&!this._paused?this._refreshDynamicSnappingData():this._refreshOnNextContinue=!0)},e.prototype._handleRemoveDynamicLayer=function(e){var i=this._managedDynamicLayers.indexOf(e);i>-1&&(this._managedDynamicLayers.splice(i,1),this._active&&!this._paused?this._refreshDynamicSnappingData():this._refreshOnNextContinue=!0)},e.prototype._refreshDynamicSnappingData=function(){this.loadForExtent(this.app.map.extent)},e.prototype._removeInfo=function(e){for(var i=0;i<this._snappingLayerInfos.length;i++)if(this._snappingLayerInfos[i].layer===e){this._snappingLayerInfos.splice(i,1);break}},e.prototype.loadForExtent=function(e){var i=this;this._convertedSnappingGraphics.clear(),this._refreshOnNextContinue=!1;for(var t=[],n=0;n<this._managedDynamicLayers.length;n++)this._isLayerVisible(this._managedDynamicLayers[n])&&t.push(this._managedDynamicLayers[n]);for(var n=0;n<t.length;n++){var r=t[n];if(r){var p=new esri.tasks.Query;p.geometry=e,p.outSpatialReference=this.app.map.spatialReference,p.returnGeometry=!0;var s="1=1";if(r.mapService&&r.mapService.serviceLayer&&r.mapService.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer){var o=r.mapService.serviceLayer,c=o.layerDefinitions||[],h=c[parseInt(r.id)];h&&(s=h)}p.where=s;var d=a.getQueryTask(r);d.execute(p,function(e){i._queryCompleted(e,r)},function(e){i._queryError(e)})}}},e.prototype._queryCompleted=function(e,i){if(e&&e.features)for(var t=0;t<e.features.length;t++){var n=e.features[t];n&&this._convertedSnappingGraphics.add(n)}},e.prototype._queryError=function(e){this.app.trace.error("An error occured while downloading snapping points: {0}".format(e&&e.message?e.message:"Undetermined cause"))},e.prototype._loadConfiguredDefaultGraphicsLayers=function(){var e=this;if(this.providerConfiguration&&this.providerConfiguration.configuration&&this.providerConfiguration.configuration.graphicsLayers){var i=this.providerConfiguration.configuration.graphicsLayers;i.forEach(function(i){var t=e.app.map.getLayer(i);t&&t instanceof esri.layers.GraphicsLayer&&e._loadedDefaultLayers.indexOf(t)<0&&(e._loadedDefaultLayers.push(t),e._handleGraphicsLayer(t))})}},e}();i.EsriSnappingProvider=o})},"Mapping/modules/Snapping/LayerSelectorForSnapping":function(){define(["require","exports"],function(e,i){"use strict";var t=function(){function e(e,i){this.app=e,this.snappingModule=i,this._registerApplicationCommands()}return e.prototype._registerApplicationCommands=function(){this.app.command("EnableAllLayersForSnapping").register(this,this._executeEnableAllLayersForSnapping),this.app.command("DisableAllLayersForSnapping").register(this,this._executeDisableAllLayersForSnapping),this.app.command("EnableLayerForSnapping").register(this,this._executeEnableLayerForSnapping),this.app.command("DisableLayerForSnapping").register(this,this._executeDisableLayerForSnapping)},e.prototype._executeEnableLayerForSnapping=function(e){this.app.command("RegisterSnappingLayer").execute(e)},e.prototype._executeEnableAllLayersForSnapping=function(e){this.app.command("RegisterSnappingLayers").execute(e)},e.prototype._executeDisableLayerForSnapping=function(e){this.app.command("RemoveSnappingLayer").execute(e)},e.prototype._executeDisableAllLayersForSnapping=function(e){this.app.command("RemoveSnappingLayers").execute(e)},e}();i.LayerSelectorForSnapping=t})},"Mapping/modules/Snapping/SnappingInfo":function(){define(["require","exports"],function(e,i){"use strict";var t=function(){function e(e){this.snapToEdge=!0,this.snapToPoint=!0,this.snapToVertex=!0,this.layer=e}return e}();i.SnappingInfo=t})},"Mapping/modules/Snapping/SnappingLayerSelectorView":function(){define(["require","exports","geocortex/infrastructure/layerselector/LayerSelectorViewBase"],function(e,i,t){"use strict";var n=function(e){function i(){return null!==e&&e.apply(this,arguments)||this}return __extends(i,e),i.prototype.attach=function(i){i&&(e.prototype.attach.call(this,i),this.registerCommands())},i.prototype.registerCommands=function(){this.app.command("ActivateSelectLayersForSnapping").register(this,this.executeActivateSelectLayersForSnapping,this.canExecuteSnapping),this.app.command("DeactivateSelectLayersForSnapping").register(this,this.executeDeactivateSelectLayersForSnapping,this.canExecuteSnapping)},i.prototype.executeActivateSelectLayersForSnapping=function(){this.app.viewManager.activateView(this),this.viewModel.activateSelectLayersForSnapping()},i.prototype.executeDeactivateSelectLayersForSnapping=function(){this.app.viewManager.deactivateView(this),this.viewModel.deactivateSelectLayersForSnapping()},i.prototype.canExecuteSnapping=function(){return this.app.command("ActivateSnapping").canExecute()},i}(t.LayerSelectorViewBase);i.SnappingLayerSelectorView=n})},"Mapping/modules/Snapping/SnappingLayerSelectorViewModel":function(){define(["require","exports","geocortex/infrastructure/layerselector/LayerSelectorViewModelBase"],function(e,i,t){"use strict";var n=function(e){function i(i,t){var n=e.call(this,i,t)||this;return n._providerRegistered=!1,n._initializeHandler=null,n.selectAllButtonTitle.set(n.app.getResource(t,"language-layer-selector-snapping-select-all-tooltip")),n.clearAllButtonTitle.set(n.app.getResource(t,"language-layer-selector-snapping-clear-all-tooltip")),n}return __extends(i,e),i.prototype.initialize=function(i){var t=this;e.prototype.initialize.call(this,i),this.app.event("SnappingProviderRegistered").once(this,function(e){t._providerRegistered=!0,t._initializeHandler&&(t._initializeHandler(),t._initializeHandler=null)})},i.prototype.filter=function(e){if(e&&e.layer&&e.layer.gcxLayer){var i=e.layer.gcxLayer;return!!i&&i.snappable}},i.prototype.handleLayerStateChange=function(e){this._setLayerStateForSnapping(e)},i.prototype.handleAllLayersEnabled=function(){var e=this._getListedLayers();this.app.command("EnableAllLayersForSnapping").execute(e)},i.prototype.handleAllLayersDisabled=function(){var e=this._getListedLayers();this.app.command("DisableAllLayersForSnapping").execute(e)},i.prototype.onInitialized=function(e){var i=this;this._providerRegistered?this._handleInitialize(e):this._initializeHandler=function(){i._handleInitialize(e)}},i.prototype._handleMapServicesAdded=function(i){e.prototype._handleMapServicesAdded.call(this,i);for(var t=0,n=i.layers;t<n.length;t++){var a=n[t];a.snappable!==!1&&a.snappingEnabled&&this.app.command("RegisterSnappingLayer").execute(a)}},i.prototype._handleMapServiceRemoved=function(i){e.prototype._handleMapServiceRemoved.call(this,i);for(var t=0,n=i.layers;t<n.length;t++){var a=n[t];this.app.command("RemoveSnappingLayer").execute(a)}},i.prototype._handleInitialize=function(e){var i=e.filteredLayerSelectorLayerItems;i.forEach(function(e){if(e&&e.layer&&e.layer.gcxLayer){var i=e.layer.gcxLayer;e.isEnabled.set(i.snappingEnabled)}})},i.prototype._getListedLayers=function(){var e=[],i=this.layerSelector.filteredLayerSelectorLayerItems;return i.forEach(function(i){i&&i.layer&&i.layer.gcxLayer&&e.push(i.layer.gcxLayer)}),e},i.prototype.activateSelectLayersForSnapping=function(){this.app.event("SelectLayersForSnappingActivatedEvent").publish(this.layerSelector.filteredLayerSelectorLayerItems.slice(0))},i.prototype.deactivateSelectLayersForSnapping=function(){this.app.event("SelectLayersForSnappingDeactivatedEvent").publish(this.layerSelector.filteredLayerSelectorLayerItems.slice(0))},i.prototype._setLayerStateForSnapping=function(e){if(e&&e.layer&&e.layer.gcxLayer){var i=e.layer.gcxLayer;i?e.isEnabled.get()?this.app.command("EnableLayerForSnapping").execute(i):this.app.command("DisableLayerForSnapping").execute(i):this.app.trace.error("SnappingLayerSelectorViewModel: Could not handle layer state change. Layer not defined.")}},i}(t.LayerSelectorViewModelBase);i.SnappingLayerSelectorViewModel=n})},"Mapping/modules/Snapping/SnappingModule":function(){define(["require","exports","geocortex/framework/application/ModuleBase","./LayerSelectorForSnapping","geocortex/infrastructure/accessibility/InputMethod","geocortex/infrastructure/tools/DrawMode","geocortex/infrastructure/tools/MapTool","geocortex/infrastructure/FocusUtils","geocortex/essentials/utilities/GraphicsLayerUtilities","geocortex/infrastructure/GraphicsLayerUtils","geocortex/infrastructure/GraphicsLayerIds"],function(e,i,t,n,a,r,p,s,o,c,h){"use strict";var d=function(e){function i(){var i=null!==e&&e.apply(this,arguments)||this;return i._inputThrottleDelay=1e3/60,i._originPoint=null,i._originSnapPoint=null,i._timer=null,i._mouseInsideMapBounds=!1,i._snapSymbol=null,i._canSnap=!1,i._supportedDrawModes=[],i._enabled=!1,i._accessibleMode=!1,i._graphicsLayer=null,i._tempEditingLayer=null,i._toggleKey=null,i._isEditing=!1,i._supressNextDeactivatedEvent=!1,i._graphicEditingLayerRef=null,i._currentEditingGraphic=null,i._dummyGraphic=null,i._toolbar=null,i._mouseMoveToken=null,i._extentChangedToken=null,i._mouseOverToken=null,i._onKeyDown=null,i._graphicDrawToken=null,i._vertexMovedToken=null,i._editVertexMoveToken=null,i._vertexHandleShownToken=null,i._vertexHandleHiddenToken=null,i._esriEditVertexMovedToken=null,i._defaultRadiusBorderColor="#000000",i._defaultHoverColor="#ffffff",i._defaultPointColor="#ffffff",i._defaultSnappingPointColor="#ffffff",i._defaultHoverOpacity=.2,i._defaultPointSize=5,i._defaultBorderSize=1,i._defaultThreshold=25,i._defaultCancelKey=70,i}return __extends(i,e),i.prototype.initialize=function(i){var t=this;e.prototype.initialize.call(this,i),this._toggleKey=isNaN(parseInt(this.configuration.toggleKey+""))?this._defaultCancelKey:parseInt(this.configuration.toggleKey+""),this._threshold=isNaN(parseInt(this.configuration.threshold))?this._defaultThreshold:parseInt(this.configuration.threshold),this.layerSelectorForSnapping=new n.LayerSelectorForSnapping(this.app,this),this.app.event("SiteServiceLayersLoadedEvent").subscribe(this,function(e){t._initializeSnappingManager(),t._subscribeToMapEvents()}),this.configuration.supportedDrawModes&&(this._supportedDrawModes=this.configuration.supportedDrawModes);var a=this.configuration.radiusFillColor?this.configuration.radiusFillColor:this._defaultHoverColor,r=new esri.Color(a),p=r.toRgba(),s=isNaN(parseFloat(this.configuration.radiusFillOpacity))?this._defaultHoverOpacity:parseFloat(this.configuration.radiusFillOpacity);p[3]=s;var o=new esri.Color(p),c=this.configuration.pointColor?this.configuration.pointColor:this._defaultPointColor,h=isNaN(parseInt(this.configuration.pointSize))?this._defaultPointSize:parseInt(this.configuration.pointSize);this._snapSymbol=new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE,h,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new esri.Color(c),1),new esri.Color(c));var d=isNaN(parseInt(this.configuration.radiusBorderSize))?this._defaultBorderSize:parseInt(this.configuration.radiusBorderSize),l=this.configuration.radiusBorderColor?this.configuration.radiusBorderColor:this._defaultRadiusBorderColor;this._hoverGraphic=new esri.Graphic,this._hoverGraphic.setSymbol(new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE,2*this._threshold,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new esri.Color(l),d),o)),this._snapGraphic=new esri.Graphic,this._snapGraphic.setSymbol(this._snapSymbol),this._registerApplicationCommands(),this._subscribeToApplicationEvents(),this.app.map&&this.app.map.loaded?this._addKeyHandlers():this.app.event("MapLoadedEvent").once(this,function(e){t._addKeyHandlers()})},i.prototype._registerApplicationCommands=function(){this.app.command("ActivateSnapping").register(this,this._executeActivateSnapping,this._canExecuteSnapping),this.app.command("DeactivateSnapping").register(this,this._executeDeactivateSnapping,this._canExecuteSnapping),this.app.command("RegisterSnappingLayer").register(this,this._executeRegisterSnappingLayer),this.app.command("RegisterSnappingLayers").register(this,this._executeRegisterSnappingLayers),this.app.command("RemoveSnappingLayer").register(this,this._executeUnregisterSnappingLayer),this.app.command("RemoveSnappingLayers").register(this,this._executeUnregisterSnappingLayers)},i.prototype._subscribeToApplicationEvents=function(){var e=this;this.app.event("ActiveToolChangedEvent").subscribe(this,this._handleActiveToolChanged),this.app.event("GraphicDrawActivatedEvent").subscribe(this,function(i){e._handleGraphicDrawActivatedEvent(i)}),this.app.event("GraphicDrawDeactivatedEvent").subscribe(this,function(i){e._handleDrawDeactivatedEvent(i)}),this.app.event("GraphicEditActivatedEvent").subscribe(this,function(i){e._canSnap=!0,e._handleEditBegin(),e._subscribeMouseEvents(),e._supressNextDeactivatedEvent=!0,e._currentEditingGraphic=i.graphic,e._dummyGraphic=new esri.Graphic,e._toolbar=i.sender,e._graphicEditingLayerRef=i.graphic.getLayer(),e._enabled&&e._moveEditingGraphicToTempLayer()}),this.app.event("GraphicEditDeactivatedEvent").subscribe(this,function(i){e._canSnap=!1,e._handleEditEnd(),e._supressNextDeactivatedEvent=!1,e._currentEditingGraphic&&(e._returnEditingGraphicToOwner(!1),e._currentEditingGraphic=null,e._graphicEditingLayerRef=null,e._dummyGraphic=null,e._toolbar=null,e.app.trace.debug("[SnappingModule]: Graphic editing context cleaned up"))}),this.app.event("GraphicDrawAccessibleEditActivatedEvent").subscribe(this,function(i){e._canSnap=!0,e._handleEditBegin()}),this.app.event("GraphicDrawAccessibleEditDeactivatedEvent").subscribe(this,function(i){return e._supressNextDeactivatedEvent?void(e._supressNextDeactivatedEvent=!1):(e._canSnap=!1,void e._handleEditEnd())}),this.app.event("InputMethodChangedEvent").subscribe(this,function(i){var t=!1;i.newMethod===a.InputMethod.KEYBOARD&&(t=!0),e._accessibleMode!==t&&e._hideSnappingGraphics(),e._accessibleMode=t,e._subscribeToUIEvents()})},i.prototype._initializeSnappingManager=function(){this._graphicsLayer=c.getInternalGraphicsLayer(h.SNAPPING_HELPER_GRAPHICS_LAYER_ID,this.app,c.GraphicsLayerType.Pushpin),o.addToGraphicsLayerIdsToExclude([c.ExcludeFromEnum.ExportApplyStateName,c.ExcludeFromEnum.ExportMapTaskName,c.ExcludeFromEnum.WebMapName],h.SNAPPING_HELPER_GRAPHICS_LAYER_ID),this.app.map.addLayer(this._graphicsLayer),this._graphicsLayer.add(this._hoverGraphic),this._graphicsLayer.add(this._snapGraphic),this._hideSnappingGraphics();var e=this.configuration.snappingProvider;e&&(e.libraryId&&!this.app.allLibrariesLoaded?this._loadProviderWhenLibrariesDownloaded(e):this._loadProvider(e))},i.prototype._subscribeToMapEvents=function(){var e=this;this.app.map.on("layer-add-result",function(i){e.app.map.reorderLayer(e._graphicsLayer,e.app.map.graphicsLayerIds.length)})},i.prototype._loadProviderWhenLibrariesDownloaded=function(e){var i=this;this.app.event("ViewerLibrariesDownloadedEvent").once(this,function(){return i._loadProvider(e)})},i.prototype._loadProvider=function(e){var i=e.type,t=dojo.getObject(i);if(t){var n=new t(this.app,e.libraryId||this.libraryId);n.initialize(e),this._registerSnappingProvider(n)}},i.prototype._subscribeMouseEvents=function(){window.PointerEvent?this._addPointerMove():this._addMouseMove(),this._addMouseLeave(),this._addMouseOver()},i.prototype._removeMouseEvents=function(){this._removeEventListener(this.app.map.root,"pointermove",this._handlePointerMove),this._removeEsriHandle(this._mouseOverToken),this._removeEsriHandle(this._mouseMoveToken),this._removeJQueryHandle(this._mouseLeaveToken)},i.prototype._handleEditBegin=function(){var e=this;this._handleEditEnd(),this._editVertexMoveToken=this.app.event("EditVertexMovedEvent").subscribe(this,function(i){e._mouseInsideMapBounds=!0,e._handleInputMove(i)}),this._vertexHandleShownToken=this.app.event("VertexHandleShownEvent").subscribe(this,function(i){e._hideSnappingGraphics(),e._removeMouseEvents()}),this._vertexHandleHiddenToken=this.app.event("VertexHandleHiddenEvent").subscribe(this,function(){e._hideSnappingGraphics(),e._subscribeMouseEvents()}),this._esriEditVertexMovedToken=this.app.event("EditVertexHandleMovedEvent").subscribe(this,function(i){i&&i.geometry&&i.geometry instanceof esri.geometry.Point&&(e._mouseInsideMapBounds=!0,e._timer||(e._timer=setTimeout(function(){var t=i.getShape(),n=t.matrix.dx,a=t.matrix.dy,r=i.geometry,p=e.app.map.toScreen(r).offset(n,a),s={mapPoint:e.app.map.toMap(p),screenPoint:p};e._handleInputMove(s),e._clearTimeout()},e._inputThrottleDelay)))}),this._isEditing=!0},i.prototype._handleEditEnd=function(){this._hideSnappingGraphics(),this._removeGcxHandle("EditVertexMovedEvent",this._editVertexMoveToken),this._removeGcxHandle("VertexHandleShownEvent",this._vertexHandleShownToken),this._removeGcxHandle("VertexHandleHiddenEvent",this._vertexHandleHiddenToken),this._removeGcxHandle("EditVertexHandleMovedEvent",this._esriEditVertexMovedToken),this._isEditing=!1,this.snappingProvider.pauseSnapping()},i.prototype._subscribeAccessibilityEvents=function(){this._addVertexMoved()},i.prototype._removeAccessibilityEvents=function(){this._removeGcxHandle("GraphicVertexMovedEvent",this._vertexMovedToken)},i.prototype._handleGraphicDrawActivatedEvent=function(e){var i=e.geometryType;i===esri.toolbars.Draw.MULTI_POINT&&(i=r.DrawMode.MULTI_POINT),i&&this._drawModeSupported(i)?(this._canSnap=!0,this.snappingProvider.continueSnapping()):(this._canSnap=!1,this.snappingProvider.pauseSnapping())},i.prototype._handleDrawDeactivatedEvent=function(e){this._canSnap=!1,this.snappingProvider.pauseSnapping()},i.prototype._handleActiveToolChanged=function(e){if(!this.snappingProvider)return this._canSnap=!1,void this.app.trace.debug("[SnappingModule]: 'ActiveToolChangedEvent' cannot be handled by the module before a SnappingProvider is registered. Check to ensure 'SiteServiceLayersLoadedEvent' has fired.");if(!(e&&e.tool&&e.tool instanceof p.MapTool))return void(this._canSnap=!1);var i=e.tool;return"EditMarkup"===i.command||"DeleteMarkup"===i.command?void(this._canSnap=!1):void(this._drawModeSupported(i.drawMode)?(this._canSnap=!0,this.snappingProvider.continueSnapping()):(this._canSnap=!1,this.snappingProvider.pauseSnapping()))},i.prototype._drawModeSupported=function(e){return this._supportedDrawModes.indexOf(e?e.toUpperCase():e)>-1},i.prototype._registerSnappingProvider=function(e){this.snappingProvider=e,this.app.command("ActivateSnapping").raiseCanExecuteChanged(),this.app.event("SnappingProviderRegistered").publish(this.snappingProvider)},i.prototype._subscribeToUIEvents=function(){this._enabled&&(this._accessibleMode?(this._subscribeAccessibilityEvents(),this._removeMouseEvents(),this._mouseInsideMapBounds=!0):(this._subscribeMouseEvents(),this._removeAccessibilityEvents()),this._addMapStateChangedEvents())},i.prototype._executeActivateSnapping=function(){this._executeDeactivateSnapping(),this._enabled=!0,this.snappingProvider.activate(this._threshold),this._canSnap&&(this.snappingProvider.pauseSnapping(),this.snappingProvider.continueSnapping()),this._subscribeToUIEvents(),this.app.command("ScreenReaderNarrate").execute(this.app.getResource(this.libraryId,"language-snapping-activated")),this._isEditing&&(this.app.trace.debug("[SnappingModule]: Snapping enabled mid-edit"),this._handleEditBegin(),this._subscribeMouseEvents(),this._currentEditingGraphic&&this._moveEditingGraphicToTempLayer())},i.prototype._canExecuteSnapping=function(){if(this._canSnap)return!0;if(!(this.app.toolRegistry.getActiveTool()instanceof p.MapTool))return!1;var e=this.app.toolRegistry.getActiveTool();return!(!this.snappingProvider||!this._drawModeSupported(e.drawMode))},i.prototype._executeDeactivateSnapping=function(){this._enabled&&this.app.command("ScreenReaderNarrate").execute(this.app.getResource(this.libraryId,"language-snapping-deactivated")),this._enabled=!1,this.snappingProvider.deactivate(),this._killOffSnapping(),this._hideSnappingGraphics(),this._raiseSnappingInputMovedEvent(null,null),s.focusOnMap(this.app.map),this._currentEditingGraphic&&this._returnEditingGraphicToOwner()},i.prototype._executeRegisterSnappingLayers=function(e){var i=this;e.forEach(function(e){i._readerLayerRegisterWrapper(e)})},i.prototype._executeRegisterSnappingLayer=function(e){this._readerLayerRegisterWrapper(e)},i.prototype._executeUnregisterSnappingLayer=function(e){this._readerLayerUnregisterWrapper(e)},i.prototype._executeUnregisterSnappingLayers=function(e){var i=this;e.forEach(function(e){i._readerLayerUnregisterWrapper(e)})},i.prototype._readerLayerRegisterWrapper=function(e){var i=this.snappingProvider.registerLayer(e);i&&this.app.command("ScreenReaderNarrate").execute(this.app.getResource(this.libraryId,"language-snapping-layer-registered").format(e.displayName))},i.prototype._readerLayerUnregisterWrapper=function(e){this.snappingProvider.unregisterLayer(e),this.app.command("ScreenReaderNarrate").execute(this.app.getResource(this.libraryId,"language-snapping-layer-unregistered").format(e.displayName))},i.prototype._clearTimeout=function(){this._timer&&(clearTimeout(this._timer),this._timer=null)},i.prototype._addVertexMoved=function(){var e=this;this._removeGcxHandle("GraphicVertexMovedEvent",this._vertexMovedToken),this._vertexMovedToken=this.app.event("GraphicVertexMovedEvent").subscribe(this,function(i){e._handleInputMove(i)})},i.prototype._addMouseLeave=function(){var e=this;this._removeJQueryHandle(this._mouseLeaveToken),this._mouseLeaveToken=$(this.app.map.root).mouseleave(function(){e._clearTimeout(),e._hideSnappingGraphics(),e.snappingProvider.pauseSnapping(),e._mouseInsideMapBounds=!1})},i.prototype._addPointerMove=function(){var e=this;this._removeEventListener(this.app.map.root,"pointermove",this._handlePointerMove),this._addEventListener(this.app.map.root,"pointermove",function(i){e._handlePointerMove(i)})},i.prototype._handlePointerMove=function(e){var i=this;e&&(this._timer||(this._timer=setTimeout(function(){var t=e.clientX-i.app.map.root.getBoundingClientRect().left,n=e.clientY-i.app.map.root.getBoundingClientRect().top,a=i.app.map.toMap(new esri.geometry.ScreenPoint(t,n)),r={mapPoint:a,screenPoint:i.app.map.toScreen(a)};i._handleInputMove(r),i._clearTimeout()},this._inputThrottleDelay)))},i.prototype._addMouseOver=function(){var e=this;this._removeEsriHandle(this._mouseOverToken),this._mouseOverToken=this.app.map.on("mouse-over",function(i){e._mouseInsideMapBounds=!0,e._timer||(e._timer=setTimeout(function(){e._handleInputMove(i),e._clearTimeout()},e._inputThrottleDelay))})},i.prototype._addMouseMove=function(){var e=this;this._removeEsriHandle(this._mouseMoveToken),this._mouseMoveToken=this.app.map.on("mouse-move",function(i){e._mouseInsideMapBounds=!0,e._timer||(e._timer=setTimeout(function(){e._handleInputMove(i),e._clearTimeout()},e._inputThrottleDelay))})},i.prototype._addMapStateChangedEvents=function(){var e=this;this._removeEsriHandle(this._extentChangedToken),this._extentChangedToken=this.app.map.on("extent-change",function(i){e.snappingProvider.loadForExtent(i.extent),e._originPoint=null,e._originSnapPoint=null})},i.prototype._removeGcxHandle=function(e,i){e&&i&&(this.app.event(e).unsubscribe(i),i=null)},i.prototype._addKeyHandlers=function(){var e=this;this._removeEsriHandle(this._onKeyDown),this._onKeyDown=this.app.map.on("key-down",function(i){e._onSnapKeyDownHandler(i)})},i.prototype._onSnapKeyDownHandler=function(e){e.keyCode===this._toggleKey&&(this._enabled?this.app.command("DeactivateSnapping").execute():this.app.command("ActivateSnapping").execute())},i.prototype._killOffSnapping=function(){this._removeMouseEvents(),this._removeAccessibilityEvents(),this._removeEsriHandle(this._graphicDrawToken),this._removeEsriHandle(this._extentChangedToken)},i.prototype._removeEsriHandle=function(e){e&&(e.remove(),e=null)},i.prototype._removeJQueryHandle=function(e){e&&(e.off(),e=null)},i.prototype._addSnappingGraphics=function(e,i){if(void 0===i&&(i=null),i||(i=e),this._originPoint){var t=this.app.map.toScreen(i),n=t.x-this._originSnapPoint.x,a=t.y-this._originSnapPoint.y,r=dojox.gfx.matrix.translate(n,a),p=this._snapGraphic.getDojoShape();p&&p.setTransform(r),t=this.app.map.toScreen(e),n=t.x-this._originPoint.x,a=t.y-this._originPoint.y,r=dojox.gfx.matrix.translate(n,a),p=this._hoverGraphic.getDojoShape(),p&&p.setTransform(r)}else this._originPoint=this.app.map.toScreen(e),this._originSnapPoint=this.app.map.toScreen(i),this._snapGraphic.setGeometry(i),this._hoverGraphic.setGeometry(e);this._snapGraphic.visible||this._snapGraphic.show(),this._hoverGraphic.visible||this._hoverGraphic.show(),$(this._snapGraphic.getNode()).css("pointer-events","none"),$(this._hoverGraphic.getNode()).css("pointer-events","none")},i.prototype._hideSnappingGraphics=function(){this._originPoint=null,this._originSnapPoint=null,this._hoverGraphic.visible&&this._hoverGraphic.hide(),this._snapGraphic.visible&&this._snapGraphic.hide()},i.prototype._handleInputMove=function(e){var i=this;if(this._enabled)return this._canSnap?void(e&&e.screenPoint&&this._mouseInsideMapBounds&&(this.snappingProvider.continueSnapping(),this.snappingProvider.provideSnappingPoint(e.screenPoint).then(function(t){t?(i._addSnappingGraphics(e.mapPoint,t),i._raiseSnappingInputMovedEvent(t,e.mapPoint),i.app.command("ScreenReaderNarrate").execute(i.app.getResource(i.libraryId,"language-snapping-point-found"))):(i._addSnappingGraphics(e.mapPoint,null),i._raiseSnappingInputMovedEvent(null,e.mapPoint))})["catch"](function(t){i.app.trace.error("Failed to find a snapping point: {0}".format(t&&t.message?t.message:"Undetermined cause")),i.app.command("ScreenReaderNarrate").execute(i.app.getResource(i.libraryId,"language-snapping-error")),i._raiseSnappingInputMovedEvent(null,e.mapPoint)}))):void this._hideSnappingGraphics()},i.prototype._raiseSnappingInputMovedEvent=function(e,i){var t={snappingPoint:e,inputPoint:i};this.app.event("SnappingFeedbackEvent").publish(t)},i.prototype._addEventListener=function(e,i,t){e.addEventListener?e.addEventListener(i,t,!1):e.attachEvent&&e.attachEvent("on"+i,t)},i.prototype._removeEventListener=function(e,i,t){
e.removeEventListener?e.removeEventListener(i,t,!1):e.detachEvent&&e.detachEvent("on"+i,t)},i.prototype._moveEditingGraphicToTempLayer=function(){if(this._graphicEditingLayerRef&&this._currentEditingGraphic&&this._canSwapEditingGraphic(this._graphicEditingLayerRef)&&(this.app.trace.debug("[SnappingModule]: Attempting to move the editing graphic from '{0}' to the temporary layer".format(this._graphicEditingLayerRef.id)),this._tempEditingLayer||(this._tempEditingLayer=c.getInternalGraphicsLayer(h.TEMP_SNAPPING_EDITOR_LAYER_ID,this.app,c.GraphicsLayerType.Pushpin)),this._graphicEditingLayerRef.remove(this._currentEditingGraphic),this._graphicEditingLayerRef.add(this._dummyGraphic),this._tempEditingLayer.add(this._currentEditingGraphic),this._toolbar&&this._toolbar.refresh(),this.app.clickableGraphics.isLayerRegistered(this._graphicEditingLayerRef))){var e=this.app.clickableGraphics.getLayerInfo(this._graphicEditingLayerRef);this.app.clickableGraphics.register(this._tempEditingLayer,e)}},i.prototype._returnEditingGraphicToOwner=function(e){void 0===e&&(e=!0),this._graphicEditingLayerRef&&this._currentEditingGraphic&&this._tempEditingLayer&&this._canSwapEditingGraphic(this._graphicEditingLayerRef)&&(this.app.trace.debug("[SnappingModule]: Returning the editing graphic back to '{0}'".format(this._graphicEditingLayerRef.id)),this._tempEditingLayer.remove(this._currentEditingGraphic),this._graphicEditingLayerRef.remove(this._dummyGraphic),this._graphicEditingLayerRef.add(this._currentEditingGraphic),this.app.clickableGraphics.isLayerRegistered(this._tempEditingLayer)&&this.app.clickableGraphics.unregister(this._tempEditingLayer),c.removeInternalGraphicsLayer(this._tempEditingLayer.id,this.app,c.GraphicsLayerType.Pushpin),this._tempEditingLayer.clear(),this._tempEditingLayer=null,e&&this._toolbar&&this._toolbar.refresh())},i.prototype._canSwapEditingGraphic=function(e){var i=!1,t=[];return this.snappingProvider&&this.snappingProvider.providerConfiguration&&this.snappingProvider.providerConfiguration.configuration&&this.snappingProvider.providerConfiguration.configuration.graphicsLayers&&(t=this.snappingProvider.providerConfiguration.configuration.graphicsLayers),e&&e instanceof esri.layers.GraphicsLayer&&t.indexOf(e.id)>-1&&(i=!0),i},i}(t.ModuleBase);i.SnappingModule=d})},"Mapping/modules/Snapping/SnappingModuleConfiguration":function(){define(["require","exports"],function(e,i){"use strict"})},"Mapping/modules/Snapping/SnappingOptions":function(){define(["require","exports"],function(e,i){"use strict"})},"Mapping/modules/Snapping/SnappingProviderConfiguration":function(){define(["require","exports"],function(e,i){"use strict"})}}}),define(["Mapping/modules/Snapping/EsriSnappingProvider","Mapping/modules/Snapping/LayerSelectorForSnapping","Mapping/modules/Snapping/SnappingInfo","Mapping/modules/Snapping/SnappingLayerSelectorView","Mapping/modules/Snapping/SnappingLayerSelectorViewModel","Mapping/modules/Snapping/SnappingModule"],function(e,i,t,n,a,r){shim(e,"geocortex.essentialsHtmlViewer.mapping.modules.snapping.EsriSnappingProvider",e.EsriSnappingProvider),shim(i,"geocortex.essentialsHtmlViewer.mapping.modules.snapping.LayerSelectorForSnapping",i.LayerSelectorForSnapping),shim(t,"geocortex.essentialsHtmlViewer.mapping.modules.snapping.SnappingInfo",t.SnappingInfo),shim(n,"geocortex.essentialsHtmlViewer.mapping.modules.snapping.SnappingLayerSelectorView",n.SnappingLayerSelectorView),shim(a,"geocortex.essentialsHtmlViewer.mapping.modules.snapping.SnappingLayerSelectorViewModel",a.SnappingLayerSelectorViewModel),shim(r,"geocortex.essentialsHtmlViewer.mapping.modules.snapping.SnappingModule",r.SnappingModule)});