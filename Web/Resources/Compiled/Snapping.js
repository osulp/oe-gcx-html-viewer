!function(){function p(e,i,t){if("string"==typeof e&&(t=i,i=e),void 0!==t)for(var n=i.split("."),a=null,r=window,p=0,o=n.length;p<o;p++)a=n[p],p==o-1?r[a]=t:r[a]||(r[a]={}),r=r[a];else console.warn("Undefined shim for: "+i)}require({cache:{"Mapping/modules/Snapping/EsriSnappingProvider":function(){define(["require","exports","./SnappingInfo","geocortex/infrastructure/ArrayUtils","geocortex/infrastructure/TaskUtils","geocortex/essentials/utilities/GraphicsLayerUtilities","geocortex/infrastructure/GraphicsLayerUtils","geocortex/infrastructure/GraphicsLayerIds"],function(e,i,n,t,s,a,r,p){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var o=(c.prototype.initialize=function(e){this.providerConfiguration=e,this._convertedSnappingGraphics=r.getInternalGraphicsLayer(p.SNAPPING_GRAPHICS_LAYER_ID,this.app,r.GraphicsLayerType.Pushpin),a.addToGraphicsLayerIdsToExclude([r.ExcludeFromEnum.ExportMapTaskName,r.ExcludeFromEnum.ExportApplyStateName,r.ExcludeFromEnum.WebMapName],p.SNAPPING_GRAPHICS_LAYER_ID),this._handleGraphicsLayer(this._convertedSnappingGraphics),this._listenForGraphicLayers()},c.prototype.activate=function(e){this._threshold=e,this.app.map.enableSnapping(this._getSnappingInitOptions()),this._refreshDynamicSnappingData(),this._active=!0},c.prototype._getSnappingInitOptions=function(){return{map:this.app.map,alwaysSnap:!0,snapKey:-1,tolerance:this._threshold,snapPointSymbol:new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_PATH,0,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new esri.Color([0,0,0,0]),0),new esri.Color([0,0,0,0])),layerInfos:this._cloneLayerInfos()}},c.prototype._cloneLayerInfos=function(){var t=[];return this._loadConfiguredDefaultGraphicsLayers(),this._snappingLayerInfos.forEach(function(e){var i=new n.SnappingInfo(e.layer);i.snapToEdge=e.snapToEdge,i.snapToPoint=e.snapToPoint,i.snapToVertex=e.snapToVertex,t.push(e)}),t},c.prototype.deactivate=function(){this.app.map.disableSnapping(),this._convertedSnappingGraphics.clear(),this._snappingManagerReference&&(this._snappingManagerReference.destroy(),this._snappingManagerReference=null),this._active=!1},c.prototype._snappingWithinMap=function(e){var i=!0;return e.x<this._threshold?i=!1:e.y<this._threshold?i=!1:e.y>this.app.map.height-this._threshold?i=!1:e.x>this.app.map.width-this._threshold&&(i=!1),i},c.prototype.provideSnappingPoint=function(e){var n=this;return new Promise(function(i,t){n._paused&&i(null),n._snappingWithinMap(e)?(n.continueSnapping(),n.app.map.snappingManager.getSnappingPoint(e).then(function(e){i(e||null)},function(e){t(e)})):(n.pauseSnapping(),i(null))})},c.prototype.registerLayer=function(e,i){if(!e)throw new Error("Must specify a layer for snapping.");return e.snappable?e.mapService.serviceLayer instanceof esri.layers.GraphicsLayer?(this._handleGraphicsLayer(e.mapService.serviceLayer,i),this._refreshLayerInfos(),!0):e.mapService.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer?(this._handleDynamicLayer(e),!0):(this.app.trace.warning("Cannot snap to layer {0}, must be of Graphic or Dynamic type".format(e.displayName)),!1):(this.app.trace.warning("Cannot snap to layer {0}, must be set as snappable in REST Manager".format(e.displayName)),!1)},c.prototype.unregisterLayer=function(e){e.mapService.serviceLayer instanceof esri.layers.GraphicsLayer?this._handleRemoveGraphicsLayer(e.mapService.serviceLayer):e.mapService.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer&&this._handleRemoveDynamicLayer(e),this._refreshLayerInfos()},c.prototype.getSnappableLayers=function(e){var i=e.mapInfo.getLayerInfos().filter(function(e){return e.gcxLayer.snappable});return i=t.ArrayUtils.sortBy(i,function(e){return e.displayName})},c.prototype.continueSnapping=function(){this._snappingManagerReference&&!this.app.map.snappingManager&&this._paused&&(this.app.map.enableSnapping(this._snappingManagerReference),this._snappingManagerReference=null),this.app.map.snappingManager&&this._paused&&(this.app.map.snappingManager._killOffSnapping(),this.app.map.snappingManager._setUpSnapping(),this.app.map.snappingManager._activateSnapping(),this.app.map.snappingManager._startSelectionLayerQuery(),this._refreshLayerInfos()),this._refreshOnNextContinue&&this._active&&(this._refreshDynamicSnappingData(),this._refreshOnNextContinue=!1),this._paused=!1},c.prototype.pauseSnapping=function(){this.app.map.snappingManager&&(this.app.map.snappingManager._killOffSnapping(),this.app.map.snappingManager._deactivateSnapping(),this.app.map.snappingManager._stopSelectionLayerQuery(),this._snappingManagerReference=this.app.map.snappingManager,this.app.map.snappingManager=null),this._paused=!0},c.prototype._isLayerVisible=function(e){if(!e.isVisible())return!1;if(null!==e.maxScale&&void 0!==e.maxScale&&null!==e.minScale&&void 0!==e.minScale){var i=this.app.map.getScale();if(i<e.maxScale||i>e.minScale)return!1}return!0},c.prototype._handleGraphicsLayer=function(e,i){this._removeInfo(e),this.app.trace.debug("[EsriSnappingProvider] Graphics Layer handled {0}".format(e.id));var t=new n.SnappingInfo(e);i&&(t.snapToEdge=i.edge,t.snapToPoint=i.point,t.snapToVertex=i.vertex),this._snappingLayerInfos.push(t),this._refreshLayerInfos()},c.prototype._listenForGraphicLayers=function(){var i=this;this.app.map.on("layer-add-result",function(e){e&&e.layer&&e.layer instanceof esri.layers.GraphicsLayer&&i._loadConfiguredDefaultGraphicsLayers()})},c.prototype._refreshLayerInfos=function(){this.app.map.snappingManager&&this.app.map.snappingManager.setLayerInfos(this._cloneLayerInfos())},c.prototype._handleRemoveGraphicsLayer=function(e){this._removeInfo(e)},c.prototype._handleDynamicLayer=function(e){this._managedDynamicLayers.indexOf(e)<0&&(this._managedDynamicLayers.push(e),this._active&&!this._paused?this._refreshDynamicSnappingData():this._refreshOnNextContinue=!0)},c.prototype._handleRemoveDynamicLayer=function(e){var i=this._managedDynamicLayers.indexOf(e);-1<i&&(this._managedDynamicLayers.splice(i,1),this._active&&!this._paused?this._refreshDynamicSnappingData():this._refreshOnNextContinue=!0)},c.prototype._refreshDynamicSnappingData=function(){this.loadForExtent(this.app.map.extent)},c.prototype._removeInfo=function(e){for(var i=0;i<this._snappingLayerInfos.length;i++)if(this._snappingLayerInfos[i].layer===e){this._snappingLayerInfos.splice(i,1);break}},c.prototype.loadForExtent=function(e){var i=this;this._convertedSnappingGraphics.clear(),this._refreshOnNextContinue=!1;for(var t=[],n=0;n<this._managedDynamicLayers.length;n++)this._isLayerVisible(this._managedDynamicLayers[n])&&t.push(this._managedDynamicLayers[n]);for(n=0;n<t.length;n++){var a=t[n];if(a){var r=new esri.tasks.Query;r.geometry=e,r.outSpatialReference=this.app.map.spatialReference,r.returnGeometry=!0;var p="1=1";if(a.mapService&&a.mapService.serviceLayer&&a.mapService.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer){var o=(a.mapService.serviceLayer.layerDefinitions||[])[parseInt(a.id)];o&&(p=o)}r.where=p,s.getQueryTask(a).execute(r,function(e){i._queryCompleted(e,a)},function(e){i._queryError(e)})}}},c.prototype._queryCompleted=function(e,i){if(e&&e.features)for(var t=0;t<e.features.length;t++){var n=e.features[t];n&&this._convertedSnappingGraphics.add(n)}},c.prototype._queryError=function(e){this.app.trace.error("An error occured while downloading snapping points: {0}".format(e&&e.message?e.message:"Undetermined cause"))},c.prototype._loadConfiguredDefaultGraphicsLayers=function(){var t=this;this.providerConfiguration&&this.providerConfiguration.configuration&&this.providerConfiguration.configuration.graphicsLayers&&this.providerConfiguration.configuration.graphicsLayers.forEach(function(e){var i=t.app.map.getLayer(e);i&&i instanceof esri.layers.GraphicsLayer&&t._loadedDefaultLayers.indexOf(i)<0&&(t._loadedDefaultLayers.push(i),t._handleGraphicsLayer(i))})},c);function c(e,i){this._convertedSnappingGraphics=null,this._managedDynamicLayers=[],this._loadedDefaultLayers=[],this._snappingLayerInfos=[],this._paused=!1,this._snappingManagerReference=null,this._active=!1,this._refreshOnNextContinue=!1,this.app=e,this.libraryId=i,this.name="EsriSnappingProvider"}i.EsriSnappingProvider=o})},"Mapping/modules/Snapping/LayerSelectorForSnapping":function(){define(["require","exports"],function(e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var t=(n.prototype._registerApplicationCommands=function(){this.app.command("EnableAllLayersForSnapping").register(this,this._executeEnableAllLayersForSnapping),this.app.command("DisableAllLayersForSnapping").register(this,this._executeDisableAllLayersForSnapping),this.app.command("EnableLayerForSnapping").register(this,this._executeEnableLayerForSnapping),this.app.command("DisableLayerForSnapping").register(this,this._executeDisableLayerForSnapping)},n.prototype._executeEnableLayerForSnapping=function(e){this.app.command("RegisterSnappingLayer").execute(e)},n.prototype._executeEnableAllLayersForSnapping=function(e){this.app.command("RegisterSnappingLayers").execute(e)},n.prototype._executeDisableLayerForSnapping=function(e){this.app.command("RemoveSnappingLayer").execute(e)},n.prototype._executeDisableAllLayersForSnapping=function(e){this.app.command("RemoveSnappingLayers").execute(e)},n);function n(e,i){this.app=e,this.snappingModule=i,this._registerApplicationCommands()}i.LayerSelectorForSnapping=t})},"Mapping/modules/Snapping/SnappingInfo":function(){define(["require","exports"],function(e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});function t(e){this.snapToEdge=!0,this.snapToPoint=!0,this.snapToVertex=!0,this.layer=e}i.SnappingInfo=t})},"Mapping/modules/Snapping/SnappingLayerSelectorView":function(){var n,p=this&&this.__extends||(n=function(e,i){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,i){e.__proto__=i}||function(e,i){for(var t in i)i.hasOwnProperty(t)&&(e[t]=i[t])})(e,i)},function(e,i){function t(){this.constructor=e}n(e,i),e.prototype=null===i?Object.create(i):(t.prototype=i.prototype,new t)});define(["require","exports","geocortex/infrastructure/layerselector/LayerSelectorViewBase"],function(e,i,t){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n,a=(n=t.LayerSelectorViewBase,p(r,n),r.prototype.attach=function(e){e&&(n.prototype.attach.call(this,e),this.registerCommands())},r.prototype.registerCommands=function(){var e=this;this.app.command("ActivateSelectLayersForSnapping").register(this,this.executeActivateSelectLayersForSnapping,this.canExecuteSnapping),this.app.command("DeactivateSelectLayersForSnapping").register(this,this.executeDeactivateSelectLayersForSnapping,this.canExecuteSnapping),this.app.command("ActivateSnapping").preExecute.subscribe(this,function(){e.viewModel.layerSelectorInitialized.get()||e.viewModel.setupLayerSelector()})},r.prototype.executeActivateSelectLayersForSnapping=function(){this.app.viewManager.activateView(this),this.viewModel.activateSelectLayersForSnapping()},r.prototype.executeDeactivateSelectLayersForSnapping=function(){this.app.viewManager.deactivateView(this),this.viewModel.deactivateSelectLayersForSnapping()},r.prototype.canExecuteSnapping=function(){return this.app.command("ActivateSnapping").canExecute()},r);function r(){return null!==n&&n.apply(this,arguments)||this}i.SnappingLayerSelectorView=a})},"Mapping/modules/Snapping/SnappingLayerSelectorViewModel":function(){var n,p=this&&this.__extends||(n=function(e,i){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,i){e.__proto__=i}||function(e,i){for(var t in i)i.hasOwnProperty(t)&&(e[t]=i[t])})(e,i)},function(e,i){function t(){this.constructor=e}n(e,i),e.prototype=null===i?Object.create(i):(t.prototype=i.prototype,new t)});define(["require","exports","geocortex/infrastructure/layerselector/LayerSelectorViewModelBase"],function(e,i,t){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var a,n=(a=t.LayerSelectorViewModelBase,p(r,a),r.prototype.initialize=function(e){var i=this;a.prototype.initialize.call(this,e),this.app.event("SnappingProviderRegistered").once(this,function(e){i._providerRegistered=!0,i._initializeHandler&&(i._initializeHandler(),i._initializeHandler=null)})},r.prototype.filter=function(e){if(e&&e.layer&&e.layer.gcxLayer){var i=e.layer.gcxLayer;return!!i&&i.snappable}},r.prototype.handleLayerStateChange=function(e){this._setLayerStateForSnapping(e)},r.prototype.handleAllLayersEnabled=function(){var e=this._getListedLayers();this.app.command("EnableAllLayersForSnapping").execute(e)},r.prototype.handleAllLayersDisabled=function(){var e=this._getListedLayers();this.app.command("DisableAllLayersForSnapping").execute(e)},r.prototype.onInitialized=function(e){var i=this;this._providerRegistered?this._handleInitialize(e):this._initializeHandler=function(){i._handleInitialize(e)}},r.prototype._handleMapServicesAdded=function(e){a.prototype._handleMapServicesAdded.call(this,e);for(var i=0,t=e.layers;i<t.length;i++){var n=t[i];!1!==n.snappable&&n.snappingEnabled&&this.app.command("RegisterSnappingLayer").execute(n)}},r.prototype._handleMapServiceRemoved=function(e){a.prototype._handleMapServiceRemoved.call(this,e);for(var i=0,t=e.layers;i<t.length;i++){var n=t[i];this.app.command("RemoveSnappingLayer").execute(n)}},r.prototype._handleInitialize=function(e){e.filteredLayerSelectorLayerItems.forEach(function(e){if(e&&e.layer&&e.layer.gcxLayer){var i=e.layer.gcxLayer;e.isEnabled.set(i.snappingEnabled)}})},r.prototype._getListedLayers=function(){var i=[];return this.layerSelector.filteredLayerSelectorLayerItems.forEach(function(e){e&&e.layer&&e.layer.gcxLayer&&i.push(e.layer.gcxLayer)}),i},r.prototype.activateSelectLayersForSnapping=function(){this.app.event("SelectLayersForSnappingActivatedEvent").publish(this.layerSelector.filteredLayerSelectorLayerItems.slice(0))},r.prototype.deactivateSelectLayersForSnapping=function(){this.app.event("SelectLayersForSnappingDeactivatedEvent").publish(this.layerSelector.filteredLayerSelectorLayerItems.slice(0))},r.prototype._setLayerStateForSnapping=function(e){if(e&&e.layer&&e.layer.gcxLayer){var i=e.layer.gcxLayer;i?e.isEnabled.get()?this.app.command("EnableLayerForSnapping").execute(i):this.app.command("DisableLayerForSnapping").execute(i):this.app.trace.error("SnappingLayerSelectorViewModel: Could not handle layer state change. Layer not defined.")}},r);function r(e,i){var t=a.call(this,e,i)||this;return t._providerRegistered=!1,t._initializeHandler=null,t.selectAllButtonTitle.set(t.app.getResource(i,"language-layer-selector-snapping-select-all-tooltip")),t.clearAllButtonTitle.set(t.app.getResource(i,"language-layer-selector-snapping-clear-all-tooltip")),t}i.SnappingLayerSelectorViewModel=n})},"Mapping/modules/Snapping/SnappingModule":function(){var n,g=this&&this.__extends||(n=function(e,i){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,i){e.__proto__=i}||function(e,i){for(var t in i)i.hasOwnProperty(t)&&(e[t]=i[t])})(e,i)},function(e,i){function t(){this.constructor=e}n(e,i),e.prototype=null===i?Object.create(i):(t.prototype=i.prototype,new t)});define(["require","exports","geocortex/framework/application/ModuleBase","./LayerSelectorForSnapping","geocortex/infrastructure/accessibility/InputMethod","geocortex/infrastructure/tools/DrawMode","geocortex/infrastructure/tools/MapTool","geocortex/infrastructure/FocusUtils","geocortex/essentials/utilities/GraphicsLayerUtilities","geocortex/infrastructure/GraphicsLayerUtils","geocortex/infrastructure/GraphicsLayerIds"],function(e,i,t,h,n,a,r,p,o,s,c){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var l,d=(l=t.ModuleBase,g(u,l),u.prototype.initialize=function(e){var i=this;l.prototype.initialize.call(this,e),this._toggleKey=isNaN(parseInt(this.configuration.toggleKey+"",10))?this._defaultCancelKey:parseInt(this.configuration.toggleKey+"",10),this._threshold=isNaN(parseInt(this.configuration.threshold,10))?this._defaultThreshold:parseInt(this.configuration.threshold,10),this.layerSelectorForSnapping=new h.LayerSelectorForSnapping(this.app,this),this.app.waitUntilSiteServiceLayersLoaded().then(function(){i._initializeSnappingManager(),i._subscribeToMapEvents()}),this.configuration.supportedDrawModes&&(this._supportedDrawModes=this.configuration.supportedDrawModes);var t=this.configuration.radiusFillColor?this.configuration.radiusFillColor:this._defaultHoverColor,n=new esri.Color(t).toRgba(),a=isNaN(parseFloat(this.configuration.radiusFillOpacity))?this._defaultHoverOpacity:parseFloat(this.configuration.radiusFillOpacity);n[3]=a;var r=new esri.Color(n),p=this.configuration.pointColor?this.configuration.pointColor:this._defaultPointColor,o=isNaN(parseInt(this.configuration.pointSize,10))?this._defaultPointSize:parseInt(this.configuration.pointSize,10);this._snapSymbol=new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE,o,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new esri.Color(p),1),new esri.Color(p));var s=isNaN(parseInt(this.configuration.radiusBorderSize,10))?this._defaultBorderSize:parseInt(this.configuration.radiusBorderSize,10),c=this.configuration.radiusBorderColor?this.configuration.radiusBorderColor:this._defaultRadiusBorderColor;this._hoverGraphic=new esri.Graphic,this._hoverGraphic.setSymbol(new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE,2*this._threshold,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new esri.Color(c),s),r)),this._snapGraphic=new esri.Graphic,this._snapGraphic.setSymbol(this._snapSymbol),this._registerApplicationCommands(),this._subscribeToApplicationEvents(),this.app.map&&this.app.map.loaded?this._addKeyHandlers():this.app.event("MapLoadedEvent").once(this,function(){i._addKeyHandlers()})},u.prototype._registerApplicationCommands=function(){this.app.command("ActivateSnapping").register(this,this._executeActivateSnapping,this._canExecuteSnapping),this.app.command("DeactivateSnapping").register(this,this._executeDeactivateSnapping,this._canExecuteSnapping),this.app.command("RegisterSnappingLayer").register(this,this._executeRegisterSnappingLayer),this.app.command("RegisterSnappingLayers").register(this,this._executeRegisterSnappingLayers),this.app.command("RemoveSnappingLayer").register(this,this._executeUnregisterSnappingLayer),this.app.command("RemoveSnappingLayers").register(this,this._executeUnregisterSnappingLayers)},u.prototype._subscribeToApplicationEvents=function(){var t=this;this.app.event("ActiveToolChangedEvent").subscribe(this,this._handleActiveToolChanged),this.app.event("GraphicDrawActivatedEvent").subscribe(this,function(e){t._handleGraphicDrawActivatedEvent(e)}),this.app.event("GraphicDrawDeactivatedEvent").subscribe(this,function(e){t._handleDrawDeactivatedEvent(e)}),this.app.event("GraphicEditActivatedEvent").subscribe(this,function(e){t._canSnap=!0,t._handleEditBegin(),t._subscribeMouseEvents(),t._supressNextDeactivatedEvent=!0,t._currentEditingGraphic=e.graphic,t._dummyGraphic=new esri.Graphic,t._toolbar=e.sender,t._graphicEditingLayerRef=e.graphic.getLayer(),t._enabled&&t._moveEditingGraphicToTempLayer()}),this.app.event("GraphicEditDeactivatedEvent").subscribe(this,function(e){t._canSnap=!1,t._handleEditEnd(),t._supressNextDeactivatedEvent=!1,t._currentEditingGraphic&&(t._returnEditingGraphicToOwner(!1),t._currentEditingGraphic=null,t._graphicEditingLayerRef=null,t._dummyGraphic=null,t._toolbar=null,t.app.trace.debug("[SnappingModule]: Graphic editing context cleaned up"))}),this.app.event("GraphicDrawAccessibleEditActivatedEvent").subscribe(this,function(e){t._canSnap=!0,t._handleEditBegin()}),this.app.event("GraphicDrawAccessibleEditDeactivatedEvent").subscribe(this,function(e){t._supressNextDeactivatedEvent?t._supressNextDeactivatedEvent=!1:(t._canSnap=!1,t._handleEditEnd())}),this.app.event("InputMethodChangedEvent").subscribe(this,function(e){var i=!1;e.newMethod===n.InputMethod.KEYBOARD&&(i=!0),t._accessibleMode!==i&&t._hideSnappingGraphics(),t._accessibleMode=i,t._subscribeToUIEvents()})},u.prototype._initializeSnappingManager=function(){this._graphicsLayer=s.getInternalGraphicsLayer(c.SNAPPING_HELPER_GRAPHICS_LAYER_ID,this.app,s.GraphicsLayerType.Pushpin),o.addToGraphicsLayerIdsToExclude([s.ExcludeFromEnum.ExportApplyStateName,s.ExcludeFromEnum.ExportMapTaskName,s.ExcludeFromEnum.WebMapName],c.SNAPPING_HELPER_GRAPHICS_LAYER_ID),this.app.map.addLayer(this._graphicsLayer),this._graphicsLayer.add(this._hoverGraphic),this._graphicsLayer.add(this._snapGraphic),this._hideSnappingGraphics();var e=this.configuration.snappingProvider;e&&(e.libraryId&&!this.app.allLibrariesLoaded?this._loadProviderWhenLibrariesDownloaded(e):this._loadProvider(e))},u.prototype._subscribeToMapEvents=function(){var i=this;this.app.map.on("layer-add-result",function(e){i.app.map.reorderLayer(i._graphicsLayer,i.app.map.graphicsLayerIds.length)})},u.prototype._loadProviderWhenLibrariesDownloaded=function(e){var i=this;this.app.event("ViewerLibrariesDownloadedEvent").once(this,function(){return i._loadProvider(e)})},u.prototype._loadProvider=function(e){var i=e.type,t=dojo.getObject(i);if(t){var n=new t(this.app,e.libraryId||this.libraryId);n.initialize(e),this._registerSnappingProvider(n)}},u.prototype._subscribeMouseEvents=function(){window.PointerEvent?this._addPointerMove():this._addMouseMove(),this._addMouseLeave(),this._addMouseOver()},u.prototype._removeMouseEvents=function(){this._removeEventListener(this.app.map.root,"pointermove",this._handlePointerMove),this._removeEsriHandle(this._mouseOverToken),this._removeEsriHandle(this._mouseMoveToken),this._removeJQueryHandle(this._mouseLeaveToken)},u.prototype._handleEditBegin=function(){var o=this;this._handleEditEnd(),this._editVertexMoveToken=this.app.event("EditVertexMovedEvent").subscribe(this,function(e){o._mouseInsideMapBounds=!0,o._handleInputMove(e)}),this._vertexHandleShownToken=this.app.event("VertexHandleShownEvent").subscribe(this,function(e){o._hideSnappingGraphics(),o._removeMouseEvents()}),this._vertexHandleHiddenToken=this.app.event("VertexHandleHiddenEvent").subscribe(this,function(){o._hideSnappingGraphics(),o._subscribeMouseEvents()}),this._esriEditVertexMovedToken=this.app.event("EditVertexHandleMovedEvent").subscribe(this,function(p){p&&p.geometry&&p.geometry instanceof esri.geometry.Point&&(o._mouseInsideMapBounds=!0,o._timer||(o._timer=setTimeout(function(){var e=p.getShape(),i=e.matrix.dx,t=e.matrix.dy,n=p.geometry,a=o.app.map.toScreen(n).offset(i,t),r={mapPoint:o.app.map.toMap(a),screenPoint:a};o._handleInputMove(r),o._clearTimeout()},o._inputThrottleDelay)))}),this._isEditing=!0},u.prototype._handleEditEnd=function(){this._hideSnappingGraphics(),this._removeGcxHandle("EditVertexMovedEvent",this._editVertexMoveToken),this._removeGcxHandle("VertexHandleShownEvent",this._vertexHandleShownToken),this._removeGcxHandle("VertexHandleHiddenEvent",this._vertexHandleHiddenToken),this._removeGcxHandle("EditVertexHandleMovedEvent",this._esriEditVertexMovedToken),this._isEditing=!1,this.snappingProvider.pauseSnapping()},u.prototype._subscribeAccessibilityEvents=function(){this._addVertexMoved()},u.prototype._removeAccessibilityEvents=function(){this._removeGcxHandle("GraphicVertexMovedEvent",this._vertexMovedToken)},u.prototype._handleGraphicDrawActivatedEvent=function(e){if(this.snappingProvider){var i=e.geometryType;i===esri.toolbars.Draw.MULTI_POINT&&(i=a.DrawMode.MULTI_POINT),i&&this._drawModeSupported(i)?(this._canSnap=!0,this.snappingProvider.continueSnapping()):(this._canSnap=!1,this.snappingProvider.pauseSnapping())}},u.prototype._handleDrawDeactivatedEvent=function(e){this.snappingProvider&&(this._canSnap=!1,this.snappingProvider.pauseSnapping())},u.prototype._handleActiveToolChanged=function(e){if(!this.snappingProvider)return this._canSnap=!1,void this.app.trace.debug("[SnappingModule]: 'ActiveToolChangedEvent' cannot be handled by the module before a SnappingProvider is registered. Check to ensure 'SiteServiceLayersLoadedEvent' has fired.");if(e&&e.tool&&e.tool instanceof r.MapTool){var i=e.tool;"EditMarkup"!==i.command&&"DeleteMarkup"!==i.command?this._drawModeSupported(i.drawMode)?(this._canSnap=!0,this.snappingProvider.continueSnapping()):(this._canSnap=!1,this.snappingProvider.pauseSnapping()):this._canSnap=!1}else this._canSnap=!1},u.prototype._drawModeSupported=function(e){return-1<this._supportedDrawModes.indexOf(e?e.toUpperCase():e)},u.prototype._registerSnappingProvider=function(e){this.snappingProvider=e,this.app.command("ActivateSnapping").raiseCanExecuteChanged(),this.app.event("SnappingProviderRegistered").publish(this.snappingProvider)},u.prototype._subscribeToUIEvents=function(){this._enabled&&(this._accessibleMode?(this._subscribeAccessibilityEvents(),this._removeMouseEvents(),this._mouseInsideMapBounds=!0):(this._subscribeMouseEvents(),this._removeAccessibilityEvents()),this._addMapStateChangedEvents())},u.prototype._executeActivateSnapping=function(){this._executeDeactivateSnapping(),this._enabled=!0,this.snappingProvider.activate(this._threshold),this._canSnap&&(this.snappingProvider.pauseSnapping(),this.snappingProvider.continueSnapping()),this._subscribeToUIEvents(),this.app.command("ScreenReaderNarrate").execute(this.app.getResource(this.libraryId,"language-snapping-activated")),this._isEditing&&(this.app.trace.debug("[SnappingModule]: Snapping enabled mid-edit"),this._handleEditBegin(),this._subscribeMouseEvents(),this._currentEditingGraphic&&this._moveEditingGraphicToTempLayer())},u.prototype._canExecuteSnapping=function(){if(this._canSnap)return!0;if(!(this.app.toolRegistry.getActiveTool()instanceof r.MapTool))return!1;var e=this.app.toolRegistry.getActiveTool();return!(!this.snappingProvider||!this._drawModeSupported(e.drawMode))},u.prototype._executeDeactivateSnapping=function(){this._enabled&&this.app.command("ScreenReaderNarrate").execute(this.app.getResource(this.libraryId,"language-snapping-deactivated")),this._enabled=!1,this.snappingProvider.deactivate(),this._killOffSnapping(),this._hideSnappingGraphics(),this._raiseSnappingInputMovedEvent(null,null),p.focusOnMap(this.app.map),this._currentEditingGraphic&&this._returnEditingGraphicToOwner()},u.prototype._executeRegisterSnappingLayers=function(e){var i=this;e.forEach(function(e){i._readerLayerRegisterWrapper(e)})},u.prototype._executeRegisterSnappingLayer=function(e){this._readerLayerRegisterWrapper(e)},u.prototype._executeUnregisterSnappingLayer=function(e){this._readerLayerUnregisterWrapper(e)},u.prototype._executeUnregisterSnappingLayers=function(e){var i=this;e.forEach(function(e){i._readerLayerUnregisterWrapper(e)})},u.prototype._readerLayerRegisterWrapper=function(e){this.snappingProvider.registerLayer(e)&&this.app.command("ScreenReaderNarrate").execute(this.app.getResource(this.libraryId,"language-snapping-layer-registered").format(e.displayName))},u.prototype._readerLayerUnregisterWrapper=function(e){this.snappingProvider.unregisterLayer(e),this.app.command("ScreenReaderNarrate").execute(this.app.getResource(this.libraryId,"language-snapping-layer-unregistered").format(e.displayName))},u.prototype._clearTimeout=function(){this._timer&&(clearTimeout(this._timer),this._timer=null)},u.prototype._addVertexMoved=function(){var i=this;this._removeGcxHandle("GraphicVertexMovedEvent",this._vertexMovedToken),this._vertexMovedToken=this.app.event("GraphicVertexMovedEvent").subscribe(this,function(e){i._handleInputMove(e)})},u.prototype._addMouseLeave=function(){var e=this;this._removeJQueryHandle(this._mouseLeaveToken),this._mouseLeaveToken=$(this.app.map.root).mouseleave(function(){e._clearTimeout(),e._hideSnappingGraphics(),e.snappingProvider.pauseSnapping(),e._mouseInsideMapBounds=!1})},u.prototype._addPointerMove=function(){var i=this;this._removeEventListener(this.app.map.root,"pointermove",this._handlePointerMove),this._addEventListener(this.app.map.root,"pointermove",function(e){i._handlePointerMove(e)})},u.prototype._handlePointerMove=function(a){var r=this;a&&(this._timer||(this._timer=setTimeout(function(){var e=a.clientX-r.app.map.root.getBoundingClientRect().left,i=a.clientY-r.app.map.root.getBoundingClientRect().top,t=r.app.map.toMap(new esri.geometry.ScreenPoint(e,i)),n={mapPoint:t,screenPoint:r.app.map.toScreen(t)};r._handleInputMove(n),r._clearTimeout()},this._inputThrottleDelay)))},u.prototype._addMouseOver=function(){var i=this;this._removeEsriHandle(this._mouseOverToken),this._mouseOverToken=this.app.map.on("mouse-over",function(e){i._mouseInsideMapBounds=!0,i._timer||(i._timer=setTimeout(function(){i._handleInputMove(e),i._clearTimeout()},i._inputThrottleDelay))})},u.prototype._addMouseMove=function(){var i=this;this._removeEsriHandle(this._mouseMoveToken),this._mouseMoveToken=this.app.map.on("mouse-move",function(e){i._mouseInsideMapBounds=!0,i._timer||(i._timer=setTimeout(function(){i._handleInputMove(e),i._clearTimeout()},i._inputThrottleDelay))})},u.prototype._addMapStateChangedEvents=function(){var i=this;this._removeEsriHandle(this._extentChangedToken),this._extentChangedToken=this.app.map.on("extent-change",function(e){i.snappingProvider.loadForExtent(e.extent),i._originPoint=null,i._originSnapPoint=null})},u.prototype._removeGcxHandle=function(e,i){e&&i&&(this.app.event(e).unsubscribe(i),i=null)},u.prototype._addKeyHandlers=function(){var i=this;this._removeEsriHandle(this._onKeyDown),this._onKeyDown=this.app.map.on("key-down",function(e){i._onSnapKeyDownHandler(e)})},u.prototype._onSnapKeyDownHandler=function(e){e.keyCode===this._toggleKey&&(this._enabled?this.app.command("DeactivateSnapping").execute():this.app.command("ActivateSnapping").execute())},u.prototype._killOffSnapping=function(){this._removeMouseEvents(),this._removeAccessibilityEvents(),this._removeEsriHandle(this._graphicDrawToken),this._removeEsriHandle(this._extentChangedToken)},u.prototype._removeEsriHandle=function(e){e&&(e.remove(),e=null)},u.prototype._removeJQueryHandle=function(e){e&&(e.off(),e=null)},u.prototype._addSnappingGraphics=function(e,i){if(void 0===i&&(i=null),i=i||e,this._originPoint){var t=this.app.map.toScreen(i),n=t.x-this._originSnapPoint.x,a=t.y-this._originSnapPoint.y,r=dojox.gfx.matrix.translate(n,a),p=this._snapGraphic.getDojoShape();p&&p.setTransform(r),n=(t=this.app.map.toScreen(e)).x-this._originPoint.x,a=t.y-this._originPoint.y,r=dojox.gfx.matrix.translate(n,a),(p=this._hoverGraphic.getDojoShape())&&p.setTransform(r)}else this._originPoint=this.app.map.toScreen(e),this._originSnapPoint=this.app.map.toScreen(i),this._snapGraphic.setGeometry(i),this._hoverGraphic.setGeometry(e);this._snapGraphic.visible||this._snapGraphic.show(),this._hoverGraphic.visible||this._hoverGraphic.show(),$(this._snapGraphic.getNode()).css("pointer-events","none"),$(this._hoverGraphic.getNode()).css("pointer-events","none")},u.prototype._hideSnappingGraphics=function(){this._originPoint=null,this._originSnapPoint=null,this._hoverGraphic.visible&&this._hoverGraphic.hide(),this._snapGraphic.visible&&this._snapGraphic.hide()},u.prototype._handleInputMove=function(i){var t=this;this._enabled&&(this._canSnap?i&&i.screenPoint&&this._mouseInsideMapBounds&&(this.snappingProvider.continueSnapping(),this.snappingProvider.provideSnappingPoint(i.screenPoint).then(function(e){e?(t._addSnappingGraphics(i.mapPoint,e),t._raiseSnappingInputMovedEvent(e,i.mapPoint),t.app.command("ScreenReaderNarrate").execute(t.app.getResource(t.libraryId,"language-snapping-point-found"))):(t._addSnappingGraphics(i.mapPoint,null),t._raiseSnappingInputMovedEvent(null,i.mapPoint))}).catch(function(e){t.app.trace.error("Failed to find a snapping point: {0}".format(e&&e.message?e.message:"Undetermined cause")),t.app.command("ScreenReaderNarrate").execute(t.app.getResource(t.libraryId,"language-snapping-error")),t._raiseSnappingInputMovedEvent(null,i.mapPoint)})):this._hideSnappingGraphics())},u.prototype._raiseSnappingInputMovedEvent=function(e,i){var t={snappingPoint:e,inputPoint:i};this.app.event("SnappingFeedbackEvent").publish(t)},u.prototype._addEventListener=function(e,i,t){e.addEventListener?e.addEventListener(i,t,!1):e.attachEvent&&e.attachEvent("on"+i,t)},u.prototype._removeEventListener=function(e,i,t){e.removeEventListener?e.removeEventListener(i,t,!1):e.detachEvent&&e.detachEvent("on"+i,t)},u.prototype._moveEditingGraphicToTempLayer=function(){if(this._graphicEditingLayerRef&&this._currentEditingGraphic&&this._canSwapEditingGraphic(this._graphicEditingLayerRef)&&(this.app.trace.debug("[SnappingModule]: Attempting to move the editing graphic from '{0}' to the temporary layer".format(this._graphicEditingLayerRef.id)),this._tempEditingLayer||(this._tempEditingLayer=s.getInternalGraphicsLayer(c.TEMP_SNAPPING_EDITOR_LAYER_ID,this.app,s.GraphicsLayerType.Pushpin)),this._graphicEditingLayerRef.remove(this._currentEditingGraphic),this._graphicEditingLayerRef.add(this._dummyGraphic),this._tempEditingLayer.add(this._currentEditingGraphic),this._toolbar&&this._toolbar.refresh(),this.app.clickableGraphics.isLayerRegistered(this._graphicEditingLayerRef))){var e=this.app.clickableGraphics.getLayerInfo(this._graphicEditingLayerRef);this.app.clickableGraphics.register(this._tempEditingLayer,e)}},u.prototype._returnEditingGraphicToOwner=function(e){void 0===e&&(e=!0),this._graphicEditingLayerRef&&this._currentEditingGraphic&&this._tempEditingLayer&&this._canSwapEditingGraphic(this._graphicEditingLayerRef)&&(this.app.trace.debug("[SnappingModule]: Returning the editing graphic back to '{0}'".format(this._graphicEditingLayerRef.id)),this._tempEditingLayer.remove(this._currentEditingGraphic),this._graphicEditingLayerRef.remove(this._dummyGraphic),this._graphicEditingLayerRef.add(this._currentEditingGraphic),this.app.clickableGraphics.isLayerRegistered(this._tempEditingLayer)&&this.app.clickableGraphics.unregister(this._tempEditingLayer),s.removeInternalGraphicsLayer(this._tempEditingLayer.id,this.app,s.GraphicsLayerType.Pushpin),this._tempEditingLayer.clear(),this._tempEditingLayer=null,e&&this._toolbar&&this._toolbar.refresh())},u.prototype._canSwapEditingGraphic=function(e){var i=!1,t=[];return this.snappingProvider&&this.snappingProvider.providerConfiguration&&this.snappingProvider.providerConfiguration.configuration&&this.snappingProvider.providerConfiguration.configuration.graphicsLayers&&(t=this.snappingProvider.providerConfiguration.configuration.graphicsLayers),e&&e instanceof esri.layers.GraphicsLayer&&-1<t.indexOf(e.id)&&(i=!0),i},u);function u(){var e=null!==l&&l.apply(this,arguments)||this;return e._inputThrottleDelay=1e3/60,e._originPoint=null,e._originSnapPoint=null,e._timer=null,e._mouseInsideMapBounds=!1,e._snapSymbol=null,e._canSnap=!1,e._supportedDrawModes=[],e._enabled=!1,e._accessibleMode=!1,e._graphicsLayer=null,e._tempEditingLayer=null,e._toggleKey=null,e._isEditing=!1,e._supressNextDeactivatedEvent=!1,e._graphicEditingLayerRef=null,e._currentEditingGraphic=null,e._dummyGraphic=null,e._toolbar=null,e._mouseMoveToken=null,e._extentChangedToken=null,e._mouseOverToken=null,e._onKeyDown=null,e._graphicDrawToken=null,e._vertexMovedToken=null,e._editVertexMoveToken=null,e._vertexHandleShownToken=null,e._vertexHandleHiddenToken=null,e._esriEditVertexMovedToken=null,e._defaultRadiusBorderColor="#000000",e._defaultHoverColor="#ffffff",e._defaultPointColor="#ffffff",e._defaultSnappingPointColor="#ffffff",e._defaultHoverOpacity=.2,e._defaultPointSize=5,e._defaultBorderSize=1,e._defaultThreshold=25,e._defaultCancelKey=70,e}i.SnappingModule=d})},"Mapping/modules/Snapping/SnappingModuleConfiguration":function(){define(["require","exports"],function(e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0})})},"Mapping/modules/Snapping/SnappingOptions":function(){define(["require","exports"],function(e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0})})},"Mapping/modules/Snapping/SnappingProviderConfiguration":function(){define(["require","exports"],function(e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0})})}}}),require({cache:{}}),define(["Mapping/modules/Snapping/EsriSnappingProvider","Mapping/modules/Snapping/LayerSelectorForSnapping","Mapping/modules/Snapping/SnappingInfo","Mapping/modules/Snapping/SnappingLayerSelectorView","Mapping/modules/Snapping/SnappingLayerSelectorViewModel","Mapping/modules/Snapping/SnappingModule"],function(e,i,t,n,a,r){p(e,"geocortex.essentialsHtmlViewer.mapping.modules.snapping.EsriSnappingProvider",e.EsriSnappingProvider),p(i,"geocortex.essentialsHtmlViewer.mapping.modules.snapping.LayerSelectorForSnapping",i.LayerSelectorForSnapping),p(t,"geocortex.essentialsHtmlViewer.mapping.modules.snapping.SnappingInfo",t.SnappingInfo),p(n,"geocortex.essentialsHtmlViewer.mapping.modules.snapping.SnappingLayerSelectorView",n.SnappingLayerSelectorView),p(a,"geocortex.essentialsHtmlViewer.mapping.modules.snapping.SnappingLayerSelectorViewModel",a.SnappingLayerSelectorViewModel),p(r,"geocortex.essentialsHtmlViewer.mapping.modules.snapping.SnappingModule",r.SnappingModule)})}();