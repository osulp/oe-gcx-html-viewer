function shim(e,r,t){if("string"==typeof e&&(t=r,r=e),"undefined"==typeof t)return void console.warn("Undefined shim for: "+r);for(var n=r.split("."),i=null,o=window,s=0,a=n.length;s<a;s++)i=n[s],s==a-1?o[i]=t:o[i]||(o[i]={}),o=o[i]}require({cache:{"Mapping/modules/Legend/LegendModule":function(){define(["require","exports","geocortex/framework/application/ModuleBase","geocortex/infrastructure/legend/LegendItemProviderFactory","./Providers/ArcGISDynamicMapService/ArcGISDynamicMapServiceLegendProvider","./Providers/ArcGISTiledMapService/ArcGISTiledMapServiceLegendProvider","./Providers/FeatureLayer/FeatureLayerLegendProvider","./Providers/KML/KMLLayerLegendProvider","./Providers/WMS/WMSLayerLegendProvider","./Providers/WFS/WFSLayerLegendProvider","./Providers/HeatMaps/HeatMapLayerLegendProvider","./Providers/ClusterLayer/ClusterLayerLegendProvider"],function(e,r,t,n,i,o,s,a,l,d,p,g){"use strict";var c=function(){function e(){}return e}();r.LegendItemViewModel=c;var u=function(e){function r(){return null!==e&&e.apply(this,arguments)||this}return __extends(r,e),r.prototype.initialize=function(e){this.enableThrottling=!e||void 0==e.enableThrottling||e.enableThrottling,n.LegendItemProviderFactory.registerLegendItemProvider(new i.ArcGISDynamicMapServiceLegendProvider(this.app,this.libraryId,this.enableThrottling)),n.LegendItemProviderFactory.registerLegendItemProvider(new o.ArcGISTiledMapServiceLegendProvider(this.app,this.libraryId,this.enableThrottling)),n.LegendItemProviderFactory.registerLegendItemProvider(new s.FeatureLayerLegendProvider(this.app,this.libraryId,this.enableThrottling)),n.LegendItemProviderFactory.registerLegendItemProvider(new a.KMLLayerLegendProvider(this.app,this.libraryId,this.enableThrottling)),n.LegendItemProviderFactory.registerLegendItemProvider(new l.WMSLayerLegendProvider(this.app,this.libraryId,this.enableThrottling)),n.LegendItemProviderFactory.registerLegendItemProvider(new d.WFSLayerLegendProvider(this.app,this.libraryId,this.enableThrottling)),n.LegendItemProviderFactory.registerLegendItemProvider(new p.HeatMapLayerLegendProvider(this.app,this.libraryId,this.enableThrottling)),n.LegendItemProviderFactory.registerLegendItemProvider(new g.ClusterLayerLegendProvider(this.app,this.libraryId,this.enableThrottling))},r}(t.ModuleBase);r.LegendModule=u})},"Mapping/modules/Legend/LegendView":function(){define(["require","exports","geocortex/framework/ui/ViewBase","geocortex/infrastructure/ui/components/FilterControl/FilterControlViewBase"],function(e,r,t,n){"use strict";var i=function(e){function r(r,t){var n=e.call(this,r,t)||this;return n.registerCommands(),n}return __extends(r,e),r.prototype.registerCommands=function(){var e=this;this.app.command("SwitchToLegendView").register(this,function(){e.app.command("ActivateView").execute(e.id)})},r.prototype.resolveWidget=function(r,t,i){switch(e.prototype.resolveWidget.call(this,r,t),r){case"LegendActionsWidget":return this.app.menuRegistry.createMenuWidget(this,t,i);case"LegendListFilterWidget":if(!t)return null;var o=new n.FilterControlViewBase(this.app,this.libraryId);o.handleFilterButtonClick=dojo.hitch(this,this.handleFilterButtonClick),o.handleFilterTextClear=dojo.hitch(this,this.handleFilterTextClear);var s=this.app.viewManager.createView({markupResource:"Mapping/infrastructure/ui/components/FilterControl/FilterControlView.html",typeName:"geocortex.essentialsHtmlViewer.mapping.infrastructure.ui.components.FilterControl.FilterControlViewBase",isVisible:!0},o);return s.attach(t.filterControlViewModel),s;default:return this.app.trace.warning("LegendView: Unknown Widget"),null}},r.prototype.activated=function(){this.viewModel.viewActive.set(!0)},r.prototype.deactivated=function(){this.viewModel.viewActive.set(!1)},r.prototype.handleSlideToggleClick=function(e,r,t){t.expanded.set(!t.expanded.get())},r.prototype.handleClickShowLayerList=function(){this.app.command("SwitchToLayerView").execute()},r.prototype.handleFilterTextClear=function(e,r,t){this.viewModel.filterControlViewModel.filterText.set("")},r.prototype.handleFilterButtonClick=function(e,r,t){this.viewModel.filterControlViewModel.filterText.pulse()},r}(t.ViewBase);r.LegendView=i})},"Mapping/modules/Legend/LegendViewModel":function(){define(["require","exports","geocortex/framework/ui/ViewModelBase","geocortex/infrastructure/legend/LegendItem","geocortex/framework/observables","geocortex/infrastructure/legend/LegendItemProviderResponse","geocortex/infrastructure/legend/LegendItemProviderFactory","geocortex/infrastructure/ui/components/FilterControl/FilterControlComponent","geocortex/infrastructure/ui/components/FilterControl/FilterControlViewModelBase"],function(e,r,t,n,i,o,s,a,l){"use strict";var d=function(e){function r(){var r=null!==e&&e.apply(this,arguments)||this;return r.hasVisibleItems=new i.Observable((!1)),r.viewActive=new i.Observable((!1)),r.extentChangedBindingToken=null,r._topLevelItems=[],r._filteredOutLegendItemLabels=[],r._itemsExpandedByFilter=[],r._filterControlId="LegendListFilterControl",r._namePositionDictionary={},r}return __extends(r,e),r.prototype.initialize=function(){var e=this;this.rootNode=new n.LegendItem(null),this.onDemandRootNode=new n.LegendItem(null,(!0)),this.filterControlViewModel=new l.FilterControlViewModelBase(this.app,this.libraryId),this.filterControlViewModel.filterInputPlaceholder.set(this.getResource("language-legend-search-placeholder")),this.filterControlViewModel.filterButtonText.set(this.getResource("language-legend-filter-button-text")),this.filterControlViewModel.setFilterControlComponent(new a.FilterControlComponent(this.app,this._filterControlId)),this.app.event("FilterControlResultChangedEvent").subscribe(this,this._handleFilterChanged),this.app.site&&this.app.site.isInitialized?this._handleInitializedSite(this.app.isOffline.get()):this.app.event("SiteInitializedEvent").once(this,function(){return e._handleInitializedSite(e.app.isOffline.get())}),this.app.event("MapServiceAddedEvent").subscribe(this,this._handleMapServiceAddedEvent),this.app.event("MapServicePropertyChangedEvent").subscribe(this,this._handleMapServiceAddedEvent),this.app.event("MapServiceLayersChangedEvent").subscribe(this,this._handleMapServiceAddedEvent),this.app.event("MapServiceRemovedEvent").subscribe(this,this._handleMapServiceRemovedEvent),this.app.event("MapExtentChangedEvent").subscribe(this,this._handleMapExtentChangedEvent),this.app.event("LayerVisualizationChangedEvent").subscribe(this,this._handleLayerVisualizationChanged),this.app.event("ClusterLayerAddedEvent").subscribe(this,this._handleAddClusterLegend),this.app.isOffline.bind(this,function(r){try{e._clear(),e._handleInitializedSite(r),setTimeout(function(){e._handleMapExtentChangedEvent()},100)}catch(t){e.app.trace.warning("Legend error while transitioning between online/offline modes: "+t)}})},r.prototype._handleAddClusterLegend=function(e){this._handleLayerAddition(e,this.app.isOffline.get())},r.prototype._handleLayerVisualizationChanged=function(e){var r=this;setTimeout(function(){r._handleMapServiceAddedEvent(e.mapService),r._removeClusteredLegendItems()},500)},r.prototype._handleMapServiceAddedEvent=function(e){if(e){var r=e.serviceLayer;try{this._handleLayerAddition(r,this.app.isOffline.get())}catch(t){this.app.trace.warning("Error loading legend items for layer '{0}': {1}".format(r.url,t.toString()))}}},r.prototype._handleMapServiceRemovedEvent=function(e){if(e)for(var r=e.serviceLayer,t=0;t<this.rootNode.children.get().length;t++)r===this.rootNode.children.get()[t].esriLayer&&(this.rootNode.children.removeAt(t),this._removeTopLevelItem(t))},r.prototype._clear=function(){this._onServiceLayerAddConnectHandle&&(this._onServiceLayerAddConnectHandle.remove(),this._onServiceLayerAddConnectHandle=null),this._onLayerRemoveHandle&&(this._onLayerRemoveHandle.remove(),this._onLayerRemoveHandle=null),this._serviceLayerVisEventSubscribeHandle&&(this.app.event("MapServiceVisibilityChangedEvent").unsubscribe(this._serviceLayerVisEventSubscribeHandle),this._serviceLayerVisEventSubscribeHandle=null),this._layerVisEventSubscribeHandle&&(this.app.event("LayerVisibilityChangedEvent").unsubscribe(this._layerVisEventSubscribeHandle),this._layerVisEventSubscribeHandle=null),this._clearTopLevelItems(),this.hasVisibleItems.set(!1)},r.prototype._handleInitializedSite=function(e){var r=this;this._map=this.app.map;for(var t={},n=this._map.layerIds.concat(this._map.graphicsLayerIds),i=0;i<n.length;++i){var o=this._map.getLayer(n[i]);if(o){t[o.url]=o;try{this._handleLayerAddition(o,e)}catch(s){this.app.trace.warning("Error loading legend items for layer '{0}': {1}".format(o.url,s.toString()))}}}this._onServiceLayerAddConnectHandle=this._map.on("layer-add",function(n){if(!t[n.layer.url])try{r._handleLayerAddition(n.layer,e)}catch(i){r.app.trace.warning("Error loading legend items for layer '{0}': {1}".format(n.layer.url,i.toString()))}}),this._onLayerRemoveHandle=this._map.on("layer-remove",function(t){r._handleLayerRemoval(t.layer,e)}),this._layerVisEventSubscribeHandle=this.app.event("LayerVisibilityChangedEvent").subscribe(this,this._handleMapExtentChangedEvent),this._serviceLayerVisEventSubscribeHandle=this.app.event("MapServiceVisibilityChangedEvent").subscribe(this,this._handleMapExtentChangedEvent)},r.prototype._refreshLegend=function(){this._handleMapExtentChangedEvent()},r.prototype._handleMapExtentChangedEvent=function(){var e=this;if(this.viewActive.get())try{this._handleMapExtentChangedEventImpl()}catch(r){}else this.extentChangedBindingToken||(this.extentChangedBindingToken=this.viewActive.bind(this,function(){e.viewActive.unbind(e.extentChangedBindingToken),e.extentChangedBindingToken=null,e._handleMapExtentChangedEventImpl()}))},r.prototype._handleMapExtentChangedEventImpl=function(){for(var e=this.app.map.getScale(),r=0,t=!1,n=0;n<this._topLevelItems.length;++n){var i=this._topLevelItems[n];i&&(r+=this._walkLegendTree(e,i),i.isVisible.get()&&("group"!==i.templateType||"group"===i.templateType&&i.children.length())&&(t=!0))}this._removeClusteredLegendItems(),this._populateOnDemandRootNode(),t!==this.hasVisibleItems.get()&&this.hasVisibleItems.set(t)},r.prototype._populateOnDemandRootNode=function(){this.onDemandRootNode.children.clear();var e=this.rootNode.children.get().filter(function(e){return e.isVisible.get()});this.onDemandRootNode.children.addItems(e)},r.prototype._isVisibleInTree=function(e){if(e&&!e.isVisible())return!0;if(e){if(null==e.parentLayerId)return!1;var r=e.mapService.findLayerById(e.parentLayerId);return!!r&&this._isVisibleInTree(r)}return!1},r.prototype._walkLegendTree=function(e,r){if(r.essLayer&&this._isVisibleInTree(r.essLayer))return this._hideLegendItem(r),0;if(!r.essLayer&&!r.esriLayer.visible)return this._hideLegendItem(r),0;if(r.isCluster)return 1;for(var t=0,n=r.children.getLength()>0,i=0;i<r.children.getLength();++i)t+=this._walkLegendTree(e,r.children.getAt(i));var o=Number.POSITIVE_INFINITY,s=0;o=r.essLayer?r.essLayer.minScale:r.esriLayer.minScale,s=r.essLayer?r.essLayer.maxScale:r.esriLayer.maxScale;var a=!1;return 0===o&&0===s?a=!0:e>=s&&e<=o&&(a=!0),a=a&&(r.essLayer?r.essLayer.isVisible():r.esriLayer.visible),a?a=n&&0===t?this._setFilterContingentLegendVisibility(r,!1):this._setFilterContingentLegendVisibility(r,!0):this._setFilterContingentLegendVisibility(r,!1),!a||0===t&&r.children.getLength()>0?0:t+(n?0:1)},r.prototype._hideLegendItem=function(e){e.isVisible.get()===!0&&e.isVisible.set(!1)},r.prototype._showLegendItem=function(e){e.isVisible.get()===!1&&e.isVisible.set(!0)},r.prototype._setFilterContingentLegendVisibility=function(e,r){var t=r&&this._filteredOutLegendItemLabels.indexOf(e.label.get())===-1;return t?this._showLegendItem(e):this._hideLegendItem(e),t},r.prototype._handleLayerAddition=function(e,r){var t=this._getProvider(e,r);if(t){var n=t.item;if(t.code.get()===o.LegendItemProviderResponseCode.Show||t.code.get()===o.LegendItemProviderResponseCode.Pending){var i=this._replaceDuplicate(n);i||this._addTopLevelItem(n,t)}else if(t.code.get()===o.LegendItemProviderResponseCode.Hide){for(var s=0;s<this.rootNode.children.length();s++)if(this.rootNode.children.getAt(s).esriLayer===n.esriLayer){this.rootNode.children.removeAt(s);break}for(var s=0;s<this._topLevelItems.length;s++)if(this._topLevelItems[s]&&this._topLevelItems[s].esriLayer===n.esriLayer){this._removeTopLevelItem(s);break}}this._handleMapExtentChangedEvent()}},r.prototype._handleLayerRemoval=function(e,r){var t=this._getProvider(e,r);if(t){for(var n=t.item,i=0;i<this.rootNode.children.length();i++)if(this.rootNode.children.getAt(i).esriLayer===n.esriLayer){if(n.esriLayer instanceof esri.layers.FeatureLayer){var o=n.esriLayer.name;(!this._namePositionDictionary.hasOwnProperty(o)||this._namePositionDictionary[o]>i)&&(this._namePositionDictionary[o]=i)}this.rootNode.children.removeAt(i);break}for(var i=0;i<this._topLevelItems.length;i++)if(this._topLevelItems[i]&&this._topLevelItems[i].esriLayer===n.esriLayer){this._removeTopLevelItem(i);break}this._handleMapExtentChangedEvent()}},r.prototype._getProvider=function(e,r){for(var t=s.LegendItemProviderFactory.getProviders(),n=0;n<t.length;++n){var i=t[n];if(!r||i.supportsOffline()){var a;try{a=i.provide(e)}catch(l){this.app.trace.warning("Error building legend: "+l);continue}if(a&&a.code.get()!==o.LegendItemProviderResponseCode.NotFound)return a}}return null},r.prototype._replaceDuplicate=function(e){for(var r=0;r<this.rootNode.children.get().length;r++)if(e.esriLayer===this.rootNode.children.get()[r].esriLayer)return this.rootNode.children.removeAt(r),this.rootNode.children.insertItem(r,e),this._topLevelItems[r]=e,!0;return!1},r.prototype._addTopLevelItem=function(e,r){var t=this,n=0;if(e.esriLayer instanceof esri.layers.FeatureLayer){var i=e.esriLayer.name;i&&this._namePositionDictionary.hasOwnProperty(i)&&(n=this._namePositionDictionary[i])}if(this.rootNode.children.insertItem(n,e),this._topLevelItems.unshift(e),r&&r.code.get()!==o.LegendItemProviderResponseCode.Show)var s=r.code.bind(this,function(n){n===o.LegendItemProviderResponseCode.Show&&(r.code.unbind(s),t._getLegendFlatListFromItem(e).forEach(function(e){return t.filterControlViewModel.getFilterControlComponent().registerFilterableItem(e,[e.label.get()])}))});else this._getLegendFlatListFromItem(e).forEach(function(e){return t.filterControlViewModel.getFilterControlComponent().registerFilterableItem(e,[e.label.get()])})},r.prototype._removeTopLevelItem=function(e){var r=this,t=this._topLevelItems[e];return!!t&&(this._topLevelItems.splice(e,1),void this._getLegendFlatListFromItem(t).forEach(function(e){r.filterControlViewModel.getFilterControlComponent().removeRegisteredItem(e)}))},r.prototype._clearTopLevelItems=function(){this._topLevelItems.length=0,this.filterControlViewModel.getFilterControlComponent().clear()},r.prototype._getLegendFlatListFromItem=function(e){var r=this,t=[];return t.push(e),"group"===e.templateType&&e.children.get().forEach(function(e){t=t.concat(r._getLegendFlatListFromItem(e))}),t},r.prototype._removeClusteredLegendItems=function(){for(var e=0;e<this._topLevelItems.length;++e){var r=this._topLevelItems[e];if(r&&r.esriLayer instanceof esri.layers.FeatureLayer){var t=r.esriLayer;if(null===t.renderer){r.isVisible.set(!1);continue}}}},r.prototype._handleFilterChanged=function(e){if(e.filterControlId===this._filterControlId){this._restoreExpandedLegendItems(),this._filteredOutLegendItemLabels=e.filterableItems.filter(function(e){return!e.queryMatched}).map(function(e){return e.item.label.get()});var r=e.filterableItems.filter(function(e){return e.queryMatched}).map(function(e){return e.item});this._processDisplayableLegendItems(r,e.filterableItems.length&&!e.filterableItems[0].filterQuery),this._refreshLegend()}},r.prototype._restoreExpandedLegendItems=function(){this._itemsExpandedByFilter&&this._itemsExpandedByFilter.length&&(this._itemsExpandedByFilter.forEach(function(e){return e.expanded.set(!1)}),this._itemsExpandedByFilter.length=0)},r.prototype._processDisplayableLegendItems=function(e,r){var t=this;void 0===r&&(r=!1);var n=function(e){var r=t._filteredOutLegendItemLabels.indexOf(e);r>=0&&t._filteredOutLegendItemLabels.splice(r,1)},i=function(e){e.expanded.get()||r||(e.expanded.set(!0),t._itemsExpandedByFilter.push(e))},o=function(e){n(e.label.get()),i(e)},s=function(e){for(var r=e.parent;r;)o(r),r=r.parent},a=function(e){o(e);var r=e.children.get();r.forEach(function(e){o(e)})};e.forEach(function(e){s(e),a(e)})},r}(t.ViewModelBase);r.LegendViewModel=d})},"Mapping/modules/Legend/Providers/ArcGISCommonLegendProviderClasses/ArcGISMapServiceLegendProvider":function(){define(["require","exports","geocortex/infrastructure/legend/LegendItemProviderResponse","geocortex/infrastructure/legend/LegendItem","geocortex/essentials/RestHelperHTTPService"],function(e,r,t,n,i){"use strict";var o=function(){function e(e,r,t,n,i){this.app=e,this.libraryId=r,this.layerType=t?t:"",this.offlineSupported=!!n&&n,this.useThrottledCollections=!!i&&i}return e.prototype.supportsOffline=function(){return this.offlineSupported},e.prototype.provide=function(e){var r=this,i=null!=e.declaredClass?e.declaredClass:null;if(i!==this.layerType)return new t.LegendItemProviderResponse(t.LegendItemProviderResponseCode.NotFound,null);if(Number(e.version)<10.01)return new t.LegendItemProviderResponse(t.LegendItemProviderResponseCode.NotFound,null);if(e.url&&e.url.indexOf("/ImageServer")>=0)return new t.LegendItemProviderResponse(t.LegendItemProviderResponseCode.NotFound,null);for(var o=this.app.site,s="",a=null,l=0;l<o.essentialsMap.mapServices.length;++l){var d=o.essentialsMap.mapServices[l];if(d.serviceLayer===e){a=d;break}}var p=null;a&&(p=this._getLegendUrl(a)),null==p&&(p=e.url.replace("/MapServer","/MapServer/legend"));var g=new n.LegendItem(e,this.useThrottledCollections),c=esri.request({url:p,content:{f:"json"},handleAs:"json",callbackParamName:"callBack"}),u=new t.LegendItemProviderResponse(t.LegendItemProviderResponseCode.Pending,g);if(c.then(function(t){r._handleLegendResponse(t,u,g,e,a)},function(e){r._handleLegendError(g,e)}),a)s=d.displayName;else{var h=e.url.lastIndexOf("/");h>-1&&(s=e.url.substr(h))}return g.label.set(s),g.templateType="group",u},e.prototype._handleLegendResponse=function(e,r,t,n,i){this._populateItemForLayer(e,r,t,n,i)},e.prototype._findGcxLayerForEsriLayer=function(e,r){return e.findLayerById(r.layerId)},e.prototype._populateItemForLayer=function(e,r,i,o,s){if(!e)return void this.app.trace.warning("Could not fetch legend entry for '{0}'".format(o.url));i.isVisible.set(!0);for(var a=0;a<e.layers.length;++a){var l=e.layers[a],d=l.minScale,p=l.maxScale,g=null,c=null;if(s){if(g=this._findGcxLayerForEsriLayer(s,l),!g)continue;if(!g.includeInLegend)continue;c=g.displayName,d=g.minScale,p=g.maxScale}var u=new n.LegendItem(o,this.useThrottledCollections);u.label.set(c||l.layerName),u.essLayer=g;for(var h=0;h<l.legend.length;++h){var m=l.legend[h],v=m.imageData,L=String.escapeHtml(v),y=new n.LegendItem(o,this.useThrottledCollections);y.label.set(m.label?m.label:l.layerName),y.sublayerId=l.layerId,y.essLayer=g;var f="data:"+m.contentType+";base64,"+L,I=this.app.getResource(this.libraryId,"language-legend-icon-alt-text").format(y.label.get());y.swatchElement="<img src='"+f+"' alt='"+I+"' />",y.parent=u,u.children.addItem(y)}if(1===u.children.getLength()){var b=u.children.getAt(0);b.templateType="single-item",b.label.set(u.label.get()),b.parent=i,i.children.addItem(b)}else u.children.getLength()>1&&(u.templateType="group",u.parent=i,i.children.addItem(u))}i.children.getLength()>0&&(i.templateType="group"),r.code.set(t.LegendItemProviderResponseCode.Show)},e.prototype._handleLegendError=function(e,r){this.app.trace.warning("Error fetching legend information: "+r.toString()),e.isVisible.set(!1)},e.prototype._getLegendUrl=function(e){var r=null;if(e&&e.serviceLayer&&e.serviceLayer.url){var t=e.serviceLayer.url.match(/(\/MapServer\/jobs\/[\d\w]+)[\?\/]?/),n=t&&t[1]?t[1]:"/MapServer";r=e.serviceLayer.url.replace(n,n+"/legend")}return r&&e.serviceToken&&!/.*token=.*/.test(r)&&(r=i.RestHelperHTTPService.appendTokenToUrl(r,e.serviceToken)),r},e}();r.ArcGISMapServiceLegendProvider=o})},"Mapping/modules/Legend/Providers/ArcGISDynamicMapService/ArcGISDynamicMapServiceLegendProvider":function(){define(["require","exports","./../ArcGISCommonLegendProviderClasses/ArcGISMapServiceLegendProvider","geocortex/infrastructure/legend/LegendItemProviderResponse","geocortex/infrastructure/legend/LegendItem"],function(e,r,t,n,i){"use strict";var o=function(e){function r(r,t,n){var i=e.call(this,r,t,"esri.layers.ArcGISDynamicMapServiceLayer",!1,!!n)||this;return i.offlineSupported=!0,i}return __extends(r,e),r.prototype.provide=function(e){var r=this,t=null!=e.declaredClass?e.declaredClass:null;if(t!==this.layerType)return new n.LegendItemProviderResponse(n.LegendItemProviderResponseCode.NotFound,null);var o=e;if(Number(o.version)<10.01)return new n.LegendItemProviderResponse(n.LegendItemProviderResponseCode.NotFound,null);for(var s=this.app.site,a="",l=null,d=0;d<s.essentialsMap.mapServices.length;++d){var p=s.essentialsMap.mapServices[d];if(p.serviceLayer===e){l=p;break}}var g=null;l&&(g=this._getLegendUrl(l)),null==g&&(g=e.url.replace("/MapServer","/MapServer/legend"));var c=new i.LegendItem(e,this.useThrottledCollections),u={};if(l){if(0===l.layers.length)return new n.LegendItemProviderResponse(n.LegendItemProviderResponseCode.NotFound,null);l.supportsDynamicLayers&&o.dynamicLayerInfos&&o.dynamicLayerInfos.length>0&&(u.dynamicLayers=this.getDynamicLayersParameterJSON(o)),a=l.displayName}else{var h=e.url.lastIndexOf("/");h>-1&&(a=e.url.substr(h))}c.label.set(a),c.templateType="group",u.f="json";var m=esri.request({url:g,content:u,handleAs:"json",callbackParamName:"callBack"}),v=new n.LegendItemProviderResponse(n.LegendItemProviderResponseCode.Pending,c);return m.then(function(t){r._handleLegendResponse(t,v,c,e,l)},function(e){r._handleLegendError(c,e)}),v},r.prototype.getDynamicLayersParameterJSON=function(e){var r=[];if(e.dynamicLayerInfos)for(var t=e.dynamicLayerInfos,n=0;n<t.length;n++)if(t[n]){var i=new s;i.source=t[n].source.toJson(),i.id=t[n].id,e.layerDrawingOptions&&e.layerDrawingOptions[t[n].id]&&(i.drawingInfo=e.layerDrawingOptions[t[n].id].toJson()),r.push(i)}return JSON.stringify(r)},r}(t.ArcGISMapServiceLegendProvider);r.ArcGISDynamicMapServiceLegendProvider=o;var s=function(){function e(){}return e}()})},"Mapping/modules/Legend/Providers/ArcGISTiledMapService/ArcGISTiledMapServiceLegendProvider":function(){define(["require","exports","./../ArcGISCommonLegendProviderClasses/ArcGISMapServiceLegendProvider"],function(e,r,t){"use strict";var n=function(e){function r(r,t,n){return e.call(this,r,t,"esri.layers.ArcGISTiledMapServiceLayer",!1,!!n)||this}return __extends(r,e),r}(t.ArcGISMapServiceLegendProvider);r.ArcGISTiledMapServiceLegendProvider=n})},"Mapping/modules/Legend/Providers/ClusterLayer/ClusterLayerLegendProvider":function(){define(["require","exports","geocortex/infrastructure/ClusterLayer","geocortex/infrastructure/legend/LegendItemProviderResponse","geocortex/infrastructure/legend/LegendItem","./../FeatureLayer/FeatureLayerLegendProvider"],function(e,r,t,n,i,o){"use strict";var s=function(){function e(e,r,t){this.app=e,this.libraryId=r,this.useThrottledCollections=!!t}return e.prototype.supportsOffline=function(){return!0},e.prototype.provide=function(e){if(!(e instanceof t.ClusterLayer))return new n.LegendItemProviderResponse(n.LegendItemProviderResponseCode.NotFound,null);for(var r,o=this.app.site,s=0;s<o.essentialsMap.mapServices.length;s++){var a=o.essentialsMap.mapServices[s];if(a.serviceLayer===e.featureLayer){r=a;break}}var l=new i.LegendItem(e,this.useThrottledCollections);l.label.set(r.displayName);for(var s=0;s<r.layers.length;s++){var d=r.layers[s];d.includeInLayerList&&this.populateItemForLayer(l,e,null)}return l&&l.children&&l.children.length()&&r.featureClustering.enabled?new n.LegendItemProviderResponse(n.LegendItemProviderResponseCode.Show,l):r.featureClustering.enabled?void 0:new n.LegendItemProviderResponse(n.LegendItemProviderResponseCode.Hide,l)},e.prototype.populateItemForLayer=function(e,r,t){var n=new Array;if(e.essLayer=r.gcxLayer,r&&r.renderer&&r.gcxLayer.includeInLegend){var s=new o.FeatureLayerLegendProvider(this.app,this.libraryId,(!0));s.populateItemForLayer(e,r.gcxLayer,r.singleFeatureLayer,r.gcxLayer.mapService.serviceUrl);for(var a=r.renderer.infos,l=0;l<a.length;l++){var d=a[l],p=d.symbol,g=String.escapeHtml(p.color.toHex()),c=String.escapeHtml(""+p.size),u=p.color.toRgb(),h=new i.LegendItem(r.featureLayer,this.useThrottledCollections);h.isCluster=!0,h.essLayer=r.gcxLayer,h.isVisible.sync(r.rendererInformation[l].isVisible),h.label.sync(r.rendererInformation[l].rangeString),h.swatchElement="<div class='simple-swatch circle' style='background-color: "+g+"; width: "+c+"px; height: "+c+"px; border-radius: 50%; background-clip: padding-box; border: 4px solid rgba("+u[0]+", "+u[1]+", "+u[2]+", 0.25);'></div>",n.push(h)}}n.forEach(function(r){return r.parent=e}),e.children.addItems(n),e.children.getLength()>0&&(e.templateType="group")},e}();r.ClusterLayerLegendProvider=s})},"Mapping/modules/Legend/Providers/FeatureLayer/FeatureLayerLegendProvider":function(){define(["require","exports","geocortex/infrastructure/legend/LegendItemProviderResponse","geocortex/infrastructure/legend/LegendItem","geocortex/infrastructure/SymbolUtils"],function(e,r,t,n,i){"use strict";var o=function(){function e(e,r,t){this.app=e,this.libraryId=r,this.mapServiceLegends={},this.useThrottledCollections=!!t}return e.prototype.supportsOffline=function(){return!0},e.prototype.provide=function(e){var r=null!=e.declaredClass?e.declaredClass:null;if("esri.layers.FeatureLayer"!==r)return new t.LegendItemProviderResponse(t.LegendItemProviderResponseCode.NotFound,null);for(var i=this.app.site,o=0;o<i.essentialsMap.mapServices.length;o++){var s=i.essentialsMap.mapServices[o];if(s.serviceLayer instanceof esri.layers.KMLLayer){for(var a=s.serviceLayer.getLayers(),l=0;l<a.length;l++)if(a[l]===e)return new t.LegendItemProviderResponse(t.LegendItemProviderResponseCode.NotFound,null)}else if(s.serviceLayer===e){if(s.heatMap&&s.heatMap.enabled&&Modernizr.canvas)return new t.LegendItemProviderResponse(t.LegendItemProviderResponseCode.NotFound,null);if(s.featureClustering&&s.featureClustering.enabled)return new t.LegendItemProviderResponse(t.LegendItemProviderResponseCode.NotFound,null)}}for(var d=new n.LegendItem(e,this.useThrottledCollections),p=e,g=i.getFeatureServices(),c=null,o=0;o<g.length;++o){var u=g[o];if(u.serviceLayer===e){c=u;break}}if(c){d.label.set(c.displayName);for(var o=0;o<c.layers.length;++o){var h=c.layers[o];h.includeInLegend&&this.populateItemForLayer(d,h,p,null)}}else d.label.set(p.name),this.populateItemForLayer(d,h,p,null);return d&&d.children&&d.children.length()?new t.LegendItemProviderResponse(t.LegendItemProviderResponseCode.Show,d):new t.LegendItemProviderResponse(t.LegendItemProviderResponseCode.Hide,d)},e.prototype._buildLegendItemForTemplate=function(e,r,t){var i;if(i=new n.LegendItem(r,this.useThrottledCollections),i.essLayer=e,i.label.set(t.name),r.renderer){var o=this._getTemplateSymbol(t,r.renderer);o&&this._populateSwatchElement(i,o)}return i},e.prototype._buildLegendItemFromSimpleRenderer=function(e,r,t){var i;return i=new n.LegendItem(r,this.useThrottledCollections),i.essLayer=e,i.label.set(e&&e.displayName?e.displayName:r.name),t.symbol&&this._populateSwatchElement(i,t.symbol),i},e.prototype._buildLegendItemFromRendererInfo=function(e,r,t){var i;return i=new n.LegendItem(r,this.useThrottledCollections),i.essLayer=e,i.label.set(t.label),t.symbol&&this._populateSwatchElement(i,t.symbol),i},e.prototype._populateSwatchElement=function(e,r){if(r&&r.type&&e){var t=r.color?r.color.toCss():"rgb(255,255,255)",n=String.escapeHtml(t);switch(r.type){case"picturefillsymbol":case"picturemarkersymbol":var o=r.url,s=this.app.getResource(this.libraryId,"language-legend-icon-alt-text").format(e.label.get()),a=r.width,l=r.height,d=String.escapeHtml(o);e.swatchElement="<img src='"+d+"' alt='"+s+"' width='"+a+"' height='"+l+"'/>";break;case"simplefillsymbol":case"simplemarkersymbol":case"simplelinesymbol":var p=document.createElement("div"),g=r instanceof esri.symbol.SimpleMarkerSymbol?r.size+(r.outline?r.outline.width:0):32;i.createSymbolSwatch(p,g,r),e.swatchElement=p.innerHTML;break;default:e.swatchElement="<div class='simple-swatch square' style='background-color: "+n+"; border-color: "+n+";'></div>"}}},e.prototype._getTemplateSymbol=function(e,r){var t=new esri.Graphic(null);return t.attributes={},e.prototype.attributes&&dojo.mixin(t.attributes,e.prototype.attributes),r.getSymbol(t)},e.prototype.populateItemForLayer=function(e,r,t,n){var i=new Array;if(e.essLayer=r,t.renderer&&(t.renderer instanceof esri.renderer.UniqueValueRenderer||t.renderer instanceof esri.renderer.ClassBreaksRenderer)&&t.renderer.infos&&t.renderer.infos.length)for(var o=0;o<t.renderer.infos.length;++o)i.push(this._buildLegendItemFromRendererInfo(r,t,t.renderer.infos[o]));else if(t.renderer&&t.renderer instanceof esri.renderer.SimpleRenderer&&t.renderer.symbol)i.push(this._buildLegendItemFromSimpleRenderer(r,t,t.renderer));else if(t.templates&&t.templates.length>0)for(var o=0;o<t.templates.length;++o)i.push(this._buildLegendItemForTemplate(r,t,t.templates[o]));else if(t.types&&t.types.length>0)for(var o=0;o<t.types.length;++o){var s=t.types[o];if(s.templates)for(var a=0;a<s.templates.length;++a)i.push(this._buildLegendItemForTemplate(r,t,s.templates[a]))}i.forEach(function(r){return r.parent=e}),e.children.addItems(i),e.children.getLength()>0&&(e.templateType="group")},e.prototype._handleLegendError=function(e,r){this.app.trace.warning("Error fetching legend information: "+r.toString())},e}();r.FeatureLayerLegendProvider=o})},"Mapping/modules/Legend/Providers/HeatMaps/HeatMapLayerLegendProvider":function(){define(["require","exports","geocortex/infrastructure/legend/LegendItemProviderResponse","geocortex/infrastructure/legend/LegendItem","geocortex/infrastructure/ColorUtils"],function(e,r,t,n,i){"use strict";var o=function(){function e(e,r,t){this.app=e,this.libraryId=r,this.useThrottledCollections=!!t}return e.prototype.supportsOffline=function(){return!0},e.prototype.provide=function(e){if(!(e instanceof esri.layers.FeatureLayer&&Modernizr.canvas))return new t.LegendItemProviderResponse(t.LegendItemProviderResponseCode.NotFound,null);for(var r,i=this.app.site,o=e,s=0;s<i.essentialsMap.mapServices.length;s++){var a=i.essentialsMap.mapServices[s];if(a.serviceLayer===o){r=a;break}}if(!(r&&r.heatMap&&r.heatMap.enabled&&r.heatMap.includeInLegend))return new t.LegendItemProviderResponse(t.LegendItemProviderResponseCode.NotFound,null);var l=new n.LegendItem(e,this.useThrottledCollections);l.label.set(r.displayName);for(var s=0;s<r.layers.length;s++){var d=r.layers[s];d.includeInLayerList&&this.populateItemForLayer(l,d,o,null)}return l&&l.children&&l.children.length()?new t.LegendItemProviderResponse(t.LegendItemProviderResponseCode.Show,l):new t.LegendItemProviderResponse(t.LegendItemProviderResponseCode.Hide,l)},e.prototype.populateItemForLayer=function(e,r,t,o){var s=new Array;e.essLayer=r;var a=t.renderer;if(a&&a instanceof esri.renderer.HeatmapRenderer){var l=a.colors;!l&&a.colorStops&&(l=a.colorStops.map(function(e){var r=e.color;return r instanceof dojo.Color?r.toCss(!0):r instanceof Array?i.getStringFromList(r):r}));for(var d=l.filter(function(e){return!e.match(/rgba.*,(?= 0\))/g)}),p=d.length-1;p>=0;p--){var g=d[p],c=String.escapeHtml(g),u=new n.LegendItem(t,this.useThrottledCollections);u.essLayer=r;var h="";0===p?h=this.app.getResource(this.libraryId,"language-legend-heat-maps-low"):p===d.length-1&&(h=this.app.getResource(this.libraryId,"language-legend-heat-maps-high")),u.label.set(h),u.swatchElement="<div class='simple-swatch square' style='background-color: "+c+"; border-color: "+c+";'></div>",
s.push(u)}}s.forEach(function(r){return r.parent=e}),e.children.addItems(s),e.children.getLength()>0&&(e.templateType="group")},e}();r.HeatMapLayerLegendProvider=o})},"Mapping/modules/Legend/Providers/KML/KMLLayerLegendProvider":function(){define(["require","exports","./../FeatureLayer/FeatureLayerLegendProvider","geocortex/infrastructure/legend/LegendItemProviderResponse","geocortex/infrastructure/legend/LegendItem"],function(e,r,t,n,i){"use strict";var o=function(){function e(e,r,n){this.app=e,this.libraryId=r,this._featureLayerProvider=new t.FeatureLayerLegendProvider(this.app,this.libraryId),this.useThrottledCollections=!!n}return e.prototype.supportsOffline=function(){return!0},e.prototype.provide=function(e){if(!(e instanceof esri.layers.KMLLayer))return new n.LegendItemProviderResponse(n.LegendItemProviderResponseCode.NotFound,null);for(var r,t=this.app.site,o=0;o<t.essentialsMap.mapServices.length;o++){var s=t.essentialsMap.mapServices[o];s.serviceLayer===e&&(r=s)}var a=new i.LegendItem(e,this.useThrottledCollections);r?a.label.set(r.displayName):a.label.set(this.app.getResource(this.libraryId,"language-legend-kml-default-title"));for(var l=r.serviceLayer.getLayers(),o=0;o<l.length;o++)l[o]instanceof esri.layers.FeatureLayer&&this._featureLayerProvider.populateItemForLayer(a,null,l[o],null);return a&&a.children&&a.children.length()?new n.LegendItemProviderResponse(n.LegendItemProviderResponseCode.Show,a):new n.LegendItemProviderResponse(n.LegendItemProviderResponseCode.Hide,a)},e}();r.KMLLayerLegendProvider=o})},"Mapping/modules/Legend/Providers/WFS/WFSLayerLegendProvider":function(){define(["require","exports","./../FeatureLayer/FeatureLayerLegendProvider","geocortex/infrastructure/legend/LegendItemProviderResponse","geocortex/infrastructure/legend/LegendItem"],function(e,r,t,n,i){"use strict";var o=function(e){function r(){return null!==e&&e.apply(this,arguments)||this}return __extends(r,e),r.prototype.supportsOffline=function(){return!1},r.prototype.provide=function(e){var r=null!=e.declaredClass?e.declaredClass:null;if("esri.layers.WFSLayer"!==r)return new n.LegendItemProviderResponse(n.LegendItemProviderResponseCode.NotFound,null);for(var t=new i.LegendItem(e,this.useThrottledCollections),o=null,s=this.app.site.essentialsMap.mapServices,a=0;a<s.length;a++){var l=s[a];if(l.serviceLayer===e){o=l;break}}if(o){t.label.set(o.displayName);var d=o.layers[0];d&&d.includeInLegend&&this.populateItemForLayer(t,d,e,null)}return t&&t.children&&t.children.length()?new n.LegendItemProviderResponse(n.LegendItemProviderResponseCode.Show,t):new n.LegendItemProviderResponse(n.LegendItemProviderResponseCode.Hide,t)},r.prototype.populateItemForLayer=function(r,t,n,i){e.prototype.populateItemForLayer.call(this,r,t,n,i);var o=!!(r&&r.children&&r.children.length());if(!o){var s=null;switch(t.featureType){case"Point":s=n._pointSymbol;break;case"Line":s=n._lineSymbol;break;case"Polygon":s=n._polygonSymbol}if(s){var a=this._buildLegendItemFromSymbol(t,n,s);a&&(r.children.addItem(a),r.templateType="group")}}},r.prototype._buildLegendItemFromSymbol=function(e,r,t){var n=new esri.renderer.SimpleRenderer(t);return this._buildLegendItemFromSimpleRenderer(e,r,n)},r}(t.FeatureLayerLegendProvider);r.WFSLayerLegendProvider=o})},"Mapping/modules/Legend/Providers/WMS/WMSLayerLegendProvider":function(){define(["require","exports","geocortex/infrastructure/legend/LegendItemProviderResponse","geocortex/infrastructure/legend/LegendItem"],function(e,r,t,n){"use strict";var i=function(){function e(e,r,t){this.app=e,this.libraryId=r,this.useThrottledCollections=!!t}return e.prototype.supportsOffline=function(){return!1},e.prototype.provide=function(e){var r=null!=e.declaredClass?e.declaredClass:null;if("esri.layers.WMSLayer"!==r)return new t.LegendItemProviderResponse(t.LegendItemProviderResponseCode.NotFound,null);for(var i=new n.LegendItem(e,this.useThrottledCollections),o=this.app.site,s="",a=null,l=0;l<o.essentialsMap.mapServices.length;++l){var d=o.essentialsMap.mapServices[l];if(d.serviceLayer===e){a=d;break}}if(!a)return new t.LegendItemProviderResponse(t.LegendItemProviderResponseCode.NotFound,null);s=a.displayName;for(var p=[],l=0;l<a.layers.length;++l){var g=a.layers[l];if(g.includeInLegend&&g.legendUrl){var c=g.legendUrl;a.proxyUrl&&(c=a.proxyUrl+"?"+encodeURIComponent(c));var u=String.escapeHtml(c),h=this.app.getResource(this.libraryId,"language-legend-icon-alt-text").format(g.displayName),m=new n.LegendItem(e,this.useThrottledCollections);m.essLayer=g,m.swatchElement="<img src='"+u+"' alt='"+h+"' class='wms-legend-swatch'/>";var v=new n.LegendItem(e,this.useThrottledCollections);v.label.set(g.displayName),v.templateType="group",m.parent=v,v.children.addItem(m),p.push(v)}}return p.length>0?(p.forEach(function(e){return e.parent=i}),i.children.addItems(p),i.label.set(s),i.children.getLength()>0&&(i.templateType="group"),new t.LegendItemProviderResponse(t.LegendItemProviderResponseCode.Show,i)):new t.LegendItemProviderResponse(t.LegendItemProviderResponseCode.Hide,i)},e}();r.WMSLayerLegendProvider=i})},"url:/Mapping/modules/Legend/LegendView.html":'<div class="results-list-actions-widget" data-binding="{@visible: viewInitialized}{@widget: LegendActionsWidget}{@widget-context: @context}{@widget-required: false}"\r\n     data-menu-id="LegendActions" data-menu-template="Mapping/infrastructure/menus/MenuHyperlinkView.html"></div>\r\n\r\n<div class="panel-filter-widget" data-binding="{@visible: viewInitialized}{@widget: LegendListFilterWidget}{@widget-context: @context}{@widget-required: true}"></div>\r\n\r\n<div class="no-results" data-binding="{@hidden: hasVisibleItems}">\r\n    <p data-binding="{@text: @language-legend-no-items}"></p>\r\n</div>\r\n\r\n<div class="layer-list legend" data-binding="{@visible: hasVisibleItems}{@source: onDemandRootNode}">\r\n    <div class="legend-list" data-binding="{@template-for: onDemandRootNode}">\r\n        <ul data-binding="{@source: children}{@template: Mapping/modules/Legend/Templates/LegendItemNode.html}"></ul>\r\n    </div>\r\n</div>',"url:/Mapping/modules/Legend/Templates/LegendItem.html":'<div class="legend-item leaf clear">\r\n    <div class="legend-swatch" data-binding="{innerHTML: swatchElement}{title: label}"></div>\r\n    <span class="legend-item-label" data-binding="{@text: label}{title: label}"></span>\r\n</div>',"url:/Mapping/modules/Legend/Templates/LegendItemGroup.html":'<div class="legend-item group clear">\r\n    <div class="legend-item-parent">\r\n        <button data-binding="{class: expanderClass}{@visible: children}{@event-onclick: handleSlideToggleClick}{title: label}">\r\n        <span class="legend-item-label" data-binding="{@text: label}{title: label}"></span></button>\r\n    </div>\r\n    <ul class="legend-item children" data-binding="{@source: children}{@visible: expanded}{@template: Mapping/modules/Legend/Templates/LegendItemNode.html}">\r\n    </ul>\r\n</div>',"url:/Mapping/modules/Legend/Templates/LegendItemNode.html":'<li data-binding="{@source: @context}{@visible: isVisible}{@template-selector: templateType}">\r\n    <div class="templ-item" data-binding="{@template-select: single-item}{@template: Mapping/modules/Legend/Templates/LegendItem.html}"></div>\r\n    <div class="templ-group" data-binding="{@template-select: group}{@template: Mapping/modules/Legend/Templates/LegendItemGroup.html}"></div>\r\n</li>'}}),define(["Mapping/modules/Legend/LegendModule","Mapping/modules/Legend/LegendView","Mapping/modules/Legend/LegendViewModel","Mapping/modules/Legend/Providers/ArcGISCommonLegendProviderClasses/ArcGISMapServiceLegendProvider","Mapping/modules/Legend/Providers/ArcGISTiledMapService/ArcGISTiledMapServiceLegendProvider","Mapping/modules/Legend/Providers/ArcGISDynamicMapService/ArcGISDynamicMapServiceLegendProvider","Mapping/modules/Legend/Providers/FeatureLayer/FeatureLayerLegendProvider","Mapping/modules/Legend/Providers/ClusterLayer/ClusterLayerLegendProvider","Mapping/modules/Legend/Providers/HeatMaps/HeatMapLayerLegendProvider","Mapping/modules/Legend/Providers/KML/KMLLayerLegendProvider","Mapping/modules/Legend/Providers/WMS/WMSLayerLegendProvider"],function(e,r,t,n,i,o,s,a,l,d,p){shim(e,"geocortex.essentialsHtmlViewer.mapping.modules.legend.LegendItemViewModel",e.LegendItemViewModel),shim(e,"geocortex.essentialsHtmlViewer.mapping.modules.legend.LegendModule",e.LegendModule),shim(r,"geocortex.essentialsHtmlViewer.mapping.modules.legend.LegendView",r.LegendView),shim(t,"geocortex.essentialsHtmlViewer.mapping.modules.legend.LegendViewModel",t.LegendViewModel),shim(n,"geocortex.essentialsHtmlViewer.mapping.modules.legend.providers.ArcGISMapServiceLegendProvider",n.ArcGISMapServiceLegendProvider),shim(i,"geocortex.essentialsHtmlViewer.mapping.modules.legend.providers.ArcGISTiledMapServiceLegendProvider",i.ArcGISTiledMapServiceLegendProvider),shim(o,"geocortex.essentialsHtmlViewer.mapping.modules.legend.providers.ArcGISDynamicMapServiceLegendProvider",o.ArcGISDynamicMapServiceLegendProvider),shim(s,"geocortex.essentialsHtmlViewer.mapping.modules.legend.providers.FeatureLayerLegendProvider",s.FeatureLayerLegendProvider),shim(a,"geocortex.essentialsHtmlViewer.mapping.modules.legend.providers.ClusterLayerLegendProvider",a.ClusterLayerLegendProvider),shim(l,"geocortex.essentialsHtmlViewer.mapping.modules.legend.providers.HeatMapLayerLegendProvider",l.HeatMapLayerLegendProvider),shim(d,"geocortex.essentialsHtmlViewer.mapping.modules.legend.providers.KMLLayerLegendProvider",d.KMLLayerLegendProvider),shim(p,"geocortex.essentialsHtmlViewer.mapping.modules.legend.providers.WMSLayerLegendProvider",p.WMSLayerLegendProvider)});