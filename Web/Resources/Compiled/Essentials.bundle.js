require({cache:{"geocortex/config":function(){define(["require","exports"],function(e,t){"use strict";t.config={baseUrl:"http://localhost/",io:{errorHandler:function(e,t){dojo.publish("geocortex.Error",[e])},postLength:2e3,timeout:6e4},REST_version:"3.0",authenticationDialogId:null}})},"geocortex/forms":function(){define(["require","exports"],function(e,t){"use strict";function i(e,t){var i=e.getElementsByTagName(t);if(i.length>=1){for(var r=0;r<i.length;r++)if(i[r].parentNode===e)return i[r]}else if(e.childNodes.length>0){var n=e.childNodes[0].prefix;if(""!=n&&(i=e.getElementsByTagName(n+":"+t),i.length>=1))for(var r=0;r<i.length;r++)if(i[r].parentNode===e)return i[r]}return null}function r(e,t){var r=i(e,t);return r?dojox.xml.parser.textContent(r):null}function n(e,t){if(null!=e)for(var i=0;i<e.attributes.length;i++)if(e.attributes[i].name==t)return e.attributes[i].value;return null}function s(e){if(null!=e)switch(e.toLowerCase()){case"true":case"yes":case"1":return!0;case"false":case"no":case"0":case null:return!1;default:return Boolean(e)}return!1}function a(e){return geocortex.forms.renderFormItem(e)}t.getElement=i,t.getElementText=r,t.getAttributeValue=n,t._parseBoolean=s,t.renderFormItem=a})},"geocortex/hasProxy":function(){define(["require","exports"],function(e,t){"use strict";function i(){var e=!1;try{e=esri._getProxyUrl()}catch(t){}return e}t.hasProxy=i})},"geocortex/essentials/TokenResult":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(){}return e}();t.TokenResult=i})},"geocortex/essentials/RestHelperHTTPService":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(e,t){this.requestObject=null,this.optionsObject=null,this._handle=null,this._error=null,this._deferred=new dojo.Deferred,void 0!==e&&(this.requestObject=e,dojo.isFunction(this.requestObject.error)&&(this._error=this.requestObject.error,this.requestObject.error=null),dojo.isFunction(this.requestObject.handle)&&(this._handle=this.requestObject.handle),this.requestObject.handle=dojo.hitch(this,this._handleProxy)),void 0!==t&&(this.optionsObject=t)}return e.getTokenForScope=function(e){var t=this._anchorScratch||(this._anchorScratch=document.createElement("a")),i=this._pathCleaner||(this._pathCleaner=/\/+/g);t.href=e;var r=t.hostname.toLowerCase(),n=("/"+t.pathname+"/").replace(i,"/").toLowerCase(),s=void 0,a=this.tokenScopes;for(var o in a){t.href=o;var l=t.hostname.toLowerCase(),c=("/"+t.pathname+"/").replace(i,"/").toLowerCase();if(r===l&&n.startsWith(c)){var u=a[o];s="string"==typeof u?u:u===!0?this.token:void 0}}return s},e.setDefaultToken=function(e,t){"string"==typeof e&&(this.token=e,this.tokenScopes[t]=!0)},e.appendTokenToUrl=function(t,i){var r=t;return t&&!e.urlHasToken(t)&&(r=e._appendParameter(t,"token",i)),r},e.urlHasToken=function(e){return/[?&]token=/.test(e)},e.getAuthenticationControlBlockStore=function(){return console.warn("RestHelperHTTPService.getAuthenticationControlBlockStore() is no longer supported."),null},e.prototype._handleProxy=function(e,t){this._isUnauthorizedResponse(e)===!1&&dojo.isFunction(this._handle)&&(console.log("Invoking original handle delegate"),this._handle(e,t))},e.prototype._requestCallback=function(e){this._deferred.resolve(e)},e.prototype._requestErrback=function(e){dojo.isFunction(this._error)&&this._error(e),this._deferred.reject(e)},e.prototype._isUnauthorizedResponse=function(e){return!(!e||401!==e.code)},e.prototype.send=function(){var t=e.getTokenForScope(this.requestObject.url);return void 0!==t&&(this.requestObject.content||(this.requestObject.content={}),this.requestObject.content.token=t),esri.request(this.requestObject,this.optionsObject).then(dojo.hitch(this,this._requestCallback),dojo.hitch(this,this._requestErrback)),this._deferred.promise},e._appendParameter=function(e,t,i){var r=e;return e&&t&&i&&(r+=e.indexOf("?")>=0?"&":"?",r+=encodeURIComponent(t)+"="+encodeURIComponent(i)),r},e}();i.tokenScopes={},t.RestHelperHTTPService=i})},"geocortex/essentials/Extension":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(e,t){this.className=e,this.instance=t}return e}();t.Extension=i})},"geocortex/geocortex":function(){define(["require","exports","geocortex/config","geocortex/hasProxy","geocortex/essentials/RestHelperHTTPService","geocortex/essentials/Extension"],function(e,t,i,r,n,s){"use strict";function a(e,t){e&&e.fired==-1&&e.resolve(t)}function o(e,t){e&&e.fired==-1&&e.reject(t)}function l(e){var t=c(e),i={};for(var r in t)dojo.isArray(t[r])||"object"==typeof t[r]?i[r]=JSON.stringify(t[r]):i[r]=t[r];return i}function c(e){var t,i=typeof e;if(null==e||"undefined"===i||"number"===i||"boolean"===i||"string"===i)return e;if("function"==typeof e.toJson&&(t=e.toJson()),dojo.isArray(e)){t=[];for(var r=0;r<e.length;r++){var n=e[r];"function"!=typeof n&&(t[r]=c(n))}}else if("object"===i){t={};for(var r in e)if(!("declaredClass"==r||r.indexOf("_inherited")>-1||void 0!==t[r])){var n=e[r];"function"!=typeof n&&(t[r]=c(n))}}return t}function u(e,t){t||(t={}),t.gcx||(t.gcx={}),void 0===t.gcx.preventCache?e.preventCache=!0:t.gcx.preventCache?e.preventCache=!0:e.preventCache=!1,e.timeout=e.timeout||i.config.io.timeout,e.handleAs=e.handleAs||"json";var s=p(e),a=r.hasProxy();if(s&&!a){var o=new Error("Cross-domain or large requests require a proxy.");dojo.isFunction(e.error)&&e.error(o);var l=new dojo.Deferred;return l.errback(o),l}delete e.gcx,t.useProxy=s,t.hasOwnProperty("disableIdentityLookup")||(t.disableIdentityLookup=!0);var c=new n.RestHelperHTTPService(e,t);return c.send()}function p(e){var t=!1;try{var r=e.url.length;e.content&&(r+=dojo.objectToQuery(e.content).length);var n=new dojo._Url(e.url),s=window.location,a=r>i.config.io.postLength;if(!n.scheme&&!n.host&&!n.port)return!1;if(h()&&"https"===n.scheme)return!1;var o=!(s.protocol+"//"+s.hostname+(s.port?":"+s.port:"")==n.scheme+"://"+n.host+(n.port?":"+n.port:""));t=a&&o}catch(l){}return t}function h(){return/\bGeocortexApp\b/.test(navigator.userAgent)||/http:\/\/127.0.0.1(:[0-9]*)?\/viewerpackages\//gi.test(window.location.href)}function d(e){var t=e.indexOf("?");return t===-1?null:dojo.queryToObject(e.substring(t+1))}function f(e){var t=[];if(!e)return t;t.length=e.length;for(var i=0;i<e.length;i++)t[i]=new s.Extension(e[i].className,e[i].instance);return t}function y(e){return(e||[]).map(function(e){return{className:e.className,instance:e.instance}})}function m(e){var t={};if(!e)return t;for(var i=0;i<e.length;i++)t[e[i].name]=e[i].value;return t}function g(e){return e?Object.keys(e).map(function(t){return{name:t,value:e[t]}}):[]}t.deferredResolve=a,t.deferredReject=o,t.encodeJson=l,t.request=u,t.requiresProxy=p,t.isNative=h,t.urlToQueryObject=d,t._getExtensions=f,t._extensionsToJson=y,t._getProperties=m,t._propertiesToJson=g,Date.now||(Date.now=function(){return+new Date})})},"geocortex/essentials/utilities/DecomposedUri":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(e){this.originalUri=e,this.schemeHostAndPath=e.match(/[^?|^#]*/)[0];var t=e.match(/\?([^#]*)/);this.query={},t&&t.length>1&&(this.query=dojo.queryToObject(t[1])),this.fragment=dojo.queryToObject(e.indexOf("#")>=0?e.substring(e.indexOf("#")+1,e.length):"")}return e.prototype.recompose=function(){var e=this.schemeHostAndPath;return this.query&&this.anyProperties(this.query)&&(e+="?"+dojo.objectToQuery(this.query)),this.fragment&&this.anyProperties(this.fragment)&&(e+="#"+dojo.objectToQuery(this.fragment)),e},e.prototype.anyProperties=function(e){for(var t in e)return!0;return!1},e.getHost=function(e){if(!e)return null;var t=e.match(/^http[s]?:\/\/([^\/]*)/);return t.length>1?t[1]:null},e.appendToPath=function(t,i){var r=new e(t);return r.schemeHostAndPath+=i,r.recompose()},e.removeQueryParameters=function(t){for(var i=[],r=1;r<arguments.length;r++)i[r-1]=arguments[r];for(var n=new e(t),s=0,a=i;s<a.length;s++){var o=a[s];delete n.query[o]}return n.recompose()},e}();t.DecomposedUri=i})},"geocortex/essentials/OAuth2Client":function(){define(["require","exports","geocortex/essentials/TokenResult","geocortex/essentials/utilities/DecomposedUri"],function(e,t,i,r){"use strict";var n=function(){function e(){}return e.getTokenFromImplicitGrant=function(){var e=window.location.href;if(e.indexOf("#")>0){var t=e.substring(e.indexOf("#")+1,e.length),r=dojo.queryToObject(t);if(!r.access_token)return null;var n=new i.TokenResult;n.token=r.access_token,n.userName=r.username;var s=parseInt(r.expires_in);return s&&(n.expiresOn=new Date((new Date).getTime()+1e3*s)),n}return null},e.getErrorFromImplicitGrant=function(){var e=window.location.href;if(e.indexOf("#")>0){var t=e.substring(e.indexOf("#")+1,e.length),i=dojo.queryToObject(t);if(i.error){var r=new s;return r.code=i.error,r.description=i.error_description,r}}return null},e.applicationHasImplicitGrant=function(){return e.hasFragmentParameter("access_token")},e.applicationHasImplicitGrantError=function(){return e.hasFragmentParameter("error")},e.hasFragmentParameter=function(e){var t=window.location.href;if(t.indexOf("#")<0)return!1;var t=window.location.href,i=t.substring(t.indexOf("#")+1,t.length),r=dojo.queryToObject(i);return!!r[e]},e.redirectToLogOnPage=function(t,i){var n=new r.DecomposedUri(window.location.href);e.removeImplicitGrantParams(n);var s=t+"?client_id="+encodeURIComponent(i)+"&response_type=token&redirect_uri="+encodeURIComponent(n.recompose())+"&expiration=20160";window.location.href=s},e.removeImplicitGrantParamsAndUpdateUrlHash=function(){var t=new r.DecomposedUri(window.location.href);e.removeImplicitGrantParams(t),window.location.hash=dojo.objectToQuery(t.fragment)},e.removeImplicitGrantParams=function(e){return delete e.fragment.access_token,delete e.fragment.username,delete e.fragment.expires_in,delete e.fragment.error,delete e.fragment.error_description,e},e}();t.OAuth2Client=n;var s=function(){function e(){}return e}();s.ACCESS_DENIED_ERROR_CODE="access_denied",t.OAuth2Error=s})},"geocortex/essentials/utilities/StringUtilities":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(){}return e.endsWith=function(e,t){return e.indexOf(t,e.length-t.length)!==-1},e.replaceLayerTokens=function(e,t){if(t)switch(e.toLowerCase()){case"layerid":return t.id;case"layername":return t.name;case"layerdisplayname":return t.displayName;case"layerdescription":return t.description}return""},e.replaceMapServicetokens=function(e,t){if(t)switch(e.toLowerCase()){case"mapserviceid":return t.id;case"mapservicedisplayname":return t.displayName;case"mapserviceurl":return t.url;case"mapservicetoken":return t.serviceToken}return""},e.getDateFromRestDateString=function(e){e=e.trim();var t=/^\/Date\(-?\d+\)\/$/;if(!e||!t.test(e))return null;var i=e.substring(e.indexOf("(")+1,e.indexOf(")"));return isNaN(i)?null:new Date(parseInt(i,10))},e}();t.StringUtilities=i,"function"!=typeof String.prototype.endsWith&&(String.prototype.endsWith=function(e){return i.endsWith(this,e)})})},"geocortex/essentials/ArcGisPortalSecurityContext":function(){define(["require","exports","geocortex/essentials/OAuth2Client","geocortex/essentials/utilities/DecomposedUri","geocortex/essentials/utilities/StringUtilities"],function(e,t,i,r,n){"use strict";var s=function(){function e(e,t,i){this.baseUrl=e,this.domains=t,this.clientId=i}return e.prototype.initiate=function(){return this.tokenResult||(this.tokenResult=i.OAuth2Client.getTokenFromImplicitGrant()),this.tokenResult?(i.OAuth2Client.removeImplicitGrantParamsAndUpdateUrlHash(),!0):(this.error=i.OAuth2Client.getErrorFromImplicitGrant(),this.error||i.OAuth2Client.redirectToLogOnPage(this.getLogOnUrl(),this.clientId),i.OAuth2Client.removeImplicitGrantParamsAndUpdateUrlHash(),!1)},e.prototype.getLogOnUrl=function(){return this.baseUrl+"oauth2/authorize"},e.prototype.getToken=function(e){return this.tokenResult&&e&&this.appliesTo(e)?this.tokenResult.token:null},e.prototype.appliesTo=function(e){for(var t=r.DecomposedUri.getHost(e),i=0;i<this.domains.length;i++)if(n.StringUtilities.endsWith(t,this.domains[i]))return!0;return!1},e}();t.ArcGisPortalSecurityContext=s})},"geocortex/essentials/utilities/Thenable":function(){define(["require","exports"],function(e,t){"use strict"})},"geocortex/essentials/documents/DocumentConstants":function(){define(["require","exports"],function(e,t){"use strict";var i;!function(e){e.AUTHOR_DESCRIPTION="author.description",e.AUTHOR_ISSUER_TITLE="author.issuerTitle",e.AUTHOR_TITLE="author.title",e.DESCRIPTION="description",e.EDITOR_DESCRIPTION="editor.description",e.EDITOR_ISSUER_TITLE="editor.issuerTitle",e.EDITOR_TITLE="editor.title",e.FILE_TYPE="fileType",e.GRANT_TOKEN="grants.token",e.ISSUER_TITLE="issuerTitle",e.TAGS="tags",e.TIME_CREATION="timeOfCreation",e.TIME_LAST_ACCESS="timeOfLastAccess",e.TIME_LAST_MODIFICATION="timeOfLastModification",e.TITLE="title"}(i=t.DocumentField||(t.DocumentField={}));var r;!function(e){e.BLOB="application/octet-stream",e.JSON="application/json",e.TEXT="text/plain",e.XML="application/xml"}(r=t.ContentType||(t.ContentType={}));var n;!function(e){e.BLOB="blob",e.JSON="json",e.TEXT="text",e.XML="xml"}(n=t.DocumentFormat||(t.DocumentFormat={}));var s;!function(e){e.FROZEN="frozen",e.OWNER="owner",e.READER="reader",e.WRITER="writer",e.READER_LINK="readerLink",e.WRITER_LINK="writerLink",e.GLOBAL_CREATE="global_create",e.GLOBAL_READER="global_reader",e.GLOBAL_WRITER="global_writer"}(s=t.GrantKind||(t.GrantKind={}));var a;!function(e){e.PUBLIC="public",e.USER="user"}(a=t.GrantID||(t.GrantID={}));var o;!function(e){e.LINK="link",e.ROLE="role",e.USER="user",e.POLICY="policy"}(o=t.MonikerKind||(t.MonikerKind={}));var l;!function(e){e.RANGES="ranges",e.SPATIAL_DISJOINT="spatialDisjoint",e.SPATIAL_INTERSECTS="spatialIntersects",e.SPATIAL_WITHIN="spatialWithin",e.MATCHES="matches",e.VALUES="values"}(l=t.FilterMethod||(t.FilterMethod={}));var c;!function(e){e.REQUIRE="require",e.EXCLUDE="exclude",e.INCLUDE="include"}(c=t.FilterType||(t.FilterType={}))})},"geocortex/essentials/utilities/UrlUtilities":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(){}return e.simplify=function(e){var t=document.createElement("a");t.href=e;var i=t.href,r=i.charAt(i.length-1);return"/"!==r&&"\\"!==r||(i=i.substr(0,i.length-1)),i},e.getUrlComponents=function(e){var t=document.createElement("a");return t.href=e,{host:t.host,hostname:t.hostname,protocol:t.protocol,port:t.port,query:t.search,hash:t.hash,path:t.pathname,origin:t.protocol+"//"+t.host}},e.resolveUrl=function(t,i,r){void 0===r&&(r=!1);var n=t.endsWith("/")?"":"/",s=""+t+n+i;return r&&(s=e.simplify(s)),s},e}();t.UrlUtilities=i})},"geocortex/essentials/documents/Document":function(){define(["require","exports"],function(e,t){"use strict"})},"geocortex/essentials/documents/BatchRequestBuilder":function(){define(["require","exports"],function(e,t){"use strict";function i(e,t,i){return{action:"cloneDocument",id:e,document:t,createOnly:i}}function r(e,t){return{action:"createDocument",document:e,streamId:t}}function n(e,t){return{action:"createMoniker",moniker:e,createOnly:t}}function s(e){return{action:"deleteDocument",id:e}}function a(e){return{action:"deleteMoniker",id:e}}function o(e){return{action:"describe",streamId:e}}function l(e){return{action:"generateLinks",count:e}}function c(e,t){return{action:"modifyDocument",document:e,streamId:t}}function u(e,t,i){return{action:"openDocument",id:e,streamId:t,startPosition:i}}function p(e,t){return void 0===t&&(t=!1),{action:"peekDocument",id:e,throwIfMissing:t}}function h(e){return{action:"peekDocumentAccess",id:e}}function d(e,t){return{action:"peekMoniker",id:e,throwIfMissing:t}}function f(e){return{action:"peekMonikerAccess",id:e}}function y(e,t){return{action:"previewDocument",id:e,streamId:t}}function m(e,t){return{action:"previewMoniker",id:e,streamId:t}}function g(e,t){return{action:"readDocument",id:e,format:t}}function v(e){return{action:"restoreDocument",globalId:e}}function S(e){return{action:"restoreMoniker",globalId:e}}function x(e,t){return{action:"resumeDocument",globalId:e,streamId:t}}function b(e){return{action:"scrub",scrubOptions:e}}function I(e){return{action:"searchDocuments",documentQuery:e}}function w(e){return{action:"searchMonikers",monikerQuery:e}}function E(e){return{action:"searchRoles",searchClause:e}}function _(e){return{action:"searchUsers",searchClause:e}}function T(){return{action:"self"}}function L(e,t,i){return{action:"touchDocument",id:e,modify:t,throwIfMissing:i}}function D(e){return{action:"updateDocument",document:e}}function C(e){return{action:"updateMoniker",moniker:e}}function R(e){return{action:"writeDocument",content:e}}t.cloneDocument=i,t.createDocument=r,t.createMoniker=n,t.deleteDocument=s,t.deleteMoniker=a,t.describe=o,t.generateLinks=l,t.modifyDocument=c,t.openDocument=u,t.peekDocument=p,t.peekDocumentAccess=h,t.peekMoniker=d,t.peekMonikerAccess=f,t.previewDocument=y,t.previewMoniker=m,t.readDocument=g,t.restoreDocument=v,t.restoreMoniker=S,t.resumeDocument=x,t.scrub=b,t.searchDocuments=I,t.searchMonikers=w,t.searchRoles=E,t.searchUsers=_,t.self=T,t.touchDocument=L,t.updateDocument=D,t.updateMoniker=C,t.writeDocument=R})},"geocortex/essentials/documents/Parameters":function(){define(["require","exports"],function(e,t){"use strict"})},"geocortex/essentials/documents/DocumentStore":function(){define(["require","exports","geocortex/essentials/documents/DocumentConstants","geocortex/essentials/utilities/UrlUtilities","geocortex/geocortex","geocortex/essentials/documents/BatchRequestBuilder"],function(e,t,i,r,n,s){"use strict";var a="/../../documents",o=4.05,l="/self",c="{0}_exact";t.LINK_QUERY_STRING_KEY="link";var u=function(){function e(){this._initializeDeferred=new dojo.Deferred,this.supported=!1,this.isInitialized=!1,this.self=[],this.userMonikers=[],this.policyMonikers=[],this.userFilter={}}return e.prototype.initialize=function(e){this._site=e;var t=/^(.*?)(\/*)$/.exec(e.originalUrl)[1];return this._rootUrl=r.UrlUtilities.simplify(t+a),this.supported=e.getEssentialsVersion()>=o,this.onInitializeAttempt()},e.prototype.onInitialized=function(){return this._initializeDeferred.promise},e.prototype.onInitializeAttempt=function(){var t=this;if(this._initializeAttemptThenable)return this._initializeAttemptThenable;if(!this.supported){var i=new Error("The Document Store is not supported in the current version of Essentials.");return this._initializeDeferred.reject(i),this._initializeAttemptThenable=(new dojo.Deferred).reject(i)}return this._initializeAttemptThenable=n.request({url:this._rootUrl+l,content:{f:"json"},handleAs:"json"},{usePost:!1}).then(e._processError).then(function(e){t._processSelf(e),t.isInitialized=!0,t._initializeDeferred.resolve()}).then(null,function(e){throw t._initializeAttemptThenable=null,e})},e.prototype.getRootUrl=function(){return this._verifySupported(),this._rootUrl+"/"},e.prototype.canCreate=function(){return this.userMonikers.length>0},e.prototype.hasPolicyGrant=function(e){return this.policyMonikers.some(function(t){return t.grants.some(e)})},e.prototype.add=function(e){var t=this,i={document:dojo.mixin({},e)};void 0!==e.content&&(i.json=e.content,delete i.document.content);var r=s.writeDocument(i);return this.perform(r,!0).then(function(e){return e.document}).then(function(e){return t._processDocument(e)})},e.prototype.addFromFormData=function(e){throw new Error("Not implemented.")},e.prototype.addFromForm=function(e){throw new Error("Not implemented.")},e.prototype.getById=function(t,r,n){var a=this;if(void 0===r&&(r=!1),void 0===n&&(n=i.DocumentFormat.JSON),this._verifyDocId(t),r){var o=s.readDocument(t,n);return this.perform(o).then(function(t){return e._processReadDocumentResponse(t,n)}).then(function(e){return a._processDocument(e)})}var l=s.peekDocument(t);return this.perform(l).then(function(e){return e.document}).then(function(e){return a._processDocument(e)})},e.prototype.getContentUrl=function(e){throw new Error("Not implemented.")},e.prototype.updateById=function(e,t){var i=this;this._verifyDocId(e),t.timeOfLastModification||(t.timeOfLastModification=null),t.editor||(t.editor=null);var r=[];for(var n in t)t.hasOwnProperty(n)&&r.push(n);if(void 0!==t.content){var a={json:t.content};delete t.content,a.document=dojo.mixin({id:e,updates:r},t);var o=s.writeDocument(a);return this.perform(o,!0).then(function(e){return e.document}).then(function(e){return i._processDocument(e)})}var l=dojo.mixin({id:e,updates:r},t),c=s.updateDocument(l);return this.perform(c,!0).then(function(e){return e.document}).then(function(e){return i._processDocument(e)})},e.prototype.deleteById=function(e){var t=this;this._verifyDocId(e);var i=s.deleteDocument(e);return this.perform(i,!0).then(function(e){return e.document}).then(function(e){return t._processDocument(e)})},e.prototype.query=function(t){var i=this,r=dojo.mixin({},t);r.sort&&r.sort.forEach(function(t,i,r){e.matchesFilterFields.some(function(e){return e===t})&&(r[i]=c.format(t))}),r.sortDescending&&r.sortDescending.forEach(function(t,i,r){e.matchesFilterFields.some(function(e){return e===t})&&(r[i]=c.format(t))});var n=s.searchDocuments(r);return this.perform(n).then(function(e){return Array.isArray(e.matchingDocuments.results)&&e.matchingDocuments.results.forEach(function(e){return i._processDocument(e.entity)}),e.matchingDocuments})},e.prototype.perform=function(t,i){var r=this;if(void 0===i&&(i=!1),!t.action)throw new Error("The Document Store batch request does not contain an action");var s=t.action;return"perform"!==s&&delete t.action,this._guestLink&&(t.link=this._guestLink),t.f="json",this.onInitializeAttempt().then(function(){return r._verifySupported()}).then(function(){return n.request({url:r._rootUrl+"/"+s,content:n.encodeJson(t),handleAs:"json"},{usePost:i})}).then(e._processError)},e.prototype.isOwner=function(e){return!e||!e.access||e.access.change},e.prototype.isReadOnly=function(e){return!(!e||!e.access)&&(!!e.access.view&&!e.access.edit&&!e.access.change)},e.prototype.isPublic=function(e){return!!(e&&e.id&&e.grants)&&e.grants.some(function(e){return e.globalId===i.GrantID.PUBLIC&&(e.revoke===!1||e.assert===!0)})},e.prototype.setGuestLink=function(e){this._guestLink=e},e._processError=function(e){if(e.error)throw e.error;return e},e.prototype._processDocument=function(e){return e.timeOfCreation&&(e.timeOfCreation=new Date(e.timeOfCreation)),e.timeOfLastAccess&&(e.timeOfLastAccess=new Date(e.timeOfLastAccess)),e.timeOfLastModification&&(e.timeOfLastModification=new Date(e.timeOfLastModification)),e.timeOfDeletion&&(e.timeOfDeletion=new Date(e.timeOfDeletion)),e.timeOfExpiration&&(e.timeOfExpiration=new Date(e.timeOfExpiration)),e.access&&!e.access.monikerIds&&(e.access.monikerIds=this.userMonikers.map(function(e){return e.id})),e},e._processReadDocumentResponse=function(e,t){var i=e.content.document;return i.content=e.content[t],i},e.prototype._processSelf=function(e){if(this.self=e.monikers,this.userMonikers=e.monikers.filter(function(e){return e.kind===i.MonikerKind.USER}),this.policyMonikers=e.monikers.filter(function(e){return e.kind===i.MonikerKind.POLICY}),this.userMonikers.length>0){var t=this.userMonikers.map(function(e){return{string:"{0}|{1}".format(i.GrantKind.OWNER,e.globalId)}});this.userFilter={field:i.DocumentField.GRANT_TOKEN,method:i.FilterMethod.VALUES,range:t}}},e.prototype._verifyDocId=function(e){if(!e)throw new Error("The Document ID must be set.");if(/[\/?#\s]/.test(e))throw new Error("The Document ID '{0}' contains illegal characters.".format(e))},e.prototype._verifySupported=function(){if(!this.supported)throw new Error("The Document Store is not supported in the current version of Essentials.")},e}();u.matchesFilterFields=[i.DocumentField.TITLE,i.DocumentField.DESCRIPTION,i.DocumentField.ISSUER_TITLE,i.DocumentField.AUTHOR_TITLE,i.DocumentField.AUTHOR_DESCRIPTION,i.DocumentField.AUTHOR_ISSUER_TITLE,i.DocumentField.EDITOR_TITLE,i.DocumentField.EDITOR_DESCRIPTION,i.DocumentField.EDITOR_ISSUER_TITLE],t.DocumentStore=u})},"geocortex/essentials/MapServiceConstants":function(){define(["require","exports"],function(e,t){"use strict";var i;!function(e){e.DYNAMIC="Dynamic",e.TILED="Tiled",e.IMAGE="Image",e.BING="Bing",e.FEATURE="Feature",e.WMS="WMS",e.WFS="WFS",e.WMTS="WMTS",e.GEORSS="GeoRss",e.WEBTILED="WebTiled",e.VECTORTILE="VectorTile",e.KML="Kml",e.GRAPHICS="Graphics",e.LABEL="Label",e.STREAM="Stream",e.CSV="Csv",e.MAPIMAGE="MapImage",e.UNKNOWN="Unknown"}(i=t.MapServiceType||(t.MapServiceType={}));var r;!function(e){e.OPERATIONAL="Operational",e.BASE="Base"}(r=t.MapServiceFunction||(t.MapServiceFunction={}));var n;!function(e){e.MAP_SERVICE="MapService",e.FEATURE_LAYER="FeatureLayer",e.WFS_LAYER="WfsService",e.GEORSS_LAYER="GeoRssLayer",e.KML_SERVICE="KmlService",e.STREAM_LAYER="StreamLayer",e.GeoRSS_LAYER=e.GEORSS_LAYER}(n=t.DrawingBehavior||(t.DrawingBehavior={}));var s;!function(e){e.IGNORE="Ignore",e.WARN="Warn",e.ERROR="Error"}(s=t.FailureAction||(t.FailureAction={}));var a;!function(e){e.LAYER_ADDITION="LayerAddition",e.LAYER_CATALOG="LayerCatalog",e.UPLOAD="Upload"}(a=t.UserLayerType||(t.UserLayerType={}))})},"geocortex/essentials/FeatureCluster":function(){define(["require","exports"],function(e,t){"use strict"})},"geocortex/essentials/LayerChart":function(){define(["require","exports","geocortex/charting/infrastructure/Enums","geocortex/charting/infrastructure/configuration/ChartDefinition"],function(require,exports,Enums_1,ChartDefinition_1){"use strict";var LayerChart=function(){function LayerChart(restLayerChart,layer){this.layer=null,dojo.isObject(eval("geocortex.charting.configuration.ChartDefinition"))&&(restLayerChart&&(this.id=restLayerChart.id,this.displayName=restLayerChart.displayName,this.defaultChart=restLayerChart.defaultChart,this.chartFeatureType=restLayerChart.chartFeatureType,this.chartDefinition=new ChartDefinition_1.ChartDefinition(restLayerChart.chartDefinition),this.chartDefinition.id=this.id,this.chartDefinition.displayName=this.displayName),layer&&(this.layer=layer,this._setFieldDisplayNames(this.chartDefinition,layer)))}return LayerChart.prototype._setFieldDisplayNames=function(e,t){if(t&&e){for(var i={},r=0;r<t.fields.length;r++){var n=t.fields[r];n&&(i[n.name]=n.displayName)}e.category.field.sourceType==Enums_1.ChartFieldSourceType.Field&&(e.category.field.displayName=i[e.category.field.name]||e.category.field.name);for(var s=0;s<e.series.length;s++){var a=e.series[s];a&&a.field.sourceType==Enums_1.ChartFieldSourceType.Field&&(a.field.displayName=i[a.field.name]||a.field.name)}}},LayerChart}();exports.LayerChart=LayerChart})},"geocortex/essentials/DataLinkParameter":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(){this.featureField=null,this.id=null,this.name=null,this.type=null}return e}();t.DataLinkParameter=i})},"geocortex/essentials/DataLinkSearch":function(){define(["require","exports"],function(e,t){"use strict"})},"geocortex/essentials/DataLink":function(){define(["require","exports","geocortex/essentials/AsyncInitializable","geocortex/geocortex"],function(e,t,i,r){"use strict";var n=function(e){function t(t){var i=e.call(this,t)||this;return i.displayName=null,i.extensions=[],i.id=null,i.visible=null,i.isOneToOne=!1,i.layer=null,i.parameters=[],i.searches=[],i.properties={},i._numDataLinkingRequests=0,i}return __extends(t,e),t.prototype.isDataLinking=function(){return!!this._numDataLinkingRequests},t.prototype.performDataLinking=function(e,t,i){var n=this,s=function(e){i&&i(new Error(e))};!e&&this.parameters.length>0&&s("No FeatureSetParameters provided");for(var a=this.url+"/link",o=null,l=0;l<this.parameters.length;l++){for(var c=this.parameters[l],u="",p=0;p<e.features.length;p++){var h=e.features[p],d=h.attributes[c.featureField];if(!d&&this.layer&&this.layer.fields){for(var f,y=0;y<this.layer.fields.length;y++){var m=this.layer.fields[y];if(m.name===c.featureField){f=m;break}}if(f){var g;f.alias&&f.alias in h.attributes?g=f.alias:f.displayName&&f.displayName in h.attributes&&(g=f.displayName),g&&g in h.attributes&&d==h.attributes[g]}}u+=(0===u.length?"":",")+(d?this._prepParamValue(d):" ")}u&&u.length>0&&(o=null===o?{}:o,o[c.id]=u)}if(o){var v=r.encodeJson(dojo.mixin({f:"json"},o));this._numDataLinkingRequests++;var S=function(e){n._numDataLinkingRequests--,!e&&i&&i(new Error("No results")),e.error&&i&&i(e.error),t&&t(n._parseConvertDates(e.results))},x=function(e){n._numDataLinkingRequests--,i&&i(e)};r.request({url:a,content:v,load:S,error:x,callbackParamName:"CallBack"})}else s("Missing Feature Fields.")},t.prototype._configureObject=function(e,t){if(void 0===e||void 0===e.displayName||void 0===e.parameters)throw new Error("Incorrect data link object returned from initialization");if(this.displayName=e.displayName,this.id=e.id,this.visible=void 0===e.visible||e.visible,this.isOneToOne=!!e.isOneToOne,this.parameters=e.parameters,this.searches=e.searches,this.searches)for(var i=0,n=this.searches.length;i<n;i++)this.searches[i].dataLink=this;t&&(this.isInitialized=!0),this.properties=r._getProperties(e.properties),this.extensions=r._getExtensions(e.extensions)},t.prototype._parseConvertDates=function(e){for(var t in e)if(e.hasOwnProperty(t)){var i=e[t];if("string"==typeof i){if(i.length>6&&"/Date("===i.substring(0,6)){i=parseInt(i.substring(6));var r=new Date(i);e[t]=r}}else"object"==typeof i&&(e[t]=this._parseConvertDates(i))}return e},t.prototype._prepParamValue=function(e){var t="";return"number"==typeof e?t=e.toString():"string"==typeof e&&(t=e.replace(/,/g,"\\,")),t},t}(i.AsyncInitializable);t.DataLink=n})},"geocortex/essentials/Field":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(){}return e}();i.esriFieldTypeSmallInteger="esriFieldTypeSmallInteger",i.esriFieldTypeInteger="esriFieldTypeInteger",i.esriFieldTypeSingle="esriFieldTypeSingle",i.esriFieldTypeDouble="esriFieldTypeDouble",i.esriFieldTypeString="esriFieldTypeString",i.esriFieldTypeDate="esriFieldTypeDate",i.esriFieldTypeOID="esriFieldTypeOID",i.esriFieldTypeGeometry="esriFieldTypeGeometry",i.esriFieldTypeBlob="esriFieldTypeBlob",i.esriFieldTypeRaster="esriFieldTypeRaster",i.esriFieldTypeGUID="esriFieldTypeGUID",i.esriFieldTypeGlobalID="esriFieldTypeGlobalID",i.esriFieldTypeXML="esriFieldTypeXML",t.EsriFieldTypes=i;var r=function(){function e(){}return e}();r.essentialsFieldTypeSmallInteger="Int16",r.essentialsFieldTypeInteger="Int32",r.essentialsFieldTypeSingle="Single",r.essentialsFieldTypeDouble="Double",r.essentialsFieldTypeString="String",r.essentialsFieldTypeDate="DateTime",r.essentialsFieldTypeGUID="Guid",r.essentialsFieldTypeObject="Object",t.EssentialsFieldTypes=r;var n=function(){function e(e){if(this.layer=null,!e||!e.layer)throw new Error("Layer is required.");this.layer=e.layer,this.alias=e.alias,this.dataType=e.dataType,this.displayName=e.displayName,this.focusField=!!e.focusField,this.hyperlinkLabel=e.hyperlinkLabel,this.name=e.name,this.searchable=!!e.searchable,this.visible=!!e.visible,this.format=e.format}return e.prototype.toJson=function(){return{alias:this.alias,dataType:this.dataType,displayName:this.displayName,focusField:this.focusField,hyperlinkLabel:this.hyperlinkLabel,name:this.name,searchable:this.searchable,visible:this.visible,format:this.format}},e.convertFromEsriType=function(e){if(!e||0!==e.indexOf("esriFieldType"))return e;switch(e){case i.esriFieldTypeGeometry:case i.esriFieldTypeBlob:case i.esriFieldTypeRaster:return r.essentialsFieldTypeObject;case i.esriFieldTypeDate:return r.essentialsFieldTypeDate;case i.esriFieldTypeDouble:return r.essentialsFieldTypeDouble;case i.esriFieldTypeGlobalID:return r.essentialsFieldTypeGUID;case i.esriFieldTypeInteger:case i.esriFieldTypeOID:return r.essentialsFieldTypeInteger;case i.esriFieldTypeSingle:return r.essentialsFieldTypeSingle;case i.esriFieldTypeSmallInteger:
return r.essentialsFieldTypeSmallInteger;case i.esriFieldTypeGUID:case i.esriFieldTypeString:case i.esriFieldTypeXML:default:return r.essentialsFieldTypeString}},e.convertToEsriFieldType=function(e){switch(e){case r.essentialsFieldTypeObject:return i.esriFieldTypeBlob;case r.essentialsFieldTypeDate:return i.esriFieldTypeDate;case r.essentialsFieldTypeDouble:return i.esriFieldTypeDouble;case r.essentialsFieldTypeGUID:return i.esriFieldTypeGlobalID;case r.essentialsFieldTypeInteger:return i.esriFieldTypeInteger;case r.essentialsFieldTypeSingle:return i.esriFieldTypeSingle;case r.essentialsFieldTypeSmallInteger:return i.esriFieldTypeSmallInteger;case r.essentialsFieldTypeString:return i.esriFieldTypeString;default:return i.esriFieldTypeString}},e}();t.Field=n})},"geocortex/essentials/RestHelper":function(){define(["require","exports","geocortex/essentials/RestHelperHTTPService"],function(e,t,i){"use strict";var r=function(){function e(){}return e.processClientSideTokens=function(t,r){var n="";if(""!==r){var s="";t&&t.url&&(s=t.url),n=e._replaceToken("SiteRestUrl",r,s),n=e._replaceToken("VirtualDirectoryUrl",n,s+"/virtualdirectory");var a=window.location.href.substring(0,window.location.href.lastIndexOf("/"));n=e._replaceToken("HostUri",n,a);var o=s.substring(0,s.lastIndexOf("/sites/")),l=o+"/virtualdirectory";n=e._replaceToken("RestVirtualDirectoryUrl",n,l);var c=i.RestHelperHTTPService.token;n=e._replaceToken("RestToken",n,c)}return n},e.validateDynamicDefinition=function(t){if(!t||!t.trim())throw new Error("The JSON string cannot be null, empty nor merely whitespace!");var i=e.getJsonObjectFromJsonString(t);if(i){if(null==i.source)throw"The source is required!";if(null==i.source.type)throw"The type is required!";if("mapLayer"==i.source.type){if(null==i.source.mapLayerId)throw"The mapLayerId is required for the mapLayer type!"}else{if("dataLayer"!=i.source.type)throw"The type '"+i.source.type.toString()+"' is not supported!";if(null==i.source.dataSource)throw"The dataSource is required for the dataLayer type!"}}},e.getJsonObjectFromJsonString=function(e){var t;return t=JSON.parse(e)},e.getLayerSourceFromJsonObject=function(e){if("mapLayer"==e.type){var t=new esri.layers.LayerMapSource(e);return t}var i=new esri.layers.LayerDataSource;switch(e.dataSource.type){case"table":i.dataSource=new esri.layers.TableDataSource(e.dataSource);break;case"queryTable":i.dataSource=new esri.layers.QueryDataSource(e.dataSource);break;case"raster":i.dataSource=new esri.layers.RasterDataSource(e.dataSource);break;case"joinTable":i.dataSource=new esri.layers.JoinDataSource(e.dataSource);break;default:throw"The type '"+e.type.toString()+"' not supported!"}return i},e.getDynamicLayerInfoFromJson=function(t,i){var r;e.validateDynamicDefinition(t);var n=e.getJsonObjectFromJsonString(t);if(n){if(r=new esri.layers.DynamicLayerInfo,n.id)r.id=n.id;else{if(null==i)throw"The Layer's ID is missing or invalid!";r.id=parseInt(i,10)}r.source=this.getLayerSourceFromJsonObject(n.source),null!=n.minScale&&(r.minScale=n.minScale),r.minScale<=0&&(r.minScale=1/0),null!=n.maxScale&&(r.maxScale=n.maxScale)}return r},e.getDynamicExpressionFromJson=function(t){var i;e.validateDynamicDefinition(t);var r=e.getJsonObjectFromJsonString(t);return r&&r.definitionExpression&&(i=r.definitionExpression),i},e.getLayerDrawingOptionsFromJson=function(t){var i;e.validateDynamicDefinition(t);var r,n=e.getJsonObjectFromJsonString(t);if(n&&n.drawingInfo){switch(r=dojo.clone(n.drawingInfo),i=new esri.layers.LayerDrawingOptions,r.renderer.type){case"simple":i.renderer=new esri.renderer.SimpleRenderer(r.renderer);break;case"uniqueValue":i.renderer=new esri.renderer.UniqueValueRenderer(r.renderer);break;case"classBreaks":i.renderer=new esri.renderer.ClassBreaksRenderer(r.renderer);break;default:throw"The type '"+r.renderer.type.toString()+"' not supported!"}if(r.labelingInfo&&r.labelingInfo instanceof Array){var s=r.labelingInfo;void 0===r.showLabels&&(r.showLabels=!0);for(var a=0;a<s.length;a++){var o=new esri.layers.LabelClass(s[a]);i.labelingInfo||(i.labelingInfo=[]),i.labelingInfo.push(o)}}i.transparency=r.transparency,i.scaleSymbols=r.scaleSymbols,i.showLabels=r.showLabels}return i},e._replaceToken=function(e,t,i){return t?t.replace("{"+e+"}",i):t},e._createRestParametersFromQuery=function(t){var i={};return t&&(i=t.toJson(),i.spatialRel=e._convertSpatialRelationshipToDotnet(i.spatialRel)),i},e._convertSpatialRelationshipToDotnet=function(e){switch(e){case esri.tasks.Query.SPATIAL_REL_CONTAINS:return"esriSpatialRelContains";case esri.tasks.Query.SPATIAL_REL_CROSSES:return"esriSpatialRelCrosses";case esri.tasks.Query.SPATIAL_REL_ENVELOPEINTERSECTS:return"esriSpatialRelEnvelopeIntersects";case esri.tasks.Query.SPATIAL_REL_INDEXINTERSECTS:return"esriSpatialRelIndexIntersects";case esri.tasks.Query.SPATIAL_REL_INTERSECTS:return"esriSpatialRelIntersects";case esri.tasks.Query.SPATIAL_REL_OVERLAPS:return"esriSpatialRelOverlaps";case esri.tasks.Query.SPATIAL_REL_RELATION:return"esriSpatialRelRelation";case esri.tasks.Query.SPATIAL_REL_TOUCHES:return"esriSpatialRelTouches";case esri.tasks.Query.SPATIAL_REL_WITHIN:return"esriSpatialRelWithin"}throw new Error("Unknown rel: "+e)},e._convertSpatialRelationshipFromDotnetIndex=function(e){switch(e){case 1:return esri.tasks.Query.SPATIAL_REL_CONTAINS;case 2:return esri.tasks.Query.SPATIAL_REL_CROSSES;case 3:return esri.tasks.Query.SPATIAL_REL_ENVELOPEINTERSECTS;case 4:return esri.tasks.Query.SPATIAL_REL_INDEXINTERSECTS;case 0:return esri.tasks.Query.SPATIAL_REL_INTERSECTS;case 5:return esri.tasks.Query.SPATIAL_REL_OVERLAPS;case 8:return esri.tasks.Query.SPATIAL_REL_RELATION;case 6:return esri.tasks.Query.SPATIAL_REL_TOUCHES;case 7:return esri.tasks.Query.SPATIAL_REL_WITHIN}throw new Error("Unknown rel: "+e)},e}();r.tokenDurationMinutes=20,t.RestHelper=r})},"geocortex/essentials/FeatureHyperlink":function(){define(["require","exports","geocortex/essentials/RestHelper"],function(e,t,i){"use strict";var r=function(){function e(e,t){this.encodeUriReplacementValues=e.encodeUriReplacementValues,this.target=e.target,this.text=e.text,this.toolTip=e.toolTip;var r=null;t&&t.mapService&&t.mapService.essentialsMap&&(r=t.mapService.essentialsMap.site),this.uri=i.RestHelper.processClientSideTokens(r,e.uri),this.iconUri=i.RestHelper.processClientSideTokens(r,e.iconUri),this.layer=t}return e}();t.FeatureHyperlink=r})},"geocortex/essentials/LayerHyperlink":function(){define(["require","exports","geocortex/essentials/RestHelper"],function(e,t,i){"use strict";var r=function(){function e(e,t){this.encodeUriReplacementValues=e.encodeUriReplacementValues,this.target=e.target,this.text=e.text,this.toolTip=e.toolTip;var r=null;null!=t.mapServiceType?this.mapService=t:(this.layer=t,this.layer.mapService&&(this.mapService=this.layer.mapService)),this.mapService&&this.mapService.essentialsMap&&(r=this.mapService.essentialsMap.site),this.uri=i.RestHelper.processClientSideTokens(r,e.uri),this.iconUri=i.RestHelper.processClientSideTokens(r,e.iconUri)}return e.prototype.toJson=function(){return{encodeUriReplacementValues:this.encodeUriReplacementValues,iconUri:this.iconUri,target:this.target,text:this.text,toolTip:this.toolTip,uri:this.uri}},e}();t.LayerHyperlink=r})},"geocortex/essentials/Scale":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(e,t){this.displayName=e,this.scale=t}return e}();t.Scale=i})},"geocortex/essentials/Resolution":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(e,t){void 0!==e&&(this.displayName=e),void 0!==t&&(this.dpi=t)}return e}();t.Resolution=i})},"geocortex/essentials/TextField":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(e,t,i,r){this.id=e,this.displayName=t,this.value=i,this.multiline=r}return e}();t.TextField=i})},"geocortex/essentials/MapGrid":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(){}return e}();t.MapGrid=i})},"geocortex/essentials/FeatureLayerService":function(){define(["require","exports","geocortex/essentials/MapService","geocortex/geocortex","geocortex/essentials/RestHelperHTTPService"],function(e,t,i,r,n){"use strict";var s=function(e){function t(t){var i=e.call(this,t)||this;return i.color=[255,0,0],i.selectionColor=[0,255,255],i.disableClientCaching=!1,i.onDemandCacheSize=1e3,i.outFields="",i.queryMode=esri.layers.FeatureLayer.MODE_ONDEMAND,i.tileHeight=null,i.tileWidth=null,i.where=null,i.canUpdate=null,i.canAdd=null,i.canDelete=null,i.canEdit=null,i.canAddAttachments=null,i.moveEnabled=null,i.rotateEnabled=null,i.editVerticesEnabled=null,i.scaleEnabled=null,i.renderer=null,i._colorSet=!1,i._initialFeatureCollection=null,i._serviceLayer=null,i.serviceUrl=t,i}return __extends(t,e),t.prototype.getEmptyFeatureCollection=function(){return JSON.parse(this._initialFeatureCollection)},t.prototype.restoreFeatureLayer=function(){if(!this._serviceLayer._mode)switch(this._serviceLayer.mode){case esri.layers.FeatureLayer.MODE_SNAPSHOT:this._serviceLayer._mode=new esri.layers._SnapshotMode(this._serviceLayer);break;case esri.layers.FeatureLayer.MODE_ONDEMAND:this._serviceLayer._mode=new esri.layers._OnDemandMode(this._serviceLayer);break;case esri.layers.FeatureLayer.MODE_SELECTION:this._serviceLayer._mode=new esri.layers._SelectionMode(this._serviceLayer)}this.replaceFeatureLayer(this._serviceLayer,!0,!0,!0),this.serviceLayer.resume(),this.serviceLayer.mode===esri.layers.FeatureLayer.MODE_SNAPSHOT&&0===this.serviceLayer.graphics.length&&this.serviceLayer.refresh()},t.prototype.replaceFeatureLayer=function(e,t,i,r){var n=this.serviceLayer;if(!e)throw new Error("featureLayer cannot be null in order to replace the feature layer.");var s=this._getEsriMap();if(!s)throw new Error("Unable to get access to the Esri map object to perform the Feature Layer replace.");if(!this.serviceLayer)throw new Error("ServiceLayer not present. Can't replace the the FeatureLayer");t&&(e.visible=n.visible,e.setMaxScale(n.maxScale),e.setMinScale(n.minScale)),i&&(e.opacity=n.opacity),r&&e.setRenderer(n.renderer);var a=dojo.indexOf(s.graphicsLayerIds,n.id);this.serviceLayer=e,n.suspend(),s.removeLayer(n),s.addLayer(e,a),n.url||this._cleanUpLayer(n)},t.prototype._cleanUpLayer=function(e){if(e.clear(),e._essentialsMetadata){var t=e._essentialsMetadata.eventHandlers,i=0;for(i=0;i<t.length;i++)dojo.disconnect(t[i])}},t.prototype.queryCount=function(e,t,i){if(this.isServiceLayerLoaded&&this.serviceLayer){var r=function(e){t&&t(e)},n=function(e){i&&i(e)};this.serviceLayer.queryCount(e,r,n)}},t.prototype.queryFeatures=function(e,t,i){if(this.isServiceLayerLoaded&&this.serviceLayer)return this.serviceLayer.queryFeatures(e,t,i);var r=new Error("Esri layer has not finished loading");if(i)return i(r),null;var n=new dojo.Deferred;return n.reject(r),n},t.prototype.queryIds=function(e,t,i){if(this.isServiceLayerLoaded&&this.serviceLayer)return this.serviceLayer.queryIds(e,t,i);if(i){var r=new Error("Esri layer has not finished loading");i(r);var n=new dojo.Deferred;return n.reject(r),n}},t.prototype.queryRelatedFeatures=function(e,t,i){if(this.isServiceLayerLoaded&&this.serviceLayer)return this.serviceLayer.queryRelatedFeatures(e,t,i);if(i){var r=new Error("Esri layer has not finished loading");i(r);var n=new dojo.Deferred;return n.reject(r),n}},t.prototype._getEsriMap=function(){var e=null;return null!==this.essentialsMap&&null!==this.essentialsMap.site&&(e=this.essentialsMap.site.getMap()),e},t.prototype._configureObject=function(t,i){if(void 0===t||void 0===t.outFields||void 0===t.queryMode||void 0===t.where)throw new Error("Incorrect map service object returned from initialization");this._configurePropertiesAndrenderer(t),e.prototype._configureObject.call(this,t,i)},t.prototype._configurePropertiesAndrenderer=function(e){if(this.disableClientCaching=!!e.disableClientCaching,this.onDemandCacheSize=void 0===e.onDemandCacheSize||null===e.onDemandCacheSize?this.onDemandCacheSize:e.onDemandCacheSize,e.outFields||(e.outFields="*"),this.outFields=e.outFields,this.where=e.where,void 0===e.queryMode)this.queryMode=esri.layers.FeatureLayer.MODE_ONDEMAND;else switch(e.queryMode){case"Selection":case"SelectionOnly":this.queryMode=esri.layers.FeatureLayer.MODE_SELECTION;break;case"Snapshot":this.queryMode=esri.layers.FeatureLayer.MODE_SNAPSHOT;break;default:this.queryMode=esri.layers.FeatureLayer.MODE_ONDEMAND}if(e.tileHeight&&(this.tileHeight=e.tileHeight),e.tileWidth&&(this.tileWidth=e.tileWidth),e.selectionColor&&(this.selectionColor=e.selectionColor),e.color&&(this.color=e.color,this._colorSet=!0,this.color.length>3&&(this.color[3]=this.color[3]/255)),this.editVerticesEnabled=!e.hasOwnProperty("editVerticesEnabled")||e.editVerticesEnabled,this.moveEnabled=!e.hasOwnProperty("moveEnabled")||e.moveEnabled,this.scaleEnabled=!e.hasOwnProperty("scaleEnabled")||e.scaleEnabled,this.rotateEnabled=!e.hasOwnProperty("rotateEnabled")||e.rotateEnabled,e.renderer)try{this.renderer=esri.renderer.fromJson(e.renderer)}catch(t){}},t.prototype._updateServiceToken=function(t){if(e.prototype._updateServiceToken.call(this,t),this.serviceLayer){var i=this.serviceLayer._task;i&&i._url&&i._url.query&&(i._url.query.token=t)}},t.prototype._createServiceLayer=function(){e.prototype._createServiceLayer.call(this);var t=this.serviceUrl;this.serviceToken&&(t=n.RestHelperHTTPService.appendTokenToUrl(t,this.serviceToken));var i={};i.id=this.id,i.opacity=this.configuredOpacity,i.visible=this._computeInitServiceLayerVisibility(),this.outFields&&this.outFields.length>0&&(i.outFields=this.outFields.split(",")),null!==this.queryMode&&(i.mode=this.queryMode),null!==this.tileHeight&&null!==this.tileWidth&&this.queryMode==esri.layers.FeatureLayer.MODE_ONDEMAND&&(i.tileHeight=this.tileHeight,i.tileWidth=this.tileWidth),this.serviceLayer=new esri.layers.FeatureLayer(t,i),this.serviceLayer.setRenderer(this.renderer),this.attributionDataUrl&&""!==this.attributionDataUrl?(this.serviceLayer.attributionDataUrl=this.attributionDataUrl,this.serviceLayer.hasAttributionData=!0):this.hasAttributionData&&(this.serviceLayer.attributionDataUrl=this.url+"/Attribution",this.serviceLayer.hasAttributionData=!0),this._serviceLayer=this.serviceLayer,this.where&&this.serviceLayer.setDefinitionExpression(this.where),dojo.connect(this.serviceLayer,"onError",this,this._layerLoadErrorHandler),this.serviceLayer.loaded?this._handleLayerLoadEvent(this.serviceLayer):dojo.connect(this.serviceLayer,"onLoad",dojo.hitch(this,this._handleLayerLoadEvent)),e.prototype.initiateServiceFailureTimer.call(this)},t.prototype._computeInitServiceLayerVisibility=function(){var e=this._initiallyVisible;return e&&this.layers&&1===this.layers.length&&(e=this.layers[0].isVisible()),e},t.prototype._handleLayerLoadEvent=function(e){if(this.serviceLayer.version<10||this._colorSet){var t=null;if("esriGeometryPoint"==this.serviceLayer.geometryType){t=new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE,15,null,new esri.Color(this.selectionColor));var i=new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE,15,null,new esri.Color(this.color)),r=new esri.renderer.SimpleRenderer(i);this.serviceLayer.setRenderer(r)}else if("esriGeometryPolyline"==this.serviceLayer.geometryType){t=new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new esri.Color(this.selectionColor),1);var n=new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new esri.Color(this.color),1),s=new esri.renderer.SimpleRenderer(n);this.serviceLayer.setRenderer(s)}else if("esriGeometryPolygon"==this.serviceLayer.geometryType){t=new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new esri.Color([0,0,0]),1),new esri.Color(this.selectionColor));var a=new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new esri.Color([0,0,0]),1),new esri.Color(this.color)),o=new esri.renderer.SimpleRenderer(a);this.serviceLayer.setRenderer(o)}this.serviceLayer.setSelectionSymbol(t)}var l=this.serviceLayer.getEditCapabilities();this.canUpdate=l.canUpdate,this.canAdd=l.canCreate,this.canDelete=l.canDelete,this.canEdit=this.serviceLayer.isEditable(),this.canAddAttachments=!1,this.serviceLayer.capabilities&&(this.canAddAttachments=this.serviceLayer.version&&this.serviceLayer.version>=10.1&&this.serviceLayer.hasAttachments&&this.canEdit),this._initialFeatureCollection=JSON.stringify(this.serviceLayer.toJson()),this._handleServiceLayerLoaded(e)},t.prototype.hasOriginRelationships=function(){if(this.serviceLayer&&this.serviceLayer.version>=10.1&&this.serviceLayer.relationships&&this.serviceLayer.relationships.length>0){for(var e=0;e<this.serviceLayer.relationships.length;e++)if("esriRelRoleOrigin"===this.serviceLayer.relationships[e].role)return!0;return!1}return!1},t.prototype.getRelatedFeatureLayer=function(e,t,i){var s=new dojo.Deferred,a=function(e){r.deferredResolve(s,e),"function"==typeof t&&t(e)},o=function(e){s&&s.fired==-1&&s.resolve(e),"function"==typeof i&&i(e)};if(this.serviceLayer.version<10.1){var l=new Error("getRelatedFeatureLayer is only available for feature layer from ArcGIS 10.1 or greater.");return s&&s.fired==-1&&s.resolve(l),"function"==typeof i&&i(l),s}var c=this._getEsriRelation(e);if(!c){var l=new Error("Relation not found: "+e);return s&&s.reject(l),"function"==typeof i&&i(l),s}var u=this.serviceUrl.substring(0,this.serviceUrl.lastIndexOf("/")+1)+c.relatedTableId;this.serviceToken&&(u=n.RestHelperHTTPService.appendTokenToUrl(u,this.serviceToken)),void 0===esri.getProxyRule(u)&&null!==this.proxyUrl&&esri.addProxyRule({urlPrefix:u,proxyUrl:this.proxyUrl});var p=new esri.layers.FeatureLayer(u,{mode:esri.layers.FeatureLayer.MODE_SELECTION,outFields:["*"]});return dojo.connect(p,"onLoad",dojo.hitch(this,a)),dojo.connect(p,"onError",dojo.hitch(this,o)),s},t.prototype._getEsriRelation=function(e){if("string"==typeof e&&(e=parseInt(e)),this.serviceLayer.relationships)for(var t=0;t<this.serviceLayer.relationships.length;t++)if(this.serviceLayer.relationships[t].id==e)return this.serviceLayer.relationships[t];return null},t.prototype._getRelation=function(e){return this.layers&&this.layers.length>0?this.layers[0]._getRelation(e):null},t}(i.MapService);t.FeatureLayerService=s})},"geocortex/essentials/utilities/PrintUtilities":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(){}return e.adjustTextSymbol=function(e,t){if(e&&e.symbol instanceof esri.symbol.TextSymbol){var i=function(e,t){t.font.size=void 0!=e.font.size&&"number"==typeof e.font.size?Math.round(e.font.size)+"px":e.font.size,t.x=e.x,t.y=e.y,t.xoffset=e.xoffset,t.yoffset=e.yoffset,t.align=e.align,t.angle=e.angle,t.color.hasOwnProperty("a")&&(t.color.a=e.color.a>=0&&e.color.a<=1?255*e.color.a:e.color.a)},r=new esri.symbol.TextSymbol(e.symbol.toJson());if(r.color=new esri.Color({r:e.symbol.color.r,g:e.symbol.color.g,b:e.symbol.color.b,a:e.symbol.color.a}),i(e.symbol,r),r.toJson&&"function"==typeof r.toJson){var n=r.toJson;r.toJson=function(){var e=n.call(r);return i(r,e),e}}var s=null,a=null;if(t){var o=document.getElementById(t+"_layer"),l=null;l=document.createElementNS("http://www.w3.org/2000/svg","text"),l.setAttributeNS(null,"font-size",r.font.size.toString()),l.setAttributeNS(null,"font-family",r.font.family),l.setAttributeNS(null,"visibility","hidden"),l.textContent=r.text,o.appendChild(l);var c=l.getBBox();a=null===a?c.height:a,s=null===s?l.getComputedTextLength():s,o.removeChild(l)}else{var u=document.body,p=document.createElement("div"),h={fontFamily:r.font.family,fontSize:r.font.size,fontWeight:r.font.weight,padding:"0",position:"absolute",lineHeight:"1",visibility:"hidden"};for(var d in h)p.style[d]=h[d];p.appendChild(document.createTextNode(r.text)),u.appendChild(p),s=p.clientWidth,a=p.clientHeight,u.removeChild(p)}if(r.xoffset=0===r.angle?r.xoffset:0,r.yoffset=0===r.angle?r.yoffset:0,(e.measurementId||e.coordinateId)&&e.attributes&&e.attributes.numberOfLines){if(e.measurementId?r.xoffset=-(s/2+a/4):r.xoffset=-(s/4+a/2),r.yoffset=e.attributes.numberOfLines&&1==e.attributes.numberOfLines?a/2:r.yoffset,"start"==r.verticalAlignment&&e.attributes.numberOfLines&&e.attributes.numberOfLines>1){var f=e.attributes.numberOfLines;r.yoffset=r.yoffset-.5*a/2+a*f/2}}else{switch(r.verticalAlignment){case"top":break;case"middle":r.yoffset+=a/2;break;default:r.yoffset+=.75*a}e.attributes&&e.attributes.customVerticalAlignment&&"middle"===e.attributes.customVerticalAlignment&&(r.xoffset=0,r.yoffset=0,r.yoffset+=Math.ceil(a/2));var y=r.horizontalAlignment||r.align||null;if(y)switch(y){case esri.symbol.TextSymbol.ALIGN_MIDDLE:case"center":case"justify":r.xoffset-=Math.ceil(s/2),e.coordinateId||(r.xoffset-=Math.ceil(a/4));break;case esri.symbol.TextSymbol.ALIGN_END:case"right":r.xoffset-=s}}return r}return null},e.adjustPictureMarkerSymbol=function(e){if(e&&e.symbol instanceof esri.symbol.PictureMarkerSymbol){var t=new esri.symbol.PictureMarkerSymbol(e.symbol.toJson());if(t.toJson&&"function"==typeof t.toJson){var i=t.toJson;t.toJson=function(){var e,r,n=i.call(t);return n.color=[0,0,0,255],isNaN(e=parseInt(t.width,10))||isNaN(r=parseInt(t.height,10))||(n.width=e,n.height=r,n.xoffset=isNaN(parseInt(n.xoffset))?e/2:n.xoffset+e/2,n.yoffset=isNaN(parseInt(n.yoffset))?r/2:n.yoffset-r/2),n}}return t}return null},e.getImageAsBase64=function(e,t){void 0===t&&(t="image/png");var i=new dojo.Deferred,r=document.createElement("canvas"),n=r.getContext("2d"),s=new Image;return s.onload=function(){r.height=s.height,r.width=s.width,n.drawImage(s,0,0);try{var a=r.toDataURL(t);i.resolve({url:e,data:a.replace(/^data:image\/(png|jpg);base64,/,"")})}catch(o){i.reject({url:e,error:o})}},s.onerror=function(t){i.reject({url:e,error:new Error("Failed to download image.")})},s.src=e,i},e}();t.PrintUtilities=i})},"geocortex/essentials/ReportParameters":function(){define(["require","exports","geocortex/essentials/MapServiceConstants","geocortex/essentials/utilities/PrintUtilities"],function(e,t,i,r){"use strict";var n=function(){function e(){this.customExtent=null,this.extentType="currentExtent",this.fields=[],this.grid=null,this.imageHeight=null,this.imageWidth=null,this.notificationEmailAddress=null,this.outputFormat=null,this.featureIds=null,this.resolution=null,this.scale=null}return e.prototype.toJson=function(t,r){if(!t||!r)throw new Error("Reporting parameter creation is missing a main map.");var n,s,a={},o=this.scale&&void 0!=this.scale.scale&&!isNaN(parseFloat(this.scale.scale))?parseFloat(this.scale.scale):t.getScale();this.scale&&void 0!=this.scale.scale&&(a.scale=this.scale.scale);var l;this.extentType==e.CURRENT_EXTENT&&null!==t?n=t.extent:this.extentType==e.FULL_EXTENT&&null!==r?n=r.fullExtent:this.extentType==e.INITIAL_EXTENT&&null!==r?n=r.initialExtent:this.extentType==e.CUSTOM_EXTENT&&null!==this.customExtent&&(n=this.customExtent),n&&(n.spatialReference&&(s=n.spatialReference.toJson(),s&&(s.wkid&&s.wkid>0?a.bboxSR=s.wkid:s.wkt&&(a.bboxSR=s.wkt))),a.bbox=n.xmin+","+n.ymin+","+n.xmax+","+n.ymax),this.targetSpatialReference&&(s=this.targetSpatialReference.toJson(),s&&(s.wkid&&s.wkid>0?a.targetSR=s.wkid:s.wkt&&(a.targetSR=s.wkt))),this.notificationEmailAddress&&(a.emailAddress=this.notificationEmailAddress),this.imageHeight&&this.imageHeight>0&&(a.imageHeight=this.imageHeight),this.imageWidth&&this.imageWidth>0&&(a.imageWidth=this.imageWidth),t.timeExtent&&(a.time="",t.timeExtent.startTime?a.time+=t.timeExtent.startTime.getTime():a.time+="null",a.time+=",",t.timeExtent.endTime?a.time+=t.timeExtent.endTime.getTime():a.time+="null");var c=[];if(null!==r){var u="",p="",h="";for(l=0;l<r.mapServices.length;l++){var d,f=r.mapServices[l],y="",m=f.serviceLayer,g="";if(m)if(m.visible===!0&&(p+=(""===p?"":";")+f.id+":"+m.opacity),f.mapServiceType===i.MapServiceType.DYNAMIC){d=m.layerDefinitions;var v=0;for(var S in d)v>0&&(g+=","),g+='"'+S+'":"'+d[S].replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"',v++;if(v>0&&(h.length>1&&(h+=","),h+='"'+f.id+'":{',h+=g,h+="}"),m.visible===!0&&m.isVisibleAtScale(o)===!0)if(m instanceof esri.layers.ArcGISDynamicMapServiceLayer){var x=m;x.visibleLayers&&"-1"!==x.visibleLayers.toString()&&(y=x.visibleLayers.toString())}else if(f.layers&&0!==f.layers.length){if(f.layers&&f.layers.length>0)for(var b=0;b<f.layers.length;b++){var I=f.layers[b];I.isVisible()&&I.areAllAncestorsVisible()&&(y+=(0===y.length?"":",")+I.id)}}else y="*"}else if(m.visible===!0&&m.isVisibleAtScale(o)===!0)if(f.layers&&0!==f.layers.length){if(f.layers&&f.layers.length>0)for(var b=0;b<f.layers.length;b++){var I=f.layers[b];I.isVisible()&&I.areAllAncestorsVisible()&&(y+=(0===y.length?"":",")+I.id)}}else y="*";var w=f.id;if(w+=0===y.length?"(hide:*)":"(show:"+y+")",u+=(0===u.length?"":";")+w,f.hasOwnProperty("onDemandCacheSize")){var E={};E.id=f.id;var _=m.getSelectionSymbol();if(_&&_.color){var T=_.color.toRgba();E.selectionColor={r:T[0],g:T[1],b:T[2],a:T[3]}}E.mode=f.queryMode;var L=m.getDefinitionExpression();L&&(E.where=L),m.renderer&&(E.renderer=m.renderer.toJson()),E.selectedFeatures=[];var D=m.getSelectedFeatures();if(D&&D.length>0){var C=m.objectIdField;if(C)for(var R=0;R<D.length;R++){var F=D[R];if(F.attributes){var M=F.attributes[C];M&&E.selectedFeatures.push(M)}}}c.push(E)}}h.length>0&&(h="{"+h+"}",a.layerDefinitions=h),u.length>0&&(a.layers=u),p.length>0&&(a.opacity=p)}c.length>0&&(a.featureLayerOptions=c),this.outputFormat&&(a.outputFormat=this.outputFormat),this.featureIds&&(a.featureIds=this.featureIds),this.resolution&&(a.dpi=this.resolution.dpi),this.mapGraphicsLayers&&(a.graphics=this.mapGraphicsLayers.layers,a.symbols=this.mapGraphicsLayers.symbols),this.includeData&&(a.of=a.of?a.of+",includeData":"includeData"),this.includeGeoreferenceData&&(a.georef=this.includeGeoreferenceData),this.useTransparentBackground&&(a.useTransparentBackground=this.useTransparentBackground);for(var k=0;k<this.fields.length;k++){var A=this.fields[k];a[A.id]=A.value}return this.grid&&(a.grid=this.grid.id),a},e.prototype.populateMapGraphicsLayers=function(e){this.mapGraphicsLayers={layers:[],symbols:[]},this._extractGraphicInformation(e.graphics,this.mapGraphicsLayers.layers,this.mapGraphicsLayers.symbols);for(var t=0;t<e.graphicsLayerIds.length;t++){var i=e.getLayer(e.graphicsLayerIds[t]);!i.visible||i instanceof esri.layers.FeatureLayer&&i.url||this._extractGraphicInformation(i,this.mapGraphicsLayers.layers,this.mapGraphicsLayers.symbols)}},e.prototype._extractGraphicInformation=function(e,t,i){for(var n=0;n<e.graphics.length;n++){var s=e.graphics[n];if(s.visible){var a={},o=null;if(s.symbol?o=s.symbol:e.renderer&&e.renderer.getSymbol&&(o=e.renderer.getSymbol(s),s.symbol=o),!o)continue;i.push(o);for(var l=0;l<i.length-1;l++)if(i[l]==o){a.symbolID=i[l].id,o.id=a.symbolID,i.pop();break}if(void 0==a.symbolID){var c=i.length-1;i[c]instanceof esri.symbol.TextSymbol?i[c]=r.PrintUtilities.adjustTextSymbol(s,e.id):i[c]instanceof esri.symbol.PictureMarkerSymbol&&(i[c]=r.PrintUtilities.adjustPictureMarkerSymbol(s)),a.symbolID=(i.length-1).toString(),i[a.symbolID].id=a.symbolID}a.geometry=s.geometry,t.push({elements:[a],opacity:e.opacity})}}},e}();n.CURRENT_EXTENT="currentExtent",n.CUSTOM_EXTENT="customExtent",n.FULL_EXTENT="fullExtent",n.INITIAL_EXTENT="initialExtent",t.ReportParameters=n})},"geocortex/essentials/exportMap/ExportMapParameters":function(){define(["require","exports","geocortex/essentials/ReportParameters"],function(e,t,i){"use strict";var r=function(){function e(){this.operationParameters=null,this.reportParameters=null,this.queryParameters=null,this.operationParameters={},this.reportParameters=new i.ReportParameters}return e}();t.ExportMapParameters=r})},"geocortex/essentials/PrintTemplate":function(){define(["require","exports","geocortex/essentials/AsyncInitializable","geocortex/essentials/Report","geocortex/essentials/exportMap/ExportMapParameters","geocortex/essentials/exportMap/ExportMapTask","geocortex/geocortex"],function(e,t,i,r,n,s,a){"use strict";var o=function(e){function t(t){var i=e.call(this,t)||this;return i.description=null,i.displayName=null,i.extensions=[],i.id=null,i.visible=null,i.maximumResolution=300,i.properties=null,i.site=null,i.supportedMapScales=[],i.supportedOutputFormats=[],i.supportedResolutions=[],i.supportsEmailNotification=!1,i.textFields=[],i.grids=[],i.type=r.ReportType.MAP_TEMPLATE_REPORT,i.isDefault=!1,i.defaultMapScale=null,i.defaultMapScaleName=null,i.defaultResolution=null,i.defaultGrid=null,i.defaultOutputFormat=null,i._printing=!1,i._onPrintComplete=null,i._onPrintError=null,i.extensions=[],i.properties=[],i.supportedMapScales=[],i.supportedOutputFormats=[],i.supportedResolutions=[],i.textFields=[],i}return __extends(t,e),t.prototype.isPrinting=function(){return this._printing},t.prototype.print=function(e,t,i){var r=this;if(this.isPrinting())return void(i&&i(new Error("Template already printing")));this._onPrintComplete=t,this._onPrintError=i,this._printing=!0;var a=new n.ExportMapParameters;a.reportParameters=e;var o=new s.ExportMapTask(this);o.generateMapImageUrl(a).then(function(e){return r._printRestComplete(e)},function(e){return r._printRestError(e)})},t.prototype._configureObject=function(e,t){if(void 0===e||void 0===e.id||void 0===e.displayName)throw new Error("Incorrect print template object returned from initialization");if(this.description=void 0===e.description?this.description:e.description,this.displayName=e.displayName,this.id=e.id,this.visible=void 0===e.visible||e.visible,this.mainMapWidth=e.mainMapWidth,this.mainMapHeight=e.mainMapHeight,this.maximumResolution=void 0===e.maximumResolution?this.maximumResolution:e.maximumResolution,this.supportedMapScales=void 0===e.supportedScales?this.supportedMapScales:e.supportedScales,this.supportedOutputFormats=void 0===e.supportedOutputFormats?this.supportedOutputFormats:e.supportedOutputFormats,this.supportedResolutions=void 0===e.supportedResolutions?this.supportedResolutions:e.supportedResolutions,this.supportsEmailNotification=!!e.supportsEmailNotification,this.textFields=void 0===e.textFields?this.textFields:e.textFields,this.grids=void 0===e.grids?this.grids:e.grids,t&&(this.isInitialized=!0),this.properties=a._getProperties(e.properties),this.extensions=a._getExtensions(e.extensions),this.isDefault=void 0===e.isDefault?this.isDefault:e.isDefault,this.defaultMapScaleName=void 0===e.defaultMapScale?null:e.defaultMapScale,this.defaultMapScaleName)for(var i=0;i<this.supportedMapScales.length;i++)this.defaultMapScaleName===this.supportedMapScales[i].displayName&&(this.defaultMapScale=this.supportedMapScales[i]);var r=void 0===e.defaultResolution?null:e.defaultResolution;if(r)for(var i=0;i<this.supportedResolutions.length;i++)r===this.supportedResolutions[i].displayName&&(this.defaultResolution=this.supportedResolutions[i]);var n=void 0===e.defaultGrid?null:e.defaultGrid;if(n)for(var i=0;i<this.grids.length;i++)n===this.grids[i].displayName&&(this.defaultGrid=this.grids[i]);this.defaultOutputFormat=void 0===e.defaultOutputFormat?this.defaultOutputFormat:e.defaultOutputFormat},t.prototype._printRestComplete=function(e){this._printing=!1;var t=null;e?e.error&&(t=e.error):t=new Error("Unexpected Error"),t?this._onPrintError&&this._onPrintError(t):this._onPrintComplete&&this._onPrintComplete(e)},t.prototype._printRestError=function(e){this._printing=!1,this._onPrintError&&this._onPrintError(e)},t}(i.AsyncInitializable);t.PrintTemplate=o})},"geocortex/essentials/exportMap/ExportOptions":function(){define(["require","exports"],function(e,t){"use strict"})},"geocortex/essentials/exportMap/ExportLayoutOptions":function(){define(["require","exports"],function(e,t){"use strict"})},"geocortex/essentials/exportMap/ExportMapOptions":function(){define(["require","exports"],function(e,t){
"use strict"})},"geocortex/essentials/exportMap/ExportDynamicMapLayerDefinition":function(){define(["require","exports"],function(e,t){"use strict"})},"geocortex/essentials/exportMap/ExportMapLayerDefinition":function(){define(["require","exports"],function(e,t){"use strict"})},"geocortex/essentials/exportMap/ExportSymbol":function(){define(["require","exports"],function(e,t){"use strict"})},"geocortex/essentials/exportMap/ExportFeature":function(){define(["require","exports"],function(e,t){"use strict"})},"geocortex/essentials/exportMap/ExportLayerFeatureSet":function(){define(["require","exports"],function(e,t){"use strict"})},"geocortex/essentials/exportMap/ExportLayer":function(){define(["require","exports"],function(e,t){"use strict"})},"geocortex/essentials/exportMap/ExportFeatureCollection":function(){define(["require","exports"],function(e,t){"use strict"})},"geocortex/essentials/exportMap/ExportMapService":function(){define(["require","exports"],function(e,t){"use strict"})},"geocortex/essentials/exportMap/ExportContext":function(){define(["require","exports"],function(e,t){"use strict"})},"geocortex/essentials/utilities/PromiseUtilities":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(){this.state={fulfilled:!1,rejected:!1}}return e.prototype.fulfill=function(e){this.state.fulfilled=!0,this.state.value=e},e.prototype.reject=function(e){this.state.rejected=!0,this.state.reason=e},e.prototype.isFulfilled=function(){return this.state.fulfilled},e.prototype.isRejected=function(){return this.state.rejected},e.prototype.isPending=function(){return!this.state.fulfilled&&!this.state.rejected},e.prototype.value=function(){return this.state.value},e.prototype.reason=function(){return this.state.reason},e}(),r=function(){function e(){}return e.settle=function(t){if(dojo.isArray(t))return e._settleImpl(t);if(t.then)return t.then(function(t){return e._settleImpl(t)});throw new Error("Unknown parameter type.  Must be an array of promises or a promise of array of promises.")},e._settleImpl=function(e){var t,r=new dojo.Deferred,n=e.map(function(e){var r=new i;return e&&"function"==typeof e.then?e.then(function(e){r.fulfill(e),t&&t()},function(e){r.reject(e),t&&t()}):r.fulfill(e),r});return t=function(){n.every(function(e){return!e.isPending()})&&r.resolve(n)},t(),r.promise},e}();t.PromiseUtilities=r})},"geocortex/essentials/utilities/EncodeImageResult":function(){define(["require","exports"],function(e,t){"use strict"})},"geocortex/essentials/utilities/EncodeImageError":function(){define(["require","exports"],function(e,t){"use strict"})},"geocortex/essentials/exportMap/ExportMapTypes":function(){define(["require","exports"],function(e,t){"use strict";t.WEBTILED="WebTiledLayer",t.BINGAERIAL="BingMapsAerial",t.BINGAERIALLABELS="BingMapsAerialWithLabels",t.BINGROADS="BingMapsRoad",t.BINGHYBRID="BingMapsHybrid"})},"geocortex/essentials/exportMap/BingEnvironment":function(){define(["require","exports"],function(e,t){"use strict";t.PRODUCTION="Production"})},"geocortex/essentials/utilities/GraphicsLayerUtilities":function(){define(["require","exports"],function(e,t){"use strict";function i(e){var t=[];return e.forEach(function(e){s[e]&&s[e].forEach(function(e){t.indexOf(e)<0&&t.push(e)})}),t}function r(e,t){t&&t.length>0&&e.forEach(function(e){s[e]||(s[e]=[]),s[e].indexOf(t)<0&&s[e].push(t)})}function n(e,t){t&&t.length>0&&e.forEach(function(e){if(s[e]){var i=s[e].indexOf(t);i>=0&&s[e].splice(i,1)}})}t.excludeFromExportMapTaskName="ExportMapTask";var s={};t.getGraphicsLayerIdsToExclude=i,t.addToGraphicsLayerIdsToExclude=r,t.removeFromGraphicsLayerIdsToExclude=n})},"geocortex/essentials/exportMap/ExportMapTask":function(){define(["require","exports","geocortex/geocortex","geocortex/essentials/utilities/UrlUtilities","geocortex/essentials/utilities/PrintUtilities","geocortex/essentials/utilities/PromiseUtilities","geocortex/essentials/exportMap/ExportMapTypes","geocortex/essentials/exportMap/BingEnvironment","geocortex/essentials/ReportParameters","geocortex/essentials/utilities/GraphicsLayerUtilities"],function(e,t,i,r,n,s,a,o,l,c){"use strict";var u=function(){function e(e){if(this.resource=null,this._esriMap=null,this._essentialsRestUrl=null,this._site=null,this._populateFromResource(e),!this._esriMap||!this._essentialsRestUrl)throw new Error("Unable to create ExportMapTask from the resource.")}return e.prototype._populateFromResource=function(e){e.hasOwnProperty("extentManager")?(this._esriMap=e.getMap(),this._essentialsRestUrl=e.url+"/export",this._site=e.site):e.hasOwnProperty("maximumResolution")?(this._esriMap=e.site.getMap(),this._essentialsRestUrl=e.url+"/print",this._site=e.site):e&&(this._esriMap=e.site.getMap(),this._essentialsRestUrl=e.url+"/run",this._site=e.site)},e.prototype.generateMapImageUrl=function(e){var t=this,r=new dojo.Deferred;return this._marshalContent(e).then(function(e){var n={url:t._essentialsRestUrl,content:e,load:r.resolve,error:r.reject,callbackParamName:"CallBack"};i.request(n)}),r},e.prototype._getWebMap=function(e,t,i){var r=new esri.tasks.PrintTemplate;r.outScale=i;for(var n=[],s=0,a=t.graphicsLayerIds;s<a.length;s++){var o=a[s],l=t.getLayer(o);1===l.opacity&&(l.setOpacity(.999),n.push(l))}try{var c=e._getPrintDefinition(t,r);return c}finally{for(var u=0,p=n;u<p.length;u++){var l=p[u];l.setOpacity(1)}}},e.prototype._getPrintingObjectForEssentials=function(e){var t=new dojo.Deferred,i=new esri.tasks.PrintTask("http://3275ec4b-ad36-465e-97e9-a20acaae8d53/",{async:!1}),r=null;try{r=this._getWebMap(i,this._esriMap,e)}catch(n){t.reject(new Error("Could not create ExportContext definition. {0} Verify that subroutines have not changed.".format(n&&n.message?n.message:"Unable to determine cause.")))}return r?(this._removeInternalLayers(r),this._handleFeatureLayers(r),this._handleDynamicLayerDefs(r),this._cleanOutVisibility(r),this._handleWebTiledLayers(r),this._handleLayersAttribution(r,this._esriMap),this._handleHeatmapRenderer(r,this._esriMap),this._handleClusters(r,this._esriMap),this._adjustMeasurementsMarkup(r),this._adjustPlotCoordinatesMarkup(r),this._removeAttributes(r),this._adjustText(r),this._setServiceVisibilities(r),this._adjustPlotCoordinatesMarkupOrder(r),this._finalizePrintingContext(r),this._convertSymbolsToBase64(r).then(function(e){return t.resolve(e)},function(e){return t.reject(new Error("Converting symbols to base64 failed: {0}".format(e&&e.message?e.message:"Unable to determine cause")))})):t.reject(new Error("ExportContext definition was empty")),t},e.prototype._removeInternalLayers=function(e){for(var t=e.operationalLayers.length-1;t>=0;t--){var i=e.operationalLayers[t].id;i&&c.getGraphicsLayerIdsToExclude([c.excludeFromExportMapTaskName]).indexOf(i)>-1&&e.operationalLayers.splice(t,1)}},e.prototype._convertSymbolsToBase64=function(e){for(var t=new dojo.Deferred,i=[],a={},o=0;o<e.operationalLayers.length;o++){var l=e.operationalLayers[o];if(l.featureCollection&&l.featureCollection.layers)for(var c=0;c<l.featureCollection.layers.length;c++){var u=l.featureCollection.layers[c];if(u.featureSet&&u.featureSet.features)for(var p=0;p<u.featureSet.features.length;p++){var h=u.featureSet.features[p];if(h&&h.symbol&&"esriPMS"===h.symbol.type){var d=h.symbol;d.url&&i.push(d)}}}}if(Modernizr&&Modernizr.canvas){for(var f=[],o=0;o<i.length;o++){var y=i[o].url;if(y&&!a.hasOwnProperty(y)&&!i[o].imageData){a[y]={url:null,data:null};var m=n.PrintUtilities.getImageAsBase64(y);f.push(m)}}s.PromiseUtilities.settle(f).then(function(n){n.forEach(function(e){if(e.isFulfilled()){var t=e.value();t&&t.url&&t.data&&(a[t.url]={data:t.data})}else{var n=e.reason();n&&n.url&&(a[n.url]={url:r.UrlUtilities.simplify(y)})}for(var s=0;s<i.length;s++){var o=i[s],l=a[o.url];l&&(l.data?(o.imageData=l.data,delete o.url):l.url&&(o.url=l.url)),o.yoffset&&(o.yoffset=o.yoffset*-1)}}),t.resolve(e)})}else{for(var o=0;o<i.length;o++){var y=i[o].url;y&&(i[o].url=r.UrlUtilities.simplify(y))}t.resolve(e)}return t},e.prototype._adjustMeasurementsMarkup=function(e){var t=this._getLayer(e,"_measurement");t&&t.id&&this._adjustSvgSymbols(t)},e.prototype._adjustPlotCoordinatesMarkup=function(e){var t=this._getLayer(e,"_coordinates");t&&t.id&&this._adjustSvgSymbols(t)},e.prototype._adjustPlotCoordinatesMarkupOrder=function(e){var t=this._getLayer(e,"_coordinates");if(t&&t.featureCollection&&t.featureCollection.layers)for(var i=null,r=null,n=0;n<t.featureCollection.layers.length;n++){var s=t.featureCollection.layers[n];if(s.layerDefinition&&("pointLayer"===s.layerDefinition.name?i=s:"textLayer"===s.layerDefinition.name&&(r=s)),i&&r){if(i.featureSet&&i.featureSet.features&&i.featureSet.features.length>0&&r.featureSet&&r.featureSet.features&&r.featureSet.features.length>0&&r.featureSet.features.length/i.featureSet.features.length===1.5){for(var a=[];i.featureSet.features.length>0;)a.push(r.featureSet.features.pop()),a.push(r.featureSet.features.pop()),a.push(r.featureSet.features.pop()),a.push(i.featureSet.features.pop()),a.push(i.featureSet.features.pop());i.featureSet.features=a.reverse()}break}}},e.prototype._getLayer=function(e,t){for(var i=0;i<e.operationalLayers.length;i++){var r=e.operationalLayers[i];if(r&&r.id&&r.id.indexOf(t)>-1&&r.featureCollection&&r.featureCollection.layers)return r}},e.prototype._adjustSvgSymbols=function(e){for(var t=e.id,i=[],r=this._esriMap.getLayer(t),n=r.graphics.filter(function(e){return!("simplemarkersymbol"!=e.symbol.type||!e.visible)}),s=0;s<n.length;s++)i.push(n[s].toJson());for(var s=0;s<e.featureCollection.layers.length;s++)if("pointLayer"===e.featureCollection.layers[s].layerDefinition.name){e.featureCollection.layers[s].featureSet.features=i;break}},e.prototype._adjustText=function(e){for(var t=0;t<e.operationalLayers.length;t++){var i=e.operationalLayers[t];if(i&&i.id&&i.featureCollection&&i.featureCollection.layers){for(var r=!1,s=0;s<i.featureCollection.layers.length;s++){var a=i.featureCollection.layers[s];if(a&&a.layerDefinition&&"textLayer"===a.layerDefinition.name){r=!0;break}}if(!r)continue;var o=i.id,l=[],c=this._esriMap.getLayer(o);if(c&&c.graphics){for(var u=c.graphics.filter(function(e){return!(!("textsymbol"==e.symbol.type||e.symbol instanceof esri.symbol.TextSymbol)||!e.visible)}),p=0;p<u.length;p++){var h=u[p],d=n.PrintUtilities.adjustTextSymbol(h,c.id);if(d){var f=new esri.Graphic(h.toJson());f.symbol=d,l.push(f.toJson())}}for(var p=0;p<i.featureCollection.layers.length;p++)"textLayer"===i.featureCollection.layers[p].layerDefinition.name&&(i.featureCollection.layers[p].featureSet.features=l)}}}},e.prototype._setServiceVisibilities=function(e){if(e.operationalLayers)for(var t=e.operationalLayers,i=0;i<t.length;i++){var r=t[i],n=this._esriMap.getLayer(r.id);r&&(r.visibility=!n||n.visible)}},e.prototype._handleDynamicLayerDefs=function(e){if(this._site&&e.operationalLayers)for(var t=e.operationalLayers,i=0;i<t.length;i++){var r=t[i].id,n=this._site.essentialsMap.findMapServiceById(r);if(n&&n.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer){var s=t[i],a=n.serviceLayer;if(!s)continue;if(s.layers){for(var o=[],l=s.layers,c=0;c<l.length;c++){var u=l[c];if(u&&(u.id||0===u.id)){var p=u.id,h={id:p,name:u.name,geometryType:u.geometryType?u.geometryType:null};if(u.layerDefinition&&((u.layerDefinition.drawingInfo||u.layerDefinition.source)&&(h.layerDefinition||(h.layerDefinition={}),h.layerDefinition.drawingInfo=u.layerDefinition.drawingInfo,h.layerDefinition.source=u.layerDefinition.source),u.layerDefinition.definitionExpression&&(h.layerDefinition?h.layerDefinition.definitionExpression=u.layerDefinition.definitionExpression:h.layerDef=u.layerDefinition.definitionExpression)),p||0===p){var d=n.findLayerById(p.toString());d&&d.displayName&&h.layerDefinition&&(h.layerDefinition.displayName=d.displayName)}o.push(h)}}s.layers=o}a.gdbVersion&&(s.gdbVersion=a.gdbVersion),s.visibleLayers=n.serviceLayer.visibleLayers,s.visibility=!0}}},e.prototype._handleFeatureLayers=function(e){if(this._site&&e.operationalLayers)for(var t=e.operationalLayers,i=0;i<t.length;i++){var r=t[i].id,n=this._site.essentialsMap.findMapServiceById(r);if(n&&n.serviceLayer instanceof esri.layers.FeatureLayer){var s=n.serviceLayer,a=t[i],o={id:r,opacity:a.opacity,visibility:!0,url:a.url,minScale:a.minScale?a.minScale:0,maxScale:a.maxScale?a.maxScale:0};s.gdbVersion&&(o.gdbVersion=s.gdbVersion),a.layerDefinition?(a.layerDefinition.drawingInfo&&(o.drawingInfo=a.layerDefinition.drawingInfo),a.layerDefinition.definitionExpression&&(o.where=a.layerDefinition.definitionExpression)):o.where=s.getDefinitionExpression(),o.featureCollection=a.featureCollection,t[i]=o}}},e.prototype._cleanOutVisibility=function(e){if(e.operationalLayers)for(var t=e.operationalLayers,i=0;i<t.length;i++)if(t[i].visibleLayers)for(var r=0;r<t[i].visibleLayers.length;r++)if(t[i].visibleLayers[r]==-1){t[i].visibleLayers.splice(r,1);break}},e.prototype._handleWebTiledLayers=function(e){if(e.operationalLayers)for(var t=e.operationalLayers,i=0;i<t.length;i++)t[i].type===a.WEBTILED?t[i]={id:t[i].id,opacity:t[i].opacity,visibility:!0}:t[i].type!==a.BINGAERIAL&&t[i].type!==a.BINGAERIALLABELS&&t[i].type!==a.BINGHYBRID&&t[i].type!==a.BINGROADS||(t[i].type===a.BINGAERIALLABELS&&(t[i].type=a.BINGHYBRID),t[i]={id:t[i].id,opacity:t[i].opacity,visibility:!0,type:t[i].type,token:t[i].key,serverType:o.PRODUCTION})},e.prototype._handleLayersAttribution=function(e,t){var i=t.layerIds.concat(t.graphicsLayerIds),r=new RegExp(".*mapservices/([^/]*)/Attribution[^/]*");e.operationalLayers.forEach(function(e){for(var n in i)if(i.hasOwnProperty(n)){var s=i[n];if(e.id===s){var a=t.getLayer(s);if(a.hasAttributionData&&a.attributionDataUrl){var o=r.exec(a.attributionDataUrl);if(o&&o.length>1){var l=o[1];e.mapServiceId=l}}else!a.layerId||e.id.indexOf("-")>-1||(e.mapServiceId=a.layerId);break}}})},e.prototype._handleHeatmapRenderer=function(e,t){var i="null_image",r=t.layerIds.concat(t.graphicsLayerIds);r.forEach(function(r){var n=t.getLayer(r);if(n.visible&&void 0!==n.renderer&&n.renderer instanceof esri.renderer.HeatmapRenderer)for(var s=n.minScale?n.minScale:0,a=n.maxScale?n.maxScale:0,o=n.getDefinitionExpression()?n.getDefinitionExpression():"",l=n.gdbVersion?n.gdbVersion:"",c=n.renderer.toJson(),u=n.url,p=n.renderer.field?n.renderer.field:"",h={renderer:c},d={name:n.name,geometryType:"esriGeometryPoint",displayField:p},f={type:"HeatMap",id:r,opacity:1,minScale:s,maxScale:a,where:o,gdbVersion:l,url:u,layerDefinition:d,drawingInfo:h},y=0;y<e.operationalLayers.length;y++)if(e.operationalLayers[y].id.startsWith(i)){e.operationalLayers[y]=f;break}})},e.prototype._handleClusters=function(e,t){var i=t.layerIds.concat(t.graphicsLayerIds),r="-cluster",n=[];e.operationalLayers.forEach(function(e,t,i){e.id.endsWith(r)&&n.push(e.id)}),n.forEach(function(t){for(var i=0;i<e.operationalLayers.length;++i){var r=e.operationalLayers[i];if(r.id===t){e.operationalLayers.splice(i,1);break}}}),i.forEach(function(i){var n=t.getLayer(i);if(n.id.endsWith(r)&&n.visible&&void 0!==n.renderer&&n.renderer instanceof esri.renderer.ClassBreaksRenderer&&n.featureLayer&&n.singleFeatureLayer){for(var s=n.featureLayer,a=s.id,o=n.url,l=n.renderer.attributeField,c=n.clusterRadius.get(),u=n.maxFeaturesInCluster.get(),p=n._clusterLabelColor,h=n.singleFeatureLayer.renderer.toJson(),d=n.renderer.toJson(),f=s.name,y=s.minScale?s.minScale:0,m=s.maxScale?s.maxScale:0,g=s.getDefinitionExpression()?s.getDefinitionExpression():"",v=s.gdbVersion?s.gdbVersion:"",S=0;S<e.operationalLayers.length;++S)if(e.operationalLayers[S].id===a){null===s.renderer&&e.operationalLayers.splice(S,1);break}if(0==n.singleFeatureLayer.graphics.length){var x={renderer:d,singleSymbolRenderer:h,labelColor:p,distance:c,maxFeaturesInCluster:u},b={name:f,geometryType:"esriGeometryPoint",displayField:l},I={type:"Cluster",id:i,opacity:1,minScale:y,maxScale:m,where:g,gdbVersion:v,url:o,layerDefinition:b,drawingInfo:x};e.operationalLayers.splice(S,0,I)}}})},e.prototype._removeAttributes=function(e){if(e.operationalLayers)for(var t=0;t<e.operationalLayers.length;t++){var i=e.operationalLayers[t];if(i&&i.featureCollection&&i.featureCollection.layers)for(var r=0;r<i.featureCollection.layers.length;r++){var n=i.featureCollection.layers[r];if((!(n&&n.layerDefinition&&n.layerDefinition.drawingInfo&&n.layerDefinition.drawingInfo.renderer)||"uniqueValue"!==n.layerDefinition.drawingInfo.renderer.type&&"classBreaks"!==n.layerDefinition.drawingInfo.renderer.type)&&n&&n.featureSet&&n.featureSet.features)for(var s=0;s<n.featureSet.features.length;s++){var a=n.featureSet.features[s];a&&a.attributes&&delete a.attributes}}}},e.prototype._finalizePrintingContext=function(e){this._fixMapServiceIds(e,this._esriMap,this._site)},e.prototype._fixMapServiceIds=function(e,t,i){if(e.operationalLayers&&t&&i)for(var r=e.operationalLayers,n=0;n<r.length;n++){var s=r[n].id,a=t.getLayer(s);if(a&&(a instanceof esri.layers.WMSLayer||a instanceof esri.layers.TiledMapServiceLayer)){for(var o=null,l=0;l<i.essentialsMap.mapServices.length;l++)if(i.essentialsMap.mapServices[l].serviceLayer==a){o=i.essentialsMap.mapServices[l];break}o&&(r[n].id=o.id)}}},e.prototype._marshalContent=function(e){var t,i=this,r=new dojo.Deferred;return e.reportParameters&&e.reportParameters.scale&&(t=parseFloat(e.reportParameters.scale.scale)),this._getPrintingObjectForEssentials(t).then(function(t){var n={f:"json","if":"WebMap,blankMap"};if(i._site&&(t.product="Geocortex Essentials "+i._site.currentVersion,i._site.displayTimeZoneId&&(n.displayTimeZoneId=i._site.displayTimeZoneId)),e.reportParameters){var s=e.reportParameters;if(t.mapOptions||(t.mapOptions={extent:null}),delete t.mapOptions.scale,s.scale){var a=parseFloat(s.scale.scale);a&&!isNaN(a)&&(t.mapOptions.scale=a)}s.targetSpatialReference&&(t.mapOptions.spatialReference=s.targetSpatialReference),s.extentType==l.ReportParameters.CURRENT_EXTENT&&i._esriMap?t.mapOptions.extent=i._esriMap.extent:s.extentType==l.ReportParameters.FULL_EXTENT&&i._site&&i._site.essentialsMap?t.mapOptions.extent=i._site.essentialsMap.fullExtent:s.extentType==l.ReportParameters.INITIAL_EXTENT&&i._site&&i._site.essentialsMap?t.mapOptions.extent=i._site.essentialsMap.initialExtent:s.extentType==l.ReportParameters.CUSTOM_EXTENT&&s.customExtent&&(t.mapOptions.extent=s.customExtent);var o={dpi:null,outputSize:[]};if(s.imageWidth?o.outputSize[0]=s.imageWidth:o.outputSize[0]=i._esriMap.width,s.imageHeight?o.outputSize[1]=s.imageHeight:o.outputSize[1]=i._esriMap.height,s.resolution?o.dpi=s.resolution.dpi:o.dpi=96,t.exportOptions=o,s.grid&&s.grid.id){var c={grid:s.grid.id};t.layoutOptions=c}if(s.fields&&s.fields.length>0)for(var u=0;u<s.fields.length;u++)n[s.fields[u].id]=s.fields[u].value;s.outputFormat&&(n.outputFormat=s.outputFormat),s.featureIds&&(n.featureIDs=s.featureIds.join(",")),s.includeGeoreferenceData&&(n.georef=s.includeGeoreferenceData),s.includeData&&(n.of=n.of?n.of+",includeData":"includeData")}e.queryParameters&&(n=dojo.mixin(e.queryParameters,n),n.geometry&&(n.geometry=JSON.stringify(n.geometry))),e.operationParameters&&(n=dojo.mixin(e.operationParameters,n)),s.notificationEmailAddress&&(n.emailAddress=s.notificationEmailAddress),n.data=JSON.stringify(t),r.resolve(n)},function(e){return r.reject(new Error("Failed to serialize ExportContext content: {0}".format(e&&e.message?e.message:"Unable to determine cause")))}),r},e}();t.ExportMapTask=u})},"geocortex/essentials/Report":function(){define(["require","exports","geocortex/essentials/AsyncInitializable","geocortex/essentials/exportMap/ExportMapTask","geocortex/essentials/exportMap/ExportMapParameters","geocortex/essentials/RestHelper","geocortex/geocortex"],function(e,t,i,r,n,s,a){"use strict";var o=function(e){function t(t){var i=e.call(this,t)||this;return i.description=null,i.displayName=null,i.extensions=[],i.id=null,i.visible=!1,i.layer=null,i.properties={},i.supportedMapScales=[],i.supportedOutputFormats=[],i.supportedResolutions=[],i.textFields=[],i._running=!1,i._onRunReportComplete=null,i._onRunReportError=null,i}return __extends(t,e),t.prototype.isRunning=function(){return this._running},t.prototype.run=function(e,t,i,a){var o=this;if(this.isRunning()){if(a){var l=new Error("Report already running");l.name="ReportAlreadyRunning",a(l)}}else{this._running=!0;try{this._onRunReportComplete=i,this._onRunReportError=a;var c=new r.ExportMapTask(this),u=new n.ExportMapParameters;u.reportParameters=t,e&&(u.queryParameters=s.RestHelper._createRestParametersFromQuery(e)),c.generateMapImageUrl(u).then(function(e){return o._runRestComplete(e)},function(e){return o._runRestError(e)})}catch(l){if(this._running=!1,!this._onRunReportError)throw l;this._onRunReportError(l)}}},t.prototype._configureObject=function(e,t){if(void 0===e.id||void 0===e.displayName)throw new Error("Incorrect report object returned from initialization");this.id=e.id,this.visible=void 0===e.visible||e.visible,this.supportedOutputFormats=e.supportedOutputFormats,this.supportedResolutions=e.supportedResolutions,this.supportedMapScales=e.supportedScales,this.textFields=e.textFields,this.description=e.description,this.displayName=e.displayName,t&&(this.isInitialized=!0),this.properties=a._getProperties(e.properties),this.extensions=a._getExtensions(e.extensions)},t.prototype._runRestComplete=function(e){this._running=!1;var t=null;e?e.error&&(t=e.error):t=new Error("No results"),t&&this._onRunReportError&&this._onRunReportError(t),e&&this._onRunReportComplete&&this._onRunReportComplete(e)},t.prototype._runRestError=function(e){this._running=!1,this._onRunReportError&&this._onRunReportError(e)},t}(i.AsyncInitializable);t.Report=o;var l;!function(e){e.LAYER_TEMPLATE_REPORT="Layer Template Report",e.MAP_TEMPLATE_REPORT="Map Template Report"}(l=t.ReportType||(t.ReportType={}))})},"geocortex/essentials/LayerStyle":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(e,t,i,r){void 0===r&&(r=!1),this.rendererJson=e,this.displayName=t,this.id=i,this.enabled=r}return e.prototype.getRenderer=function(){var e=esri.renderer.fromJson(JSON.parse(this.rendererJson));return e instanceof esri.renderer.Renderer||console.error("Layer Style: '{0}'. Could not create a valid renderer from the stored JSON string: '{1}'".format(this.displayName,this.rendererJson)),e},e.prototype.setRenderer=function(e){e instanceof esri.renderer.Renderer?this.rendererJson=JSON.stringify(e.toJson()):esri.renderer.fromJson(JSON.parse(e))instanceof esri.renderer.Renderer?this.rendererJson=e:console.error("Layer Style: '{0}'. Supplied JSON string could not be used to create a valid renderer: '{1}'".format(this.displayName,e))},e.prototype.isSimple=function(){var e=JSON.parse(this.rendererJson);return"simple"===e.type},e}();t.LayerStyle=i})},"geocortex/essentials/LayerQuery":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(e){e&&(this.id=e.id,this.displayName=e.displayName,this.query=e.query)}return e}();t.LayerQuery=i})},"geocortex/essentials/LayerType":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(){}return e}();i.UNKNOWN=0,i.FEATURE_LAYER=1,i.RASTER_LAYER=2,i.GROUP_LAYER=3,i.GEO_RSS_LAYER=4,i.TABLE_LAYER=5,t.LayerType=i})},"geocortex/essentials/RefreshVisibility":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(){}return e}();i.DEFAULT="Default",i.SHOW="Show",i.HIDE="Hide",t.RefreshVisibility=i})},"geocortex/essentials/LayerThemeEventArgs":function(){define(["require","exports"],function(e,t){"use strict"})},"geocortex/essentials/LayerThemesInfo":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(e){this.layerThemeChangedEvent=function(e){},this.themeChangeInProgress=!1,this.layerThemeChangingEvent=function(e){},this.layerThemesConfigured=!1,this.allowDefault=!1,this.themes=[],this.map=e}return e.prototype.applyTheme=function(e){if(this.layerThemesConfigured){var t=this.getTheme(e);t?t.applyToMap():console.log("Error: Theme with ID '{0}' could not be found and was not activated.".format(e))}else console.log("Warning: No layer themes have been configured by the essentials administrator.")},e.prototype.getTheme=function(e,t){if(void 0===t&&(t=!1),this.layerThemesConfigured)for(var i=0;i<this.themes.length;i++){if(this.themes[i].id===e)return this.themes[i];if(t&&this.themes[i].displayName.toLowerCase()===e.toLowerCase())return this.themes[i]}return null},e}();t.LayerThemesInfo=i})},"geocortex/essentials/LayerTheme":function(){define(["require","exports","geocortex/geocortex","geocortex/essentials/Layer","geocortex/essentials/LayerType"],function(e,t,i,r,n){"use strict";var s=function(){function e(e,t,i){this.layerThemesInfo=e;var r="object"==typeof t?t:null;this._configureLayerTheme(r,t,i)}return e.prototype._configureLayerTheme=function(e,t,r){this.id=e?e.id:t,this.isDefaultTheme=null===this.id,this.isActive=!1,this.displayName=e?e.displayName:r,this.extensions=i._getExtensions(e?e.extensions:null),this.properties=e?e.properties:null},e.prototype.applyToMap=function(){var e=this;if(void 0==this.layerThemesInfo)throw new Error("Could not apply theme '{0}' to the map because the LayerThemesInfo property is not set on this LayerTheme.".format(this.displayName));var t=this.layerThemesInfo,i=t.map;if(void 0==i)throw new Error("Failed to apply theme '{0}' to map because the Map property is not set on the LayerThemesInfo object.".format(this.displayName));this.isActive=!0,(t.activeTheme&&t.activeTheme!==this||!t.activeTheme)&&(t.activeTheme&&(t.previousTheme=t.activeTheme,t.previousTheme.isActive=!1),t.activeTheme=this),t.themeChangeInProgress=!0,t.layerThemeChangingEvent({currTheme:t.activeTheme,prevTheme:t.previousTheme});for(var s=function(e,t){void 0===t&&(t=!1),e.setInActiveTheme(!0),o(e,e.configuredVisible,t)},a=function(t,i){void 0===i&&(i=!1);var r=t.getLayerThemeSettings(e.id);t.setInActiveTheme(null!=r);var n=!1;null!=r&&(n=void 0!=r.visible?r.visible:t.configuredVisible),o(t,n,i)},o=function(e,t,i){if(void 0===i&&(i=!1),e instanceof r.Layer){var s=e;if(s.mapService.supportsLayerVisibility()){var a=s.mapService.essentialsMap.site.getEssentialsVersion();a>=4.02&&s.type===n.LayerType.GROUP_LAYER&&(t=!0)}else if(1!==s.mapService.layers.length||!s.inActiveTheme||s.mapService.includeInLayerList)return}e.isUserCreated||e.setVisibility(t,i)},l=0;l<i.mapServices.length;l++){var c=i.mapServices[l],u=c.supportsLayerVisibility();this.isDefaultTheme?s(c):a(c);for(var p=0;p<c.layers.length;p++){var h=c.layers[p];this.isDefaultTheme?s(h,u):a(h,u)}u&&c.refresh()}i.refreshFilteredCollections(),t.themeChangeInProgress=!1,t.layerThemeChangedEvent({currTheme:t.activeTheme,prevTheme:t.previousTheme})},e}();t.LayerTheme=s})},"geocortex/essentials/LayerThemeSetting":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(e,t){this.theme=e,this.visible=t}return e}();t.LayerThemeSetting=i})},"geocortex/essentials/TimeUnits":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(){}return e}();i.UNIT_CENTURIES="esriTimeUnitsCenturies",i.UNIT_DAYS="esriTimeUnitsDays",i.UNIT_DECADES="esriTimeUnitsDecades",i.UNIT_HOURS="esriTimeUnitsHours",i.UNIT_MILLISECONDS="esriTimeUnitsMilliseconds",i.UNIT_MINUTES="esriTimeUnitsMinutes",i.UNIT_MONTHS="esriTimeUnitsMonths",i.UNIT_SECONDS="esriTimeUnitsSeconds",i.UNIT_WEEKS="esriTimeUnitsWeeks",i.UNIT_YEARS="esriTimeUnitsYears",i.UNIT_UNKNOWN="esriTimeUnitsUnknown",t.TimeUnits=i;var r=function(){function e(){}return e}();r.Century=i.UNIT_CENTURIES,r.Day=i.UNIT_DAYS,r.Decade=i.UNIT_DECADES,r.Hour=i.UNIT_HOURS,r.MilliSecond=i.UNIT_MILLISECONDS,r.Minute=i.UNIT_MINUTES,r.Month=i.UNIT_MONTHS,r.Second=i.UNIT_SECONDS,r.Week=i.UNIT_WEEKS,r.Year=i.UNIT_YEARS,t.EssentialsTimeUnits=r})},"geocortex/essentials/LayerTimeOptions":function(){define(["require","exports"],function(e,t){"use strict"})},"geocortex/essentials/TimeExtent":function(){define(["require","exports"],function(e,t){"use strict"})},"geocortex/essentials/TimeReference":function(){define(["require","exports"],function(e,t){"use strict"})},"geocortex/essentials/TimeInfo":function(){define(["require","exports","geocortex/essentials/utilities/StringUtilities"],function(e,t,i){"use strict";function r(e,t,r){var n=null,s=null;if(e&&e.timeExtent&&(n=e.timeExtent&&e.timeExtent.startTime instanceof Date?e.timeExtent.startTime.valueOf():parseInt(e.timeExtent[0],10),s=e.timeExtent&&e.timeExtent.endTime instanceof Date?e.timeExtent.endTime.valueOf():parseInt(e.timeExtent[1],10)),(!n||isNaN(n))&&!t||(!s||isNaN(s))&&!r)return null;var a=t?i.StringUtilities.getDateFromRestDateString(t):new Date(n),o=r?i.StringUtilities.getDateFromRestDateString(r):new Date(s),l={};return l.timeExtent={startTime:a,endTime:o},e&&(e.startTimeField&&(l.startTimeField=e.startTimeField),e.endTimeField&&(l.endTimeField=e.endTimeField),e.trackIdField&&(l.trackIdField=e.trackIdField),e.timeReference&&(l.timeReference={},void 0!=e.timeReference.respectsDaylightSaving&&(l.timeReference.respectsDaylightSavings=e.timeReference.respectsDaylightSaving),void 0!=e.timeReference.timeZone&&(l.timeReference.timeZone=e.timeReference.timeZone)),e.exportOptions&&(l.exportOptions={},void 0!=e.exportOptions.timeDataCumulative&&(l.exportOptions.timeDataCumulative=e.exportOptions.timeDataCumulative),void 0!=e.exportOptions.timeOffset&&(l.exportOptions.timeOffset=e.exportOptions.timeOffset),void 0!=e.exportOptions.timeOffsetUnits&&(l.exportOptions.timeOffsetUnits=e.exportOptions.timeOffsetUnits),void 0!=e.exportOptions.useTime&&(l.exportOptions.useTime=e.exportOptions.useTime))),l}t.getGcxTimeInfo=r})},"geocortex/essentials/utilities/SiteResourceIdComparer":function(){define(["require","exports","geocortex/essentials/utilities/StringUtilities"],function(e,t,i){"use strict";var r=function(){function e(){}return e.equals=function(e,t){return!(!e||!t||e!==t&&!i.StringUtilities.endsWith(e,this.separator+t))},e.lookUp=function(e,t){if(e&&t){var r=0,n=null;for(r=0;r<e.length;++r)if(n=e[r],n.id===t)return n;for(r=0;r<e.length;++r)if(n=e[r],i.StringUtilities.endsWith(n.id,this.separator+t))return n}return null},e}();r.separator="-",t.SiteResourceIdComparer=r})},"geocortex/essentials/Layer":function(){define(["require","exports","geocortex/essentials/AsyncInitializable","geocortex/essentials/LayerChart","geocortex/essentials/DataLink","geocortex/essentials/Field","geocortex/essentials/FeatureHyperlink","geocortex/essentials/LayerHyperlink","geocortex/essentials/Report","geocortex/essentials/LayerStyle","geocortex/essentials/LayerQuery","geocortex/essentials/LayerType","geocortex/essentials/RefreshVisibility","geocortex/essentials/LayerThemeSetting","geocortex/essentials/TimeInfo","geocortex/geocortex","geocortex/essentials/RestHelperHTTPService","geocortex/essentials/MapServiceConstants","geocortex/essentials/utilities/SiteResourceIdComparer","geocortex/essentials/RestHelper"],function(require,exports,AsyncInitializable_4,LayerChart_1,DataLink_1,Field_1,FeatureHyperlink_1,LayerHyperlink_1,Report_2,LayerStyle_1,LayerQuery_1,LayerType_2,RefreshVisibility_1,LayerThemeSetting_1,TimeInfo_1,geocortex_8,RestHelperHTTPService_4,MapServiceConstants_2,SiteResourceIdComparer_1,RestHelper_4){"use strict";var Layer=function(_super){function Layer(e){var t=_super.call(this,e)||this;return t.allowSymbolization=!1,t.canToggleLabels=!1,t.charts=[],t.configuredVisible=!1,t.dataLinks=[],t.dataProvider=null,t.defaultVisibility=!1,t.displayField=null,t.displayName=null,t.defaultDateFormat=null,t.defaultNumberFormat=null,t.description=null,t.drawIndex=null,t.dynamicDefinition=null,t.extensions=[],t.featureBorderColor=null,t.featureBorderWidth=null,t.featureDescription=null,t.featureFillColor=null,t.featureHyperlinks=[],t.featureLabel=null,t.featureLongDescription=null,t.featureType="None",t.featureZoomFactor=null,t.featureZoomScale=null,
t.fields=[],t.fullExtent=null,t.hasAttachments=!1,t.hasDataLinks=!1,t.hasReports=!1,t.iconUri=null,t.id=null,t.identifiable=!1,t.identifiableAtAllScales=!1,t.includeInLayerList=!0,t.includeInLegend=!0,t.isDynamic=!1,t.isExpanded=!1,t.isUserCreated=!1,t.userLayerType=null,t.catalogId=null,t.layerHyperlinks=[],t.legendUrl=null,t.mapService=null,t.maxScale=0,t.minScale=0,t.name=null,t.parentLayerId=null,t.primaryKeyField=null,t.properties={},t.queryable=!1,t.queries=[],t.relationships=[],t.reports=[],t.searchable=!1,t.showFeatureHyperlinks="ShowAll",t.showLabels=!0,t.showMapTips=!1,t.snappable=!1,t.snappingEnabled=!1,t.supportsIdentify=!1,t.supportsQuery=!1,t.styleName=null,t.styles=[],t.subLayerIds=[],t.timeZoneId=null,t.type=LayerType_2.LayerType.UNKNOWN,t.visibleStateForRefresh=RefreshVisibility_1.RefreshVisibility.DEFAULT,t.wmsLayerName=null,t.wfsLayerName=null,t.inActiveTheme=!0,t.layerThemeSettings=[],t._visible=!1,t._featureLayerPromise=null,t._timeInfo=null,t._gcxTimeInfo=null,t.setInActiveTheme(!0),t}return __extends(Layer,_super),Layer.prototype.getFeatureLayer=function(){var e=this;if(!this._featureLayerPromise)if(this.mapService.serviceUrl&&this.mapService.serviceUrl.endsWith("/MapServer"))this._featureLayerPromise=new Promise(function(t,i){e.mapService._getLayersInfo().then(function(r){var n=null;if(r&&r.layers){if(r.layers.forEach(function(t){if(e.id===t.id.toString())return void(n=new esri.layers.FeatureLayer({layerDefinition:t}))}),!n&&r.tables&&r.tables.forEach(function(t){if(e.id===t.id.toString())return void(n=new esri.layers.FeatureLayer({layerDefinition:t}))}),n)return void t(n);if(e.isDynamic&&e.mapService&&e.mapService.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer){var s=e.mapService.serviceLayer;if(s.dynamicLayerInfos){var a=null;for(var o in s.dynamicLayerInfos)if(s.dynamicLayerInfos.hasOwnProperty(o)&&s.dynamicLayerInfos[o].id==parseInt(e.id)){a=s.dynamicLayerInfos[o].source;break}if(a){var l=e.mapService.serviceUrl+"/dynamicLayer",c=l;e.mapService.serviceToken&&(c=RestHelperHTTPService_4.RestHelperHTTPService.appendTokenToUrl(c,e.mapService.serviceToken)),n=new esri.layers.FeatureLayer(c,{source:a});var u=n.on("load",function(e){u.remove(),p.remove(),t(n)}),p=n.on("error",function(e){u.remove(),p.remove();var t=e.error&&e.error.message?e.error.message:"Could not determine underlying error.";i(new Error("Could not create a Feature Layer from the given dynamic layer source. Reason: {0}".format(t)))})}else i(new Error("Could not find LayerSource for the given dynamic layer."))}}}})["catch"](function(e){return i(e)})});else{var t;t=this.mapService.serviceLayer instanceof esri.layers.FeatureLayer?this.mapService.serviceLayer:new esri.layers.FeatureLayer(this.getLayerUrl()),t.loaded?this._featureLayerPromise=Promise.resolve(t):this._featureLayerPromise=new Promise(function(i,r){var n=t.on("load",function(){if(n.remove(),s.remove(),e.wmsLayerName||e.wfsLayerName)for(var r=e.fields,a=t.fields.length-1;a>=0;a--){var o=t.fields[a];"gml:id"===o.name&&t.fields.splice(a,1),o.type=Field_1.Field.convertToEsriFieldType(r[a].dataType)}i(t)}),s=t.on("error",function(e){n.remove(),s.remove(),r(e)})})}return this._featureLayerPromise},Layer.prototype.getRelatedFeatureLayer=function(e,t,i){var r=new dojo.Deferred,n=function(e){geocortex_8.deferredResolve(r,e),"function"==typeof t&&t(e)},s=function(e){r&&r.fired==-1&&r.resolve(e),"function"==typeof i&&i(e)},a=this._getRelation(e);if(!a){var o=new Error("Relation not found: "+e);return r&&r.fired==-1&&r.resolve(o),"function"==typeof i&&i(o),r}var l=this.getLayerUrl(),c=l.substring(0,l.lastIndexOf("/")+1)+a.relatedTableId;this.mapService&&this.mapService.serviceToken&&(c=RestHelperHTTPService_4.RestHelperHTTPService.appendTokenToUrl(c,this.mapService.serviceToken)),void 0===esri.getProxyRule(c)&&null!==this.mapService.proxyUrl&&esri.addProxyRule({urlPrefix:c,proxyUrl:this.mapService.proxyUrl});var u=new esri.layers.FeatureLayer(c,{mode:esri.layers.FeatureLayer.MODE_SELECTION,outFields:["*"]});return u.loaded?n(u):dojo.connect(u,"onLoad",dojo.hitch(this,n)),dojo.connect(u,"onError",dojo.hitch(this,s)),r},Layer.prototype.areAllAncestorsVisible=function(){for(var e=this.mapService.findLayerById(this.parentLayerId);null!==e&&void 0!==e;){if(!e.isVisible())return!1;e=this.mapService.findLayerById(e.parentLayerId)}return!0},Layer.prototype.getLayerUrl=function(){if(this.mapService&&this.mapService.serviceUrl){if("FeatureLayer"===this.mapService.drawingBehavior)return this.mapService.serviceUrl;if(this.mapService.mapServiceType===MapServiceConstants_2.MapServiceType.WMS||this.mapService.mapServiceType===MapServiceConstants_2.MapServiceType.WFS){var e=this.mapService.url+"/layers/"+this.id,t=RestHelperHTTPService_4.RestHelperHTTPService.getTokenForScope(this.mapService.url);return t&&(e=RestHelperHTTPService_4.RestHelperHTTPService.appendTokenToUrl(e,t)),e}return this.mapService.serviceUrl+"/"+this.id}return null},Layer.prototype.getFieldByName=function(e){if(this.fields&&this.fields.length>0){if(!this._fieldLookup){this._fieldLookup={};for(var t=0;t<this.fields.length;t++){var i=this.fields[t];this._fieldLookup[i.name]=i}}return this._fieldLookup[e]}return null},Layer.prototype.isVisible=function(){return this._visible},Layer.prototype.setVisibility=function(e,t){if(this.mapService){switch(this.mapService.mapServiceType){case MapServiceConstants_2.MapServiceType.DYNAMIC:case MapServiceConstants_2.MapServiceType.FEATURE:case MapServiceConstants_2.MapServiceType.WMS:case MapServiceConstants_2.MapServiceType.WFS:case MapServiceConstants_2.MapServiceType.WMTS:case MapServiceConstants_2.MapServiceType.GEORSS:case MapServiceConstants_2.MapServiceType.KML:case MapServiceConstants_2.MapServiceType.TILED:case MapServiceConstants_2.MapServiceType.STREAM:this._visible=e;break;default:this._visible=!0}this.mapService._setVisibility(this.id,this._visible,t)}},Layer.prototype.setInActiveTheme=function(e){this.inActiveTheme=e,dojo.publish("LayerInActiveThemeChangedEvent",this)},Layer.prototype.findReportById=function(e){return SiteResourceIdComparer_1.SiteResourceIdComparer.lookUp(this.reports,e)},Layer.prototype.withinScaleRange=function(e){return!!(0==this.maxScale&&this.minScale==1/0||isNaN(this.maxScale)&&isNaN(this.minScale))||(null==e&&(e=this.mapService.essentialsMap.calculateScale()),this.maxScale<e&&e<this.minScale)},Layer.prototype._configureDataLinks=function(e,t,i){for(var r=0;e&&r<e.length;r++){var n=this.dataLinks[r]=new DataLink_1.DataLink(this.url+"/datalinks/"+e[r].id);n.layer=this,n._configureObject(e[r],t)}},Layer.prototype._idIsUnique=function(e){if(this.mapService&&e){var t=[];if(dojo.forEach(this.mapService.layers,function(e){t.push(e.id)}),t.indexOf(e)<0)return!0}return!1},Layer.prototype._getUniqueId=function(){if(this.mapService){var e=[];if(dojo.forEach(this.mapService.layers,function(t){e.push(t.id)}),e.length>0){var t=Math.max.apply(null,e);return t++,t.toString()}}return"0"},Layer.prototype.createFromDefinition=function(e){this._createFrom(e)},Layer.prototype._createFrom=function(e){if(this.defaultVisibility=e.defaultVisibility,this.configuredVisible=e.visible,this.displayName=e.displayName||e.name,this.description=e.description,this.featureDescription=e.featureDescription,e.hasOwnProperty("featureLongDescription")?this.featureLongDescription=e.featureLongDescription:this.featureLongDescription=e.featureDescription,this.featureLabel=e.featureLabel,this.featureType=e.featureType,this.featureZoomScale=e.featureZoomScale,this.featureZoomFactor=e.featureZoomFactor,this.hasDataLinks=e.hasDataLinks,this.hasReports=e.hasReports,this.hasAttachments=e.hasAttachments,e.hasOwnProperty("id")?this.id=e.id:this.id=this._getUniqueId(),this.name=e.name,e.nativeID&&(this.mapService&&this.mapService.mapServiceType===MapServiceConstants_2.MapServiceType.WFS?this.wfsLayerName=e.nativeID:this.wmsLayerName=e.nativeID),this.parentLayerId=e.parentLayerId,this.subLayerIds=e.subLayerIds,this._visible=e.visible,this.styleName=e.styleName,this.legendUrl=e.legendUrl,this.isUserCreated=void 0==e.isUserCreated?this.isUserCreated:e.isUserCreated,this.userLayerType=void 0==e.userLayerType?this.userLayerType:e.userLayerType,this.isDynamic=e.isDynamic,this.dynamicDefinition=e.dynamicDefinition,this.dataProvider=e.dataProvider,this.defaultDateFormat=e.defaultDateFormat,this.defaultNumberFormat=e.defaultNumberFormat,this.timeZoneId=e.timeZoneId,e.fullExtent&&(this.fullExtent=new esri.geometry.Extent(e.fullExtent)),e.hasOwnProperty("drawIndex")&&(this.drawIndex=e.drawIndex),e.hasOwnProperty("identifiable")&&(this.identifiable=e.identifiable),e.hasOwnProperty("includeInLayerList")&&(this.includeInLayerList=e.includeInLayerList),e.hasOwnProperty("includeInLegend")&&(this.includeInLegend=e.includeInLegend),e.hasOwnProperty("featureBorderColor")&&(this.featureBorderColor=e.featureBorderColor,this.featureBorderColor&&this.featureBorderColor.length>=4&&this.featureBorderColor[3]>=1&&(this.featureBorderColor[3]/=255)),e.hasOwnProperty("featureBorderWidth")&&(this.featureBorderWidth=e.featureBorderWidth),e.hasOwnProperty("featureFillColor")&&(this.featureFillColor=e.featureFillColor,this.featureFillColor&&this.featureFillColor.length>=4&&this.featureFillColor[3]>=1&&(this.featureFillColor[3]/=255)),e.hasOwnProperty("minScale")&&!isNaN(e.minScale)&&0!=e.minScale?this.minScale=e.minScale:this.minScale=1/0,e.hasOwnProperty("maxScale")&&!isNaN(e.maxScale)?this.maxScale=e.maxScale:this.maxScale=0,this.mapService&&null!=this.mapService.minScale&&!isNaN(this.mapService.minScale)&&(this.minScale=Math.min(this.minScale,this.mapService.minScale)),this.mapService&&null!=this.mapService.maxScale&&!isNaN(this.mapService.maxScale)&&(this.maxScale=Math.max(this.maxScale,this.mapService.maxScale)),e.hasOwnProperty("queryable")&&(this.queryable=e.queryable),e.hasOwnProperty("searchable")&&(this.searchable=e.searchable),e.hasOwnProperty("snappable")&&(this.snappable=e.snappable),e.hasOwnProperty("snappingEnabled")&&(this.snappingEnabled=e.snappingEnabled),e.hasOwnProperty("showFeatureHyperlinks")&&(this.showFeatureHyperlinks=e.showFeatureHyperlinks),e.hasOwnProperty("canToggleLabels")&&(this.canToggleLabels=e.canToggleLabels),e.hasOwnProperty("showLabels")&&(this.showLabels=e.showLabels),e.hasOwnProperty("showMapTips")&&(this.showMapTips=e.showMapTips),e.hasOwnProperty("supportsIdentify")&&(this.supportsIdentify=e.supportsIdentify),e.hasOwnProperty("supportsQuery")&&(this.supportsQuery=e.supportsQuery),e.hasOwnProperty("layerHyperlinks"))for(t=0;t<e.layerHyperlinks.length;t++)this.layerHyperlinks[t]=new LayerHyperlink_1.LayerHyperlink(e.layerHyperlinks[t],this);if(void 0!==e.type&&(this.type=this._layerTypeStringToEssentialsLayerType(e.type)),e.fields)for(var t=0;t<e.fields.length;t++){var i=e.fields[t],r={layer:this,dataType:Field_1.Field.convertFromEsriType(i.type||i.dataType),alias:i.alias,displayName:i.displayName||i.alias||i.name,name:i.name,searchable:!0,visible:!0,focusField:!1,hyperlinkLabel:null,format:i.format};i.hasOwnProperty("searchable")&&(r.searchable=i.searchable),i.hasOwnProperty("visible")&&(r.visible=i.visible),this.fields[t]=new Field_1.Field(r)}this.primaryKeyField=this.getFieldByName(e.primaryKeyField),this.displayField=this.getFieldByName(e.displayField),e.properties&&(this.properties=geocortex_8._getProperties(e.properties),this.catalogId=this.properties.layerCatalogLookupId),e.extensions&&(this.extensions=geocortex_8._getExtensions(e.extensions)),this.isInitialized=!0},Layer.prototype._configureObject=function(results,deepInitialize){if(void 0===results||void 0===results.name||void 0===results.id)throw new Error("Incorrect layer object returned from initialization");this.allowSymbolization=results.allowSymbolization,this.defaultVisibility=results.defaultVisibility,this.configuredVisible=results.visible,this.displayName=results.displayName,this.description=results.description,this.featureDescription=results.featureDescription,results.hasOwnProperty("featureLongDescription")?this.featureLongDescription=results.featureLongDescription:this.featureLongDescription=results.featureDescription,this.featureLabel=results.featureLabel,this.featureType=void 0===results.featureType?this.featureType:results.featureType,this.featureZoomScale=void 0===results.featureZoomScale?this.featureZoomScale:results.featureZoomScale,this.featureZoomFactor=void 0===results.featureZoomFactor?this.featureZoomFactor:results.featureZoomFactor,this.hasDataLinks=void 0==results.hasDataLinks?this.hasDataLinks:results.hasDataLinks,this.hasReports=void 0==results.hasReports?this.hasReports:results.hasReports,this.hasAttachments=results.hasAttachments,this.id=results.id,this.name=results.name,results.nativeID&&(this.mapService&&this.mapService.mapServiceType===MapServiceConstants_2.MapServiceType.WFS?this.wfsLayerName=results.nativeID:this.wmsLayerName=results.nativeID),this.parentLayerId=results.parentLayerId,this.subLayerIds=results.subLayerIds,this.styleName=results.styleName,this.legendUrl=results.legendUrl,this.catalogId=void 0==results.catalogId?this.catalogId:results.catalogId,this.isUserCreated=void 0==results.isUserCreated?this.isUserCreated:results.isUserCreated,this.userLayerType=void 0==results.userLayerType?this.userLayerType:results.userLayerType,this.isDynamic=void 0===results.isDynamic?this.isDynamic:results.isDynamic,this.dynamicDefinition=results.dynamicDefinition,this.dataProvider=results.dataProvider,this.defaultDateFormat=results.defaultDateFormat,this.defaultNumberFormat=results.defaultNumberFormat,this.timeZoneId=results.timeZoneId,this._timeInfo=results.timeInfo?results.timeInfo:null,this.queries=[],results.fullExtent&&(this.fullExtent=new esri.geometry.Extent(results.fullExtent));var site=null;if(this.mapService&&this.mapService.essentialsMap&&(site=this.mapService.essentialsMap.site),this.iconUri=RestHelper_4.RestHelper.processClientSideTokens(site,results.iconUri),results.hasOwnProperty("includeInLayerList")&&(this.includeInLayerList=results.includeInLayerList),this.isUserCreated)this._visible=void 0===results.initiallyVisible?!!results.visible:!!results.initiallyVisible;else if(null!=this.mapService.essentialsMap.layerThemesInfo.startupThemeId&&this.includeInLayerList?this._visible=!1:this._visible=void 0===results.initiallyVisible?!!results.visible:!!results.initiallyVisible,results.themeSettings&&results.themeSettings.length)for(var x=0;x<results.themeSettings.length;x++){var themeSetting=results.themeSettings[x],layerTheme=this.mapService.essentialsMap.layerThemesInfo.getTheme(themeSetting.themeID);if(layerTheme){var isVisible=void 0==themeSetting.visible?this.configuredVisible:themeSetting.visible;this.layerThemeSettings.push(new LayerThemeSetting_1.LayerThemeSetting(layerTheme,isVisible)),layerTheme.id===this.mapService.essentialsMap.layerThemesInfo.startupThemeId&&this.includeInLayerList&&(this._visible=void 0===themeSetting.initiallyVisible?isVisible:themeSetting.initiallyVisible)}}results.hasOwnProperty("drawIndex")&&(this.drawIndex=results.drawIndex),results.hasOwnProperty("featureBorderColor")&&(this.featureBorderColor=results.featureBorderColor,this.featureBorderColor&&this.featureBorderColor.length>=4&&this.featureBorderColor[3]>=1&&(this.featureBorderColor[3]/=255)),results.hasOwnProperty("featureBorderWidth")&&(this.featureBorderWidth=results.featureBorderWidth),results.hasOwnProperty("featureFillColor")&&(this.featureFillColor=results.featureFillColor,this.featureFillColor&&this.featureFillColor.length>=4&&this.featureFillColor[3]>=1&&(this.featureFillColor[3]/=255)),results.hasOwnProperty("identifiable")&&(this.identifiable=results.identifiable),results.hasOwnProperty("includeInLegend")&&(this.includeInLegend=results.includeInLegend),results.hasOwnProperty("minScale")&&!isNaN(results.minScale)&&0!=results.minScale?this.minScale=results.minScale:this.minScale=1/0,results.hasOwnProperty("maxScale")&&!isNaN(results.maxScale)?this.maxScale=results.maxScale:this.maxScale=0,this.mapService&&null!=this.mapService.minScale&&!isNaN(this.mapService.minScale)&&(this.minScale=Math.min(this.minScale,this.mapService.minScale)),this.mapService&&null!=this.mapService.maxScale&&!isNaN(this.mapService.maxScale)&&(this.maxScale=Math.max(this.maxScale,this.mapService.maxScale)),results.hasOwnProperty("queryable")&&(this.queryable=results.queryable),results.hasOwnProperty("searchable")&&(this.searchable=results.searchable),results.hasOwnProperty("showFeatureHyperlinks")&&(this.showFeatureHyperlinks=results.showFeatureHyperlinks),results.hasOwnProperty("canToggleLabels")&&(this.canToggleLabels=results.canToggleLabels),results.hasOwnProperty("showLabels")&&(this.showLabels=results.showLabels),results.hasOwnProperty("showMapTips")&&(this.showMapTips=results.showMapTips),results.hasOwnProperty("snappable")&&(this.snappable=results.snappable),results.hasOwnProperty("snappingEnabled")&&(this.snappingEnabled=results.snappingEnabled),results.hasOwnProperty("supportsIdentify")&&(this.supportsIdentify=results.supportsIdentify),results.hasOwnProperty("supportsQuery")&&(this.supportsQuery=results.supportsQuery),void 0!==results.type&&(this.type=this._layerTypeStringToEssentialsLayerType(results.type)),this.type==LayerType_2.LayerType.GROUP_LAYER&&results.hasOwnProperty("isExpanded")&&(this.isExpanded=results.isExpanded);var i;if(results.featureHyperlinks)for(i=0;i<results.featureHyperlinks.length;i++)this.featureHyperlinks[i]=new FeatureHyperlink_1.FeatureHyperlink(results.featureHyperlinks[i],this);if(results.fields)for(i=0;i<results.fields.length;i++)results.fields[i].layer=this,this.fields[i]=new Field_1.Field(results.fields[i]);if(results.relationships)for(i=0;i<results.relationships.length;i++)results.relationships[i].displayName&&(results.relationships[i].name=results.relationships[i].displayName),results.relationships[i].id=parseInt(results.relationships[i].id),results.relationships[i].relatedTableId=parseInt(results.relationships[i].relatedTableId),this.relationships.push(results.relationships[i]);if(results.hasOwnProperty("layerHyperlinks"))for(i=0;i<results.layerHyperlinks.length;i++)this.layerHyperlinks[i]=new LayerHyperlink_1.LayerHyperlink(results.layerHyperlinks[i],this);if(results.hasOwnProperty("charts")&&dojo.isObject(eval("geocortex.charting.configuration.ChartDefinition")))for(i=0;i<results.charts.length;i++)this.charts.push(new LayerChart_1.LayerChart(results.charts[i],this));if(results.styles&&results.styles.length)for(i=0;i<results.styles.length;i++){var style=results.styles[i],rendererJson=style.definition;rendererJson&&this.styles.push(new LayerStyle_1.LayerStyle(rendererJson,style.displayName,style.id))}if(results.queries&&results.queries.length)for(i=0;i<results.queries.length;i++)this.queries.push(new LayerQuery_1.LayerQuery(results.queries[i]));this.primaryKeyField=this.getFieldByName(results.primaryKeyField),this.displayField=this.getFieldByName(results.displayField),this._configureDataLinks(results.dataLinks,deepInitialize,site),this._configureReports(results.reports,deepInitialize),deepInitialize&&(this.isInitialized=!0),this.properties=geocortex_8._getProperties(results.properties),this.extensions=geocortex_8._getExtensions(results.extensions)},Layer.prototype.toJson=function(){return{id:this.id,name:this.name,url:this.url,defaultVisibility:this.defaultVisibility,visible:this.configuredVisible,displayName:this.displayName,description:this.description,featureDescription:this.featureDescription,featureLongDescription:this.featureLongDescription,featureLabel:this.featureLabel,featureType:this.featureType,featureZoomScale:this.featureZoomScale,featureZoomFactor:this.featureZoomFactor,hasDataLinks:this.hasDataLinks,hasReports:this.hasReports,hasAttachments:this.hasAttachments,nativeID:this.wmsLayerName||this.wfsLayerName,parentLayerId:this.parentLayerId,subLayerIds:(this.subLayerIds||[]).slice(),styleName:this.styleName,legendUrl:this.legendUrl,isDynamic:this.isDynamic,dynamicDefinition:this.dynamicDefinition,dataProvider:this.dataProvider,defaultDateFormat:this.defaultDateFormat,defaultNumberFormat:this.defaultNumberFormat,timeZoneId:this.timeZoneId,fullExtent:this.fullExtent?this.fullExtent.toJson():void 0,drawIndex:this.drawIndex,identifiable:this.identifiable,isExpanded:this.isExpanded,includeInLayerList:this.includeInLayerList,includeInLegend:this.includeInLegend,featureBorderColor:this.featureBorderColor,featureBorderWidth:this.featureBorderWidth,featureFillColor:this.featureFillColor,minScale:this.minScale===1/0?0:this.minScale,maxScale:this.maxScale,queryable:this.queryable,searchable:this.searchable,snappable:this.snappable,snappingEnabled:this.snappingEnabled,showFeatureHyperlinks:this.showFeatureHyperlinks,canToggleLabels:this.canToggleLabels,showLabels:this.showLabels,showMapTips:this.showMapTips,supportsIdentify:this.supportsIdentify,supportsQuery:this.supportsQuery,layerHyperlinks:this.layerHyperlinks.map(function(e){return e.toJson()}),type:this._essentialsLayerTypeToLayerTypeString(this.type),fields:this.fields.map(function(e){return e.toJson()}),primaryKeyField:this.primaryKeyField?this.primaryKeyField.name:void 0,displayField:this.displayField?this.displayField.name:void 0,catalogId:this.catalogId?this.catalogId:void 0,isUserCreated:this.isUserCreated,userLayerType:this.userLayerType,properties:geocortex_8._propertiesToJson(this.properties),extensions:geocortex_8._extensionsToJson(this.extensions)}},Layer.prototype._configureReports=function(e,t){for(var i=0;e&&i<e.length;i++)this.reports[i]=new Report_2.Report(this.url+"/reports/"+e[i].id),this.reports[i].layer=this,this.mapService&&this.mapService.essentialsMap&&this.mapService.essentialsMap.site&&(this.reports[i].site=this.mapService.essentialsMap.site),this.reports[i]._configureObject(e[i],t)},Layer.prototype.getLayerTimeInfo=function(){var e=this;if(!this.mapService||!this.mapService.isTimeAware)return null;if(this._gcxTimeInfo)return this._gcxTimeInfo;var t=function(t){if(t)return e._timeInfo=t,e._gcxTimeInfo=TimeInfo_1.getGcxTimeInfo(e._timeInfo),e._gcxTimeInfo},i=function(){if(e.mapService.serviceLayer&&e.mapService.serviceLayer.url){var i=e.mapService.serviceLayer.url+"/"+e.id;geocortex_8.request({url:i,content:{f:"json"},load:function(e){return t(e.timeInfo)},error:function(e){console.log(e.message)},callbackParamName:"CallBack"})}};this._timeInfo?t(this._timeInfo):i()},Layer.prototype.getObjectIdFieldName=function(){var e=null;return this.primaryKeyField&&(e=this.primaryKeyField.name),e},Layer.prototype._layerTypeStringToEssentialsLayerType=function(e){return"FeatureLayer"==e||"DynamicFeatureLayer"==e?LayerType_2.LayerType.FEATURE_LAYER:"GroupLayer"==e||"AnnotationLayer"==e?LayerType_2.LayerType.GROUP_LAYER:"RasterLayer"==e?LayerType_2.LayerType.RASTER_LAYER:"GeoRssLayer"==e?LayerType_2.LayerType.GEO_RSS_LAYER:"TableLayer"==e?LayerType_2.LayerType.TABLE_LAYER:LayerType_2.LayerType.UNKNOWN},Layer.prototype._essentialsLayerTypeToLayerTypeString=function(e){switch(e){case LayerType_2.LayerType.FEATURE_LAYER:return"FeatureLayer";case LayerType_2.LayerType.GROUP_LAYER:return"GroupLayer";case LayerType_2.LayerType.RASTER_LAYER:return"RasterLayer";case LayerType_2.LayerType.GEO_RSS_LAYER:return"GeoRssLayer";default:return"Unknown"}},Layer.prototype._getRelation=function(e){"string"==typeof e&&(e=parseInt(e));for(var t=0;t<this.relationships.length;t++)if(this.relationships[t].id==e)return this.relationships[t];return null},Layer.prototype.getDefinitionExpression=function(e){var t=null,i=parseInt(this.id);if(e)if(e instanceof esri.layers.ArcGISDynamicMapServiceLayer){var r=e.layerDefinitions;r&&r[i]&&(t=r[i])}else if(e instanceof esri.layers.FeatureLayer){var n=e.getDefinitionExpression();n&&(t=n)}return t||this.dynamicDefinition&&(t=RestHelper_4.RestHelper.getDynamicExpressionFromJson(this.dynamicDefinition)),t},Layer.prototype._createDynamicLayerInfo=function(){var e=null;return this.isDynamic&&(e=RestHelper_4.RestHelper.getDynamicLayerInfoFromJson(this.dynamicDefinition,this.id),this.minScale<1/0&&(e.minScale=this.minScale),this.maxScale>0&&(e.maxScale=this.maxScale)),e},Layer.prototype.getLayerDrawingOptions=function(){var e=null;return this.isDynamic&&(e=RestHelper_4.RestHelper.getLayerDrawingOptionsFromJson(this.dynamicDefinition)),e},Layer.prototype.getLayerThemeSettings=function(e){for(var t=0;t<this.layerThemeSettings.length;t++){var i=this.layerThemeSettings[t];if(i.theme===e||i.theme.id===e)return i}return null},Layer.prototype._syncProgramaticallyChangedLayerVisibility=function(e){this._visible=e},Layer}(AsyncInitializable_4.AsyncInitializable);exports.Layer=Layer})},"geocortex/essentials/FeatureHeatMap":function(){define(["require","exports"],function(e,t){"use strict"})},"geocortex/essentials/LayerVisibilityEventManager":function(){define(["require","exports","geocortex/essentials/MapServiceConstants"],function(e,t,i){"use strict";var r=function(){function e(e,t){if(this._mapService=null,this._mapService=e,this._mapService.mapServiceType!=i.MapServiceType.WMS&&this._mapService.mapServiceType!=i.MapServiceType.DYNAMIC)throw new Error("LayerVisibilityEventManager: Only Dynamic and WMS Layer types supported.");var r=this;dojo.aspect.before(t,"setVisibleLayers",function(e,t){return r.beforeESRIsetVisibleLayers(e,t)}),dojo.aspect.after(t,"setVisibleLayers",function(e,t,i){r.afterESRIsetVisibleLayers(e,t,i)},!0)}return e.prototype.beforeESRIsetVisibleLayers=function(e,t){var r=[],n=[];if(void 0===t&&(t=!1),e.InternallyChangedLayer){var s=e.InternallyChangedLayer;void 0!=s.mapServiceId&&void 0!=s.layerId&&void 0!=s.visibility&&r.push(s);var a=[e,t,r];return a}if(this._mapService.mapServiceType==i.MapServiceType.DYNAMIC)n=dojo.clone(e);else if(this._mapService.mapServiceType==i.MapServiceType.WMS)for(var o=0;e&&o<e.length;o++){var l=this._findWmsLayerIdFromName(e[o]);if(!l||null===l){var a=[e,t,r];return console.error("WARNING: LayerVisibilityEventManager could not find layer corresponding to WMS name ["+e[o]+"] Possible Invalid configuration"),a}n.push(l.toString())}if(e&&this._mapService.mapServiceType==i.MapServiceType.DYNAMIC&&1===e.length&&"-1"==e[0]){for(var c=0;c<this._mapService.layers.length;c++){var u=this._mapService.layers[c].id;r.push({mapServiceId:this._mapService.id,layerId:u.toString(),visibility:!1}),this._mapService.findLayerById(u)._syncProgramaticallyChangedLayerVisibility(!1)}var a=[e,t,r];return a}(e&&0===e.length||this._mapService.mapServiceType==i.MapServiceType.DYNAMIC&&1===e.length&&""===e[0])&&(n=this._mapService.getDefaultVisibleLayers());for(var p=this._getAllCurrentlyVisibleLayers(),h=0;p&&h<p.length;h++){var u=p[h];if(n&&n.indexOf(u.toString())<0){var d=this._mapService.findLayerById(u);d&&(r.push({mapServiceId:this._mapService.id,layerId:u.toString(),visibility:!1}),d._syncProgramaticallyChangedLayerVisibility(!1))}}var f=this._mapService.getVisibleLayers();if(n&&n.length>0)for(var y=0;y<n.length;y++)if(this._mapService.mapServiceType==i.MapServiceType.DYNAMIC&&isNaN(parseInt(n[y]))&&(n[y]="0"),f&&f.indexOf(n[y].toString())<0){var d=this._mapService.findLayerById(n[y]);d&&(d.subLayerIds&&d.subLayerIds.length>0&&(this._deleteItemWithId(n[y],r),this._recursivelyUpdateSublayerVisibility(d,!0,r)),r.push({mapServiceId:this._mapService.id,layerId:n[y].toString(),visibility:!0}),d._syncProgramaticallyChangedLayerVisibility(!0),d.parentLayerId&&null!==d.parentLayerId&&void 0!==d.parentLayerId&&this._recursivelyUpdateAncestorVisibility(d,n,r))}var a=[e,t,r];return a},e.prototype.afterESRIsetVisibleLayers=function(e,t,i){i&&i.length>0&&dojo.publish("LayerVisibilityChange",new Array(i))},e.prototype._recursivelyUpdateAncestorVisibility=function(e,t,i){if(e&&e.parentLayerId&&null!==e.parentLayerId&&void 0!==e.parentLayerId){var r=this._mapService.findLayerById(e.parentLayerId);r.isVisible()||(this._deleteItemWithId(e.parentLayerId,i),r._syncProgramaticallyChangedLayerVisibility(!0),i.push({mapServiceId:this._mapService.id,layerId:e.parentLayerId.toString(),visibility:!0})),this._recursivelyUpdateAncestorVisibility(r,t,i)}},e.prototype._recursivelyUpdateSublayerVisibility=function(e,t,i){if(e.subLayerIds&&e.subLayerIds.length>0)for(var r=0;r<e.subLayerIds.length;r++){var n=this._mapService.findLayerById(e.subLayerIds[r]),s=n.id;n._syncProgramaticallyChangedLayerVisibility(t),this._deleteItemWithId(s,i),i.push({mapServiceId:this._mapService.id,layerId:s.toString(),visibility:t}),n.subLayerIds&&n.subLayerIds.length>0&&this._recursivelyUpdateSublayerVisibility(n,t,i)}},e.prototype._getAllCurrentlyVisibleLayers=function(){for(var e=[],t=0;t<this._mapService.layers.length;t++){var i=this._mapService.layers[t];i.isVisible()&&e.push(i.id.toString())}return e},e.prototype._findWmsLayerIdFromName=function(e){for(var t=0;t<this._mapService.layers.length;t++){var i=this._mapService.layers[t];if(e==i.wmsLayerName)return i.id}return null},e.prototype._deleteItemWithId=function(e,t){for(var i=0;i<t.length;i++)t[i].layerId==e&&t.splice(i,1)},e}();t.LayerVisibilityEventManager=r})},"geocortex/essentials/GeometryUtilities":function(){define(["require","exports"],function(e,t){"use strict";function i(e,t,i){return null==e||null==t?i:!!(e.isWebMercator&&t.isWebMercator&&e.isWebMercator()&&t.isWebMercator())||e.wkid===t.wkid&&(e.wkid>0||e.wkt.toLowerCase()==t.wkt.toLowerCase())}function r(e,t){return null==e||null==t?null==e&&null==t:i(e.spatialReference,t.spatialReference)&&e.xmin==t.xmin&&e.ymin==t.ymin&&e.xmax==t.xmax&&e.ymax==t.ymax}function n(e){if(e.length)var t=new esri.geometry.Extent(Number.MAX_VALUE,Number.MAX_VALUE,Number.MIN_VALUE,Number.MIN_VALUE,e[0].spatialReference);for(var i=0;i<e.length;++i){var r=e[i].getExtent();t.xmin=Math.min(r.xmin,t.xmin),t.ymin=Math.min(r.ymin,t.ymin),t.xmax=Math.min(r.xmax,t.xmax),t.xmax=Math.min(r.ymax,t.ymax)}return t}function s(e){var t=new esri.geometry.Polygon(e.spatialReference);return t.addRing([[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]),t}function a(e){if("polygon"!=e.type)return!0;var t=e;if(0==t.rings.length||t.rings.length<3)return!0;if(l(t)){var i=t.rings[0][0],r=t.rings[0][1],n=t.rings[0].slice(2,t.rings[0].length);n.push(i);for(var s=0;s<n.length;++s){var a=n[s];if(S(i,a,r)>0)return!0;i=r,r=a}return!1}for(var o=0,c=0;c<t.rings.length;++c)for(var u=t.rings[c],p=0,s=0;s<u.length;++s)p=(s+1)%u.length,o+=u[s][0]*-u[p][1],o-=-u[s][1]*u[p][0];return o>0}function o(e){if(esri.geometry.polygonSelfIntersecting)return esri.geometry.polygonSelfIntersecting(e);if(e.isSelfIntersecting)return e.isSelfIntersecting(e);throw new Error("No self intersection method found")}function l(e){var t=e.rings[0][0],i=e.rings[0][1],r=null,n=!0,s=e.rings[0].slice(2,e.rings[0].length);s.push(t);for(var a=0;a<s.length;++a){var o=s[a],l=this.crossProduct(o,t,i);if(l>0&&r===!0||l<0&&r===!1)return!1;r=l>0,t=i,i=o}return n}function c(e,t){if(!this.spatialRefsAreEqual(e.spatialReference,t.spatialReference,!0))throw new Error("Mismatched spatial references.");return!(e.x<t.xmin||e.x>t.xmax)&&!(e.y<t.ymin||e.y>t.ymax)}function u(e,t){if(!this.spatialRefsAreEqual(e.spatialReference,t.spatialReference,!0))throw new Error("Mismatched spatial references.");var i=new esri.geometry.Extent(e.xmin,e.ymin,e.xmax,e.ymax,e.spatialReference),r=function(e,t,i){return e<t?t:e>i?i:e};return i.xmin=r(e.xmin,t.xmin,t.xmax),i.xmin=r(e.ymin,t.ymin,t.ymax),i.xmin=r(e.xmax,t.xmin,t.xmax),i.xmin=r(e.ymax,t.ymin,t.ymax),i}function p(e,t,i){return new esri.geometry.Extent(e.xmin*t,e.ymin*i,e.xmax*t,e.ymax*i,e.spatialReference)}function h(e,t){if(null==e)return null;var i=e.getCenter();return new esri.geometry.Extent(i.x-e.getWidth()*(t/2),i.y-e.getHeight()*(t/2),i.x+e.getWidth()*(t/2),i.y+e.getHeight()*(t/2),e.spatialReference)}function d(e,t){var i=t.x-e.x,r=t.y-e.y;return Math.sqrt(i*i+r*r)}function f(e,t,i){return new esri.geometry.Extent(e.xmin+t,e.ymin+i,e.xmax+t,e.ymax+i,e.spatialReference)}function y(e){return Math.sqrt(e.x*e.x+e.y*e.y);
}function m(e){var t=this.length(e);return new esri.geometry.Point(e.x/t,e.y/t)}function g(e,t){if(!this.spatialRefsAreEqual(e.spatialReference,t.spatialReference,!0))throw new Error("Mismatched spatial references");return Math.acos(this.dotProduct(e,t)/Math.sqrt(this.dotProduct(e,e)*this.dotProduct(t,t)))}function v(e,t,i){if(!this.spatialRefsAreEqual(e.spatialReference,t.spatialReference,!0))throw new Error("Mismatched spatial references");return i||(i=new esri.geometry.Point(0,0)),(e.x-i.x)*(t.y-i.y)-(e.y-i.y)*(t.x-i.x)}function S(e,t,i){return i||(i=[0,0]),(e[0]-i[0])*(t[1]-i[1])-(e[1]-i[1])*(t[0]-i[0])}function x(e,t){if(!this.spatialRefsAreEqual(e.spatialReference,t.spatialReference,!0))throw new Error("Mismatched spatial references");return e.x*t.x+e.y*t.y}function b(e){if(0==e.length)throw new Error("Expected at least one point in polygonMidPoint.");for(var t=0,i=0,r=0;r<e.length;++r){var n=e[r];t+=n.x,i+=n.y}return t/=e.length,i/=e.length,new esri.geometry.Point(t,i,e[0].spatialReference)}t.spatialRefsAreEqual=i,t.envelopesAreEqual=r,t.getExtent=n,t.envelopeToPolygon=s,t.isValidGeometry=a,t.isSelfIntersectingPolygon=o,t.isConvex=l,t.pointInEnvelope=c,t.clipEnvelope=u,t.scaleEnvelope=p,t.scaleEnvelopeWithoutTranslation=h,t.computeDistance=d,t.translateEnvelope=f,t.length=y,t.normalize=m,t.angle=g,t.crossProduct=v,t.crossProductArray=S,t.dotProduct=x,t.polygonMidpoint=b})},"geocortex/essentials/Principal":function(){define(["require","exports"],function(e,t){"use strict"})},"geocortex/essentials/ServiceHelper":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(){}return e.extractConnectionStringValue=function(e,t){if(e.length>0){var i=e.match("(^|;)[s]*"+t+"=([^;]*)");return null!==i?i[2]:""}return""},e}();t.ServiceHelper=i})},"geocortex/essentials/catalog/LayerCatalogDetailEntry":function(){define(["require","exports"],function(e,t){"use strict"})},"geocortex/essentials/catalog/LayerCatalogDetail":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(){this.mapServiceId=null,this.entries=null,this.entries=[]}return e}();t.LayerCatalogDetail=i})},"geocortex/essentials/MapService":function(){define(["require","exports","geocortex/essentials/AsyncInitializable","geocortex/essentials/MapServiceConstants","geocortex/essentials/Layer","geocortex/essentials/LayerThemeSetting","geocortex/essentials/LayerHyperlink","geocortex/essentials/TimeInfo","geocortex/essentials/LayerVisibilityEventManager","geocortex/essentials/utilities/UrlUtilities","geocortex/geocortex","geocortex/essentials/RestHelper","geocortex/hasProxy","geocortex/essentials/RestHelperHTTPService","geocortex/essentials/RefreshVisibility","geocortex/essentials/ServiceHelper","geocortex/framework/SimplePromise"],function(e,t,i,r,n,s,a,o,l,c,u,p,h,d,f,y,m){"use strict";var g=function(t){function i(e){var i=t.call(this,e)||this;return i.bingProperties=null,i.baseMapGroup=null,i.configuredOpacity=1,i.configuredVisible=!1,i.copyright=null,i.attributionDataUrl=null,i.hasAttributionData=!1,i.dataProvider=null,i.description=null,i.defaultDateFormat=null,i.defaultNumberFormat=null,i.disableClientCaching=!1,i.displayName=null,i.drawingBehavior=null,i.essentialsMap=null,i.extensions=[],i.failureAction=r.FailureAction.WARN,i.failureTimeout=null,i.failureTimeoutThresholdExceeded=!1,i.onFailureTimeoutThresholdExceeded=function(){},i.featureClustering=null,i.geometryServiceUrl=null,i.hasLayerCatalog=!1,i.iconUri=null,i.id=null,i.catalogId=null,i.originalUrl=null,i.imageFormat=null,i.initializationFailure=null,i.includeInLayerList=!0,i.isExpanded=!0,i.isServiceLayerLoaded=!1,i.isUserCreated=!1,i.userLayerType=null,i.layers=[],i.tables=[],i.layersFilteredView=[],i.mapServiceFunction=null,i.mapServiceType=null,i.mapUrl=null,i.maxScale=null,i.minScale=null,i.opacity=1,i.opacityFilter=1,i.operationalSpatialReference=null,i.inActiveTheme=!0,i.layerThemeSettings=[],i.layerHyperlinks=[],i.properties={},i.proxyUrl=null,i.requestEncoding=null,i.instantSearch=!1,i.serverVersion=null,i.serviceLayer=null,i.serviceToken=null,i.serviceUrl=null,i.shortDisplayName=null,i.subDomains=[],i.supportsDynamicLayers=!1,i.tileMatrixSet=null,i.tileInfo=null,i.tileRestUrl=null,i.isTimeAware=!1,i.timeInfo=null,i.timeZoneId=null,i.updateInterval=null,i.heatMap=null,i.identifiable=!1,i.includeMosaicDatasetValues=!1,i.includeCatalogItems=!1,i._needsProxy=!1,i.layerVisibilityEventManager=null,i._updateIntervalId=null,i._delayedRefreshToken=null,i._layersInfoPromise=null,i._styleUrl=null,i._restStartTimeOverrideString=null,i._restEndTimeOverrideString=null,i._featureLayerPromise=null,i._initiallyVisible=!1,i.originalUrl=e,i.url&&(i.url=c.UrlUtilities.simplify(e)),i.setInActiveTheme(!0),i}return __extends(i,t),i.prototype._getLayersInfo=function(){var e=this;return this._layersInfoPromise||(this._layersInfoPromise=new Promise(function(t,i){e.doWhenInitialized(function(r){if(e.serviceUrl.endsWith("/MapServer")){var n=e.serviceUrl+"/Layers",s={url:n,content:{f:"json"},load:function(e){t(e)},error:function(e){i(e)},callbackParamName:"CallBack",preventCache:!1},a={gcx:{preventCache:!1}};null!==e.serviceToken&&(s.content.token=e.serviceToken),esri.request(s,a)}else t(null)})})),this._layersInfoPromise},i.prototype.getConfiguredVisibleLayers=function(){return this._getVisibleLayersOfType("configuredVisible")},i.prototype.getDefaultVisibleLayers=function(){return this._getVisibleLayersOfType("defaultVisibility")},i.prototype.getVisibleLayers=function(){return this._getVisibleLayersOfType("_visible")},i.prototype._getVisibleLayersOfType=function(e){for(var t=[],i=0,r=0;r<this.layers.length;r++){var n=this.layers[r];n[e]&&null==n.parentLayerId&&(null==n.subLayerIds||0===n.subLayerIds.length?t[i++]=n.id:i=this._getVisibleGroupLayersOfType(e,n,t,i))}return t},i.prototype.isVisible=function(){var e=!1;return this.serviceLayer&&"boolean"==typeof this.serviceLayer.visible&&(e=this.serviceLayer.visible),e},i.prototype.isTiled=function(){return!!this.serviceLayer&&this.serviceLayer instanceof esri.layers.TiledMapServiceLayer},i.prototype.setVisibility=function(e){if(null!==this.serviceLayer){if(!this.supportsLayerVisibility()&&this.layers.length)for(var t=0;t<this.layers.length;t++){var i=this.layers[t];i&&(i._visible=e)}e?this.serviceLayer.show():this.serviceLayer.hide()}},i.prototype.setOpacity=function(e){(null==e||isNaN(e))&&(e=1),e=Math.min(1,Math.max(0,e)),this.opacity=e,this.serviceLayer&&this.serviceLayer.setOpacity&&this.serviceLayer.setOpacity(e*this.opacityFilter)},i.prototype.setOpacityFilter=function(e){isNaN(e)&&(e=1),e=Math.min(1,Math.max(0,e)),this.opacityFilter=e,this.serviceLayer&&this.serviceLayer.setOpacity&&this.serviceLayer.setOpacity(e*this.opacity)},i.prototype.setInActiveTheme=function(e){this.inActiveTheme=e,dojo.publish("MapServiceInActiveThemeChangedEvent",this)},i.prototype.findServiceToken=function(){if(this.serviceToken)return this.serviceToken;if(!this.essentialsMap||!this.essentialsMap.site||!this.essentialsMap.site.arcGisPortalSecurityContext)return null;var e=this.essentialsMap.site.arcGisPortalSecurityContext,t=e.getToken(this.serviceUrl);return t},i.prototype._findById=function(e,t){for(var i=0;i<t.length;i++){var r=t[i];if(r.id==e)return r}return null},i.prototype._findByName=function(e,t){for(var i=0;i<t.length;i++){var r=t[i];if(r.name==e||r.displayName==e)return r}return null},i.prototype.findLayerByName=function(e){return this._findByName(e,this.layers)},i.prototype.findLayerById=function(e){return this._findById(e,this.layers)},i.prototype.findTableByName=function(e){return this._findByName(e,this.tables)},i.prototype.findTableById=function(e){return this._findById(e,this.tables)},i.prototype.findLayerOrTableByName=function(e){var t=this.findLayerByName(e);return t||(t=this.findTableByName(e)),t},i.prototype.findLayerOrTableById=function(e){var t=this.findLayerById(e);return t||(t=this.findTableById(e)),t},i.prototype.refresh=function(e,t){var i=this,r=this.serviceLayer;if(r&&"function"==typeof r.refresh){var n=function(){if(i._delayedRefreshToken=null,e===!0&&"function"==typeof r.setDisableClientCaching){var e=r.disableClientCaching;r.setDisableClientCaching(!0),r.refresh(),r.setDisableClientCaching(e)}else r.refresh()};this._delayedRefreshToken&&clearTimeout(this._delayedRefreshToken),"number"!=typeof e?n():this._delayedRefreshToken=setTimeout(n,e)}},i.prototype.refreshFilteredCollections=function(){var e=this;this.layersFilteredView.length=0,dojo.forEach(this.layers,function(t){return e._addToFilteredView(t)})},i.prototype._configureLayers=function(e,t){for(var i=0;e&&i<e.length;i++)this.layers[i]=new n.Layer(this.url+"/layers/"+e[i].id),this.layers[i].mapService=this,this.layers[i]._configureObject(e[i],t);this._createServiceLayer(),this.minScale&&this.serviceLayer.setMinScale(this.minScale),this.maxScale&&this.serviceLayer.setMaxScale(this.maxScale),this.disableClientCaching&&this.serviceLayer&&this.serviceLayer.setDisableClientCaching&&this.serviceLayer.setDisableClientCaching(!0)},i.prototype._configureTimeInfo=function(){if(!this.serviceLayer)throw new Error("_configureTimeInfo: The esri service layer must be created before attempting to populate time information.");var e=this.serviceLayer.timeInfo;return e?(this.isTimeAware=!0,void(this.timeInfo=o.getGcxTimeInfo(e,this._restStartTimeOverrideString,this._restEndTimeOverrideString))):void(this.isTimeAware=!1)},i.getGcxTimeInfo=function(e,t,i){return o.getGcxTimeInfo.apply(this,arguments)},i.prototype._configureTables=function(e,t){for(var i=0;e&&i<e.length;i++)this.tables[i]=new n.Layer(this.url+"/tables/"+e[i].id),this.tables[i].mapService=this,this.tables[i]._configureObject(e[i],t)},i.prototype._createFrom=function(e){var t=this;if(this.id=e.id,this.serviceUrl=e.serviceUrl,this.tileRestUrl=e.tileRestUrl,this.mapUrl=e.mapUrl,this.subDomains=(e.subDomains||[]).slice(),this.mapServiceType=e.serviceType,this.mapServiceFunction=e.serviceFunction,this.displayName=e.displayName||e.name,this.shortDisplayName=e.shortDisplayName,this.baseMapGroup=e.baseMapGroup,this.baseMapGroupIndex=e.baseMapGroupIndex,this.baseMapGroupIsMutuallyExclusive=e.baseMapGroupIsMutuallyExclusive,this.description=e.description,this.copyright=e.copyright,this.attributionDataUrl=e.attributionDataUrl,this.hasAttributionData=e.hasAttributionData,this.configuredVisible=!!e.visible,this._initiallyVisible=this.configuredVisible,this.disableClientCaching=!!e.disableClientCaching,this.instantSearch=!!e.instantSearch,this.configuredOpacity=e.opacity,this.opacity=this.configuredOpacity,this.imageFormat=e.format,this.isExpanded=e.isExpanded,this.isUserCreated=void 0==e.isUserCreated?this.isUserCreated:e.isUserCreated,this.userLayerType=void 0==e.userLayerType?this.userLayerType:e.userLayerType,this.serverVersion=e.serverVersion,this.failureAction=e.failureAction,this.failureTimeout=e.failureTimeout,this.tileMatrixSet=e.tileMatrixSet,this.requestEncoding=e.requestEncoding,this.operationalSpatialReference=e.operationalSpatialReference,this.dataProvider=e.dataProvider,this.minScale=e.minScale,this.maxScale=e.maxScale,this.identifiable=!!e.identifiable,this.includeCatalogItems=!!e.includeCatalogItems,this.includeMosaicDatasetValues=!!e.includeMosaicDatasetValues,this.defaultDateFormat=e.defaultDateFormat,this.defaultNumberFormat=e.defaultNumberFormat,this.timeZoneId=e.timeZoneId,this.serviceTag=e.serviceTag,e.tileInfo&&(this.tileInfo=dojo.clone(e.tileInfo),this.tileInfo.spatialReference&&(this.tileInfo.spatialReference.wkid?this.tileInfo.spatialReference=new esri.SpatialReference(this.tileInfo.spatialReference.wkid):this.tileInfo.spatialReference=new esri.SpatialReference(this.tileInfo.spatialReference.wkt))),this.supportsDynamicLayers=!1,this.includeInLayerList=e.includeInLayerList,this.drawingBehavior=e.drawingBehavior||r.DrawingBehavior.FEATURE_LAYER,e.layerOptions){var i=new n.Layer;i.mapService=this,i._createFrom(e.layerOptions),this.layers.push(i)}e.hasOwnProperty("layerHyperlinks")&&e.layerHyperlinks.forEach(function(e){t.layerHyperlinks.push(new a.LayerHyperlink(e,t))}),e.featureClustering&&(this.featureClustering={enabled:e.featureClustering.enabled,userCanToggle:e.featureClustering.userCanToggle,radius:e.featureClustering.radius,maximumFeatures:e.featureClustering.clusterSize,backgroundColor:e.featureClustering.backgroundColor,labelColor:e.featureClustering.labelColor}),e.featureHeatMap&&(this.heatMap={enabled:e.featureHeatMap.enabled,userCanToggle:e.featureHeatMap.userCanToggle,respectScaleRange:e.featureHeatMap.respectScaleRange,gradient:(e.featureHeatMap.gradient||[]).slice(),offset:(e.featureHeatMap.offset||[]).slice(),intensity:e.featureHeatMap.intensity,field:e.featureHeatMap.field,defaultRenderer:e.featureHeatMap.defaultRenderer?esri.renderer.fromJson(e.featureHeatMap.defaultRenderer):null,defaultMinScale:e.featureHeatMap.defaultMinScale,defaultMaxScale:e.featureHeatMap.defaultMaxScale,includeInLegend:e.featureHeatMap.includeInLegend}),e.properties&&(this.catalogId=u._getProperties(e.properties).layerCatalogLookupId),this.isInitialized=!0},i.prototype.createFromDefinition=function(e){this._createFrom(e)},i.prototype.toJson=function(){var e={id:this.id,url:this.url,serviceUrl:this.serviceUrl,mapUrl:this.mapUrl,tileRestUrl:this.tileRestUrl,subDomains:(this.subDomains||[]).slice(),serviceType:this.mapServiceType,serviceFunction:this.mapServiceFunction,displayName:this.displayName,shortDisplayName:this.shortDisplayName,baseMapGroup:this.baseMapGroup,baseMapGroupIndex:this.baseMapGroupIndex,baseMapGroupIsMutuallyExclusive:this.baseMapGroupIsMutuallyExclusive,description:this.description,copyright:this.copyright,attributionDataUrl:this.attributionDataUrl,hasAttributionData:this.hasAttributionData,visible:this.isVisible(),disableClientCaching:this.disableClientCaching,opacity:this.opacity,instantSearch:this.instantSearch,format:this.imageFormat,updateInterval:this.updateInterval,isExpanded:this.isExpanded,serverVersion:this.serverVersion,failureAction:this.failureAction,failureTimeout:this.failureTimeout,tileMatrixSet:this.tileMatrixSet,requestEncoding:this.requestEncoding,operationalSpatialReference:this.operationalSpatialReference,dataProvider:this.dataProvider,minScale:this.minScale,maxScale:this.maxScale,identifiable:this.identifiable,includeCatalogItems:this.includeCatalogItems,includeMosaicDatasetValues:this.includeMosaicDatasetValues,defaultDateFormat:this.defaultDateFormat,defaultNumberFormat:this.defaultNumberFormat,timeZoneId:this.timeZoneId,serviceTag:this.serviceTag,startTime:this._restStartTimeOverrideString,endTime:this._restEndTimeOverrideString,tileInfo:this.tileInfo&&"function"==typeof this.tileInfo.toJson?this.tileInfo.toJson():void 0,supportsDynamicLayers:this.supportsDynamicLayers,hasLayerCatalog:this.hasLayerCatalog,includeInLayerList:this.includeInLayerList,drawingBehavior:this.drawingBehavior,layerOptions:this.layers.map(function(e){return e.toJson()}),catalogId:this.catalogId,isUserCreated:this.isUserCreated,userLayerType:this.userLayerType,tables:this.tables.map(function(e){return e.toJson()}),layerHyperlinks:this.layerHyperlinks.map(function(e){return e.toJson()}),properties:u._propertiesToJson(this.properties),extensions:u._extensionsToJson(this.extensions)};return this.featureClustering&&(e.featureClustering=dojo.clone(this.featureClustering)),this.heatMap&&(e.featureHeatMap=dojo.clone(this.heatMap),e.featureHeatMap.defaultRenderer instanceof esri.renderer.Renderer&&(e.featureHeatMap.defaultRenderer=e.featureHeatMap.defaultRenderer.toJson())),e},i.prototype._configureObject=function(e,t){var i=this;if(void 0===e||void 0===e.id||void 0===e.displayName||void 0===e.serviceType||void 0==e.connectionString)throw new Error("Incorrect map service object returned from initialization");if(this.id=e.id,this.mapServiceType=e.serviceType,this.mapServiceFunction=void 0===e.serviceFunction?this.mapServiceFunction:e.serviceFunction,this.displayName=e.displayName,this.shortDisplayName=e.shortDisplayName,this.baseMapGroup=e.baseMapGroup,this.baseMapGroupIndex=e.baseMapGroupIndex,this.baseMapGroupIsMutuallyExclusive=e.baseMapGroupIsMutuallyExclusive,this.description=void 0===e.description?this.description:e.description,this.copyright=e.copyright,this.attributionDataUrl=e.attributionDataUrl,this.hasAttributionData=e.hasAttributionData,this.configuredVisible=!!e.visible,this.disableClientCaching=!!e.disableClientCaching,this.instantSearch=!!e.instantSearch,this.configuredOpacity=void 0===e.opacity||null===e.opacity?this.configuredOpacity:e.opacity,this.opacity=this.configuredOpacity,this.imageFormat=void 0===e.format?this.imageFormat:e.format,void 0!==e.updateInterval){var r=e.updateInterval;r&&r<10&&0!==r&&(r=10),this.updateInterval=r,this._resetUpdateTimer()}if(this.tileRestUrl=e.tileRestUrl,this.mapUrl=e.mapUrl,this.subDomains=(e.subDomains||[]).slice(),this.isExpanded=void 0==e.isExpanded?this.isExpanded:e.isExpanded,this.isUserCreated=void 0==e.isUserCreated?this.isUserCreated:e.isUserCreated,this.userLayerType=void 0==e.userLayerType?this.userLayerType:e.userLayerType,this.catalogId=void 0==e.catalogId?this.catalogId:e.catalogId,this.serverVersion=e.serverVersion,this.failureAction=e.failureAction,this.failureTimeout=e.failureTimeout,this.tileMatrixSet=e.tileMatrixSet,this.requestEncoding=e.requestEncoding,this.operationalSpatialReference=e.operationalSpatialReference,this.dataProvider=e.dataProvider,this.minScale=e.minScale,this.maxScale=e.maxScale,this.identifiable=!!e.identifiable,this.includeCatalogItems=!!e.includeCatalogItems,this.includeMosaicDatasetValues=!!e.includeMosaicDatasetValues,this.defaultDateFormat=e.defaultDateFormat,this.defaultNumberFormat=e.defaultNumberFormat,this.timeZoneId=e.timeZoneId,this.serviceTag=e.serviceTag,this._restStartTimeOverrideString=e.startTime||null,this._restEndTimeOverrideString=e.endTime||null,e.tileInfo&&(this.tileInfo=dojo.clone(e.tileInfo),this.tileInfo.spatialReference&&(this.tileInfo.spatialReference.wkid?this.tileInfo.spatialReference=new esri.SpatialReference(this.tileInfo.spatialReference.wkid):this.tileInfo.spatialReference=new esri.SpatialReference(this.tileInfo.spatialReference.wkt))),"boolean"==typeof e.includeInLayerList&&(this.includeInLayerList=e.includeInLayerList),this.isUserCreated)this._initiallyVisible=void 0===e.initiallyVisible?!!e.visible:!!e.initiallyVisible;else if(null!=this.essentialsMap.layerThemesInfo.startupThemeId&&this.includeInLayerList?this._initiallyVisible=!1:this._initiallyVisible=void 0===e.initiallyVisible?!!e.visible:!!e.initiallyVisible,e.themeSettings&&e.themeSettings.length)for(var n=0;n<e.themeSettings.length;n++){var o=e.themeSettings[n],l=this.essentialsMap.layerThemesInfo.getTheme(o.themeID);if(l){var c=void 0==o.visible?this.configuredVisible:o.visible;this.layerThemeSettings.push(new s.LayerThemeSetting(l,c)),l.id===this.essentialsMap.layerThemesInfo.startupThemeId&&this.includeInLayerList&&(this._initiallyVisible=void 0===o.initiallyVisible?c:o.initiallyVisible)}}if(this.supportsDynamicLayers=void 0===e.supportsDynamicLayers?this.supportsDynamicLayers:e.supportsDynamicLayers,this.hasLayerCatalog=void 0===e.hasLayerCatalog?this.hasLayerCatalog:e.hasLayerCatalog,e.iconUri){var h=null;this.essentialsMap&&(h=this.essentialsMap.site),this.iconUri=p.RestHelper.processClientSideTokens(h,e.iconUri)}e.featureClustering&&(this.featureClustering={enabled:e.featureClustering.enabled,userCanToggle:e.featureClustering.userCanToggle,radius:e.featureClustering.radius,maximumFeatures:e.featureClustering.clusterSize,backgroundColor:e.featureClustering.backgroundColor,labelColor:e.featureClustering.labelColor}),e.featureHeatMap&&(this.heatMap={enabled:e.featureHeatMap.enabled,userCanToggle:e.featureHeatMap.userCanToggle,respectScaleRange:e.featureHeatMap.respectScaleRange,gradient:(e.featureHeatMap.gradient||[]).slice(),offset:(e.featureHeatMap.offset||[]).slice(),intensity:e.featureHeatMap.intensity,field:e.featureHeatMap.field,defaultRenderer:e.featureHeatMap.defaultRenderer?esri.renderer.fromJson(e.featureHeatMap.defaultRenderer):null,defaultMinScale:e.featureHeatMap.defaultMinScale,defaultMaxScale:e.featureHeatMap.defaultMaxScale,includeInLegend:e.featureHeatMap.includeInLegend}),this.drawingBehavior=void 0===e.drawingBehavior?this.drawingBehavior:e.drawingBehavior,this._processConnectionString(e.connectionString,e),this._processProxyInfo(e.proxyInfo);var d=e.layers||e.layerOptions;this._configureLayers(d,t),this._configureTables(e.tables,t),e.hasOwnProperty("layerHyperlinks")&&e.layerHyperlinks.forEach(function(e){i.layerHyperlinks.push(new a.LayerHyperlink(e,i))}),t&&(this.isInitialized=!0),this.properties=u._getProperties(e.properties),this.extensions=u._getExtensions(e.extensions),this.setOpacity(this.configuredOpacity)},i.prototype._updateServiceToken=function(e){if(this.serviceToken=e,this.serviceLayer&&this.serviceLayer._url){var t=this.serviceLayer._url;if(t.query){t.query.token=e;var i=dojo.objectToQuery(t.query);this.serviceLayer.url=t.path+(i?"?"+i:"")}}dojo.publish("ServiceTokenRefreshed",{serviceUrl:this.serviceUrl,token:e})},i.prototype._addDefinitionExpression=function(e,t){if(!e)throw new Error("Expecting a layer");if(t=t||this.serviceLayer,t instanceof esri.layers.ArcGISDynamicMapServiceLayer){var i=e.getDefinitionExpression(null);if(i){var r=parseInt(e.id),n=t.layerDefinitions||[];if(!r)throw new Error("Failed to add definition expression for "+e.displayName);n[r]=i,t.setLayerDefinitions(n)}}},i.prototype._removeDefinitionExpression=function(e,t){if(e&&(t=t||this.serviceLayer,t&&t instanceof esri.layers.ArcGISDynamicMapServiceLayer)){var i=parseInt(e.id);if(i&&t.layerDefinitions){var r=t.layerDefinitions;r[i]&&(r.splice(i,1),t.setLayerDefinitions(r))}}},i.prototype._createServiceLayer=function(){var t=this;if(null==this.serviceLayer){var n=this.serviceUrl;if(null!=this.serviceToken&&(n=d.RestHelperHTTPService.appendTokenToUrl(n,this.serviceToken)),"MapService"===this.drawingBehavior){var s;switch(this.mapServiceType){case r.MapServiceType.DYNAMIC:this._needsProxy&&(esri.config.defaults.io.alwaysUseProxy=!0);var a=new esri.layers.ArcGISDynamicMapServiceLayer(n,{id:this.id});this._applyAttributionUrl(a);var o=this.getVisibleLayers();0===o.length?a.setVisibleLayers&&(0===this.layers.length?a.setVisibleLayers(o,!1):a.setVisibleLayers(["-1"],!1)):a.setVisibleLayers&&a.setVisibleLayers(o,!1);for(var c=0;c<this.layers.length;c++)this._addDefinitionExpression(this.layers[c],a);this.layerVisibilityEventManager=new l.LayerVisibilityEventManager(this,a),a.setImageFormat(this._getAgsDynamicImageFormat(this.imageFormat)),dojo.connect(a,"onError",this,this._layerLoadErrorHandler),dojo.connect(a,"onLoad",this,function(){this._handleServiceLayerLoaded(a),this._handleDynamicLayers(a)}),this._initiallyVisible?a.show():a.hide(),this.serviceLayer=a;break;case r.MapServiceType.TILED:var u=new esri.layers.ArcGISTiledMapServiceLayer(n,{id:this.id});this._applyAttributionUrl(u),dojo.connect(u,"onError",dojo.hitch(this,this._layerLoadErrorHandler)),dojo.connect(u,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded)),this._initiallyVisible?u.show():u.hide(),this.serviceLayer=u;break;case r.MapServiceType.IMAGE:var p=null;this._hasTileLevels()?p=new esri.layers.ArcGISTiledMapServiceLayer(n,{id:this.id}):(p=new esri.layers.ArcGISImageServiceLayer(n,{id:this.id}),p.setImageFormat(this._getAgsImageServiceImageFormat(this.imageFormat))),this._applyAttributionUrl(p),dojo.connect(p,"onError",this,this._layerLoadErrorHandler),dojo.connect(p,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded)),this._initiallyVisible?p.show():p.hide(),this.serviceLayer=p;break;case r.MapServiceType.BING:var f=new esri.virtualearth.VETiledLayer(this.bingProperties);dojo.connect(f,"onError",this,this._layerLoadErrorHandler),dojo.connect(f,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded)),this._initiallyVisible?f.show():f.hide(),this.serviceLayer=f;break;case r.MapServiceType.WMS:if(!dojo.isObject(esri.layers.WMSLayer))throw new Error("This Javascript application must require the esri.layers.wms package in order to use a site with a WMS service.");this._extendWms();for(var y=!1,c=0;c<this.layers.length;c++)if(this.layers[c].wmsLayerName){y=!0;break}var m;if(y){if(s={extent:this.essentialsMap.initialExtent,layerInfos:this._constructWmsLayerInfos(),version:this.serverVersion},m=new esri.layers.WMSLayer(n,{resourceInfo:s,visibleLayers:this._getWmsVisibleLayers()}),null!=this.operationalSpatialReference){var g=parseInt(this.operationalSpatialReference.replace(/^.*:/,""));m.spatialReferences.push(g),m.preferredSpatialReference=g}dojo.connect(m,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded))}else m=new esri.layers.WMSLayer(n),dojo.connect(m,"onLoad",dojo.hitch(this,this._finishWmsLayerConfiguration));if(this._restStartTimeOverrideString&&this._restEndTimeOverrideString&&!m.timeInfo){var v=i.getGcxTimeInfo(null,this._restStartTimeOverrideString,this._restEndTimeOverrideString);if(v){var S={timeExtent:new esri.TimeExtent(v.timeExtent.startTime,v.timeExtent.endTime)};m.timeInfo=S}}m.id=this.id,this._applyAttributionUrl(m),this.layerVisibilityEventManager=new l.LayerVisibilityEventManager(this,m),m.setImageFormat(this._getEsriWmsImageFormat()),m.__gcxWmsImageFormat=this.imageFormat,dojo.connect(m,"onError",this,this._layerLoadErrorHandler),this._initiallyVisible?m.show():m.hide(),this.serviceLayer=m,this._corsRequest(this._prefixProxy(n)).then(function(){m.refresh()},function(e){m.refresh()});break;case r.MapServiceType.WMTS:if(!dojo.isObject(esri.layers.WMTSLayer))throw new Error("This JavaScript application must require the esri.layers.wmts package in order to use a site with WMTS service.");if(0==this.layers.length)throw new Error("You must include at least one layer in your WMTS. Service "+this.displayName+" has 0 layers.");this.tileInfo&&this.tileInfo.dpi&&this.tileInfo.lods.forEach(function(e){return e.scale=96*(e.scale/t.tileInfo.dpi)});var x=this.layers[0].fullExtent?this.layers[0].fullExtent:this.essentialsMap.fullExtent,b=new esri.layers.WMTSLayerInfo({tileInfo:this.tileInfo,fullExtent:x,initialExtent:x,identifier:this.layers.length>0?this.layers[0].name:null,tileMatrixSet:this.tileMatrixSet,format:this._getEsriOgcImageFormat(),style:this.layers[0].styleName?this.layers[0].styleName:""});s={version:this.serverVersion,layerInfos:[b],getTileUrl:this._prefixProxy(this.mapUrl)};var I={serviceMode:"KVP",resourceInfo:s,layerInfo:b},w=new esri.layers.WMTSLayer(n,I);if(w.id=this.id,this._applyAttributionUrl(w),w._url){var E=0,_=h.hasProxy()?2:1;w._url=w._url.replace(/\?/g,function(e){return E++,E<=_?"?":""})}dojo.connect(w,"onError",this,this._layerLoadErrorHandler),dojo.connect(w,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded)),this._initiallyVisible?w.show():w.hide(),this.serviceLayer=w;break;case r.MapServiceType.WEBTILED:var T=n.replace(/([^$])({[^}]*})/g,function(e,t,i){return t+"$"+i}),L={copyright:this.copyright,id:this.id,subDomains:null};T.indexOf("${subDomain}")>=0&&(L.subDomains=this.subDomains);var D=new esri.layers.WebTiledLayer(T,L);D.id=this.id,this._applyAttributionUrl(D),this._initiallyVisible?D.show():D.hide(),dojo.connect(D,"onError",this,this._layerLoadErrorHandler),dojo.connect(D,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded)),this.serviceLayer=D;break;case r.MapServiceType.VECTORTILE:var C=n;if(this._styleUrl&&(C=this._styleUrl,this.essentialsMap&&this.essentialsMap.site)){var R=this.essentialsMap.site.getTokenFromPrincipal(this._styleUrl,this.mapServiceType);R&&(C=d.RestHelperHTTPService.appendTokenToUrl(this._styleUrl,R))}e(["esri/layers/VectorTileLayer"],function(e){var i=new e(C);i.id=t.id,i.loadError&&t._layerLoadErrorHandler(i.loadError),t._initiallyVisible?i.show():i.hide(),dojo.connect(i,"onError",t,t._layerLoadErrorHandler),dojo.connect(i,"onLoad",dojo.hitch(t,t._handleServiceLayerLoaded)),t._applyAttributionUrl(i),t.serviceLayer=i})}this.initiateServiceFailureTimer()}}},i.prototype.initiateServiceFailureTimer=function(){var e=this;this.failureTimeout&&!isNaN(this.failureTimeout)&&setTimeout(function(){e.serviceLayer&&(!e.serviceLayer||e.serviceLayer.loaded)||e.initializationFailure||(e.failureTimeoutThresholdExceeded=!0,e.onFailureTimeoutThresholdExceeded())},1e3*this.failureTimeout)},i.prototype._applyAttributionUrl=function(e){if(this.attributionDataUrl&&""!==this.attributionDataUrl)e.attributionDataUrl=this.attributionDataUrl,e.hasAttributionData=!0;else if(this.hasAttributionData){e.attributionDataUrl=this.url+"/attribution",e.hasAttributionData=!0;var t=d.RestHelperHTTPService.getTokenForScope(e.attributionDataUrl);t&&(e.attributionDataUrl=d.RestHelperHTTPService.appendTokenToUrl(e.attributionDataUrl,t))}},i.prototype._prefixProxy=function(e){return this.proxyUrl?this.proxyUrl+"?"+e:e},i.prototype._constructWmsLayerInfos=function(){for(var e=[],t=0;t<this.layers.length;t++){var i=this.layers[t];if(null!=i.wmsLayerName){var r=new esri.layers.WMSLayerInfo({name:i.wmsLayerName,title:i.name});r.styleName=i.styleName,e.push(r)}}return e},i.prototype._getWmsVisibleLayers=function(){for(var e=[],t=0;t<this.layers.length;t++){var i=this.layers[t];i.isVisible()&&i.areAllAncestorsVisible()&&null!=i.wmsLayerName&&0==i.subLayerIds.length&&e.push(i.wmsLayerName)}return e},i.prototype._applyWmsLayerVisibility=function(){var e=this._getWmsVisibleLayers();this.serviceLayer.setVisibleLayers(e)},i.prototype._getEsriWmsImageFormat=function(){var e=this._getEsriOgcImageFormat();return"jpeg"==e&&(e="jpg"),e},i.prototype._getEsriOgcImageFormat=function(){return null!=this.imageFormat?this.imageFormat.replace(/^image\//,""):null},i.prototype._findWMSLayerName=function(e,t){for(var i in e){var r=e[i];if(r.title===t)return r.name;if(null!==r.subLayers&&r.subLayers.length>0){var n=this._findWMSLayerName(r.subLayers,t);if(null!==n)return n}}return null},i.prototype._finishWmsLayerConfiguration=function(e){for(var t,i=[],r=0,n=0;n<this.layers.length;n++){var s=this.layers[n];if(s.configuredVisible&&(null===s.subLayerIds||0===s.subLayerIds.length))if(null!==s.parentLayerId){var a=this.findLayerById(s.parentLayerId);a.configuredVisible&&(t=this._getWMSLayerNameFromTitle(s.name),s.wmsLayerName=t,null!==t&&""!==t&&(i[r]=t,r++))}else t=this._getWMSLayerNameFromTitle(s.name),s.wmsLayerName=t,null!==t&&""!==t&&(i[r]=t,r++)}this.serviceLayer.setVisibleLayers(i),this._handleServiceLayerLoaded(e)},i.prototype._handleServiceLayerLoaded=function(e){this._configureTimeInfo(),this.isServiceLayerLoaded=!0,this.essentialsMap&&this.essentialsMap.site&&dojo.isFunction(this.essentialsMap.site.onLayerLoad)&&this.essentialsMap.site.onLayerLoad(e)},i.prototype.convertToDynamicLayers=function(){var e=this.serviceLayer;e&&e instanceof esri.layers.ArcGISDynamicMapServiceLayer&&(e.dynamicLayerInfos||e.setDynamicLayerInfos(this._createDynamicLayerInfos(e)),e.layerDrawingOptions||(e.layerDrawingOptions=[]))},i.prototype._layerLoadErrorHandler=function(e){e&&e.message&&0==e.message.indexOf("Unable to load tile")||(this.initializationFailure=e,this.essentialsMap&&this.essentialsMap.site&&dojo.isFunction(this.essentialsMap.site.onLayerLoadError)&&(this._layerLoadErrorHandler=this.essentialsMap.site.onLayerLoadError))},i.prototype.remove=function(e){if(!e)throw new Error("Expecting a layer.");var t=this.serviceLayer;if(!(e.isDynamic&&this.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer&&this.serviceLayer))throw"MapService - remove() - Unsupported Layer Type.";this.convertToDynamicLayers();var i=parseInt(e.id,10),r=this.findLayerById(e.id);if(null!=r){var n=this.layers.indexOf(r);n>-1&&(r.setInActiveTheme(!1),this.layers.splice(n,1),dojo.publish("CatalogLayerRemovedEvent",r))}var s=this.getVisibleLayers();if(null==i)throw"Could not convert Layer ID '"+e.id+"' into an integer!";var a=[];t.dynamicLayerInfos&&(a=dojo.clone(this.serviceLayer.dynamicLayerInfos));
var o=[];if(t.layerDrawingOptions&&(o=this.serviceLayer.layerDrawingOptions),e.isDynamic){for(var l=null,c=0;c<a.length;c++)if(a[c].id===i){l=a[c];break}if(l){var n=a.indexOf(l);n>-1&&(a.splice(n,1),t.setDynamicLayerInfos(a,!0))}var u=[];for(var p in o)o.hasOwnProperty(p)&&p!==e.id&&(u[p]=dojo.clone(o[p]));this._removeDefinitionExpression(e,t),t.setLayerDrawingOptions(u)}s.indexOf(e.id)>-1&&s.splice(s.indexOf(e.id),1),this._syncLayerVisibilities(s)},i.prototype.add=function(e){if(!e)throw new Error("Expecting a layer");var t=this.serviceLayer;if(!(e.isDynamic&&t instanceof esri.layers.ArcGISDynamicMapServiceLayer))throw"MapService - add() - Unsupported layer type..";this.convertToDynamicLayers();var i=this.getVisibleLayers();e.mapService=this;var r=[];t.dynamicLayerInfos&&(r=t.dynamicLayerInfos);var n=[];t.layerDrawingOptions&&(n=t.layerDrawingOptions);var s,a,o=parseInt(e.id,10);if(null==o)throw"Could not convert Layer ID '"+e.id+"' into an integer!";s=e._createDynamicLayerInfo(),s.name||(s.name=e.displayName),null!=s&&r.push(s),a=e.getLayerDrawingOptions(),null!=a&&(n[o]=a),n.length>0&&t.setLayerDrawingOptions(n,!0),this._addDefinitionExpression(e,t),t.setDynamicLayerInfos(r),i.push(e.id),this._syncLayerVisibilities(i),this.layers.push(e),dojo.publish("CatalogLayerAddedEvent",e)},i.prototype.getDynamicLayerInfoById=function(e){var t=null;if(this.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer){var i=parseInt(e,10);if(!isNaN(i)){var r=this.serviceLayer.dynamicLayerInfos;if(r)for(var n=0;n<r.length;n++)r[n].id===i&&(t=r[n])}}return t},i.prototype._syncLayerVisibilities=function(e){for(var t=0;t<this.layers.length;t++)e.indexOf(this.layers[t].id)>-1?this.layers[t].visibleStateForRefresh=f.RefreshVisibility.SHOW:this.layers[t].visibleStateForRefresh=f.RefreshVisibility.HIDE;0==e.length&&e.push("-1"),this.serviceLayer.setVisibleLayers(e)},i.prototype._handleDynamicLayers=function(e){var t=this;if(this.supportsDynamicLayers){var i=dojo.some(this.layers,function(e){return e.isDynamic}),r=dojo.some(this.layers,function(e){return null!=e.drawIndex}),n=dojo.some(this.layers,function(e){return e.canToggleLabels&&!e.showLabels});if(i||r||n||this.hasLayerCatalog){var s=this.essentialsMap.getMap();if(s&&(s.spatialReference&&(s.spatialReference.wkid&&!(s.spatialReference.wkid<=0)||s.spatialReference.wkt&&s.spatialReference.wkt.trim())||null!=e.spatialReference&&e.spatialReference.wkt&&e.spatialReference.wkt.trim()&&(s.spatialReference=e.spatialReference),s.extent&&(!s.extent.spatialReference||(!s.extent.spatialReference.wkid||s.extent.spatialReference.wkid<=0)&&(!s.extent.spatialReference.wkt||!s.extent.spatialReference.wkt.trim()))&&null!=e.spatialReference&&e.spatialReference.wkt&&e.spatialReference.wkt.trim())){var a=new esri.geometry.Extent(s.extent);a.spatialReference=e.spatialReference,this.essentialsMap.extentManager.setExtentWithPriority(a,2)}var o=this._createDynamicLayerInfos(e),l=[];if(e.layerDrawingOptions&&(l=dojo.mixin([],e.layerDrawingOptions)),n&&dojo.forEach(this.layers,function(e,t){if(e.canToggleLabels){var i=e.getLayerDrawingOptions();if(null==i){i=new esri.layers.LayerDrawingOptions;var r=parseInt(e.id,10);l[r]=i}i.showLabels=e.showLabels}}),dojo.forEach(this.layers,function(e,t){if(e.isDynamic){var i,r,n=parseInt(e.id,10);if(!n)throw"Could not convert Layer ID '"+e.id+"' into an integer!";i=e._createDynamicLayerInfo(),i.name||(i.name=e.name),i&&o.splice(t,0,i),r=e.getLayerDrawingOptions(),r&&(l[n]=r,null!=e.showLabels&&(r.showLabels=e.showLabels))}}),r){var c=dojo.clone(o),u=[];dojo.forEach(this.layers,function(e,t){null!=e&&null!=e.drawIndex&&u.push(e)}),u.sort(function(e,t){return e.drawIndex-t.drawIndex}),dojo.forEach(u,function(e,t){for(var i=null,r=null,n=0;n<c.length;n++){var s=c[n];if(s.id.toString()==e.id){i=s,r=n;break}}null!=i&&null!=r&&(c.splice(r,1),c.push(i))}),o=[],dojo.forEach(c,function(e,t){o.push(e)})}setTimeout(function(){e.visibleLayers;l.length>0&&e.setLayerDrawingOptions(l,!0),o.length>0&&e.setDynamicLayerInfos(o,!0);var i=t.getVisibleLayers();i.InternallyChangedLayer={},i.length>0?e.setVisibleLayers(i):(i.push("-1"),e.setVisibleLayers(i))},0)}}},i.prototype._createDynamicLayerInfos=function(e,t){void 0==t&&(t=!0);var i=null;if(null!=e&&(i=e.createDynamicLayerInfosFromLayerInfos(),t))for(var r=i.length-1;r>=0;r--){var n=this.findLayerById(i[r].id.toString());(null==n||n.isDynamic)&&i.splice(r,1)}return i},i.prototype._getAgsDynamicImageFormat=function(e){if("undefined"==typeof e||null===e||e.length<1)return"png8";var t=e.toLowerCase();switch(t){case"png":case"png8":case"png24":case"png32":case"jpeg":case"jpg":case"gif":case"bmp":case"svg":case"svgz":case"emf":case"ps":case"pdf":return t;default:return"png8"}},i.prototype._getAgsImageServiceImageFormat=function(e){if("undefined"==typeof e||null===e||e.length<1)return null;var t=e.toLowerCase();switch(t){case"jpgpng":case"png":case"png8":case"png24":case"png32":case"jpeg":case"jpg":case"gif":case"bmp":case"tiff":return t;default:return null}},i.prototype._getVisibleGroupLayersOfType=function(e,t,i,r){if(t[e])for(var n=0;n<t.subLayerIds.length;n++){var s=this.findLayerById(t.subLayerIds[n]);s[e]&&(null!==s.subLayerIds&&s.subLayerIds.length>0?r=this._getVisibleGroupLayersOfType(e,s,i,r):dojo.indexOf(i,s.id)<0&&(i[r]=s.id,r++))}return r},i.prototype._getWMSLayerNameFromTitle=function(e){return this.serviceLayer instanceof esri.layers.WMSLayer?this._findWMSLayerName(this.serviceLayer.layerInfos,e):null},i.prototype._getPrincipalResult=function(e){if(this.essentialsMap&&this.essentialsMap.site&&this.essentialsMap.site.principal)return e(this.essentialsMap.site.principal)},i.prototype._processConnectionString=function(e,t){var i=y.ServiceHelper.extractConnectionStringValue;if(this.mapServiceType==r.MapServiceType.BING){this.bingProperties={};var n;n=i(e,"mapStyle"),n&&n.length>0&&(this.bingProperties.mapStyle=n),n=i(e,"culture"),n&&n.length>0&&(this.bingProperties.culture=n),n=i(e,"key"),n&&n.length>0&&(this.bingProperties.bingMapsKey=n)}else{var s=i(e,"url");if(s.length>0)this.serviceUrl=s.replace(/%3d/g,"=").replace(/%3D/g,"=").replace(/%3a/g,":").replace(/%3A/g,":");else if((this.mapServiceType===r.MapServiceType.DYNAMIC||this.mapServiceType===r.MapServiceType.TILED)&&this.essentialsMap.site.getEssentialsVersion()>=3.912||(this.mapServiceType===r.MapServiceType.FEATURE||this.mapServiceType===r.MapServiceType.IMAGE||this.mapServiceType===r.MapServiceType.STREAM||this.mapServiceType===r.MapServiceType.VECTORTILE)&&this.essentialsMap.site.getEssentialsVersion()>=4.01){if(this.essentialsMap.site.getEssentialsVersion()<4.03)this.serviceUrl=this.url+"/MapServer";else{var a=this.essentialsMap.site.getEssentialsVersion()<4.05?"/GeoREST":"/rest/services/x";if(this.mapServiceType===r.MapServiceType.FEATURE){if(!(t&&t.layers&&t.layers.length>0&&t.layers[0]))throw new Error("Unable to configure FeatureLayer connection string. No child layer is specified.");this.serviceUrl=this.url+a+"/FeatureServer/"+t.layers[0].id}else this.mapServiceType===r.MapServiceType.IMAGE?this.serviceUrl=this.url+a+"/ImageServer":this.mapServiceType===r.MapServiceType.STREAM?this.serviceUrl=this.url+a+"/StreamServer":this.mapServiceType===r.MapServiceType.VECTORTILE?this.serviceUrl=this.url+a+"/VectorTileServer":this.serviceUrl=this.url+a+"/MapServer"}this._getPrincipalResult(function(e){return e.isAuthenticated})&&(this.serviceToken=this._getPrincipalResult(function(e){return e.tokens.site})),"3.912"===this.essentialsMap.site.currentVersion&&(this._needsProxy=!0)}var o=i(e,"geometryServiceUrl");o.length>0&&(this.geometryServiceUrl=o),this.mapServiceType===r.MapServiceType.VECTORTILE&&(this._styleUrl=i(e,"styleUrl")),this.essentialsMap&&this.essentialsMap.site&&!this.serviceToken&&(this.serviceToken=this.essentialsMap.site.getTokenFromPrincipal(this.serviceUrl,this.mapServiceType));var l=i(e,"token"),c=this.essentialsMap&&this.essentialsMap.site?this.essentialsMap.site.arcGisPortalSecurityContext:null;l.length>0?this.serviceToken=l:c&&c.appliesTo(this.serviceUrl)&&c.tokenResult&&(this.serviceToken=c.tokenResult.token);var u=i(e,"proxy");u.length>0&&(this.proxyUrl=u,esri.addProxyRule({urlPrefix:this.serviceUrl,proxyUrl:u}),this.serviceUrl.indexOf("services.arcgis")>-1&&esri.addProxyRule({urlPrefix:this.serviceUrl.replace("services.arcgis","server.arcgis"),proxyUrl:u}));var p=i(e,"mapUrl");p.length>0&&(this.mapUrl=p.replace(/%3d/g,"=").replace(/%3D/g,"="));var h=i(e,"tileRestUrl");h.length>0&&(this.tileRestUrl=h.replace(/%3d/g,"=").replace(/%3D/g,"="));var d=i(e,"subDomains");d&&(this.subDomains=d.split(","))}},i.prototype._isLocalProxyInfo=function(e){return!!e&&("local-reverse-proxy"==e.type&&!!e.address)},i.prototype._processProxyInfo=function(e){if(this._isLocalProxyInfo(e)){for(var t=this.url+"/../../../../../"+e.address,i=t.split("/"),r=i.indexOf("..");r>0;r=i.indexOf(".."))i.splice(r-1,2);this.serviceUrl=i.join("/")}},i.prototype.supportsLayerVisibility=function(){switch(this.mapServiceType){case r.MapServiceType.WMS:return!0;case r.MapServiceType.DYNAMIC:return null!==this.serviceLayer&&!!this.serviceLayer.visibleLayers;case r.MapServiceType.GRAPHICS:case r.MapServiceType.FEATURE:case r.MapServiceType.CSV:case r.MapServiceType.LABEL:case r.MapServiceType.STREAM:case r.MapServiceType.GEORSS:case r.MapServiceType.KML:case r.MapServiceType.BING:case r.MapServiceType.TILED:case r.MapServiceType.WMTS:case r.MapServiceType.IMAGE:case r.MapServiceType.WEBTILED:case r.MapServiceType.VECTORTILE:case r.MapServiceType.MAPIMAGE:case r.MapServiceType.UNKNOWN:default:return!1}},i.prototype._setVisibility=function(e,t,i){var n={mapServiceId:this.id,layerId:e,visibility:t};void 0===i&&(i=!1);var s,a,o;switch(this.mapServiceType){case r.MapServiceType.DYNAMIC:if(null!==this.serviceLayer){var l=this.serviceLayer.visibleLayers;if(!l){t?this.serviceLayer.show():this.serviceLayer.hide(),dojo.publish("LayerVisibilityChange",[new Array(n)]);break}var c=this.getVisibleLayers();c.InternallyChangedLayer=n,0===c.length&&c.push("-1"),this.serviceLayer.setVisibleLayers&&this.serviceLayer.setVisibleLayers(c,i)}break;case r.MapServiceType.WMS:if(null!==this.serviceLayer){var u=[];for(u.InternallyChangedLayer=n,s=0,a=0;a<this.layers.length;a++)if(o=this.layers[a],o.isVisible()&&(null===o.subLayerIds||0===o.subLayerIds.length)&&o.areAllAncestorsVisible()){var p=o.wmsLayerName;null!==p&&""!==p&&(u[s]=p,s++)}i?(this.serviceLayer.visibleLayers=u.slice(0),dojo.publish("LayerVisibilityChange",[new Array(n)])):this.serviceLayer.setVisibleLayers(u)}break;case r.MapServiceType.GRAPHICS:case r.MapServiceType.FEATURE:case r.MapServiceType.CSV:case r.MapServiceType.LABEL:case r.MapServiceType.STREAM:case r.MapServiceType.GEORSS:case r.MapServiceType.KML:case r.MapServiceType.BING:case r.MapServiceType.TILED:case r.MapServiceType.WMTS:case r.MapServiceType.IMAGE:case r.MapServiceType.WEBTILED:case r.MapServiceType.VECTORTILE:case r.MapServiceType.MAPIMAGE:case r.MapServiceType.WFS:if(null!==this.serviceLayer){if(1!==this.layers.length)throw new Error("Visibility of individual layers cannot be set for this Map Service: {0}".format(this.displayName));t?this.serviceLayer.show():this.serviceLayer.hide(),dojo.publish("LayerVisibilityChange",[new Array(n)])}break;default:throw new Error("Cannot set layer visibility. Unknown MapService type.")}},i.prototype._extendWms=function(){if(!i._wmsExtended){var e=esri.layers.WMSLayer._meta.hidden.getImageUrl,t=/.*images\/pixel.png$/;esri.layers.WMSLayer.extend({getImageUrl:function(i,r,n,s){function a(e){if(t.test(e))return void s(e);for(var i={},r=0;r<o.layerInfos.length;r++)i[o.layerInfos[r].name]=o.layerInfos[r].styleName;var n=[];for(r=0;r<o.visibleLayers.length;r++)n.push(i[o.visibleLayers[r]]);var a=n.join(","),l=e.substring(e.lastIndexOf("?")+1,e.length),c=dojo.queryToObject(l);if(c.STYLES=a,o.preferredSpatialReference){var u=c.CRS?"CRS":"SRS";c[u]="EPSG:"+o.preferredSpatialReference}o.__gcxWmsImageFormat&&(c.FORMAT=o.__gcxWmsImageFormat);var p=o.getMap(),h=p&&p.timeExtent?p.timeExtent.startTime:o.timeInfo&&o.timeInfo.timeExtent&&o.timeInfo.timeExtent.startTime,d=p&&p.timeExtent?p.timeExtent.endTime:o.timeInfo&&o.timeInfo.timeExtent&&o.timeInfo.timeExtent.endTime;if(h&&d){var f=new Date(h.getTime()-60*h.getTimezoneOffset()*1e3).toISOString(),y=new Date(d.getTime()-60*d.getTimezoneOffset()*1e3).toISOString();c.TIME=f+"/"+y}var m=e.substring(0,e.lastIndexOf("?")+1)+dojo.objectToQuery(c);s(m)}var o=this;e.apply(this,[i,r,n,a])}}),i._wmsExtended=!0}},i.prototype._hasTileLevels=function(){return!!this.tileInfo&&(!!this.tileInfo.lods&&this.tileInfo.lods.length>0)},i.prototype.applyCatalogLayersChange=function(e){var t=this,i=!1,r=[];if(this.id==e.mapServiceId){for(var s=0;s<e.entries.length;s++){var a=e.entries[s],o=this.findLayerById(a.id);o||(o=new n.Layer(this.url+"/layers/"+e.entries[s].id),e.entries[s].visible=!0,o.createFromDefinition(e.entries[s]),o.isUserCreated=!0,o.includeInLayerList=!0,o.setInActiveTheme(!0)),r.push(o)}var l=this.layers.filter(function(e){return e.isUserCreated&&r.indexOf(e)<0}),c=r.filter(function(e){return t.layers.indexOf(e)<0});return l.forEach(function(e){t.remove(e),i=!0}),c.forEach(function(e){t.add(e),i=!0}),i?(dojo.publish("MapServiceLayersChangedWithResultEvent",{mapService:this,newItems:[].concat(c),oldItems:[].concat(l)}),dojo.publish("CatalogLayersChangedEvent",this),c):[]}},i.prototype.getLayerThemeSettings=function(e){for(var t=0;t<this.layerThemeSettings.length;t++){var i=this.layerThemeSettings[t];if(i.theme===e||i.theme.id===e)return i}return null},i.prototype.getFeatureLayer=function(){var e=this;if(this._featureLayerPromise)return this._featureLayerPromise;var t;if(this.serviceLayer instanceof esri.layers.FeatureLayer)t=this.serviceLayer;else{if(this.mapServiceType!==r.MapServiceType.IMAGE)return Promise.resolve(null);var i=this.serviceUrl;this.serviceToken&&(i=d.RestHelperHTTPService.appendTokenToUrl(i,this.serviceToken)),t=new esri.layers.FeatureLayer(i)}return t.loaded?this._featureLayerPromise=Promise.resolve(t):this._featureLayerPromise=new Promise(function(i,r){var n=t.on("load",function(){n.remove(),s.remove(),i(t)}),s=t.on("error",function(t){n.remove(),s.remove(),e._featureLayerPromise=null,r(t)})}),this._featureLayerPromise},i.prototype._resetUpdateTimer=function(){if(void 0!=this.updateInterval&&0!=this.updateInterval){void 0!=this._updateIntervalId&&window.clearInterval(this._updateIntervalId);var e=this;this._updateIntervalId=setInterval(function(){e._onUpdateIntervalTick()},1e3*this.updateInterval)}else window.clearInterval(this._updateIntervalId),this._updateIntervalId=null},i.prototype._onUpdateIntervalTick=function(){if(this.serviceLayer&&this.serviceLayer.refresh){var e=this;e.serviceLayer.setDisableClientCaching?(e.serviceLayer.setDisableClientCaching(!0),e.serviceLayer.refresh(),e.serviceLayer.setDisableClientCaching(e.disableClientCaching)):e.serviceLayer.refresh()}},i.prototype._addToFilteredView=function(e){e&&this._layerThemeLayerFilter(e)&&this.layersFilteredView.push(e)},i.prototype._layerThemeLayerFilter=function(e){return!e.mapService.essentialsMap.layerThemesInfo.layerThemesConfigured||e.inActiveTheme},i.prototype._getDefaultGeometryServiceUrl=function(){var e=this.essentialsMap?this.essentialsMap.site:null,t=e&&e.geometryEndpoints&&e.geometryEndpoints.length>0?e.geometryEndpoints[0].geometryServiceUrl:null;return t},i.prototype._getDefaultGeometryServiceToken=function(){var e=this.essentialsMap?this.essentialsMap.site:null;return e&&e.geometryEndpoints&&e.geometryEndpoints.length>0?e.geometryEndpoints[0].geometryServiceToken:null},i.prototype._corsRequest=function(t,i,r){var n=this;return new m.SimplePromise(function(s,a){try{e(["dojo/request"],function(e){i=!!i,r=!!r;var o=e(t,{headers:{"X-Requested-With":null},withCredentials:i});return o.response.then(function(e){return s()},function(e){return r?a(e):s(n._corsRequest(t,!i,!0))})})}catch(o){return console.log("Error in initializing WMS layer: "+o),a(o)}})},i}(i.AsyncInitializable);g._wmsExtended=!1,t.MapService=g})},"geocortex/essentials/BaseMapService":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(e){if(this.mapService=null,!e)throw new Error("Map service is required for a basemap service.");this.mapService=e}return e}();t.BaseMapService=i})},"geocortex/essentials/BaseMap":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(e){if(this.displayName=null,this.essentialsMap=null,this.extensions=[],this.id=null,this.iconUri=null,this.exportTilesMapServiceUri=null,this.properties={},this.services=[],!e)throw new Error("Essentials map is required for a basemap.");this.essentialsMap=e}return e}();t.BaseMap=i})},"geocortex/essentials/ExportMapImageOptions":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(e,t){void 0===t&&(t="Png"),this.defaultOutputFormat=t,this.allowIncludeGeoreferenceData=e}return e}();t.ExportMapImageOptions=i})},"geocortex/essentials/DistanceUnit":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(e,t){this.name=e,this.type=t}return e.prototype.isLinear=function(){return!(this.type===r.DEGREES||this.type===r.RADIANS||this.type===r.GRADS||this.type===r.OTHER)},e}();t.DistanceUnit=i;var r;!function(e){e.OTHER="Other",e.INCHES="Inches",e.FEET="Feet",e.US_SURVEY_FEET="USSurveyFeet",e.YARDS="Yards",e.MILES="Miles",e.NAUTICAL_MILES="NauticalMiles",e.MILLIMETERS="Millimeters",e.CENTIMETERS="Centimeters",e.DECIMETERS="Decimeters",e.METERS="Meters",e.KILOMETERS="Kilometers",e.DEGREES="Degrees",e.RADIANS="Radians",e.GRADS="Grads"}(r=t.DistanceUnitType||(t.DistanceUnitType={}))})},"geocortex/essentials/ExtentManager":function(){define(["require","exports"],function(e,t){"use strict";var i;!function(e){e[e.NONE=-1]="NONE",e[e.RESIZE=0]="RESIZE",e[e.REPOSITION=1]="REPOSITION",e[e.EXTENT_CHANGE=2]="EXTENT_CHANGE"}(i||(i={}));var r=function(){function e(e,t){this._map=null,this._currentExtentChangePriority=-1,this._queuedExtentChangePriority=-1,this._queuedExtentChange=[],this._extentChangeInProgress=!1,this._fitTiledMapsToExtent=!1,this._newLayers=[],this._initialExtent=null,this.currentExtentChangeHandle=null,this._firstMapResizeExecuted=!1,this._map=e,this._fitTiledMapsToExtent=!!t,this._fitTiledMapsToExtent&&console.log("The fitTiledMapsToExtent parameter is active. When true, for maps that contain tiled map service layers, you are guaranteed to have the input extent shown completely on the map."),this._map.on("resize",dojo.hitch(this,this._onResize)),this._map.on("reposition",dojo.hitch(this,this._onReposition))}return e.prototype.setInitialExtent=function(e){var t=this;this._map&&this._map.loaded?this._setInitialExtentImpl(e):this._map.on("load",function(){return t._setInitialExtentImpl(e)})},e.prototype._setInitialExtentImpl=function(e){this._initialExtent=e;var t=esri.config.defaults.map.panDuration;esri.config.defaults.map.panDuration=0,this._map.reposition(),this._map.setExtent(e,this._fitTiledMapsToExtent),esri.config.defaults.map.panDuration=t,this._firstMapResizeExecuted=!0},e.prototype._onResize=function(e,t,i){return this._firstMapResizeExecuted?void this._handleNextExtentChange():(this._firstMapResizeExecuted=!0,void this.firstResize())},e.prototype._onReposition=function(e,t){this._handleNextExtentChange()},e.prototype._onExtentChange=function(){this._extentChangeInProgress&&(this._currentExtentChangePriority=-1,this._extentChangeInProgress=!1,this._handleNextExtentChange())},e.prototype.registerLayer=function(e){this._hasLoaded()||this._newLayers.push(e)},e.prototype.firstResize=function(){var e=1.75;this._initialExtent&&this._map.extent&&!this._fitTiledMapsToExtent&&!this._map.extent.expand(e).contains(this._initialExtent)&&console.log("The 'fitTiledMapsToExtent' parameter may need to be set to true in configuration for the initial extent to be shown completely on the map."),this._handleNextExtentChange()},e.prototype._handleNextExtentChange=function(){if(this._hasLoaded())if(null!==this._queuedExtentChange[i.RESIZE]&&"undefined"!=typeof this._queuedExtentChange[i.RESIZE]){var e=this._queuedExtentChange[i.RESIZE];this._queuedExtentChange[i.RESIZE]=null,e(this._map)}else if(null!==this._queuedExtentChange[i.REPOSITION]&&"undefined"!=typeof this._queuedExtentChange[i.REPOSITION]){var t=this._queuedExtentChange[i.REPOSITION];this._queuedExtentChange[i.REPOSITION]=null,t(this._map)}else if(null!==this._queuedExtentChange[i.EXTENT_CHANGE]&&"undefined"!=typeof this._queuedExtentChange[i.EXTENT_CHANGE]){this._extentChangeInProgress=!0,this._currentExtentChangePriority=this._queuedExtentChangePriority,this._queuedExtentChangePriority=-1;var r=this._queuedExtentChange[i.EXTENT_CHANGE];this._queuedExtentChange[i.EXTENT_CHANGE]=null,r(this._map)}},e.prototype.changeExtentWithPriority=function(e,t){var r=this,n="undefined"!=typeof t?t:5,s=function(t){null!==r.currentExtentChangeHandle&&r.currentExtentChangeHandle.cancel(),r.currentExtentChangeHandle=e(t),r.currentExtentChangeHandle.then(dojo.hitch(r,r._onExtentChange),dojo.hitch(r,r._onExtentChange))};if(this._isExtentChangeBlocked()){if(n<this._queuedExtentChangePriority)return;this._queuedExtentChangePriority=n,this._queuedExtentChange[i.EXTENT_CHANGE]=s}else{if(n<this._currentExtentChangePriority)return;this._currentExtentChangePriority=n,this._extentChangeInProgress=!0,s(this._map)}},e.prototype.setExtentWithPriority=function(e,t){var i=this;this.changeExtentWithPriority(function(t){return t.setExtent(e,i._fitTiledMapsToExtent)},t)},e.prototype.centerAtWithPriority=function(e,t){this.changeExtentWithPriority(function(t){var i=t.extent.getCenter(),r=t.extent.getWidth()/t.width,n=t.extent.getHeight()/t.height;if(e&&(Math.abs(i.x-e.x)>=r||Math.abs(i.y-e.y)>=n))return t.centerAt(e);var s=new dojo.Deferred;return s.resolve(),s},t)},e.prototype.setScaleWithPriority=function(e,t){this.changeExtentWithPriority(function(t){if(e!==t.getScale())return t.setScale(e);var i=new dojo.Deferred;return i.resolve(),i},t)},e.prototype.blockForResize=function(e,t,r){e===this._map.width&&t===this._map.height||(this._isResizeBlocked()?this._queuedExtentChange[i.RESIZE]=function(e){e.position.update(0,0),e.resize(r)}:(this._map.position.update(0,0),this._map.resize(r)))},e.prototype.blockForReposition=function(){this._isRepositionBlocked()?this._queuedExtentChange[i.REPOSITION]=function(e){e.position.update(0,0),e.resize()}:(this._map.position.update(0,0),this._map.resize())},e.prototype._isExtentChangeBlocked=function(){return null!=this._queuedExtentChange[i.REPOSITION]||null!=this._queuedExtentChange[i.RESIZE]||!this._hasLoaded()},e.prototype._isRepositionBlocked=function(){return this._extentChangeInProgress||!this._hasLoaded()},e.prototype._isResizeBlocked=function(){return this._isRepositionBlocked()},e.prototype._hasLoaded=function(){return this._map&&this._map.loaded&&this._firstMapResizeExecuted},e}();t.ExtentManager=r})},"geocortex/essentials/XmlUtils":function(){define(["require","exports"],function(e,t){"use strict";function i(e){if(e)try{if(3===e.nodeType||4===e.nodeType){var t=String.prototype.trim?e.nodeValue.trim():dojo.string.trim(e.nodeValue);return 0===t.length?null:t}if(1===e.nodeType){var r={},n=0;dojo.forEach(e.attributes,function(e){r[e.nodeName]=e.nodeValue});var s=e.childNodes;return dojo.forEach(s,function(e){var t=i(e);t&&(n++,r[e.nodeName]?(dojo.isArray(r[e.nodeName])===!1&&(r[e.nodeName]=[r[e.nodeName]]),r[e.nodeName].push(t)):r[e.nodeName]=t)}),1===n&&r["#text"]?r["#text"]:1===n&&r["#cdata-section"]?r["#cdata-section"]:r}}catch(a){throw new Error("Unable to parse XML object: "+a.toString())}return null}function r(e){var t=new dojo.NodeList;if(dojo.isIE)for(var i=e.childNodes,r=0;r<i.length;r++)t.push(i[r]);else t=dojo.query("*",e);return t}function n(e,t,i){var r=new dojo.NodeList;if(dojo.isIE){var n=i.getElementsByTagName(e);dojo.forEach(n,function(e,i,n){var s=e.getElementsByTagName(t);dojo.forEach(s,function(e,t,i){r.push(e)})})}else r=dojo.query(e+" > "+t,i);return r}function s(e,t){if(e){var i=e;if(dojo.isString(e)){var r=e.split(" > "),n=this.getNodes(r[0],r[1],t);i=n[0]}return i.firstChild&&i.firstChild.nodeValue?i.firstChild.nodeValue:"Node not valid"}return"No Value"}function a(e,t){if(e){if(dojo.isIE){for(var i=0;i<e.attributes.length;i++)if(e.attributes[i].nodeName==t)return e.attributes[i].nodeValue;return null}return e.getAttribute(t)}return"No Value"}t.parseObject=i,t.getAllNodes=r,t.getNodes=n,t.getValue=s,t.getAttribute=a})},"geocortex/essentials/GeoRssLayerService":function(){define(["require","exports","geocortex/essentials/MapService","geocortex/essentials/RestHelper","geocortex/essentials/XmlUtils","geocortex/essentials/RestHelperHTTPService"],function(e,t,i,r,n,s){"use strict";var a=function(e){function t(t){var i=e.call(this,t)||this;return i._colorSet=!1,i._layerLoadCompleted=null,i.color=null,i.feedUrl=null,i.feedImageUri=null,i.updateInterval=null,i.pictureSymbol=null,i.markerSymbol=null,i.geoRssLayer=null,i.mapSpatialReference=null,i.geometryService=null,i}return __extends(t,e),t.prototype._configureObject=function(i,r){if(void 0===i)throw new Error("Incorrect map service object returned from initialization");t.webMercatorSref=new esri.SpatialReference({wkid:102100}),t.wgs84Sref=new esri.SpatialReference({wkid:4326}),this.feedImageUri=i.feedImageUri,this.updateInterval=i.updateInterval,this.geoRssLayer=new esri.layers.GraphicsLayer({opacity:i.opacity,id:i.id,visible:i.visible}),dojo.connect(this.geoRssLayer,"onError",this,this._layerLoadErrorHandler),i.color&&(this.color=i.color,this._colorSet=!0,this.color.length>3&&(this.color[3]=this.color[3]/255)),e.prototype._configureObject.call(this,i,r),this.attributionDataUrl&&""!==this.attributionDataUrl?(this.geoRssLayer.attributionDataUrl=this.attributionDataUrl,this.geoRssLayer.hasAttributionData=!0):this.hasAttributionData&&(this.geoRssLayer.attributionDataUrl=this.url+"/Attribution",this.geoRssLayer.hasAttributionData=!0)},t.prototype._createServiceLayer=function(){var e=this,t=null;if(this.essentialsMap&&(t=this.essentialsMap.site,this.mapSpatialReference=this.essentialsMap.initialExtent.spatialReference),this.feedImageUri?(this.feedImageUri=r.RestHelper.processClientSideTokens(t,this.feedImageUri),this.pictureSymbol=new esri.symbol.PictureMarkerSymbol(this.feedImageUri,25,25)):this.markerSymbol=new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE,15,new esri.symbol.SimpleLineSymbol,new esri.Color(this.color)),this.feedUrl=this.serviceUrl,this._loadFeed(),this.updateInterval&&!isNaN(this.updateInterval)){this._layerLoadCompleted=!1;var i=setInterval(function(){e._layerLoadCompleted&&e._loadFeed(),e._layerLoadCompleted=!1},1e3*this.updateInterval);dojo.connect(window,"onunload",function(){clearInterval(i)})}this.serviceLayer=this.geoRssLayer},t.prototype._loadFeed=function(){esri.config.defaults.io.proxyUrl&&esri.request({url:this.serviceUrl,content:{},handleAs:"xml",load:dojo.hitch(this,this._handleFeed),error:function(e){e&&e.message&&"string"==typeof e.message&&alert(e.message)}})},t.prototype._handleFeed=function(e){var t="http://www.georss.org/georss",i="http://www.w3.org/2003/01/geo/wgs84_pos#",r=this._getFeedRoot(e);if(r){var s=r.nodeName,a=n.getAttribute(r,"xml:base"),o=[],l=null;if("feed"===s?l=n.getNodes("feed","entry",e):"rdf"===s?l=n.getNodes("rdf","item",e):"rss"===s&&(l=n.getNodes("channel","item",e)),l){var c=this.pictureSymbol||this.markerSymbol;l.forEach(dojo.hitch(this,function(e,r,l){var u,p,h,d=null,f=n.getAllNodes(e);if(f.forEach(dojo.hitch(this,function(e,r,o){e.nodeName&&("title"===e.nodeName&&(u=e.firstChild.nodeValue),"feed"===s?"summary"===e.nodeName&&(h=e.firstChild.nodeValue):"description"===e.nodeName&&(h=e.firstChild.nodeValue),"link"===e.nodeName&&(p="feed"===s?(a||"")+n.getAttribute(e,"href"):(a||"")+e.firstChild.nodeValue),("georss:where"===e.nodeName||"where"===e.nodeName&&e.namespaceURI===t)&&(d=this._getGMLGRSSPoint(e)),("georss:point"===e.nodeName||"point"===e.nodeName&&e.namespaceURI===t)&&(d=this._getSimpleGRSSPoint(e)),("geo:lat"===e.nodeName||"lat"===e.nodeName&&e.namespaceURI===i)&&(d=this._getW3CGRSSPoint(e)))})),d){var y={title:u,content:h,link:p};o.push(new esri.Graphic(d,c,y,null))}})),this.mapSpatialReference&&this._projectShapes(o,this.mapSpatialReference)}}},t.prototype._projectShapes=function(e,i){if(e&&i){for(var r=!1,n=t.webMercatorSref.wkid,a=t.wgs84Sref.wkid,o=0;o<e.length;o++){var l=e[o],c=null;l.geometry&&l.geometry.spatialReference.wkid!==i.wkid&&(i.wkid===n&&l.geometry.spatialReference.wkid===a?c=esri.geometry.geographicToWebMercator(l.geometry):i.wkid===a&&l.geometry.spatialReference.wkid===n?c=esri.geometry.webMercatorToGeographic(l.geometry):(c=esri.geometry.geographicToWebMercator(l.geometry),r=!0),l.geometry=c)}if(r){var u=[],p=this.geometryServiceUrl||this._getDefaultGeometryServiceUrl(),h=this.geometryServiceUrl?null:this._getDefaultGeometryServiceToken();null!==h&&(p=s.RestHelperHTTPService.appendTokenToUrl(p,h)),this.geometryService=new esri.tasks.GeometryService(p),dojo.forEach(e,function(e){u.push(e.geometry)});var d=new esri.tasks.ProjectParameters;return d.geometries=u,d.outSR=i,void this.geometryService.project(d,dojo.hitch(this,function(t){for(var i=0;i<t.length;i++)e[i].geometry=t[i];this._publishLayer(e)}),this._projectionError)}}this._publishLayer(e)},t.prototype._publishLayer=function(e){if(this.geoRssLayer){this.geoRssLayer.clear(),dojo.forEach(e,dojo.hitch(this,function(e){this.geoRssLayer.add(e)})),this.geoRssLayer.redraw();var t={esriLayer:this.geoRssLayer};dojo.publish("geoRssLayerLoaded",[t]),this._layerLoadCompleted=!0}},t.prototype._projectionError=function(e){},t.prototype._getSimpleGRSSPoint=function(e){var i=e.firstChild.nodeValue,r=i.split(" ");return new esri.geometry.Point(parseFloat(r[1]),parseFloat(r[0]),t.wgs84Sref)},t.prototype._getGMLGRSSPoint=function(e){var i=this._getNonTextNodeChild(e),r=this._getNonTextNodeChild(i),n=r.firstChild.nodeValue,s=n.split(" ");return new esri.geometry.Point(parseFloat(s[1]),parseFloat(s[0]),t.wgs84Sref)},t.prototype._getNonTextNodeChild=function(e){for(var t=e.childNodes,i=0;i<t.length;i++)if(3!==t[i].nodeType)return t[i]},t.prototype._getW3CGRSSPoint=function(e){if(!e.nextSibling)return null;var i=e.nextSibling;"#text"===e.nextSibling.nodeName&&(i=e.nextSibling.nextSibling);var r=e.firstChild.nodeValue,n=i.firstChild.nodeValue;return new esri.geometry.Point(parseFloat(n),parseFloat(r),t.wgs84Sref)},t.prototype._getFeedRoot=function(e){if(!e)throw new Error("The GeoRSS service at "+this.feedUrl+" returned an invalid response.");for(var t=e.childNodes,i=0;i<t.length;i++)if(t[i]){var r=t[i].nodeName,n=r.substring(0,3);if("xml"!==n)return t[i]}return null},t}(i.MapService);a.webMercatorSref=null,a.wgs84Sref=null,t.GeoRssLayerService=a})},"geocortex/essentials/KmlService":function(){define(["require","exports","geocortex/essentials/MapService"],function(e,t,i){"use strict";var r=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.updateInterval=null,t.serviceLayer=null,t.mapSpatialReference=null,t}return __extends(t,e),t.prototype._configureObject=function(t,i){if(void 0===t)throw new Error("Incorrect map service object returned from initialization");this.updateInterval=t.updateInterval,e.prototype._configureObject.call(this,t,i)},t.prototype._createServiceLayer=function(){var e=this,t=null;this.essentialsMap&&(t=this.essentialsMap.site,this.mapSpatialReference=this.essentialsMap.initialExtent.spatialReference);var i={id:this.id,outSR:this.mapSpatialReference};this.serviceLayer=new esri.layers.KMLLayer(this.serviceUrl,i),this._initiallyVisible?this.serviceLayer.show():this.serviceLayer.hide(),this.serviceLayer._options=i,this.attributionDataUrl&&""!==this.attributionDataUrl?(this.serviceLayer.attributionDataUrl=this.attributionDataUrl,
this.serviceLayer.hasAttributionData=!0):this.hasAttributionData&&(this.serviceLayer.attributionDataUrl=this.url+"/Attribution",this.serviceLayer.hasAttributionData=!0);var r=this.serviceLayer.on("load",function(t){r.remove(),e.serviceLayer.setOpacity(e.configuredOpacity),e._initializeKmlLayers()});this.serviceLayer.on("error",function(t){return e._layerLoadErrorHandler(t)}),this.serviceLayer.setOpacity(this.configuredOpacity),this.updateInterval&&!isNaN(this.updateInterval)&&this.serviceLayer.setRefreshInterval(this.updateInterval)},t.prototype._updateStartHandler=function(){this._initializeKmlLayers()},t.prototype._initializeKmlLayers=function(){for(var e=this.serviceLayer.getLayers(),t=0;t<e.length;t++)if(e[t]instanceof esri.layers.FeatureLayer){var i=e[t];i.layerId=+this.id,i.name=this.displayName,i.displayField="name",e[t].spatialReference=this.mapSpatialReference}},t}(i.MapService);t.KmlService=r})},"geocortex/essentials/StreamLayerService":function(){define(["require","exports","geocortex/essentials/MapService","geocortex/essentials/RestHelperHTTPService"],function(e,t,i,r){"use strict";var n=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._streamLayerOptions=null,t}return __extends(t,e),t.prototype._configureStreamSettings=function(e){if(e){var t={purgeOptions:{displayCount:1e4}};null!=e.maxDisplayCount&&(t.purgeOptions.displayCount=e.maxDisplayCount),null!=e.maxAge&&(t.purgeOptions.maxAge=e.maxAge),null!=e.maxTrackPoints&&(t.maximumTrackPoints=e.maxTrackPoints),e.definitionExpression&&(t.definitionExpression=e.definitionExpression),e.geometryDefinition&&(t.geometryDefinition=new esri.geometry.Extent(e.geometryDefinition)),this._streamLayerOptions=t}},t.prototype._configureObject=function(t,i){if(void 0===t)throw new Error("Incorrect map service object returned from initialization");this._configureStreamSettings(t.streamSettings),e.prototype._configureObject.call(this,t,i)},t.prototype._createServiceLayer=function(){var t=this.serviceUrl;this.serviceToken&&(t=r.RestHelperHTTPService.appendTokenToUrl(t,this.serviceToken));var i=new esri.layers.StreamLayer(t,this._streamLayerOptions);i.id=this.id,i.loadError&&this._layerLoadErrorHandler(i.loadError),this._initiallyVisible?i.show():i.hide(),dojo.connect(i,"onError",this,this._layerLoadErrorHandler),dojo.connect(i,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded)),this.attributionDataUrl&&""!==this.attributionDataUrl?(i.attributionDataUrl=this.attributionDataUrl,i.hasAttributionData=!0):this.hasAttributionData&&(i.attributionDataUrl=this.url+"/Attribution",i.hasAttributionData=!0),this.serviceLayer=i,e.prototype.initiateServiceFailureTimer.call(this)},t}(i.MapService);t.StreamLayerService=n})},"geocortex/essentials/WFSLayerService":function(){define(["require","exports","geocortex/essentials/MapService","geocortex/essentials/RestHelperHTTPService"],function(e,t,i,r){"use strict";var n=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._WFSLayerOptions=null,t._defaultMaxFeaturesInOnDemandMode=100,t._defaultMaxFeaturesInSnapshotMode=500,t._defaultWFSLayerMode="snapshot",t}return __extends(t,e),t.prototype._configureWFSSettings=function(e){var t=this.serviceUrl.indexOf("?");if(this.baseUrl=t>-1?this.serviceUrl.substring(0,t):this.serviceUrl,this.layers.length<1||!this.layers[0].wfsLayerName)throw new Error("Failed to initialize WFS layer. Layer name or layer not defined.");var i=this.layers[0].wfsLayerName.split(":")[1],r={url:this.baseUrl,name:i,layerName:i,mode:this._defaultWFSLayerMode,swapXY:!1,swapXYFilter:!1,version:"1.0.0"};e&&(e.version&&(r.version=e.version),e.spatialReference&&(r.wkid=e.spatialReference.wkid),e.mode&&(r.mode=e.mode),e.customParameters&&(r.customParameters=e.customParameters),e.infoTemplate&&(r.infoTemplate=e.infoTemplate)),e.maxFeatures?r.maxFeatures=e.maxFeatures:r.maxFeatures=r.mode===this._defaultWFSLayerMode?this._defaultMaxFeaturesInSnapshotMode:this._defaultMaxFeaturesInOnDemandMode,this._WFSLayerOptions=r},t.prototype._configureObject=function(t,i){if(void 0===t)throw new Error("Incorrect map service object returned from initialization");this._restWFSConfigObject=t,e.prototype._configureObject.call(this,t,i)},t.prototype._createServiceLayer=function(){var t=this;this._configureWFSSettings(this._restWFSConfigObject),this.serviceToken&&(this._WFSLayerOptions.url=r.RestHelperHTTPService.appendTokenToUrl(this.serviceUrl,this.serviceToken));var i=new esri.layers.WFSLayer(this._WFSLayerOptions);i.id=this.id,this.serviceLayer=i,dojo.connect(i,"onError",dojo.hitch(this,this._layerLoadErrorHandler)),dojo.connect(i,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded)),i.initialize(this._WFSLayerOptions,function(e){i.selectLayer(t._WFSLayerOptions,function(e){t._initiallyVisible&&t.layers[0].configuredVisible?i.show():i.hide(),t.attributionDataUrl&&""!==t.attributionDataUrl?(i.attributionDataUrl=t.attributionDataUrl,i.hasAttributionData=!0):t.hasAttributionData&&(i.attributionDataUrl=t.url+"/Attribution",i.hasAttributionData=!0),i.onLoad(i)})}),e.prototype.initiateServiceFailureTimer.call(this)},t}(i.MapService);t.WFSLayerService=n})},"geocortex/essentials/Map":function(){define(["require","exports","geocortex/essentials/AsyncInitializable","geocortex/essentials/BaseMap","geocortex/essentials/MapService","geocortex/essentials/LayerThemesInfo","geocortex/essentials/ExportMapImageOptions","geocortex/essentials/DistanceUnit","geocortex/essentials/ExtentManager","geocortex/essentials/utilities/UrlUtilities","geocortex/essentials/MapServiceConstants","geocortex/essentials/FeatureLayerService","geocortex/framework/utils/utils","geocortex/essentials/GeoRssLayerService","geocortex/essentials/KmlService","geocortex/essentials/StreamLayerService","geocortex/essentials/WFSLayerService","geocortex/essentials/exportMap/ExportMapTask","geocortex/essentials/exportMap/ExportMapParameters","geocortex/essentials/catalog/LayerCatalogDetail","geocortex/essentials/LayerTheme","geocortex/essentials/RestHelper","geocortex/geocortex","geocortex/essentials/BaseMapService","geocortex/essentials/RestHelperHTTPService"],function(e,t,i,r,n,s,a,o,l,c,u,p,h,d,f,y,m,g,v,S,x,b,I,w,E){"use strict";var _=function(e){function t(t){var i=e.call(this,t)||this;return i.baseMaps=[],i.fullExtent=null,i.initialExtent=null,i.fitTiledMapsToExtent=!1,i.mapServices=[],i.mapServicesFilteredView=[],i.layerThemesInfo=null,i.primaryMapService=null,i.supportedExportFormats=["BMP","JPEG","PNG","TIFF","GeoTIFF","PDF"],i.exportMapImageOptions=null,i.units=null,i.serviceLayersAdded=!1,i.extentManager=null,i.spatialReference=null,i.setExtentOnLoad=!0,i._esriMap=null,i._onExportComplete=null,i._onExportError=null,i._suspendedLayers=[],i.originalUrl=t,i.url=c.UrlUtilities.simplify(t),i.layerThemesInfo=new s.LayerThemesInfo(i),i}return __extends(t,e),t.prototype.getMap=function(){return this._esriMap},t.prototype.allLayers=function(){for(var e=[],t=0;t<this.mapServices.length;t++)for(var i=this.mapServices[t],r=0;r<i.layers.length;r++)e.push(i.layers[r]);return e},t.prototype.allTables=function(){for(var e=[],t=0;t<this.mapServices.length;t++)for(var i=this.mapServices[t],r=0;r<i.tables.length;r++)e.push(i.tables[r]);return e},t.prototype.allLayersAndTables=function(){var e=[];return e=this.allLayers(),e=this.allTables().reduce(function(e,t){return e.push(t),e},e)},t.prototype.filteredLayers=function(){for(var e=[],t=0;t<this.mapServices.length;t++){var i=this.mapServices[t];this._layerThemeMapServiceFilter(i)&&(e=e.concat(i.layers))}return e},t.prototype.loadServiceLayersInMap=function(e){if(!e)throw new Error("Must supply a map");this._esriMap=e,this.fitTiledMapsToExtent=!!e._fitTiledMapsToExtent,this.extentManager=new l.ExtentManager(e,this.fitTiledMapsToExtent);for(var t=0;t<this.mapServices.length;t++){var i=this.mapServices[t],r=i.serviceLayer;r&&(this.extentManager.registerLayer(r),r.loaded||i.failureTimeoutThresholdExceeded?(this._layerLoadedUpdate(e),i._handleServiceLayerLoaded(r),i._handleDynamicLayers(r)):(dojo.connect(i,"onFailureTimeoutThresholdExceeded",dojo.hitch(this,this._layerLoadedUpdate,e)),dojo.connect(r,"onLoad",dojo.hitch(this,this._layerLoadedUpdate,e)),dojo.connect(r,"onError",dojo.hitch(this,this._layerLoadedUpdate,e))))}},t.prototype.calculateScale=function(){return esri.geometry.getScale(this.site.getMap())},t.prototype._addServiceLayers=function(e){for(var t=this.site&&this.site.suspendLayersOnLoad,i=this.mapServices.length-1;i>=0;i--){var r=this.mapServices[i].serviceLayer;t&&(r.suspend(),this._suspendedLayers.push(r)),e.addLayer(r)}this.setExtentOnLoad&&this.initialExtent&&this.extentManager.setInitialExtent(this.initialExtent),this.site&&dojo.isObject(this.site)&&(this.site.serviceLayersLoaded=!0,dojo.isFunction(this.site.onServiceLayersLoaded)&&this.site.onServiceLayersLoaded(this.site))},t.prototype.addServiceLayers=function(e,t){var i=this,r=this;if(e||e.length){for(var s=[],a=function(e){var i=null,a=!1,o=u.MapServiceType.FEATURE;switch(e.opacity=e.opacity||1,e.type){case"Feature Layer":i=new p.FeatureLayerService(e.url);break;default:switch(e.declaredClass){case"esri.layers.WebTiledLayer":i=new n.MapService(e.tileServers[0]),o=u.MapServiceType.WEBTILED,a=!0}}if(i){i.serviceLayer=e,i.essentialsMap=r;var l=e.layerId||h.alphaNumericToken(),c={id:l,isExpanded:!0,includeInLayerList:a,serviceFunction:t,serviceType:o,layerOptions:null};c.layerOptions={id:l,name:e.name,description:e.description,displayField:e.displayField,includeInLayerList:!0,identifiable:!0,fullExtent:e.fullExtent,primaryKeyField:e.objectIdField,visible:e.visible},i._createFrom(c),s.push(i),dojo.connect(e,"onClick",function(e){dojo.publish("FeatureClickedEvent",dojo.mixin(e,{layer:i.layers[0],useFeaturePresenter:!0}))})}},o=0;o<e.length;++o){var l=e[o];if(l.getFeatureLayers){var c=l,d=c.getFeatureLayers();if(d&&d.length>0){dojo.forEach(d,function(e){e.name=e.name||c.name,a(e)});continue}}a(l)}this.mapServices=this.mapServices.concat(s),dojo.forEach(s,function(e){return i._addToFilteredView(e)}),this._addServiceLayers(this.getMap()),dojo.forEach(s,function(e){dojo.publish("MapServiceAddedEvent",e)})}},t.prototype.removeServiceLayer=function(e){if(e&&this.mapServices.length)for(var t=0;t<this.mapServices.length;t++){var i=this.mapServices[t];if(i&&i.serviceLayer&&i.serviceLayer===e){this.mapServices.splice(t,1),dojo.publish("MapServiceRemovedEvent",i);break}}},t.prototype.resumeSuspendedLayers=function(){this._suspendedLayers.forEach(function(e){e.resume()}),this._suspendedLayers=[]},t.prototype.addMapService=function(e){var t=this.getMap(),i=this.site;e.isUserCreated=!0,e.includeInLayerList=!(e instanceof p.FeatureLayerService),e.opacity=1;for(var r=0,n=e.layers;r<n.length;r++){var s=n[r];s.isUserCreated=!0,s.includeInLayerList=!0,s.includeInLegend=!0,s.site=i,s.configuredVisible=!0,e.supportsLayerVisibility()?s.setVisibility(!0):s._visible=!0}e.essentialsMap=this,this.mapServices.push(e),t.addLayer(e.serviceLayer),dojo.publish("MapServiceAddedEvent",e),e.setVisibility(!0)},t.prototype.removeMapService=function(e){if(e){var t=this.mapServices.indexOf(e);t>=0&&(this.mapServices.splice(t,1),dojo.publish("MapServiceRemovedEvent",e)),this._esriMap&&e.serviceLayer&&this._esriMap.removeLayer(e.serviceLayer)}},t.prototype._configureMapServices=function(e,t){for(var i=0;e&&i<e.length;i++){var r=e[i],s=this.originalUrl+"/mapservices/"+r.id;if(r.drawingBehavior==u.DrawingBehavior.FEATURE_LAYER){if(!dojo.isObject(esri.layers.FeatureLayer))throw new Error("This Javascript application must require the esri.layers.FeatureLayer package in order to use a site with feature layers");this.mapServices[i]=new p.FeatureLayerService(s)}else if(r.drawingBehavior==u.DrawingBehavior.GEORSS_LAYER){if(!dojo.isObject(esri.layers.GraphicsLayer))throw new Error("This Javascript application must require the esri.layers.GraphicsLayer package in order to use a site with GeoRSS layers");this.mapServices[i]=new d.GeoRssLayerService(s)}else if(r.drawingBehavior==u.DrawingBehavior.KML_SERVICE){if(!dojo.isObject(esri.layers.KMLLayer))throw new Error("This Javascript application must require the esri.layers.KMLLayer package in order to use a site with KML layers");this.mapServices[i]=new f.KmlService(s)}else if(r.drawingBehavior==u.DrawingBehavior.STREAM_LAYER){if(!dojo.isObject(esri.layers.StreamLayer))throw new Error("This Javascript application must require the esri.layers.StreamLayer package in order to use a site with stream layers");this.mapServices[i]=new y.StreamLayerService(s)}else if(r.drawingBehavior==u.DrawingBehavior.WFS_LAYER){if(!dojo.isObject(esri.layers.WFSLayer))throw new Error("This Javascript application must require the esri.layers.WFSLayer package in order to use a site with WFS layers");this.mapServices[i]=new m.WFSLayerService(s),this.mapServices[i].mapServiceType=u.MapServiceType.WFS}else this.mapServices[i]=new n.MapService(s);this.mapServices[i].essentialsMap=this,this.mapServices[i].initialize(r),dojo.publish("ServiceLayerInitializedEvent",this.mapServices[i].serviceLayer),this._addToFilteredView(this.mapServices[i])}},t.prototype._configureObject=function(e,t){if(void 0===e||void 0===e.mapServices)throw new Error("Incorrect map object returned from initialization");e.initialExtent&&(this.initialExtent=new esri.geometry.Extent(e.initialExtent)),e.fullExtent&&(this.fullExtent=new esri.geometry.Extent(e.fullExtent)),e.units&&(this.units=new o.DistanceUnit(e.units.name,e.units.type)),e.exportOptions&&(this.exportMapImageOptions=new a.ExportMapImageOptions(e.exportOptions.allowIncludeGeoreferenceData,e.exportOptions.defaultOutputFormat)),e.layerThemes&&(e.layerThemes.items&&e.layerThemes.items.length||e.layerThemes.allowDefault)&&this._configureLayerThemesInfo(e.layerThemes),this._configureMapServices(e.mapServices,t),dojo.isArray(e.baseMaps)&&this._configureBaseMaps(e.baseMaps),t&&(this.isInitialized=!0),this.primaryMapService=this.findMapServiceById(e.primaryMapServiceID)},t.prototype.findMapServiceById=function(e){for(var t=0;t<this.mapServices.length;t++)if(this.mapServices[t].id==e)return this.mapServices[t];return null},t.prototype.setFeatureLayerExclusivelyVisible=function(e){for(var t=this.site.getFeatureServices(),i=0;i<t.length;i++){var r=t[i];r.setVisibility(r.serviceLayer.id===e.id)}},t.prototype.exportMap=function(e,t,i){var r=this;this._onExportComplete=t,this._onExportError=i;var n=new g.ExportMapTask(this),s=new v.ExportMapParameters;s.reportParameters=e,n.generateMapImageUrl(s).then(function(e){return r._exportRestComplete(e)},function(e){return r._exportRestError(e)})},t.prototype.findLayerFromMatchingEsriFeatureLayer=function(e){if(e){for(var t=0;t<this.mapServices.length;t++){var i=this.mapServices[t];if(i.serviceLayer instanceof esri.layers.FeatureLayer){var r=i.serviceLayer;if(r.layerId==e.layerId&&r.name==e.name&&i.layers.length>0)return i.layers[0]}}for(var n=function(e,t){var i=e.serviceUrl;return e.serviceToken&&t.search(/token=.[^&]*/g)>0&&(i=E.RestHelperHTTPService.appendTokenToUrl(i,e.serviceToken)),i},s=e.url.match(/.[^?]*/g)[0],t=0;t<this.mapServices.length;t++){var i=this.mapServices[t],a=n(i,s);if(a===s&&i.layers.length>0)return i.layers[0]}for(var o=new RegExp("[^/]*.$"),l=Number(s.match(o)),c=new RegExp("/[^/]*.$"),u=s.replace(c,""),t=0;t<this.mapServices.length;t++){var i=this.mapServices[t],a=n(i,u);if(a===u){var p=i.findLayerOrTableById(l.toString());if(p)return p;if(i.layers.length>=l)return i.layers[l]}}return null}},t.prototype._exportRestComplete=function(e){var t=null;e?e.error&&(t=e.error):t=new Error("No results"),t&&this._onExportComplete&&this._onExportError(t),e&&this._onExportComplete&&this._onExportComplete(e)},t.prototype._exportRestError=function(e){this._onExportError&&this._onExportError(e)},t.prototype._layerLoadedUpdate=function(e){if(!this.serviceLayersAdded){for(var t=0;t<this.mapServices.length;t++){var i=this.mapServices[t],r=i.serviceLayer;if(!i.initializationFailure&&i.failureTimeoutThresholdExceeded&&(i.initializationFailure=new Error("Map Service - {0}: Failure timeout threshold exceeded.".format(i.id))),!r.loaded&&!i.initializationFailure&&!i.failureTimeoutThresholdExceeded)return}this.serviceLayersAdded=!0,this.spatialReference=this.primaryMapService.serviceLayer.spatialReference,this.spatialReference&&this.spatialReference.wkt&&this._switchSpatialReferenceGlobally(this.spatialReference),this._esriMap.spatialReference||(this._esriMap.spatialReference=this.spatialReference||this.initialExtent.spatialReference||this.fullExtent.spatialReference),!this._esriMap.extent&&this.initialExtent&&this._esriMap.setExtent(new esri.geometry.Extent(this.initialExtent.toJson())),this._addServiceLayers(e)}},t.prototype.applyCatalogLayersChange=function(e){e&&(this._applyCatalogChangesToDynamicLayers(e),this._applyCatalogChangesToWmsLayers(e))},t.prototype.applyStartupTheme=function(){this.layerThemesInfo.layerThemesConfigured&&this.layerThemesInfo.applyTheme(this.layerThemesInfo.startupThemeId||this.layerThemesInfo.themes[0].id)},t.prototype.refreshFilteredCollections=function(){var e=this;this.mapServicesFilteredView.length=0,dojo.forEach(this.mapServices,function(t){return e._addToFilteredView(t)});for(var t=0;t<this.mapServices.length;t++)this.mapServices[t].refreshFilteredCollections()},t.prototype._switchSpatialReferenceGlobally=function(e){if(this.initialExtent&&(this.initialExtent=new esri.geometry.Extent(this.initialExtent.xmin,this.initialExtent.ymin,this.initialExtent.xmax,this.initialExtent.ymax,e)),this.fullExtent&&(this.fullExtent=new esri.geometry.Extent(this.fullExtent.xmin,this.fullExtent.ymin,this.fullExtent.xmax,this.fullExtent.ymax,e)),this.site.hasNamedExtents&&this.site.namedExtents&&this.site.namedExtents.length)for(var t=0;t<this.site.namedExtents.length;t++){var i=this.site.namedExtents[t];i.extent=new esri.geometry.Extent(i.extent.xmin,i.extent.ymin,i.extent.xmax,i.extent.ymax,e)}this._esriMap.spatialReference=e},t.prototype._applyCatalogChangesToWmsLayers=function(e){},t.prototype._applyCatalogChangesToDynamicLayers=function(e){var t=e.mapServiceId,i=[],r=new S.LayerCatalogDetail;r.mapServiceId=t;for(var n=0;n<e.entries.length;n++)e.entries[n].isDynamic&&i.push(e.entries[n]);r.entries=i;var s=this.findMapServiceById(t);s&&s.applyCatalogLayersChange(r)},t.prototype._configureLayerThemesInfo=function(e){var t=this;if(!e)throw new Error("RestLayerThemesInfo object not defined. Cannot configure layer themes.");this.layerThemesInfo.layerThemesConfigured=!0,this.layerThemesInfo.allowDefault=void 0==e.allowDefault||e.allowDefault,this.layerThemesInfo.startupThemeId=e.startupThemeID,this.layerThemesInfo.allowDefault&&this.layerThemesInfo.themes.push(new x.LayerTheme(this.layerThemesInfo,null,e.defaultThemeDisplayName||"")),e.items&&e.items.length&&dojo.forEach(e.items,function(e){t.layerThemesInfo.themes.push(new x.LayerTheme(t.layerThemesInfo,e))})},t.prototype._addToFilteredView=function(e){e&&this._layerThemeMapServiceFilter(e)&&this.mapServicesFilteredView.push(e)},t.prototype._layerThemeMapServiceFilter=function(e){return!e.essentialsMap.layerThemesInfo.layerThemesConfigured||e.inActiveTheme},t.prototype._configureBaseMaps=function(e){var t=this;e.forEach(function(e){var i=new r.BaseMap(t);i.displayName=e.displayName,i.id=e.id,e.iconUri&&(i.iconUri=b.RestHelper.processClientSideTokens(t.site,e.iconUri)),e.exportTilesMapServiceUri&&(i.exportTilesMapServiceUri=b.RestHelper.processClientSideTokens(t.site,e.exportTilesMapServiceUri)),i.properties=I._getProperties(e.properties),i.extensions=I._getExtensions(e.extensions),dojo.isArray(e.mapServices)&&e.mapServices.forEach(function(e){var r=t.findMapServiceById(e.id);r&&i.services.push(new w.BaseMapService(r))}),t.baseMaps.push(i)})},t}(i.AsyncInitializable);t.Map=_})},"geocortex/essentials/GeocodingEndpoint":function(){define(["require","exports","geocortex/geocortex","geocortex/essentials/AsyncInitializable","geocortex/essentials/ServiceHelper"],function(e,t,i,r,n){"use strict";var s=function(e){function t(t){var i=e.call(this,t)||this;return i.bingProperties=null,i.displayName=null,i.extensions=[],i.id=null,i.properties={},i.geocoderType=null,i.geocoderUrl=null,i.geocoderToken=null,i.includeInGlobalSearch=!1,i.iconUri=null,i.featureZoomScale=null,i.isDefaultReverseGeocoder=!1,i.site=null,i.parameters=[],i.globalSearchKey=null,i.isDefaultBatchGeocoder=!1,i}return __extends(t,e),t.prototype._configureObject=function(e){if(!(e.hasOwnProperty("id")&&e.hasOwnProperty("displayName")&&e.hasOwnProperty("serviceType")&&e.hasOwnProperty("connectionString")&&e.hasOwnProperty("globalSearchKey")&&e.hasOwnProperty("parameters")))throw new Error("Incorrect geocoding endpoint object returned from initialization");this.id=e.id,this.displayName=e.displayName,this.iconUri=e.iconUri,this.featureZoomScale=e.featureZoomScale,this.geocoderType=e.serviceType,this.includeInGlobalSearch=e.includeInGlobalSearch,this.isDefaultReverseGeocoder=e.isDefaultReverseGeocoder,this.globalSearchKey=e.globalSearchKey,this.isDefaultBatchGeocoder=e.isDefaultBatchGeocoder,this._processConnectionString(e.connectionString),this.properties=i._getProperties(e.properties),this.extensions=i._getExtensions(e.extensions),this.parameters=e.parameters},t.prototype._processConnectionString=function(e){var t=n.ServiceHelper.extractConnectionStringValue;if(this.geocoderType===a.BING_GEOCODER){this.bingProperties={};var i=t(e,"key");i&&i.length>0&&(this.bingProperties.bingMapsKey=i),i=t(e,"culture"),i&&i.length>0&&(this.bingProperties.culture=i)}else if(this.geocoderType===a.ARCGIS_GEOCODER){var r=t(e,"url");r&&r.length>0&&(this.geocoderUrl=r),this.geocoderToken=t(e,"token")}else console.error("Unknown geocoder type '"+this.geocoderType+"'")},t}(r.AsyncInitializable);t.GeocodingEndpoint=s;var a;!function(e){e.ARCGIS_GEOCODER="ArcGisGeocoder",e.BING_GEOCODER="BingGeocoder"}(a=t.GeocodingEndpointType||(t.GeocodingEndpointType={}))})},"geocortex/essentials/GeometryEndpoint":function(){define(["require","exports","geocortex/essentials/AsyncInitializable","geocortex/geocortex","geocortex/essentials/ServiceHelper"],function(e,t,i,r,n){"use strict";var s=function(e){function t(t){var i=e.call(this,t)||this;return i.displayName=null,i.extensions=[],i.id=null,i.properties={},i.geometryServiceType=null,i.geometryServiceUrl=null,i.geometryServiceToken=null,i.site=null,i}return __extends(t,e),t.prototype._configureObject=function(e){if(void 0===e.id||void 0===e.displayName||void 0===e.connectionString)throw new Error("Incorrect geometry endpoint object returned from initialization");this.id=e.id,this.displayName=e.displayName,this.geometryServiceType=e.serviceType,this._processConnectionString(e.connectionString),this.properties=r._getProperties(e.properties),this.extensions=r._getExtensions(e.extensions)},t.prototype._processConnectionString=function(e){var t=n.ServiceHelper.extractConnectionStringValue;if(this.geometryServiceType===a.ARCGIS_GEOMETRY){var i=t(e,"url");i&&i.length>0&&(this.geometryServiceUrl=i),this.geometryServiceToken=t(e,"token")}else console.error("Unknown geometry service type '"+this.geometryServiceType+"'")},t}(i.AsyncInitializable);t.GeometryEndpoint=s;var a;!function(e){e.ARCGIS_GEOMETRY="ArcGisGeometry"}(a=t.GeometryEndpointType||(t.GeometryEndpointType={}))})},"geocortex/essentials/GeoprocessingEndpoint":function(){define(["require","exports","geocortex/essentials/AsyncInitializable","geocortex/geocortex","geocortex/essentials/ServiceHelper"],function(e,t,i,r,n){"use strict";var s=function(e){function t(t){var i=e.call(this,t)||this;return i.displayName=null,i.extensions=[],i.id=null,i.properties={},i.geoprocessorType=null,i.geoprocessorUrl=null,i.site=null,i}return __extends(t,e),t.prototype._configureObject=function(e){if(void 0===e.id||void 0===e.displayName||void 0===e.connectionString)throw new Error("Incorrect geoprocessing endpoint object returned from initialization");this.id=e.id,this.displayName=e.displayName,this.geoprocessorType=e.geoprocessorType||e.serviceType,this._processConnectionString(e.connectionString),this.properties=r._getProperties(e.properties),this.extensions=r._getExtensions(e.extensions)},t.prototype._processConnectionString=function(e){var t=n.ServiceHelper.extractConnectionStringValue;if(this.geoprocessorType!==a.ARCGIS_GEOPROCESSOR)throw new Error("Unknown geoprocessor type '"+this.geoprocessorType+"'");var i=t(e,"url");i&&i.length>0&&(this.geoprocessorUrl=i)},t}(i.AsyncInitializable);t.GeoprocessingEndpoint=s;var a;!function(e){e.ARCGIS_GEOPROCESSOR="ArcGisGeoprocessor"}(a=t.GeoprocessingEndpointType||(t.GeoprocessingEndpointType={}))})},"geocortex/essentials/NamedExtent":function(){define(["require","exports","geocortex/essentials/AsyncInitializable","geocortex/geocortex"],function(e,t,i,r){"use strict";var n=function(e){function t(t){var i=e.call(this,t)||this;return i.displayName=null,i.extensions=[],i.extent=null,i.id=null,i.properties={},i.site=null,i}return __extends(t,e),t.prototype.navigateTo=function(){if(this.site){var e=this.site.essentialsMap;e&&e.extentManager.setExtentWithPriority(this.extent,10)}},t.prototype._configureObject=function(e,t){if(void 0===e||void 0===e.id||void 0==e.displayName||void 0===e.extent)throw new Error("Incorrect named extent object returned from initialization");this.id=e.id,this.displayName=e.displayName,this.extent=new esri.geometry.Extent(e.extent),this.properties=r._getProperties(e.properties),this.extensions=r._getExtensions(e.extensions)},t}(i.AsyncInitializable);t.NamedExtent=n})},"geocortex/essentials/TimeSliderMode":function(){define(["require","exports"],function(e,t){"use strict";var i;!function(e){e[e.Extent=0]="Extent",e[e.Cumulative=1]="Cumulative",e[e.Instant=2]="Instant"}(i=t.TimeSliderMode||(t.TimeSliderMode={}))})},"geocortex/essentials/TimeSliderProfile":function(){define(["require","exports","geocortex/essentials/AsyncInitializable","geocortex/essentials/TimeSliderMode","geocortex/essentials/TimeUnits","geocortex/essentials/utilities/StringUtilities","geocortex/geocortex"],function(e,t,i,r,n,s,a){"use strict";var o=function(e){function t(t){return e.call(this,t)||this}return __extends(t,e),t.prototype._configureObject=function(e,t){this.id=e.id,this.displayName=e.displayName,this.description=e.description,this.mode=r.TimeSliderMode[e.mode],this.displayFormat=e.displayFormat,this.timeExtent={startTime:s.StringUtilities.getDateFromRestDateString(e.startTime),endTime:s.StringUtilities.getDateFromRestDateString(e.endTime)},this.initialTimeExtent={startTime:s.StringUtilities.getDateFromRestDateString(e.initialStartTime),endTime:s.StringUtilities.getDateFromRestDateString(e.initialEndTime)},this.timeInterval=e.timeInterval,this.timeIntervalUnit=n.EssentialsTimeUnits[e.timeIntervalUnit],this.snapToTimeIntervals=e.snapToTimeIntervals,this.properties=a._getProperties(e.properties),this.extensions=a._getExtensions(e.extensions)},t}(i.AsyncInitializable);t.TimeSliderProfile=o})},"geocortex/essentials/LayerCatalog":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(e){this.siteId=e}return e}();t.LayerCatalog=i})},"geocortex/essentials/SearchTableParameter":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(){this.name=null,this.type=null}return e}();t.SearchTableParameter=i})},"geocortex/essentials/SearchTable":function(){define(["require","exports","geocortex/essentials/AsyncInitializable","geocortex/essentials/RestHelper","geocortex/geocortex"],function(e,t,i,r,n){"use strict";var s=function(e){function t(t){var i=e.call(this,t)||this;return i.displayName=null,i.parameters=[],i.id=null,i.site=null,i.featureDescription=null,i.featureLabel=null,i.featureLongDescription=null,i.iconUri=null,i.includeInGlobalSearch=!1,i._searching=!1,i._onSearchingComplete=null,i._onSearchingError=null,i}return __extends(t,e),t.prototype._configureObject=function(e,t){if(void 0===e||void 0===e.id||void 0==e.displayName)throw new Error("Incorrect search table object returned from initialization");this.id=e.id,this.displayName=e.displayName,this.parameters=e.parameters,this.featureDescription=e.featureDescription,this.featureLabel=e.featureLabel,this.featureLongDescription=e.featureLongDescription,this.iconUri=r.RestHelper.processClientSideTokens(this.site,e.iconUri),this.includeInGlobalSearch=e.includeInGlobalSearch},t.prototype.isSearching=function(){return this._searching},t.prototype.performSearch=function(e,t,i){var r=this,s=function(e){r._searching=!1,i&&i(new Error(e))};e||s("No searchParameters provided"),this.isSearching()&&s("Currently performing a search"),this._searching=!0,this._onSearchingComplete=dojo.hitch(this,t),this._onSearchingError=dojo.hitch(this,i);var a=this.url+"/search",o="";for(var l in e)e.hasOwnProperty(l)&&(o+=(o?"&":"")+encodeURIComponent(l)+"="+encodeURIComponent(e[l]));a+="?"+o,n.request({url:a,content:{f:"json"},handleAs:"json",load:dojo.hitch(this,this._searchRestComplete),error:dojo.hitch(this,this._searchRestError),callbackParamName:"CallBack"})},t.prototype._searchRestComplete=function(e){this._searching=!1,!e&&this._onSearchingError&&this._onSearchingError(new Error("No results")),e.error&&this._onSearchingError&&this._onSearchingError(e.error),this._onSearchingComplete&&this._onSearchingComplete(new esri.tasks.FeatureSet(e))},t.prototype._searchRestError=function(e){this._searching=!1,this._onSearchingError&&this._onSearchingError(e)},t}(i.AsyncInitializable);t.SearchTable=s})},"geocortex/essentials/SearchQuery":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(){this.extent=null,this.maxResults=50,this.contains=!0,this.returnGeometry=!1,this.returnHighlights=!1,this.returnIdsOnly=!1,this.returnCountOnly=!1,this.searchText=null,this.outSpatialReference=null}return e.prototype.toJson=function(e,t){if(!e||!t)throw new Error("Search query parameter creation is missing a main map.");var i={searchText:this.searchText,contains:this.contains,returnGeometry:this.returnGeometry,returnHighlights:this.returnHighlights,returnIdsOnly:this.returnIdsOnly,returnCountOnly:this.returnCountOnly};this.extent&&(i.envelope="{0},{1},{2},{3}".format(this.extent.xmin,this.extent.ymin,this.extent.xmax,this.extent.ymax)),(this.returnGeometry||this.extent)&&this.outSpatialReference&&(i.outSR=this.outSpatialReference.toJson()),this.maxResults>0&&(i.maxResults=this.maxResults);var r=this.searchLayers;return r&&0!=r.length||(r=t.allLayers()),i.layers=this._getServiceStrings(r),i},e.prototype._getServiceStrings=function(e){for(var t="",i={},r=0;r<e.length;r++){var n=e[r];if(n&&n.searchable&&n.mapService&&n.mapService.instantSearch){var s=n.mapService.id;i.hasOwnProperty(s)||(i[s]=[]),i[s].push(n.id)}}for(var a in i)i.hasOwnProperty(a)&&(t+=0===t.length?"":";",t+="{0}(include:{1})".format(a,i[a].join(",")));return t},e}();t.SearchQuery=i})},"geocortex/essentials/SearchResultFeature":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(e,t){this.esriFeature=null,this.layer=null,this.highlights={},this.esriFeature=e,this.layer=t}return e}();t.SearchResultFeature=i})},"geocortex/essentials/SearchResultSet":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(e){this.features=[],this.layer=null,e&&e.hasOwnProperty("features")&&(this.features=e.features),e&&e.hasOwnProperty("layer")&&(this.layer=e.layer)}return e}();t.SearchResultSet=i})},"geocortex/essentials/SearchResults":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(){this.error=null,this.results=[],this.queryParams=null}return e}();t.SearchResults=i})},"geocortex/essentials/catalog/LayerCatalogParams":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(){}return e}();t.LayerCatalogParams=i})},"geocortex/essentials/catalog/LayerCatalogDetailsParams":function(){
define(["require","exports"],function(e,t){"use strict";var i=function(){function e(){this.ids=null,this.ids=[]}return e}();t.LayerCatalogDetailsParams=i})},"geocortex/essentials/OfflineBasemap":function(){define(["require","exports"],function(e,t){"use strict"})},"geocortex/essentials/SecurityHelper":function(){define(["require","exports","geocortex/geocortex"],function(e,t,i){"use strict";var r=function(){function e(){var e=this;this.finished=!1,this.id=(new Date).valueOf().toString(),this.scripts=[],this._refreshPromise=new Promise(function(t,i){e._refreshPromiseResolve=t,e._refreshPromiseReject=i})}return e.getCurrent=function(){var e=window.security;return e&&!e.finished?e:null},e.beginRefresh=function(t){if(null!=e.getCurrent())return!1;var i=new e;return i.site=t,!!i.getExpirationNoticeUrl()&&(!!i.getRefreshUrl()&&(window.security=i,i.openFrame(),!0))},e.waitForSignIn=function(){var t=e.getCurrent();return t?t._refreshPromise:Promise.resolve()},e.cancel=function(){var t=e.getCurrent();return t&&(t._refreshPromise.isFulfilled||t._refreshPromiseReject("Canceled")),t&&t.finish()},e.prototype.openSystemBrowser=function(){var e=this,t=this.getRefreshUrl()+"&app="+this.site.signInRedirectUri+"&token_type=fragment&openSystemBrowser=true",i=/GeocortexApp\.iOS/.test(navigator.userAgent)?"_system":"_blank",r=function(){var t=location.hash;if(t.length>0&&t.startsWith("#gcx-")){window.removeEventListener?window.removeEventListener("popstate",r,!1):window.detachEvent&&window.detachEvent("onpopstate",r);var i=t.substring(5);e.sendRequest(e.site.url+"?f=json&callback=security.updateSitePrincipal&token="+i)}};window.addEventListener?window.addEventListener("popstate",r,!1):window.attachEvent&&window.attachEvent("onpopstate",r),window.open(t,i)},e.prototype.openFrame=function(){var e=this;this.frame=document.createElement("iframe"),this.frame.name="SignInHelper",this.frame.style.display="none",document.body.appendChild(this.frame);var t=i.isNative();t?(this.frame.src="SignInHelper.html",window.setTimeout(function(){e.finished||e.openSystemBrowser()},1e4)):(window.open("SignInHelper.html","SignInHelper"),window.setTimeout(function(){return e.openPopup()},15e3))},e.prototype.openPopup=function(){this.finished||(this.sendRequest(this.getExpirationNoticeUrl()+"?f=json&part=_html&callback=security.showContent"),window.open("SignInHelper.html","_blank"))},e.prototype.getExpirationNoticeUrl=function(){return this.site.principal&&this.site.principal.urls?this.site.principal.urls.expirationNotice:null},e.prototype.getRefreshUrl=function(){return this.site.principal&&this.site.principal.urls?this.site.principal.urls.refresh:null},e.prototype.sendRequest=function(e){if(!this.finished){var t=document.createElement("script");t.style.display="none",document.body.appendChild(t),this.scripts.push(t),t.type="text/javascript",t.src=e+"&rid="+this.id}},e.prototype.showContent=function(e){return!this.finished&&(e.rid==this.id&&(this.dialog&&this.dialog.parentNode&&this.dialog.parentNode.removeChild(this.dialog),this.dialog=document.createElement("div"),this.dialog.innerHTML=e.content,document.body.appendChild(this.dialog),!0))},e.prototype.handleSignIn=function(e,t){if(this.finished)return null;if(!(e.length>0&&e.startsWith("#gcx-"))){var i="";return null==this.site.principal.urls.referrer&&(i="&app="+encodeURIComponent(t)),this.getRefreshUrl()+i+"&token_type=fragment"}var r=e.substring(5);return this.sendRequest(this.site.url+"?f=json&callback=security.updateSitePrincipal&token="+r),null},e.prototype.finish=function(){if(this.finished)return!1;for(this.finished=!0;this.scripts.length>0;){var e=this.scripts.pop();e.parentNode.removeChild(e)}return this.dialog&&this.dialog.parentNode&&this.dialog.parentNode.removeChild(this.dialog),this.frame&&this.frame.parentNode&&this.frame.parentNode.removeChild(this.frame),!0},e.prototype.updateSitePrincipal=function(e){return this.finished?(this._refreshPromise.isResolved||this._refreshPromiseResolve(),!1):e.rid==this.id&&(this.finish(),this.site.updatePrincipal(e.principal),this._refreshPromiseResolve(),console.log("Updated Principal (Refresh Successful)"),!0)},e.prototype.useSystemBrowser=function(){return!1},e.prototype.waitForSignIn=function(){return this._refreshPromise},e}();t.SecurityHelper=r})},"geocortex/essentials/utilities/LayerUtilities":function(){define(["require","exports","geocortex/framework/utils/utils"],function(e,t,i){"use strict";var r=function(){function e(){}return e.createFeatureLayerFromCsv=function(e,t){var r=new dojo.Deferred;if(!e)return r.resolve(null),r;var n=new dojox.data.CsvStore({url:e.url,separator:e.columnDelimiter||","});return n.fetch({onComplete:function(s,a){var o,l,c=0,u=e.layerDefinition,p={layerDefinition:u,featureSet:{features:[],geometryType:"esriGeometryPoint"}},h=null,d=null;t&&(h=t.lowerBound||0,d=t.upperBound||s.length),(h||d)&&(s=s.slice(h,d)),dojo.forEach(s,function(t,i){0===i&&e.locationInfo&&(o=e.locationInfo.latitudeFieldName,l=e.locationInfo.longitudeFieldName);var r=(n.getIdentity(t),n.getAttributes(t)),s={};dojo.forEach(r,function(e){var i=Number(n.getValue(t,e));isNaN(i)?s[e]=n.getValue(t,e):s[e]=i}),s.__OBJECTID=c,c++;var a=parseFloat(s[o]),u=parseFloat(s[l]);if(!isNaN(a)&&!isNaN(u)){var h=new esri.geometry.Point(u,a),d={geometry:h.toJson(),attributes:s};p.featureSet.features.push(d)}});var f=new esri.layers.FeatureLayer(p),y=null;u&&u.drawingInfo&&u.drawingInfo.renderer&&u.drawingInfo.renderer.symbol&&"esriPMS"===u.drawingInfo.renderer.symbol.type&&(y=u.drawingInfo.renderer.symbol),null!=y&&(f.renderer.symbol.imageData=y.imageData,f.renderer.symbol.url=y.url),e.title&&(f.name=e.title),f.layerId=e.id||i.alphaNumericToken(),r.resolve(f)}}),r},e.decomposeFeatureLayerUrl=function(e){var t=/(.+?)\/([0-9]*)(\?.*)?$/g.exec(e);return{serviceUrl:t[1],layerId:parseInt(t[2]),queryString:t[3]}},e}();t.LayerUtilities=r})},"geocortex/essentials/WebMapReference":function(){define(["require","exports","geocortex/essentials/AsyncInitializable","geocortex/essentials/utilities/LayerUtilities","geocortex/essentials/GeoRssLayerService","geocortex/essentials/MapServiceConstants","geocortex/framework/utils/utils"],function(e,t,i,r,n,s,a){"use strict";var o=function(e){function t(t){var i=e.call(this,t)||this;return i.displayName=null,i.id=null,i._isLoading=!1,i._onLoadingComplete=null,i._onLoadingError=null,i._layerTypes=null,i._arcgisSharingRegularExpressions=[new RegExp("(https?://.*?/)home/item.html\\?id=(\\w*)"),new RegExp("(https?://.*?/)home/webmap/viewer.html\\?webmap=(\\w*)"),new RegExp("(https?://.*?/)explorer/\\?open=(\\w*)"),new RegExp("(https?://.*?/sharing)/content/items/(\\w*)/data"),new RegExp("(https?://.*?/sharing)/content/items/(\\w*)")],i.site=null,i}return __extends(t,e),t.prototype.isLoading=function(){return this._isLoading},t.prototype._getUrlPortions=function(e){for(var t={id:null,path:null},i=0;i<this._arcgisSharingRegularExpressions.length;++i){var r=this._arcgisSharingRegularExpressions[i],n=e.match(r);if(n&&n.length>0){t.id=n[2],t.path=n[1];break}}return t},t.prototype._loadWebMap=function(e,t,i){var r=this;if(e&&e.path){if(!esri.arcgis||!esri.arcgis.Portal)return;var n=new esri.arcgis.Portal(e.path);n.on("ready",function(t){if(t){var n={q:"id:"+e.id};t.queryItems(n).then(function(e){if(e){var t=e.results[0],n=esri.request({url:t.itemDataUrl});n.then(function(e){r._processItemData(e),i.resolve(!1)})}})}})}else{var s="Web map with address "+t+" cannot be loaded.",a=esri.urlToObject(t);if(a.query=a.query||{},a.query&&(a.query.webmap||a.query.id)){var o,l=a.query.webmap||a.query.id;esri.arcgis&&esri.arcgis.utils?o=esri.arcgis.utils.getItem:esri.arcgis.getItem&&(o=esri.arcgis.getItem),o&&o(l).then(function(e){e?this._processItemData(e.itemData):this._onLoadingError(new Error(s)),i.resolve(!1)})}else this._onLoadingError(new Error(s)),i.resolve(!1)}},t.prototype._initializeWebMap=function(e,t,i,r){var n=this;if(this.isLoading())return void(r&&r(new Error("Currently loading web map.")));this._isLoading=!0;var s=new dojo.Deferred;this._onLoadingComplete=dojo.hitch(this,i),this._onLoadingError=dojo.hitch(this,r),this._layerTypes=this.site.webMapsInfo.layerTypes;var a=this._getUrlPortions(e.url);this._loadWebMap(a,e.url,s),s.then(function(e){n._isLoading=e})},t.prototype._processItemData=function(e){if(e){var t=e.operationalLayers;t&&this._processLayerCollection(t,"Operational");var i=e.baseMap.baseMapLayers;i&&this._processLayerCollection(i,"Base")}},t.prototype._processLayerCollection=function(e,t){var i=this;if(e){for(var r=[],n=0;n<e.length;++n){var s=e[n];if(!this._layerTypes||!(!s.type&&this._layerTypes.indexOf("Null")>=0||s.type&&this._layerTypes.indexOf(s.type)>=0)){var a=this._addLayerToMap(s);r.push(a)}}var o=new dojo.DeferredList(r);o.then(function(e){if(e){for(var r=[],n=0;n<e.length;++n){var s=e[n][1];s&&(s.length>0?r=r.concat(s):r.push(s))}r.length>0&&i.site.essentialsMap.addServiceLayers(r,t)}},function(e){i._onLoadingError(new Error("There was an error loading a layer: "+e))})}},t.prototype._addLayerToMap=function(e){var t=new dojo.Deferred,i=null;this.site.getMap();switch(e.type){case"CSV":var o=new dojo._Url(window.location.href),l=new dojo._Url(e.url);o.host===l.host&&o.port===l.port&&o.scheme===l.scheme||(e.url=esri.config.defaults.io.proxyUrl+e.url);var c=r.LayerUtilities.createFeatureLayerFromCsv(e,null);c.then(function(i){i&&i.setVisibility&&i.setVisibility(e.visibility),t.resolve(i)},function(e){t.reject(e)});break;case"GeoRSS":var u=new n.GeoRssLayerService(e.url);u.essentialsMap=this.site.essentialsMap;var p={displayName:e.title,serviceType:s.MapServiceType.GEORSS,connectionString:"url="+e.url,feedImageUri:e.pointSymbol?e.pointSymbol.url:null,opacity:e.opacity,id:e.id||a.alphaNumericToken(),visible:e.visibility};u._configureObject(p),t.resolve(u);break;case"WebTiledLayer":if(!e.wmtsInfo&&esri.layers&&esri.layers.WebTiledLayer){var h={id:e.id,subDomains:e.subDomains,copyright:e.copyright};i=new esri.layers.WebTiledLayer(e.templateUrl,h),e.title&&(i.name=e.title)}t.resolve(i);break;case"WMS":t.resolve(null);break;default:var d=null;e.url||e.featureCollection&&(d=this._addFeatureCollectionToMap(e.featureCollection)),t.resolve(d)}return t.promise},t.prototype._addFeatureCollectionToMap=function(e){var t=this.site.getMap(),i=[];return dojo.forEach(e.layers,function(e){var r=new esri.layers.FeatureLayer(e,{outSR:t.spatialReference});r.layerId=a.alphaNumericToken(),i.push(r)}),i},t.prototype._loadingRestComplete=function(e){this._isLoading=!1,!e&&this._onLoadingError&&this._onLoadingError(new Error("No results")),e.error&&this._onLoadingError&&this._onLoadingError(e.error),this._onLoadingComplete&&this._onLoadingComplete(e.results)},t.prototype._loadingRestError=function(e){this._isLoading=!1,this._onLoadingError&&this._onLoadingError(e)},t.prototype._configureObject=function(e,t){if(void 0===e||void 0===e.id)throw new Error("Incorrect Web Map reference object returned from initialization");this.displayName=e.displayName,this.id=e.id,t&&(this.isInitialized=!0),this._initializeWebMap(e,this.site,function(e){},function(e){throw e})},t}(i.AsyncInitializable);t.WebMapReference=o})},"geocortex/essentials/Site":function(){define(["require","exports","geocortex/essentials/AsyncInitializable","geocortex/essentials/ArcGisPortalSecurityContext","geocortex/essentials/documents/DocumentStore","geocortex/essentials/Map","geocortex/essentials/GeocodingEndpoint","geocortex/essentials/GeometryEndpoint","geocortex/essentials/GeoprocessingEndpoint","geocortex/essentials/NamedExtent","geocortex/essentials/PrintTemplate","geocortex/essentials/TimeSliderProfile","geocortex/essentials/LayerCatalog","geocortex/essentials/Workflow","geocortex/essentials/SearchTable","geocortex/essentials/utilities/UrlUtilities","geocortex/essentials/utilities/SiteResourceIdComparer","geocortex/essentials/FeatureLayerService","geocortex/framework/utils/ArrayUtils","geocortex/essentials/SearchResults","geocortex/geocortex","geocortex/essentials/SearchResultSet","geocortex/essentials/SearchResultFeature","geocortex/essentials/ServiceHelper","geocortex/essentials/MapServiceConstants","geocortex/essentials/RestHelperHTTPService","geocortex/essentials/SecurityHelper","geocortex/framework/utils/utils","geocortex/essentials/OAuth2Client","geocortex/essentials/WebMapReference","geocortex/geocortex"],function(e,t,i,r,n,s,a,o,l,c,u,p,h,d,f,y,m,g,v,S,x,b,I,w,E,_,T,L,D,C,R){"use strict";var F=function(e){function t(t,i){var r=e.call(this,t)||this;return r.currentVersion=null,r.dataProvider=null,r.deepInitialize=!1,r.displayName=null,r.documentStore=new n.DocumentStore,r.updateInterval=null,r.essentialsMap=null,r.extensions=[],r.geocodingEndpoints=[],r.geometryEndpoints=[],r.geoprocessingEndpoints=[],r.layerListRestEndpoint=null,r.hasGeocodingEndpoints=!1,r.hasGeometryEndpoints=!1,r.hasGeoprocessingEndpoints=!1,r.hasNamedExtents=!1,r.hasNorthArrow=!1,r.hasTimeSliders=!1,r.hasOverviewMap=!1,r.hasPrintTemplates=!1,r.hasViewers=!1,r.hasVirtualDirectory=!1,r.hasWorkflows=!1,r.hasSearchTables=!1,r.hasWebMaps=!1,r.id=null,r.namedExtents=[],r.overviewMap=null,r.printTemplates=[],r.properties={},r.timeSliders=[],r.trustedUrls=[],r.layerCatalogs=[],r.serviceLayersLoaded=!1,r.url=null,r.workflows=[],r.searchTables=[],r.timeZoneId=null,r.displayTimeZoneId=null,r.webMapsInfo={layerTypes:null,webMaps:[]},r.configPreprocessor=null,r.onLayerLoad=null,r.onLayerLoadError=null,r.onServiceLayersLoaded=function(){},r.onSignIn=null,r.onSignOut=null,r.onUserSignInCancelled=null,r.principal={isAuthenticated:!1,label:null,identities:[],policy:{},urls:{},tokens:{arcgis:{},geocortex:{},site:null}},r.suspendLayersOnLoad=!0,r._geocodingEndpointsInitialized=!1,r._geometryEndpointsInitialized=!1,r._geoprocessingEndpointsInitialized=!1,r._kmlServiceInitialized=!1,r._mapInitialized=!1,r._namedExtentsInitialized=!1,r._overviewMapInitialized=!1,r._printTemplatesInitialized=!1,r._workflowsInitialized=!1,r._searchTablesInitialized=!1,r._timeSlidersInitialized=!1,r._webMapsInitialized=!1,r._initializedHandlerCalled=!1,r._signInEnabled=!1,r._signOutEnabled=!1,r._tokenIntervalHandle=null,r._serviceTokenRefresh=null,r._serviceTokensStale=!1,r._allDeferredDojosForUpdatingTokens=new Array,r.originalUrl=t,r.url=y.UrlUtilities.simplify(t),r._esriMap=i,r}return __extends(t,e),t.prototype.initialize=function(){var e=this;this._detectAndConfigureCors().then(function(){e._initialize()})},t.prototype.getResourceById=function(e,t){return m.SiteResourceIdComparer.lookUp(e,t)},t.prototype.findWorkflowById=function(e){return this.getResourceById(this.workflows,e)},t.prototype.findPrintTemplateById=function(e){return this.getResourceById(this.printTemplates,e)},t.prototype.getFeatureServices=function(){var e=[];if(!this.essentialsMap)return e;for(var t=0;t<this.essentialsMap.mapServices.length;t++){var i=this.essentialsMap.mapServices[t];i instanceof g.FeatureLayerService&&e.push(i)}return e},t.prototype.getMap=function(){return this._esriMap},t.prototype.getEssentialsVersion=function(){var e=3;if(this.currentVersion){var t=this.currentVersion.split(".");if(t.length>=2){var i=t[0]+"."+t[1];e=parseFloat(i)}}return e},t.prototype.getDefaultBatchGeocoder=function(){var e=v.firstOrDefault(this.geocodingEndpoints,function(e){return e.isDefaultBatchGeocoder});return!e&&this.geocodingEndpoints.length>0&&(e=this.geocodingEndpoints[0]),e},t.prototype.search=function(e,t,i,r){var n=this;t&&t(e);try{var s=this.url+"/search",a={};e&&e.toJson&&(a=e.toJson(this.getMap(),this.essentialsMap));var o=x.encodeJson(dojo.mixin({f:"json"},a))}catch(l){return void(r&&r(l))}var c=function(t){var s=new S.SearchResults;s.queryParams=e,t?n._parseSearchResponse(s,t):s.error=new Error("Unexpected Error"),s.error&&r&&r(s.error),i&&i(s)},u=function(e){r&&r(e)};o.hasOwnProperty("layers")&&o.layers&&x.request({url:s,content:o,load:c,error:u,callbackParamName:"CallBack"})},t.prototype._parseSearchResponse=function(e,t){if(!t)throw new Error("_parseSearchResponse: required jsonObject argument was not supplied.");if(t.hasOwnProperty("error")&&t.error&&t.error.message)e.error=new Error(t.error.message);else if(t.hasOwnProperty("ResponseStatus")&&t.ResponseStatus&&t.ResponseStatus.ErrorCode)e.error=new Error(t.ResponseStatus.Message),e.error.name=t.ResponseStatus.ErrorCode;else if(t.hasOwnProperty("features")){var i=this._createFeatureSets(t.features,e.queryParams.returnHighlights);for(var r in i)i.hasOwnProperty(r)&&e.results.push(i[r])}},t.prototype._createFeatureSets=function(e,t){for(var i={},r=0;r<e.length;r++){var n=e[r],s=n.hasOwnProperty("mapServiceId")?n.mapServiceId:null,a=n.hasOwnProperty("layerId")?n.layerId:null,o=this.essentialsMap.findMapServiceById(s),l=o?o.findLayerOrTableById(a):null;if(l){var c=this._createFeature(n,l,t);i.hasOwnProperty(l.url)||(i[l.url]=new b.SearchResultSet({layer:l})),i[l.url].features.push(c)}}return i},t.prototype._createFeature=function(e,t,i){if(!e)throw new Error("_createSearchFeature: required jsonFeature argument was not supplied.");var r=this._jObjectToGraphic(e),n=new I.SearchResultFeature(r,t);return i&&this._assignHighlights(n,e),n},t.prototype._jObjectToGraphic=function(e){if(!e)throw new Error("_jObjectToGraphic: required jobject argument was not supplied.");var t=null;e.hasOwnProperty("geometry")&&e.geometry&&(t=esri.geometry.fromJson(e.geometry),t&&t.spatialReference&&!e.geometry.spatialReference&&(t.spatialReference=new esri.SpatialReference(4326)));var i={};return e.hasOwnProperty("attributes")&&e.attributes&&(i=JSON.parse(JSON.stringify(e.attributes))),new esri.Graphic(t,null,i,null)},t.prototype._assignHighlights=function(e,t){if(!e)throw new Error("_assignHighlights: required feature argument was not supplied.");if(!t)throw new Error("_assignHighlights: required jobject argument was not supplied.");var i={};t.hasOwnProperty("highlights")&&t.highlights&&(i=JSON.parse(JSON.stringify(t.highlights))),e.highlights=i},t.prototype._initAsyncCollection=function(e,t,i,r){if(e&&i&&r)for(var n=0;e&&n<e.length;n++)i[n]=new r(this.url+"/"+t+"/"+e[n].id),i[n].site=this,i[n]._configureObject(e[n]),this.deepInitialize===!0&&r!==d.Workflow&&(i[n].isInitialized=!0);this._siteInitializeUpdate()},t.prototype._initAsyncCollectionErrorHandler=function(e,t){e(),this._initializationFailedHandler(t),this._siteInitializeUpdate()},t.prototype._initGeocodingEndpointsHandler=function(e){this._geocodingEndpointsInitialized=!0,e&&this._initAsyncCollection(e.geocodingEndpoints,"geocoding",this.geocodingEndpoints,a.GeocodingEndpoint)},t.prototype._initGeometryEndpointsHandler=function(e){this._geometryEndpointsInitialized=!0,e&&this._initAsyncCollection(e.geometryEndpoints,"geometry",this.geometryEndpoints,o.GeometryEndpoint)},t.prototype._initKmlEndpointHandler=function(e){if(this._kmlServiceInitialized=!0,e&&e.connectionString){var t=w.ServiceHelper.extractConnectionStringValue(e.connectionString,"url");t&&(esri.config.defaults.kmlService=t)}},t.prototype.getLayerCatalog=function(e,t,i,r){var n=this.url+"/catalog/layercatalog/getcatalog";t();var s=function(e){i(e)};x.request({url:n,content:{f:"json"},load:s,error:r,callbackParamName:"CallBack"})},t.prototype.getLayerCatalogDetails=function(e,t,i,r){var n=this.url+"/catalog/layercatalog/getcatalogdetails",s={};s.ids=e.ids.join(),s.f="json",t();var a=function(e){i(e)};x.request({url:n,content:s,load:a,error:r,callbackParamName:"CallBack"})},t.prototype.getOfflineBasemaps=function(e,t){void 0===t&&(t=function(){});var i=this.url+"/offlinebasemaps";if("function"!=typeof e)throw new Error("loadComplete must be a function.");x.request({url:i,content:{f:"json"},load:function(i){i.error?t(new Error(i.error.message)):i.basemaps?e(i.basemaps):t(new Error("Unexpected result: "+JSON.stringify(i)))},error:t,callbackParamName:"CallBack"})},t.prototype._initGeoprocessingEndpointsHandler=function(e){this._geoprocessingEndpointsInitialized=!0,e&&this._initAsyncCollection(e.geoprocessingEndpoints,"geoprocessing",this.geoprocessingEndpoints,l.GeoprocessingEndpoint)},t._getTokenFromFragment=function(){var e=window.location.href,t=e.indexOf("#gcx-");if(t>=0){var i=e.substring(t+5);return window.location.replace("#"),i}return null},t._addQueryParameter=function(e,t){var i=e.split("#",2);e=i[0];var r=i.length>1?i[1]:"";return e+(e.indexOf("?")>-1?"&":"?")+t+r},t.prototype.canSignIn=function(){return this._signInEnabled&&!!this.principal&&!!this.principal.urls.signIn&&!this.principal.isAuthenticated&&!!this.principal.policy&&this.principal.policy.issuers.length>0},t.prototype._signIn=function(e,i){e||(e=this.principal),i||(i=e.urls.signIn),void 0===e.policy&&(e.policy={});var r=e.policy.hints;r&&(i=t._addQueryParameter(i,r)),i=t._addQueryParameter(i,"token_type=fragment"),this.signInRedirectUri&&i.indexOf("app=")<0?i=t._addQueryParameter(i,"app="+encodeURIComponent(this.signInRedirectUri)):!e.urls.referrer&&i.indexOf("app=")<0&&(i=t._addQueryParameter(i,"app="+encodeURIComponent(window.location.toString()))),this.onSignIn&&this.onSignIn({url:i}),window.addEventListener&&window.addEventListener("popstate",function(){location.hash.startsWith("#gcx-")&&location.reload()},!1),window.location.assign(i)},t.prototype.signIn=function(e){this._signIn(this.principal,e)},t.prototype.canSignOut=function(){return this._signOutEnabled&&!!this.principal&&this.principal.isAuthenticated&&!!this.principal.urls.signOut},t.prototype.signOut=function(){this.onSignOut&&this.onSignOut();var e=this.principal.urls.signOut;this.signOutRedirectUri?e=t._addQueryParameter(e,"app="+encodeURIComponent(this.signOutRedirectUri)):this._signOutRedirectUrl&&(e=t._addQueryParameter(e,"app="+encodeURIComponent(this._signOutRedirectUrl))),window.location.assign(e)},t.prototype.getTokenFromPrincipal=function(e,i){var r=null;if(i===E.MapServiceType.DYNAMIC?r=this.principal.tokens.arcgis:i===E.MapServiceType.FEATURE?r=this.principal.tokens.arcgis:i===E.MapServiceType.IMAGE?r=this.principal.tokens.arcgis:i===E.MapServiceType.TILED?r=this.principal.tokens.arcgis:i===E.MapServiceType.WEBTILED?r=this.principal.tokens.arcgis:i===E.MapServiceType.VECTORTILE?r=this.principal.tokens.arcgis:i===esri.IdentityManagerBase?r=this.principal.tokens.arcgis:i===t&&(p={},p[this.url]=this.principal.tokens.site,r=p),!r)return null;e=e.toLowerCase();var n=document.createElement("a");n.href=e.toLowerCase();var s=n.protocol,a=n.hostname,o=n.port;e=n.href;for(var l in r){var c=l.toLowerCase();if(a==c)return r[l];if(a.endsWith("."+c))return r[l];try{if(n.href=s+"://"+c,n.port=o,e.startsWith(n.href))return r[l]}catch(u){}try{if(n.href=c,e.startsWith(n.href))return r[l]}catch(u){}}return null;var p},t.prototype._updateDefaultToken=function(e){if("string"==typeof e){var t=this.url,i=Math.max(t.indexOf("?"),t.indexOf("#"));i>=0&&(t=t.substr(0,i)),t=/^(.*?)\/*$/.exec(t)[1],_.RestHelperHTTPService.setDefaultToken(e,t+"/../../")}},t.prototype._detectAndConfigureCors=function(){var e=new dojo.Deferred;if(window.geocortexDisableEssentialsCorsDetection)return e.resolve(),e;var t=y.UrlUtilities.getUrlComponents(this.url),i=y.UrlUtilities.getUrlComponents(window.location.href);if(t.origin===i.origin)return e.resolve(),e;var r=/(.*\/+)sites\/+[^\/]*\/?$/i.exec(this.url)||[],n=r[1];if(n){var s=n+"info?f=json";dojo.xhrGet({url:s}).then(function(i){esri.config.defaults.io.corsEnabledServers.push(t.host),e.resolve()},function(t){e.resolve()})}else e.resolve();return e},t.prototype._initialize=function(){var e=this;if(!this.isInitialized&&!this._initializing){var i=t._getTokenFromFragment();if(this._updateDefaultToken(i),!i){var r=function(){if(window.removeEventListener?window.removeEventListener("popstate",r,!1):window.detachEvent&&window.detachEvent("onpopstate",r),!e.isInitialized&&e._initializing){var i=t._getTokenFromFragment();i&&(e._updateDefaultToken(i),x.request({url:e.url,content:{f:"json",deep:e.deepInitialize},load:dojo.hitch(e,e._verifySiteDependencies),error:dojo.hitch(e,e._initSiteErrorHandler),callbackParamName:"CallBack"}))}};window.addEventListener?window.addEventListener("popstate",r,!1):window.attachEvent&&window.attachEvent("onpopstate",r)}this._initializedHandlerCalled=!1,this._initializing=!0,x.request({url:this.url,content:{f:"json",deep:this.deepInitialize},load:dojo.hitch(this,this._verifySiteDependencies),error:dojo.hitch(this,this._initSiteErrorHandler),callbackParamName:"CallBack"})}},t.prototype._initMapHandler=function(e){this._mapInitialized=!0,null!==e&&null!==e.site&&e.loadServiceLayersInMap(e.site.getMap()),this._siteInitializeUpdate()},t.prototype._initMapErrorHandler=function(e){this._mapInitialized=!0,this._initializationFailedHandler(e),this._siteInitializeUpdate()},t.prototype._initNamedExtentsHandler=function(e){this._namedExtentsInitialized=!0,e&&this._initAsyncCollection(e.namedExtents,"namedextents",this.namedExtents,c.NamedExtent)},t.prototype._initTimeSlidersHandler=function(e){this._timeSlidersInitialized=!0,e&&this._initAsyncCollection(e.timeSliders,"timesliders",this.timeSliders,p.TimeSliderProfile)},t.prototype._initOverviewMapHandler=function(){this._overviewMapInitialized=!0,this._siteInitializeUpdate()},t.prototype._initOverviewMapErrorHandler=function(e){this._overviewMapInitialized=!0,this._initializationFailedHandler(e),this._siteInitializeUpdate()},t.prototype._initPrintTemplatesHandler=function(e){var t=this,i=0;return this._printTemplatesInitialized=!0,e.printTemplates.length>0&&null!=e.printTemplates[0].visible?void this._initAsyncCollection(e.printTemplates,"printtemplates",this.printTemplates,u.PrintTemplate):void e.printTemplates.forEach(function(r){x.request({url:t.url+"/printtemplates/"+r.id,content:{f:"json"},load:function(r){i++,e.printTemplates.forEach(function(e){e.id===r.id&&(e.visible=r.visible)}),i===e.printTemplates.length&&t._initAsyncCollection(e.printTemplates,"printtemplates",t.printTemplates,u.PrintTemplate)},callbackParamName:"CallBack"})})},t.prototype.updateServiceTokensIfStale=function(){if(!this._serviceTokensStale){var e=new dojo.Deferred;return e.resolve(),e}return this._getUpdatedServiceTokens()},t.prototype._getUpdatedServiceTokens=function(){var e=this;if(0===this.updateInterval){var t=new dojo.Deferred;return t.resolve(),t}if(this._serviceTokenRefresh)return this._serviceTokenRefresh;this._serviceTokenRefresh=new dojo.Deferred,this._updateServiceTokensOfAllSites();var i=new dojo.DeferredList(this._allDeferredDojosForUpdatingTokens);return i.then(function(t){e._serviceTokensStale=!1;for(var i=0;i<t.length;i++){var r=t[i];if(!r[0]){e._serviceTokensStale=!0,e._serviceTokenRefresh.reject(new Error("One or more service tokens failed to update")),e._serviceTokenRefresh=null;break}}e._serviceTokenRefresh&&(e._serviceTokenRefresh.resolve(),e._serviceTokenRefresh=null),e._allDeferredDojosForUpdatingTokens=[]},function(t){e._allDeferredDojosForUpdatingTokens=[],e._serviceTokensStale=!0,e._serviceTokenRefresh.reject(t),e._serviceTokenRefresh=null}),this._serviceTokenRefresh},t.prototype._updateServiceTokensBySendingRestRequest=function(e,t){var i=this.url;e&&(i=this.url.replace(this.id,e)),this._isTokenUpdateRequired(e)?x.request({url:i+"/update",content:{f:"json"},load:dojo.hitch(this,this._processServiceTokensHandler,e,t),error:dojo.hitch(this,this._processServiceTokensErrorHandler,t),callbackParamName:"CallBack"}):t.resolve()},t.prototype._isTokenUpdateRequired=function(e){if(!e)return!0;var t=this.essentialsMap.mapServices;if(t.length>0)for(var i=0;i<t.length;i++){var r=t[i];if(r.catalogId&&r.catalogId.split(".")[0]==e)return!0}return!1},t.prototype._processServiceTokensHandler=function(e,t,i){var r=this;i&&i.mapServiceTokens&&this._updateServiceTokens(this.essentialsMap,i.mapServiceTokens,e),e||(i&&i.overviewMapServiceTokens&&this._updateServiceTokens(this.overviewMap,i.overviewMapServiceTokens,e),i.geocodingServiceTokens&&i.geocodingServiceTokens.forEach(function(e){var t=r.geocodingEndpoints.filter(function(t){return t.id===e.id})[0];t&&(t.geocoderToken=e.token,dojo.publish("ServiceTokenRefreshed",{serviceUrl:t.geocoderUrl,token:e.token}))}),i.geometryServiceTokens&&i.geometryServiceTokens.forEach(function(e){var t=r.geometryEndpoints.filter(function(t){return t.id===e.id})[0];t&&(t.geometryServiceToken=e.token,dojo.publish("ServiceTokenRefreshed",{serviceUrl:t.geometryServiceUrl,token:e.token}))})),t.resolve()},t.prototype._processServiceTokensErrorHandler=function(e,t){this._serviceTokensStale=!0,e.reject(t),dojo.publish("ServiceTokenRefreshError",{error:t})},t.prototype._updateServiceTokens=function(e,t,i){if(e&&t)for(var r=0;t&&r<t.length;r++){var n;n=i?e.findMapServiceById(i+"-"+t[r].id):e.findMapServiceById(t[r].id),n&&n._updateServiceToken(t[r].token)}},t.prototype._updateServiceTokensFromPrincipal=function(e){if(e&&e.mapServices)for(var i=0;i<e.mapServices.length;i++){var r=e.mapServices[i];if(r&&r.serviceUrl){var n=this.getTokenFromPrincipal(r.serviceUrl,esri.IdentityManagerBase)||this.getTokenFromPrincipal(r.serviceUrl,t);n&&r._updateServiceToken(n)}}},t.prototype.refreshPrincipal=function(){return this._refreshPrincipal(),T.SecurityHelper.waitForSignIn()},t.prototype._refreshPrincipal=function(){var e=this,t={site:this,handled:!1,resumeRefresh:function(){return T.SecurityHelper.beginRefresh(e)},suspendRefresh:function(){return T.SecurityHelper.cancel()}};dojo.publish("geocortex_sessionExpiring",t),t.handled||t.resumeRefresh()},t.prototype._refreshPrincipalAt=function(e,t){var i=this;if(!e)return!1;var r=new Date(e).valueOf();isNaN(r)&&(console.log("_refreshPrincipalAt: Date parse failed, most likely due to ECMAScript 5 support only. Using alternate method."),r=Date.parse(e),console.log("_refreshPrincipalAt: Parsed '"+e+"' as raw value '"+r.toString()+"'."));var n=r-(new Date).valueOf()-t;return n=Math.max(1e4,n),window.setTimeout(function(){return i._refreshPrincipal()},n),!0},t.prototype.updatePrincipal=function(e){this.principal=e,this._refreshPrincipalAt(e.expiry,3e5),this._updateDefaultToken(this.principal.tokens.site),this.principal.tokens&&this.principal.tokens.arcgis&&(this._updateServiceTokensFromPrincipal(this.essentialsMap),this._updateServiceTokensFromPrincipal(this.overviewMap))},t.prototype._getCredential=function(e,i){var r=this.getTokenFromPrincipal(e,esri.IdentityManagerBase)||this.getTokenFromPrincipal(e,t),n=new dojo.Deferred;if(r){var s=new esri.Credential;s.token=r,s.server=this._getCredentialServer(e),n.resolve(s)}else n.reject(new Error("No token available for service {0}".format(e)));return n},t.prototype._getCredentialServer=function(e){var t=e.toLowerCase(),i=t.indexOf("/rest/services");return i===-1&&(i=t.indexOf("/sharing")),i===-1&&"/"===t.substr(-1)&&(i=t.length-1),i>-1?e.substring(0,i):e},t.prototype._hookGetCredential=function(){var e=this,t=function(t,i){try{return e._getCredential(t,i)}catch(r){console.log("Error getting site credential: "+r);var n=new dojo.Deferred;return n.reject(r),n}};esri.IdentityManagerBase.prototype.getCredential=t},t.prototype._initSiteHandler=function(e){var t=this;if(this._hookGetCredential(),!e)throw new Error("Incorrect site object returned from initialization");if(this.configPreprocessor&&(this.configPreprocessor(e),this.configPreprocessor=null),e.__loadedOffline&&(this._serviceTokensStale=!0),e.contentPolicy&&(L.isNullOrUndefined(e.contentPolicy.trustedUrls)?this.trustedUrls=[]:this.trustedUrls=e.contentPolicy.trustedUrls),e.layerCatalogs)if(0==e.layerCatalogs.length)this.layerCatalogs=[];else for(var i=0;i<e.layerCatalogs.length;i++)this.layerCatalogs[i]=new h.LayerCatalog(e.layerCatalogs[i].siteId);if(e.principal){var n=e.principal;if(void 0===n.policy&&(n.policy={}),n.policy.authenticate&&!n.isAuthenticated)return void this._signIn(n);this.principal=n,n.isAuthenticated&&dojo.publish("geocortex_authenticationSucceeded",[{username:n.label,token:n.tokens.site}]),this._refreshPrincipalAt(this.principal.expiry,3e5)}else if(e.arcGisPortalAuthentication&&e.arcGisPortalAuthentication.clientID){var a=e.arcGisPortalAuthentication;
if(this.arcGisPortalSecurityContext=new r.ArcGisPortalSecurityContext(a.url,a.domains,a.clientID),!this.arcGisPortalSecurityContext.initiate()){if(this.arcGisPortalSecurityContext.error)if(this.arcGisPortalSecurityContext.error.code==D.OAuth2Error.ACCESS_DENIED_ERROR_CODE)this.onUserSignInCancelled&&this.onUserSignInCancelled({tryAgainAction:dojo.hitch(this,function(){D.OAuth2Client.redirectToLogOnPage(this.arcGisPortalSecurityContext.getLogOnUrl(),this.arcGisPortalSecurityContext.clientId)})});else{var o=new Error;o.name=this.arcGisPortalSecurityContext.error.code,o.message=this.arcGisPortalSecurityContext.error.description,this._initializationFailedHandler(o)}return}_.RestHelperHTTPService.arcGisPortalToken=this.arcGisPortalSecurityContext.tokenResult}this.hasGeocodingEndpoints=!!e.hasGeocodingEndpoints,this.hasGeometryEndpoints=!!e.hasGeometryEndpoints,this.hasGeoprocessingEndpoints=!!e.hasGeoprocessingEndpoints,this.hasNamedExtents=!!e.hasNamedExtents,this.hasNorthArrow=!!e.hasNorthArrow,this.hasTimeSliders=!!e.hasTimeSliders,this.hasOverviewMap=!!e.hasOverviewMap,this.hasPrintTemplates=!!e.hasPrintTemplates,this.hasViewers=!!e.hasViewers,this.hasVirtualDirectory=!!e.hasVirtualDirectory,this.hasWorkflows=!!e.hasWorkflows,this.hasSearchTables=!!e.hasSearchTables,this.hasWebMaps=!!e.hasWebMaps,this.dataProvider=e.dataProvider,this.displayName=e.displayName,this.id=e.id,this._signInEnabled=!!e.signInEnabled,this._signOutEnabled=!!e.signOutEnabled,this._signOutRedirectUrl=e.signOutRedirectUrl,this.timeZoneId=e.timeZoneId,this.displayTimeZoneId=e.displayTimeZoneId,void 0===e.currentVersion?this.currentVersion="3.0":this.currentVersion=e.currentVersion,e.hasOwnProperty("updateInterval")?(this.updateInterval=parseInt(e.updateInterval),isNaN(this.updateInterval)&&(this.updateInterval=0)):this.updateInterval=0,this.updateInterval>0&&(this._tokenIntervalHandle=setInterval(function(){t._getUpdatedServiceTokens()},Math.max(60,1e3*this.updateInterval))),this.properties=x._getProperties(e.properties),this.extensions=x._getExtensions(e.extensions),this.essentialsMap=new s.Map(this.originalUrl+"/map"),this.essentialsMap.site=this,dojo.connect(this.essentialsMap,"onInitialized",dojo.hitch(this,this._initMapHandler)),dojo.connect(this.essentialsMap,"onInitializationFailed",dojo.hitch(this,this._initMapErrorHandler)),this.hasOverviewMap&&(this.overviewMap=new s.Map(this.originalUrl+"/overviewmap"),this.overviewMap.site=this,dojo.connect(this.overviewMap,"onInitialized",dojo.hitch(this,this._initOverviewMapHandler)),dojo.connect(this.overviewMap,"onInitializationFailed",dojo.hitch(this,this._initOverviewMapErrorHandler))),e.map&&e.map.layerList&&(this.layerListRestEndpoint=e.map.layerList),!this.deepInitialize||this.getEssentialsVersion()<3.3||void 0===e.map?(this.essentialsMap.initialize(),this.hasOverviewMap?this.overviewMap.initialize():this._overviewMapInitialized=!0,e.hasKmlServiceEndpoint?x.request({url:this.url+"/kmlService",content:{f:"json"},load:dojo.hitch(this,this._initKmlEndpointHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._kmlServiceInitialized=!0})),callbackParamName:"CallBack"}):this._kmlServiceInitialized=!0,this.hasGeocodingEndpoints?x.request({url:this.url+"/geocoding",content:{f:"json"},load:dojo.hitch(this,this._initGeocodingEndpointsHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._geocodingEndpointsInitialized=!0})),callbackParamName:"CallBack"}):this._geocodingEndpointsInitialized=!0,this.hasGeometryEndpoints?x.request({url:this.url+"/geometry",content:{f:"json"},load:dojo.hitch(this,this._initGeometryEndpointsHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._geometryEndpointsInitialized=!0})),callbackParamName:"CallBack"}):this._geometryEndpointsInitialized=!0,this.hasGeoprocessingEndpoints?x.request({url:this.url+"/geoprocessing",content:{f:"json"},load:dojo.hitch(this,this._initGeoprocessingEndpointsHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._geoprocessingEndpointsInitialized=!0})),callbackParamName:"CallBack"}):this._geoprocessingEndpointsInitialized=!0,this.hasNamedExtents?x.request({url:this.url+"/namedextents",content:{f:"json"},load:dojo.hitch(this,this._initNamedExtentsHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._namedExtentsInitialized=!0})),callbackParamName:"CallBack"}):this._namedExtentsInitialized=!0,this.hasPrintTemplates?x.request({url:this.url+"/printtemplates",content:{f:"json"},load:dojo.hitch(this,this._initPrintTemplatesHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._printTemplatesInitialized=!0})),callbackParamName:"CallBack"}):this._printTemplatesInitialized=!0,this.hasSearchTables?x.request({url:this.url+"/searchtables",content:{f:"json"},load:dojo.hitch(this,this._initSearchTablesHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._searchTablesInitialized=!0})),callbackParamName:"CallBack"}):this._searchTablesInitialized=!0,this.hasTimeSliders?x.request({url:this.url+"/timesliders",content:{f:"json"},load:dojo.hitch(this,this._initTimeSlidersHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._timeSlidersInitialized=!0})),callbackParamName:"CallBack"}):this._timeSlidersInitialized=!0,this.hasWorkflows?x.request({url:this.url+"/workflows",content:{f:"json"},load:dojo.hitch(this,this._initWorkflowsHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._workflowsInitialized=!0})),callbackParamName:"CallBack"}):this._workflowsInitialized=!0,this.hasWebMaps?x.request({url:this.url+"/webmaps",content:{f:"json"},load:dojo.hitch(this,this._initWebMapHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._webMapsInitialized=!0})),callbackParamName:"CallBack"}):this._webMapsInitialized=!0):(this._initGeocodingEndpointsHandler(e),this._initGeometryEndpointsHandler(e),this._initGeoprocessingEndpointsHandler(e),this._initTimeSlidersHandler(e),this._initKmlEndpointHandler(e.kmlServiceEndpoint),this.essentialsMap.initialize(e.map),this._initNamedExtentsHandler(e),e.overviewMap?this.overviewMap.initialize(e.overviewMap):(this._overviewMapInitialized=!0,this._siteInitializeUpdate()),this._initPrintTemplatesHandler(e),this._initWorkflowsHandler(e),this._initSearchTablesHandler(e),this._initWebMapHandler(e)),this.documentStore.initialize(this),this._siteInitializeUpdate()},t.prototype._updateServiceTokensOfAllSites=function(){var e=this;this.layerCatalogs&&this.layerCatalogs.length>0&&this.layerCatalogs.forEach(function(t){var i=new dojo.Deferred;e._allDeferredDojosForUpdatingTokens.push(i),e._updateServiceTokensBySendingRestRequest(t.siteId,i)});var t=new dojo.Deferred;this._allDeferredDojosForUpdatingTokens.push(t),this._updateServiceTokensBySendingRestRequest(null,t)},t.prototype._initSiteErrorHandler=function(e){var t=this,i=e,r=i.principal;if(r&&!r.isAuthenticated&&403==i.code){var n=R.isNative();return void(n?dojo.publish("SiteSignInRequired",{error:i.code,callback:function(){return t._signIn(r)}}):this._signIn(r))}r&&r.isAuthenticated&&403==i.code&&r.urls.signOut&&(this._signOutEnabled=!0,this.principal=r),this._geocodingEndpointsInitialized=!0,this._geometryEndpointsInitialized=!0,this._geoprocessingEndpointsInitialized=!0,this._kmlServiceInitialized=!0,this._namedExtentsInitialized=!0,this._printTemplatesInitialized=!0,this._workflowsInitialized=!0,this._searchTablesInitialized=!0,this._timeSlidersInitialized=!0,this._initializationFailedHandler(e),this._siteInitializeUpdate()},t.prototype._initWorkflowsHandler=function(e){this._workflowsInitialized=!0,e&&this._initAsyncCollection(e.workflows,"workflows",this.workflows,d.Workflow)},t.prototype._initSearchTablesHandler=function(e){this._searchTablesInitialized=!0,e&&this._initAsyncCollection(e.searchTables,"searchTables",this.searchTables,f.SearchTable)},t.prototype._initWebMapHandler=function(e){this._webMapsInitialized=!0,e&&e.webMapsInfo&&(this.webMapsInfo.layerTypes=e.webMapsInfo.layerTypes,this._initAsyncCollection(e.webMapsInfo.webMaps,"webmaps",this.webMapsInfo.webMaps,C.WebMapReference))},t.prototype._siteInitializeUpdate=function(){this._geocodingEndpointsInitialized&&this._geometryEndpointsInitialized&&this._geoprocessingEndpointsInitialized&&this._kmlServiceInitialized&&this._mapInitialized&&this._namedExtentsInitialized&&this._overviewMapInitialized&&this._printTemplatesInitialized&&this._workflowsInitialized&&this._searchTablesInitialized&&this._timeSlidersInitialized&&this._webMapsInitialized&&(this._initializedHandlerCalled||(this._initializedHandlerCalled=!0,this._initializedHandler(this)))},t.prototype._verifySiteDependencies=function(e){e&&e.hasFeatureLayers?dojo.addOnLoad(dojo.hitch(this,function(){this._initSiteHandler(e)})):this._initSiteHandler(e)},t}(i.AsyncInitializable);t.Site=F})},"geocortex/essentials/AsyncInitializable":function(){define(["require","exports","geocortex/geocortex"],function(e,t,i){"use strict";var r=function(){function e(e){this.initializationFailure=null,this.isInitialized=!1,this.onInitializationFailed=null,this.onInitialized=null,this._initializing=!1,this.url=e,this._initializedHandler=dojo.hitch(this,this._initializedHandler),this._initializationFailedHandler=dojo.hitch(this,this._initializationFailedHandler),this._restLoadHandler=dojo.hitch(this,this._restLoadHandler),this._restErrorHandler=dojo.hitch(this,this._restErrorHandler)}return e.prototype.initialize=function(e){if(!this.isInitialized&&!this._initializing){var t=void 0!==e&&null!==e;if(t)this._restLoadHandler(!0,e);else{if(!this.url)throw new Error("Unable to initialize AsyncInitializable without a valid URL.");this._initializing=!0,i.request({url:this.url,content:{f:"json"},load:dojo.hitch(this,this._restLoadHandler,t),error:this._restErrorHandler,callbackParamName:"CallBack"})}}},e.prototype.doWhenInitialized=function(e,t){if(1===arguments.length&&(t=e,e=this),this.isInitialized)t.call(e,this);else var i=dojo.connect(this,"onInitialized",this,function(){dojo.disconnect(i),t.apply(e,arguments)})},e.prototype._configureObject=function(e,t){},e.prototype._initializationFailedHandler=function(e){this.initializationFailure=e,this.onInitializationFailed&&this.onInitializationFailed(e)},e.prototype._initializedHandler=function(e){this.isInitialized=!0,this.onInitialized&&this.onInitialized(e),this._initializing=!1},e.prototype._restErrorHandler=function(e){this._initializationFailedHandler(e),this._initializedHandler(this)},e.prototype._restLoadHandler=function(e,t){this._configureObject(t,e),this._initializedHandler(this)},e}();t.AsyncInitializable=r})},"geocortex/workflow/ArgumentInfo":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(e,t,i,r){this.runtimeTypeName=null,this.name=e||null,this.typeName=t||null,this.isRequired=!!i,this.value=r||null}return e.prototype._configureObject=function(e){if("undefined"==typeof e.name||"undefined"==typeof e.typeName)throw new Error("Incorrect argument info object returned from initialization");this.name=e.name,this.typeName=e.typeName,this.isRequired=e.isRequired,this.value=e.value,this.runtimeTypeName=e.runtimeTypeName},e.prototype._internalClone=function(){var t=new e(this.name,this.typeName,this.isRequired,dojo.clone(this.value));return t.runtimeTypeName=dojo.clone(this.runtimeTypeName),t},e}();t.ArgumentInfo=i})},"geocortex/workflow/ExternalActivityInfo":function(){define(["require","exports","geocortex/workflow/ArgumentInfo"],function(e,t,i){"use strict";var r=function(){function e(e,t,i,r,n,s,a,o,l){this.debug=!1,this.id=e||null,this.displayName=t||null,this.typeName=i||null,this.instanceId=r||null,this.externalId=n||null,this.syncToken=s||null,this.isComplete=a||!1,this.isAborted=!1,this.inputs=o||[],this.outputs=l||[]}return e.prototype._configureObject=function(e){if("undefined"==typeof e.id||"undefined"==typeof e.displayName||"undefined"==typeof e.typeName||"undefined"==typeof e.instanceId)throw new Error("Incorrect external activity info object returned from initialization");this.id=e.id,this.displayName=e.displayName,this.typeName=e.typeName,this.instanceId=e.instanceId,this.externalId=e.externalId,this.syncToken=e.syncToken,this.isComplete=e.isComplete,e.debug&&(this.debug=e.debug),this.inputs=[],this.outputs=[];var t;if(e.inputs)for(t=0;t<e.inputs.length;t++){var r=e.inputs[t],n=new i.ArgumentInfo;n._configureObject(r),this.inputs[t]=n}if(e.outputs)for(t=0;t<e.outputs.length;t++){var r=e.outputs[t],n=new i.ArgumentInfo;n._configureObject(r),this.outputs[t]=n}},e}();t.ExternalActivityInfo=r})},"geocortex/essentials/Workflow":function(){define(["require","exports","geocortex/essentials/AsyncInitializable","geocortex/workflow/ArgumentInfo","geocortex/workflow/ExternalActivityInfo","geocortex/geocortex"],function(e,t,i,r,n,s){"use strict";var a=function(e){function t(t){var i=e.call(this,t)||this;return i.displayName=null,i.error=null,i.extensions=[],i.externalActivities={},i.id=null,i.properties={},i.site=null,i._inputs=[],i._outputs=[],i}return __extends(t,e),t.prototype.getInputs=function(){return this._cloneArgumentInfoCollection(this._inputs)},t.prototype.getOutputsMetadata=function(){return this._cloneArgumentInfoCollection(this._outputs)},t.prototype._cloneArgumentInfoCollection=function(e){var t=null;if(null!==e){t=[];for(var i=0;i<e.length;i++)t.push(e[i]._internalClone())}return t},t.prototype._configureObject=function(e,t){if(void 0===e.id||void 0===e.displayName)throw new Error("Incorrect workflow object returned from initialization");var i,a;if(this.id=e.id,this.displayName=e.displayName,this.runOnStartup=!!e.runOnStartup,this.error=e.error,this._inputs=[],this._outputs=[],this.externalActivities=[],e.inputs)for(var o=0;o<e.inputs.length;o++)i=e.inputs[o],a=new r.ArgumentInfo,a._configureObject(i),this._inputs[o]=a;if(e.outputs)for(o=0;o<e.outputs.length;o++)i=e.outputs[o],a=new r.ArgumentInfo,a._configureObject(i),this._outputs[o]=a;if(e.externalActivities)for(o=0;o<e.externalActivities.length;o++){var l=e.externalActivities[o],c=new n.ExternalActivityInfo;c._configureObject(l),this.externalActivities[o]=c}this.properties=s._getProperties(e.properties),this.extensions=s._getExtensions(e.extensions)},t}(i.AsyncInitializable);t.Workflow=a})},"geocortex/workflow/WorkflowState":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(e,t,i,r,n,s){this.instanceId=e,this.status=t,this.pendingExternalActivities=i,this.outputs=r,this.workflowData=n,this.instanceData=s}return e}();t.WorkflowState=i})},"geocortex/workflow/ArgumentValueWrapper":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(e,t){this.runtimeTypeName=null,this.runtimeTypeName=e||null,this.value=t||null}return e}();t.ArgumentValueWrapper=i})},"geocortex/workflow/MapServiceActivityHandlers":function(){define(["require","exports","geocortex/essentials/utilities/SiteResourceIdComparer"],function(e,t,i){"use strict";function r(e,t){return t&&e&&e.essentialsMap&&e.essentialsMap.mapServices?i.SiteResourceIdComparer.lookUp(e.essentialsMap.mapServices,t):null}function n(e,t){if(!e||!t)return null;if(null!=e.layerIds)for(var r=0;r<e.layerIds.length;r++){var n=e.getLayer(e.layerIds[r]);if(null!=n&&i.SiteResourceIdComparer.equals(n.id,t))return n}if(null!=e.graphicsLayerIds)for(var r=0;r<e.graphicsLayerIds.length;r++){var n=e.getLayer(e.graphicsLayerIds[r]);if(null!=n&&i.SiteResourceIdComparer.equals(n.id,t))return n}return null}function s(e){var t=e.getValue("MapServiceId"),i=e.getEsriMap();if(null==i)throw new Error("Remove Map Service: No map available.");var r=n(i,t);if(r){i.removeLayer(r);var s=e.getSite();s&&s.essentialsMap&&s.essentialsMap.mapServices&&s.essentialsMap.removeServiceLayer(r)}e.completeActivity()}function a(t){var i=t.getValue("ImageServiceId"),r=t.getValue("BandIds"),s=t.getValue("MosaicRule"),a=t.getValue("RenderingRule"),o=t.getEsriMap();if(null==o)throw new Error("Set Image Service Info: No map available.");e(["esri/layers/RasterFunction"],function(e){var l=n(o,i);if(l instanceof esri.layers.ArcGISImageServiceLayer){var c=l;if(r&&c.setBandIds(r,!0),s){var u=new esri.layers.MosaicRule(s);u.method||(u=c.defaultMosaicRule),c.setMosaicRule(u,!0)}if(a){var p=new esri.layers.RasterFunction(a);p.functionName||(p=null),c.setRenderingRule(p,!0)}c.refresh()}t.completeActivity()})}function o(e){var t=e.getValue("MapServiceId"),i=e.getValue("Visible");if(null==t)throw new Error("Set Map Service Visibility: required MapServiceId argument was not supplied.");if(null==i)throw new Error("Set Map Service Visibility: required Visible argument was not supplied.");var s=e.getEsriMap(),a=e.getSite();if(null==s)throw new Error("Set Map Service Visibility: No map available.");var o=null;if(o=n(s,t),null==o)throw new Error("Set Map Service Visibility: Unable to find map service with ID '"+t+"'");if(o.setVisibility(i),e.completeActivity(),a&&t){var l=r(a,t);dojo.publish("MapServiceVisibilityChangedEvent",l)}}function l(e){if(!e)throw new Error("Get Map Service Info: required context was not supplied.");var t=e.getValue("MapServiceId"),i=e.getValue("LayerName");if(null==t)throw new Error("Get Map Service Info: required MapServiceId argument was not supplied.");var s=null,a=null,o=null,l=null,c=!1,u=e.getEsriMap();if(null==u)throw new Error("Get Map Service Info: No map available.");var p=e.getSite(),h=null,d=null;if(null!=p&&null!=p.essentialsMap&&(d=r(p,t),null!=d&&(h=d.serviceLayer,s=d.serviceUrl,a=d.findServiceToken(),c=d.isVisible())),null==h&&(h=n(u,t),h&&(s=h.url,"boolean"==typeof h.visible&&(c=h.visible))),null!=i){var f=!1;if(h.supportsDynamicLayers&&h.dynamicLayerInfos)for(var y=h.dynamicLayerInfos,m=0;m<y.length;m++){var g=y[m];if(g.name===i||"{0}".format(g.id)===i){f=!0,o="dynamicLayer",l=g.source;break}}if(!f&&h.layerInfos)for(var y=h.layerInfos,m=0;m<y.length;m++){var g=y[m];if(null!=g&&null!=g.id&&g.name==i){f=!0,o=g.id;break}}if(!f&&d){var v=d.findLayerOrTableByName(i);v&&(f=!0,o=v.id)}}e.setValue("MapServiceUrl",s),e.setValue("Token",a),e.setValue("LayerId",o),e.setValue("Source",l),e.setValue("Visible",c),e.completeActivity()}function c(e){var t="Set Map Service Property",i=e.getValue("MapServiceId"),r=e.getValue("PropertyName"),s=e.getValue("Value");if(!i)throw new Error("{0}: required MapServiceId argument was not supplied.".format(t));if(!r)throw new Error("{0}: required PropertyName argument was not supplied.".format(t));var a=e.getEsriMap();if(!a)throw new Error("{0}: no map available.".format(t));var o=n(a,i);if(!o)throw new Error("{0}: unable to find map service with ID '{1}'.".format(t,i));if("gdbversion"===r.toLowerCase())if(o instanceof esri.layers.FeatureLayer){if(!o.isDataVersioned)throw new Error("{0}: map service with ID '{1}' is not versioned.".format(t,i));o.setGDBVersion(s)}else{if(!(o instanceof esri.layers.ArcGISDynamicMapServiceLayer))throw new Error("{0}: map service with ID '{1}' does not support GDB version.".format(t,i));o.setGDBVersion(s)}else if("visible"===r.toLowerCase())o.setVisibility(s);else{r="set"+r.toLowerCase();var l=null;for(var c in o)if(c.toLowerCase()===r){l=c;break}if(!l)throw new Error("{0}: map service property '{1}' does not exist.".format(t,r));o[l](s)}e.completeActivity()}t.findMapServiceById=r,t.findMapServiceByMap=n,t.handleRemoveMapService=s,t.handleSetImageServiceInfo=a,t.handleSetMapServiceVisibility=o,t.handleGetMapServiceInfo=l,t.handleSetMapServiceProperty=c})},"geocortex/forms/items/validation/ValidationResult":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(e,t){this.isValid=e,this.errorMessage=t}return e}();t.ValidationResult=i})},"geocortex/forms/items/FormItemResult":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(e,t,i){this.isList=!1,this.argumentName=e,this.value=t,this.wasSet=i||!1}return e}();t.FormItemResult=i})},"geocortex/forms/items/validation/ValidationItem":function(){define(["require","exports","geocortex/forms"],function(e,t,i){"use strict";var r=function(){function e(e){this.message=i.getElementText(e,"Message")}return e.prototype.validate=function(e){throw new Error("Abstract method")},e}();t.ValidationItem=r})},"geocortex/forms/getItemType":function(){define(["require","exports"],function(e,t){"use strict";function i(e){var t="";if(null!=e&&null!=e.attributes)for(var i=0;i<e.attributes.length;i++)if(String(e.attributes[i].nodeName).indexOf("type")>=0){var r=e.attributes[i].nodeValue,n=r.indexOf(":");n>=0&&n+1<r.length&&(r=r.substr(n+1)),t=r;break}return t}t.getItemType=i})},"geocortex/forms/items/validation/NumericRangeValidationItem":function(){define(["require","exports","geocortex/forms/items/validation/ValidationItem","geocortex/forms","geocortex/forms/items/validation/ValidationResult"],function(e,t,i,r,n){"use strict";var s=function(e){function t(t){var i=e.call(this,t)||this;return i.minimumValue=parseFloat(r.getElementText(t,"MinimumValue")),i.maximumValue=parseFloat(r.getElementText(t,"MaximumValue")),i}return __extends(t,e),t.prototype.validate=function(e){if(null===e||void 0===e||""===e)return new n.ValidationResult((!0),null);var t=parseFloat(e);return null==t||isNaN(t)||t<this.minimumValue||t>this.maximumValue?new n.ValidationResult((!1),this.message):new n.ValidationResult((!0),null)},t}(i.ValidationItem);t.NumericRangeValidationItem=s})},"geocortex/forms/items/validation/RequiredValidationItem":function(){define(["require","exports","geocortex/forms/items/validation/ValidationItem","geocortex/forms/items/validation/ValidationResult"],function(e,t,i,r){"use strict";var n=function(e){function t(t){return e.call(this,t)||this}return __extends(t,e),t.prototype.validate=function(e){var t=!0,i=null;return(void 0===e||null===e||"string"==typeof e&&""===dojo.trim(e)||void 0!==e.length&&e.length<=0||e.value&&dojo.isArray(e.value)&&0===e.value.length)&&(t=!1,i=this.message),new r.ValidationResult(t,i)},t}(i.ValidationItem);t.RequiredValidationItem=n})},"geocortex/forms/items/validation/RegexValidationItem":function(){define(["require","exports","geocortex/forms/items/validation/ValidationItem","geocortex/forms","geocortex/forms/items/validation/ValidationResult"],function(e,t,i,r,n){"use strict";var s=function(e){function t(t){var i=e.call(this,t)||this;return i.expression=r.getElementText(t,"Expression"),i.ignoreCase=r._parseBoolean(r.getElementText(t,"IgnoreCase")),i}return __extends(t,e),t.prototype.validate=function(e){if(null===e||void 0===e||""===e)return new n.ValidationResult((!0),null);var t="",i=this.expression;this.ignoreCase&&(t+="i"),'^(?(")(".+?"@)|(([0-9a-zA-Z]((\\.(?!\\.))|[-!#\\$%&\'\\*\\+/=\\?\\^`\\{\\}\\|~\\w])*)(?<=[0-9a-zA-Z])@))(?(\\[)(\\[(\\d{1,3}\\.){3}\\d{1,3}\\])|(([0-9a-zA-Z][-\\w]*[0-9a-zA-Z]\\.)+[a-zA-Z]{2,6}))$'==this.expression&&(i="^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,4}$");var r=null;try{r=new RegExp(i,t)}catch(s){}return null==r||r.test(e)?new n.ValidationResult((!0),null):new n.ValidationResult((!1),this.message)},t}(i.ValidationItem);t.RegexValidationItem=s})},"geocortex/forms/FileItem":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(){this.fileName=null,this.fileDataBase64=null,this.fileSize=0,this.fileType=null}return e}();t.FileItem=i})},"geocortex/forms/items/validation/FileSizeValidationItem":function(){define(["require","exports","geocortex/forms/items/validation/ValidationItem","geocortex/forms","geocortex/forms/items/validation/ValidationResult","geocortex/workflow/ArgumentValueWrapper","geocortex/forms/FileItem"],function(e,t,i,r,n,s,a){"use strict";var o=function(e){function t(t){var i=e.call(this,t)||this;return i.totalFileSize=parseInt(r.getElementText(t,"TotalFileSize")),i}return __extends(t,e),t.prototype.validate=function(e){if(e instanceof s.ArgumentValueWrapper&&e.value&&e.value instanceof Array){for(var t=0,i=0;i<e.value.length;++i){var r=e.value[i];r&&r instanceof a.FileItem&&(t+=r.fileSize)}if(t>this.totalFileSize)return new n.ValidationResult((!1),this.message)}return new n.ValidationResult((!0),null)},t}(i.ValidationItem);t.FileSizeValidationItem=o})},"geocortex/forms/items/FormItem":function(){define(["require","exports","geocortex/framework/observables","geocortex/forms","geocortex/forms/getItemType","geocortex/forms/items/validation/NumericRangeValidationItem","geocortex/forms/items/validation/RequiredValidationItem","geocortex/forms/items/validation/RegexValidationItem","geocortex/forms/items/validation/FileSizeValidationItem"],function(e,t,i,r,n,s,a,o,l){"use strict";function c(e){var t=n.getItemType(e),i=null;switch(t){case"NumericRangeValidationItem":i=new s.NumericRangeValidationItem(e);break;case"RequiredValidationItem":i=new a.RequiredValidationItem(e);break;case"RegexValidationItem":i=new o.RegexValidationItem(e);break;case"FileSizeValidationItem":i=new l.FileSizeValidationItem(e)}return i}var u=function(){function e(e,t){if(this.isRequired=new i.Observable((!1)),this.isValid=new i.Observable((!0)),this.isVisible=new i.Observable((!0)),this.argumentName=null,this.validationItems=[],this.formDefinition=t||null,this.attached_indicatorClass=new i.Observable(""),this.attached_showIndicator=new i.Observable(""),e){this.toolTip=new i.Observable(r.getElementText(e,"ToolTip")),this.itemID=new i.Observable(r.getElementText(e,"ItemID")),this.argumentName=new i.Observable(r.getElementText(e,"ArgumentName"));var n=r.getElementText(e,"IsVisible");n&&this.isVisible.set(r._parseBoolean(n));var s=r.getElement(e,"ValidationItems");if(null!=s)for(var a=0;a<s.childNodes.length;a++){var o=c(s.childNodes[a]);o instanceof geocortex.forms.items.validation.RequiredValidationItem&&this.isRequired.set(!0),null!=o&&this.validationItems.push(o)}}else this.toolTip=new i.Observable(""),this.itemID=new i.Observable(null),this.argumentName=new i.Observable(null)}return e.prototype.getResult=function(){return null},e.prototype._notifyResultChanged=function(){dojo.publish("FormItemResultChangedEvent",[this])},e.prototype.refresh=function(){},e.prototype.validate=function(){var e=[];if(this.isValid.set(!0),null!=this.validationItems)for(var t=0;t<this.validationItems.length;t++){var i=this.getResult();null!=i&&(i=i.value);var r=this.validationItems[t].validate(i);r.isValid||(this.isValid.set(!1),e.push(r))}return e},e.prototype._render=function(){return document.createTextNode(this.itemID.get())},e.prototype._destroy=function(){},e}();t.AbstractFormItem=u})},"geocortex/forms/items/ContainerFormItem":function(){define(["require","exports","geocortex/forms/items/FormItem","geocortex/framework/observables","geocortex/forms"],function(e,t,i,r,n){"use strict";var s=function(e){function t(t,i){var s=e.call(this,t,i)||this;if(s.formItems=new r.ObservableCollection,s.formItemType="ContainerFormItem",s.createElementDelegate=function(e,t){return i.createElementDelegate(e,t)},t){s.orientation=new r.Observable(n.getElementText(t,"Orientation")),s.description=new r.Observable(n.getElementText(t,"Description")),s.maxWidth=new r.Observable(parseInt(n.getElementText(t,"MaxWidth"))),s.visibleControlID=new r.Observable(n.getElementText(t,"VisibleControlID")),s.visibleControlValue=new r.Observable(n.getElementText(t,"VisibleControlValue"));var a=n.getElement(t,"FormItems");if(null!=a)for(var o=0;o<a.childNodes.length;o++){var l=i.createElementDelegate(a.childNodes[o],s.formDefinition);null!=l&&(s.formItems.addItem(l),l.refresh=function(){var e=s.formItems.indexOf(s);e>=0&&(s.formItems.removeAt(e),s.formItems.insertItem(e,s))})}}else s.orientation=new r.Observable("Vertical"),s.description=new r.Observable(""),s.maxWidth=new r.Observable(NaN),s.visibleControlID=new r.Observable(""),s.visibleControlValue=new r.Observable("");return s}return __extends(t,e),t.prototype.validate=function(){var e=[];if(this.isVisible.get()&&null!=this.formItems)for(var t=0;t<this.formItems.getLength();++t){var i=this.formItems.getAt(t);if(i.isVisible.get())for(var r=i.validate(),n=0;n<r.length;++n)e.push(r[n])}return e},t.prototype._getResults=function(){for(var e=[],i=0;i<this.formItems.getLength();++i){var r=this.formItems.getAt(i);if(r.isVisible.get())if(r instanceof t){var n=r._getResults();if(null!=n)for(var s=0;s<n.length;++s)e.push(n[s])}else{var a=r.getResult();null!=a&&e.push(a)}}return e},t.prototype._destroy=function(){for(var e=this.formItems.length()-1;e>=0;e--)this.formItems.getAt(e)._destroy();this.formItems.clear()},t.prototype._render=function(){return n.renderFormItem(this)},t.prototype.getFormItemById=function(e){for(var t=0,i=this.formItems.length();t<i;t++){var r=this.formItems.getAt(t);if(r.itemID.get()===e)return r;if(r.getFormItemById&&(r=r.getFormItemById(e)))return r}return null},t.prototype.applyVisibility=function(e){if(e){var t=!1,i=e.getResult();if(null!==i&&null!==i.value){var r=this.visibleControlValue.get();if(r)if(i.isList){var n=i.value;if(n)for(var s=0;s<n.length;s++)if(n[s].toString()===r){t=!0;break}}else t=i.value===!0||i.value===!1?i.value.toString().toUpperCase()===r.toUpperCase():i.value.toString()===r;else 1==i.value&&(t=!0)}this.isVisible.set(t)}},t.prototype.getDisplayName=function(){return null},t}(i.AbstractFormItem);t.ContainerFormItem=s})},"geocortex/forms/items/LabelFormItem":function(){define(["require","exports","geocortex/forms/items/FormItem","geocortex/framework/observables","geocortex/forms"],function(e,t,i,r,n){"use strict";var s=function(e){function t(t,i){var s=e.call(this,t,i)||this;return s.formItemType="LabelFormItem",t?(s.text=new r.Observable(n.getElementText(t,"Text")),s.labelForItemID=new r.Observable(n.getElementText(t,"LabelForItemID"))):(s.text=new r.Observable(null),s.labelForItemID=new r.Observable(null)),s}return __extends(t,e),t.prototype._render=function(){return n.renderFormItem(this)},t}(i.AbstractFormItem);t.LabelFormItem=s})},"geocortex/forms/items/LabelContainer":function(){define(["require","exports","geocortex/forms/items/LabelFormItem","geocortex/forms"],function(e,t,i,r){"use strict";function n(e,t,n){t?(e.label=new i.LabelFormItem(r.getElement(t,"Label")),""==e.label.toolTip.get()&&null!=e.toolTip&&e.label.toolTip.set(e.toolTip.get())):e.label=new i.LabelFormItem(null)}t.initLabelContainer=n})},"geocortex/forms/items/TextBoxFormItem":function(){define(["require","exports","geocortex/forms/items/FormItem","geocortex/forms/items/LabelContainer","geocortex/framework/observables","geocortex/forms","geocortex/forms/items/FormItemResult"],function(e,t,i,r,n,s,a){"use strict";var o=function(e){function t(t,i){var a=e.call(this,t,i)||this;if(a.formItemType="TextBoxFormItem",t){var o=s.getElementText(t,"DefaultText");a.defaultText=new n.Observable(o),a.text=new n.Observable(o),a.inputScope=new n.Observable(s.getElementText(t,"InputScope")),a.textboxWidth=new n.Observable(parseInt(s.getElementText(t,"TextboxWidth"))),a.readOnly=new n.Observable(s._parseBoolean(s.getElementText(t,"ReadOnly")))}else a.defaultText=new n.Observable(""),a.text=new n.Observable(""),a.inputScope=new n.Observable("Default"),a.textboxWidth=new n.Observable(NaN),a.readOnly=new n.Observable((!1));return r.initLabelContainer(a,t,i),a.text.bind(null,function(e){return a._notifyResultChanged()}),a}return __extends(t,e),t.prototype.getResult=function(){return new a.FormItemResult(this.argumentName.get(),this.text.get())},t.prototype._render=function(){return s.renderFormItem(this)},t}(i.AbstractFormItem);t.TextBoxFormItem=o})},"geocortex/forms/items/DataItemsFormItem":function(){define(["require","exports","geocortex/framework/observables","geocortex/forms/DataItem","geocortex/forms"],function(e,t,i,r,n){
"use strict";function s(e,t,s){if(e.dataItems=new i.ObservableCollection,t){var a=n.getElement(t,"DataItems");if(null!=a)for(var o=0;o<a.childNodes.length;o++){var l=a.childNodes[o],c=new r.DataItem(n.getElementText(l,"Display"),n.getElementText(l,"Value"),n.getElementText(l,"TypeName"));null!=c&&e.dataItems.addItem(c)}}if(s){var u=s.inputData;if(u&&u.hasOwnProperty(e.itemID.get())){var p=u[e.itemID.get()];e.dataItems.addItems(p)}}}t.initDataItemsFormItem=s})},"geocortex/forms/items/QueryTaskFormItem":function(){define(["require","exports","geocortex/framework/observables","geocortex/framework/events/Event","geocortex/forms","geocortex/essentials/RestHelper","geocortex/forms/DataItem","geocortex/essentials/Field","geocortex/essentials/RestHelperHTTPService"],function(e,t,i,r,n,s,a,o,l){"use strict";var c=function(){function e(e,t,s){if(this.cascadingEvent=new r.Event("cascadingEvent"),this.isBusy=new i.Observable((!1)),this._queryId=0,e.queryTaskRunner||(e.queryTaskRunner=this),e.queryTaskRunner!==this)throw new Error("FormItem in the constructor must be the QueryTaskFormItem containing the QueryTaskRunner");this.formItem=e,t?(this.queryDisplayOutputField=new i.Observable(n.getElementText(t,"QueryDisplayOutputField")),this.queryValueOutputField=new i.Observable(n.getElementText(t,"QueryValueOutputField")),this.queryServiceUrl=new i.Observable(n.getElementText(t,"QueryServiceUrl")),this.queryWhereClause=new i.Observable(n.getElementText(t,"QueryWhereClause")),this.filterByInputGeometry=new i.Observable(n._parseBoolean(n.getElementText(t,"FilterByInputGeometry"))),this.queryCascadingID=new i.Observable(n.getElementText(t,"QueryCascadingID")),this.proxyUrl=new i.Observable(n.getElementText(t,"ProxyUrl")),this.token=new i.Observable(n.getElementText(t,"Token")),n.getElementText(t,"LayerSourceJson")&&(this.layerSourceJson=new i.Observable(n.getElementText(t,"LayerSourceJson")))):(this.queryDisplayOutputField=new i.Observable(null),this.queryValueOutputField=new i.Observable(null),this.queryServiceUrl=new i.Observable(null),this.queryWhereClause=new i.Observable(null),this.filterByInputGeometry=new i.Observable((!1)),this.queryCascadingID=new i.Observable(null),this.proxyUrl=new i.Observable(null),this.token=new i.Observable(null)),e.formDefinition&&e.formDefinition.map(e);var a=this.queryCascadingID.get();null!=a&&""!=a&&e.formDefinition.addCascading(a,e,function(e){e?this.queryTaskRunner.performQuery(e):(this.clearDataItems(),this.triggerCascading(null))}),e.isBusy||(e.isBusy=new i.Observable((!1))),e.isBusy.sync(this.isBusy)}return e.prototype.triggerCascading=function(e){this.cascadingEvent.publish(e)},e.prototype.isQueryable=function(){return null!=this.queryServiceUrl.get()&&""!==dojo.trim(this.queryServiceUrl.get())&&null!=this.queryWhereClause.get()&&""!==dojo.trim(this.queryWhereClause.get())&&null!=this.queryDisplayOutputField.get()&&""!==dojo.trim(this.queryDisplayOutputField.get())},e.prototype.performQuery=function(e,t){var i=this;if(this.isQueryable()&&(this.formItem.dataItems.clear(),null!=e)){var r=null;this.filterByInputGeometry.get()&&null!=this.formItem.formDefinition&&this.formItem.formDefinition.inputGeometry&&(r=this.formItem.formDefinition.inputGeometry);var n=this.queryServiceUrl.get();this.proxyUrl.get()&&void 0===esri.getProxyRule(n)&&esri.addProxyRule({proxyUrl:this.proxyUrl.get(),urlPrefix:n}),this.token&&this.token.get()&&(n=l.RestHelperHTTPService.appendTokenToUrl(n,this.token.get()));var c;if(this.layerSourceJson&&this.layerSourceJson.get()){var u=s.RestHelper.getJsonObjectFromJsonString(this.layerSourceJson.get()),p={source:s.RestHelper.getLayerSourceFromJsonObject(u)};c=new esri.tasks.QueryTask(n,p)}else c=new esri.tasks.QueryTask(n);var h=new esri.tasks.Query;h.returnGeometry=!1,h.geometry=r,h.outFields=[],h.where=this._getWhereClause(e),h.outFields.push(this.queryDisplayOutputField.get()),null!=this.queryValueOutputField.get()&&""!=dojo.trim(this.queryValueOutputField.get())&&this.queryValueOutputField.get()!=this.queryDisplayOutputField.get()&&h.outFields.push(this.queryValueOutputField.get());var d=h.outFields.every(function(e){return e.indexOf(".")!==-1});d||(h.returnDistinctValues=!0),this.isBusy.set(!0),++this._queryId,function(){var e=i._queryId;c.execute(h,function(r){function n(e){return e.display+"-"+e.value}var s=[];if(e==i._queryId){for(var l=0;l<r.features.length;++l){var c=r.features[l].attributes,u=null;null!=i.queryDisplayOutputField.get()&&(u=c[i.queryDisplayOutputField.get().trim()]);var p;p=null!=i.queryValueOutputField.get()&&""!=dojo.trim(i.queryValueOutputField.get())&&i.queryValueOutputField.get()!=i.queryDisplayOutputField.get()?c[i.queryValueOutputField.get().trim()]:u,s.push(new a.DataItem(u,p,null))}if(s.sort(function(e,t){return e.display<t.display?-1:1}),i.formatCallback){var h=o.EsriFieldTypes.esriFieldTypeString;if(r.fields){var d=r.fields.filter(function(e){return e.name===i.queryDisplayOutputField.get()})[0];d&&(h=d.type)}s.forEach(function(e){e.display=i.formatCallback(e.display,h)})}i.formItem.prepareForResults&&i.formItem.prepareForResults();for(var f={},y=[],m=0;m<s.length;++m){var g=s[m],v=n(g);f.hasOwnProperty(v)||(f[v]=!0,y.push(g))}i.formItem.dataItems.addItems(y),i.isBusy.set(!1);var S=null;i.formItem.dataItems.getLength()>0&&(S=i.formItem.dataItems.getAt(0)),t===!0&&i.triggerCascading(null==S?null:S.value),i.formItem.handleResultsComplete&&i.formItem.handleResultsComplete()}})}()}},e.prototype._getWhereClause=function(e){var t=this,i=this.queryWhereClause.get();return i=i.replace(/{1:([a-zA-Z0-9]+)(:[a-zA-Z0-9]+)?}/g,function(e,i,r){var n=t.formItem.formDefinition.getFormItemById(i);if(!n)return"{unknown form item "+i+"}";var s=n.getResult().value;if(!r)return s;if(":SQL"===r)return t._escapeForWhere(s);var a=/:[fF](\d+)/.exec(r);return a?parseFloat(s).toFixed(+a[1]):"{unknown format clause "+r+"}"}),i=i.format(this._escapeForWhere(e))},e.prototype._escapeForWhere=function(e){return e&&"number"==typeof e&&(e=e.toString()),(e||"").replace(/\'/g,"''")},e}();t.QueryTaskRunner=c})},"geocortex/forms/items/AutoCompleteBoxFormItem":function(){define(["require","exports","geocortex/forms/items/TextBoxFormItem","geocortex/forms/items/QueryTaskFormItem","geocortex/framework/observables","geocortex/forms","geocortex/forms/items/DataItemsFormItem"],function(e,t,i,r,n,s,a){"use strict";var o=function(e){function t(t,i){var o=e.call(this,t,i)||this;return o.isBusy=new n.Observable((!1)),o.formItemType="AutoCompleteBoxFormItem",t?(o.minimumPrefixLength=new n.Observable(parseInt(s.getElementText(t,"MinimumPrefixLength"))),o.minimumPopulateDelay=new n.Observable(parseInt(s.getElementText(t,"MinimumPopulateDelay")))):(o.minimumPrefixLength=new n.Observable(3),o.minimumPopulateDelay=new n.Observable(200)),a.initDataItemsFormItem(o,t,i),o.queryTaskRunner=new r.QueryTaskRunner(o,t,i),o}return __extends(t,e),t.prototype.clearDataItems=function(){this.dataItems.clear()},t}(i.TextBoxFormItem);t.AutoCompleteBoxFormItem=o})},"geocortex/forms/items/CheckBoxFormItem":function(){define(["require","exports","geocortex/forms/items/FormItem","geocortex/framework/observables","geocortex/forms","geocortex/forms/items/FormItemResult"],function(e,t,i,r,n,s){"use strict";var a=function(e){function t(t,i){var s=e.call(this,t,i)||this;return s.formItemType="CheckBoxFormItem",t?(s.text=new r.Observable(n.getElementText(t,"Text")),s.checked=new r.Observable(n._parseBoolean(n.getElementText(t,"Checked"))),s.textLocation=new r.Observable(n.getElementText(t,"TextLocation"))):(s.text=new r.Observable(""),s.checked=new r.Observable((!1)),s.textLocation=new r.Observable("Right")),s.checked.bind(null,function(e){return s._notifyResultChanged()}),s}return __extends(t,e),t.prototype.getResult=function(){return new s.FormItemResult(this.argumentName.get(),this.checked.get())},t.prototype._render=function(){return n.renderFormItem(this)},t}(i.AbstractFormItem);t.CheckBoxFormItem=a})},"geocortex/forms/items/ComboBoxFormItem":function(){define(["require","exports","geocortex/forms/items/FormItem","geocortex/forms/items/LabelContainer","geocortex/forms/items/QueryTaskFormItem","geocortex/framework/observables","geocortex/forms/DataItem","geocortex/forms/items/DataItemsFormItem","geocortex/forms","geocortex/forms/items/FormItemResult"],function(e,t,i,r,n,s,a,o,l,c){"use strict";var u=function(e){function t(t,i){var a=e.call(this,t,i)||this;if(a._defaultSet=!1,a.selectText=new s.Observable,a.selected=new s.Observable,a.defaultSelectedValue=new s.Observable,a.isBusy=new s.Observable((!1)),a.formItemType="ComboBoxFormItem",r.initLabelContainer(a,t,i),o.initDataItemsFormItem(a,t,i),a.queryTaskRunner=new n.QueryTaskRunner(a,t,i),t){var c=l.getElementText(t,"SelectText");c&&a.selectText.set(c);var u=l.getElementText(t,"SelectedValue");u&&a.defaultSelectedValue.set(u)}a.selected.bind(null,function(e){return a._notifyResultChanged()}),a.prepareForResults(),a.queryTaskRunner.isQueryable()||a._selectDefaultValue();var p=a.queryTaskRunner.queryCascadingID.get();return null!=p&&""!=p||a.queryTaskRunner.performQuery(""),a}return __extends(t,e),t.prototype.clearDataItems=function(){this.dataItems.clear(),this.selected.set(null),this._defaultSet=!1},t.prototype._hasRealDataItem=function(){return null!=this.selected.get()},t.prototype.triggerCascading=function(e){null!=this.selected.get()&&e||this.queryTaskRunner.cascadingEvent.publish(null);var t=this.selected.get();null===t&&(t=e),null===t||void 0===t?this.queryTaskRunner.cascadingEvent.publish(null):this.queryTaskRunner.cascadingEvent.publish(t.value)},t.prototype.prepareForResults=function(){if(this.selectText.get()){var e=this.selectText.get(),t=new a.DataItem(e,"",null);this.dataItems.insertItem(0,t)}},t.prototype.handleResultsComplete=function(){this._defaultSet||(this._selectDefaultValue(),null!=this.selected.get()&&(this._defaultSet=!0,this.triggerCascading(this.selected.get())))},t.prototype.getResult=function(){if(null==this.selected.get())return new c.FormItemResult(this.argumentName.get(),null);var e=this.selected.get();return e?new c.FormItemResult(this.argumentName.get(),e.getValue()):new c.FormItemResult(this.argumentName.get(),null)},t.prototype._addOption=function(e,t){this.dataItems.addItem(new a.DataItem(e,t))},t.prototype._selectDefaultValue=function(){var e=dojo.filter(this.dataItems.getItems(),dojo.hitch(this,function(e){return!!this.defaultSelectedValue.get()&&e.value+""==this.defaultSelectedValue.get()+""}));e.length>0?this.selected.set(e[0]):this.dataItems.length()>0&&this.selected.set(this.dataItems.getAt(0))},t.prototype._render=function(){return l.renderFormItem(this)},t}(i.AbstractFormItem);t.ComboBoxFormItem=u})},"geocortex/forms/items/TimePickerFormItem":function(){define(["require","exports","geocortex/forms/items/FormItem","geocortex/forms/items/LabelContainer","geocortex/framework/observables","geocortex/forms","geocortex/framework/utils/DateUtils","geocortex/forms/items/FormItemResult"],function(e,t,i,r,n,s,a,o){"use strict";var l=function(e){function t(t,i){var o=e.call(this,t,i)||this;if(o.initialTime=new n.Observable,o.nullable=new n.Observable((!1)),o.timeFormat=new n.Observable,o.jQueryPickerTimeAsInfoMsg=new n.Observable((!1)),o.formItemType="TimePickerFormItem",r.initLabelContainer(o,t,i),t){for(var l=!0,c=t.getElementsByTagNameNS?t.getElementsByTagNameNS("http://schemas.datacontract.org/2004/07/Geocortex.Forms.Client.Items.Validation","ValidationItem"):t.getElementsByTagName("ValidationItem"),u=0;u<c.length;u++){var p=c[u].getAttributeNS("http://www.w3.org/2001/XMLSchema-instance","type");if(p&&p.indexOf("RequiredValidationItem")>=0){l=!1;break}}o.nullable.set(l);var h=s.getElementText(t,"jQueryPickerTimeAsInfoMsg");h&&o.jQueryPickerTimeAsInfoMsg.set("true"===h);var d=!0,f=s.getElementText(t,"InitialTime");d=null===s.getElementText(t,"InitializeWithCurrentTime")?!f:"true"===s.getElementText(t,"InitializeWithCurrentTime"),d?o.initialTime.set(new Date):f?(a.containsTimezone(f)||(f+=a.getTimezoneString()),o.initialTime.set(Date.fromISO(f))):o.initialTime.set(null),o.timeFormat.set(s.getElementText(t,"TimeFormat"))}else o.timeFormat.set("LongTime"),o.initialTime.set(new Date);return o.time=new n.Observable(o.initialTime.get()),o.time.bind(null,function(e){return o._notifyResultChanged()}),o}return __extends(t,e),t.prototype.getResult=function(){var e=this.time.get();return e&&(e=new Date(e.toString()),e="/Date({0})/".format(e.getTime())),new o.FormItemResult(this.argumentName.get(),e)},t.prototype._render=function(){return s.renderFormItem(this)},t}(i.AbstractFormItem);t.TimePickerFormItem=l})},"geocortex/forms/items/DatePickerFormItem":function(){define(["require","exports","geocortex/forms/items/FormItem","geocortex/forms/items/LabelContainer","geocortex/framework/observables","geocortex/forms/items/TimePickerFormItem","geocortex/forms","geocortex/framework/utils/DateUtils","geocortex/forms/items/FormItemResult"],function(e,t,i,r,n,s,a,o,l){"use strict";var c=function(e){function t(t,i){var l=e.call(this,t,i)||this;l.nullable=new n.Observable((!1)),l.formItemType="DatePickerFormItem",r.initLabelContainer(l,t,i);var c=!0;if(t){for(var u=!0,p=t.getElementsByTagNameNS?t.getElementsByTagNameNS("http://schemas.datacontract.org/2004/07/Geocortex.Forms.Client.Items.Validation","ValidationItem"):t.getElementsByTagName("ValidationItem"),h=0;h<p.length;h++){var d=p[h].getAttributeNS("http://www.w3.org/2001/XMLSchema-instance","type");if(d&&d.indexOf("RequiredValidationItem")>=0){u=!1;break}}l.nullable.set(u),l.dateFormat=new n.Observable(a.getElementText(t,"DateFormat")),l.includeTimePicker=new n.Observable("true"===a.getElementText(t,"IncludeTimePicker"));var f=null;l.includeTimePicker.get()&&(l.timePickerItem=new s.TimePickerFormItem(a.getElement(t,"TimePickerItem")),f=l.timePickerItem.initialTime.get());var y=a.getElementText(t,"InitialDate");if(c=null===a.getElementText(t,"InitializeWithCurrentDate")?!y:"true"===a.getElementText(t,"InitializeWithCurrentDate"),y){if(o.containsTimezone(y)){var m=Math.max(y.lastIndexOf("Z"),y.lastIndexOf("+"),y.lastIndexOf("-"));m>0&&(y=y.substring(0,m))}y+=o.getTimezoneString()}var g=null;(c||y)&&(g=new Date(y)),g&&!isNaN(g.getTime())?(g.getTimezoneOffset()!=o.getTimezoneOffset()&&g.setTime(g.getTime()-6e4*(o.getTimezoneOffset()-g.getTimezoneOffset())),f&&(g.setHours(f.getHours()),g.setMinutes(f.getMinutes()),g.setSeconds(f.getSeconds())),l.initialDate=new n.Observable(g)):l.initialDate=new n.Observable(f)}else l.dateFormat=new n.Observable,l.initialDate=new n.Observable(null),l.includeTimePicker=new n.Observable((!1));if(c){var v=new Date;l.includeTimePicker.get()||(v.setHours(0),v.setMinutes(0),v.setSeconds(0)),l.date=new n.Observable(v),l.initialDate.set(v)}else l.date=new n.Observable(l.initialDate.get());return l.date.bind(null,function(e){return l._notifyResultChanged()}),l}return __extends(t,e),t.prototype.getResult=function(){var e=this.date.get(),t=null===e?null:new Date(e.toString());if(t)if(isNaN(t.getTime()))t=this.initialDate.get();else{var i=0,r=!this.attached_pickerType||!this.attached_pickerType.get||this.attached_pickerType.get().toLowerCase().indexOf("native")>-1;e instanceof Date||this.includeTimePicker.get()||!r||(i=6e4*t.getTimezoneOffset()),t="/Date({0})/".format(t.getTime()+i)}return new l.FormItemResult(this.argumentName.get(),t)},t.prototype._render=function(){return a.renderFormItem(this)},t}(i.AbstractFormItem);t.DatePickerFormItem=c})},"geocortex/forms/items/FilePickerFormItem":function(){define(["require","exports","geocortex/forms/items/FormItem","geocortex/forms/items/LabelContainer","geocortex/framework/observables","geocortex/forms","geocortex/forms/items/FormItemResult","geocortex/workflow/ArgumentValueWrapper"],function(e,t,i,r,n,s,a,o){"use strict";var l=function(e){function t(t,i){var a=e.call(this,t,i)||this;return a.files=new n.ObservableCollection,a.formItemType="FilePickerFormItem",a.isSupported=new n.Observable("undefined"!=typeof FileReader&&a._isFileInputSupported()),t?(a.acceptFileTypes=new n.Observable(s.getElementText(t,"AcceptFileTypes")),a.allowMultiple=new n.Observable(s._parseBoolean(s.getElementText(t,"AllowMultiple")))):(a.acceptFileTypes=new n.Observable(null),a.allowMultiple=new n.Observable((!1))),r.initLabelContainer(a,t,i),a.files.bind(null,function(e){return a._notifyResultChanged()}),a}return __extends(t,e),t.prototype.clear=function(){this.files.clear(),this.refresh()},t.prototype.getResult=function(){for(var e=[],t=0;t<this.files.getLength();++t){var i=this.files.getAt(t);i&&e.push(i)}var r=new o.ArgumentValueWrapper("System.Collections.Generic.List`1[[Geocortex.Forms.Client.FileItem, Geocortex.EssentialsWpfApi]]",e),n=new a.FormItemResult(this.argumentName.get(),r,(!0));return n.isList=!0,n},t.prototype._render=function(){return s.renderFormItem(this)},t.prototype._isFileInputSupported=function(){if(navigator.userAgent.match(/(Android (1.0|1.1|1.5|1.6|2.0|2.1))|(Windows Phone (OS 7|8.0))|(XBLWP)|(ZuneWP)|(w(eb)?OSBrowser)|(webOS)|(Kindle\/(1.0|2.0|2.5|3.0))/))return!1;var e=document.createElement("input");return e.type="file",!e.disabled},t}(i.AbstractFormItem);t.FilePickerFormItem=l})},"geocortex/forms/items/GroupBoxFormItem":function(){define(["require","exports","geocortex/forms/items/ContainerFormItem","geocortex/framework/observables","geocortex/forms"],function(e,t,i,r,n){"use strict";var s=function(e){function t(t,i){var s=e.call(this,t,i)||this;return s.formItemType="GroupBoxFormItem",t?s.header=new r.Observable(n.getElementText(t,"Header")):s.header=new r.Observable(null),s}return __extends(t,e),t.prototype._render=function(){return n.renderFormItem(this)},t.prototype.getDisplayName=function(){return this.header.get()},t}(i.ContainerFormItem);t.GroupBoxFormItem=s})},"geocortex/forms/items/HyperlinkFormItem":function(){define(["require","exports","geocortex/forms/items/FormItem","geocortex/framework/observables","geocortex/forms","geocortex/forms/items/FormItemResult"],function(e,t,i,r,n,s){"use strict";var a=function(e){function t(t,i){var s=e.call(this,t,i)||this;return s.wasClicked=new r.Observable((!1)),s.formItemType="HyperlinkFormItem",t?(s.hyperlinkText=new r.Observable(n.getElementText(t,"HyperlinkText")),s.target=new r.Observable(n.getElementText(t,"Target")),s.uri=new r.Observable(n.getElementText(t,"Uri"))):(s.hyperlinkText=new r.Observable("Hyperlink"),s.target=new r.Observable("_blank"),s.uri=new r.Observable("")),s.wasClicked.bind(null,function(e){return s._notifyResultChanged()}),s}return __extends(t,e),t.prototype.getResult=function(){return new s.FormItemResult(this.argumentName.get(),this.wasClicked.get(),this.wasClicked.get())},t.prototype._render=function(){return n.renderFormItem(this)},t}(i.AbstractFormItem);t.HyperlinkFormItem=a})},"geocortex/forms/items/ImageFormItem":function(){define(["require","exports","geocortex/forms/items/FormItem","geocortex/framework/observables","geocortex/forms"],function(e,t,i,r,n){"use strict";var s=function(e){function t(t,i){var s=e.call(this,t,i)||this;if(s.formItemType="ImageFormItem",t){s.source=new r.Observable(n.getElementText(t,"Source")),s.width=new r.Observable(n.getElementText(t,"Width")),s.height=new r.Observable(n.getElementText(t,"Height"));var a=s.width.get(),o=s.height.get();a&&o?parseInt(a)>parseInt(o)?s.height.set("auto"):s.width.set("auto"):(s.width=new r.Observable("auto"),s.height=new r.Observable("auto"))}else s.source=new r.Observable(""),s.width=new r.Observable("auto"),s.height=new r.Observable("auto");return s}return __extends(t,e),t.prototype._render=function(){return n.renderFormItem(this)},t}(i.AbstractFormItem);t.ImageFormItem=s})},"geocortex/forms/items/ListBoxFormItem":function(){define(["require","exports","geocortex/forms/items/FormItem","geocortex/forms/items/LabelContainer","geocortex/forms/items/QueryTaskFormItem","geocortex/forms/items/LabelFormItem","geocortex/framework/observables","geocortex/forms/items/DataItemsFormItem","geocortex/forms","geocortex/forms/items/FormItemResult"],function(e,t,i,r,n,s,a,o,l,c){"use strict";var u=function(e){function t(t,i){var c=e.call(this,t,i)||this;if(c.selection=new a.ObservableCollection,c.selectedValues=new a.ObservableCollection,c._selectedValuesLookup=null,c.isBusy=new a.Observable((!1)),c.formItemType="ListBoxFormItem",r.initLabelContainer(c,t,i),o.initDataItemsFormItem(c,t,i),c.size=new a.Observable(6),t){c.maxHeight=new a.Observable(parseInt(l.getElementText(t,"MaxHeight"))),c.selectionMode=new a.Observable(l.getElementText(t,"SelectionMode"));var u=l.getElementText(t,"Size");if(u){var p=parseInt(u);p>0&&c.size.set(p)}var h=l.getElement(t,"SelectedValues");if(h){c._selectedValuesLookup={};var d;for(d=0;d<h.childNodes.length;d++){var f=h.childNodes[d].textContent;c.selectedValues.addItem(f),c._selectedValuesLookup[f+""]=!0}c._setDefaults(),0===c.selection.length()&&0!==c.dataItems.getItems().length&&c.selection.addItem(c.dataItems.getAt(0))}}else c.label=new s.LabelFormItem(null,c.formDefinition),c.maxHeight=new a.Observable(NaN),c.selectionMode=new a.Observable("Single");c.queryTaskRunner=new n.QueryTaskRunner(c,t,i);var y=c.queryTaskRunner.queryCascadingID.get();return y||c.queryTaskRunner.performQuery(""),c.selection.bind(null,function(e){setTimeout(function(){c._notifyResultChanged()},0)}),c}return __extends(t,e),t.prototype.clearDataItems=function(){this.dataItems.clear()},t.prototype._setDefaults=function(){for(var e=0;e<this.dataItems.getItems().length;e++){var t=this.dataItems.getAt(e);this._selectedValuesLookup[t.value.toString()]&&this.selection.addItem(t)}},t.prototype.handleResultsComplete=function(){this._setDefaults()},t.prototype.triggerCascading=function(e){null!=this.selection&&e||this.queryTaskRunner.cascadingEvent.publish(null);var t=null;null!=this.selection&&(t=this.selection.getAt(0)),null==t&&null!=e&&(t=e),null==t?this.queryTaskRunner.cascadingEvent.publish(null):this.queryTaskRunner.cascadingEvent.publish(t.value)},t.prototype.getResult=function(){var e=null;if("single"==this.selectionMode.get().toLowerCase()){if(this.selection.getLength()>0){var t=this.selection.getAt(0);e=t?t.getValue():null}return new c.FormItemResult(this.argumentName.get(),e,(!0))}for(var i=[],r=0;r<this.selection.getLength();++r){var t=this.selection.getAt(r);e=t?t.getValue():null,e&&i.push(e)}return e=new c.FormItemResult(this.argumentName.get(),i,(!0)),e.isList=!0,e},t.prototype._render=function(){return l.renderFormItem(this)},t}(i.AbstractFormItem);t.ListBoxFormItem=u})},"geocortex/forms/items/MarkdownFormItem":function(){define(["require","exports","geocortex/forms/items/FormItem","geocortex/framework/observables","geocortex/forms"],function(e,t,i,r,n){"use strict";var s=function(e){function t(t,i){var s=e.call(this,t,i)||this;return s.formItemType="MarkdownFormItem",t?s.plainText=new r.Observable(n.getElementText(t,"PlainText")):s.plainText=new r.Observable(""),s}return __extends(t,e),t.prototype._render=function(){return n.renderFormItem(this)},t}(i.AbstractFormItem);t.MarkdownFormItem=s})},"geocortex/forms/items/RadioButtonFormItem":function(){define(["require","exports","geocortex/forms/items/FormItem","geocortex/framework/observables","geocortex/forms","geocortex/forms/items/FormItemResult","geocortex/forms/items/ContainerFormItem"],function(e,t,i,r,n,s,a){"use strict";var o=function(e){function t(i,s){var a=e.call(this,i,s)||this;return a.formItemType="RadioButtonFormItem",i?(a.text=new r.Observable(n.getElementText(i,"Text")),a.checked=new r.Observable(n._parseBoolean(n.getElementText(i,"Checked"))),a.textLocation=new r.Observable(n.getElementText(i,"TextLocation")),a.groupName=new r.Observable(n.getElementText(i,"GroupName"))):(a.text=new r.Observable(null),a.checked=new r.Observable((!1)),a.textLocation=new r.Observable("Right"),a.groupName=new r.Observable(null)),a.checked.bind(null,function(e){e&&t._findButtonsInGroup(a.groupName.get(),a.formDefinition.containerFormItem).forEach(function(e){e!==a&&e.checked.set(!1)}),a._notifyResultChanged()}),a}return __extends(t,e),t.prototype.getResult=function(){var e=this.__getRadioValueClosure,t=!!e&&e();return new s.FormItemResult(this.argumentName.get(),t)},t.prototype._render=function(){return n.renderFormItem(this)},t._findButtonsInGroup=function(e,i){var r=[];return i&&i.formItems.get().forEach(function(i){i instanceof t?i.groupName.get()===e&&r.push(i):i instanceof a.ContainerFormItem&&t._findButtonsInGroup(e,i).forEach(function(e){return r.push(e)})}),r},t}(i.AbstractFormItem);t.RadioButtonFormItem=o})},"geocortex/forms/items/TextAreaFormItem":function(){define(["require","exports","geocortex/forms/items/TextBoxFormItem","geocortex/framework/observables","geocortex/forms"],function(e,t,i,r,n){"use strict";var s=function(e){function t(t,i){var s=e.call(this,t,i)||this;return s.formItemType="TextAreaFormItem",t?s.textboxHeight=new r.Observable(parseInt(n.getElementText(t,"TextboxHeight"))):s.textboxHeight=new r.Observable(1),s}return __extends(t,e),t}(i.TextBoxFormItem);t.TextAreaFormItem=s})},"geocortex/forms/items":function(){define(["require","exports","geocortex/forms/getItemType","geocortex/forms/items/AutoCompleteBoxFormItem","geocortex/forms/items/CheckBoxFormItem","geocortex/forms/items/ContainerFormItem","geocortex/forms/items/ComboBoxFormItem","geocortex/forms/items/DatePickerFormItem","geocortex/forms/items/FilePickerFormItem","geocortex/forms/items/GroupBoxFormItem","geocortex/forms/items/HyperlinkFormItem","geocortex/forms/items/ImageFormItem","geocortex/forms/items/ListBoxFormItem","geocortex/forms/items/MarkdownFormItem","geocortex/forms/items/RadioButtonFormItem","geocortex/forms/items/TextAreaFormItem","geocortex/forms/items/TextBoxFormItem","geocortex/forms/items/TimePickerFormItem"],function(e,t,i,r,n,s,a,o,l,c,u,p,h,d,f,y,m,g){"use strict";function v(e,t){var S=i.getItemType(e),x=null;switch(S){case"AutoCompleteBoxFormItem":x=new r.AutoCompleteBoxFormItem(e,t);break;case"CheckBoxFormItem":x=new n.CheckBoxFormItem(e,t);break;case"ContainerFormItem":x=new s.ContainerFormItem(e,t),x.createElementDelegate=function(e,t){return v(e,t)};break;case"ComboBoxFormItem":x=new a.ComboBoxFormItem(e,t);break;case"DatePickerFormItem":x=new o.DatePickerFormItem(e,t);break;case"FilePickerFormItem":x=new l.FilePickerFormItem(e,t);break;case"GroupBoxFormItem":x=new c.GroupBoxFormItem(e,t);break;case"HyperlinkFormItem":x=new u.HyperlinkFormItem(e,t);break;case"ImageFormItem":x=new p.ImageFormItem(e,t);break;case"ListBoxFormItem":x=new h.ListBoxFormItem(e,t);break;case"MarkdownFormItem":x=new d.MarkdownFormItem(e,t);break;case"RadioButtonFormItem":x=new f.RadioButtonFormItem(e,t);break;case"TextAreaFormItem":x=new y.TextAreaFormItem(e,t);break;case"TextBoxFormItem":x=new m.TextBoxFormItem(e,t);break;case"TimePickerFormItem":x=new g.TimePickerFormItem(e,t)}return x.dataItems&&null!=t&&null!=t.inputData&&t.inputData.hasOwnProperty(x.itemID)&&x.dataItems.addItems(t.inputData.item(x.itemID)),x}t._processFormItem=v})},"geocortex/forms/FormDefinition":function(){define(["require","exports","geocortex/framework/observables","geocortex/forms","geocortex/forms/items/ContainerFormItem","geocortex/forms/items"],function(e,t,i,r,n,s){"use strict";var a=function(){function e(e,t,a){this.version=null,this.inputData=null,this.containerFormItem=null,this.inputGeometry=null,this.knownTypes=null,this._formManager=null,this._version=1.1,this._formContainer=null,this._cascadingMap=null,this._controlMap=null,this.knownTypes=[],this.inputData=t,this.version=this._version,this._controlMap={},this._cascadingMap={},this.createElementDelegate=function(e,t){return s._processFormItem(e,t)};var o=null;if(e&&(o=dojox.xml.parser.parse(e)),a&&(this.inputGeometry=a),null!=o){var l=o.documentElement,c=r.getElementText(l,"Version");if(parseFloat(c)>this._version)throw new Error("Form version "+c+" is incompatible with current API version "+this._version);this.title=new i.Observable(r.getElementText(l,"Title")),this.maxWidth=new i.Observable(parseInt(r.getElementText(l,"MaxWidth"))),this.maxHeight=new i.Observable(parseInt(r.getElementText(l,"MaxHeight")));var u=r.getElement(l,"KnownTypes");if(null!=u)for(var p=0;p<u.childNodes.length;p++)this.knownTypes.push(u.childNodes[p].firstChild.data);this.containerFormItem=new n.ContainerFormItem(r.getElement(l,"ContainerFormItem"),this)}else this.containerFormItem=new n.ContainerFormItem(null,this),this.containerFormItem.itemID=new i.Observable("Group1"),this.title=new i.Observable(""),this.maxWidth=new i.Observable(NaN),this.maxHeight=new i.Observable(NaN);for(var h in this._cascadingMap)if(this._cascadingMap.hasOwnProperty(h))for(var p=0;p<this._cascadingMap[h].length;++p){var d=this._cascadingMap[h][p],f=this._controlMap[h];f.queryTaskRunner.cascadingEvent.subscribe(d.formItem,d.handler)}}return e.prototype.addCascading=function(e,t,i){0==this._cascadingMap.hasOwnProperty(e)&&(this._cascadingMap[e]=[]),this._cascadingMap[e].push({formItem:t,handler:i})},e.prototype.map=function(e){this._controlMap[e.itemID.get()]=e},e.prototype.render=function(e){},e.prototype.validate=function(){return this.containerFormItem.validate()},e.prototype.getResults=function(){return this.containerFormItem._getResults()},e.prototype.destroy=function(){this.containerFormItem._destroy()},e.prototype.getFormItemById=function(e){return this.containerFormItem.getFormItemById(e)},e}();t.FormDefinition=a})},"geocortex/workflow/DefaultActivityHandlers":function(){define(["require","exports","geocortex/workflow/MapServiceActivityHandlers","geocortex/essentials/ReportParameters","geocortex/essentials/TextField","geocortex/essentials/RestHelper","geocortex/forms/FormDefinition","geocortex/forms/items/TextBoxFormItem","geocortex/forms/items/TextAreaFormItem","geocortex/forms/items/LabelFormItem","geocortex/essentials/MapServiceConstants"],function(e,t,i,r,n,s,a,o,l,c,u){"use strict";function p(e,t){for(var i in e)if(e.hasOwnProperty(i)&&i.toLowerCase()===t.toLowerCase())return i;return null}function h(e){function t(e){var t=null;if(L&&e)for(var i=0;i<L.length;i++){var r=L[i];if(r.Key===e.displayName||"tf_"+r.Key===e.id||r.Key===e.id){t=r;break}}return t}var a=e.getValue("MapServiceId"),o=e.getValue("LayerId"),l=e.getValue("LayerName"),c=e.getValue("ReportId"),u=null,p=e.getSite();if(p&&a&&(o||l)&&c){var h=i.findMapServiceById(p,a);if(h){var d=null;o?d=h.findLayerById(o):l&&(d=h.findLayerByName(l)),null!=d&&(u=d.findReportById(c))}}if(!u)return void e.dispatcher().handleError(new Error("Cannot find report '"+c+"'"),e);var f=new esri.tasks.Query,y=new r.ReportParameters,m=e.getValue("ShowOpenReport"),g=e.getValue("Geometry"),v=e.getValue("OutSpatialReference"),S=e.getValue("Text"),x=e.getValue("Where"),b=e.getValue("OutputFormat"),I=e.getValue("Resolution"),w=e.getValue("CustomExtent"),E=e.getValue("SpatialRelationship"),_=e.getValue("ReportExtentType"),T=e.getValue("NotificationEmailAddress"),L=e.getValue("TextFields");if(_||(_=r.ReportParameters.CURRENT_EXTENT),y.extentType=_,b&&(y.outputFormat=b),u.textFields)for(var D in u.textFields)if(u.textFields.hasOwnProperty(D)){var C=u.textFields[D],R=t(C);null!=R?y.fields.push(new n.TextField(C.id,C.displayName,R.Value,C.multiline)):y.fields.push(C)}T&&(y.notificationEmailAddress=T),I&&(y.resolution=I),w&&(y.customExtent=w),f.spatialRelationship=s.RestHelper._convertSpatialRelationshipFromDotnetIndex(E),g&&(f.geometry=g),v&&(f.outSpatialReference=v),S&&(f.text=S),x&&(f.where=x),u.run(f,y,function(t){var i=t?t.href:null;m&&i&&i.length>0&&e.dispatcher().handleOpenReportUrl(i,e),e.setValue("ResultUrl",i),e.completeActivity()},function(t){e.dispatcher().handleError(new Error("Error running report '"+t.message+"'"),e)})}function d(e,t,i){var r=new a.FormDefinition;r.maxHeight.set(600),r.maxWidth.set(500);var n;if(t?(r.title.set("Debug - Input Arguments for "+e.getDisplayName()),r.containerFormItem.description.set("Input Arguments:"),n=e.getInputNames()):(r.title.set("Debug - Output Arguments for "+e.getDisplayName()),
r.containerFormItem.description.set("Output Arguments:"),n=e.getOutputNames()),null!=n&&n.length>0)for(var s=0;s<n.length;s++){var u,p=n[s];u=t?e.getValue(p):e.getOutputValue(p),u&&"object"==typeof u&&(u=t?e.getJsonValue(p):e.getOutputJsonValue(p));var h;!u||String(u).length<100&&String(u).indexOf("\n")==-1?h=new o.TextBoxFormItem(null,r):(h=new l.TextAreaFormItem(null,r),h.textboxHeight.set(100)),h.label=new c.LabelFormItem(null,r),h.text.set(u),h.textboxWidth.set(300),h.label.text.set(p),h.readOnly.set(!0),r.containerFormItem.formItems.addItem(h)}var d=e.dispatcher();d&&"function"==typeof d._showDebugHandler?d._showDebugHandler(r,i):i&&i()}function f(e){e.setValue("Url",window.location.href),e.completeActivity()}function y(e){var t=e.getValue("Milliseconds");if(null==t)throw new Error("External Delay: required Milliseconds argument was not supplied.");setTimeout(function(){e.completeActivity()},t)}function m(e){var t=new Date;e.setValue("UtcOffset",t.getTimezoneOffset()*-6e4),e.completeActivity()}function g(e){var t=e.getValue("GeoprocessorUrl"),i=(e.getValue("Token"),e.getValue("ProxyURL"),e.getValue("UpdateDelay")),r=e.getValue("JobId"),n=!1;if(!t)throw new Error("GeoprocessorUrl parameter is missing.");if(!r)throw new Error("JobId parameter is missing.");var s=new esri.tasks.Geoprocessor(t);i>0&&s.setUpdateDelay(i),dojo.connect(s,"onError",function(t){e.setValue("Result",v(esri.tasks.JobInfo.STATUS_FAILED)),e.completeActivity()}),dojo.connect(s,"onStatusUpdate",function(t){if(!n){var a=t.jobStatus;a==esri.tasks.JobInfo.STATUS_CANCELLED||a==esri.tasks.JobInfo.STATUS_DELETED||a==esri.tasks.JobInfo.STATUS_FAILED||a==esri.tasks.JobInfo.STATUS_SUCCEEDED||a==esri.tasks.JobInfo.STATUS_TIMED_OUT?(n=!0,e.setValue("Result",v(a)),e.completeActivity()):window.setTimeout(function(){s.checkJobStatus(r)},i)}}),s.checkJobStatus(r)}function v(e){switch(e){case"esriJobNew":return 0;case"esriJobSubmitted":return 1;case"esriJobWaiting":return 2;case"esriJobExecuting":return 3;case"esriJobSucceeded":return 4;case"esriJobFailed":return 5;case"esriJobTimedOut":return 6;case"esriJobCancelling":return 7;case"esriJobCancelled":return 8;case"esriJobDeleting":return 9;case"esriJobDeleted":return 10;default:return-1}}function S(e){if(!e)throw new Error("Get Map Service Info: required context was not supplied.");var t=e.getValue("PropertyName");if(null==t)throw new Error("Provide a Property Name: No property name available.");var i=e.getSite();if(!i)throw new Error("Set Layer Visibility: No site available.");for(var r=[],n=i.essentialsMap.mapServices,s={mapServiceUrl:"",mapServiceId:"",token:"",isVisible:!1,isDynamic:!1,propertyValue:null,id:"",name:"",displayName:"",layerUrl:""},a=null,o=0;o<n.length;o++)for(var l=n[o].layers.concat(n[o].tables),c=0;c<l.length;c++)if(void 0!=l[c].properties[t]){if(s.mapServiceUrl=n[o].serviceUrl,s.mapServiceId=n[o].id,s.token=n[o].serviceToken,s.isVisible=l[c].isVisible(),s.isDynamic=l[c].isDynamic,s.propertyValue=l[c].properties[t],s.id=l[c].id,s.name=l[c].name,s.displayName=l[c].displayName,n[o].mapServiceType===u.MapServiceType.FEATURE?s.layerUrl=s.mapServiceUrl:s.layerUrl=s.mapServiceUrl+"/"+(s.isDynamic?"dynamicLayer":s.id),s.isDynamic){var p=n[0].serviceLayer;if(p&&p.dynamicLayerInfos)for(var h=0;h<p.dynamicLayerInfos.length;h++)if(a=p.dynamicLayerInfos[h],a&&a.id.toString()===s.id){a.source&&(s.layerSourceJson=JSON.stringify(a.source.toJson()));break}}r.push(s),s={mapServiceUrl:"",mapServiceId:"",token:"",isVisible:!1,isDynamic:!1,propertyValue:null,id:"",name:"",displayName:"",layerUrl:""}}e.setValue("LayersInfo",r),e.completeActivity()}t.getPropertyIgnoreCase=p,t.handleReport=h,t.showDebug=d,t.handleGetBrowserUrl=f,t.handleExternalDelay=y,t.handleGetExternalTimeInfo=m,t.handleWaitForGeoprocessorJobComplete=g,t._getJobStatusCode=v,t.handleGetLayerInfoByProperty=S})},"geocortex/workflow/ActivityContext":function(){define(["require","exports","geocortex/workflow/ArgumentValueWrapper","geocortex/workflow/ArgumentInfo","geocortex/workflow/DefaultActivityHandlers","geocortex/workflow/WorkflowControllerProxy"],function(e,t,i,r,n,s){"use strict";var a=function(){function e(e,t,i,r){this.activityComplete=null,this._dispatcher=e,this._pendingIndex=t,this._workflow=i,this._workflowState=r}return e.prototype.dispatcher=function(){return this._dispatcher},e.prototype.workflow=function(){return this._workflow},e.prototype.getDisplayName=function(){return this._workflowState?this._workflowState.pendingExternalActivities[this._pendingIndex].displayName:""},e.prototype.getInputNames=function(){var e=[];if(this._workflowState)for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].inputs,i=0;i<t.length;i++)e.push(t[i].name);return e},e.prototype.getInputNamesByType=function(e){var t=[];if(this._workflowState)for(var i=this._workflowState.pendingExternalActivities[this._pendingIndex].inputs,r=0;r<i.length;r++)0===i[r].typeName.indexOf(e)&&t.push(i[r].name);return t},e.prototype.getOutputNames=function(){var e=[];if(this._workflowState)for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].outputs,i=0;i<t.length;i++)e.push(t[i].name);return e},e.prototype.getOutputNamesByType=function(e){var t=[];if(this._workflowState)for(var i=this._workflowState.pendingExternalActivities[this._pendingIndex].outputs,r=0;r<i.length;r++)0===i[r].typeName.indexOf(e)&&t.push(i[r].name);return t},e.prototype.getSite=function(){return null!=this._workflow?this._workflow.site:null},e.prototype.getEsriMap=function(){return null!=this._workflow&&null!=this._workflow.site?this._workflow.site.getMap():null},e.prototype.getValue=function(e){if(this._workflowState)for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].inputs,i=0;i<t.length;i++)if(t[i].name==e)return t[i].value;return null},e.prototype.getOutputValue=function(e){if(this._workflowState)for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].outputs,i=0;i<t.length;i++)if(t[i].name==e)return t[i].value;return null},e.prototype.getJsonValue=function(e){for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].inputs,i=0;i<t.length;i++)if(t[i].name==e)return JSON.stringify(t[i].value);return null},e.prototype.getOutputJsonValue=function(e){if(this._workflowState)for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].outputs,i=0;i<t.length;i++)if(t[i].name==e){var r=t[i].value;return r&&1===r.length&&(r=r[0]),JSON.stringify(r)}return null},e.prototype.setValue=function(e,t,n){if(this._workflowState){var s=!1,a=this._workflowState.pendingExternalActivities[this._pendingIndex].outputs,o=this._getRuntimeType(t);t&&t instanceof i.ArgumentValueWrapper&&(o=t.runtimeTypeName,t=t.value);for(var l=0;l<a.length;l++)if(a[l].name==e){s=!0;var c=a[l];c&&(c.value=t,null!=o&&(c.runtimeTypeName=o));break}if(!s&&n){o||(o="System.Object");var c=new r.ArgumentInfo;c.isRequired=!1,c.name=e,c.value=t,c.typeName=o,c.runtimeTypeName=o,this._workflowState.pendingExternalActivities[this._pendingIndex].outputs.push(c)}}},e.prototype.getActivityTypeName=function(){var e="";if(this._workflowState&&(e=this._workflowState.pendingExternalActivities[this._pendingIndex].typeName)){var t=e.indexOf("`");t>=0&&(e=e.substring(0,t))}return e},e.prototype.getActivityExternalId=function(){return this._workflowState?this._workflowState.pendingExternalActivities[this._pendingIndex].externalId:""},e.prototype.getInputArgumentTypeName=function(e){if(this._workflowState)for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].inputs,i=0;i<t.length;i++)if(t[i].name==e)return t[i].typeName;return""},e.prototype.getInputArgumentRuntimeTypeName=function(e){for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].inputs,i=0;i<t.length;i++)if(t[i].name==e)return t[i].runtimeTypeName;return""},e.prototype.completeActivity=function(){if(this._workflowState){var e=this._workflowState.pendingExternalActivities[this._pendingIndex];if(e.isComplete)return;var t=this;"debugger"==this.getActivityExternalId()||e&&e.debug?n.showDebug(this,!1,function(){t._completeActivityInternal()}):this._completeActivityInternal()}},e.prototype.abortActivity=function(){if(this._workflowState){var e=this._workflowState.pendingExternalActivities[this._pendingIndex];e.isAborted=!0,this._workflowState.status="Aborted: "+e.displayName}null!=this._dispatcher&&this._dispatcher.activityAbort(this)},e.prototype._completeActivityInternal=function(){if(this._workflowState){var e=this._workflowState.pendingExternalActivities[this._pendingIndex];e.isComplete=!0,null!=this._dispatcher&&this._dispatcher.activityComplete(this),e.inputs=null;var t=this._workflowState.pendingExternalActivities[this._pendingIndex].syncToken,i=!0;if(""!=t)for(var r=this._workflowState.pendingExternalActivities,n=0;n<r.length;n++)if(r[n].syncToken==t&&!r[n].isComplete){i=!1;break}i&&(s._executeWorkflow(this._workflow,this._dispatcher,this._workflowState,null,this),dojo.isFunction(this.activityComplete)&&this.activityComplete(this))}},e.prototype._getRuntimeType=function(e){var t="System.Object";return e&&("function"==typeof e.isInstanceOf?e.isInstanceOf(esri.geometry.Extent)?t="ESRI.ArcGIS.Client.Geometry.Envelope":e.isInstanceOf(esri.geometry.Extent)?t="ESRI.ArcGIS.Client.Geometry.Envelope":e.isInstanceOf(esri.geometry.Point)?t="ESRI.ArcGIS.Client.Geometry.MapPoint":e.isInstanceOf(esri.geometry.Multipoint)?t="ESRI.ArcGIS.Client.Geometry.MultiPoint":e.isInstanceOf(esri.geometry.Polygon)?t="ESRI.ArcGIS.Client.Geometry.Polygon":e.isInstanceOf(esri.geometry.Polyline)?t="ESRI.ArcGIS.Client.Geometry.Polyline":e.isInstanceOf(esri.geometry.Geometry)?t="ESRI.ArcGIS.Client.Geometry.Geometry":e.isInstanceOf(esri.layers.LayerDataSource)?t="ESRI.ArcGIS.Client.LayerDataSource":e.isInstanceOf(esri.layers.LayerMapSource)&&(t="ESRI.ArcGIS.Client.LayerMapSource"):"string"==typeof e?t="System.String":"number"==typeof e?t="System.Double":"boolean"==typeof e?t="System.Boolean":"object"==typeof e&&(t="function"==typeof e.getMonth?"System.DateTime":"System.Object")),t},e}();t.ActivityContext=a})},"geocortex/workflow/ActivityDispatcher":function(){define(["require","exports"],function(e,t){"use strict"})},"geocortex/workflow/WorkflowControllerProxy":function(){define(["require","exports","geocortex/workflow/WorkflowState","geocortex/workflow/ActivityContext","geocortex/geocortex","geocortex/workflow/DefaultActivityHandlers","geocortex/workflow/ExternalActivityInfo","geocortex/workflow/ArgumentInfo"],function(e,t,i,r,n,s,a,o){"use strict";function l(e,t,i){c(e,t,null,i,null)}function c(e,t,i,r,s){var a={};if(null==e){var o=new Error("workflow cannot be null");if(null!=t)return void t.handleError(o,null);throw o}var l=e.url+"/run";if(r&&(h(r),a.inargs=JSON.stringify(r)),null!=i){for(var c=i.pendingExternalActivities,p=0;p<c.length;p++)h(c[p].outputs);a.workflow=JSON.stringify(i)}a=n.encodeJson(dojo.mixin({f:"json"},a)),null!=t&&(t.isBusy=!0),t.webRequestBegin(l,e),n.request({url:l,content:a,load:dojo.hitch(this,function(i){t.webRequestComplete(l,e),u(i,e,t)}),error:dojo.hitch(this,function(e){if(null==t)throw e;t.isBusy=!1,t.handleError(e,s)}),callbackParamName:"CallBack"},{usePost:!0})}function u(e,t,n){if(null!=n&&(n.isBusy=!1),e){if(e.error){var a=new Error("Error running workflow: "+e.error.message);return void p(n,a)}var o=new i.WorkflowState(e.instanceId,e.status,f(e.pendingExternalActivities),y(e.outputs),e.workflowData,e.instanceData);if("Completed"==o.status)null!=n&&n.workflowComplete(o.outputs,t);else if("WaitingForExternalActivities"==o.status){var l=o.pendingExternalActivities;if(null!=l)for(var c=0;c<l.length;c++){var u=new r.ActivityContext(n,c,t,o);null!=n&&n.activityBegin(u);var d=l[c];h(d.inputs);try{"debugger"===u.getActivityExternalId()||d&&d.debug?s.showDebug(u,!0,function(){m(u)}):m(u)}catch(a){p(n,a,u)}}}}}function p(e,t,i){if(null==e)throw t;e.handleError(t,i||null)}function h(e){if(null!=e)for(var t=0;t<e.length;t++){var i=function(e){var t=e,i=e.indexOf(",");return i>0&&(t=e.substring(0,i)),t},r=i(e[t].runtimeTypeName);if(e[t].value=d(e[t].value,r),null==e[t].value){var n=i(e[t].typeName);e[t].value=d(e[t].value,n)}}}function d(e,t){var i=e;switch(t){case"ESRI.ArcGIS.Client.Tasks.FeatureSet":var r=e;if(null!=r){var n=new esri.tasks.FeatureSet(r);n.features=n.features||[],i=n}break;case"ESRI.ArcGIS.Client.Geometry.Geometry":case"ESRI.ArcGIS.Client.Geometry.Envelope":case"ESRI.ArcGIS.Client.Geometry.MapPoint":case"ESRI.ArcGIS.Client.Geometry.MultiPoint":case"ESRI.ArcGIS.Client.Geometry.Polygon":case"ESRI.ArcGIS.Client.Geometry.Polyline":var s=e;if(null!=s){var a=esri.geometry.fromJson(s);a&&a.spatialReference&&!s.spatialReference&&(a.spatialReference=null),i=a}break;case"ESRI.ArcGIS.Client.Geometry.SpatialReference":var o=e;null!=o&&(i=new esri.SpatialReference(o));break;case"ESRI.ArcGIS.Client.LayerMapSource":var l=e;l&&(i=new esri.layers.LayerMapSource(l));break;case"ESRI.ArcGIS.Client.LayerDataSource":var l=e;l&&(i=new esri.layers.LayerDataSource(l));break;case"ESRI.ArcGIS.Client.TimeExtent":if(e instanceof Array){var c=e;if(c.length>0){var u=new Date(c[0]),p=c.length>1?new Date(c[1]):u;i=new esri.TimeExtent(u,p)}}break;case"ESRI.ArcGIS.Client.Graphic":e&&(i=e.toJson());break;case"System.DateTime":e instanceof Date&&(i="/Date("+e.getTime()+")/")}return i}function f(e){var t=[];if(null!=e)for(var i=0;i<e.length;i++){var r=e[i],n=new a.ExternalActivityInfo;n._configureObject(r),t[i]=n}return t}function y(e){var t=[];if(null!=e)for(var i=0;i<e.length;i++){var r=e[i],n=new o.ArgumentInfo;n._configureObject(r),t[i]=n}return t}function m(e){if(null==e.dispatcher())throw new Error("Unhandled activity: "+e.getActivityTypeName());e.dispatcher().dispatch(e)}t.startWorkflow=l,t._executeWorkflow=c,t._processWorkflowResults=u,t._handleErrorInternal=p,t._preProcessArguments=h,t._getObjectFromJsonWithType=d,t._getExternalActivities=f,t._getArguments=y,t._dispatch=m})},"geocortex/forms/DataItem":function(){define(["require","exports","geocortex/workflow/WorkflowControllerProxy"],function(e,t,i){"use strict";var r=function(){function e(e,t,i){this.display=e,this.value=t,this.typeName=i}return e.prototype.getValue=function(){var e=this.value;return null!=this.typeName&&(e=i._getObjectFromJsonWithType(e,this.typeName)),null!=this.value&&"undefined"!=typeof this.value.__type&&delete e.__type,e},e}();t.DataItem=r})},"geocortex/forms/FormButton":function(){define(["require","exports","geocortex/framework/observables"],function(e,t,i){"use strict";var r=function(){function e(e,t,r,n){this.label=new i.Observable(e),this.value=new i.Observable(t),this.isDefault=new i.Observable(n||!1),this.causesValidation=new i.Observable(r)}return e}();t.FormButton=r})},"geocortex/essentials/AuthenticationControlBlock":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(){this.messageFromServer=null,this.password=null,this.pendingCalls=[],this.tokenService=null,this.tokenRootUri=null,this.targetRootUri=null,this.token=null,this.username=null}return e}();t.AuthenticationControlBlock=i})},"geocortex/essentials/AuthenticationControlBlockStore":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(){this._authenticationControlBlocks=[]}return e.prototype.add=function(e){null===this.find(e.tokenRootUri)&&this._authenticationControlBlocks.push(e)},e.prototype.remove=function(e){for(var t=0;t<this._authenticationControlBlocks.length;t++)if(this._authenticationControlBlocks[t]===e)return this._authenticationControlBlocks.splice(t,1),!0;return!1},e.prototype.find=function(e){for(var t=0;t<this._authenticationControlBlocks.length;t++){var i=this._authenticationControlBlocks[t],r=i.tokenRootUri,n=i.targetRootUri;if(0===e.toLowerCase().indexOf(r.toLowerCase())||0===e.toLowerCase().indexOf(n.toLowerCase()))return i}return null},e.prototype.removeAt=function(e){this._authenticationControlBlocks.splice(e,1)},e}();t.AuthenticationControlBlockStore=i})},"geocortex/essentials/EssentialsLayerInfo":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(){}return e}();t.EssentialsLayerInfo=i})},"geocortex/essentials/EssentialsFeatureSet":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(){}return e.prototype.toJson=function(){return JSON.stringify(this)},e}();t.EssentialsFeatureSet=i})},"geocortex/essentials/RestEndpointResult":function(){define(["require","exports","geocortex/geocortex"],function(e,t,i){"use strict";var r=function(){function e(e,t){this.error=t,this.resultObject=e,e&&(this.rawJson=i.encodeJson(e))}return e}();t.RestEndpointResult=r})},"geocortex/essentials/RestUtility":function(){define(["require","exports","geocortex/essentials/RestEndpointResult","geocortex/geocortex"],function(e,t,i,r){"use strict";var n=function(){function e(){this._activeEndpointRequest=!1,this._onRequestComplete=null,this._onRequestError=null}return e.prototype.getCustomRestEndpoint=function(e,t,i,n,s){return this._activeEndpointRequest?void this._onEndpointRequestError(new Error("An operation is already in progress.")):(this._activeEndpointRequest=!0,this._onRequestComplete=i,this._onRequestError=n,void r.request({url:e,content:t,load:dojo.hitch(this,this._onEndpointRequestComplete),error:dojo.hitch(this,this._onEndpointRequestError),callbackParamName:"CallBack"},s))},e.prototype._onEndpointRequestComplete=function(e){this._activeEndpointRequest=!1;try{e||(e={error:new Error("Expected results")}),e.error&&this._onRequestError&&this._onRequestError(e.error)}finally{this._onRequestComplete&&this._onRequestComplete(new i.RestEndpointResult(e,e.error))}},e.prototype._onEndpointRequestError=function(e){this._activeEndpointRequest=!1;try{this._onRequestError&&this._onRequestError(e)}finally{this._onRequestComplete&&this._onRequestComplete(new i.RestEndpointResult(null,e))}},e}();t.RestUtility=n})},"geocortex/essentials/Rx.light":function(){define(["require","exports"],function(e,t){"use strict";function i(){}var r=function(){function e(){}return e.prototype.select=function(t){var i=this,r=new e;return r._subscribe=function(e){var r=!0,n={onNext:function(i){if(r)try{e.onNext(t(i))}catch(n){r=!1,e.onError(n)}},onError:function(t){r&&(r=!1,e.onError(t))},onCompleted:function(){r&&(r=!1,e.onCompleted())}},s=i._subscribe(n);return r?s:(s.dispose(),{dispose:function(){}})},r},e.prototype._subscribe=function(e){return{dispose:i}},e.prototype.subscribe=function(e,t,r){if(arguments.length>1){var n={onNext:e||i,onError:t||i,onCompleted:r||i};return this._subscribe(n)}if(e instanceof Function){if(e.length>1){var n={onNext:function(t){return e(t)},onError:function(t){return e(void 0,t)},onCompleted:function(){return e()}};return this._subscribe(n)}var n={onNext:e,onError:t||i,onCompleted:r||i};return this._subscribe(n)}return e?this._subscribe(e):this._subscribe({onNext:i,onError:i,onCompleted:i})},e}();t.AnonymousObservable=r})},"geocortex/essentials/ServicePoint":function(){define(["require","exports","geocortex/essentials/Rx.light","geocortex/geocortex"],function(t,i,r,n){"use strict";function s(e,t){h||(p=document.head.getElementsByTagName("base")[0],p||(p=document.createElement("base"),p.setAttribute("href",window.location.href),document.head.appendChild(p)),h=document.createElement("a"));try{var i=p.getAttribute("href");p.setAttribute("href",e),h.setAttribute("href",t),t=h.href}finally{p.setAttribute("href",i)}return t}function a(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];for(var r=e.length,n=0;n<t.length;n++){var s=e.indexOf(t[n]);s>=0&&s<r&&(r=s)}return s}function o(e){var t=a(e,"?","!","#");return{query:e.substring(0,t),tail:e.substring(t)}}var l=function(){function e(){}return e.prototype.toString=function(){return this.message},e}();i.ServiceRequestError=l,l.prototype.message="An error occurred while performing the operation.",l.prototype.details=new Array,l.prototype.name="ServiceRequestError";var c=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t}(l);i.ServiceRequestAbortedError=c,c.prototype.message="The request was aborted.",c.prototype.name="ServiceRequestAbortedError";var u=function(){function t(){}return t.prototype.start=function(){try{this.promise=n.request(this),this.valid?this.registration=this.servicePoint.cancellationToken.register(this.error.bind(this)):this.promise.cancel()}catch(e){this.error(e)}},t.prototype.load=function(e){try{if(this.member){var t=e[this.member];if(t)for(var i=0;i<t.length&&this.valid;i++)this.observer.onNext(t[i])}else this.valid&&this.observer.onNext(e);this.complete()}catch(r){this.error(r)}},t.prototype.error=function(t){this.valid&&(this.valid=!1,this.promise.cancel(),this.registration.dispose(),this.observer.onError(e||new c))},t.prototype.complete=function(){this.valid&&(this.valid=!1,this.promise.cancel(),this.registration.dispose(),this.observer.onCompleted())},t.prototype.dispose=function(){this.valid&&(this.valid=!1,this.promise.cancel(),this.registration.dispose())},t}();u.prototype.handleAs="json",u.prototype.valid=!0,u.prototype.registration={dispose:function(){}};var p,h,d=function(){function e(){}return e.prototype.formatQuery=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];var r=e,n=o(r.format.apply(e,t));return s(this.baseAddress,n.query)+n.tail},e.prototype.getRequest=function(e,t){var i=function(e){this.observer=e,this.start()};i.prototype=new u,i.prototype.servicePoint=this,i.prototype.query=e,i.prototype.member=t;var n=new r.AnonymousObservable;return n._subscribe=function(e){return new i(e)},n},e}();i.ServicePoint=d,d.prototype.baseAddress=window.location.href,d.prototype.cancellationToken={dispose:function(){},register:function(e){return this}}})},"geocortex/optimizer/EventRelay":function(){define(["require","exports","geocortex/framework/utils/TimeDelayedOperation"],function(e,t,i){"use strict";var r=function(){function e(e,t,r,n){var s=this;this._timer=null,this._siteId="",this._endpointUrl="",this.userName="",this._extentConnect=null,this._numConsecutiveFailures=0,this._enabled=!0,this._sessionId="",this._previousScale=-1,this._firstExtentLogged=!1,this._map=e,t&&(this._siteId=t),r?this._endpointUrl=r:this._endpointUrl=window.location.protocol+"//"+window.location.host+"/Geocortex/Optimizer/Rest/DataRelay/LogData.ashx?f=json",n&&(this.userName=n),this._pendingEvents=new Array,this._timer=new i.TimeDelayedAction(3e3,this._flushQueue,this);var a={};a.extent=this._map.extent,e.loaded?(this._logExtentChange(a),this._extentConnect=e.on("extent-change",dojo.hitch(this,"_logExtentChange"))):e.on("load",function(){s._logExtentChange(a),s._extentConnect=e.on("extent-change",dojo.hitch(s,"_logExtentChange"))}),this._sessionId=this._crc32((new Date).getTime()+""+navigator.userAgent)}return e.prototype._logExtentChange=function(e){if(this._enabled){var t;if(t={},t.data=[{name:"ArcGISExtents",columns:{}}],t.data[0].columns=[{type:"tinyint",name:"InitialExtent",key:"InitialExtent"},{type:"real",name:"XMinNew",key:"XMinNew"},{type:"real",name:"YMinNew",key:"YMinNew"},{type:"real",name:"XMaxNew",key:"XMaxNew"},{type:"real",name:"YMaxNew",key:"YMaxNew"}],t.data[0].rows=[{InitialExtent:this._firstExtentLogged?0:1,XMinNew:e.extent.xmin,YMinNew:e.extent.ymin,XMaxNew:e.extent.xmax,YMaxNew:e.extent.ymax}],this._queueData(t),this._firstExtentLogged=!0,e.lod)e.levelChange&&this._previousScale>-1&&this._logScaleChange(this._previousScale,e.lod.scale),this._previousScale=e.lod.scale;else{var i=this._map.getScale();null!==i&&(this._previousScale!=i&&this._previousScale>-1&&this._logScaleChange(this._previousScale,i),this._previousScale=i)}}},e.prototype._logScaleChange=function(e,t){if(this._enabled){var i={};i.data=[{name:"ArcGISScale",columns:[]}],i.data[0].columns=[{type:"float",name:"ScaleOld",key:"ScaleOld"},{type:"float",name:"ScaleNew",key:"ScaleNew"}],i.data[0].rows=[{ScaleOld:e,ScaleNew:t}],this._queueData(i)}},e.prototype.logToolUsage=function(e,t){if(this._enabled){var i={};i.data=[{name:"ArcGISTool",columns:[]}],i.data[0].columns=[{type:"ustr",name:"Tool",key:"Tool"},{type:"ustr",name:"ToolData",key:"ToolData"}],i.data[0].rows=[{Tool:e,ToolData:t}],this._queueData(i)}},e.prototype._queueData=function(e){e.platform="js",e.data[0].columns.push({type:"now",name:"SampleTime",key:"SampleTime"},{type:"origin",name:"UserAddress",key:"UserAddress"},{type:"ustr",name:"SiteId",key:"SiteId"},{type:"ustr",name:"UserAgent",key:"UserAgent"},{type:"ustr",name:"UserName",key:"UserName"},{type:"ustr",name:"LayerList",key:"LayerList"},{type:"int",name:"SessionId",key:"SessionId"},{type:"ustr",name:"ClientType",key:"ClientType"},{type:"host",name:"MachineName",key:"MachineName"}),dojo.mixin(e.data[0].rows[0],{SiteId:this._siteId,UserAgent:navigator.userAgent,UserName:this.userName,LayerList:this._getCurrentLayerList(),SessionId:this._sessionId,ClientType:"JavaScript"}),this._pendingEvents.push(e),this._timer.reset()},e.prototype._flushQueue=function(){for(this._timer.stop();this._pendingEvents.length>0;){var e=this._pendingEvents.shift();this._logData(e)}},e.prototype._logData=function(e){try{dojo.xhrPost({url:this._endpointUrl,postData:JSON.stringify(e),timeout:1e4,load:dojo.hitch(this,this._handleLogSuccessResponse),error:dojo.hitch(this,this._handleLogErrorResponse)})}catch(t){console.log(t.message),this._incrementFailures()}},e.prototype._handleLogSuccessResponse=function(e){this._numConsecutiveFailures=0},e.prototype._handleLogErrorResponse=function(e){console.log(e),this._incrementFailures()},e.prototype._incrementFailures=function(){this._numConsecutiveFailures++,this._numConsecutiveFailures>2&&(dojo.disconnect(this._extentConnect),this._enabled=!1)},e.prototype._getCurrentLayerList=function(){for(var e="",t=this._map.layerIds,i=0;i<t.length;i++){var r=t[i],n=this._map.getLayer(r);if(null!=n&&n.visible&&n.visibleAtMapScale){var s;if(n instanceof esri.layers.ArcGISDynamicMapServiceLayer){var a=n;for(s=0;s<a.visibleLayers.length;s++)null!=a.visibleLayers[s]&&a.visibleLayers[s]!=-1&&(e+=a.layerInfos.filter(function(e){return e.id==a.visibleLayers[s]})[0].name+"\\t")}else if(n instanceof esri.virtualearth.VETiledLayer){var o=n;e+="Bing:"+o.mapStyle+"\\t"}else if(n instanceof esri.layers.ArcGISImageServiceLayer)e+="Image:"+n.url+"\\t";else if(n instanceof esri.layers.ArcGISTiledMapServiceLayer){var l=n;for(s=0;s<l.layerInfos.length;s++)null!=l.layerInfos[s]&&(e+=l.layerInfos[s].name+"\\t")}}}return e.length>3&&(e=e.substring(0,e.length-2)),e},e.prototype._crc32=function(e){e=e.replace(/\r\n/g,"\n");for(var t="",i=0;i<e.length;i++){var r=e.charCodeAt(i);r<128?t+=String.fromCharCode(r):r>127&&r<2048?(t+=String.fromCharCode(r>>6|192),t+=String.fromCharCode(63&r|128)):(t+=String.fromCharCode(r>>12|224),t+=String.fromCharCode(r>>6&63|128),t+=String.fromCharCode(63&r|128))}e=t;var n,s,a="00000000 77073096 EE0E612C 990951BA 076DC419 706AF48F E963A535 9E6495A3 0EDB8832 79DCB8A4 E0D5E91E 97D2D988 09B64C2B 7EB17CBD E7B82D07 90BF1D91 1DB71064 6AB020F2 F3B97148 84BE41DE 1ADAD47D 6DDDE4EB F4D4B551 83D385C7 136C9856 646BA8C0 FD62F97A 8A65C9EC 14015C4F 63066CD9 FA0F3D63 8D080DF5 3B6E20C8 4C69105E D56041E4 A2677172 3C03E4D1 4B04D447 D20D85FD A50AB56B 35B5A8FA 42B2986C DBBBC9D6 ACBCF940 32D86CE3 45DF5C75 DCD60DCF ABD13D59 26D930AC 51DE003A C8D75180 BFD06116 21B4F4B5 56B3C423 CFBA9599 B8BDA50F 2802B89E 5F058808 C60CD9B2 B10BE924 2F6F7C87 58684C11 C1611DAB B6662D3D 76DC4190 01DB7106 98D220BC EFD5102A 71B18589 06B6B51F 9FBFE4A5 E8B8D433 7807C9A2 0F00F934 9609A88E E10E9818 7F6A0DBB 086D3D2D 91646C97 E6635C01 6B6B51F4 1C6C6162 856530D8 F262004E 6C0695ED 1B01A57B 8208F4C1 F50FC457 65B0D9C6 12B7E950 8BBEB8EA FCB9887C 62DD1DDF 15DA2D49 8CD37CF3 FBD44C65 4DB26158 3AB551CE A3BC0074 D4BB30E2 4ADFA541 3DD895D7 A4D1C46D D3D6F4FB 4369E96A 346ED9FC AD678846 DA60B8D0 44042D73 33031DE5 AA0A4C5F DD0D7CC9 5005713C 270241AA BE0B1010 C90C2086 5768B525 206F85B3 B966D409 CE61E49F 5EDEF90E 29D9C998 B0D09822 C7D7A8B4 59B33D17 2EB40D81 B7BD5C3B C0BA6CAD EDB88320 9ABFB3B6 03B6E20C 74B1D29A EAD54739 9DD277AF 04DB2615 73DC1683 E3630B12 94643B84 0D6D6A3E 7A6A5AA8 E40ECF0B 9309FF9D 0A00AE27 7D079EB1 F00F9344 8708A3D2 1E01F268 6906C2FE F762575D 806567CB 196C3671 6E6B06E7 FED41B76 89D32BE0 10DA7A5A 67DD4ACC F9B9DF6F 8EBEEFF9 17B7BE43 60B08ED5 D6D6A3E8 A1D1937E 38D8C2C4 4FDFF252 D1BB67F1 A6BC5767 3FB506DD 48B2364B D80D2BDA AF0A1B4C 36034AF6 41047A60 DF60EFC3 A867DF55 316E8EEF 4669BE79 CB61B38C BC66831A 256FD2A0 5268E236 CC0C7795 BB0B4703 220216B9 5505262F C5BA3BBE B2BD0B28 2BB45A92 5CB36A04 C2D7FFA7 B5D0CF31 2CD99E8B 5BDEAE1D 9B64C2B0 EC63F226 756AA39C 026D930A 9C0906A9 EB0E363F 72076785 05005713 95BF4A82 E2B87A14 7BB12BAE 0CB61B38 92D28E9B E5D5BE0D 7CDCEFB7 0BDBDF21 86D3D2D4 F1D4E242 68DDB3F8 1FDA836E 81BE16CD F6B9265B 6FB077E1 18B74777 88085AE6 FF0F6A70 66063BCA 11010B5C 8F659EFF F862AE69 616BFFD3 166CCF45 A00AE278 D70DD2EE 4E048354 3903B3C2 A7672661 D06016F7 4969474D 3E6E77DB AED16A4A D9D65ADC 40DF0B66 37D83BF0 A9BCAE53 DEBB9EC5 47B2CF7F 30B5FFE9 BDBDF21C CABAC28A 53B39330 24B4A3A6 BAD03605 CDD70693 54DE5729 23D967BF B3667A2E C4614AB8 5D681B02 2A6F2B94 B40BBE37 C30C8EA1 5A05DF1B 2D02EF8D",o=0;o^=-1;for(var l=0,c=e.length;l<c;l++)s=255&(o^e.charCodeAt(l)),n="0x"+a.substr(9*s,8),o=o>>>8^n;return o^=-1,o.toString()},e}();t.EventRelay=r})},"geocortex/workflow/CacheActivityHandlers":function(){define(["require","exports"],function(e,t){"use strict";function i(e){var t=e.getValue("Key");if(null!=t){var i=n[t];void 0===i&&(i=null),e.setValue("Value",i)}e.completeActivity()}function r(e){var t=e.getValue("Key"),i=e.getValue("Value");null!=t&&(n[t]=i),e.completeActivity()}var n={};t.handleGetExternalValue=i,t.handleSetExternalValue=r})},"geocortex/workflow/DialogActivityHandlers":function(){define(["require","exports"],function(e,t){"use strict";function i(e){var t=(e.getValue("Title"),e.getValue("Text"));alert(t),e.completeActivity()}function r(e){var t=e.getValue("Text"),i=confirm(t);null==i&&(i=!1),e.setValue("Result",i),e.completeActivity()}function n(e){var t=e.getValue("Description"),i=e.getValue("DefaultText"),r=prompt(t,i);e.setValue("Result",r),e.completeActivity()}t.handleAlert=i,t.handleConfirm=r,t.handlePrompt=n})},"geocortex/workflow/MapActivityHandlers":function(){define(["require","exports","geocortex/essentials/utilities/SiteResourceIdComparer","geocortex/essentials/LayerType","geocortex/essentials/ReportParameters","geocortex/essentials/Resolution","geocortex/essentials/Scale","geocortex/essentials/TextField"],function(e,t,i,r,n,s,a,o){"use strict";var l;!function(e){function t(e){var t=e.getValue("MapServiceId"),r=e.getEsriMap();if(null==r)throw new Error("Refresh Map: no map available.");var n=function(e){var t=e.serviceLayer,i="function"==typeof t.refresh;if(i)if("boolean"==typeof t.disableClientCaching){var r=t.disableClientCaching;t.disableClientCaching=!0,t.refresh(),t.disableClientCaching=r}else t.refresh()},s=e.workflow().site.essentialsMap.mapServices;if(t){var a=i.SiteResourceIdComparer.lookUp(s,t);a&&n(a)}else dojo.forEach(s,function(e){n(e)});e.completeActivity()}function l(e){var t=e.getEsriMap();if(null==t)throw new Error("Get Map Extent: No map available.");e.setValue("Extent",t.extent),e.completeActivity()}function c(e){var t=e.getEsriMap();if(null==t)throw new Error("Get Map Info: No map available.");e.setValue("Extent",t.extent),e.setValue("Scale",esri.geometry.getScale(t)),e.setValue("SpatialReference",t.spatialReference),e.setValue("Height",t.height),e.setValue("Width",t.width);var i=[];null!=t.layerIds&&(i=i.concat(t.layerIds)),null!=t.graphicsLayerIds&&(i=i.concat(t.graphicsLayerIds)),e.setValue("MapServiceIds",i),e.completeActivity()}function u(e){var t=e.getValue("Extent");if(null==t)throw new Error("Set Map Extent: required Extent argument was not supplied.");var i=e.getEsriMap();if(null==i)throw new Error("Set Map Extent: No map available.");
t.spatialReference&&(t.spatialReference.wkid||t.spatialReference.wkt)||(t.spatialReference=i.spatialReference);var r=e.getSite();r&&r.essentialsMap?r.essentialsMap.extentManager.setExtentWithPriority(t,10):i.setExtent(t),e.completeActivity()}function p(e){function t(t,i,n){n.deactivate(),dojo.disconnect(i),r.setDrawObjectContext(null),e.setValue("Result",t),e.completeActivity()}function i(e){var i;switch(e){case 0:i=esri.toolbars.Draw.EXTENT;break;case 1:i=esri.toolbars.Draw.FREEHAND_POLYGON;break;case 2:i=esri.toolbars.Draw.FREEHAND_POLYLINE;break;case 3:i=esri.toolbars.Draw.LINE;break;case 4:i=esri.toolbars.Draw.POINT;break;case 5:i=esri.toolbars.Draw.MULTI_POINT;break;case 6:i=esri.toolbars.Draw.POLYGON;break;case 7:i=esri.toolbars.Draw.POLYLINE;break;case 8:t(s.extent,o,a),l=!1;break;default:i=esri.toolbars.Draw.EXTENT}return i}var r=e.dispatcher();if(!r.abortMapBasedActivity())throw new Error("Could not deactivate current map based activity.");var n=e.getValue("CaptureType"),s=e.getEsriMap();if(null==s)throw new Error("Capture Geometry: No map available.");if("function"!=typeof esri.toolbars.Draw)throw new Error('dojo.require("esri.toolbars.draw") must be added to your client code to use CaptureGeometry activity.');var a=new esri.toolbars.Draw(s),o=dojo.connect(a,"onDrawEnd",dojo.hitch(o,function(e){t(e,o,a)})),l=!0,c=i(n);l&&a.activate(c),r.setDrawObjectContext({activityContext:e,toolbar:a,drawEvent:o})}function h(e,t){if(!e||e.length<=0)return null;if(t)for(var i=t.toUpperCase(),r=0;r<e.length;r++){var n=e[r];if(n&&n.toUpperCase()===i)return e[r]}return e[0]}function d(e){var t,i,n,s="\\\\",a=[],o=[],l=[],c=[],u=null,p=null,h=null,d=null,f=null,y=!1,m=null,g=-1,v=e.getValue("InputLayers");if(v&&v.length>0)for(n=0;n<v.length;n++)g=v[n].lastIndexOf(s),g>=0&&(v[n]=v[n].substring(g+s.length));else e.dispatcher().handleError(new Error("Intersect Layers: no input layers provided."),e);for(u=e.getSite(),u||e.dispatcher().handleError(new Error("Intersect Layers: no site available."),e),p=u.essentialsMap,p||e.dispatcher().handleError(new Error("Intersect Layers: no map available."),e),(!p.mapServices||p.mapServices.length<=0)&&e.dispatcher().handleError(new Error("Intersect Layers: no map service is configured for the map."),e),t=0;t<p.mapServices.length;t++){h=p.mapServices[t],d=h.layers,m=[];var S=v.length,x="";for(d.forEach(function(e){x=e.name;for(var t=0;t<S;++t)if(x===v[t]){m.push(e);break}}),i=0;i<m.length;i++){switch(f=m[i],y=!1,f.type){case r.LayerType.FEATURE_LAYER:o.push(f.name),y=!0;break;case r.LayerType.GROUP_LAYER:l.push(f.name),y=!0;break;case r.LayerType.RASTER_LAYER:c.push(f.name),y=!0}y&&a.push(f.name)}}e.setValue("OutputLayers",a),e.setValue("FeatureLayers",o),e.setValue("GroupLayers",l),e.setValue("RasterLayers",c),e.completeActivity()}function f(t){var i=t.getValue("TargetSpatialReference"),r=t.getValue("CustomExtent"),o=t.getValue("Resolution"),l=t.getValue("OutputFormat"),c=t.getValue("Scale"),u=t.getValue("ImageHeight"),p=t.getValue("ImageWidth"),h=t.getValue("UseTransparentBackground"),d=null,f=null,y=null,m=null;d=t.getSite(),d||t.dispatcher().handleError(new Error("Export Map: no site available."),t),f=d.getMap(),f||t.dispatcher().handleError(new Error("Export Map: no map available."),t),y=d.essentialsMap,y||t.dispatcher().handleError(new Error("Export Map: no map available."),t),m=new n.ReportParameters,m.outputFormat=e._pickSupported(y.supportedExportFormats,l),o&&(m.resolution=new s.Resolution("",o)),c&&(m.scale=new a.Scale("",c)),u?m.imageHeight=u:m.imageHeight=f.height,p?m.imageWidth=p:m.imageWidth=f.width,r&&(m.customExtent=r),m.extentType=r?n.ReportParameters.CUSTOM_EXTENT:n.ReportParameters.CURRENT_EXTENT,m.useTransparentBackground=h,i&&(m.targetSpatialReference=i),f&&m.populateMapGraphicsLayers(f),y.exportMap(m,function(e){var i=e?e.href:null;t.setValue("ResultUrl",i),t.completeActivity()},function(e){t.dispatcher().handleError(new Error("Error exporting map '"+e.message+"'"),t)})}function y(t){var i=t.getValue("TargetSpatialReference"),r=t.getValue("TextFields"),l=t.getValue("CustomExtent"),c=t.getValue("NotificationEmailAddress"),u=t.getValue("Resolution"),p=t.getValue("OutputFormat"),h=t.getValue("Scale"),d=t.getValue("PrintTemplateId"),f=t.getValue("GridId"),y=null,m=null;y=t.getSite(),y||t.dispatcher().handleError(new Error("Print Map: no site available."),t),m=y.getMap(),m||t.dispatcher().handleError(new Error("Print Map: no map available."),t);var g=y.findPrintTemplateById(d);g||t.dispatcher().handleError(new Error("Print Map: unable to find print template '"+d+"'."),t),g.isPrinting()&&t.dispatcher().handleError(new Error("Print Map: unable to perform print operation because print template '"+d+"' is busy."),t);var v=new n.ReportParameters;if(v.outputFormat=e._pickSupported(g.supportedOutputFormats,p),u&&(v.resolution=new s.Resolution("",u)),h&&(v.scale=new a.Scale("",h)),c&&(v.notificationEmailAddress=c),l&&(v.customExtent=l),v.extentType=l?n.ReportParameters.CUSTOM_EXTENT:n.ReportParameters.CURRENT_EXTENT,i&&(v.targetSpatialReference=i),g.textFields&&g.textFields.length>0&&r)for(var S=0;S<r.length;S++)if(r[S])for(var x=0;x<g.textFields.length;x++)if(r[S].Key===g.textFields[x].displayName){var b=new o.TextField(g.textFields[x].id,"",r[S].Value,(!1));v.fields.push(b)}if(f){var I=dojo.filter(g.grids,function(e){return e.id==f});I.length>0&&(v.grid=I[0])}g.print(v,function(e){var i=e?e.href:null;t.setValue("ResultUrl",i),t.completeActivity()},function(e){t.dispatcher().handleError(new Error("Error printing map '"+e.message+"'"),t)})}e.handleRefreshMap=t,e.handleGetMapExtent=l,e.handleGetMapInfo=c,e.handleSetMapExtent=u,e.handleCaptureGeometry=p,e._pickSupported=h,e.handleIntersectLayers=d,e.handleExportMap=f,e.handlePrintMap=y}(l=t.MapActivityHandlers||(t.MapActivityHandlers={}))})},"geocortex/workflow/NativeActivityHandlers":function(){define(["require","exports"],function(e,t){"use strict";function i(e){if(!navigator.geolocation)return e.setValue("ErrorCode",2),e.setValue("ErrorMessage","Geolocation is not supported."),void e.completeActivity();var t=2e4,i={enableHighAccuracy:e.getValue("EnableHighAccuracy"),timeout:e.getValue("Timeout")||t,maximumAge:e.getValue("MaximumAge")};navigator.geolocation.getCurrentPosition(function(t){e.setValue("Latitude",t.coords.latitude),e.setValue("Longitude",t.coords.longitude),e.setValue("Altitude",t.coords.altitude),e.setValue("Accuracy",t.coords.accuracy),e.setValue("AltitudeAccuracy",t.coords.altitudeAccuracy),e.setValue("Heading",t.coords.heading),e.setValue("Speed",t.coords.speed),e.setValue("Timestamp",t.timestamp),e.completeActivity()},function(t){e.setValue("ErrorCode",t.code),e.setValue("ErrorMessage",t.message),e.completeActivity()},i)}function r(e){if(!navigator.camera)return e.setValue("Message","camera is not supported."),void e.completeActivity();var t={quality:e.getValue("Quality"),destinationType:e.getValue("DestinationType"),sourceType:e.getValue("SourceType"),allowEdit:e.getValue("AllowEdit"),encodingType:e.getValue("EncodingType"),targetWidth:e.getValue("TargetWidth"),targetHeight:e.getValue("TargetHeight")};navigator.camera.getPicture(function(t){e.setValue("ImageData",t),e.completeActivity()},function(t){e.setValue("Message",t),e.completeActivity()},t)}t.handleGetCurrentPosition=i,t.handleGetPhoto=r})},"geocortex/workflow/LayerActivityHandlers":function(){define(["require","exports","geocortex/workflow/MapServiceActivityHandlers","geocortex/workflow/DefaultActivityHandlers"],function(e,t,i,r){"use strict";function n(e){var t="Set Layer Property",n=e.getValue("MapServiceId"),s=e.getValue("LayerId"),a=e.getValue("LayerName"),o=e.getValue("PropertyName"),l=e.getValue("Value");if(!n)throw new Error(t+": required MapServiceId argument was not supplied.");if(!s&&!a)throw new Error(t+": a LayerId or a LayerName argument must be supplied.");var c=e.getSite();if(!c)throw new Error(t+": No site available.");var u=i.findMapServiceById(c,n);if(!u||!u.serviceLayer)throw new Error(t+": Unable to find map service with ID '"+n+"'");var p=null;if(p=s?u.findLayerById(s):u.findLayerByName(a),!p)throw new Error(t+": Unable to find layer with Name '"+a+"' or ID '"+s+"'.");var h=r.getPropertyIgnoreCase(p,o);if(h)p[h]=l;else{if(h=r.getPropertyIgnoreCase(p.properties,o),!h)throw new Error(t+": Layer does not support the property '"+o+"'.");p.properties[h]=l}e.completeActivity()}function s(e){var t="Get Layer Property",n=e.getValue("MapServiceId"),s=e.getValue("LayerId"),a=e.getValue("LayerName"),o=e.getValue("PropertyName");if(!n)throw new Error(t+": required MapServiceId argument was not supplied.");if(!s&&!a)throw new Error(t+": a LayerId or a LayerName argument must be supplied.");var l=e.getSite();if(!l)throw new Error(t+": No site available.");var c=i.findMapServiceById(l,n);if(!c||!c.serviceLayer)throw new Error(t+": Unable to find map service with ID '"+n+"'");var u=null;if(u=s?c.findLayerById(s):c.findLayerByName(a),!u)throw new Error(t+": Unable to find layer with Name '"+a+"' or ID '"+s+"'.");var p=r.getPropertyIgnoreCase(u,o);if(p)e.setValue("Value",u[p]);else{if(p=r.getPropertyIgnoreCase(u.properties,o),!p)throw new Error(t+": Layer does not support the property '"+o+"'.");e.setValue("Value",u.properties[p])}e.completeActivity()}function a(e){var t=e.getValue("MapServiceId"),r=e.getValue("LayerId"),n=e.getValue("LayerName"),s=e.getValue("EffectiveVisibility");if(!t)throw new Error("Get Layer Visibility: required MapServiceId argument was not supplied.");if(!r&&!n)throw new Error("Get Layer Visibility: a LayerId or a LayerName argument must be supplied.");var a=e.getSite();if(!a)throw new Error("Get Layer Visibility: No site available.");var o=i.findMapServiceById(a,t);if(!o)throw new Error("Get Layer Visibility: Unable to find map service with ID '"+t+"'");var l=null;if(r?l=o.findLayerById(r):n&&(l=o.findLayerByName(n)),!l)throw new Error("Get Layer Visibility: Unable to find layer with ID '"+r+"' in map service with ID '"+t+"'");var c=l.isVisible();if(s&&(c=!1,l.isVisible()&&o.isVisible()&&l.withinScaleRange(null)))for(var u=o.getVisibleLayers(),p=0;p<u.length;p++){var h=u[p];if(h==l.id){c=!0;break}}e.setValue("Visible",c),e.completeActivity()}function o(e){var t=e.getValue("MapServiceId"),r=e.getValue("LayerId"),n=e.getValue("LayerName"),s=e.getValue("Visible");if(!t)throw new Error("Set Layer Visibility: required MapServiceId argument was not supplied.");if(!r&&!n)throw new Error("Set Layer Visibility: a LayerId or a LayerName argument must be supplied.");if(null===s)throw new Error("Set Layer Visibility: required Visible argument was not supplied.");var a=e.getSite();if(!a)throw new Error("Set Layer Visibility: No site available.");var o=i.findMapServiceById(a,t);if(!o)throw new Error("Set Layer Visibility: Unable to find map service with ID '"+t+"'");var l=null;if(r){if(l=o.findLayerById(r),!l)throw new Error("Set Layer Visibility: Unable to find layer with ID '"+r+"' in map service with ID '"+t+"'")}else{if(!n)throw new Error("Set Layer Visibility: must define layer ID or name");if(l=o.findLayerByName(n),!l)throw new Error("Set Layer Visibility: Unable to find layer with name '"+n+"' in map service with ID '"+t+"'")}l.setVisibility(s),e.completeActivity()}function l(e){var t=e.getValue("MapServiceId"),r=e.getValue("LayerId"),n=e.getValue("LayerName");if(!t)throw new Error("Get Layer Definition: required MapServiceId argument was not supplied.");if(!r&&!n)throw new Error("Get Layer Definition: a LayerId or a LayerName argument must be supplied.");var s=null,a=e.getSite();if(a){var o=i.findMapServiceById(a,t);if(o&&o.serviceLayer){if(!r&&n){var l=o.findLayerByName(n);if(!l)throw new Error("Set Layer Definition: Unable to find layer with Name '"+n+"'.");r=l.id}o.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer?o.serviceLayer.layerDefinitions&&(s=o.serviceLayer.layerDefinitions[parseInt(r)]):o.serviceLayer instanceof esri.layers.FeatureLayer&&(s=o.serviceLayer.getDefinitionExpression())}}e.setValue("Definition",s),e.completeActivity()}function c(e){var t=e.getValue("MapServiceId"),r=e.getValue("LayerId"),n=e.getValue("LayerName"),s=e.getValue("Definition");if(!t)throw new Error("Set Layer Definition: required MapServiceId argument was not supplied.");if(!r&&!n)throw new Error("Set Layer Definition: a LayerId or a LayerName argument must be supplied.");var a=e.getSite();if(!a)throw new Error("Set Layer Visibility: No site available.");var o=i.findMapServiceById(a,t);if(!o||!o.serviceLayer)throw new Error("Set Layer Definition: Unable to find map service with ID '"+t+"'");if(!r&&n){var l=o.findLayerByName(n);if(!l)throw new Error("Set Layer Definition: Unable to find layer with Name '"+n+"'.");r=l.id}if(o.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer){var c=o.serviceLayer;c.layerDefinitions||(c.layerDefinitions=[]),c.layerDefinitions[parseInt(r)]=s,c.setLayerDefinitions(c.layerDefinitions,!0)}else{if(!(o.serviceLayer instanceof esri.layers.FeatureLayer))throw new Error("Set Layer Definition: Map service type does not support layer definitions.");o.serviceLayer.setDefinitionExpression(s)}e.completeActivity()}function u(e){var t=e.getValue("GraphicsLayerId"),i=e.getValue("GeometryType"),r=null;null!==i&&(0===i?r="extent":1===i?r="multipoint":2===i?r="point":3===i?r="polygon":4===i&&(r="polyline"));var n=e.getEsriMap();if(null!=n&&null!=n.graphicsLayerIds)for(var s=0;s<n.graphicsLayerIds.length;s++)if(t==n.graphicsLayerIds[s]){var a=n.getLayer(n.graphicsLayerIds[s]);if(null!=a&&null!=a.graphics){for(var o=new esri.tasks.FeatureSet,l=0;l<a.graphics.length;l++){var c=a.graphics[l];if(null!==r){if(null===c.geometry)continue;if(r!==c.geometry.type)continue}var u=new esri.Graphic(c.geometry,null,c.attributes,null);o.features.push(u)}e.setValue("Features",o)}break}e.completeActivity()}function p(e){var t=e.getValue("GraphicsLayerId"),r=!!e.getValue("RemoveAllFeatures"),n=e.getValue("FeatureSet"),s=e.getValue("RendererJson"),a=e.getEsriMap();if(null==a)throw new Error("Update Graphics Layer: No map available.");var o=!1,l=i.findMapServiceByMap(a,t);if(l){if(!(l instanceof esri.layers.GraphicsLayer))throw new Error("Update Graphics Layer: The layer '"+t+"' is not a GraphicsLayer")}else l=new esri.layers.GraphicsLayer({id:t}),o=!0;try{if(l.suspend(),r&&l.clear(),n&&n.features)for(var c=n.features.length-1;c>=0;--c)l.add(n.features[c]);s&&(l.renderer=esri.renderer.fromJson(JSON.parse(s))),o&&a.addLayer(l)}finally{l.resume()}e.completeActivity()}t.handleSetLayerProperty=n,t.handleGetLayerProperty=s,t.handleGetLayerVisibility=a,t.handleSetLayerVisibility=o,t.handleGetLayerDefinition=l,t.handleSetLayerDefinition=c,t.handleGetGraphicsLayerContent=u,t.handleUpdateGraphicsLayer=p})},"geocortex/workflow/DefaultActivityDispatcher":function(){define(["require","exports","geocortex/workflow/DialogActivityHandlers","geocortex/workflow/MapActivityHandlers","geocortex/workflow/DefaultActivityHandlers","geocortex/workflow/NativeActivityHandlers","geocortex/workflow/CacheActivityHandlers","geocortex/workflow/LayerActivityHandlers","geocortex/workflow/MapServiceActivityHandlers"],function(e,t,i,r,n,s,a,o,l){"use strict";var c=function(){function e(e,t,i,r,n,s,a){this.isBusy=!1,this._drawObjectContext=null,this._registeredActivityHandlers={},this._registeredExternalIdHandlers={},this.handleUnhandledActivityErrorFunction=null,this.handleOpenReportUrlFunction=null,this.defaultFormContainerId="form-container-outer",this.defaultFormContentId="form-container",this._handleErrorFunction=e||null,this._activityBeginFunction=t||null,this._activityCompleteFunction=i||null,this._workflowAbortFunction=n||null,this._workflowCompleteFunction=r||null,this._webRequestBeginFunction=s||null,this._webRequestCompleteFunction=a||null,this.registerDefaultHandlers()}return e.prototype.registerDefaultHandlers=function(){this.registerActivityHandler("Geocortex.Workflow.Activities.Alert",i.handleAlert),this.registerActivityHandler("Geocortex.Workflow.Activities.CaptureGeometry",r.MapActivityHandlers.handleCaptureGeometry),this.registerActivityHandler("Geocortex.Workflow.Activities.Confirm",i.handleConfirm),this.registerActivityHandler("Geocortex.Workflow.Activities.ExportMap",r.MapActivityHandlers.handleExportMap),this.registerActivityHandler("Geocortex.Workflow.Activities.ExternalDelay",n.handleExternalDelay),this.registerActivityHandler("Geocortex.Workflow.Activities.GetBrowserUrl",n.handleGetBrowserUrl),this.registerActivityHandler("Geocortex.Workflow.Activities.GetCurrentPosition",s.handleGetCurrentPosition),this.registerActivityHandler("Geocortex.Workflow.Activities.GetExternalTimeInfo",n.handleGetExternalTimeInfo),this.registerActivityHandler("Geocortex.Workflow.Activities.GetExternalValue",a.handleGetExternalValue),this.registerActivityHandler("Geocortex.Workflow.Activities.GetGraphicsLayerContent",o.handleGetGraphicsLayerContent),this.registerActivityHandler("Geocortex.Workflow.Activities.GetLayerDefinition",o.handleGetLayerDefinition),this.registerActivityHandler("Geocortex.Workflow.Activities.GetLayerInfoByProperty",n.handleGetLayerInfoByProperty),this.registerActivityHandler("Geocortex.Workflow.Activities.GetLayerProperty",o.handleGetLayerProperty),this.registerActivityHandler("Geocortex.Workflow.Activities.GetLayerVisibility",o.handleGetLayerVisibility),this.registerActivityHandler("Geocortex.Workflow.Activities.GetMapExtent",r.MapActivityHandlers.handleGetMapExtent),this.registerActivityHandler("Geocortex.Workflow.Activities.GetMapInfo",r.MapActivityHandlers.handleGetMapInfo),this.registerActivityHandler("Geocortex.Workflow.Activities.GetMapServiceInfo",l.handleGetMapServiceInfo),this.registerActivityHandler("Geocortex.Workflow.Activities.GetPhoto",s.handleGetPhoto),this.registerActivityHandler("Geocortex.Workflow.Activities.PrintMap",r.MapActivityHandlers.handlePrintMap),this.registerActivityHandler("Geocortex.Workflow.Activities.Prompt",i.handlePrompt),this.registerActivityHandler("Geocortex.Workflow.Activities.RefreshMap",r.MapActivityHandlers.handleRefreshMap),this.registerActivityHandler("Geocortex.Workflow.Activities.RemoveMapService",l.handleRemoveMapService),this.registerActivityHandler("Geocortex.Workflow.Activities.Report",n.handleReport),this.registerActivityHandler("Geocortex.Workflow.Activities.SetExternalValue",a.handleSetExternalValue),this.registerActivityHandler("Geocortex.Workflow.Activities.SetLayerDefinition",o.handleSetLayerDefinition),this.registerActivityHandler("Geocortex.Workflow.Activities.SetLayerProperty",o.handleSetLayerProperty),this.registerActivityHandler("Geocortex.Workflow.Activities.SetLayerVisibility",o.handleSetLayerVisibility),this.registerActivityHandler("Geocortex.Workflow.Activities.SetMapExtent",r.MapActivityHandlers.handleSetMapExtent),this.registerActivityHandler("Geocortex.Workflow.Activities.SetMapServiceVisibility",l.handleSetMapServiceVisibility),this.registerActivityHandler("Geocortex.Workflow.Activities.UpdateGraphicsLayer",o.handleUpdateGraphicsLayer),this.registerActivityHandler("Geocortex.Workflow.Activities.WaitForGeoprocessorJobComplete",n.handleWaitForGeoprocessorJobComplete),this.registerActivityHandler("Geocortex.Workflow.Activities.SetImageServiceInfo",l.handleSetImageServiceInfo),this.registerActivityHandler("Geocortex.Workflow.Activities.SetMapServiceProperty",l.handleSetMapServiceProperty),this.registerExternalIdHandler("IntersectLayers",r.MapActivityHandlers.handleIntersectLayers),this.registerExternalIdHandler("GetPhoto",s.handleGetPhoto)},e.prototype.canHandleActivity=function(e){if(!e){var t=new Error("Null ActivityContext passed to canHandleActivity.");this.handleError(t,e)}if(null!=e.getActivityExternalId()&&null!=this._registeredExternalIdHandlers[e.getActivityExternalId()])return!0;var i=e.getActivityTypeName();return!(null==i||!this._registeredActivityHandlers[i])},e.prototype.registerExternalIdHandler=function(e,t){if(null==e||null==t){var i=new Error("Null externalId or handler passed to registerExternalIdHandler.");return void this.handleError(i,null)}this._registeredExternalIdHandlers[e]=t},e.prototype.registerActivityHandler=function(e,t){if(null==e||null==t){var i=new Error("Null activityTypeName or handler passed to registerActivityHandler.");return void this.handleError(i,null)}this._registeredActivityHandlers[e]=t},e.prototype.dispatch=function(e){if(null==e){var t=new Error("Null ActivityContext passed to dispatch.");return void this.handleError(t,e)}var i=e.getActivityTypeName(),r=e.getActivityExternalId();if(!this.canHandleActivity(e)){var t=new Error("Unknown activity type '"+i+"' or external ID '"+r+"' encountered.");return void this.handleUnhandledActivityErrorFunction(t,e)}if(null!=r&&null!=this._registeredExternalIdHandlers[r]){var n=this._registeredExternalIdHandlers[r];n(e,this)}if(null!=i&&this._registeredActivityHandlers[i]){var n=this._registeredActivityHandlers[i];n(e,this)}},e.prototype.handleError=function(e,t){null!=this._handleErrorFunction&&this._handleErrorFunction(e,t)},e.prototype.handleUnhandledActivityError=function(e,t){null!=this.handleUnhandledActivityErrorFunction?this.handleUnhandledActivityErrorFunction(e,t):this.handleError(e,t)},e.prototype.handleOpenReportUrl=function(e,t){if(null!=this.handleOpenReportUrlFunction)this.handleOpenReportUrlFunction(e,t);else{window.open(e)}},e.prototype.webRequestBegin=function(e,t){null!=this._webRequestBeginFunction&&this._webRequestBeginFunction(e,t)},e.prototype.webRequestComplete=function(e,t){null!=this._webRequestCompleteFunction&&this._webRequestCompleteFunction(e,t)},e.prototype.abortMapBasedActivity=function(){if(this._drawObjectContext){if(!this._drawObjectContext.toolbar||!this._drawObjectContext.drawEvent||!this._drawObjectContext.activityContext)return!1;this._drawObjectContext.toolbar.deactivate(),dojo.disconnect(this._drawObjectContext.drawEvent),this._drawObjectContext.activityContext.abortActivity(),this._drawObjectContext=null}return!0},e.prototype.setDrawObjectContext=function(e){this._drawObjectContext=e},e.prototype.activityBegin=function(e){null!=this._activityBeginFunction&&this._activityBeginFunction(e)},e.prototype.activityComplete=function(e){null!=this._activityCompleteFunction&&this._activityCompleteFunction(e)},e.prototype.activityAbort=function(e){this.workflowAbort(e,e.workflow())},e.prototype.workflowComplete=function(e,t){null!=this._workflowCompleteFunction&&this._workflowCompleteFunction(e,t)},e.prototype.workflowAbort=function(e,t){null!=this._workflowAbortFunction&&this._workflowAbortFunction(e,t)},e}();t.DefaultActivityDispatcher=c})},"geocortex/workflow/SimpleActivityDispatcher":function(){define(["require","exports","geocortex/workflow/DefaultActivityDispatcher"],function(e,t,i){"use strict";var r=function(){function e(e,t,r,n,s,a,o,l){this._defaultActivityDispatcher=new i.DefaultActivityDispatcher,this._drawObjectContext=null,this.isBusy=null,this._dispatchFunction=e||null,this._handleErrorFunction=t||null,this._activityBeginFunction=r||null,this._activityCompleteFunction=n||null,this._workflowCompleteFunction=s||null,this._workflowAbortFunction=a||null,this._webRequestBeginFunction=o||null,this._webRequestCompleteFunction=l||null}return e.prototype.dispatch=function(e){return this._defaultActivityDispatcher.canHandleActivity(e)?void this._defaultActivityDispatcher.dispatch(e):void(null!=this._dispatchFunction&&this._dispatchFunction(e))},e.prototype.handleError=function(e,t){null!=this._handleErrorFunction&&this._handleErrorFunction(e,t)},e.prototype.abortMapBasedActivity=function(){if(this._drawObjectContext){if(!this._drawObjectContext.toolbar||!this._drawObjectContext.drawEvent||!this._drawObjectContext.activityContext)return!1;this._drawObjectContext.toolbar.deactivate(),dojo.disconnect(this._drawObjectContext.drawEvent),this._drawObjectContext.activityContext.abortActivity(),this._drawObjectContext=null}return!0},e.prototype.setDrawObjectContext=function(e){this._drawObjectContext=e},e.prototype.activityBegin=function(e){null!=this._activityBeginFunction&&this._activityBeginFunction(e)},e.prototype.activityComplete=function(e){null!=this._activityCompleteFunction&&this._activityCompleteFunction(e)},e.prototype.activityAbort=function(e){this.workflowAbort(e,e.workflow())},e.prototype.webRequestBegin=function(e,t){null!=this._webRequestBeginFunction&&this._webRequestBeginFunction(e,t)},e.prototype.webRequestComplete=function(e,t){null!=this._webRequestCompleteFunction&&this._webRequestCompleteFunction(e,t)},e.prototype.workflowComplete=function(e,t){null!=this._workflowCompleteFunction&&this._workflowCompleteFunction(e,t)},e.prototype.workflowAbort=function(e,t){null!=this._workflowAbortFunction&&this._workflowAbortFunction(e,t)},e.prototype.handleOpenReportUrl=function(e,t){window.open(e)},e}();t.SimpleActivityDispatcher=r})},"geocortex/essentials/catalog/CatalogEntry":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(){this.id=null,this.displayName=null,this.entries=null,this.type=null,this.entries=[]}return e}();t.CatalogEntry=i})},"geocortex/essentials/serviceDiscovery/ResultItem":function(){define(["require","exports"],function(e,t){"use strict"})},"geocortex/essentials/serviceDiscovery/ServiceDiscoveryProvider":function(){define(["require","exports"],function(e,t){"use strict"})},"geocortex/essentials/serviceDiscovery/serviceDiscoveryServicePoint":function(){define(["require","exports","geocortex/essentials/MapService","geocortex/essentials/FeatureLayerService"],function(e,t,i,r){"use strict";var n=function(){function e(e){this.service=e}return e.prototype.postProcess=function(e){e.thumbnailUrl||(e.thumbnailUrl=this.service.formatQuery("connections/{0}/preview?f=json&providerName={1}&url={2}",e.connection.id,e.serviceProviderName,e.url));for(var t in e.children)this.postProcess(e.children[t]);return e},e.prototype.findServices=function(e){var t=this.postProcess.bind(this.postProcess),i=this.service.formatQuery("connections/find?f=json&term={0}",e);return this.service.getRequest(i,"results").select(t)},e.prototype.expandService=function(e,t,i){if(1==arguments.length){var r=e;e=r.connection.id,t=r.serviceProviderName,i=r.url}var n=this.postProcess.bind(this.postProcess),s=this.service.formatQuery("connections/{0}/expand?f=json&providerName={1}&url={2}",e,t,i);return this.service.getRequest(s,null).select(n)},e.prototype.suggestHints=function(e){var t=this.service.formatQuery("connections/suggest?f=json&term={0}",e);return this.service.getRequest(t,"hints")},e.prototype.realizeMapService=function(e,t,n,s){if(1==arguments.length){var a=e;e=a.connection.id,t=a.serviceProviderName,n=a.url}var o=function(e){if(e.serviceType.indexOf("FeatureLayer")>=0){var t=new r.FeatureLayerService(n);return t._configureObject(e,!0),t}var s=new i.MapService(n);return s._configureObject(e,!0),s},l=this.service.formatQuery("connections/{0}/realize?f=json&providerName={1}&url={2}&sr={3}",e,t,n,s);return this.service.getRequest(l,null).select(o)},e}();t.ServiceDiscoveryServicePoint=n})},"geocortex/essentials/utilities/ServiceDiscoveryUtilities":function(){define(["require","exports","geocortex/essentials/MapService","geocortex/essentials/FeatureLayerService","geocortex/essentials/MapServiceConstants","geocortex/framework/SimplePromise","geocortex/framework/utils/utils"],function(e,t,i,r,n,s,a){"use strict";var o=function(){function e(){}return e.buildMapService=function(e,t){return new s.SimplePromise(function(s,o){if(!e)throw new Error('ServiceDiscoveryUtilities.buildMapService: Parameter "essentialsMap" is required.');if(!t)throw new Error('ServiceDiscoveryUtilities.buildMapService: Parameter "serviceDefinition" is required.');var l,c={id:a.alphaNumericToken(),connectionString:t.serviceUrl?"url="+t.serviceUrl:void 0},u=dojo.mixin(c,t);if(u.drawingBehavior===n.DrawingBehavior.FEATURE_LAYER){if(!dojo.isObject(esri.layers.FeatureLayer))throw new Error("This Javascript application must require the esri.layers.FeatureLayer package in order to use a site with feature layers");l=new r.FeatureLayerService}else if(u.drawingBehavior===n.DrawingBehavior.GEORSS_LAYER){if(!dojo.isObject(esri.layers.GraphicsLayer))throw new Error("This Javascript application must require the esri.layers.GraphicsLayer package in order to use a site with GeoRSS layers");l=new geocortex.essentials.GeoRssLayerService}else if(u.drawingBehavior===n.DrawingBehavior.KML_SERVICE){if(!dojo.isObject(esri.layers.KMLLayer))throw new Error("This Javascript application must require the esri.layers.KMLLayer package in order to use a site with KML layers");l=new geocortex.essentials.KmlService}else l=new i.MapService;l.isUserCreated=!0,l.userLayerType=n.UserLayerType.LAYER_ADDITION,l.essentialsMap=e,l.initialize(u),l instanceof r.FeatureLayerService&&(l.moveEnabled=!0,l.rotateEnabled=!0,l.editVerticesEnabled=!0,l.scaleEnabled=!0);for(var p=0,h=l.layers;p<h.length;p++){var d=h[p];d.isUserCreated=!0,d.userLayerType=n.UserLayerType.LAYER_ADDITION,d.includeInLayerList=!0,d.includeInLegend=!0,d.site=e.site,d.configuredVisible=!0,l.supportsLayerVisibility()?d.setVisibility(!0):d._visible=!0;var f=d.subLayerIds&&d.subLayerIds.length>0;if(f)d.supportsIdentify=d.supportsQuery=d.identifiable=d.queryable=!1;else{d.identifiable=d.supportsIdentify,d.queryable=d.supportsQuery,d.searchable=!0,d.showMapTips=!0;var y=l.serviceLayer,m=y instanceof esri.layers.GraphicsLayer||y instanceof esri.layers.ArcGISDynamicMapServiceLayer;d.snappable=m,d.snappingEnabled=m}}if(l.serviceLayer.loaded)return s(l);var g,v;g=l.serviceLayer.on("load",function(e){return g&&g.remove(),v&&v.remove(),s(l)}),v=l.serviceLayer.on("error",function(e){return g&&g.remove(),v&&v.remove(),o(e.error)})})},e}();t.ServiceDiscoveryUtilities=o})},"geocortex/essentials/serviceDiscovery/SiteServiceDiscoveryProvider":function(){define(["require","exports","geocortex/essentials/utilities/UrlUtilities","geocortex/framework/SimplePromise","geocortex/geocortex","geocortex/essentials/ServiceHelper","geocortex/essentials/utilities/ServiceDiscoveryUtilities"],function(e,t,i,r,n,s,a){"use strict";var o="/../../../connections",l=4.05,c=function(){function e(){this.initialized=!1,this.supported=!1}return e.prototype.initialize=function(e){this._site=e,this._rootUrl=i.UrlUtilities.resolveUrl(e.url,o,!0),this.supported=e.getEssentialsVersion()>=l,this.initialized=!0},e.prototype.getRootUrl=function(){return this._rootUrl},e.prototype.suggestHints=function(e){var t={f:"json",term:e};return this.sendRequest("suggest",t).then(function(e){return e.hints})},e.prototype.findServices=function(e,t){var i=this,r={f:"json",term:e,whitelistOnly:!0};return t&&(r=dojo.mixin(r,t)),this.sendRequest("find",r).then(function(e){return Array.isArray(e.results)&&e.results.forEach(function(e){return i._processItem(e)}),e.results})},e.prototype.expandService=function(e){var t=this,i=this._getConnectionId(e),r={f:"json",providerName:e.serviceProviderName,url:e.url};return this.sendRequest(i+"/expand",r).then(function(e){return t._processItem(e)})},e.prototype.realizeMapService=function(e,t){var i=this,r=this._getConnectionId(e),n={f:"json",providerName:e.serviceProviderName,url:e.url,sr:t,itemId:e.id||"null"};return this.sendRequest(r+"/realize",n).then(function(t){return i._createMapService(e,t)})},e.prototype.sendRequest=function(e,t){var s=this,a=r.SimplePromise.resolve(null);return a.then(function(){return s._verifyInitialized()}).then(function(){return s._verifySupported()}).then(function(){return t.f=t.f||"json",n.request({url:i.UrlUtilities.resolveUrl(s._rootUrl,e),content:n.encodeJson(t),handleAs:"json"})}).then(this._processError)},e.prototype._getConnectionId=function(e){var t=e.connection&&null!=e.connection.id?e.connection.id:"none";return t},e.prototype._processError=function(e){if(e&&e.error)throw e.error;return e},e.prototype._processItem=function(e){var t=e;if(t.connection&&null!=t.connection.id?t.isWhitelisted=!0:t.isWhitelisted=!1,
!t.thumbnailUrl){var r=this._getConnectionId(t),n=r+"/preview?f=json&providerName="+t.serviceProviderName+"&url="+t.url;t.thumbnailUrl=i.UrlUtilities.resolveUrl(this._rootUrl,n)}if(t.children)for(var s=0,a=t.children;s<a.length;s++){var o=a[s];this._processItem(o)}return t},e.prototype._createMapService=function(e,t){return t.serviceUrl||(t.serviceUrl=e.url),!t.serviceUrl&&t.connectionString&&(t.serviceUrl=s.ServiceHelper.extractConnectionStringValue(t.connectionString,"url")),t.serviceUrl?a.ServiceDiscoveryUtilities.buildMapService(this._site.essentialsMap,t):r.SimplePromise.reject(new Error("SiteServiceDiscoveryProvider._createMapService: Cannot create map service, the service URL is required."))},e.prototype._verifySupported=function(){if(!this.supported)throw new Error("Service Discovery is not supported in the current version of Geocortex Essentials.")},e.prototype._verifyInitialized=function(){if(!this.initialized)throw new Error("The Service Discovery client is not initialized yet.")},e}();t.SiteServiceDiscoveryProvider=c})},"geocortex/essentials/utilities/ExifUtilities":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(){}return e.getPointFromExif=function(t){if(!t||!dojo.isArray(t.GPSLatitude)||!dojo.isArray(t.GPSLongitude))return null;var i=e.dmsToDecimal(t.GPSLatitude),r=e.dmsToDecimal(t.GPSLongitude);return"S"===t.GPSLatitudeRef&&(i*=-1),"W"===t.GPSLongitudeRef&&(r*=-1),new esri.geometry.Point(r,i)},e.dmsToDecimal=function(e){return e.length>2?e[0]+e[1]/60+e[2]/3600:e.length>1?e[0]+e[1]/60:e[0]},e.getExifTagsFromImageBytes=function(t){if(0==t.byteLength)return{};var i=t.byteLength,r=new DataView(t);if(i<2||65496!=r.getUint16(0))return{};for(var n=2;n+4<i;n+=a+2){if(255!==r.getUint8(n))throw new Error("Expected start of a JPEG marker.");var s=r.getUint8(n+1),a=r.getUint16(n+2);if(n+a+2>i)throw new Error("Unexpected end of file.");if(225===s)return e.getExifTags(r,n+4,a-2)}return{}},e.getExifTags=function(t,i,r){if(r<6||1165519206!==t.getUint32(i)||0!==t.getUint16(i+4))throw new Error("EXIF header corrupted.");var n,s=t.getInt16(i+6);if(18761===s)n=!0;else{if(19789!==s)throw new Error("Unknown endian marker.");n=!1}if(42!==t.getUint16(i+8,n)){if(10752===t.getUint16(i+8,n))throw new Error("Endian marker test is backwards.");throw new Error("Endian marker test magic value is corrupted.")}var a,o=t.getUint32(i+10,n),l=e.readTags(t,i+6,i+6+o,e.TiffTags,n);if(l.ExifIFDPointer){var c=e.readTags(t,i+6,i+6+l.ExifIFDPointer,e.ExifTags,n);for(a in c)if(c.hasOwnProperty(a)){switch(a){case"ExifVersion":case"FlashpixVersion":c[a]=String.fromCharCode(c[a][0],c[a][1],c[a][2],c[a][3])}l[a]=c[a]}}if(l.GPSInfoIFDPointer){var u=e.readTags(t,i+6,i+6+l.GPSInfoIFDPointer,e.GPSTags,n);for(a in u)if(u.hasOwnProperty(a)){switch(a){case"GPSVersionID":u[a]=u[a][0]+"."+u[a][1]+"."+u[a][2]+"."+u[a][3]}l[a]=u[a]}}return l},e.readTags=function(t,i,r,n,s){for(var a={},o=t.getUint16(r,s),l=0;l<o;l++){var c=r+12*l+2,u=t.getUint16(c,s),p=n[u];p||(p=u.toString(16)),a[p]=e.readTagValue(t,c,i,r,s)}return a},e.readTagValue=function(t,i,r,n,s){var a,o,l,c,u,p=t.getUint16(i+2,s),h=t.getUint32(i+4,s),d=t.getUint32(i+8,s)+r;switch(p){case 1:case 7:if(1==h)return t.getUint8(i+8);for(a=h>4?d:i+8,o=[],l=0;l<h;l++)o[l]=t.getUint8(a+l);return o;case 2:return a=h>4?d:i+8,e.getStringFromBytes(t,a,h-1);case 3:if(1==h)return t.getUint16(i+8,s);for(a=h>2?d:i+8,o=[],l=0;l<h;l++)o[l]=t.getUint16(a+2*l,s);return o;case 4:if(1==h)return t.getUint32(i+8,s);for(o=[],l=0;l<h;l++)o[l]=t.getUint32(d+4*l,s);return o;case 5:if(1==h)return c=t.getUint32(d,s),u=t.getUint32(d+4,s),c/u;for(o=[],l=0;l<h;l++)c=t.getUint32(d+8*l,s),u=t.getUint32(d+4+8*l,s),o[l]=c/u;return o;case 9:if(1==h)return t.getInt32(i+8,s);for(o=[],l=0;l<h;l++)o[l]=t.getInt32(d+4*l,s);return o;case 10:if(1==h)return t.getInt32(d,s)/t.getInt32(d+4,s);for(o=[],l=0;l<h;l++)o[l]=t.getInt32(d+8*l,s)/t.getInt32(d+4+8*l,s);return o}return""},e.getStringFromBytes=function(e,t,i){for(var r="",n=t;n<t+i;n++)r+=String.fromCharCode(e.getUint8(n));return r},e}();i.ExifTags={36864:"ExifVersion",40960:"FlashpixVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",37121:"ComponentsConfiguration",37122:"CompressedBitsPerPixel",37500:"MakerNote",37510:"UserComment",40964:"RelatedSoundFile",36867:"DateTimeOriginal",36868:"DateTimeDigitized",37520:"SubsecTime",37521:"SubsecTimeOriginal",37522:"SubsecTimeDigitized",33434:"ExposureTime",33437:"FNumber",34850:"ExposureProgram",34852:"SpectralSensitivity",34855:"ISOSpeedRatings",34856:"OECF",37377:"ShutterSpeedValue",37378:"ApertureValue",37379:"BrightnessValue",37380:"ExposureBias",37381:"MaxApertureValue",37382:"SubjectDistance",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37396:"SubjectArea",37386:"FocalLength",41483:"FlashEnergy",41484:"SpatialFrequencyResponse",41486:"FocalPlaneXResolution",41487:"FocalPlaneYResolution",41488:"FocalPlaneResolutionUnit",41492:"SubjectLocation",41493:"ExposureIndex",41495:"SensingMethod",41728:"FileSource",41729:"SceneType",41730:"CFAPattern",41985:"CustomRendered",41986:"ExposureMode",41987:"WhiteBalance",41988:"DigitalZoomRation",41989:"FocalLengthIn35mmFilm",41990:"SceneCaptureType",41991:"GainControl",41992:"Contrast",41993:"Saturation",41994:"Sharpness",41995:"DeviceSettingDescription",41996:"SubjectDistanceRange",40965:"InteroperabilityIFDPointer",42016:"ImageUniqueID"},i.TiffTags={256:"ImageWidth",257:"ImageHeight",34665:"ExifIFDPointer",34853:"GPSInfoIFDPointer",40965:"InteroperabilityIFDPointer",258:"BitsPerSample",259:"Compression",262:"PhotometricInterpretation",274:"Orientation",277:"SamplesPerPixel",284:"PlanarConfiguration",530:"YCbCrSubSampling",531:"YCbCrPositioning",282:"XResolution",283:"YResolution",296:"ResolutionUnit",273:"StripOffsets",278:"RowsPerStrip",279:"StripByteCounts",513:"JPEGInterchangeFormat",514:"JPEGInterchangeFormatLength",301:"TransferFunction",318:"WhitePoint",319:"PrimaryChromaticities",529:"YCbCrCoefficients",532:"ReferenceBlackWhite",306:"DateTime",270:"ImageDescription",271:"Make",272:"Model",305:"Software",315:"Artist",33432:"Copyright"},i.GPSTags={0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude",5:"GPSAltitudeRef",6:"GPSAltitude",7:"GPSTimeStamp",8:"GPSSatellites",9:"GPSStatus",10:"GPSMeasureMode",11:"GPSDOP",12:"GPSSpeedRef",13:"GPSSpeed",14:"GPSTrackRef",15:"GPSTrack",16:"GPSImgDirectionRef",17:"GPSImgDirection",18:"GPSMapDatum",19:"GPSDestLatitudeRef",20:"GPSDestLatitude",21:"GPSDestLongitudeRef",22:"GPSDestLongitude",23:"GPSDestBearingRef",24:"GPSDestBearing",25:"GPSDestDistanceRef",26:"GPSDestDistance",27:"GPSProcessingMethod",28:"GPSAreaInformation",29:"GPSDateStamp",30:"GPSDifferential"},t.ExifUtilities=i})}}}),require(["geocortex/framework/resourceManager"],function(e){e.resourceManager.register("Essentials","inv","Invariant","json","e30=")});