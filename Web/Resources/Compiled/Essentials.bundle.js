require({cache:{"geocortex/config":function(){define(["require","exports"],function(e,o){"use strict";Object.defineProperty(o,"__esModule",{value:!0}),o.config={baseUrl:"http://localhost/",io:{errorHandler:function(e,o){dojo.publish("geocortex.Error",[e])},postLength:2e3,timeout:6e4},REST_version:"3.0",authenticationDialogId:null}})}}});!function(){require({cache:{"geocortex/essentials/ArcadeExpression":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/ArcGisPortalSecurityContext":function(){define(["require","exports","./OAuth2Client","./utilities/DecomposedUri","./utilities/StringUtilities"],function(e,t,i,r,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=(a.prototype.initiate=function(){return this.tokenResult||(this.tokenResult=i.OAuth2Client.getTokenFromImplicitGrant()),this.tokenResult?(i.OAuth2Client.removeImplicitGrantParamsAndUpdateUrlHash(),!0):(this.error=i.OAuth2Client.getErrorFromImplicitGrant(),this.error||i.OAuth2Client.redirectToLogOnPage(this.getLogOnUrl(),this.clientId),i.OAuth2Client.removeImplicitGrantParamsAndUpdateUrlHash(),!1)},a.prototype.getLogOnUrl=function(){return this.baseUrl+"oauth2/authorize"},a.prototype.getToken=function(e){return this.tokenResult&&e&&this.appliesTo(e)?this.tokenResult.token:null},a.prototype.appliesTo=function(e){for(var t=r.DecomposedUri.getHost(e),i=0;i<this.domains.length;i++)if(n.StringUtilities.endsWith(t,this.domains[i]))return!0;return!1},a);function a(e,t,i){this.baseUrl=e,this.domains=t,this.clientId=i}t.ArcGisPortalSecurityContext=s})},"geocortex/essentials/AsyncInitializable":function(){define(["require","exports","./../geocortex"],function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=(n.prototype.initialize=function(e){if(!this.isInitialized&&!this._initializing){var t=null!=e;if(t)this._restLoadHandler(!0,e);else{if(!this.url)throw new Error("Unable to initialize AsyncInitializable without a valid URL.");this._initializing=!0,i.request({url:this.url,content:{f:"json"},load:dojo.hitch(this,this._restLoadHandler,t),error:this._restErrorHandler,callbackParamName:"CallBack"})}}},n.prototype.doWhenInitialized=function(e,t){if(1===arguments.length&&(t=e,e=this),this.isInitialized)t.call(e,this);else var i=dojo.connect(this,"onInitialized",this,function(){dojo.disconnect(i),t.apply(e,arguments)})},n.prototype._configureObject=function(e,t,i){void 0===i&&(i=!0)},n.prototype._initializationFailedHandler=function(e){this.initializationFailure=e,this.onInitializationFailed&&this.onInitializationFailed(e)},n.prototype._initializedHandler=function(e){this.isInitialized=!0,this.onInitialized&&this.onInitialized(e),this._initializing=!1},n.prototype._restErrorHandler=function(e){this._initializationFailedHandler(e),this._initializedHandler(this)},n.prototype._restLoadHandler=function(e,t){this._configureObject(t,e),this._initializedHandler(this)},n);function n(e){this.initializationFailure=null,this.isInitialized=!1,this.onInitializationFailed=null,this.onInitialized=null,this._initializing=!1,this.url=e,this._initializedHandler=dojo.hitch(this,this._initializedHandler),this._initializationFailedHandler=dojo.hitch(this,this._initializationFailedHandler),this._restLoadHandler=dojo.hitch(this,this._restLoadHandler),this._restErrorHandler=dojo.hitch(this,this._restErrorHandler)}t.AsyncInitializable=r})},"geocortex/essentials/AuthenticationControlBlock":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});function i(){this.messageFromServer=null,this.password=null,this.pendingCalls=[],this.tokenService=null,this.tokenRootUri=null,this.targetRootUri=null,this.token=null,this.username=null}t.AuthenticationControlBlock=i})},"geocortex/essentials/AuthenticationControlBlockStore":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=(r.prototype.add=function(e){null===this.find(e.tokenRootUri)&&this._authenticationControlBlocks.push(e)},r.prototype.remove=function(e){for(var t=0;t<this._authenticationControlBlocks.length;t++)if(this._authenticationControlBlocks[t]===e)return this._authenticationControlBlocks.splice(t,1),!0;return!1},r.prototype.find=function(e){for(var t=0;t<this._authenticationControlBlocks.length;t++){var i=this._authenticationControlBlocks[t],r=i.tokenRootUri,n=i.targetRootUri;if(0===e.toLowerCase().indexOf(r.toLowerCase())||0===e.toLowerCase().indexOf(n.toLowerCase()))return i}return null},r.prototype.removeAt=function(e){this._authenticationControlBlocks.splice(e,1)},r);function r(){this._authenticationControlBlocks=[]}t.AuthenticationControlBlockStore=i})},"geocortex/essentials/BaseMap":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});function i(e){if(this.displayName=null,this.essentialsMap=null,this.extensions=[],this.id=null,this.iconUri=null,this.exportTilesMapServiceUri=null,this.properties={},this.services=[],!e)throw new Error("Essentials map is required for a basemap.");this.essentialsMap=e}t.BaseMap=i})},"geocortex/essentials/BaseMapService":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});function i(e){if(this.mapService=null,!e)throw new Error("Map service is required for a basemap service.");this.mapService=e}t.BaseMapService=i})},"geocortex/essentials/DataLink":function(){var r,a=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)});define(["require","exports","./AsyncInitializable","./../geocortex"],function(e,t,i,g){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r,n=(r=i.AsyncInitializable,a(s,r),s.prototype.isDataLinking=function(){return!!this._numDataLinkingRequests},s.prototype.performDataLinking=function(e,t,i){function r(e){i&&i(new Error(e))}var n=this;!e&&0<this.parameters.length&&r("No FeatureSetParameters provided");for(var s=this.url+"/link",a=null,o=0;o<this.parameters.length;o++){for(var l=this.parameters[o],c="",u=0;u<e.features.length;u++){var p=e.features[u],h=p.attributes[l.featureField];if(!h&&this.layer&&this.layer.fields){for(var d,f,y=0;y<this.layer.fields.length;y++){var m=this.layer.fields[y];if(m.name===l.featureField){d=m;break}}d&&(d.alias&&d.alias in p.attributes?f=d.alias:d.displayName&&d.displayName in p.attributes&&(f=d.displayName),f&&f in p.attributes&&p.attributes[f])}c+=(0===c.length?"":",")+(h||0===h?this._prepParamValue(h):" ")}c&&0<c.length&&((a=null===a?{}:a)[l.id]=c)}if(a){var v=g.encodeJson(dojo.mixin({f:"json"},a));this._numDataLinkingRequests++,g.request({url:s,content:v,load:function(e){n._numDataLinkingRequests--,!e&&i&&i(new Error("No results")),e.error&&i&&i(e.error),t&&t(n._parseConvertDates(e.results))},error:function(e){n._numDataLinkingRequests--,i&&i(e)},callbackParamName:"CallBack"})}else r("Missing Feature Fields.")},s.prototype._configureObject=function(e,t){if(void 0===e||void 0===e.displayName||void 0===e.parameters)throw new Error("Incorrect data link object returned from initialization");if(this.displayName=e.displayName,this.id=e.id,this.visible=void 0===e.visible||e.visible,this.isOneToOne=!!e.isOneToOne,this.parameters=e.parameters,this.searches=e.searches,this.searches)for(var i=0,r=this.searches.length;i<r;i++)this.searches[i].dataLink=this;t&&(this.isInitialized=!0),this.properties=g._getProperties(e.properties),this.extensions=g._getExtensions(e.extensions)},s.prototype._parseConvertDates=function(e){for(var t in e)if(e.hasOwnProperty(t)){var i=e[t];if("string"==typeof i){if(6<i.length&&"/Date("===i.substring(0,6)){i=parseInt(i.substring(6));var r=new Date(i);e[t]=r}}else"object"==typeof i&&(e[t]=this._parseConvertDates(i))}return e},s.prototype._prepParamValue=function(e){var t="";return"number"==typeof e?t=e.toString():"string"==typeof e&&(t=e.replace(/,/g,"\\,")),t},s);function s(e){var t=r.call(this,e)||this;return t.displayName=null,t.extensions=[],t.id=null,t.visible=null,t.isOneToOne=!1,t.layer=null,t.parameters=[],t.searches=[],t.properties={},t._numDataLinkingRequests=0,t}t.DataLink=n})},"geocortex/essentials/DataLinkParameter":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});function i(){this.featureField=null,this.id=null,this.name=null,this.type=null}t.DataLinkParameter=i})},"geocortex/essentials/DataLinkSearch":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/DistanceUnit":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i,r,n=(s.prototype.isLinear=function(){return!(this.type===i.DEGREES||this.type===i.RADIANS||this.type===i.GRADS||this.type===i.OTHER)},s);function s(e,t){this.name=e,this.type=t}t.DistanceUnit=n,(r=i=t.DistanceUnitType||(t.DistanceUnitType={})).OTHER="Other",r.INCHES="Inches",r.FEET="Feet",r.US_SURVEY_FEET="USSurveyFeet",r.YARDS="Yards",r.MILES="Miles",r.NAUTICAL_MILES="NauticalMiles",r.MILLIMETERS="Millimeters",r.CENTIMETERS="Centimeters",r.DECIMETERS="Decimeters",r.METERS="Meters",r.KILOMETERS="Kilometers",r.DEGREES="Degrees",r.RADIANS="Radians",r.GRADS="Grads"})},"geocortex/essentials/EssentialsFeatureSet":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=(r.prototype.toJson=function(){return JSON.stringify(this)},r);function r(){}t.EssentialsFeatureSet=i})},"geocortex/essentials/EssentialsLayerInfo":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});function i(){}t.EssentialsLayerInfo=i})},"geocortex/essentials/ExportMapImageOptions":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});function i(e,t){void 0===t&&(t="Png"),this.defaultOutputFormat=t,this.allowIncludeGeoreferenceData=e}t.ExportMapImageOptions=i})},"geocortex/essentials/Extension":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});function i(e,t){this.className=e,this.instance=t}t.Extension=i})},"geocortex/essentials/ExtentManager":function(){define(["require","exports"],function(e,t){"use strict";var s,i;Object.defineProperty(t,"__esModule",{value:!0}),(i=s=s||{})[i.NONE=-1]="NONE",i[i.RESIZE=0]="RESIZE",i[i.REPOSITION=1]="REPOSITION",i[i.EXTENT_CHANGE=2]="EXTENT_CHANGE";var r=(n.prototype._onResize=function(e,t,i){this._firstMapResizeExecuted?this._handleNextExtentChange():this.firstResize()},n.prototype.firstResize=function(){this._firstMapResizeExecuted=!0,this._initialExtent&&this._map.extent&&!this._fitTiledMapsToExtent&&!this._map.extent.expand(1.75).contains(this._initialExtent)&&console.log("The 'fitTiledMapsToExtent' parameter may need to be set to true in configuration for the initial extent to be shown completely on the map."),this._handleNextExtentChange()},n.prototype._onReposition=function(e,t){this._handleNextExtentChange()},n.prototype._onExtentChange=function(){this._extentChangeInProgress&&(this._currentExtentChangePriority=-1,this._extentChangeInProgress=!1,this._handleNextExtentChange())},n.prototype.registerLayer=function(e){this._hasLoaded()||this._newLayers.push(e)},n.prototype._handleNextExtentChange=function(){if(this._hasLoaded())if(null!==this._queuedExtentChange[s.RESIZE]&&void 0!==this._queuedExtentChange[s.RESIZE]){var e=this._queuedExtentChange[s.RESIZE];this._queuedExtentChange[s.RESIZE]=null,e(this._map)}else if(null!==this._queuedExtentChange[s.REPOSITION]&&void 0!==this._queuedExtentChange[s.REPOSITION]){var t=this._queuedExtentChange[s.REPOSITION];this._queuedExtentChange[s.REPOSITION]=null,t(this._map)}else if(null!==this._queuedExtentChange[s.EXTENT_CHANGE]&&void 0!==this._queuedExtentChange[s.EXTENT_CHANGE]){this._extentChangeInProgress=!0,this._currentExtentChangePriority=this._queuedExtentChangePriority,this._queuedExtentChangePriority=-1;var i=this._queuedExtentChange[s.EXTENT_CHANGE];this._queuedExtentChange[s.EXTENT_CHANGE]=null,i(this._map)}},n.prototype.changeExtentWithPriority=function(t,e){function i(e){null!==r.currentExtentChangeHandle&&r.currentExtentChangeHandle.cancel(),r.currentExtentChangeHandle=t(e),r.currentExtentChangeHandle.then(dojo.hitch(r,r._onExtentChange),dojo.hitch(r,r._onExtentChange))}var r=this,n=void 0!==e?e:5;if(this._isExtentChangeBlocked()){if(n<this._queuedExtentChangePriority)return;this._queuedExtentChangePriority=n,this._queuedExtentChange[s.EXTENT_CHANGE]=i}else{if(n<this._currentExtentChangePriority)return;this._currentExtentChangePriority=n,this._extentChangeInProgress=!0,i(this._map)}},n.prototype.setExtentWithPriority=function(r,e){var n=this;this.changeExtentWithPriority(function(i){return new Promise(function(e,t){i.setExtent(r,n._fitTiledMapsToExtent).then(e,e)})},e)},n.prototype.centerAtWithPriority=function(n,e){this.changeExtentWithPriority(function(i){var e=i.extent.getCenter(),t=i.extent.getWidth()/i.width,r=i.extent.getHeight()/i.height;return n&&(Math.abs(e.x-n.x)>=t||Math.abs(e.y-n.y)>=r)?new Promise(function(e,t){i.centerAt(n).then(e,e)}):Promise.resolve()},e)},n.prototype.setScaleWithPriority=function(r,e){this.changeExtentWithPriority(function(i){return r===i.getScale()?Promise.resolve():new Promise(function(e,t){i.setScale(r).then(e,e)})},e)},n.prototype.blockForResize=function(e,t,i){this._firstMapResizeExecuted&&(e===this._map.width&&t===this._map.height||this._resize(!this._isResizeBlocked()))},n.prototype.blockForReposition=function(){this._firstMapResizeExecuted&&this._resize(!this._isRepositionBlocked())},n.prototype._resize=function(t){function i(e){e.position.update(0,0),e.resize(t)}t?i(this._map):this._queuedExtentChange[s.RESIZE]=function(e){i(e)}},n.prototype._isExtentChangeBlocked=function(){return null!=this._queuedExtentChange[s.REPOSITION]||null!=this._queuedExtentChange[s.RESIZE]||!this._hasLoaded()},n.prototype._isRepositionBlocked=function(){return this._extentChangeInProgress||!this._hasLoaded()},n.prototype._isResizeBlocked=function(){return this._isRepositionBlocked()},n.prototype._hasLoaded=function(){return this._map&&this._map.loaded&&this._firstMapResizeExecuted},n);function n(e,t){var i=this;this._map=null,this._currentExtentChangePriority=-1,this._queuedExtentChangePriority=-1,this._queuedExtentChange=[],this._extentChangeInProgress=!1,this._fitTiledMapsToExtent=!1,this._newLayers=[],this._initialExtent=null,this.currentExtentChangeHandle=null,this._firstMapResizeExecuted=!1,this._map=e,this._fitTiledMapsToExtent=!!t,this._fitTiledMapsToExtent&&console.log("The fitTiledMapsToExtent parameter is active. When true, for maps that contain tiled map service layers, you are guaranteed to have the input extent shown completely on the map."),this._map.on("resize",dojo.hitch(this,this._onResize)),this._map.on("reposition",dojo.hitch(this,this._onReposition));var r=this._map.on("extent-change",function(){r.remove(),i._firstMapResizeExecuted=!0})}t.ExtentManager=r})},"geocortex/essentials/FeatureCluster":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/FeatureHeatMap":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/FeatureHyperlink":function(){define(["require","exports","./RestHelper"],function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});function i(e,t){this.encodeUriReplacementValues=e.encodeUriReplacementValues,this.target=e.target,this.text=e.text,this.toolTip=e.toolTip;var i=null;t&&t.mapService&&t.mapService.essentialsMap&&(i=t.mapService.essentialsMap.site),this.uri=r.RestHelper.processClientSideTokens(i,e.uri),this.iconUri=r.RestHelper.processClientSideTokens(i,e.iconUri),this.layer=t}t.FeatureHyperlink=i})},"geocortex/essentials/FeatureLayerService":function(){var r,a=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)});define(["require","exports","./MapService","./../geocortex","./RestHelperHTTPService"],function(e,t,i,l,c){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r,n=(r=i.MapService,a(s,r),s.prototype.getEmptyFeatureCollection=function(){return JSON.parse(this._initialFeatureCollection)},s.prototype.restoreFeatureLayer=function(){if(!this._serviceLayer._mode)switch(this._serviceLayer.mode){case esri.layers.FeatureLayer.MODE_SNAPSHOT:this._serviceLayer._mode=new esri.layers._SnapshotMode(this._serviceLayer);break;case esri.layers.FeatureLayer.MODE_ONDEMAND:this._serviceLayer._mode=new esri.layers._OnDemandMode(this._serviceLayer);break;case esri.layers.FeatureLayer.MODE_SELECTION:this._serviceLayer._mode=new esri.layers._SelectionMode(this._serviceLayer)}this.replaceFeatureLayer(this._serviceLayer,!0,!0,!0),this.serviceLayer.resume(),this.serviceLayer.mode===esri.layers.FeatureLayer.MODE_SNAPSHOT&&0===this.serviceLayer.graphics.length&&this.serviceLayer.refresh()},s.prototype.replaceFeatureLayer=function(e,t,i,r){var n=this.serviceLayer;if(!e)throw new Error("featureLayer cannot be null in order to replace the feature layer.");var s=this._getEsriMap();if(!s)throw new Error("Unable to get access to the Esri map object to perform the Feature Layer replace.");if(!this.serviceLayer)throw new Error("ServiceLayer not present. Can't replace the the FeatureLayer");t&&(e.visible=n.visible,e.setMaxScale(n.maxScale),e.setMinScale(n.minScale)),i&&(e.opacity=n.opacity),r&&e.setRenderer(n.renderer);var a=dojo.indexOf(s.graphicsLayerIds,n.id);this.serviceLayer=e,n.suspend(),s.removeLayer(n),s.addLayer(e,a),n.url||this._cleanUpLayer(n)},s.prototype._cleanUpLayer=function(e){if(e.applyEdits(),e._essentialsMetadata){var t=e._essentialsMetadata.eventHandlers,i=0;for(i=0;i<t.length;i++)dojo.disconnect(t[i])}},s.prototype.setOpacity=function(e){r.prototype.setOpacity.call(this,e),this.featureClustering&&this.featureClustering.enabled&&this.clusterLayer&&this.explodedClusterLayer&&(this.clusterLayer.setOpacity(this.opacity),this.explodedClusterLayer.setOpacity(this.opacity))},s.prototype.queryCount=function(e,t,i){this.isServiceLayerLoaded&&this.serviceLayer&&this.serviceLayer.queryCount(e,function(e){t&&t(e)},function(e){i&&i(e)})},s.prototype.queryFeatures=function(e,t,i){if(this.isServiceLayerLoaded&&this.serviceLayer)return this.serviceLayer.queryFeatures(e,t,i);var r=new Error("Esri layer has not finished loading");if(i)return i(r),null;var n=new dojo.Deferred;return n.reject(r),n},s.prototype.queryIds=function(e,t,i){if(this.isServiceLayerLoaded&&this.serviceLayer)return this.serviceLayer.queryIds(e,t,i);if(i){var r=new Error("Esri layer has not finished loading");i(r);var n=new dojo.Deferred;return n.reject(r),n}},s.prototype.queryRelatedFeatures=function(e,t,i){if(this.isServiceLayerLoaded&&this.serviceLayer)return this.serviceLayer.queryRelatedFeatures(e,t,i);if(i){var r=new Error("Esri layer has not finished loading");i(r);var n=new dojo.Deferred;return n.reject(r),n}},s.prototype._getEsriMap=function(){var e=null;return null!==this.essentialsMap&&null!==this.essentialsMap.site&&(e=this.essentialsMap.site.getMap()),e},s.prototype._configureObject=function(e,t){if(void 0===e||void 0===e.outFields||void 0===e.queryMode||void 0===e.where)throw new Error("Incorrect map service object returned from initialization");this._configurePropertiesAndrenderer(e),r.prototype._configureObject.call(this,e,t)},s.prototype._configurePropertiesAndrenderer=function(e){if(this.disableClientCaching=!!e.disableClientCaching,this.onDemandCacheSize=void 0===e.onDemandCacheSize||null===e.onDemandCacheSize?this.onDemandCacheSize:e.onDemandCacheSize,e.outFields||(e.outFields="*"),this.outFields=e.outFields,this.where=e.where,void 0===e.queryMode)this.queryMode=esri.layers.FeatureLayer.MODE_ONDEMAND;else switch(e.queryMode){case"Selection":case"SelectionOnly":this.queryMode=esri.layers.FeatureLayer.MODE_SELECTION;break;case"Snapshot":this.queryMode=esri.layers.FeatureLayer.MODE_SNAPSHOT;break;default:this.queryMode=esri.layers.FeatureLayer.MODE_ONDEMAND}if(e.tileHeight&&(this.tileHeight=e.tileHeight),e.tileWidth&&(this.tileWidth=e.tileWidth),e.selectionColor&&(this.selectionColor=e.selectionColor),e.color&&(this.color=e.color,this._colorSet=!0,3<this.color.length&&(this.color[3]=this.color[3]/255)),this.editVerticesEnabled=!e.hasOwnProperty("editVerticesEnabled")||e.editVerticesEnabled,this.moveEnabled=!e.hasOwnProperty("moveEnabled")||e.moveEnabled,this.scaleEnabled=!e.hasOwnProperty("scaleEnabled")||e.scaleEnabled,this.rotateEnabled=!e.hasOwnProperty("rotateEnabled")||e.rotateEnabled,e.renderer)try{this.renderer=esri.renderer.fromJson(e.renderer)}catch(e){return}},s.prototype._updateServiceToken=function(e){if(r.prototype._updateServiceToken.call(this,e),this.serviceLayer){var t=this.serviceLayer._task;t&&t._url&&t._url.query&&(t._url.query.token=e)}},s.prototype._createServiceLayer=function(){r.prototype._createServiceLayer.call(this);var e=this.serviceUrl;this.serviceToken&&(e=c.RestHelperHTTPService.appendTokenToUrl(e,this.serviceToken));var t={};t.id=this.id,t.opacity=this.configuredOpacity,t.visible=this._computeInitServiceLayerVisibility(),this.outFields&&0<this.outFields.length&&(t.outFields=this.outFields.split(",")),null!==this.queryMode&&(t.mode=this.queryMode),null!==this.tileHeight&&null!==this.tileWidth&&this.queryMode===esri.layers.FeatureLayer.MODE_ONDEMAND&&(t.tileHeight=this.tileHeight,t.tileWidth=this.tileWidth),this.serviceLayer=new esri.layers.FeatureLayer(e,t),this.serviceLayer.setRenderer(this.renderer),this.attributionDataUrl&&""!==this.attributionDataUrl?(this.serviceLayer.attributionDataUrl=this.attributionDataUrl,this.serviceLayer.hasAttributionData=!0):this.hasAttributionData&&(this.serviceLayer.attributionDataUrl=this.url+"/Attribution",this.serviceLayer.hasAttributionData=!0),this._serviceLayer=this.serviceLayer,this.where&&this.serviceLayer.setDefinitionExpression(this.where),dojo.connect(this.serviceLayer,"onError",this,this._layerLoadErrorHandler),this.serviceLayer.loaded?this._handleLayerLoadEvent(this.serviceLayer):dojo.connect(this.serviceLayer,"onLoad",dojo.hitch(this,this._handleLayerLoadEvent)),r.prototype.initiateServiceFailureTimer.call(this)},s.prototype._computeInitServiceLayerVisibility=function(){var e=this._initiallyVisible;return e&&this.layers&&1===this.layers.length&&(e=this.layers[0].isVisible()),e},s.prototype._handleLayerLoadEvent=function(e){if(this.serviceLayer.version<10||this._colorSet){var t=null;if("esriGeometryPoint"===this.serviceLayer.geometryType){t=new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE,15,null,new esri.Color(this.selectionColor));var i=new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE,15,null,new esri.Color(this.color)),r=new esri.renderer.SimpleRenderer(i);this.serviceLayer.setRenderer(r)}else if("esriGeometryPolyline"===this.serviceLayer.geometryType){t=new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new esri.Color(this.selectionColor),1);var n=new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new esri.Color(this.color),1),s=new esri.renderer.SimpleRenderer(n);this.serviceLayer.setRenderer(s)}else if("esriGeometryPolygon"===this.serviceLayer.geometryType){t=new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new esri.Color([0,0,0]),1),new esri.Color(this.selectionColor));var a=new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new esri.Color([0,0,0]),1),new esri.Color(this.color)),o=new esri.renderer.SimpleRenderer(a);this.serviceLayer.setRenderer(o)}this.serviceLayer.setSelectionSymbol(t)}var l=this.serviceLayer.getEditCapabilities();this.canUpdate=l.canUpdate,this.canAdd=l.canCreate,this.canDelete=l.canDelete,this.canEdit=this.serviceLayer.isEditable(),this.canAddAttachments=!1,this.serviceLayer.capabilities&&(this.canAddAttachments=this.serviceLayer.version&&10.1<=this.serviceLayer.version&&this.serviceLayer.hasAttachments&&this.canEdit),this._initialFeatureCollection=JSON.stringify(this.serviceLayer.toJson()),this._handleServiceLayerLoaded(e)},s.prototype.hasOriginRelationships=function(){if(this.serviceLayer&&10.1<=this.serviceLayer.version&&this.serviceLayer.relationships&&0<this.serviceLayer.relationships.length){for(var e=0,t=this.serviceLayer.relationships;e<t.length;e++)if("esriRelRoleOrigin"===t[e].role)return!0;return!1}return!1},s.prototype.getRelatedFeatureLayer=function(e,t,i){var r=new dojo.Deferred;if(this.serviceLayer.version<10.1){var n=new Error("getRelatedFeatureLayer is only available for feature layer from ArcGIS 10.1 or greater.");return r&&-1===r.fired&&r.resolve(n),"function"==typeof i&&i(n),r}var s=this._getEsriRelation(e);if(!s)return n=new Error("Relation not found: "+e),r&&r.reject(n),"function"==typeof i&&i(n),r;var a=this.serviceUrl.substring(0,this.serviceUrl.lastIndexOf("/")+1)+s.relatedTableId;this.serviceToken&&(a=c.RestHelperHTTPService.appendTokenToUrl(a,this.serviceToken)),void 0===esri.getProxyRule(a)&&null!==this.proxyUrl&&esri.addProxyRule({urlPrefix:a,proxyUrl:this.proxyUrl});var o=new esri.layers.FeatureLayer(a,{mode:esri.layers.FeatureLayer.MODE_SELECTION,outFields:["*"]});return dojo.connect(o,"onLoad",dojo.hitch(this,function(e){l.deferredResolve(r,e),"function"==typeof t&&t(e)})),dojo.connect(o,"onError",dojo.hitch(this,function(e){r&&-1===r.fired&&r.resolve(e),"function"==typeof i&&i(e)})),r},s.prototype._getEsriRelation=function(e){if("string"==typeof e&&(e=parseInt(e,10)),this.serviceLayer.relationships)for(var t=0,i=this.serviceLayer.relationships;t<i.length;t++){var r=i[t];if(r.id===e)return r}return null},s);function s(e){var t=r.call(this,e)||this;return t.color=[255,0,0],t.selectionColor=[0,255,255],t.disableClientCaching=!1,t.onDemandCacheSize=1e3,t.outFields="",t.queryMode=esri.layers.FeatureLayer.MODE_ONDEMAND,t.tileHeight=null,t.tileWidth=null,t.where=null,t.canUpdate=null,t.canAdd=null,t.canDelete=null,t.canEdit=null,t.canAddAttachments=null,t.moveEnabled=null,t.rotateEnabled=null,t.editVerticesEnabled=null,t.scaleEnabled=null,t.renderer=null,t._colorSet=!1,t._initialFeatureCollection=null,t._serviceLayer=null,t.serviceUrl=e,t}t.FeatureLayerService=n})},"geocortex/essentials/Field":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=(r.esriFieldTypeSmallInteger="esriFieldTypeSmallInteger",r.esriFieldTypeInteger="esriFieldTypeInteger",r.esriFieldTypeSingle="esriFieldTypeSingle",r.esriFieldTypeDouble="esriFieldTypeDouble",r.esriFieldTypeString="esriFieldTypeString",r.esriFieldTypeDate="esriFieldTypeDate",r.esriFieldTypeOID="esriFieldTypeOID",r.esriFieldTypeGeometry="esriFieldTypeGeometry",r.esriFieldTypeBlob="esriFieldTypeBlob",r.esriFieldTypeRaster="esriFieldTypeRaster",r.esriFieldTypeGUID="esriFieldTypeGUID",r.esriFieldTypeGlobalID="esriFieldTypeGlobalID",r.esriFieldTypeXML="esriFieldTypeXML",r);function r(){}t.EsriFieldTypes=i;var n=(s.essentialsFieldTypeSmallInteger="Int16",s.essentialsFieldTypeInteger="Int32",s.essentialsFieldTypeSingle="Single",s.essentialsFieldTypeDouble="Double",s.essentialsFieldTypeString="String",s.essentialsFieldTypeDate="DateTime",s.essentialsFieldTypeGUID="Guid",s.essentialsFieldTypeObject="Object",s);function s(){}t.EssentialsFieldTypes=n;var a=(o.prototype.toJson=function(){return{alias:this.alias,dataType:this.dataType,displayName:this.displayName,focusField:this.focusField,hyperlinkLabel:this.hyperlinkLabel,name:this.name,searchable:this.searchable,visible:this.visible,editable:this.editable,format:this.format}},o.convertFromEsriType=function(e){if(!e||0!==e.indexOf("esriFieldType"))return e;switch(e){case i.esriFieldTypeGeometry:case i.esriFieldTypeBlob:case i.esriFieldTypeRaster:return n.essentialsFieldTypeObject;case i.esriFieldTypeDate:return n.essentialsFieldTypeDate;case i.esriFieldTypeDouble:return n.essentialsFieldTypeDouble;case i.esriFieldTypeGlobalID:return n.essentialsFieldTypeGUID;case i.esriFieldTypeInteger:case i.esriFieldTypeOID:return n.essentialsFieldTypeInteger;case i.esriFieldTypeSingle:return n.essentialsFieldTypeSingle;case i.esriFieldTypeSmallInteger:return n.essentialsFieldTypeSmallInteger;case i.esriFieldTypeGUID:case i.esriFieldTypeString:case i.esriFieldTypeXML:default:return n.essentialsFieldTypeString}},o.convertToEsriFieldType=function(e){switch(e){case n.essentialsFieldTypeObject:return i.esriFieldTypeBlob;case n.essentialsFieldTypeDate:return i.esriFieldTypeDate;case n.essentialsFieldTypeDouble:return i.esriFieldTypeDouble;case n.essentialsFieldTypeGUID:return i.esriFieldTypeGlobalID;case n.essentialsFieldTypeInteger:return i.esriFieldTypeInteger;case n.essentialsFieldTypeSingle:return i.esriFieldTypeSingle;case n.essentialsFieldTypeSmallInteger:return i.esriFieldTypeSmallInteger;case n.essentialsFieldTypeString:default:return i.esriFieldTypeString}},o);function o(e){if(this.layer=null,!e||!e.layer)throw new Error("Layer is required.");this.layer=e.layer,this.alias=e.alias,this.dataType=e.dataType,this.displayName=e.displayName,this.focusField=!!e.focusField,this.hyperlinkLabel=e.hyperlinkLabel,this.name=e.name,this.searchable=!!e.searchable,this.visible=!!e.visible,this.editable=null===e.editable||void 0===e.editable||e.editable,this.format=e.format}t.Field=a})},"geocortex/essentials/GeocodingEndpoint":function(){var r,u=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)});define(["require","exports","./../geocortex","./AsyncInitializable","./ServiceHelper"],function(e,t,i,r,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s,a,o,l=(s=r.AsyncInitializable,u(c,s),c.prototype._configureObject=function(e){if(!(e.hasOwnProperty("id")&&e.hasOwnProperty("displayName")&&e.hasOwnProperty("serviceType")&&e.hasOwnProperty("connectionString")&&e.hasOwnProperty("globalSearchKey")&&e.hasOwnProperty("parameters")))throw new Error("Incorrect geocoding endpoint object returned from initialization");this.id=e.id,this.displayName=e.displayName,this.iconUri=e.iconUri,this.featureZoomScale=e.featureZoomScale,this.geocoderType=e.serviceType,this.includeInGlobalSearch=e.includeInGlobalSearch,this.isDefaultReverseGeocoder=e.isDefaultReverseGeocoder,this.globalSearchKey=e.globalSearchKey,this.isDefaultBatchGeocoder=e.isDefaultBatchGeocoder,this._processConnectionString(e.connectionString),this.properties=i._getProperties(e.properties),this.extensions=i._getExtensions(e.extensions),this.parameters=e.parameters},c.prototype._processConnectionString=function(e){var t=n.ServiceHelper.extractConnectionStringValue;if(this.geocoderType===a.BING_GEOCODER){this.bingProperties={};var i=t(e,"key");i&&0<i.length&&(this.bingProperties.bingMapsKey=i),(i=t(e,"culture"))&&0<i.length&&(this.bingProperties.culture=i)}else if(this.geocoderType===a.ARCGIS_GEOCODER){var r=t(e,"url");r&&0<r.length&&(this.geocoderUrl=r),this.geocoderToken=t(e,"token")}else console.error("Unknown geocoder type '"+this.geocoderType+"'")},c);function c(e){var t=s.call(this,e)||this;return t.bingProperties=null,t.displayName=null,t.extensions=[],t.id=null,t.properties={},t.geocoderType=null,t.geocoderUrl=null,t.geocoderToken=null,t.includeInGlobalSearch=!1,t.iconUri=null,t.featureZoomScale=null,t.isDefaultReverseGeocoder=!1,t.site=null,t.parameters=[],t.globalSearchKey=null,t.isDefaultBatchGeocoder=!1,t}t.GeocodingEndpoint=l,(o=a=t.GeocodingEndpointType||(t.GeocodingEndpointType={})).ARCGIS_GEOCODER="ArcGisGeocoder",o.BING_GEOCODER="BingGeocoder"})},"geocortex/essentials/GeometryEndpoint":function(){var r,c=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)});define(["require","exports","./AsyncInitializable","./../geocortex","./ServiceHelper"],function(e,t,i,r,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s,a,o=(s=i.AsyncInitializable,c(l,s),l.prototype._configureObject=function(e){if(void 0===e.id||void 0===e.displayName||void 0===e.connectionString)throw new Error("Incorrect geometry endpoint object returned from initialization");this.id=e.id,this.displayName=e.displayName,this.geometryServiceType=e.serviceType,this._processConnectionString(e.connectionString),this.properties=r._getProperties(e.properties),this.extensions=r._getExtensions(e.extensions)},l.prototype._processConnectionString=function(e){var t=n.ServiceHelper.extractConnectionStringValue;if(this.geometryServiceType===a.ARCGIS_GEOMETRY){var i=t(e,"url");i&&0<i.length&&(this.geometryServiceUrl=i),this.geometryServiceToken=t(e,"token")}else console.error("Unknown geometry service type '"+this.geometryServiceType+"'")},l);function l(e){var t=s.call(this,e)||this;return t.displayName=null,t.extensions=[],t.id=null,t.properties={},t.geometryServiceType=null,t.geometryServiceUrl=null,t.geometryServiceToken=null,t.site=null,t}t.GeometryEndpoint=o,(a=t.GeometryEndpointType||(t.GeometryEndpointType={})).ARCGIS_GEOMETRY="ArcGisGeometry"})},"geocortex/essentials/GeometryUtilities":function(){define(["require","exports"],function(e,t){"use strict";function i(e,t,i){return null==e||null==t?i:!!(e.isWebMercator&&t.isWebMercator&&e.isWebMercator()&&t.isWebMercator())||e.wkid===t.wkid&&(0<e.wkid||e.wkt.toLowerCase()==t.wkt.toLowerCase())}function p(e){var t=e.rings[0][0],i=e.rings[0][1],r=null,n=e.rings[0].slice(2,e.rings[0].length);n.push(t);for(var s=0;s<n.length;++s){var a=n[s],o=this.crossProduct(a,t,i);if(0<o&&!0===r||o<0&&!1===r)return!1;r=0<o,t=i,i=a}return!0}function h(e,t,i){return i=i||[0,0],(e[0]-i[0])*(t[1]-i[1])-(e[1]-i[1])*(t[0]-i[0])}Object.defineProperty(t,"__esModule",{value:!0}),t.spatialRefsAreEqual=i,t.envelopesAreEqual=function(e,t){return null==e||null==t?null==e&&null==t:i(e.spatialReference,t.spatialReference)&&e.xmin==t.xmin&&e.ymin==t.ymin&&e.xmax==t.xmax&&e.ymax==t.ymax},t.getExtent=function(e){if(e.length)var t=new esri.geometry.Extent(Number.MAX_VALUE,Number.MAX_VALUE,Number.MIN_VALUE,Number.MIN_VALUE,e[0].spatialReference);for(var i=0;i<e.length;++i){var r=e[i].getExtent();t.xmin=Math.min(r.xmin,t.xmin),t.ymin=Math.min(r.ymin,t.ymin),t.xmax=Math.min(r.xmax,t.xmax),t.xmax=Math.min(r.ymax,t.ymax)}return t},t.envelopeToPolygon=function(e){var t=new esri.geometry.Polygon(e.spatialReference);return t.addRing([[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]),t},t.isValidGeometry=function(e){if("polygon"!=e.type)return!0;var t=e;if(0==t.rings.length||t.rings.length<3)return!0;if(p(t)){var i=t.rings[0][0],r=t.rings[0][1],n=t.rings[0].slice(2,t.rings[0].length);n.push(i);for(var s=0;s<n.length;++s){var a=n[s];if(0<h(i,a,r))return!0;i=r,r=a}return!1}for(var o=0,l=0;l<t.rings.length;++l){var c=t.rings[l],u=0;for(s=0;s<c.length;++s)u=(s+1)%c.length,o+=c[s][0]*-c[u][1],o-=-c[s][1]*c[u][0]}return 0<o},t.isSelfIntersectingPolygon=function(e){if(esri.geometry.polygonSelfIntersecting)return esri.geometry.polygonSelfIntersecting(e);if(e.isSelfIntersecting)return e.isSelfIntersecting(e);throw new Error("No self intersection method found")},t.isConvex=p,t.pointInEnvelope=function(e,t){if(!this.spatialRefsAreEqual(e.spatialReference,t.spatialReference,!0))throw new Error("Mismatched spatial references.");return!(e.x<t.xmin||e.x>t.xmax)&&!(e.y<t.ymin||e.y>t.ymax)},t.clipEnvelope=function(e,t){if(!this.spatialRefsAreEqual(e.spatialReference,t.spatialReference,!0))throw new Error("Mismatched spatial references.");function i(e,t,i){return e<t?t:i<e?i:e}var r=new esri.geometry.Extent(e.xmin,e.ymin,e.xmax,e.ymax,e.spatialReference);return r.xmin=i(e.xmin,t.xmin,t.xmax),r.xmin=i(e.ymin,t.ymin,t.ymax),r.xmin=i(e.xmax,t.xmin,t.xmax),r.xmin=i(e.ymax,t.ymin,t.ymax),r},t.scaleEnvelope=function(e,t,i){return new esri.geometry.Extent(e.xmin*t,e.ymin*i,e.xmax*t,e.ymax*i,e.spatialReference)},t.scaleEnvelopeWithoutTranslation=function(e,t){if(null==e)return null;var i=e.getCenter();return new esri.geometry.Extent(i.x-e.getWidth()*(t/2),i.y-e.getHeight()*(t/2),i.x+e.getWidth()*(t/2),i.y+e.getHeight()*(t/2),e.spatialReference)},t.computeDistance=function(e,t){var i=t.x-e.x,r=t.y-e.y;return Math.sqrt(i*i+r*r)},t.translateEnvelope=function(e,t,i){return new esri.geometry.Extent(e.xmin+t,e.ymin+i,e.xmax+t,e.ymax+i,e.spatialReference)},t.length=function(e){return Math.sqrt(e.x*e.x+e.y*e.y)},t.normalize=function(e){var t=this.length(e);return new esri.geometry.Point(e.x/t,e.y/t)},t.angle=function(e,t){if(!this.spatialRefsAreEqual(e.spatialReference,t.spatialReference,!0))throw new Error("Mismatched spatial references");return Math.acos(this.dotProduct(e,t)/Math.sqrt(this.dotProduct(e,e)*this.dotProduct(t,t)))},t.crossProduct=function(e,t,i){if(!this.spatialRefsAreEqual(e.spatialReference,t.spatialReference,!0))throw new Error("Mismatched spatial references");return i=i||new esri.geometry.Point(0,0),(e.x-i.x)*(t.y-i.y)-(e.y-i.y)*(t.x-i.x)},t.crossProductArray=h,t.dotProduct=function(e,t){if(!this.spatialRefsAreEqual(e.spatialReference,t.spatialReference,!0))throw new Error("Mismatched spatial references");return e.x*t.x+e.y*t.y},t.polygonMidpoint=function(e){if(0==e.length)throw new Error("Expected at least one point in polygonMidPoint.");for(var t=0,i=0,r=0;r<e.length;++r){var n=e[r];t+=n.x,i+=n.y}return t/=e.length,i/=e.length,new esri.geometry.Point(t,i,e[0].spatialReference)}})},"geocortex/essentials/GeoprocessingEndpoint":function(){var r,c=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)});define(["require","exports","./AsyncInitializable","./../geocortex","./ServiceHelper"],function(e,t,i,r,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s,a,o=(s=i.AsyncInitializable,c(l,s),l.prototype._configureObject=function(e){if(void 0===e.id||void 0===e.displayName||void 0===e.connectionString)throw new Error("Incorrect geoprocessing endpoint object returned from initialization");this.id=e.id,this.displayName=e.displayName,this.geoprocessorType=e.geoprocessorType||e.serviceType,this._processConnectionString(e.connectionString),this.properties=r._getProperties(e.properties),this.extensions=r._getExtensions(e.extensions)},l.prototype._processConnectionString=function(e){var t=n.ServiceHelper.extractConnectionStringValue;if(this.geoprocessorType!==a.ARCGIS_GEOPROCESSOR)throw new Error("Unknown geoprocessor type '"+this.geoprocessorType+"'");var i=t(e,"url");i&&0<i.length&&(this.geoprocessorUrl=i)},l);function l(e){var t=s.call(this,e)||this;return t.displayName=null,t.extensions=[],t.id=null,t.properties={},t.geoprocessorType=null,t.geoprocessorUrl=null,t.site=null,t}t.GeoprocessingEndpoint=o,(a=t.GeoprocessingEndpointType||(t.GeoprocessingEndpointType={})).ARCGIS_GEOPROCESSOR="ArcGisGeoprocessor"})},"geocortex/essentials/GeoRssLayerService":function(){var r,a=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)});define(["require","exports","./MapService","./RestHelper","./XmlUtils","./RestHelperHTTPService"],function(e,t,i,r,f,y){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n,s=(n=i.MapService,a(m,n),m.prototype._configureObject=function(e,t){if(void 0===e)throw new Error("Incorrect map service object returned from initialization");m.webMercatorSref=new esri.SpatialReference({wkid:102100}),m.wgs84Sref=new esri.SpatialReference({wkid:4326}),this.feedImageUri=e.feedImageUri,this.updateInterval=e.updateInterval,this.geoRssLayer=new esri.layers.GraphicsLayer({opacity:e.opacity,id:e.id,visible:e.visible}),dojo.connect(this.geoRssLayer,"onError",this,this._layerLoadErrorHandler),e.color&&(this.color=e.color,this._colorSet=!0,3<this.color.length&&(this.color[3]=this.color[3]/255)),n.prototype._configureObject.call(this,e,t),this.attributionDataUrl&&""!==this.attributionDataUrl?(this.geoRssLayer.attributionDataUrl=this.attributionDataUrl,this.geoRssLayer.hasAttributionData=!0):this.hasAttributionData&&(this.geoRssLayer.attributionDataUrl=this.url+"/Attribution",this.geoRssLayer.hasAttributionData=!0)},m.prototype._createServiceLayer=function(){var e=this,t=null;if(this.essentialsMap&&(t=this.essentialsMap.site,this.mapSpatialReference=this.essentialsMap.initialExtent.spatialReference),this.feedImageUri?(this.feedImageUri=r.RestHelper.processClientSideTokens(t,this.feedImageUri),this.pictureSymbol=new esri.symbol.PictureMarkerSymbol(this.feedImageUri,25,25)):this.markerSymbol=new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE,15,new esri.symbol.SimpleLineSymbol,new esri.Color(this.color)),this.feedUrl=this.serviceUrl,this._loadFeed(),this.updateInterval&&!isNaN(this.updateInterval)){this._layerLoadCompleted=!1;var i=setInterval(function(){e._layerLoadCompleted&&e._loadFeed(),e._layerLoadCompleted=!1},1e3*this.updateInterval);dojo.connect(window,"onunload",function(){clearInterval(i)})}this.serviceLayer=this.geoRssLayer},m.prototype._loadFeed=function(){esri.config.defaults.io.proxyUrl&&esri.request({url:this.serviceUrl,content:{},handleAs:"xml",load:dojo.hitch(this,this._handleFeed),error:function(e){e&&e.message&&"string"==typeof e.message&&alert(e.message)}})},m.prototype._handleFeed=function(e){var l=this,c="http://www.georss.org/georss",t=this._getFeedRoot(e);if(t){var u=t.nodeName,p=f.getAttribute(t,"xml:base"),h=[],i=null;if("feed"===u?i=f.getNodes("feed","entry",e):"rdf"===u?i=f.getNodes("rdf","item",e):"rss"===u&&(i=f.getNodes("channel","item",e)),i){var d=this.pictureSymbol||this.markerSymbol;i.forEach(dojo.hitch(this,function(e,t,i){var r,n,s,a=null;if(f.getAllNodes(e).forEach(dojo.hitch(l,function(e,t,i){e.nodeName&&("title"===e.nodeName&&(r=e.firstChild.nodeValue),"feed"===u?"summary"===e.nodeName&&(s=e.firstChild.nodeValue):"description"===e.nodeName&&(s=e.firstChild.nodeValue),"link"===e.nodeName&&(n="feed"===u?(p||"")+f.getAttribute(e,"href"):(p||"")+e.firstChild.nodeValue),("georss:where"===e.nodeName||"where"===e.nodeName&&e.namespaceURI===c)&&(a=l._getGMLGRSSPoint(e)),("georss:point"===e.nodeName||"point"===e.nodeName&&e.namespaceURI===c)&&(a=l._getSimpleGRSSPoint(e)),("geo:lat"===e.nodeName||"lat"===e.nodeName&&"http://www.w3.org/2003/01/geo/wgs84_pos#"===e.namespaceURI)&&(a=l._getW3CGRSSPoint(e)))})),a){var o={title:r,content:s,link:n};h.push(new esri.Graphic(a,d,o,null))}})),this.mapSpatialReference&&this._projectShapes(h,this.mapSpatialReference)}}},m.prototype._projectShapes=function(i,e){var r=this;if(i&&e){for(var t=!1,n=m.webMercatorSref.wkid,s=m.wgs84Sref.wkid,a=0,o=i;a<o.length;a++){var l=o[a],c=null;l.geometry&&l.geometry.spatialReference.wkid!==e.wkid&&(e.wkid===n&&l.geometry.spatialReference.wkid===s?c=esri.geometry.geographicToWebMercator(l.geometry):e.wkid===s&&l.geometry.spatialReference.wkid===n?c=esri.geometry.webMercatorToGeographic(l.geometry):(c=esri.geometry.geographicToWebMercator(l.geometry),t=!0),l.geometry=c)}if(t){var u=[],p=this.geometryServiceUrl||this._getDefaultGeometryServiceUrl(),h=this.geometryServiceUrl?null:this._getDefaultGeometryServiceToken();null!==h&&(p=y.RestHelperHTTPService.appendTokenToUrl(p,h)),this.geometryService=new esri.tasks.GeometryService(p),dojo.forEach(i,function(e){u.push(e.geometry)});var d=new esri.tasks.ProjectParameters;return d.geometries=u,d.outSR=e,void this.geometryService.project(d,dojo.hitch(this,function(e){for(var t=0;t<e.length;t++)i[t].geometry=e[t];r._publishLayer(i)}),this._projectionError)}}this._publishLayer(i)},m.prototype._publishLayer=function(e){var t=this;if(this.geoRssLayer){this.geoRssLayer.clear(),dojo.forEach(e,dojo.hitch(this,function(e){t.geoRssLayer.add(e)})),this.geoRssLayer.redraw();var i={esriLayer:this.geoRssLayer};dojo.publish("geoRssLayerLoaded",[i]),this._layerLoadCompleted=!0}},m.prototype._projectionError=function(e){},m.prototype._getSimpleGRSSPoint=function(e){var t=e.firstChild.nodeValue.split(" ");return new esri.geometry.Point(parseFloat(t[1]),parseFloat(t[0]),m.wgs84Sref)},m.prototype._getGMLGRSSPoint=function(e){var t=this._getNonTextNodeChild(e),i=this._getNonTextNodeChild(t).firstChild.nodeValue.split(" ");return new esri.geometry.Point(parseFloat(i[1]),parseFloat(i[0]),m.wgs84Sref)},m.prototype._getNonTextNodeChild=function(e){for(var t=e.childNodes,i=0;i<t.length;i++)if(3!==t[i].nodeType)return t[i]},m.prototype._getW3CGRSSPoint=function(e){if(!e.nextSibling)return null;var t=e.nextSibling;"#text"===e.nextSibling.nodeName&&(t=e.nextSibling.nextSibling);var i=e.firstChild.nodeValue,r=t.firstChild.nodeValue;return new esri.geometry.Point(parseFloat(r),parseFloat(i),m.wgs84Sref)},m.prototype._getFeedRoot=function(e){if(!e)throw new Error("The GeoRSS service at "+this.feedUrl+" returned an invalid response.");for(var t=e.childNodes,i=0;i<t.length;i++)if(t[i]&&"xml"!==t[i].nodeName.substring(0,3))return t[i];return null},m.webMercatorSref=null,m.wgs84Sref=null,m);function m(e){var t=n.call(this,e)||this;return t._colorSet=!1,t._layerLoadCompleted=null,t.color=null,t.feedUrl=null,t.feedImageUri=null,t.updateInterval=null,t.pictureSymbol=null,t.markerSymbol=null,t.geoRssLayer=null,t.mapSpatialReference=null,t.geometryService=null,t}t.GeoRssLayerService=s})},"geocortex/essentials/KmlService":function(){var r,a=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)});define(["require","exports","./MapService"],function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r,n=(r=i.MapService,a(s,r),s.prototype._configureObject=function(e,t){if(void 0===e)throw new Error("Incorrect map service object returned from initialization");this.updateInterval=e.updateInterval,r.prototype._configureObject.call(this,e,t)},s.prototype._createServiceLayer=function(){var t=this;this.essentialsMap&&(this.essentialsMap.site,this.mapSpatialReference=this.essentialsMap.initialExtent.spatialReference);var e={id:this.id,outSR:this.mapSpatialReference};this.serviceLayer=new esri.layers.KMLLayer(this.serviceUrl,e),this._initiallyVisible?this.serviceLayer.show():this.serviceLayer.hide(),this.serviceLayer._options=e,this.attributionDataUrl&&""!==this.attributionDataUrl?(this.serviceLayer.attributionDataUrl=this.attributionDataUrl,this.serviceLayer.hasAttributionData=!0):this.hasAttributionData&&(this.serviceLayer.attributionDataUrl=this.url+"/Attribution",this.serviceLayer.hasAttributionData=!0);var i=this.serviceLayer.on("load",function(e){i.remove(),t.serviceLayer.setOpacity(t.configuredOpacity),t._initializeKmlLayers()});this.serviceLayer.on("error",function(e){return t._layerLoadErrorHandler(e)}),this.serviceLayer.setOpacity(this.configuredOpacity),this.updateInterval&&!isNaN(this.updateInterval)&&this.serviceLayer.setRefreshInterval(this.updateInterval)},s.prototype._updateStartHandler=function(){this._initializeKmlLayers()},s.prototype._initializeKmlLayers=function(){for(var e=this.serviceLayer.getLayers(),t=0;t<e.length;t++)if(e[t]instanceof esri.layers.FeatureLayer){var i=e[t];i.layerId=+this.id,i.name=this.displayName,i.displayField="name",e[t].spatialReference=this.mapSpatialReference}},s);function s(){var e=null!==r&&r.apply(this,arguments)||this;return e.updateInterval=null,e.serviceLayer=null,e.mapSpatialReference=null,e}t.KmlService=n})},"geocortex/essentials/Layer":function(){var __extends=this&&this.__extends||(Jk=function(e,t){return(Jk=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}Jk(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}),Jk;define(["require","exports","./AsyncInitializable","./LayerChart","./DataLink","./Field","./FeatureHyperlink","./LayerHyperlink","./Report","./LayerStyle","./LayerQuery","./LayerType","./RefreshVisibility","./LayerThemeSetting","./TimeInfo","./../geocortex","./RestHelperHTTPService","./MapServiceConstants","./utilities/SiteResourceIdComparer","./RestHelper","geocortex/framework/utils/utils"],function(require,exports,AsyncInitializable_1,LayerChart_1,DataLink_1,Field_1,FeatureHyperlink_1,LayerHyperlink_1,Report_1,LayerStyle_1,LayerQuery_1,LayerType_1,RefreshVisibility_1,LayerThemeSetting_1,TimeInfo_1,geocortex_1,RestHelperHTTPService_1,MapServiceConstants_1,SiteResourceIdComparer_1,RestHelper_1,utils_1){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Layer=function(_super){function Layer(e){var t=_super.call(this,e)||this;return t.allowSymbolization=!1,t.canToggleLabels=!1,t.charts=[],t.configuredVisible=!1,t.dataLinks=[],t.dataProvider=null,t.defaultVisibility=!1,t.displayField=null,t.displayName=null,t.defaultDateFormat=null,t.defaultNumberFormat=null,t.description=null,t.drawIndex=null,t.dynamicDefinition=null,t.extensions=[],t.featureBorderColor=null,t.featureBorderWidth=null,t.featureDescription=null,t.featureFillColor=null,t.featureHyperlinks=[],t.featureLabel=null,t.featureLongDescription=null,t.featureType="None",t.featureZoomFactor=null,t.featureZoomScale=null,t.fields=[],t.fullExtent=null,t.hasAttachments=!1,t.hasDataLinks=!1,t.hasReports=!1,t.iconUri=null,t.id=null,t.identifiable=!1,t.identifiableAtAllScales=!1,t.includeInLayerList=!0,t.includeInLegend=!0,t.isDynamic=!1,t.isExpanded=!1,t.isUserCreated=!1,t.userLayerType=null,t.catalogId=null,t.layerHyperlinks=[],t.arcadeExpressions=[],t.legendUrl=null,t.mapService=null,t.maxScale=0,t.minScale=0,t.name=null,t.parentLayerId=null,t.primaryKeyField=null,t.properties={},t.queryable=!1,t.queries=[],t.relationships=[],t.reports=[],t.searchable=!1,t.showFeatureHyperlinks="ShowAll",t.showLabels=!0,t.showMapTips=!1,t.snappable=!1,t.snappingEnabled=!1,t.supportsIdentify=!1,t.supportsQuery=!1,t.styleName=null,t.styles=[],t.subLayerIds=[],t.timeZoneId=null,t.type=LayerType_1.LayerType.UNKNOWN,t.visibleStateForRefresh=RefreshVisibility_1.RefreshVisibility.DEFAULT,t.wmsLayerName=null,t.wfsLayerName=null,t.inActiveTheme=!0,t.layerThemeSettings=[],t._visible=!1,t._featureLayerPromise=null,t._timeInfo=null,t._gcxTimeInfo=null,t.setInActiveTheme(!0),t}return __extends(Layer,_super),Layer.prototype.getFeatureLayer=function(){var u=this;if(!this._featureLayerPromise)if(this.mapService.serviceUrl&&this.mapService.serviceUrl.endsWith("/MapServer"))this._featureLayerPromise=new Promise(function(l,c){u.mapService._getLayersInfo(u.id).then(function(e){var t=null;if(e){if(e.layers&&e.layers.forEach(function(e){if(u.id!==e.id.toString());else try{t=new esri.layers.FeatureLayer({layerDefinition:e})}catch(e){l(null)}}),!t&&e.tables&&e.tables.forEach(function(e){if(u.id!==e.id.toString());else try{t=new esri.layers.FeatureLayer({layerDefinition:e})}catch(e){l(null)}}),t)return void l(t);if(u.isDynamic)if(u.mapService&&u.mapService.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer){var i=u.mapService.serviceLayer;if(i.dynamicLayerInfos){var r=null;for(var n in i.dynamicLayerInfos)if(i.dynamicLayerInfos.hasOwnProperty(n)&&i.dynamicLayerInfos[n].id==parseInt(u.id,10)){r=i.dynamicLayerInfos[n].source;break}if(r){var s=u.mapService.serviceUrl+"/dynamicLayer";u.mapService.serviceToken&&(s=RestHelperHTTPService_1.RestHelperHTTPService.appendTokenToUrl(s,u.mapService.serviceToken));var a=(t=new esri.layers.FeatureLayer(s,{source:r})).on("load",function(e){a.remove(),o.remove(),l(t)}),o=t.on("error",function(e){a.remove(),o.remove();var t=e.error&&e.error.message?e.error.message:"Could not determine underlying error.";c(new Error("Could not create a Feature Layer from the given dynamic layer source. Reason: {0}".format(t)))})}else c(new Error("Could not find LayerSource for the given dynamic layer."))}else c(new Error("No dynamicLayerInfos on the service layer."))}else c(new Error("The service layer is not an instance of esri.layers.ArcGISDynamicMapServiceLayer."));else c(new Error("The Essentials layer is not a dynamic layer."))}else c(new Error("The Essentials map service did not return information related to the service's layers."))}).catch(function(e){return c(e)})});else{var a;if(this.mapService.serviceLayer instanceof esri.layers.FeatureLayer)a=this.mapService.serviceLayer;else{var e=this.getLayerUrl();if(!e)return this._featureLayerPromise=Promise.reject(new Error("Cound not get layerUrl for creating feature layer")),this._featureLayerPromise;a=new esri.layers.FeatureLayer(e)}a.loaded?this._featureLayerPromise=Promise.resolve(a):this._featureLayerPromise=new Promise(function(r,t){var n=a.on("load",function(){if(n.remove(),s.remove(),u.wmsLayerName||u.wfsLayerName)for(var e=u.fields,t=a.fields.length-1;0<=t;t--){var i=a.fields[t];"gml:id"===i.name&&a.fields.splice(t,1),i.type=Field_1.Field.convertToEsriFieldType(e[t].dataType)}r(a)}),s=a.on("error",function(e){n.remove(),s.remove(),t(e)})})}return this._featureLayerPromise},Layer.prototype.getRelatedFeatureLayer=function(e,t,i){function r(e){geocortex_1.deferredResolve(n,e),"function"==typeof t&&t(e)}var n=new dojo.Deferred,s=this._getRelation(e),a=this.getLayerUrl();if(!s||!a){var o=new Error("getRelatedFeatureLayer - Relation not found for: "+e+" or layerUrl is null");return n&&-1===n.fired&&n.resolve(o),"function"==typeof i&&i(o),n}var l=a.substring(0,a.lastIndexOf("/")+1)+s.relatedTableId;this.mapService&&this.mapService.serviceToken&&(l=RestHelperHTTPService_1.RestHelperHTTPService.appendTokenToUrl(l,this.mapService.serviceToken)),void 0===esri.getProxyRule(l)&&null!==this.mapService.proxyUrl&&esri.addProxyRule({urlPrefix:l,proxyUrl:this.mapService.proxyUrl});var c=new esri.layers.FeatureLayer(l,{mode:esri.layers.FeatureLayer.MODE_SELECTION,outFields:["*"]});return c.loaded?r(c):dojo.connect(c,"onLoad",dojo.hitch(this,r)),dojo.connect(c,"onError",dojo.hitch(this,function(e){n&&-1===n.fired&&n.resolve(e),"function"==typeof i&&i(e)})),n},Layer.prototype.areAllAncestorsVisible=function(){for(var e=this.mapService.findLayerById(this.parentLayerId);null!=e;){if(!e.isVisible())return!1;e=this.mapService.findLayerById(e.parentLayerId)}return!0},Layer.prototype.getLayerUrl=function(){if(this.mapService&&this.mapService.serviceUrl){if("FeatureLayer"===this.mapService.drawingBehavior)return this.mapService.serviceUrl;if(this.mapService.mapServiceType!==MapServiceConstants_1.MapServiceType.WMS&&this.mapService.mapServiceType!==MapServiceConstants_1.MapServiceType.WFS)return this.mapService.serviceUrl+"/"+this.id;if(this.mapService.userLayerType===MapServiceConstants_1.UserLayerType.LAYER_ADDITION)return null;var e=this.mapService.url+"/layers/"+this.id,t=RestHelperHTTPService_1.RestHelperHTTPService.getTokenForScope(this.mapService.url);return t&&(e=RestHelperHTTPService_1.RestHelperHTTPService.appendTokenToUrl(e,t)),e}return null},Layer.prototype.getFieldByName=function(e){if(this.fields&&0<this.fields.length){if(!this._fieldLookup){this._fieldLookup={};for(var t=0,i=this.fields;t<i.length;t++){var r=i[t];this._fieldLookup[r.name]=r}}return this._fieldLookup[e]}return null},Layer.prototype.isVisible=function(){return this._visible},Layer.prototype.setVisibility=function(e,t){if(this.mapService){switch(this.mapService.mapServiceType){case MapServiceConstants_1.MapServiceType.DYNAMIC:case MapServiceConstants_1.MapServiceType.FEATURE:case MapServiceConstants_1.MapServiceType.WMS:case MapServiceConstants_1.MapServiceType.WFS:case MapServiceConstants_1.MapServiceType.WMTS:case MapServiceConstants_1.MapServiceType.GEORSS:case MapServiceConstants_1.MapServiceType.KML:case MapServiceConstants_1.MapServiceType.TILED:case MapServiceConstants_1.MapServiceType.STREAM:this._visible=e;break;default:this._visible=!0}this.mapService._setVisibility(this.id,this._visible,t)}},Layer.prototype.setInActiveTheme=function(e){this.inActiveTheme=e,dojo.publish("LayerInActiveThemeChangedEvent",this)},Layer.prototype.findReportById=function(e){return SiteResourceIdComparer_1.SiteResourceIdComparer.lookUp(this.reports,e)},Layer.prototype.withinScaleRange=function(e){return!!(0===this.maxScale&&this.minScale===1/0||isNaN(this.maxScale)&&isNaN(this.minScale))||(null==e&&(e=this.mapService.essentialsMap.calculateScale()),this.maxScale<e&&e<this.minScale)},Layer.prototype._configureDataLinks=function(e,t,i){for(var r=0;e&&r<e.length;r++){var n=this.dataLinks[r]=new DataLink_1.DataLink(this.url+"/datalinks/"+e[r].id);n.layer=this,n._configureObject(e[r],t)}},Layer.prototype._getUniqueId=function(){if(this.mapService){var t=[];if(dojo.forEach(this.mapService.layers,function(e){t.push(e.id)}),0<t.length){var e=Math.max.apply(null,t);return(++e).toString()}}return"0"},Layer.prototype.createFromDefinition=function(e){this._createFrom(e)},Layer.prototype._createFrom=function(e){if(this.defaultVisibility=e.defaultVisibility,this.configuredVisible=e.visible,this.displayName=e.displayName||e.name,this.description=e.description,this.featureDescription=e.featureDescription,e.hasOwnProperty("featureLongDescription")?this.featureLongDescription=e.featureLongDescription:this.featureLongDescription=e.featureDescription,this.featureLabel=e.featureLabel,this.featureType=e.featureType,this.featureZoomScale=e.featureZoomScale,this.featureZoomFactor=e.featureZoomFactor,this.hasDataLinks=e.hasDataLinks,this.hasReports=e.hasReports,this.hasAttachments=e.hasAttachments,e.hasOwnProperty("id")?this.id=e.id:this.id=this._getUniqueId(),this.name=e.name,this._populateOgcID(e.nativeID),this.parentLayerId=e.parentLayerId,this.subLayerIds=e.subLayerIds,this._visible=e.visible,this.styleName=e.styleName,this.legendUrl=e.legendUrl,this.isUserCreated=utils_1.isNullOrUndefined(e.isUserCreated)?this.isUserCreated:e.isUserCreated,this.userLayerType=utils_1.isNullOrUndefined(e.userLayerType)?this.userLayerType:e.userLayerType,this.isDynamic=e.isDynamic,this.dynamicDefinition=e.dynamicDefinition,this.dataProvider=e.dataProvider,this.defaultDateFormat=e.defaultDateFormat,this.defaultNumberFormat=e.defaultNumberFormat,this.timeZoneId=e.timeZoneId,e.fullExtent&&(this.fullExtent=new esri.geometry.Extent(e.fullExtent)),e.hasOwnProperty("drawIndex")&&(this.drawIndex=e.drawIndex),e.hasOwnProperty("identifiable")&&(this.identifiable=e.identifiable),e.hasOwnProperty("includeInLayerList")&&(this.includeInLayerList=e.includeInLayerList),e.hasOwnProperty("includeInLegend")&&(this.includeInLegend=e.includeInLegend),e.hasOwnProperty("featureBorderColor")&&(this.featureBorderColor=e.featureBorderColor,this.featureBorderColor&&4<=this.featureBorderColor.length&&1<=this.featureBorderColor[3]&&(this.featureBorderColor[3]/=255)),e.hasOwnProperty("featureBorderWidth")&&(this.featureBorderWidth=e.featureBorderWidth),e.hasOwnProperty("featureFillColor")&&(this.featureFillColor=e.featureFillColor,this.featureFillColor&&4<=this.featureFillColor.length&&1<=this.featureFillColor[3]&&(this.featureFillColor[3]/=255)),e.hasOwnProperty("minScale")&&!isNaN(e.minScale)&&0!==e.minScale?this.minScale=e.minScale:this.minScale=1/0,e.hasOwnProperty("maxScale")&&!isNaN(e.maxScale)?this.maxScale=e.maxScale:this.maxScale=0,this.mapService&&null!=this.mapService.minScale&&!isNaN(this.mapService.minScale)&&(this.minScale=Math.min(this.minScale,this.mapService.minScale)),this.mapService&&null!=this.mapService.maxScale&&!isNaN(this.mapService.maxScale)&&(this.maxScale=Math.max(this.maxScale,this.mapService.maxScale)),e.hasOwnProperty("queryable")&&(this.queryable=e.queryable),e.hasOwnProperty("searchable")&&(this.searchable=e.searchable),e.hasOwnProperty("snappable")&&(this.snappable=e.snappable),e.hasOwnProperty("snappingEnabled")&&(this.snappingEnabled=e.snappingEnabled),e.hasOwnProperty("showFeatureHyperlinks")&&(this.showFeatureHyperlinks=e.showFeatureHyperlinks),e.hasOwnProperty("canToggleLabels")&&(this.canToggleLabels=e.canToggleLabels),e.hasOwnProperty("showLabels")&&(this.showLabels=e.showLabels),e.hasOwnProperty("showMapTips")&&(this.showMapTips=e.showMapTips),e.hasOwnProperty("supportsIdentify")&&(this.supportsIdentify=e.supportsIdentify),e.hasOwnProperty("supportsQuery")&&(this.supportsQuery=e.supportsQuery),e.hasOwnProperty("layerHyperlinks"))for(var t=0;t<e.layerHyperlinks.length;t++)this.layerHyperlinks[t]=new LayerHyperlink_1.LayerHyperlink(e.layerHyperlinks[t],this);if(e.hasOwnProperty("arcadeExpressions"))for(t=0;t<e.arcadeExpressions.length;t++)this.arcadeExpressions[t]={token:e.arcadeExpressions[t].token,expression:e.arcadeExpressions[t].expression};if(void 0!==e.type&&(this.type=this._layerTypeStringToEssentialsLayerType(e.type)),e.fields)for(t=0;t<e.fields.length;t++){var i=e.fields[t],r={layer:this,dataType:Field_1.Field.convertFromEsriType(i.type||i.dataType),alias:i.alias,displayName:i.displayName||i.alias||i.name,name:i.name,searchable:!0,visible:!0,focusField:!1,hyperlinkLabel:null,format:i.format};i.hasOwnProperty("searchable")&&(r.searchable=i.searchable),i.hasOwnProperty("visible")&&(r.visible=i.visible),this.fields[t]=new Field_1.Field(r)}this.primaryKeyField=this.getFieldByName(e.primaryKeyField),this.displayField=this.getFieldByName(e.displayField),e.properties&&(this.properties=geocortex_1._getProperties(e.properties),this.catalogId=this.properties.layerCatalogLookupId),e.extensions&&(this.extensions=geocortex_1._getExtensions(e.extensions)),this.isInitialized=!0},Layer.prototype._configureObject=function(results,deepInitialize){if(void 0===results||void 0===results.name||void 0===results.id)throw new Error("Incorrect layer object returned from initialization");this.allowSymbolization=results.allowSymbolization,this.defaultVisibility=results.defaultVisibility,this.configuredVisible=results.visible,this.displayName=results.displayName,this.description=results.description,this.featureDescription=results.featureDescription,results.hasOwnProperty("featureLongDescription")?this.featureLongDescription=results.featureLongDescription:this.featureLongDescription=results.featureDescription,this.featureLabel=results.featureLabel,this.featureType=void 0===results.featureType?this.featureType:results.featureType,this.featureZoomScale=void 0===results.featureZoomScale?this.featureZoomScale:results.featureZoomScale,this.featureZoomFactor=void 0===results.featureZoomFactor?this.featureZoomFactor:results.featureZoomFactor,this.hasDataLinks=utils_1.isNullOrUndefined(results.hasDataLinks)?this.hasDataLinks:results.hasDataLinks,this.hasReports=utils_1.isNullOrUndefined(results.hasReports)?this.hasReports:results.hasReports,this.hasAttachments=results.hasAttachments,this.id=results.id,this.name=results.name,this._populateOgcID(results.nativeID),this.parentLayerId=results.parentLayerId,this.subLayerIds=results.subLayerIds,this.styleName=results.styleName,this.legendUrl=results.legendUrl,this.catalogId=utils_1.isNullOrUndefined(results.catalogId)?this.catalogId:results.catalogId,this.isUserCreated=utils_1.isNullOrUndefined(results.isUserCreated)?this.isUserCreated:results.isUserCreated,this.userLayerType=utils_1.isNullOrUndefined(results.userLayerType)?this.userLayerType:results.userLayerType,this.isDynamic=void 0===results.isDynamic?this.isDynamic:results.isDynamic,this.dynamicDefinition=results.dynamicDefinition,this.dataProvider=results.dataProvider,this.defaultDateFormat=results.defaultDateFormat,this.defaultNumberFormat=results.defaultNumberFormat,this.timeZoneId=results.timeZoneId,this._timeInfo=results.timeInfo?results.timeInfo:null,this.queries=[],results.fullExtent&&(this.fullExtent=new esri.geometry.Extent(results.fullExtent));var site=null,i;if(this.mapService&&this.mapService.essentialsMap&&(site=this.mapService.essentialsMap.site),this.iconUri=RestHelper_1.RestHelper.processClientSideTokens(site,results.iconUri),results.hasOwnProperty("includeInLayerList")&&(this.includeInLayerList=results.includeInLayerList),this.isUserCreated)this._visible=void 0===results.initiallyVisible?!!results.visible:!!results.initiallyVisible;else if(null!=this.mapService.essentialsMap.layerThemesInfo.startupThemeId&&this.includeInLayerList?this._visible=!1:this._visible=void 0===results.initiallyVisible?!!results.visible:!!results.initiallyVisible,results.themeSettings&&results.themeSettings.length)for(var _i=0,_a=results.themeSettings;_i<_a.length;_i++){var themeSetting=_a[_i],layerTheme=this.mapService.essentialsMap.layerThemesInfo.getTheme(themeSetting.themeID);if(layerTheme){var isVisible=utils_1.isNullOrUndefined(themeSetting.visible)?this.configuredVisible:themeSetting.visible;this.layerThemeSettings.push(new LayerThemeSetting_1.LayerThemeSetting(layerTheme,isVisible)),layerTheme.id===this.mapService.essentialsMap.layerThemesInfo.startupThemeId&&this.includeInLayerList&&(this._visible=void 0===themeSetting.initiallyVisible?isVisible:themeSetting.initiallyVisible)}}if(results.hasOwnProperty("drawIndex")&&(this.drawIndex=results.drawIndex),results.hasOwnProperty("featureBorderColor")&&(this.featureBorderColor=results.featureBorderColor,this.featureBorderColor&&4<=this.featureBorderColor.length&&1<=this.featureBorderColor[3]&&(this.featureBorderColor[3]/=255)),results.hasOwnProperty("featureBorderWidth")&&(this.featureBorderWidth=results.featureBorderWidth),results.hasOwnProperty("featureFillColor")&&(this.featureFillColor=results.featureFillColor,this.featureFillColor&&4<=this.featureFillColor.length&&1<=this.featureFillColor[3]&&(this.featureFillColor[3]/=255)),results.hasOwnProperty("identifiable")&&(this.identifiable=results.identifiable),results.hasOwnProperty("includeInLegend")&&(this.includeInLegend=results.includeInLegend),results.hasOwnProperty("minScale")&&!isNaN(results.minScale)&&0!==results.minScale?this.minScale=results.minScale:this.minScale=1/0,results.hasOwnProperty("maxScale")&&!isNaN(results.maxScale)?this.maxScale=results.maxScale:this.maxScale=0,this.mapService&&null!=this.mapService.minScale&&!isNaN(this.mapService.minScale)&&(this.minScale=Math.min(this.minScale,this.mapService.minScale)),this.mapService&&null!=this.mapService.maxScale&&!isNaN(this.mapService.maxScale)&&(this.maxScale=Math.max(this.maxScale,this.mapService.maxScale)),results.hasOwnProperty("queryable")&&(this.queryable=results.queryable),results.hasOwnProperty("searchable")&&(this.searchable=results.searchable),results.hasOwnProperty("showFeatureHyperlinks")&&(this.showFeatureHyperlinks=results.showFeatureHyperlinks),results.hasOwnProperty("canToggleLabels")&&(this.canToggleLabels=results.canToggleLabels),results.hasOwnProperty("showLabels")&&(this.showLabels=results.showLabels),results.hasOwnProperty("showMapTips")&&(this.showMapTips=results.showMapTips),results.hasOwnProperty("snappable")&&(this.snappable=results.snappable),results.hasOwnProperty("snappingEnabled")&&(this.snappingEnabled=results.snappingEnabled),results.hasOwnProperty("supportsIdentify")&&(this.supportsIdentify=results.supportsIdentify),results.hasOwnProperty("supportsQuery")&&(this.supportsQuery=results.supportsQuery),void 0!==results.type&&(this.type=this._layerTypeStringToEssentialsLayerType(results.type)),this.type===LayerType_1.LayerType.GROUP_LAYER&&results.hasOwnProperty("isExpanded")&&(this.isExpanded=results.isExpanded),results.featureHyperlinks)for(i=0;i<results.featureHyperlinks.length;i++)this.featureHyperlinks[i]=new FeatureHyperlink_1.FeatureHyperlink(results.featureHyperlinks[i],this);if(results.fields)for(i=0;i<results.fields.length;i++)results.fields[i].layer=this,this.fields[i]=new Field_1.Field(results.fields[i]);if(results.relationships)for(i=0;i<results.relationships.length;i++)results.relationships[i].displayName&&(results.relationships[i].name=results.relationships[i].displayName),results.relationships[i].id=parseInt(results.relationships[i].id,10),results.relationships[i].relatedTableId=parseInt(results.relationships[i].relatedTableId,10),this.relationships.push(results.relationships[i]);if(results.hasOwnProperty("layerHyperlinks"))for(i=0;i<results.layerHyperlinks.length;i++)this.layerHyperlinks[i]=new LayerHyperlink_1.LayerHyperlink(results.layerHyperlinks[i],this);if(results.hasOwnProperty("arcadeExpressions"))for(i=0;i<results.arcadeExpressions.length;i++)this.arcadeExpressions[i]={token:results.arcadeExpressions[i].token,expression:results.arcadeExpressions[i].expression};if(results.hasOwnProperty("charts")&&dojo.isObject(eval("geocortex.charting.configuration.ChartDefinition")))for(i=0;i<results.charts.length;i++)this.charts.push(new LayerChart_1.LayerChart(results.charts[i],this));if(results.styles&&results.styles.length)for(i=0;i<results.styles.length;i++){var style=results.styles[i],rendererJson=style.definition;if(rendererJson)if(style.isDefault)try{this.defaultRenderer=style.definition,this.styles.push(new LayerStyle_1.LayerStyle(rendererJson,style.displayName,LayerStyle_1.CUSTOM_STYLE_ID))}catch(e){return}else this.styles.push(new LayerStyle_1.LayerStyle(rendererJson,style.displayName,style.id))}if(results.queries&&results.queries.length)for(i=0;i<results.queries.length;i++)this.queries.push(new LayerQuery_1.LayerQuery(results.queries[i]));this.primaryKeyField=this.getFieldByName(results.primaryKeyField),this.displayField=this.getFieldByName(results.displayField),this._configureDataLinks(results.dataLinks,deepInitialize,site),this._configureReports(results.reports,deepInitialize),deepInitialize&&(this.isInitialized=!0),this.properties=geocortex_1._getProperties(results.properties),this.extensions=geocortex_1._getExtensions(results.extensions)},Layer.prototype.toJson=function(){return{id:this.id,name:this.name,url:this.url,defaultVisibility:this.defaultVisibility,visible:this.configuredVisible,displayName:this.displayName,description:this.description,featureDescription:this.featureDescription,featureLongDescription:this.featureLongDescription,featureLabel:this.featureLabel,featureType:this.featureType,featureZoomScale:this.featureZoomScale,featureZoomFactor:this.featureZoomFactor,hasDataLinks:this.hasDataLinks,hasReports:this.hasReports,hasAttachments:this.hasAttachments,nativeID:this.wmsLayerName||this.wfsLayerName,parentLayerId:this.parentLayerId,subLayerIds:(this.subLayerIds||[]).slice(),styleName:this.styleName,legendUrl:this.legendUrl,isDynamic:this.isDynamic,dynamicDefinition:this.dynamicDefinition,dataProvider:this.dataProvider,defaultDateFormat:this.defaultDateFormat,defaultNumberFormat:this.defaultNumberFormat,timeZoneId:this.timeZoneId,fullExtent:this.fullExtent?this.fullExtent.toJson():void 0,drawIndex:this.drawIndex,identifiable:this.identifiable,isExpanded:this.isExpanded,includeInLayerList:this.includeInLayerList,includeInLegend:this.includeInLegend,featureBorderColor:this.featureBorderColor,featureBorderWidth:this.featureBorderWidth,featureFillColor:this.featureFillColor,minScale:this.minScale===1/0?0:this.minScale,maxScale:this.maxScale,queryable:this.queryable,searchable:this.searchable,snappable:this.snappable,snappingEnabled:this.snappingEnabled,showFeatureHyperlinks:this.showFeatureHyperlinks,canToggleLabels:this.canToggleLabels,showLabels:this.showLabels,showMapTips:this.showMapTips,supportsIdentify:this.supportsIdentify,supportsQuery:this.supportsQuery,layerHyperlinks:this.layerHyperlinks.map(function(e){return e.toJson()}),type:this._essentialsLayerTypeToLayerTypeString(this.type),fields:this.fields.map(function(e){return e.toJson()}),primaryKeyField:this.primaryKeyField?this.primaryKeyField.name:void 0,displayField:this.displayField?this.displayField.name:void 0,catalogId:this.catalogId?this.catalogId:void 0,isUserCreated:this.isUserCreated,userLayerType:this.userLayerType,properties:geocortex_1._propertiesToJson(this.properties),extensions:geocortex_1._extensionsToJson(this.extensions)}},Layer.prototype._configureReports=function(e,t){for(var i=0;e&&i<e.length;i++)this.reports[i]=new Report_1.Report(this.url+"/reports/"+e[i].id),(this.reports[i].layer=this).mapService&&this.mapService.essentialsMap&&this.mapService.essentialsMap.site&&(this.reports[i].site=this.mapService.essentialsMap.site),this.reports[i]._configureObject(e[i],t)},Layer.prototype.getLayerTimeInfo=function(){var t=this;if(!this.mapService||!this.mapService.isTimeAware)return null;if(this._gcxTimeInfo)return this._gcxTimeInfo;function i(e){if(e)return t._timeInfo=e,t._gcxTimeInfo=TimeInfo_1.getGcxTimeInfo(t._timeInfo),t._gcxTimeInfo}this._timeInfo?i(this._timeInfo):function(){if(t.mapService.serviceLayer&&t.mapService.serviceLayer.url){var e=t.mapService.serviceLayer.url+"/"+t.id;geocortex_1.request({url:e,content:{f:"json"},load:function(e){return i(e.timeInfo)},error:function(e){console.log((e.message,e.message))},callbackParamName:"CallBack"})}}()},Layer.prototype.getObjectIdFieldName=function(){var e=null;return this.primaryKeyField&&(e=this.primaryKeyField.name),e},Layer.prototype._layerTypeStringToEssentialsLayerType=function(e){return"FeatureLayer"===e||"DynamicFeatureLayer"===e?LayerType_1.LayerType.FEATURE_LAYER:"GroupLayer"===e||"AnnotationLayer"===e?LayerType_1.LayerType.GROUP_LAYER:"RasterLayer"===e?LayerType_1.LayerType.RASTER_LAYER:"GeoRssLayer"===e?LayerType_1.LayerType.GEO_RSS_LAYER:"TableLayer"===e?LayerType_1.LayerType.TABLE_LAYER:LayerType_1.LayerType.UNKNOWN},Layer.prototype._essentialsLayerTypeToLayerTypeString=function(e){switch(e){case LayerType_1.LayerType.FEATURE_LAYER:return"FeatureLayer";case LayerType_1.LayerType.GROUP_LAYER:return"GroupLayer";case LayerType_1.LayerType.RASTER_LAYER:return"RasterLayer";case LayerType_1.LayerType.GEO_RSS_LAYER:return"GeoRssLayer";default:return"Unknown"}},Layer.prototype._getRelation=function(e){"string"==typeof e&&(e=parseInt(e,10));for(var t=0,i=this.relationships;t<i.length;t++){var r=i[t];if(r.id==e)return r}return null},Layer.prototype.getDefinitionExpression=function(e){var t=null,i=parseInt(this.id,10);if(e)if(e instanceof esri.layers.ArcGISDynamicMapServiceLayer){var r=e.layerDefinitions;r&&r[i]&&(t=r[i])}else if(e instanceof esri.layers.FeatureLayer){var n=e.getDefinitionExpression();n&&(t=n)}return t||this.dynamicDefinition&&(t=RestHelper_1.RestHelper.getDynamicExpressionFromJson(this.dynamicDefinition)),t},Layer.prototype._createDynamicLayerInfo=function(){var e=null;return this.isDynamic&&(e=RestHelper_1.RestHelper.getDynamicLayerInfoFromJson(this.dynamicDefinition,this.id),this.minScale<1/0&&(e.minScale=this.minScale),0<this.maxScale&&(e.maxScale=this.maxScale)),e},Layer.prototype.getLayerDrawingOptions=function(){var e=null;return this.isDynamic&&(e=RestHelper_1.RestHelper.getLayerDrawingOptionsFromJson(this.dynamicDefinition)),e},Layer.prototype.getLayerThemeSettings=function(e){for(var t=0,i=this.layerThemeSettings;t<i.length;t++){var r=i[t];if(r.theme===e||r.theme.id===e)return r}return null},Layer.prototype._syncProgramaticallyChangedLayerVisibility=function(e){this._visible=e},Layer.prototype._populateOgcID=function(e){if(!utils_1.isNullOrUndefined(e)&&this.mapService)switch(this.mapService.mapServiceType){case MapServiceConstants_1.MapServiceType.WMTS:case MapServiceConstants_1.MapServiceType.WMS:this.wmsLayerName=e;break;case MapServiceConstants_1.MapServiceType.WFS:this.wfsLayerName=e}},Layer}(AsyncInitializable_1.AsyncInitializable);exports.Layer=Layer})},"geocortex/essentials/LayerCatalog":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});function i(e){this.siteId=e}t.LayerCatalog=i})},"geocortex/essentials/LayerChart":function(){define(["require","exports","geocortex/charting/infrastructure/Enums","geocortex/charting/infrastructure/configuration/ChartDefinition"],function(require,exports,Enums_1,ChartDefinition_1){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var LayerChart=function(){function LayerChart(restLayerChart,layer){this.layer=null,dojo.isObject(eval("geocortex.charting.configuration.ChartDefinition"))&&(restLayerChart&&(this.id=restLayerChart.id,this.displayName=restLayerChart.displayName,this.defaultChart=restLayerChart.defaultChart,this.chartFeatureType=restLayerChart.chartFeatureType,this.chartDefinition=new ChartDefinition_1.ChartDefinition(restLayerChart.chartDefinition),this.chartDefinition.id=this.id,this.chartDefinition.displayName=this.displayName),layer&&(this.layer=layer,this._setFieldDisplayNames(this.chartDefinition,layer)))}return LayerChart.prototype._setFieldDisplayNames=function(e,t){if(t&&e){for(var i={},r=0,n=t.fields;r<n.length;r++){var s=n[r];s&&(i[s.name]=s.displayName)}e.category.field.sourceType===Enums_1.ChartFieldSourceType.Field&&(e.category.field.displayName=i[e.category.field.name]||e.category.field.name);for(var a=0,o=e.series;a<o.length;a++){var l=o[a];l&&l.field.sourceType===Enums_1.ChartFieldSourceType.Field&&(l.field.displayName=i[l.field.name]||l.field.name)}}},LayerChart}();exports.LayerChart=LayerChart})},"geocortex/essentials/LayerHyperlink":function(){define(["require","exports","./RestHelper"],function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=(n.prototype.toJson=function(){return{encodeUriReplacementValues:this.encodeUriReplacementValues,iconUri:this.iconUri,target:this.target,text:this.text,toolTip:this.toolTip,uri:this.uri}},n);function n(e,t){this.encodeUriReplacementValues=e.encodeUriReplacementValues,this.target=e.target,this.text=e.text,this.toolTip=e.toolTip;var i=null;null!=t.mapServiceType?this.mapService=t:(this.layer=t,this.layer.mapService&&(this.mapService=this.layer.mapService)),this.mapService&&this.mapService.essentialsMap&&(i=this.mapService.essentialsMap.site),this.uri=r.RestHelper.processClientSideTokens(i,e.uri),this.iconUri=r.RestHelper.processClientSideTokens(i,e.iconUri)}t.LayerHyperlink=i})},"geocortex/essentials/LayerQuery":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});function i(e){e&&(this.id=e.id,this.displayName=e.displayName,this.query=e.query)}t.LayerQuery=i})},"geocortex/essentials/LayerStyle":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CUSTOM_STYLE_ID="__CUSTOM__";var i=(r.prototype.getRenderer=function(){var e=esri.renderer.fromJson(JSON.parse(this.rendererJson));return e instanceof esri.renderer.Renderer||console.error("Layer Style: '{0}'. Could not create a valid renderer from the stored JSON string: '{1}'".format(this.displayName,this.rendererJson)),e},r.prototype.setRenderer=function(e){e instanceof esri.renderer.Renderer?this.rendererJson=JSON.stringify(e.toJson()):esri.renderer.fromJson(JSON.parse(e))instanceof esri.renderer.Renderer?this.rendererJson=e:console.error("Layer Style: '{0}'. Supplied JSON string could not be used to create a valid renderer: '{1}'".format(this.displayName,e))},r.prototype.isSimple=function(){return"simple"===JSON.parse(this.rendererJson).type},r);function r(e,t,i,r){void 0===r&&(r=!1),this.rendererJson=e,this.displayName=t,this.id=i,this.enabled=r}t.LayerStyle=i})},"geocortex/essentials/LayerTheme":function(){define(["require","exports","./../geocortex","./Layer","./LayerType","geocortex/framework/utils/utils"],function(e,t,r,d,f,y){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=(n.prototype._configureLayerTheme=function(e,t,i){this.id=e?e.id:t,this.isDefaultTheme=null===this.id,this.isActive=!1,this.displayName=e?e.displayName:i,this.extensions=r._getExtensions(e?e.extensions:null),this.properties=e?e.properties:null},n.prototype.applyToMap=function(){var n=this;if(y.isNullOrUndefined(this.layerThemesInfo))throw new Error("Could not apply theme '{0}' to the map because the LayerThemesInfo property is not set on this LayerTheme.".format(this.displayName));var e=this.layerThemesInfo,t=e.map;if(y.isNullOrUndefined(t))throw new Error("Failed to apply theme '{0}' to map because the Map property is not set on the LayerThemesInfo object.".format(this.displayName));this.isActive=!0,(e.activeTheme&&e.activeTheme!==this||!e.activeTheme)&&(e.activeTheme&&(e.previousTheme=e.activeTheme,e.previousTheme.isActive=!1),e.activeTheme=this),e.themeChangeInProgress=!0,e.layerThemeChangingEvent({currTheme:e.activeTheme,prevTheme:e.previousTheme});for(var i=function(e,t){void 0===t&&(t=!1),e.setInActiveTheme(!0),s(e,e.configuredVisible,t)},r=function(e,t){void 0===t&&(t=!1);var i=e.getLayerThemeSettings(n.id);e.setInActiveTheme(null!=i);var r=!1;null!=i&&(r=y.isNullOrUndefined(i.visible)?e.configuredVisible:i.visible),s(e,r,t)},s=function(e,t,i){if(void 0===i&&(i=!1),e instanceof d.Layer){var r=e;if(r.mapService.supportsLayerVisibility())4.02<=r.mapService.essentialsMap.site.getEssentialsVersion()&&r.type===f.LayerType.GROUP_LAYER&&(t=!0);else if(1!==r.mapService.layers.length||!r.inActiveTheme||r.mapService.includeInLayerList)return}e.isUserCreated||e.setVisibility(t,i)},a=0,o=t.mapServices;a<o.length;a++){var l=o[a],c=l.supportsLayerVisibility();this.isDefaultTheme?i(l):r(l);for(var u=0,p=l.layers;u<p.length;u++){var h=p[u];this.isDefaultTheme?i(h,c):r(h,c)}c&&l.refresh()}t.refreshFilteredCollections(),e.themeChangeInProgress=!1,e.layerThemeChangedEvent({currTheme:e.activeTheme,prevTheme:e.previousTheme})},n);function n(e,t,i){this.layerThemesInfo=e;var r="object"==typeof t?t:null;this._configureLayerTheme(r,t,i)}t.LayerTheme=i})},"geocortex/essentials/LayerThemeEventArgs":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/LayerThemeSetting":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});function i(e,t){this.theme=e,this.visible=t}t.LayerThemeSetting=i})},"geocortex/essentials/LayerThemesInfo":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=(r.prototype.applyTheme=function(e){if(this.layerThemesConfigured){var t=this.getTheme(e);t?t.applyToMap():console.log("Error: Theme with ID '{0}' could not be found and was not activated.".format(e))}else console.log("Warning: No layer themes have been configured by the essentials administrator.")},r.prototype.getTheme=function(e,t){if(void 0===t&&(t=!1),this.layerThemesConfigured)for(var i=0;i<this.themes.length;i++){if(this.themes[i].id===e)return this.themes[i];if(t&&this.themes[i].displayName.toLowerCase()===e.toLowerCase())return this.themes[i]}return null},r);function r(e){this.layerThemeChangedEvent=function(e){},this.themeChangeInProgress=!1,this.layerThemeChangingEvent=function(e){},this.layerThemesConfigured=!1,this.allowDefault=!1,this.themes=[],this.map=e}t.LayerThemesInfo=i})},"geocortex/essentials/LayerTimeOptions":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/LayerType":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=(r.UNKNOWN=0,r.FEATURE_LAYER=1,r.RASTER_LAYER=2,r.GROUP_LAYER=3,r.GEO_RSS_LAYER=4,r.TABLE_LAYER=5,r);function r(){}t.LayerType=i})},"geocortex/essentials/LayerVisibilityEventManager":function(){define(["require","exports","./MapServiceConstants","./LayerType"],function(e,t,m,v){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=(r.prototype.beforeESRIsetVisibleLayers=function(e,t){var i=[],r=[];if(void 0===t&&(t=!1),e.InternallyChangedLayer){var n=e.InternallyChangedLayer;return null!=n.mapServiceId&&null!=n.layerId&&null!=n.visibility&&i.push(n),o=[e,t,i]}if(this._mapService.mapServiceType==m.MapServiceType.DYNAMIC)r=dojo.clone(e);else if(this._mapService.mapServiceType==m.MapServiceType.WMS)for(var s=0;e&&s<e.length;s++){var a=this._findWmsLayerIdFromName(e[s]);if(!a||null===a){var o=[e,t,i];return console.error("WARNING: LayerVisibilityEventManager could not find layer corresponding to WMS name ["+e[s]+"] Possible Invalid configuration"),o}r.push(a.toString())}if(e&&this._mapService.mapServiceType==m.MapServiceType.DYNAMIC&&1===e.length&&"-1"==e[0]){for(var l=0;l<this._mapService.layers.length;l++){var c=this._mapService.layers[l].id,u=this._mapService.findLayerById(c);u.type!==v.LayerType.GROUP_LAYER&&(i.push({mapServiceId:this._mapService.id,layerId:c.toString(),visibility:!1}),u._syncProgramaticallyChangedLayerVisibility(!1))}return o=[e,t,i]}(e&&0===e.length||this._mapService.mapServiceType==m.MapServiceType.DYNAMIC&&1===e.length&&""===e[0])&&(r=this._mapService.getDefaultVisibleLayers());for(var p=this._getAllCurrentlyVisibleLayers(),h=0;p&&h<p.length;h++)c=p[h],r&&r.indexOf(c.toString())<0&&(y=this._mapService.findLayerById(c))&&y.type!==v.LayerType.GROUP_LAYER&&(i.push({mapServiceId:this._mapService.id,layerId:c.toString(),visibility:!1}),y._syncProgramaticallyChangedLayerVisibility(!1));var d=this._mapService.getVisibleLayers();if(r&&0<r.length)for(var f=0;f<r.length;f++){var y;this._mapService.mapServiceType==m.MapServiceType.DYNAMIC&&isNaN(parseInt(r[f]))&&(r[f]="0"),d&&d.indexOf(r[f].toString())<0&&(y=this._mapService.findLayerById(r[f]))&&(y.subLayerIds&&0<y.subLayerIds.length&&(this._deleteItemWithId(r[f],i),this._recursivelyUpdateSublayerVisibility(y,!0,i)),i.push({mapServiceId:this._mapService.id,layerId:r[f].toString(),visibility:!0}),y._syncProgramaticallyChangedLayerVisibility(!0),y.parentLayerId&&null!==y.parentLayerId&&void 0!==y.parentLayerId&&this._recursivelyUpdateAncestorVisibility(y,r,i))}return o=[e,t,i]},r.prototype.afterESRIsetVisibleLayers=function(e,t,i){i&&0<i.length&&dojo.publish("LayerVisibilityChange",new Array(i))},r.prototype._recursivelyUpdateAncestorVisibility=function(e,t,i){if(e&&e.parentLayerId&&null!==e.parentLayerId&&void 0!==e.parentLayerId){var r=this._mapService.findLayerById(e.parentLayerId);r.isVisible()||(this._deleteItemWithId(e.parentLayerId,i),r._syncProgramaticallyChangedLayerVisibility(!0),i.push({mapServiceId:this._mapService.id,layerId:e.parentLayerId.toString(),visibility:!0})),this._recursivelyUpdateAncestorVisibility(r,t,i)}},r.prototype._recursivelyUpdateSublayerVisibility=function(e,t,i){if(e.subLayerIds&&0<e.subLayerIds.length)for(var r=0;r<e.subLayerIds.length;r++){var n=this._mapService.findLayerById(e.subLayerIds[r]),s=n.id;n._syncProgramaticallyChangedLayerVisibility(t),this._deleteItemWithId(s,i),i.push({mapServiceId:this._mapService.id,layerId:s.toString(),visibility:t}),n.subLayerIds&&0<n.subLayerIds.length&&this._recursivelyUpdateSublayerVisibility(n,t,i)}},r.prototype._getAllCurrentlyVisibleLayers=function(){for(var e=[],t=0;t<this._mapService.layers.length;t++){var i=this._mapService.layers[t];i.isVisible()&&e.push(i.id.toString())}return e},r.prototype._findWmsLayerIdFromName=function(e){for(var t=0;t<this._mapService.layers.length;t++){var i=this._mapService.layers[t];if(e==i.wmsLayerName)return i.id}return null},r.prototype._deleteItemWithId=function(e,t){for(var i=0;i<t.length;i++)t[i].layerId==e&&t.splice(i,1)},r);function r(e,t){if(this._mapService=null,this._mapService=e,this._mapService.mapServiceType!=m.MapServiceType.WMS&&this._mapService.mapServiceType!=m.MapServiceType.DYNAMIC)throw new Error("LayerVisibilityEventManager: Only Dynamic and WMS Layer types supported.");var r=this;dojo.aspect.before(t,"setVisibleLayers",function(e,t){return r.beforeESRIsetVisibleLayers(e,t)}),dojo.aspect.after(t,"setVisibleLayers",function(e,t,i){r.afterESRIsetVisibleLayers(e,t,i)},!0)}t.LayerVisibilityEventManager=i})},"geocortex/essentials/Map":function(){var r,O=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)});define(["require","exports","./AsyncInitializable","./BaseMap","./MapService","./LayerThemesInfo","./ExportMapImageOptions","./DistanceUnit","./ExtentManager","./utilities/UrlUtilities","./MapServiceConstants","./FeatureLayerService","geocortex/framework/utils/utils","./GeoRssLayerService","./KmlService","./StreamLayerService","./WFSLayerService","./exportMap/ExportMapTask","./exportMap/ExportMapParameters","./catalog/LayerCatalogDetail","./LayerTheme","./RestHelper","./../geocortex","./BaseMapService","./RestHelperHTTPService","geocortex/framework/utils/utils","geocortex/framework/utils/ArrayUtils"],function(e,t,i,n,c,r,s,a,o,l,u,p,h,d,f,y,m,v,g,_,S,L,b,T,E,I,x){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var w,M=(w=i.AsyncInitializable,O(R,w),R.prototype.getMap=function(){return this._esriMap},R.prototype.allLayers=function(){for(var e=[],t=0,i=this.mapServices;t<i.length;t++)for(var r=0,n=i[t].layers;r<n.length;r++){var s=n[r];e.push(s)}return e},R.prototype.allTables=function(){for(var e=[],t=0,i=this.mapServices;t<i.length;t++)for(var r=0,n=i[t].tables;r<n.length;r++){var s=n[r];e.push(s)}return e},R.prototype.allLayersAndTables=function(){var e=[];return e=this.allLayers(),e=this.allTables().reduce(function(e,t){return e.push(t),e},e)},R.prototype.filteredLayers=function(){for(var e=[],t=0,i=this.mapServices;t<i.length;t++){var r=i[t];this._layerThemeMapServiceFilter(r)&&(e=e.concat(r.layers))}return e},R.prototype.loadServiceLayersInMap=function(e){if(!e)throw new Error("Must supply a map");this._esriMap=e,this.fitTiledMapsToExtent=!!e._fitTiledMapsToExtent,this.extentManager=new o.ExtentManager(e,this.fitTiledMapsToExtent);for(var t=0,i=this.mapServices;t<i.length;t++){var r=i[t],n=r.serviceLayer;n&&(this.extentManager.registerLayer(n),n.loaded||r.failureTimeoutThresholdExceeded?(this._layerLoadedUpdate(e),r._handleServiceLayerLoaded(n),r._handleDynamicLayers(n)):(dojo.connect(r,"onFailureTimeoutThresholdExceeded",dojo.hitch(this,this._layerLoadedUpdate,e)),dojo.connect(n,"onLoad",dojo.hitch(this,this._layerLoadedUpdate,e)),dojo.connect(n,"onError",dojo.hitch(this,this._layerLoadedUpdate,e))))}},R.prototype.calculateScale=function(){return esri.geometry.getScale(this.site.getMap())},R.prototype._addServiceLayers=function(e){for(var t=this.mapServices.filter(function(e){return e instanceof y.StreamLayerService}).concat(this.mapServices.filter(function(e){return!(e instanceof y.StreamLayerService)})),i=t.length-1;0<=i;i--){var r=t[i].serviceLayer;if(!r.loadError){this._canAddLayersUnsuspended||(r.suspend(),this._suspendedLayers.push(r)),(r instanceof esri.layers.DynamicMapServiceLayer||r instanceof esri.layers.TiledMapServiceLayer)&&r.fullExtent&&(I.isNullOrUndefined(r.fullExtent.xmax)||"NaN"===r.fullExtent.xmax.toString()||I.isNullOrUndefined(r.fullExtent.ymax)||"NaN"===r.fullExtent.ymax.toString()||I.isNullOrUndefined(r.fullExtent.xmin)||"NaN"===r.fullExtent.xmin.toString()||I.isNullOrUndefined(r.fullExtent.ymin)||"NaN"===r.fullExtent.ymin.toString())&&(r.fullExtent=r.initialExtent);try{e.addLayer(r)}catch(e){this.site.onLayerLoadError(e),t[i].initializationFailure=e}}}this.site&&dojo.isObject(this.site)&&(this.site.serviceLayersLoaded=!0,dojo.isFunction(this.site.onServiceLayersLoaded)&&this.site.onServiceLayersLoaded(this.site))},R.prototype.addServiceLayers=function(e,a){var t=this;if(e||e.length){for(var o=[],l=this,r=function(e){var t=null,i=!1,r=u.MapServiceType.FEATURE;switch(e.opacity=e.opacity||1,e.type){case"Feature Layer":t=new p.FeatureLayerService(e.url);break;default:switch(e.declaredClass){case"esri.layers.WebTiledLayer":t=new c.MapService(e.tileServers[0]),r=u.MapServiceType.WEBTILED,i=!0}}if(t){t.serviceLayer=e,t.essentialsMap=l;var n=e.layerId||h.alphaNumericToken(),s={id:n,isExpanded:!0,includeInLayerList:i,serviceFunction:a,serviceType:r,layerOptions:null};s.layerOptions={id:n,name:e.name,description:e.description,displayField:e.displayField,includeInLayerList:!0,identifiable:!0,fullExtent:e.fullExtent,primaryKeyField:e.objectIdField,visible:e.visible},t._createFrom(s),o.push(t),dojo.connect(e,"onClick",function(e){dojo.publish("FeatureClickedEvent",dojo.mixin(e,{layer:t.layers[0],useFeaturePresenter:!0}))})}},i=function(e){if(e.getFeatureLayers){var t=e,i=t.getFeatureLayers();if(i&&0<i.length)return dojo.forEach(i,function(e){e.name=e.name||t.name,r(e)}),"continue"}r(e)},n=0,s=e;n<s.length;n++)i(s[n]);this.mapServices=this.mapServices.concat(o),dojo.forEach(o,function(e){return t._addToFilteredView(e)}),this._addServiceLayers(this.getMap()),dojo.forEach(o,function(e){dojo.publish("MapServiceAddedEvent",e)})}},R.prototype.removeServiceLayer=function(e){if(e&&this.mapServices.length)for(var t=0;t<this.mapServices.length;t++){var i=this.mapServices[t];if(i&&i.serviceLayer&&i.serviceLayer===e){this.mapServices.splice(t,1),dojo.publish("MapServiceRemovedEvent",i);break}}},R.prototype.enableUnsuspendedMapLayers=function(){this._suspendedLayers.forEach(function(e){e.resume()}),this._suspendedLayers=[],this._canAddLayersUnsuspended=!0},R.prototype.addMapService=function(e){var t=this.getMap(),i=this.site,r=e instanceof c.MapService?e:e.mapService,n=!(e instanceof c.MapService||!e.respectVisibility);r.isUserCreated=!0,r.includeInLayerList=!(r instanceof p.FeatureLayerService||r instanceof m.WFSLayerService||r instanceof y.StreamLayerService),r.opacity=1;for(var s=0,a=r.layers;s<a.length;s++){var o=a[s];o.isUserCreated=!0,o.includeInLayerList=!0,o.includeInLegend=!0,o.site=i,n||(o.configuredVisible=!0,r.supportsLayerVisibility()?o.setVisibility(!0):o._visible=!0)}(r.essentialsMap=this).mapServices.push(r),t.addLayer(r.serviceLayer),dojo.publish("MapServiceAddedEvent",r),n||r.setVisibility(!0)},R.prototype.removeMapService=function(e){if(e){var t=this.mapServices.indexOf(e);0<=t&&(this.mapServices.splice(t,1),dojo.publish("MapServiceRemovedEvent",e)),this._esriMap&&e.serviceLayer&&this._esriMap.removeLayer(e.serviceLayer)}},R.prototype._configureMapServices=function(e,t){for(var i=0;e&&i<e.length;i++){var r=e[i],n=this.originalUrl+"/mapservices/"+r.id;if(r.drawingBehavior===u.DrawingBehavior.FEATURE_LAYER){if(!dojo.isObject(esri.layers.FeatureLayer))throw new Error("This Javascript application must require the esri.layers.FeatureLayer package in order to use a site with feature layers");this.mapServices[i]=new p.FeatureLayerService(n)}else if(r.drawingBehavior===u.DrawingBehavior.GEORSS_LAYER){if(!dojo.isObject(esri.layers.GraphicsLayer))throw new Error("This Javascript application must require the esri.layers.GraphicsLayer package in order to use a site with GeoRSS layers");this.mapServices[i]=new d.GeoRssLayerService(n)}else if(r.drawingBehavior===u.DrawingBehavior.KML_SERVICE){if(!dojo.isObject(esri.layers.KMLLayer))throw new Error("This Javascript application must require the esri.layers.KMLLayer package in order to use a site with KML layers");this.mapServices[i]=new f.KmlService(n)}else if(r.drawingBehavior===u.DrawingBehavior.STREAM_LAYER){if(!dojo.isObject(esri.layers.StreamLayer))throw new Error("This Javascript application must require the esri.layers.StreamLayer package in order to use a site with stream layers");this.mapServices[i]=new y.StreamLayerService(n)}else if(r.drawingBehavior===u.DrawingBehavior.WFS_LAYER){if(!dojo.isObject(esri.layers.WFSLayer))throw new Error("This Javascript application must require the esri.layers.WFSLayer package in order to use a site with WFS layers");this.mapServices[i]=new m.WFSLayerService(n),this.mapServices[i].mapServiceType=u.MapServiceType.WFS}else this.mapServices[i]=new c.MapService(n);(this.mapServices[i].essentialsMap=this).mapServices[i].initialize(r),dojo.publish("ServiceLayerInitializedEvent",this.mapServices[i].serviceLayer),this._addToFilteredView(this.mapServices[i])}},R.prototype._configureObject=function(e,t){if(void 0===e||void 0===e.mapServices)throw new Error("Incorrect map object returned from initialization");var i;e.initialExtent&&(I.isNullOrUndefined(e.initialExtent.spatialReference)&&(i=x.firstOrDefault(e.mapServices,function(e){return e.fullExtent&&e.fullExtent.spatialReference}))&&(e.initialExtent.spatialReference=i.fullExtent.spatialReference),this.initialExtent=new esri.geometry.Extent(e.initialExtent)),e.fullExtent&&(I.isNullOrUndefined(e.fullExtent.spatialReference)&&(i=x.firstOrDefault(e.mapServices,function(e){return e.fullExtent&&e.fullExtent.spatialReference}))&&(e.fullExtent.spatialReference=i.fullExtent.spatialReference),this.fullExtent=new esri.geometry.Extent(e.fullExtent));e.units&&(this.units=new a.DistanceUnit(e.units.name,e.units.type)),e.exportOptions&&(this.exportMapImageOptions=new s.ExportMapImageOptions(e.exportOptions.allowIncludeGeoreferenceData,e.exportOptions.defaultOutputFormat)),e.layerThemes&&(e.layerThemes.items&&e.layerThemes.items.length||e.layerThemes.allowDefault)&&this._configureLayerThemesInfo(e.layerThemes),this._configureMapServices(e.mapServices,t),dojo.isArray(e.baseMaps)&&this._configureBaseMaps(e.baseMaps),t&&(this.isInitialized=!0),this.primaryMapService=this.findMapServiceById(e.primaryMapServiceID)},R.prototype.findMapServiceById=function(e){for(var t=0,i=this.mapServices;t<i.length;t++){var r=i[t];if(r.id===e)return r}return null},R.prototype.setFeatureLayerExclusivelyVisible=function(e){for(var t=0,i=this.site.getFeatureServices();t<i.length;t++){var r=i[t];r.setVisibility(r.serviceLayer.id===e.id)}},R.prototype.exportMap=function(e,t,i){var r=this;this._onExportComplete=t,this._onExportError=i;var n=new v.ExportMapTask(this),s=new g.ExportMapParameters;s.reportParameters=e,n.generateMapImageUrl(s).then(function(e){return r._exportRestComplete(e)},function(e){return r._exportRestError(e)})},R.prototype.findLayerFromMatchingEsriFeatureLayer=function(t){if(t){for(var e=0;e<this.mapServices.length;e++)if((f=this.mapServices[e]).serviceLayer instanceof esri.layers.FeatureLayer){var i=f.serviceLayer;if(i.layerId===t.layerId&&i.name===t.name&&0<f.layers.length)return f.layers[0]}var r=this.allTables().filter(function(e){return e.id===t.layerId.toString()&&e.name===t.name})[0];if(r)return r;for(var n=function(e,t){var i=e.serviceUrl;return e.serviceToken&&0<t.search(/token=.[^&]*/g)&&(i=E.RestHelperHTTPService.appendTokenToUrl(i,e.serviceToken)),i},s=t.url.match(/.[^?]*/g)[0],a=0,o=this.mapServices;a<o.length;a++)if(n(f=o[a],s)===s&&0<f.layers.length)return f.layers[0];for(var l=new RegExp("[^/]*.$"),c=Number(s.match(l)),u=new RegExp("/[^/]*.$"),p=s.replace(u,""),h=0,d=this.mapServices;h<d.length;h++){var f;if(n(f=d[h],p)===p){var y=f.findLayerOrTableById(c.toString());if(y)return y;if(f.layers.length>=c)return f.layers[c]}}return null}},R.prototype._exportRestComplete=function(e){var t=null;e?e.error&&(t=e.error):t=new Error("No results"),t&&this._onExportComplete&&this._onExportError(t),e&&this._onExportComplete&&this._onExportComplete(e)},R.prototype._exportRestError=function(e){this._onExportError&&this._onExportError(e)},R.prototype._layerLoadedUpdate=function(e){if(!this.serviceLayersAdded){for(var t=0,i=this.mapServices;t<i.length;t++){var r=i[t],n=r.serviceLayer;if(!r.initializationFailure&&r.failureTimeoutThresholdExceeded&&(r.initializationFailure=new Error("Map Service - {0}: Failure timeout threshold exceeded.".format(r.id))),!n.loaded&&!r.initializationFailure&&!r.failureTimeoutThresholdExceeded)return}this.serviceLayersAdded=!0,this.spatialReference=this.primaryMapService.serviceLayer.loadError?this.initialExtent.spatialReference:this.primaryMapService.serviceLayer.spatialReference,this.spatialReference&&this._switchSpatialReferenceGlobally(this.spatialReference),this._esriMap.spatialReference||(this._esriMap.spatialReference=this.spatialReference||this.initialExtent.spatialReference||this.fullExtent.spatialReference),!this._esriMap.extent&&this.initialExtent&&this._esriMap.setExtent(new esri.geometry.Extent(this.initialExtent.toJson())),this._addServiceLayers(e)}},R.prototype.applyCatalogLayersChange=function(e){e&&(this._applyCatalogChangesToDynamicLayers(e),this._applyCatalogChangesToWmsLayers(e))},R.prototype.applyStartupTheme=function(){this.layerThemesInfo.layerThemesConfigured&&this.layerThemesInfo.applyTheme(this.layerThemesInfo.startupThemeId||this.layerThemesInfo.themes[0].id)},R.prototype.refreshFilteredCollections=function(){var t=this;this.mapServicesFilteredView.length=0,dojo.forEach(this.mapServices,function(e){return t._addToFilteredView(e)});for(var e=0,i=this.mapServices;e<i.length;e++)i[e].refreshFilteredCollections()},R.prototype._switchSpatialReferenceGlobally=function(e){if(this.initialExtent&&(this.initialExtent=new esri.geometry.Extent(this.initialExtent.xmin,this.initialExtent.ymin,this.initialExtent.xmax,this.initialExtent.ymax,e)),this.fullExtent&&(this.fullExtent=new esri.geometry.Extent(this.fullExtent.xmin,this.fullExtent.ymin,this.fullExtent.xmax,this.fullExtent.ymax,e)),this.site.hasNamedExtents&&this.site.namedExtents&&this.site.namedExtents.length)for(var t=0,i=this.site.namedExtents;t<i.length;t++){var r=i[t];r.extent=new esri.geometry.Extent(r.extent.xmin,r.extent.ymin,r.extent.xmax,r.extent.ymax,e)}this._esriMap.spatialReference=e,this._esriMap.extent.spatialReference=e},R.prototype._applyCatalogChangesToWmsLayers=function(e){},R.prototype._applyCatalogChangesToDynamicLayers=function(e){var t=e.mapServiceId,i=[],r=new _.LayerCatalogDetail;r.mapServiceId=t;for(var n=0,s=e.entries;n<s.length;n++){var a=s[n];a.isDynamic&&i.push(a)}r.entries=i;var o=this.findMapServiceById(t);o&&o.applyCatalogLayersChange(r)},R.prototype._configureLayerThemesInfo=function(e){var t=this;if(!e)throw new Error("RestLayerThemesInfo object not defined. Cannot configure layer themes.");this.layerThemesInfo.layerThemesConfigured=!0,this.layerThemesInfo.allowDefault=!!I.isNullOrUndefined(e.allowDefault)||e.allowDefault,this.layerThemesInfo.startupThemeId=e.startupThemeID,this.layerThemesInfo.allowDefault&&this.layerThemesInfo.themes.push(new S.LayerTheme(this.layerThemesInfo,null,e.defaultThemeDisplayName||"")),e.items&&e.items.length&&dojo.forEach(e.items,function(e){t.layerThemesInfo.themes.push(new S.LayerTheme(t.layerThemesInfo,e))})},R.prototype._addToFilteredView=function(e){e&&this._layerThemeMapServiceFilter(e)&&this.mapServicesFilteredView.push(e)},R.prototype._layerThemeMapServiceFilter=function(e){return!e.essentialsMap.layerThemesInfo.layerThemesConfigured||e.inActiveTheme},R.prototype._configureBaseMaps=function(e){var r=this;e.forEach(function(e){var i=new n.BaseMap(r);i.displayName=e.displayName,i.id=e.id,e.iconUri&&(i.iconUri=L.RestHelper.processClientSideTokens(r.site,e.iconUri)),e.exportTilesMapServiceUri&&(i.exportTilesMapServiceUri=L.RestHelper.processClientSideTokens(r.site,e.exportTilesMapServiceUri)),i.properties=b._getProperties(e.properties),i.extensions=b._getExtensions(e.extensions),dojo.isArray(e.mapServices)&&e.mapServices.forEach(function(e){var t=r.findMapServiceById(e.id);t&&i.services.push(new T.BaseMapService(t))}),r.baseMaps.push(i)})},R);function R(e){var t=w.call(this,e)||this;return t.baseMaps=[],t.fullExtent=null,t.initialExtent=null,t.fitTiledMapsToExtent=!1,t.mapServices=[],t.mapServicesFilteredView=[],t.layerThemesInfo=null,t.primaryMapService=null,t.supportedExportFormats=["BMP","JPEG","PNG","TIFF","GeoTIFF","PDF"],t.exportMapImageOptions=null,t.units=null,t.serviceLayersAdded=!1,t.extentManager=null,t.spatialReference=null,t.setExtentOnLoad=!0,t.isLoaded=!1,t._esriMap=null,t._onExportComplete=null,t._onExportError=null,t._suspendedLayers=[],t._canAddLayersUnsuspended=!1,t.originalUrl=e,t.url=l.UrlUtilities.simplify(e),t.layerThemesInfo=new r.LayerThemesInfo(t),t}t.Map=M})},"geocortex/essentials/MapGrid":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});function i(){}t.MapGrid=i})},"geocortex/essentials/MapService":function(){var r,m=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)});define(["require","exports","./AsyncInitializable","./MapServiceConstants","./Layer","./LayerThemeSetting","./LayerHyperlink","./TimeInfo","./LayerVisibilityEventManager","./utilities/UrlUtilities","./../geocortex","./RestHelper","./../hasProxy","./RestHelperHTTPService","./RefreshVisibility","./ServiceHelper","geocortex/framework/SimplePromise","geocortex/framework/utils/utils","./LayerType","geocortex/framework/utils/ArrayUtils","./utilities/TimeZoneUtils"],function(C,e,t,P,u,p,h,r,F,i,d,f,U,k,n,y,o,A,l,c,N){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var s,a=(s=t.AsyncInitializable,m(j,s),j.prototype._getLayersInfo=function(e){var s=this,t=this.findLayerById(e);if(this._layerInfoPromises.all&&this._layerInfoPromises.all.isRejected()&&e&&this._layerInfoPromises[e]&&this._layerInfoPromises[e].isRejected())return this._layerInfoPromises[e];if(e&&this._layerInfoPromises[e]&&!this._layerInfoPromises[e].isRejected())return this._layerInfoPromises[e];if(this._layerInfoPromises.all&&!this._layerInfoPromises.all.isRejected())return this._layerInfoPromises.all;if(this.serviceUrl.endsWith("/MapServer")){var i=[];this.serviceLayer instanceof esri.layers.FeatureLayer?this._layerInfoPromises.all||i.push({layerId:"all",url:this.serviceUrl}):(e&&!this._layerInfoPromises[e]&&t&&!t.isDynamic&&i.push({layerId:e,url:this.serviceUrl+"/"+e}),this._layerInfoPromises.all||i.push({layerId:"all",url:this.serviceUrl+"/layers"})),i.forEach(function(e){s._layerInfoPromises[e.layerId]=new Promise(function(n){return function(r,i){s.doWhenInitialized(function(e){var t={url:n,content:{f:"json"},load:function(e){if(s.serviceLayer instanceof esri.layers.FeatureLayer&&!e.layers||e.type){var t={},i=[e];t[e.type&&"table"===e.type.toLowerCase()?"tables":"layers"]=i,e=t}r(e)},error:function(e){return i(e)},callbackParamName:"CallBack",preventCache:!1};null!==s.serviceToken&&(t.content.token=s.serviceToken),esri.request(t,{gcx:{preventCache:!1}})})}}(e.url))})}else this._layerInfoPromises.all||this._layerInfoPromises.all.isRejected()||(this._layerInfoPromises.all=Promise.resolve(null));return this._layerInfoPromises[e]||this._layerInfoPromises.all},j.prototype.getConfiguredVisibleLayers=function(){return this._getVisibleLayersOfType("configuredVisible")},j.prototype.getDefaultVisibleLayers=function(){return this._getVisibleLayersOfType("defaultVisibility")},j.prototype.getVisibleLayers=function(){return this._getVisibleLayersOfType("_visible")},j.prototype._getVisibleLayersOfType=function(e){for(var t=[],i=0,r=0,n=this.layers;r<n.length;r++){var s=n[r];s[e]&&null==s.parentLayerId&&(null==s.subLayerIds||0===s.subLayerIds.length?(i=this._addAnnotationSublayers(s,t,i),t[i++]=s.id):i=this._getVisibleGroupLayersOfType(e,s,t,i))}return t},j.prototype._addAnnotationSublayers=function(i,e,r){if(i.type===l.LayerType.RASTER_LAYER&&i.mapService.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer){var t=c.firstOrDefault(i.mapService.serviceLayer.layerInfos,function(e){return e.id.toString()===i.id});if(t&&t.subLayerIds&&0<t.subLayerIds.length)for(var n=function(t){c.firstOrDefault(i.mapService.layers,function(e){return e.id===t.toString()})||(e[r++]=t.toString())},s=0,a=t.subLayerIds;s<a.length;s++)n(a[s])}return r},j.prototype.isVisible=function(){var e=!1;return this.serviceLayer&&"boolean"==typeof this.serviceLayer.visible&&(e=this.serviceLayer.visible),e},j.prototype.isTiled=function(){return!!this.serviceLayer&&this.serviceLayer instanceof esri.layers.TiledMapServiceLayer},j.prototype.setVisibility=function(e){if(null!==this.serviceLayer){if(!this.supportsLayerVisibility()&&this.layers.length)for(var t=0,i=this.layers;t<i.length;t++){var r=i[t];r&&(r._visible=e)}e?this.serviceLayer.show():this.serviceLayer.hide()}},j.prototype.setOpacity=function(e){null!=e&&!isNaN(e)||(e=1),e=Math.min(1,Math.max(0,e)),this.opacity=e,this.serviceLayer&&this.serviceLayer.setOpacity&&this.serviceLayer.setOpacity(e*this.opacityFilter)},j.prototype.setOpacityFilter=function(e){isNaN(e)&&(e=1),e=Math.min(1,Math.max(0,e)),this.opacityFilter=e,this.serviceLayer&&this.serviceLayer.setOpacity&&this.serviceLayer.setOpacity(e*this.opacity)},j.prototype.setInActiveTheme=function(e){this.inActiveTheme=e,dojo.publish("MapServiceInActiveThemeChangedEvent",this)},j.prototype.findServiceToken=function(){return this.serviceToken?this.serviceToken:this.essentialsMap&&this.essentialsMap.site&&this.essentialsMap.site.arcGisPortalSecurityContext?this.essentialsMap.site.arcGisPortalSecurityContext.getToken(this.serviceUrl):null},j.prototype._findById=function(e,t){for(var i=0,r=t;i<r.length;i++){var n=r[i];if(n.id==e)return n}return null},j.prototype._findByName=function(e,t){for(var i=0,r=t;i<r.length;i++){var n=r[i];if(n.name==e||n.displayName==e)return n}return null},j.prototype._findByNameAndId=function(e,t,i){if(0===i.length)return null;var r=[],n=["name","displayName"];i[0].mapService&&(i[0].mapService.mapServiceType===P.MapServiceType.WMS||i[0].mapService.mapServiceType===P.MapServiceType.WMTS?n.push("wmsLayerName"):i[0].mapService.mapServiceType===P.MapServiceType.WFS&&n.push("wfsLayerName"));for(var s=0,a=i;s<a.length;s++)for(var o=a[s],l=0,c=n;l<c.length;l++)if(o[c[l]]==e){r.push(o);break}for(var u=0,p=r;u<p.length;u++){var h=p[u];if(h.id==t)return h}return null},j.prototype.findLayerByName=function(e){return this._findByName(e,this.layers)},j.prototype.findLayerById=function(e){return this._findById(e,this.layers)},j.prototype.findTableByName=function(e){return this._findByName(e,this.tables)},j.prototype.findTableById=function(e){return this._findById(e,this.tables)},j.prototype.findTableByNameAndId=function(e,t){return this._findByNameAndId(e,t,this.tables)},j.prototype.findLayerByNameAndId=function(e,t){return this._findByNameAndId(e,t,this.layers)},j.prototype.findLayerOrTableByName=function(e){var t=this.findLayerByName(e);return t=t||this.findTableByName(e)},j.prototype.findLayerOrTableById=function(e){var t=this.findLayerById(e);return t=t||this.findTableById(e)},j.prototype.findLayerOrTableByNameAndId=function(e,t){var i=this.findLayerByNameAndId(e,t);return i=i||this.findTableByNameAndId(e,t)},j.prototype.refresh=function(e,t){var i=this,r=this.serviceLayer;if(r&&"function"==typeof r.refresh){var n=function(){if(!(i._delayedRefreshToken=null)===t&&"function"==typeof r.setDisableClientCaching){var e=r.disableClientCaching;r.setDisableClientCaching(!0),r.refresh(),r.setDisableClientCaching(e)}else r.refresh()};this._delayedRefreshToken&&clearTimeout(this._delayedRefreshToken),"number"!=typeof e?n():this._delayedRefreshToken=setTimeout(n,e)}},j.prototype.refreshFilteredCollections=function(){var t=this;this.layersFilteredView.length=0,dojo.forEach(this.layers,function(e){return t._addToFilteredView(e)})},j.prototype._configureLayers=function(e,t){for(var i=0;e&&i<e.length;i++)this.layers[i]=new u.Layer(this.url+"/layers/"+e[i].id),(this.layers[i].mapService=this).layers[i]._configureObject(e[i],t);this._createServiceLayer(),this.minScale&&this.serviceLayer.setMinScale(this.minScale),this.maxScale&&this.serviceLayer.setMaxScale(this.maxScale),this.disableClientCaching&&this.serviceLayer&&this.serviceLayer.setDisableClientCaching&&this.serviceLayer.setDisableClientCaching(!0)},j.prototype._configureTimeInfo=function(){if(!this.serviceLayer)throw new Error("_configureTimeInfo: The esri service layer must be created before attempting to populate time information.");var e=this.serviceLayer.timeInfo;e?(this.isTimeAware=!0,this.timeInfo=r.getGcxTimeInfo(e,this._restStartTimeOverrideString,this._restEndTimeOverrideString)):this.isTimeAware=!1},j.getGcxTimeInfo=function(e,t,i){return r.getGcxTimeInfo.apply(this,arguments)},j.prototype._configureTables=function(e,t){for(var i=0;e&&i<e.length;i++)this.tables[i]=new u.Layer(this.url+"/tables/"+e[i].id),(this.tables[i].mapService=this).tables[i]._configureObject(e[i],t)},j.prototype._createFrom=function(e){var t=this;if(this.id=e.id,this.serviceUrl=e.serviceUrl,this.tileRestUrl=e.tileRestUrl,this.mapUrl=e.mapUrl,this.subDomains=(e.subDomains||[]).slice(),this.mapServiceType=e.serviceType,this.mapServiceFunction=e.serviceFunction,this.displayName=e.displayName||e.name,this.shortDisplayName=e.shortDisplayName,this.baseMapGroup=e.baseMapGroup,this.baseMapGroupIndex=e.baseMapGroupIndex,this.baseMapGroupIsMutuallyExclusive=e.baseMapGroupIsMutuallyExclusive,this.description=e.description,this.copyright=e.copyright,this.attributionDataUrl=e.attributionDataUrl,this.hasAttributionData=e.hasAttributionData,this.configuredVisible=!!e.visible,this._initiallyVisible=this.configuredVisible,this.disableClientCaching=!!e.disableClientCaching,this.instantSearch=!!e.instantSearch,this.configuredOpacity=e.opacity,this.opacity=this.configuredOpacity,this.imageFormat=e.format,this.isExpanded=e.isExpanded,this.isUserCreated=A.isNullOrUndefined(e.isUserCreated)?this.isUserCreated:e.isUserCreated,this.userLayerType=A.isNullOrUndefined(e.userLayerType)?this.userLayerType:e.userLayerType,this.serverVersion=e.serverVersion,this.failureAction=e.failureAction,this.failureTimeout=e.failureTimeout,this.tileMatrixSet=e.tileMatrixSet,this.requestEncoding=e.requestEncoding,this.operationalSpatialReference=e.operationalSpatialReference,this.dataProvider=e.dataProvider,this.minScale=e.minScale,this.maxScale=e.maxScale,this.identifiable=!!e.identifiable,this.includeCatalogItems=!!e.includeCatalogItems,this.includeMosaicDatasetValues=!!e.includeMosaicDatasetValues,this.defaultDateFormat=e.defaultDateFormat,this.defaultNumberFormat=e.defaultNumberFormat,this.timeZoneId=e.timeZoneId,this.serviceTag=e.serviceTag,e.timeAwareMode&&(this.timeAwareMode=e.timeAwareMode),e.tileInfo&&(this.tileInfo=dojo.clone(e.tileInfo),this.tileInfo.spatialReference&&(this.tileInfo.spatialReference.wkid?this.tileInfo.spatialReference=new esri.SpatialReference(this.tileInfo.spatialReference.wkid):this.tileInfo.spatialReference=new esri.SpatialReference(this.tileInfo.spatialReference.wkt))),this.supportsDynamicLayers=!1,this.includeInLayerList=e.includeInLayerList,this.drawingBehavior=e.drawingBehavior||P.DrawingBehavior.FEATURE_LAYER,e.layerOptions){var i=new u.Layer;i.mapService=this,i._createFrom(e.layerOptions),this.layers.push(i)}e.hasOwnProperty("layerHyperlinks")&&e.layerHyperlinks.forEach(function(e){t.layerHyperlinks.push(new h.LayerHyperlink(e,t))}),e.featureClustering&&(this.featureClustering={enabled:e.featureClustering.enabled,userCanToggle:e.featureClustering.userCanToggle,radius:e.featureClustering.radius,maximumFeatures:e.featureClustering.clusterSize,backgroundColor:e.featureClustering.backgroundColor,labelColor:e.featureClustering.labelColor}),e.featureHeatMap&&(this.heatMap={enabled:e.featureHeatMap.enabled,userCanToggle:e.featureHeatMap.userCanToggle,respectScaleRange:e.featureHeatMap.respectScaleRange,gradient:(e.featureHeatMap.gradient||[]).slice(),offset:(e.featureHeatMap.offset||[]).slice(),intensity:e.featureHeatMap.intensity,defaultIntensity:e.featureHeatMap.intensity,field:e.featureHeatMap.field,defaultField:e.featureHeatMap.field,defaultRenderer:e.featureHeatMap.defaultRenderer?esri.renderer.fromJson(e.featureHeatMap.defaultRenderer):null,defaultMinScale:e.featureHeatMap.defaultMinScale,defaultMaxScale:e.featureHeatMap.defaultMaxScale,includeInLegend:e.featureHeatMap.includeInLegend}),e.properties&&(this.catalogId=d._getProperties(e.properties).layerCatalogLookupId),this.isInitialized=!0},j.prototype.createFromDefinition=function(e){this._createFrom(e)},j.prototype.toJson=function(){var e={id:this.id,url:this.url,serviceUrl:this.serviceUrl,mapUrl:this.mapUrl,tileRestUrl:this.tileRestUrl,subDomains:(this.subDomains||[]).slice(),serviceType:this.mapServiceType,serviceFunction:this.mapServiceFunction,displayName:this.displayName,shortDisplayName:this.shortDisplayName,baseMapGroup:this.baseMapGroup,baseMapGroupIndex:this.baseMapGroupIndex,baseMapGroupIsMutuallyExclusive:this.baseMapGroupIsMutuallyExclusive,description:this.description,copyright:this.copyright,attributionDataUrl:this.attributionDataUrl,hasAttributionData:this.hasAttributionData,visible:this.isVisible(),disableClientCaching:this.disableClientCaching,opacity:this.opacity,instantSearch:this.instantSearch,format:this.imageFormat,updateInterval:this.updateInterval,isExpanded:this.isExpanded,serverVersion:this.serverVersion,failureAction:this.failureAction,failureTimeout:this.failureTimeout,tileMatrixSet:this.tileMatrixSet,requestEncoding:this.requestEncoding,operationalSpatialReference:this.operationalSpatialReference,dataProvider:this.dataProvider,minScale:this.minScale,maxScale:this.maxScale,identifiable:this.identifiable,includeCatalogItems:this.includeCatalogItems,includeMosaicDatasetValues:this.includeMosaicDatasetValues,defaultDateFormat:this.defaultDateFormat,defaultNumberFormat:this.defaultNumberFormat,timeZoneId:this.timeZoneId,serviceTag:this.serviceTag,startTime:this._restStartTimeOverrideString,endTime:this._restEndTimeOverrideString,timeAwareMode:this.timeAwareMode,tileInfo:this.tileInfo&&"function"==typeof this.tileInfo.toJson?this.tileInfo.toJson():void 0,supportsDynamicLayers:this.supportsDynamicLayers,hasLayerCatalog:this.hasLayerCatalog,includeInLayerList:this.includeInLayerList,drawingBehavior:this.drawingBehavior,layerOptions:this.layers.map(function(e){return e.toJson()}),catalogId:this.catalogId,isUserCreated:this.isUserCreated,userLayerType:this.userLayerType,tables:this.tables.map(function(e){return e.toJson()}),layerHyperlinks:this.layerHyperlinks.map(function(e){return e.toJson()}),properties:d._propertiesToJson(this.properties),extensions:d._extensionsToJson(this.extensions)};return this.featureClustering&&(e.featureClustering=dojo.clone(this.featureClustering)),this.heatMap&&(e.featureHeatMap=dojo.clone(this.heatMap),e.featureHeatMap.defaultRenderer instanceof esri.renderer.Renderer&&(e.featureHeatMap.defaultRenderer=e.featureHeatMap.defaultRenderer.toJson())),e},j.prototype._configureObject=function(e,t){var i=this;if(A.isNullOrUndefined(e)||A.isNullOrUndefined(e.id)||A.isNullOrUndefined(e.displayName)||A.isNullOrUndefined(e.serviceType)||A.isNullOrUndefined(e.connectionString))throw new Error("Incorrect map service object returned from initialization");if(this.id=e.id,this.mapServiceType=e.serviceType,this.mapServiceFunction=A.isNullOrUndefined(e.serviceFunction)?this.mapServiceFunction:e.serviceFunction,this.displayName=e.displayName,this.shortDisplayName=e.shortDisplayName,this.baseMapGroup=e.baseMapGroup,this.baseMapGroupIndex=e.baseMapGroupIndex,this.baseMapGroupIsMutuallyExclusive=e.baseMapGroupIsMutuallyExclusive,this.description=A.isNullOrUndefined(e.description)?this.description:e.description,this.copyright=e.copyright,this.attributionDataUrl=e.attributionDataUrl,this.hasAttributionData=e.hasAttributionData,this.configuredVisible=!!e.visible,this.disableClientCaching=!!e.disableClientCaching,this.instantSearch=!!e.instantSearch,this.configuredOpacity=A.isNullOrUndefined(e.opacity)||null===e.opacity?this.configuredOpacity:e.opacity,this.opacity=this.configuredOpacity,this.imageFormat=A.isNullOrUndefined(e.format)?this.imageFormat:e.format,!A.isNullOrUndefined(e.updateInterval)){var r=e.updateInterval;r&&r<10&&0!==r&&(r=10),this.updateInterval=r,this._resetUpdateTimer()}if(this.tileRestUrl=e.tileRestUrl,this.mapUrl=e.mapUrl,this.subDomains=(e.subDomains||[]).slice(),this.isExpanded=A.isNullOrUndefined(e.isExpanded)?this.isExpanded:e.isExpanded,this.isUserCreated=A.isNullOrUndefined(e.isUserCreated)?this.isUserCreated:e.isUserCreated,this.userLayerType=A.isNullOrUndefined(e.userLayerType)?this.userLayerType:e.userLayerType,this.catalogId=A.isNullOrUndefined(e.catalogId)?this.catalogId:e.catalogId,this.serverVersion=e.serverVersion,this.failureAction=e.failureAction,this.failureTimeout=e.failureTimeout,this.tileMatrixSet=e.tileMatrixSet,this.requestEncoding=e.requestEncoding,this.operationalSpatialReference=e.operationalSpatialReference,this.dataProvider=e.dataProvider,this.minScale=e.minScale,this.maxScale=e.maxScale,this.identifiable=!!e.identifiable,this.includeCatalogItems=!!e.includeCatalogItems,this.includeMosaicDatasetValues=!!e.includeMosaicDatasetValues,this.defaultDateFormat=e.defaultDateFormat,this.defaultNumberFormat=e.defaultNumberFormat,this.timeZoneId=e.timeZoneId,this.serviceTag=e.serviceTag,this._restStartTimeOverrideString=e.startTime||null,this._restEndTimeOverrideString=e.endTime||null,e.timeAwareMode&&(this.timeAwareMode=e.timeAwareMode),e.tileInfo&&(this.tileInfo=dojo.clone(e.tileInfo),this.tileInfo.spatialReference&&(this.tileInfo.spatialReference.wkid?this.tileInfo.spatialReference=new esri.SpatialReference(this.tileInfo.spatialReference.wkid):this.tileInfo.spatialReference=new esri.SpatialReference(this.tileInfo.spatialReference.wkt))),"boolean"==typeof e.includeInLayerList&&(this.includeInLayerList=e.includeInLayerList),this.isUserCreated)this._initiallyVisible=void 0===e.initiallyVisible?!!e.visible:!!e.initiallyVisible;else if(null!=this.essentialsMap.layerThemesInfo.startupThemeId&&this.includeInLayerList?this._initiallyVisible=!1:this._initiallyVisible=void 0===e.initiallyVisible?!!e.visible:!!e.initiallyVisible,e.themeSettings&&e.themeSettings.length)for(var n=0,s=e.themeSettings;n<s.length;n++){var a=s[n],o=this.essentialsMap.layerThemesInfo.getTheme(a.themeID);if(o){var l=A.isNullOrUndefined(a.visible)?this.configuredVisible:a.visible;this.layerThemeSettings.push(new p.LayerThemeSetting(o,l)),o.id===this.essentialsMap.layerThemesInfo.startupThemeId&&this.includeInLayerList&&(this._initiallyVisible=void 0===a.initiallyVisible?l:a.initiallyVisible)}}if(this.supportsDynamicLayers=void 0===e.supportsDynamicLayers?this.supportsDynamicLayers:e.supportsDynamicLayers,this.hasLayerCatalog=void 0===e.hasLayerCatalog?this.hasLayerCatalog:e.hasLayerCatalog,e.iconUri){var c=null;this.essentialsMap&&(c=this.essentialsMap.site),this.iconUri=f.RestHelper.processClientSideTokens(c,e.iconUri)}e.featureClustering&&(this.featureClustering={enabled:e.featureClustering.enabled,userCanToggle:e.featureClustering.userCanToggle,radius:e.featureClustering.radius,maximumFeatures:e.featureClustering.clusterSize,backgroundColor:e.featureClustering.backgroundColor,labelColor:e.featureClustering.labelColor}),e.featureHeatMap&&(this.heatMap={enabled:e.featureHeatMap.enabled,userCanToggle:e.featureHeatMap.userCanToggle,respectScaleRange:e.featureHeatMap.respectScaleRange,gradient:(e.featureHeatMap.gradient||[]).slice(),offset:(e.featureHeatMap.offset||[]).slice(),intensity:e.featureHeatMap.intensity,defaultIntensity:e.featureHeatMap.intensity,field:e.featureHeatMap.field,defaultField:e.featureHeatMap.field,defaultRenderer:e.featureHeatMap.defaultRenderer?esri.renderer.fromJson(e.featureHeatMap.defaultRenderer):null,defaultMinScale:e.featureHeatMap.defaultMinScale,defaultMaxScale:e.featureHeatMap.defaultMaxScale,includeInLegend:e.featureHeatMap.includeInLegend}),this.drawingBehavior=void 0===e.drawingBehavior?this.drawingBehavior:e.drawingBehavior,this._processConnectionString(e.connectionString,e),this._processProxyInfo(e.proxyInfo);var u=e.layers||e.layerOptions;this._configureLayers(u,t),this._configureTables(e.tables,t),e.hasOwnProperty("layerHyperlinks")&&e.layerHyperlinks.forEach(function(e){i.layerHyperlinks.push(new h.LayerHyperlink(e,i))}),t&&(this.isInitialized=!0),this.properties=d._getProperties(e.properties),this.extensions=d._getExtensions(e.extensions),this.setOpacity(this.configuredOpacity)},j.prototype._updateServiceToken=function(e){if(this.serviceToken=e,this.serviceLayer&&this.serviceLayer._url){var t=this.serviceLayer._url;if(t.query){t.query.token=e;var i=dojo.objectToQuery(t.query);this.serviceLayer.url=t.path+(i?"?"+i:"")}}this._updateCredentialForLayer(),dojo.publish("ServiceTokenRefreshed",{serviceUrl:this.serviceUrl,token:e})},j.prototype._addDefinitionExpression=function(e,t){if(!e)throw new Error("Expecting a layer");if((t=t||this.serviceLayer)instanceof esri.layers.ArcGISDynamicMapServiceLayer){var i=e.getDefinitionExpression(null);if(i){var r=parseInt(e.id,10),n=t.layerDefinitions||[];if(!r)throw new Error("Failed to add definition expression for "+e.displayName);n[r]=i,t.setLayerDefinitions(n)}}},j.prototype._removeDefinitionExpression=function(e,t){if(e&&(t=t||this.serviceLayer)&&t instanceof esri.layers.ArcGISDynamicMapServiceLayer){var i=parseInt(e.id,10);if(i&&t.layerDefinitions){var r=t.layerDefinitions;r[i]&&(r.splice(i,1),t.setLayerDefinitions(r))}}},j.prototype._createServiceLayer=function(){var i=this;if(null==this.serviceLayer){var e=this.serviceUrl;if(null!=this.serviceToken&&this.mapServiceType!==P.MapServiceType.VECTORTILE&&(e=k.RestHelperHTTPService.appendTokenToUrl(e,this.serviceToken)),"MapService"===this.drawingBehavior){var t;switch(this.mapServiceType){case P.MapServiceType.DYNAMIC:this._needsProxy&&(esri.config.defaults.io.alwaysUseProxy=!0);var r=new esri.layers.ArcGISDynamicMapServiceLayer(e,{id:this.id});this._applyAttributionUrl(r);var n=this.getVisibleLayers();0===n.length?r.setVisibleLayers&&(0===this.layers.length?r.setVisibleLayers(n,!1):r.setVisibleLayers(["-1"],!1)):r.setVisibleLayers&&r.setVisibleLayers(n,!1);for(var s=0,a=this.layers;s<a.length;s++){var o=a[s];this._addDefinitionExpression(o,r)}this.layerVisibilityEventManager=new F.LayerVisibilityEventManager(this,r),r.setImageFormat(this._getAgsDynamicImageFormat(this.imageFormat)),dojo.connect(r,"onError",this,this._layerLoadErrorHandler),dojo.connect(r,"onLoad",this,function(){this._handleServiceLayerLoaded(r),this._handleDynamicLayers(r)}),this._initiallyVisible?r.show():r.hide(),this.serviceLayer=r;break;case P.MapServiceType.TILED:var l=new esri.layers.ArcGISTiledMapServiceLayer(e,{id:this.id});this._applyAttributionUrl(l),dojo.connect(l,"onError",dojo.hitch(this,this._layerLoadErrorHandler)),dojo.connect(l,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded)),this._initiallyVisible?l.show():l.hide(),this.serviceLayer=l;break;case P.MapServiceType.IMAGE:var c=null;this._hasTileLevels()?c=new esri.layers.ArcGISTiledMapServiceLayer(e,{id:this.id}):(c=new esri.layers.ArcGISImageServiceLayer(e,{id:this.id})).setImageFormat(this._getAgsImageServiceImageFormat(this.imageFormat)),this._applyAttributionUrl(c),dojo.connect(c,"onError",this,this._layerLoadErrorHandler),dojo.connect(c,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded)),this._initiallyVisible?c.show():c.hide(),this.serviceLayer=c;break;case P.MapServiceType.BING:var u=new esri.virtualearth.VETiledLayer(this.bingProperties);dojo.connect(u,"onError",this,this._layerLoadErrorHandler),dojo.connect(u,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded)),this._initiallyVisible?u.show():u.hide(),this.serviceLayer=u;break;case P.MapServiceType.WMS:if(!dojo.isObject(esri.layers.WMSLayer))throw new Error("This Javascript application must require the esri.layers.wms package in order to use a site with a WMS service.");this._extendWms();for(var p,h=!1,d=0,f=this.layers;d<f.length;d++)if((o=f[d]).wmsLayerName){h=!0;break}if(h){if(t={extent:this.essentialsMap.initialExtent,layerInfos:this._constructWmsLayerInfos(),version:this.serverVersion},p=new esri.layers.WMSLayer(e,{resourceInfo:t,visibleLayers:this._getWmsVisibleLayers()}),null!=this.operationalSpatialReference){var y=parseInt(this.operationalSpatialReference.replace(/^.*:/,""),10);p.spatialReferences.push(y),p.preferredSpatialReference=y}dojo.connect(p,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded))}else p=new esri.layers.WMSLayer(e),dojo.connect(p,"onLoad",dojo.hitch(this,this._finishWmsLayerConfiguration));if(this._restStartTimeOverrideString&&this._restEndTimeOverrideString&&!p.timeInfo){var m=j.getGcxTimeInfo(null,this._restStartTimeOverrideString,this._restEndTimeOverrideString);if(m){var v={timeExtent:new esri.TimeExtent(m.timeExtent.startTime,m.timeExtent.endTime)};p.timeInfo=v}}p.id=this.id,this._applyAttributionUrl(p),this.layerVisibilityEventManager=new F.LayerVisibilityEventManager(this,p),p.setImageFormat(this._getEsriWmsImageFormat()),p.__gcxWmsImageFormat=this.imageFormat,p.__timeAwareMode=this.timeAwareMode,p.__timeZone=N.getTimeZoneFromMapService(this),p.__displayTimeZone=N.getDisplayTimeZoneFromMapService(this),dojo.connect(p,"onError",this,this._layerLoadErrorHandler),this._initiallyVisible?p.show():p.hide(),this.serviceLayer=p,this._corsRequest(this._prefixProxy(e)).then(function(){p.refresh()},function(e){p.refresh()});break;case P.MapServiceType.WMTS:if(!dojo.isObject(esri.layers.WMTSLayer))throw new Error("This JavaScript application must require the esri.layers.wmts package in order to use a site with WMTS service.");if(0===this.layers.length)throw new Error("You must include at least one layer in your WMTS. Service "+this.displayName+" has 0 layers.");var g=this.layers[0].fullExtent&&!this.essentialsMap.site.useSiteFullExtentForWMTSServices?this.layers[0].fullExtent:this.essentialsMap.fullExtent;this.tileInfo&&this.tileInfo.dpi&&96!==this.tileInfo.dpi&&this.tileInfo.lods.forEach(function(e){return e.scale=e.scale/i.tileInfo.dpi*96}),this.tileInfo.dpi=96;var _={900913:102100,3857:102100};if(this.tileInfo){var S=_[this.tileInfo.spatialReference.wkid];if(S){var L=new esri.SpatialReference(S);this.tileInfo.spatialReference=L,A.isNullOrUndefined(_[g.spatialReference.wkid])||(g.spatialReference=L)}}4326===this.tileInfo.spatialReference.wkid&&90<this.tileInfo.origin.y&&(this.tileInfo.origin=new esri.geometry.Point(this.tileInfo.origin.x,90,this.tileInfo.spatialReference));var b={tileInfo:this.tileInfo,fullExtent:g,initialExtent:g,identifier:0<this.layers.length?this.layers[0].name:null,tileMatrixSet:this.tileMatrixSet,format:this._getEsriOgcImageFormat(),style:this.layers[0].styleName?this.layers[0].styleName:""},T=new esri.layers.WMTSLayerInfo(b),E={serviceMode:"KVP",resourceInfo:t={version:this.serverVersion,layerInfos:[T],getTileUrl:this._prefixProxy(this.mapUrl)},layerInfo:T,id:this.id},I=new esri.layers.WMTSLayer(e,E);if(this._applyAttributionUrl(I),I._url){var x=0,w=U.hasProxy()?2:1;I._url=I._url.replace(/\?/g,function(e){return++x<=w?"?":""})}dojo.connect(I,"onError",this,this._layerLoadErrorHandler),dojo.connect(I,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded)),this._initiallyVisible?I.show():I.hide(),this.serviceLayer=I;break;case P.MapServiceType.WEBTILED:var M=e.replace(/([^$])({[^}]*})/g,function(e,t,i){return t+"$"+i}),R={copyright:this.copyright,id:this.id,subDomains:null,tileInfo:this._tileScheme?this.tileInfo:null};0<=M.indexOf("${subDomain}")&&(R.subDomains=this.subDomains);var O=new esri.layers.WebTiledLayer(M,R);O.id=this.id,this._applyAttributionUrl(O),this._initiallyVisible?O.show():O.hide(),dojo.connect(O,"onError",this,this._layerLoadErrorHandler),dojo.connect(O,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded)),this.serviceLayer=O;break;case P.MapServiceType.VECTORTILE:var D=e;this._styleUrl&&(D=this._styleUrl),C(["esri/layers/VectorTileLayer"],function(e){i._addCredentialForLayer();var t=new e(D);t.id=i.id,t.loadError&&i._layerLoadErrorHandler(t.loadError),dojo.aspect.before(t,"_frame",dojo.hitch(t,function(){this._frameRequested&&this.spatialReference&&this._viewState&&!this._viewState.spatialReference&&(this._viewState.spatialReference=this.spatialReference)})),i._initiallyVisible?t.show():t.hide(),dojo.connect(t,"onError",i,i._layerLoadErrorHandler),dojo.connect(t,"onLoad",dojo.hitch(i,i._handleServiceLayerLoaded)),i._applyAttributionUrl(t),i.serviceLayer=t})}this.initiateServiceFailureTimer()}}},j.prototype.initiateServiceFailureTimer=function(){var e=this;this.failureTimeout&&!isNaN(this.failureTimeout)&&setTimeout(function(){e.serviceLayer&&(!e.serviceLayer||e.serviceLayer.loaded)||e.initializationFailure||(e.failureTimeoutThresholdExceeded=!0,e.onFailureTimeoutThresholdExceeded())},1e3*this.failureTimeout)},j.prototype._addCredentialForLayer=function(){var e=esri.id,t=this.findServiceToken(),i=e.credentials;if(t&&e&&i instanceof Array){for(var r=0;r<i.length;r++)if(i[r].server===this.url){i.splice(r,1);break}var n=new esri.Credential;n.token=t,this._layerSecurityProxy?n.server=this.url:n.server=esri.id._getServerInstanceRoot(this.serviceUrl),n.resources=[this.serviceUrl],n.scope=esri.id._isServerRsrc(this.serviceUrl)?"server":"portal",this.url.startsWith("https")?n.ssl=!0:n.ssl=!1,i.push(n)}},j.prototype._updateCredentialForLayer=function(){var e=esri.id,t=this.findServiceToken(),i=e.credentials;if(t&&e&&i instanceof Array)for(var r=0,n=i;r<n.length;r++){var s=n[r];if(s.server===this.url){s.token=this.serviceToken;break}}},j.prototype._applyAttributionUrl=function(e){if(this.attributionDataUrl&&""!==this.attributionDataUrl)e.attributionDataUrl=this.attributionDataUrl,e.hasAttributionData=!0;else if(this.hasAttributionData){e.attributionDataUrl=this.url+"/attribution",e.hasAttributionData=!0;var t=k.RestHelperHTTPService.getTokenForScope(e.attributionDataUrl);t&&(e.attributionDataUrl=k.RestHelperHTTPService.appendTokenToUrl(e.attributionDataUrl,t))}},j.prototype._prefixProxy=function(e){return this.proxyUrl?this.proxyUrl+"?"+e:e},j.prototype._constructWmsLayerInfos=function(){for(var e=[],t=0,i=this.layers;t<i.length;t++){var r=i[t];if(null!=r.wmsLayerName){var n=new esri.layers.WMSLayerInfo({name:r.wmsLayerName,title:r.name});n.styleName=r.styleName,e.push(n)}}return e},j.prototype._getWmsVisibleLayers=function(){for(var e=[],t=0,i=this.layers;t<i.length;t++){var r=i[t];r.isVisible()&&r.areAllAncestorsVisible()&&null!=r.wmsLayerName&&0===r.subLayerIds.length&&e.push(r.wmsLayerName)}return e},j.prototype._applyWmsLayerVisibility=function(){var e=this._getWmsVisibleLayers();this.serviceLayer.setVisibleLayers(e)},j.prototype._getEsriWmsImageFormat=function(){var e=this._getEsriOgcImageFormat();return"jpeg"===e&&(e="jpg"),e},j.prototype._getEsriOgcImageFormat=function(){return null!=this.imageFormat?this.imageFormat.replace(/^image\//,""):null},j.prototype._findWMSLayerName=function(e,t){for(var i in e)if(e.hasOwnProperty(i)){var r=e[i];if(r.title===t)return r.name;if(null!==r.subLayers&&0<r.subLayers.length){var n=this._findWMSLayerName(r.subLayers,t);if(null!==n)return n}}return null},j.prototype._finishWmsLayerConfiguration=function(e){for(var t,i=[],r=0,n=0,s=this.layers;n<s.length;n++){var a=s[n];!a.configuredVisible||null!==a.subLayerIds&&0!==a.subLayerIds.length||(null!==a.parentLayerId?this.findLayerById(a.parentLayerId).configuredVisible&&(t=this._getWMSLayerNameFromTitle(a.name),null!==(a.wmsLayerName=t)&&""!==t&&(i[r]=t,r++)):(t=this._getWMSLayerNameFromTitle(a.name),null!==(a.wmsLayerName=t)&&""!==t&&(i[r]=t,r++)))}this.serviceLayer.setVisibleLayers(i),this._handleServiceLayerLoaded(e)},j.prototype._handleServiceLayerLoaded=function(e){this._configureTimeInfo(),this.isServiceLayerLoaded=!0,this.essentialsMap&&this.essentialsMap.site&&dojo.isFunction(this.essentialsMap.site.onLayerLoad)&&this.essentialsMap.site.onLayerLoad(e)},j.prototype.convertToDynamicLayers=function(){var e=this.serviceLayer;e&&e instanceof esri.layers.ArcGISDynamicMapServiceLayer&&(e.dynamicLayerInfos||e.setDynamicLayerInfos(this._createDynamicLayerInfos(e)),e.layerDrawingOptions||(e.layerDrawingOptions=[]))},j.prototype._layerLoadErrorHandler=function(e){e&&e.message&&0===e.message.indexOf("Unable to load tile")||(this.initializationFailure=e,this.essentialsMap&&this.essentialsMap.site&&dojo.isFunction(this.essentialsMap.site.onLayerLoadError)&&(this._layerLoadErrorHandler=this.essentialsMap.site.onLayerLoadError))},j.prototype.remove=function(e){if(!e)throw new Error("Expecting a layer.");var t=this.serviceLayer;if(!(e.isDynamic&&this.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer&&this.serviceLayer))throw new Error("MapService - remove() - Unsupported Layer Type.");this.convertToDynamicLayers();var i=parseInt(e.id,10),r=this.findLayerById(e.id);null!=r&&-1<(o=this.layers.indexOf(r))&&(r.setInActiveTheme(!1),this.layers.splice(o,1),dojo.publish("CatalogLayerRemovedEvent",r));var n=this.getVisibleLayers();if(null==i)throw new Error("Could not convert Layer ID '"+e.id+"' into an integer!");var s=[];t.dynamicLayerInfos&&(s=dojo.clone(this.serviceLayer.dynamicLayerInfos));var a=[];if(t.layerDrawingOptions&&(a=this.serviceLayer.layerDrawingOptions),e.isDynamic){for(var o,l=null,c=0,u=s;c<u.length;c++){var p=u[c];if(p.id===i){l=p;break}}l&&-1<(o=s.indexOf(l))&&(s.splice(o,1),t.setDynamicLayerInfos(s,!0));var h=[];for(var d in a)a.hasOwnProperty(d)&&d!==e.id&&(h[d]=dojo.clone(a[d]));this._removeDefinitionExpression(e,t),t.setLayerDrawingOptions(h)}-1<n.indexOf(e.id)&&n.splice(n.indexOf(e.id),1),this._syncLayerVisibilities(n)},j.prototype.add=function(e){if(!e)throw new Error("Expecting a layer");var t=this.serviceLayer;if(!(e.isDynamic&&t instanceof esri.layers.ArcGISDynamicMapServiceLayer))throw new Error("MapService - add() - Unsupported layer type..");this.convertToDynamicLayers();var i=this.getVisibleLayers();e.mapService=this;var r=[];t.dynamicLayerInfos&&(r=t.dynamicLayerInfos);var n=[];t.layerDrawingOptions&&(n=t.layerDrawingOptions);var s=void 0,a=void 0,o=parseInt(e.id,10);if(null==o)throw new Error("Could not convert Layer ID '"+e.id+"' into an integer!");(s=e._createDynamicLayerInfo()).name||(s.name=e.displayName),null!=s&&r.push(s),null!=(a=e.getLayerDrawingOptions())&&(n[o]=a),0<n.length&&t.setLayerDrawingOptions(n,!0),this._addDefinitionExpression(e,t),t.setDynamicLayerInfos(r),i.push(e.id),this._syncLayerVisibilities(i),this.layers.push(e),dojo.publish("CatalogLayerAddedEvent",e)},j.prototype.getDynamicLayerInfoById=function(e){var t=null;if(this.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer){var i=parseInt(e,10);if(!isNaN(i)){var r=this.serviceLayer.dynamicLayerInfos;if(r)for(var n=0,s=r;n<s.length;n++){var a=s[n];a.id===i&&(t=a)}}}return t},j.prototype._syncLayerVisibilities=function(e){for(var t=0,i=this.layers;t<i.length;t++){var r=i[t];-1<e.indexOf(r.id)?r.visibleStateForRefresh=n.RefreshVisibility.SHOW:r.visibleStateForRefresh=n.RefreshVisibility.HIDE}0===e.length&&e.push("-1"),this.serviceLayer.setVisibleLayers(e)},j.prototype._handleDynamicLayers=function(t){var i=this;if(this.supportsDynamicLayers){var e=dojo.some(this.layers,function(e){return null!=e.drawIndex}),r=dojo.some(this.layers,function(e){return e.canToggleLabels&&!e.showLabels}),n=this.essentialsMap.getMap();if(n&&(n.spatialReference&&(n.spatialReference.wkid&&!(n.spatialReference.wkid<=0)||n.spatialReference.wkt&&n.spatialReference.wkt.trim())||null!=t.spatialReference&&t.spatialReference.wkt&&t.spatialReference.wkt.trim()&&(n.spatialReference=t.spatialReference),n.extent&&(!n.extent.spatialReference||(!n.extent.spatialReference.wkid||n.extent.spatialReference.wkid<=0)&&(!n.extent.spatialReference.wkt||!n.extent.spatialReference.wkt.trim()))&&null!=t.spatialReference&&t.spatialReference.wkt&&t.spatialReference.wkt.trim())){var s=new esri.geometry.Extent(n.extent);s.spatialReference=t.spatialReference,this.essentialsMap.extentManager.setExtentWithPriority(s,2)}var a=this._createDynamicLayerInfos(t),o=[];if(t.layerDrawingOptions&&(o=dojo.mixin([],t.layerDrawingOptions)),r&&dojo.forEach(this.layers,function(e,t){if(e.canToggleLabels){var i=e.getLayerDrawingOptions();if(null==i){i=new esri.layers.LayerDrawingOptions;var r=parseInt(e.id,10);o[r]=i}i.showLabels=e.showLabels}}),dojo.forEach(this.layers,function(e,t){if(e.isDynamic){var i=void 0,r=void 0,n=parseInt(e.id,10);if(isNaN(n))throw new Error("Could not convert Layer ID '"+e.id+"' into an integer!");(i=e._createDynamicLayerInfo()).name||(i.name=e.name),i&&a.splice(t,0,i),(r=e.getLayerDrawingOptions())&&(o[n]=r,null!=e.showLabels&&(r.showLabels=e.showLabels))}}),e){var l=dojo.clone(a),c=[];dojo.forEach(this.layers,function(e,t){null!=e&&null!=e.drawIndex&&c.push(e)}),c.sort(function(e,t){return e.drawIndex-t.drawIndex}),dojo.forEach(c,function(e,t){for(var i=null,r=null,n=0;n<l.length;n++){var s=l[n];if(s.id.toString()==e.id){i=s,r=n;break}}null!=i&&null!=r&&(l.splice(r,1),l.push(i))}),a=[],dojo.forEach(l,function(e,t){a.push(e)})}setTimeout(function(){t.visibleLayers,0<o.length&&t.setLayerDrawingOptions(o,!0),0<a.length&&t.setDynamicLayerInfos(a,!0);var e=i.getVisibleLayers();e.InternallyChangedLayer={},0<e.length||e.push("-1"),t.setVisibleLayers(e)})}},j.prototype._createDynamicLayerInfos=function(e,t){A.isNullOrUndefined(t)&&(t=!0);var i=null;if(null!=e&&(i=e.createDynamicLayerInfosFromLayerInfos(),t))for(var r=i.length-1;0<=r;r--){var n=this.findLayerById(i[r].id.toString());null!=n&&!n.isDynamic||i.splice(r,1)}return i},j.prototype._getAgsDynamicImageFormat=function(e){if(null==e||e.length<1)return"png8";var t=e.toLowerCase();switch(t){case"png":case"png8":case"png24":case"png32":case"jpeg":case"jpg":case"gif":case"bmp":case"svg":case"svgz":case"emf":case"ps":case"pdf":return t;default:return"png8"}},j.prototype._getAgsImageServiceImageFormat=function(e){if(null==e||e.length<1)return null;var t=e.toLowerCase();switch(t){case"jpgpng":case"png":case"png8":case"png24":case"png32":case"jpeg":case"jpg":case"gif":case"bmp":case"tiff":return t;default:return null}},j.prototype._getVisibleGroupLayersOfType=function(e,t,i,r){if(t[e])for(var n=0,s=t.subLayerIds;n<s.length;n++){var a=s[n],o=this.findLayerById(a);o[e]&&(null!==o.subLayerIds&&0<o.subLayerIds.length?r=this._getVisibleGroupLayersOfType(e,o,i,r):dojo.indexOf(i,o.id)<0&&(i[r=this._addAnnotationSublayers(o,i,r)]=o.id,r++))}return r},j.prototype._getWMSLayerNameFromTitle=function(e){return this.serviceLayer instanceof esri.layers.WMSLayer?this._findWMSLayerName(this.serviceLayer.layerInfos,e):null},j.prototype._getPrincipalResult=function(e){if(this.essentialsMap&&this.essentialsMap.site&&this.essentialsMap.site.principal)return e(this.essentialsMap.site.principal)},j.prototype._processConnectionString=function(e,t){var i=y.ServiceHelper.extractConnectionStringValue;if(this.mapServiceType===P.MapServiceType.BING){this.bingProperties={};var r=void 0;(r=i(e,"mapStyle"))&&0<r.length&&(this.bingProperties.mapStyle=r),(r=i(e,"culture"))&&0<r.length&&(this.bingProperties.culture=r),(r=i(e,"key"))&&0<r.length&&(this.bingProperties.bingMapsKey=r)}else{var n=i(e,"url");if(0<n.length)this.serviceUrl=n.replace(/%3d/g,"=").replace(/%3D/g,"=").replace(/%3a/g,":").replace(/%3A/g,":");else if((this.mapServiceType===P.MapServiceType.DYNAMIC||this.mapServiceType===P.MapServiceType.TILED)&&3.912<=this.essentialsMap.site.getEssentialsVersion()||(this.mapServiceType===P.MapServiceType.FEATURE||this.mapServiceType===P.MapServiceType.IMAGE||this.mapServiceType===P.MapServiceType.STREAM||this.mapServiceType===P.MapServiceType.VECTORTILE)&&4.01<=this.essentialsMap.site.getEssentialsVersion()){if(this._layerSecurityProxy=!0,this.essentialsMap.site.getEssentialsVersion()<4.03)this.serviceUrl=this.url+"/MapServer";else{var s=this.essentialsMap.site.getEssentialsVersion()<4.05?"/GeoREST":"/rest/services/x";if(this.mapServiceType===P.MapServiceType.FEATURE){if(!(t&&t.layers&&0<t.layers.length&&t.layers[0]))throw new Error("Unable to configure FeatureLayer connection string. No child layer is specified.");this.serviceUrl=this.url+s+"/FeatureServer/"+t.layers[0].id}else this.mapServiceType===P.MapServiceType.IMAGE?this.serviceUrl=this.url+s+"/ImageServer":this.mapServiceType===P.MapServiceType.STREAM?this.serviceUrl=this.url+s+"/StreamServer":this.mapServiceType===P.MapServiceType.VECTORTILE?this.serviceUrl=this.url+s+"/VectorTileServer":this.serviceUrl=this.url+s+"/MapServer"}this._getPrincipalResult(function(e){return e.isAuthenticated})&&(this.serviceToken=this._getPrincipalResult(function(e){return e.tokens.site})),"3.912"===this.essentialsMap.site.currentVersion&&(this._needsProxy=!0)}var a=i(e,"geometryServiceUrl");0<a.length&&(this.geometryServiceUrl=a),this.mapServiceType===P.MapServiceType.VECTORTILE&&(this._styleUrl=i(e,"styleUrl")),this.mapServiceType===P.MapServiceType.WEBTILED&&(this._tileScheme=i(e,"tileScheme")),this.essentialsMap&&this.essentialsMap.site&&!this.serviceToken&&(this.serviceToken=this.essentialsMap.site.getTokenFromPrincipal(this.serviceUrl,this.mapServiceType));var o=i(e,"token"),l=this.essentialsMap&&this.essentialsMap.site?this.essentialsMap.site.arcGisPortalSecurityContext:null;0<o.length?this.serviceToken=o:l&&l.appliesTo(this.serviceUrl)&&l.tokenResult&&(this.serviceToken=l.tokenResult.token);var c=i(e,"proxy");0<c.length&&(this.proxyUrl=c,esri.addProxyRule({urlPrefix:this.serviceUrl,proxyUrl:c}),-1<this.serviceUrl.indexOf("services.arcgis")&&esri.addProxyRule({urlPrefix:this.serviceUrl.replace("services.arcgis","server.arcgis"),proxyUrl:c}));var u=i(e,"mapUrl");0<u.length&&(this.mapUrl=u.replace(/%3d/g,"=").replace(/%3D/g,"="));var p=i(e,"tileRestUrl");0<p.length&&(this.tileRestUrl=p.replace(/%3d/g,"=").replace(/%3D/g,"="));var h=i(e,"subDomains");h&&(this.subDomains=h.split(","))}},j.prototype._isLocalProxyInfo=function(e){return!!e&&"local-reverse-proxy"===e.type&&!!e.address},j.prototype._processProxyInfo=function(e){if(this._isLocalProxyInfo(e)){for(var t=(this.url+"/../../../../../"+e.address).split("/"),i=t.indexOf("..");0<i;i=t.indexOf(".."))t.splice(i-1,2);this.serviceUrl=t.join("/")}},j.prototype.supportsLayerVisibility=function(){switch(this.mapServiceType){case P.MapServiceType.WMS:return!0;case P.MapServiceType.DYNAMIC:return null!==this.serviceLayer&&!!this.serviceLayer.visibleLayers;case P.MapServiceType.GRAPHICS:case P.MapServiceType.FEATURE:case P.MapServiceType.CSV:case P.MapServiceType.LABEL:case P.MapServiceType.STREAM:case P.MapServiceType.GEORSS:case P.MapServiceType.KML:case P.MapServiceType.BING:case P.MapServiceType.TILED:case P.MapServiceType.WMTS:case P.MapServiceType.IMAGE:case P.MapServiceType.WEBTILED:case P.MapServiceType.VECTORTILE:case P.MapServiceType.MAPIMAGE:case P.MapServiceType.UNKNOWN:default:return!1}},j.prototype._setVisibility=function(e,t,i){var r,n,s,a={mapServiceId:this.id,layerId:e,visibility:t};switch(void 0===i&&(i=!1),this.mapServiceType){case P.MapServiceType.DYNAMIC:if(null!==this.serviceLayer){if(!this.serviceLayer.visibleLayers){t?this.serviceLayer.show():this.serviceLayer.hide(),dojo.publish("LayerVisibilityChange",[new Array(a)]);break}var o=this.getVisibleLayers();o.InternallyChangedLayer=a,0===o.length&&o.push("-1"),this.serviceLayer.setVisibleLayers&&this.serviceLayer.setVisibleLayers(o,i)}break;case P.MapServiceType.WMS:if(null!==this.serviceLayer){var l=[];for(l.InternallyChangedLayer=a,n=r=0;n<this.layers.length;n++)if((s=this.layers[n]).isVisible()&&(null===s.subLayerIds||0===s.subLayerIds.length)&&s.areAllAncestorsVisible()){var c=s.wmsLayerName;null!==c&&""!==c&&(l[r]=c,r++)}i?(this.serviceLayer.visibleLayers=l.slice(0),dojo.publish("LayerVisibilityChange",[new Array(a)])):this.serviceLayer.setVisibleLayers(l)}break;case P.MapServiceType.GRAPHICS:case P.MapServiceType.FEATURE:case P.MapServiceType.CSV:case P.MapServiceType.LABEL:case P.MapServiceType.STREAM:case P.MapServiceType.GEORSS:case P.MapServiceType.KML:case P.MapServiceType.BING:case P.MapServiceType.TILED:case P.MapServiceType.WMTS:case P.MapServiceType.IMAGE:case P.MapServiceType.WEBTILED:case P.MapServiceType.VECTORTILE:case P.MapServiceType.MAPIMAGE:case P.MapServiceType.WFS:if(null!==this.serviceLayer){if(1!==this.layers.length)throw new Error("Visibility of individual layers cannot be set for this Map Service: {0}".format(this.displayName));t?this.serviceLayer.show():this.serviceLayer.hide(),dojo.publish("LayerVisibilityChange",[new Array(a)])}break;default:throw new Error("Cannot set layer visibility. Unknown MapService type.")}},j.prototype._extendWms=function(){if(!j._wmsExtended){var r=esri.layers.WMSLayer._meta.hidden.getImageUrl,y=/.*images\/pixel.png$/;esri.layers.WMSLayer.extend({getImageUrl:function(e,t,i,d){var f=this;r.apply(this,[e,t,i,function(e){if(y.test(e))d(e);else{for(var t={},i=0;i<f.layerInfos.length;i++)t[f.layerInfos[i].name]=f.layerInfos[i].styleName;var r=[];for(i=0;i<f.visibleLayers.length;i++)r.push(t[f.visibleLayers[i]]);var n=r.join(","),s=e.substring(e.lastIndexOf("?")+1,e.length),a=dojo.queryToObject(s);if(a.STYLES=n,f.preferredSpatialReference&&(a[a.CRS?"CRS":"SRS"]="EPSG:"+f.preferredSpatialReference),f.__gcxWmsImageFormat&&(a.FORMAT=f.__gcxWmsImageFormat),f.__timeAwareMode&&f.__timeAwareMode!==P.TimeAwareMode.DISABLED){var o=f.getMap(),l=o&&o.timeExtent?o.timeExtent.startTime:f.timeInfo&&f.timeInfo.timeExtent&&f.timeInfo.timeExtent.startTime,c=o&&o.timeExtent?o.timeExtent.endTime:f.timeInfo&&f.timeInfo.timeExtent&&f.timeInfo.timeExtent.endTime;if(l&&c){var u=A.dateToISOStringNoMs(N.correctDatesToSubmitInDatabaseTime(l,f.__timeZone,f.__displayTimeZone)),p=A.dateToISOStringNoMs(N.correctDatesToSubmitInDatabaseTime(c,f.__timeZone,f.__displayTimeZone));f.__timeAwareMode===P.TimeAwareMode.RANGE&&(a.TIME=u+"/"+p),f.__timeAwareMode===P.TimeAwareMode.INSTANT&&(a.TIME=p)}}f.disableClientCaching&&(a.t=Date.now());var h=e.substring(0,e.lastIndexOf("?")+1)+dojo.objectToQuery(a);d(h)}}])},setDisableClientCaching:function(e){this.disableClientCaching=!!e}}),j._wmsExtended=!0}},j.prototype._hasTileLevels=function(){return!!this.tileInfo&&!!this.tileInfo.lods&&0<this.tileInfo.lods.length},j.prototype.applyCatalogLayersChange=function(e){var t=this,i=!1,r=[];if(this.id==e.mapServiceId){for(var n=0,s=e.entries;n<s.length;n++){var a=s[n],o=this.findLayerById(a.id);o||(o=new u.Layer(this.url+"/layers/"+a.id),a.visible=!0,o.createFromDefinition(a),o.isUserCreated=!0,o.includeInLayerList=!0,o.setInActiveTheme(!0)),r.push(o)}var l=this.layers.filter(function(e){return e.isUserCreated&&r.indexOf(e)<0}),c=r.filter(function(e){return t.layers.indexOf(e)<0});return l.forEach(function(e){t.remove(e),i=!0}),c.forEach(function(e){t.add(e),i=!0}),i?(dojo.publish("MapServiceLayersChangedWithResultEvent",{mapService:this,newItems:[].concat(c),oldItems:[].concat(l)}),dojo.publish("CatalogLayersChangedEvent",this),c):[]}},j.prototype.getLayerThemeSettings=function(e){for(var t=0,i=this.layerThemeSettings;t<i.length;t++){var r=i[t];if(r.theme===e||r.theme.id===e)return r}return null},j.prototype.getFeatureLayer=function(){var n,s=this;if(this._featureLayerPromise)return this._featureLayerPromise;if(this.serviceLayer instanceof esri.layers.FeatureLayer)n=this.serviceLayer;else{if(this.mapServiceType!==P.MapServiceType.IMAGE)return Promise.resolve(null);var e=this.serviceUrl;this.serviceToken&&(e=k.RestHelperHTTPService.appendTokenToUrl(e,this.serviceToken)),n=new esri.layers.FeatureLayer(e)}return n.loaded?this._featureLayerPromise=Promise.resolve(n):this._featureLayerPromise=new Promise(function(e,t){var i=n.on("load",function(){i.remove(),r.remove(),e(n)}),r=n.on("error",function(e){i.remove(),r.remove(),s._featureLayerPromise=null,t(e)})}),this._featureLayerPromise},j.prototype._resetUpdateTimer=function(){var e=this;A.isNullOrUndefined(this.updateInterval)||0===this.updateInterval?(window.clearInterval(this._updateIntervalId),this._updateIntervalId=null):(A.isNullOrUndefined(this._updateIntervalId)||window.clearInterval(this._updateIntervalId),this._updateIntervalId=setInterval(function(){e._onUpdateIntervalTick()},1e3*this.updateInterval))},j.prototype._onUpdateIntervalTick=function(){if(this.serviceLayer&&this.serviceLayer.refresh){var e=this;e.serviceLayer.setDisableClientCaching?(e.serviceLayer.setDisableClientCaching(!0),e.serviceLayer.refresh(),e.serviceLayer.setDisableClientCaching(e.disableClientCaching)):e.serviceLayer.refresh()}},j.prototype._addToFilteredView=function(e){e&&this._layerThemeLayerFilter(e)&&this.layersFilteredView.push(e)},j.prototype._layerThemeLayerFilter=function(e){return!e.mapService.essentialsMap.layerThemesInfo.layerThemesConfigured||e.inActiveTheme},j.prototype._getDefaultGeometryServiceUrl=function(){var e=this.essentialsMap?this.essentialsMap.site:null;return e&&e.geometryEndpoints&&0<e.geometryEndpoints.length?e.geometryEndpoints[0].geometryServiceUrl:null},j.prototype._getDefaultGeometryServiceToken=function(){var e=this.essentialsMap?this.essentialsMap.site:null;return e&&e.geometryEndpoints&&0<e.geometryEndpoints.length?e.geometryEndpoints[0].geometryServiceToken:null},j.prototype._corsRequest=function(r,n,s){var a=this;return new o.SimplePromise(function(t,i){try{C(["dojo/request"],function(e){return s=!!s,e(r,{headers:{"X-Requested-With":null},withCredentials:n=!!n}).response.then(function(e){return t()},function(e){return s?i(e):t(a._corsRequest(r,!n,!0))})})}catch(e){return console.log("Error in initializing WMS layer: "+e),i(e)}})},j._wmsExtended=!1,j);function j(e){var t=s.call(this,e)||this;return t.bingProperties=null,t.baseMapGroup=null,t.configuredOpacity=1,t.configuredVisible=!1,t.copyright=null,t.attributionDataUrl=null,t.hasAttributionData=!1,t.dataProvider=null,t.description=null,t.defaultDateFormat=null,t.defaultNumberFormat=null,t.disableClientCaching=!1,t.displayName=null,t.drawingBehavior=null,t.essentialsMap=null,t.extensions=[],t.failureAction=P.FailureAction.WARN,t.failureTimeout=null,t.failureTimeoutThresholdExceeded=!1,t.onFailureTimeoutThresholdExceeded=function(){},t.featureClustering=null,t.geometryServiceUrl=null,t.hasLayerCatalog=!1,t.iconUri=null,t.id=null,t.catalogId=null,t.originalUrl=null,t.imageFormat=null,t.initializationFailure=null,t.includeInLayerList=!0,t.isExpanded=!0,t.isServiceLayerLoaded=!1,t.isUserCreated=!1,t.userLayerType=null,t.layers=[],t.tables=[],t.layersFilteredView=[],t.mapServiceFunction=null,t.mapServiceType=null,t.mapUrl=null,t.maxScale=null,t.minScale=null,t.opacity=1,t.opacityFilter=1,t.operationalSpatialReference=null,t.inActiveTheme=!0,t.layerThemeSettings=[],t.layerHyperlinks=[],t.properties={},t.proxyUrl=null,t.requestEncoding=null,t.instantSearch=!1,t.serverVersion=null,t.serviceLayer=null,t.serviceToken=null,t.serviceUrl=null,t.shortDisplayName=null,t.subDomains=[],t.supportsDynamicLayers=!1,t.tileMatrixSet=null,t.tileInfo=null,t.tileRestUrl=null,t.isTimeAware=!1,t.timeInfo=null,t.timeZoneId=null,t.timeAwareMode=null,t.updateInterval=null,t.heatMap=null,t.identifiable=!1,t.includeMosaicDatasetValues=!1,t.includeCatalogItems=!1,t._needsProxy=!1,t.layerVisibilityEventManager=null,t._updateIntervalId=null,t._delayedRefreshToken=null,t._layerInfoPromises={},t._styleUrl=null,t._tileScheme=null,t._restStartTimeOverrideString=null,t._restEndTimeOverrideString=null,t._layerSecurityProxy=!1,t._featureLayerPromise=null,t._initiallyVisible=!1,t.originalUrl=e,t.url&&(t.url=i.UrlUtilities.simplify(e)),t.setInActiveTheme(!0),t}e.MapService=a})},"geocortex/essentials/MapServiceConstants":function(){define(["require","exports"],function(e,t){"use strict";var i,r,n,s,a,o;Object.defineProperty(t,"__esModule",{value:!0}),(i=t.MapServiceType||(t.MapServiceType={})).DYNAMIC="Dynamic",i.TILED="Tiled",i.IMAGE="Image",i.BING="Bing",i.FEATURE="Feature",i.WMS="WMS",i.WFS="WFS",i.WMTS="WMTS",i.GEORSS="GeoRss",i.WEBTILED="WebTiled",i.VECTORTILE="VectorTile",i.KML="Kml",i.GRAPHICS="Graphics",i.LABEL="Label",i.STREAM="Stream",i.CSV="Csv",i.MAPIMAGE="MapImage",i.UNKNOWN="Unknown",(r=t.MapServiceFunction||(t.MapServiceFunction={})).OPERATIONAL="Operational",r.BASE="Base",(n=t.DrawingBehavior||(t.DrawingBehavior={})).MAP_SERVICE="MapService",n.FEATURE_LAYER="FeatureLayer",n.WFS_LAYER="WfsService",n.GEORSS_LAYER="GeoRssLayer",n.KML_SERVICE="KmlService",n.STREAM_LAYER="StreamLayer",n.GeoRSS_LAYER=n.GEORSS_LAYER,(s=t.FailureAction||(t.FailureAction={})).IGNORE="Ignore",s.WARN="Warn",s.ERROR="Error",(a=t.UserLayerType||(t.UserLayerType={})).LAYER_ADDITION="LayerAddition",a.LAYER_CATALOG="LayerCatalog",a.UPLOAD="Upload",(o=t.TimeAwareMode||(t.TimeAwareMode={})).DISABLED="Disabled",o.INSTANT="Instant",o.RANGE="Range"})},"geocortex/essentials/NamedExtent":function(){var r,o=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)});define(["require","exports","./AsyncInitializable","./../geocortex"],function(e,t,i,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n,s=(n=i.AsyncInitializable,o(a,n),a.prototype.navigateTo=function(){if(this.site){var e=this.site.essentialsMap;e&&e.extentManager.setExtentWithPriority(this.extent,10)}},a.prototype._configureObject=function(e,t){if(void 0===e||void 0===e.id||null==e.displayName||void 0===e.extent)throw new Error("Incorrect named extent object returned from initialization");this.id=e.id,this.displayName=e.displayName,this.extent=new esri.geometry.Extent(e.extent),this.properties=r._getProperties(e.properties),this.extensions=r._getExtensions(e.extensions)},a);function a(e){var t=n.call(this,e)||this;return t.displayName=null,t.extensions=[],t.extent=null,t.id=null,t.properties={},t.site=null,t}t.NamedExtent=s})},"geocortex/essentials/OAuth2Client":function(){define(["require","exports","./TokenResult","./utilities/DecomposedUri"],function(e,t,s,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=(a.getTokenFromImplicitGrant=function(){var e=window.location.href;if(0<e.indexOf("#")){var t=e.substring(e.indexOf("#")+1,e.length),i=dojo.queryToObject(t);if(!i.access_token)return null;var r=new s.TokenResult;r.token=i.access_token,r.userName=i.username;var n=parseInt(i.expires_in,10);return n&&(r.expiresOn=new Date((new Date).getTime()+1e3*n)),r}return null},a.getErrorFromImplicitGrant=function(){var e=window.location.href;if(0<e.indexOf("#")){var t=e.substring(e.indexOf("#")+1,e.length),i=dojo.queryToObject(t);if(i.error){var r=new o;return r.code=i.error,r.description=i.error_description,r}}return null},a.applicationHasImplicitGrant=function(){return a.hasFragmentParameter("access_token")},a.applicationHasImplicitGrantError=function(){return a.hasFragmentParameter("error")},a.hasFragmentParameter=function(e){var t=window.location.href;if(t.indexOf("#")<0)return!1;var i=t.substring(t.indexOf("#")+1,t.length);return!!dojo.queryToObject(i)[e]},a.redirectToLogOnPage=function(e,t){var i=new n.DecomposedUri(window.location.href);a.removeImplicitGrantParams(i);var r=e+"?client_id="+encodeURIComponent(t)+"&response_type=token&redirect_uri="+encodeURIComponent(i.recompose())+"&expiration=20160";window.location.href=r},a.removeImplicitGrantParamsAndUpdateUrlHash=function(){var e=new n.DecomposedUri(window.location.href);a.removeImplicitGrantParams(e),window.location.hash=dojo.objectToQuery(e.fragment)},a.removeImplicitGrantParams=function(e){return delete e.fragment.access_token,delete e.fragment.username,delete e.fragment.expires_in,delete e.fragment.error,delete e.fragment.error_description,e},a);function a(){}t.OAuth2Client=i;var o=(r.ACCESS_DENIED_ERROR_CODE="access_denied",r);function r(){}t.OAuth2Error=o})},"geocortex/essentials/OfflineBasemap":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/Principal":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/PrintTemplate":function(){var r,u=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)});define(["require","exports","./AsyncInitializable","./Report","./exportMap/ExportMapParameters","./exportMap/ExportMapTask","./../geocortex"],function(e,t,i,s,a,o,l){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r,n=(r=i.AsyncInitializable,u(c,r),c.prototype.isPrinting=function(){return this._printing},c.prototype.print=function(e,t,i){var r=this;if(this.isPrinting())i&&i(new Error("Template already printing"));else{this._onPrintComplete=t,this._onPrintError=i,this._printing=!0;var n=new a.ExportMapParameters;n.reportParameters=e,new o.ExportMapTask(this).generateMapImageUrl(n).then(function(e){return r._printRestComplete(e)},function(e){return r._printRestError(e)})}},c.prototype._configureObject=function(e,t){if(void 0===e||void 0===e.id||void 0===e.displayName)throw new Error("Incorrect print template object returned from initialization");if(this.description=void 0===e.description?this.description:e.description,this.displayName=e.displayName,this.id=e.id,this.visible=void 0===e.visible||e.visible,this.reportUrl=e.reportUrl,this.type=e.type?e.type:s.ReportType.MAP_TEMPLATE_REPORT,this.mainMapWidth=e.mainMapWidth,this.mainMapHeight=e.mainMapHeight,this.maximumResolution=void 0===e.maximumResolution?this.maximumResolution:e.maximumResolution,this.supportedMapScales=void 0===e.supportedScales?this.supportedMapScales:e.supportedScales,this.supportedOutputFormats=void 0===e.supportedOutputFormats?this.supportedOutputFormats:e.supportedOutputFormats,this.supportedResolutions=void 0===e.supportedResolutions?this.supportedResolutions:e.supportedResolutions,this.supportsEmailNotification=!!e.supportsEmailNotification,this.textFields=void 0===e.textFields?this.textFields:e.textFields,this.grids=void 0===e.grids?this.grids:e.grids,t&&(this.isInitialized=!0),this.properties=l._getProperties(e.properties),this.extensions=l._getExtensions(e.extensions),this.isDefault=void 0===e.isDefault?this.isDefault:e.isDefault,this.defaultMapScaleName=void 0===e.defaultMapScale?null:e.defaultMapScale,this.defaultMapScaleName)for(var i=0;i<this.supportedMapScales.length;i++)this.defaultMapScaleName===this.supportedMapScales[i].displayName&&(this.defaultMapScale=this.supportedMapScales[i]);var r=void 0===e.defaultResolution?null:e.defaultResolution;if(r)for(i=0;i<this.supportedResolutions.length;i++)r===this.supportedResolutions[i].displayName&&(this.defaultResolution=this.supportedResolutions[i]);var n=void 0===e.defaultGrid?null:e.defaultGrid;if(n)for(i=0;i<this.grids.length;i++)n===this.grids[i].displayName&&(this.defaultGrid=this.grids[i]);this.defaultOutputFormat=void 0===e.defaultOutputFormat?this.defaultOutputFormat:e.defaultOutputFormat},c.prototype._printRestComplete=function(e){this._printing=!1;var t=null;e?e.error&&(t=e.error):t=new Error("Unexpected Error"),t?this._onPrintError&&this._onPrintError(t):this._onPrintComplete&&this._onPrintComplete(e)},c.prototype._printRestError=function(e){this._printing=!1,this._onPrintError&&this._onPrintError(e)},c);function c(e){var t=r.call(this,e)||this;return t.description=null,t.displayName=null,t.extensions=[],t.id=null,t.visible=null,t.maximumResolution=300,t.properties=null,t.reportUrl=null,t.site=null,t.supportedMapScales=[],t.supportedOutputFormats=[],t.supportedResolutions=[],t.supportsEmailNotification=!1,t.textFields=[],t.grids=[],t.type=null,t.isDefault=!1,t.defaultMapScale=null,t.defaultMapScaleName=null,t.defaultResolution=null,t.defaultGrid=null,t.defaultOutputFormat=null,t._printing=!1,t._onPrintComplete=null,t._onPrintError=null,t.extensions=[],t.properties=[],t.supportedMapScales=[],t.supportedOutputFormats=[],t.supportedResolutions=[],t.textFields=[],t}t.PrintTemplate=n})},"geocortex/essentials/RefreshVisibility":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=(r.DEFAULT="Default",r.SHOW="Show",r.HIDE="Hide",r);function r(){}t.RefreshVisibility=i})},"geocortex/essentials/Report":function(){var r,p=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)});define(["require","exports","./AsyncInitializable","./exportMap/ExportMapTask","./exportMap/ExportMapParameters","./RestHelper","./../geocortex"],function(e,t,i,l,c,u,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n,s,a=(n=i.AsyncInitializable,p(o,n),o.prototype.isRunning=function(){return this._running},o.prototype.run=function(e,t,i,r){var n=this;if(this.isRunning()){if(r){var s=new Error("Report already running");s.name="ReportAlreadyRunning",r(s)}}else{this._running=!0;try{this._onRunReportComplete=i,this._onRunReportError=r;var a=new l.ExportMapTask(this),o=new c.ExportMapParameters;o.reportParameters=t,e&&(o.queryParameters=u.RestHelper._createRestParametersFromQuery(e)),a.generateMapImageUrl(o).then(function(e){return n._runRestComplete(e)},function(e){return n._runRestError(e)})}catch(s){if(this._running=!1,!this._onRunReportError)throw s;this._onRunReportError(s)}}},o.prototype._configureObject=function(e,t){if(void 0===e.id||void 0===e.displayName)throw new Error("Incorrect report object returned from initialization");this.id=e.id,this.visible=void 0===e.visible||e.visible,this.reportUrl=e.reportUrl,this.supportedOutputFormats=e.supportedOutputFormats,this.supportedResolutions=e.supportedResolutions,this.supportedMapScales=e.supportedScales,this.textFields=e.textFields,this.type=e.type,this.description=e.description,this.displayName=e.displayName,t&&(this.isInitialized=!0),this.properties=r._getProperties(e.properties),this.extensions=r._getExtensions(e.extensions)},o.prototype._runRestComplete=function(e){this._running=!1;var t=null;e?e.error&&(t=e.error):t=new Error("No results"),t&&this._onRunReportError&&this._onRunReportError(t),e&&this._onRunReportComplete&&this._onRunReportComplete(e)},o.prototype._runRestError=function(e){this._running=!1,this._onRunReportError&&this._onRunReportError(e)},o);function o(e){var t=n.call(this,e)||this;return t.description=null,t.displayName=null,t.extensions=[],t.id=null,t.visible=!1,t.layer=null,t.properties={},t.reportUrl=null,t.type=null,t.supportedMapScales=[],t.supportedOutputFormats=[],t.supportedResolutions=[],t.textFields=[],t._running=!1,t._onRunReportComplete=null,t._onRunReportError=null,t}t.Report=a,(s=t.ReportType||(t.ReportType={})).LAYER_TEMPLATE_REPORT="Layer Template Report",s.LAYER_URL_REPORT="Layer URL Report",s.MAP_TEMPLATE_REPORT="Map Template Report",s.MAP_URL_REPORT="Map URL Report"})},"geocortex/essentials/ReportParameters":function(){define(["require","exports","./MapServiceConstants","./utilities/PrintUtilities"],function(e,t,P,c){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=(F.prototype.toJson=function(e,t){if(!e||!t)throw new Error("Reporting parameter creation is missing a main map.");var i,r,n,s={},a=this.scale&&null!=this.scale.scale&&!isNaN(parseFloat(this.scale.scale))?parseFloat(this.scale.scale):e.getScale();this.scale&&null!=this.scale.scale&&(s.scale=this.scale.scale),this.extentType==F.CURRENT_EXTENT&&null!==e?i=e.extent:this.extentType==F.FULL_EXTENT&&null!==t?i=t.fullExtent:this.extentType==F.INITIAL_EXTENT&&null!==t?i=t.initialExtent:this.extentType==F.CUSTOM_EXTENT&&null!==this.customExtent&&(i=this.customExtent),i&&(i.spatialReference&&(r=i.spatialReference.toJson())&&(r.wkid&&0<r.wkid?s.bboxSR=r.wkid:r.wkt&&(s.bboxSR=r.wkt)),s.bbox=i.xmin+","+i.ymin+","+i.xmax+","+i.ymax),this.targetSpatialReference&&(r=this.targetSpatialReference.toJson())&&(r.wkid&&0<r.wkid?s.targetSR=r.wkid:r.wkt&&(s.targetSR=r.wkt)),this.notificationEmailAddress&&(s.emailAddress=this.notificationEmailAddress),this.imageHeight&&0<this.imageHeight&&(s.imageHeight=this.imageHeight),this.imageWidth&&0<this.imageWidth&&(s.imageWidth=this.imageWidth),e.timeExtent&&(s.time="",e.timeExtent.startTime?s.time+=e.timeExtent.startTime.getTime():s.time+="null",s.time+=",",e.timeExtent.endTime?s.time+=e.timeExtent.endTime.getTime():s.time+="null");var o=[];if(null!==t){var l="",c="",u="";for(n=0;n<t.mapServices.length;n++){var p,h=t.mapServices[n],d="",f=h.serviceLayer,y="";if(f)if(!0===f.visible&&(c+=(""===c?"":";")+h.id+":"+f.opacity),h.mapServiceType===P.MapServiceType.DYNAMIC){p=f.layerDefinitions;var m=0;for(var v in p)0<m&&(y+=","),y+='"'+v+'":"'+p[v].replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"',m++;if(0<m&&(1<u.length&&(u+=","),u+='"'+h.id+'":{',u+=y,u+="}"),!0===f.visible&&!0===f.isVisibleAtScale(a))if(f instanceof esri.layers.ArcGISDynamicMapServiceLayer){var g=f;g.visibleLayers&&"-1"!==g.visibleLayers.toString()&&(d=g.visibleLayers.toString())}else if(h.layers&&0!==h.layers.length){if(h.layers&&0<h.layers.length)for(var _=0;_<h.layers.length;_++)(S=h.layers[_]).isVisible()&&S.areAllAncestorsVisible()&&(d+=(0===d.length?"":",")+S.id)}else d="*"}else if(!0===f.visible&&!0===f.isVisibleAtScale(a))if(h.layers&&0!==h.layers.length){if(h.layers&&0<h.layers.length)for(_=0;_<h.layers.length;_++){var S;(S=h.layers[_]).isVisible()&&S.areAllAncestorsVisible()&&(d+=(0===d.length?"":",")+S.id)}}else d="*";var L=h.id;if(0===d.length?L+="(hide:*)":L+="(show:"+d+")",l+=(0===l.length?"":";")+L,h.hasOwnProperty("onDemandCacheSize")){var b={};b.id=h.id;var T=f.getSelectionSymbol();if(T&&T.color){var E=T.color.toRgba();b.selectionColor={r:E[0],g:E[1],b:E[2],a:E[3]}}b.mode=h.queryMode;var I=f.getDefinitionExpression();I&&(b.where=I),f.renderer&&(b.renderer=f.renderer.toJson()),b.selectedFeatures=[];var x=f.getSelectedFeatures();if(x&&0<x.length){var w=f.objectIdField;if(w)for(var M=0;M<x.length;M++){var R=x[M];if(R.attributes){var O=R.attributes[w];O&&b.selectedFeatures.push(O)}}}o.push(b)}}0<u.length&&(u="{"+u+"}",s.layerDefinitions=u),0<l.length&&(s.layers=l),0<c.length&&(s.opacity=c)}0<o.length&&(s.featureLayerOptions=o),this.outputFormat&&(s.outputFormat=this.outputFormat),this.featureIds&&(s.featureIds=this.featureIds),this.resolution&&(s.dpi=this.resolution.dpi),this.mapGraphicsLayers&&(s.graphics=this.mapGraphicsLayers.layers,s.symbols=this.mapGraphicsLayers.symbols),this.includeData&&(s.of=s.of?s.of+",includeData":"includeData"),this.includeGeoreferenceData&&(s.georef=this.includeGeoreferenceData),this.useTransparentBackground&&(s.useTransparentBackground=this.useTransparentBackground);for(var D=0;D<this.fields.length;D++){var C=this.fields[D];s[C.id]=C.value}return this.grid&&(s.grid=this.grid.id),s},F.prototype.populateMapGraphicsLayers=function(e){this.mapGraphicsLayers={layers:[],symbols:[]},this._extractGraphicInformation(e.graphics,this.mapGraphicsLayers.layers,this.mapGraphicsLayers.symbols);for(var t=0;t<e.graphicsLayerIds.length;t++){var i=e.getLayer(e.graphicsLayerIds[t]);!i.visible||i instanceof esri.layers.FeatureLayer&&i.url||this._extractGraphicInformation(i,this.mapGraphicsLayers.layers,this.mapGraphicsLayers.symbols)}},F.prototype._extractGraphicInformation=function(e,t,i){for(var r=0;r<e.graphics.length;r++){var n=e.graphics[r];if(n.visible){var s={},a=null;if(n.symbol?a=n.symbol:e.renderer&&e.renderer.getSymbol&&(a=e.renderer.getSymbol(n),n.symbol=a),!a)continue;i.push(a);for(var o=0;o<i.length-1;o++)if(i[o]==a){s.symbolID=i[o].id,a.id=s.symbolID,i.pop();break}if(null==s.symbolID){var l=i.length-1;i[l]instanceof esri.symbol.TextSymbol?i[l]=c.PrintUtilities.adjustTextSymbol(n,e.id):i[l]instanceof esri.symbol.PictureMarkerSymbol&&(i[l]=c.PrintUtilities.adjustPictureMarkerSymbol(n)),s.symbolID=(i.length-1).toString(),i[s.symbolID].id=s.symbolID}s.geometry=n.geometry,t.push({elements:[s],opacity:e.opacity})}}},F.CURRENT_EXTENT="currentExtent",F.CUSTOM_EXTENT="customExtent",F.FULL_EXTENT="fullExtent",F.INITIAL_EXTENT="initialExtent",F);function F(){this.customExtent=null,this.extentType="currentExtent",this.fields=[],this.grid=null,this.imageHeight=null,this.imageWidth=null,this.notificationEmailAddress=null,this.outputFormat=null,this.featureIds=null,this.resolution=null,this.scale=null}t.ReportParameters=i})},"geocortex/essentials/Resolution":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});function i(e,t){void 0!==e&&(this.displayName=e),void 0!==t&&(this.dpi=t)}t.Resolution=i})},"geocortex/essentials/RestEndpointResult":function(){define(["require","exports","./../geocortex"],function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});function r(e,t){this.error=t,(this.resultObject=e)&&(this.rawJson=i.encodeJson(e))}t.RestEndpointResult=r})},"geocortex/essentials/RestHelper":function(){define(["require","exports","./RestHelperHTTPService"],function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=(l.processClientSideTokens=function(e,t){var i="";if(""!==t){var r="";e&&e.url&&(r=e.url),i=l._replaceToken("SiteRestUrl",t,r),i=l._replaceToken("VirtualDirectoryUrl",i,r+"/virtualdirectory");var n=window.location.href.substring(0,window.location.href.lastIndexOf("/"));i=l._replaceToken("HostUri",i,n);var s=r.substring(0,r.lastIndexOf("/sites/"));i=l._replaceToken("RestVirtualDirectoryUrl",i,s+"/virtualdirectory");var a=o.RestHelperHTTPService.token;i=l._replaceToken("RestToken",i,a)}return i},l.validateDynamicDefinition=function(e){if(!e||!e.trim())throw new Error("The JSON string cannot be null, empty nor merely whitespace!");var t=l.getJsonObjectFromJsonString(e);if(t){if(null==t.source)throw"The source is required!";if(null==t.source.type)throw"The type is required!";if("mapLayer"==t.source.type){if(null==t.source.mapLayerId)throw"The mapLayerId is required for the mapLayer type!"}else{if("dataLayer"!=t.source.type)throw"The type '"+t.source.type.toString()+"' is not supported!";if(null==t.source.dataSource)throw"The dataSource is required for the dataLayer type!"}}},l.getJsonObjectFromJsonString=function(e){return JSON.parse(e)},l.getLayerSourceFromJsonObject=function(e){if("mapLayer"==e.type)return new esri.layers.LayerMapSource(e);var t=new esri.layers.LayerDataSource;switch(e.dataSource.type){case"table":t.dataSource=new esri.layers.TableDataSource(e.dataSource);break;case"queryTable":t.dataSource=new esri.layers.QueryDataSource(e.dataSource);break;case"raster":t.dataSource=new esri.layers.RasterDataSource(e.dataSource);break;case"joinTable":t.dataSource=new esri.layers.JoinDataSource(e.dataSource);break;default:throw"The type '"+e.type.toString()+"' not supported!"}return t},l.getDynamicLayerInfoFromJson=function(e,t){var i;l.validateDynamicDefinition(e);var r=l.getJsonObjectFromJsonString(e);if(r){if(i=new esri.layers.DynamicLayerInfo,r.id)i.id=r.id;else{if(null==t)throw"The Layer's ID is missing or invalid!";i.id=parseInt(t,10)}i.source=this.getLayerSourceFromJsonObject(r.source),null!=r.minScale&&(i.minScale=r.minScale),i.minScale<=0&&(i.minScale=1/0),null!=r.maxScale&&(i.maxScale=r.maxScale)}return i},l.getDynamicExpressionFromJson=function(e){var t;l.validateDynamicDefinition(e);var i=l.getJsonObjectFromJsonString(e);return i&&i.definitionExpression&&(t=i.definitionExpression),t},l.getLayerDrawingOptionsFromJson=function(e){var t;l.validateDynamicDefinition(e);var i,r=l.getJsonObjectFromJsonString(e);if(r&&r.drawingInfo){switch(i=dojo.clone(r.drawingInfo),t=new esri.layers.LayerDrawingOptions,i.renderer.type){case"simple":t.renderer=new esri.renderer.SimpleRenderer(i.renderer);break;case"uniqueValue":t.renderer=new esri.renderer.UniqueValueRenderer(i.renderer);break;case"classBreaks":t.renderer=new esri.renderer.ClassBreaksRenderer(i.renderer);break;default:throw"The type '"+i.renderer.type.toString()+"' not supported!"}if(i.labelingInfo&&i.labelingInfo instanceof Array){var n=i.labelingInfo;void 0===i.showLabels&&(i.showLabels=!0);for(var s=0;s<n.length;s++){var a=new esri.layers.LabelClass(n[s]);t.labelingInfo||(t.labelingInfo=[]),t.labelingInfo.push(a)}}t.transparency=i.transparency,t.scaleSymbols=i.scaleSymbols,t.showLabels=i.showLabels}return t},l._replaceToken=function(e,t,i){return t?t.replace("{"+e+"}",i):t},l._createRestParametersFromQuery=function(e){var t={};return e&&((t=e.toJson()).spatialRel=l._convertSpatialRelationshipToDotnet(t.spatialRel)),t},l._convertSpatialRelationshipToDotnet=function(e){switch(e){case esri.tasks.Query.SPATIAL_REL_CONTAINS:return"esriSpatialRelContains";case esri.tasks.Query.SPATIAL_REL_CROSSES:return"esriSpatialRelCrosses";case esri.tasks.Query.SPATIAL_REL_ENVELOPEINTERSECTS:return"esriSpatialRelEnvelopeIntersects";case esri.tasks.Query.SPATIAL_REL_INDEXINTERSECTS:return"esriSpatialRelIndexIntersects";case esri.tasks.Query.SPATIAL_REL_INTERSECTS:return"esriSpatialRelIntersects";case esri.tasks.Query.SPATIAL_REL_OVERLAPS:return"esriSpatialRelOverlaps";case esri.tasks.Query.SPATIAL_REL_RELATION:return"esriSpatialRelRelation";case esri.tasks.Query.SPATIAL_REL_TOUCHES:return"esriSpatialRelTouches";case esri.tasks.Query.SPATIAL_REL_WITHIN:return"esriSpatialRelWithin"}throw new Error("Unknown rel: "+e)},l._convertSpatialRelationshipFromDotnetIndex=function(e){switch(e){case 1:return esri.tasks.Query.SPATIAL_REL_CONTAINS;case 2:return esri.tasks.Query.SPATIAL_REL_CROSSES;case 3:return esri.tasks.Query.SPATIAL_REL_ENVELOPEINTERSECTS;case 4:return esri.tasks.Query.SPATIAL_REL_INDEXINTERSECTS;case 0:return esri.tasks.Query.SPATIAL_REL_INTERSECTS;case 5:return esri.tasks.Query.SPATIAL_REL_OVERLAPS;case 8:return esri.tasks.Query.SPATIAL_REL_RELATION;case 6:return esri.tasks.Query.SPATIAL_REL_TOUCHES;case 7:return esri.tasks.Query.SPATIAL_REL_WITHIN}throw new Error("Unknown rel: "+e)},l.tokenDurationMinutes=20,l);function l(){}t.RestHelper=i})},"geocortex/essentials/RestHelperHTTPService":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=(r.getTokenForScope=function(e){var t=this._anchorScratch||(this._anchorScratch=document.createElement("a")),i=this._pathCleaner||(this._pathCleaner=/\/+/g);t.href=e;var r=t.hostname.toLowerCase(),n=("/"+t.pathname+"/").replace(i,"/").toLowerCase(),s=void 0,a=this.tokenScopes;for(var o in a){t.href=o;var l=t.hostname.toLowerCase(),c=("/"+t.pathname+"/").replace(i,"/").toLowerCase();if(r===l&&n.startsWith(c)){var u=a[o];s="string"==typeof u?u:!0===u?this.token:void 0}}return s},r.setDefaultToken=function(e,t){"string"==typeof e&&(this.token=e,this.tokenScopes[t]=!0)},r.appendTokenToUrl=function(e,t){var i=e;return e&&!r.urlHasToken(e)&&(i=r._appendParameter(e,"token",t)),i},r.urlHasToken=function(e){return/[?&]token=/.test(e)},r.getAuthenticationControlBlockStore=function(){return console.warn("RestHelperHTTPService.getAuthenticationControlBlockStore() is no longer supported."),null},r.prototype._handleProxy=function(e,t){!1===this._isUnauthorizedResponse(e)&&dojo.isFunction(this._handle)&&(console.log("Invoking original handle delegate"),this._handle(e,t))},r.prototype._requestCallback=function(e){this._deferred.resolve(e)},r.prototype._requestErrback=function(e){dojo.isFunction(this._error)&&this._error(e),this._deferred.reject(e)},r.prototype._isUnauthorizedResponse=function(e){return!(!e||401!==e.code)},r.prototype.send=function(){var e=r.getTokenForScope(this.requestObject.url);return void 0!==e&&(this.requestObject.content||(this.requestObject.content={}),this.requestObject.content.token=e),esri.request(this.requestObject,this.optionsObject).then(dojo.hitch(this,this._requestCallback),dojo.hitch(this,this._requestErrback)),this._deferred.promise},r._appendParameter=function(e,t,i){var r=e;return e&&t&&i&&(0<=e.indexOf("?")?r+="&":r+="?",r+=encodeURIComponent(t)+"="+encodeURIComponent(i)),r},r.tokenScopes={},r);function r(e,t){this.requestObject=null,this.optionsObject=null,this._handle=null,this._error=null,this._deferred=new dojo.Deferred,void 0!==e&&(this.requestObject=e,dojo.isFunction(this.requestObject.error)&&(this._error=this.requestObject.error,this.requestObject.error=null),dojo.isFunction(this.requestObject.handle)&&(this._handle=this.requestObject.handle),this.requestObject.handle=dojo.hitch(this,this._handleProxy)),void 0!==t&&(this.optionsObject=t)}t.RestHelperHTTPService=i})},"geocortex/essentials/RestUtility":function(){define(["require","exports","./RestEndpointResult","./../geocortex"],function(e,t,i,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=(n.prototype.getCustomRestEndpoint=function(e,t,i,r,n){this._activeEndpointRequest?this._onEndpointRequestError(new Error("An operation is already in progress.")):(this._activeEndpointRequest=!0,this._onRequestComplete=i,this._onRequestError=r,s.request({url:e,content:t,load:dojo.hitch(this,this._onEndpointRequestComplete),error:dojo.hitch(this,this._onEndpointRequestError),callbackParamName:"CallBack"},n))},n.prototype._onEndpointRequestComplete=function(e){this._activeEndpointRequest=!1;try{(e=e||{error:new Error("Expected results")}).error&&this._onRequestError&&this._onRequestError(e.error)}finally{this._onRequestComplete&&this._onRequestComplete(new i.RestEndpointResult(e,e.error))}},n.prototype._onEndpointRequestError=function(e){this._activeEndpointRequest=!1;try{this._onRequestError&&this._onRequestError(e)}finally{this._onRequestComplete&&this._onRequestComplete(new i.RestEndpointResult(null,e))}},n);function n(){this._activeEndpointRequest=!1,this._onRequestComplete=null,this._onRequestError=null}t.RestUtility=r})},"geocortex/essentials/Rx.light":function(){define(["require","exports"],function(e,t){"use strict";function n(){}Object.defineProperty(t,"__esModule",{value:!0});var i=(r.prototype.select=function(n){var s=this,e=new r;return e._subscribe=function(t){var i=!0,e={onNext:function(e){if(i)try{t.onNext(n(e))}catch(e){i=!1,t.onError(e)}},onError:function(e){i&&(i=!1,t.onError(e))},onCompleted:function(){i&&(i=!1,t.onCompleted())}},r=s._subscribe(e);return i?r:(r.dispose(),{dispose:function(){}})},e},r.prototype._subscribe=function(e){return{dispose:n}},r.prototype.subscribe=function(t,e,i){if(1<arguments.length){var r={onNext:t||n,onError:e||n,onCompleted:i||n};return this._subscribe(r)}return t instanceof Function?(r=1<t.length?{onNext:function(e){return t(e)},onError:function(e){return t(void 0,e)},onCompleted:function(){return t()}}:{onNext:t,onError:e||n,onCompleted:i||n},this._subscribe(r)):t?this._subscribe(t):this._subscribe({onNext:n,onError:n,onCompleted:n})},r);function r(){}t.AnonymousObservable=i})},"geocortex/essentials/Scale":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});function i(e,t){this.displayName=e,this.scale=t}t.Scale=i})},"geocortex/essentials/SearchQuery":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=(r.prototype.toJson=function(e,t){if(!e||!t)throw new Error("Search query parameter creation is missing a main map.");var i={searchText:this.searchText,contains:this.contains,returnGeometry:this.returnGeometry,returnHighlights:this.returnHighlights,returnIdsOnly:this.returnIdsOnly,returnCountOnly:this.returnCountOnly};this.extent&&(i.envelope="{0},{1},{2},{3}".format(this.extent.xmin,this.extent.ymin,this.extent.xmax,this.extent.ymax)),(this.returnGeometry||this.extent)&&this.outSpatialReference&&(i.outSR=this.outSpatialReference.toJson()),0<this.maxResults&&(i.maxResults=this.maxResults);var r=this.searchLayers;return r&&0!=r.length||(r=t.allLayers()),i.layers=this._getServiceStrings(r),i},r.prototype._getServiceStrings=function(e){for(var t="",i={},r=0;r<e.length;r++){var n=e[r];if(n&&n.searchable&&n.mapService&&n.mapService.instantSearch){var s=n.mapService.id;i.hasOwnProperty(s)||(i[s]=[]),i[s].push(n.id)}}for(var a in i)i.hasOwnProperty(a)&&(t+=0===t.length?"":";",t+="{0}(include:{1})".format(a,i[a].join(",")));return t},r);function r(){this.extent=null,this.maxResults=50,this.contains=!0,this.returnGeometry=!1,this.returnHighlights=!1,this.returnIdsOnly=!1,this.returnCountOnly=!1,this.searchText=null,this.outSpatialReference=null}t.SearchQuery=i})},"geocortex/essentials/SearchResultFeature":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});function i(e,t){this.esriFeature=null,this.layer=null,this.highlights={},this.esriFeature=e,this.layer=t}t.SearchResultFeature=i})},"geocortex/essentials/SearchResults":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});function i(){this.error=null,this.results=[],this.queryParams=null}t.SearchResults=i})},"geocortex/essentials/SearchResultSet":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});function i(e){this.features=[],this.layer=null,e&&e.hasOwnProperty("features")&&(this.features=e.features),e&&e.hasOwnProperty("layer")&&(this.layer=e.layer)}t.SearchResultSet=i})},"geocortex/essentials/SearchTable":function(){var r,o=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)});define(["require","exports","./AsyncInitializable","./RestHelper","./../geocortex"],function(e,t,i,r,l){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n,s=(n=i.AsyncInitializable,o(a,n),a.prototype._configureObject=function(e,t){if(void 0===e||void 0===e.id||null==e.displayName)throw new Error("Incorrect search table object returned from initialization");this.id=e.id,this.displayName=e.displayName,this.parameters=e.parameters,this.featureDescription=e.featureDescription,this.featureLabel=e.featureLabel,this.featureLongDescription=e.featureLongDescription,this.iconUri=r.RestHelper.processClientSideTokens(this.site,e.iconUri),this.includeInGlobalSearch=e.includeInGlobalSearch},a.prototype.isSearching=function(){return this._searching},a.prototype.performSearch=function(e,t,i){function r(e){n._searching=!1,i&&i(new Error(e))}var n=this;e||r("No searchParameters provided"),this.isSearching()&&r("Currently performing a search"),this._searching=!0,this._onSearchingComplete=dojo.hitch(this,t),this._onSearchingError=dojo.hitch(this,i);var s=this.url+"/search",a="";for(var o in e)e.hasOwnProperty(o)&&(a+=(a?"&":"")+encodeURIComponent(o)+"="+encodeURIComponent(e[o]));s+="?"+a,l.request({url:s,content:{f:"json"},handleAs:"json",load:dojo.hitch(this,this._searchRestComplete),error:dojo.hitch(this,this._searchRestError),callbackParamName:"CallBack"})},a.prototype._searchRestComplete=function(e){this._searching=!1,!e&&this._onSearchingError&&this._onSearchingError(new Error("No results")),e.error&&this._onSearchingError&&this._onSearchingError(e.error),this._onSearchingComplete&&this._onSearchingComplete(new esri.tasks.FeatureSet(e))},a.prototype._searchRestError=function(e){this._searching=!1,this._onSearchingError&&this._onSearchingError(e)},a);function a(e){var t=n.call(this,e)||this;return t.displayName=null,t.parameters=[],t.id=null,t.site=null,t.featureDescription=null,t.featureLabel=null,t.featureLongDescription=null,t.iconUri=null,t.includeInGlobalSearch=!1,t._searching=!1,t._onSearchingComplete=null,t._onSearchingError=null,t}t.SearchTable=s})},"geocortex/essentials/SearchTableParameter":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});function i(){this.name=null,this.type=null}t.SearchTableParameter=i})},"geocortex/essentials/SecurityHelper":function(){define(["require","exports","../geocortex"],function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=(n.getCurrent=function(){var e=window.security;return e&&!e.finished?e:null},n.beginRefresh=function(e){if(null!=n.getCurrent())return!1;var t=new n;return t.site=e,!!t.getExpirationNoticeUrl()&&!!t.getRefreshUrl()&&((window.security=t).openFrame(),!0)},n.waitForSignIn=function(){var e=n.getCurrent();return e?e._refreshPromise:Promise.resolve()},n.cancel=function(){var e=n.getCurrent();return e&&(e._refreshPromise.isFulfilled||e._refreshPromiseReject("Canceled")),e&&e.finish()},n.prototype.openSystemBrowser=function(){var i=this,e=this.getRefreshUrl()+"&app="+this.site.signInRedirectUri+"&token_type=fragment&openSystemBrowser=true",t=/GeocortexApp\.iOS/.test(navigator.userAgent)?"_system":"_blank",r=function(){var e=location.hash;if(0<e.length&&e.startsWith("#gcx-")){window.removeEventListener?window.removeEventListener("popstate",r,!1):window.detachEvent&&window.detachEvent("onpopstate",r);var t=e.substring(5);i.sendRequest(i.site.url+"?f=json&callback=security.updateSitePrincipal&token="+t)}};window.addEventListener?window.addEventListener("popstate",r,!1):window.attachEvent&&window.attachEvent("onpopstate",r),window.open(e,t)},n.prototype.openFrame=function(){var e=this;this.frame=document.createElement("iframe"),this.frame.name="SignInHelper",this.frame.style.display="none",document.body.appendChild(this.frame),i.isNative()?(this.frame.src="SignInHelper.html",window.setTimeout(function(){e.finished||e.openSystemBrowser()},1e4)):(window.open("SignInHelper.html","SignInHelper"),window.setTimeout(function(){return e.openPopup()},15e3))},n.prototype.openPopup=function(){this.finished||(this.sendRequest(this.getExpirationNoticeUrl()+"?f=json&part=_html&callback=security.showContent"),window.open("SignInHelper.html","_blank"))},n.prototype.getExpirationNoticeUrl=function(){return this.site.principal&&this.site.principal.urls?this.site.principal.urls.expirationNotice:null},n.prototype.getRefreshUrl=function(){return this.site.principal&&this.site.principal.urls?this.site.principal.urls.refresh:null},n.prototype.sendRequest=function(e){if(!this.finished){var t=document.createElement("script");t.style.display="none",document.body.appendChild(t),this.scripts.push(t),t.type="text/javascript",t.src=e+"&rid="+this.id}},n.prototype.showContent=function(e){return!this.finished&&e.rid===this.id&&(this.dialog&&this.dialog.parentNode&&this.dialog.parentNode.removeChild(this.dialog),this.dialog=document.createElement("div"),this.dialog.innerHTML=e.content,document.body.appendChild(this.dialog),!0)},n.prototype.handleSignIn=function(e,t){if(this.finished)return null;if(!(0<e.length&&e.startsWith("#gcx-"))){var i="";return null==this.site.principal.urls.referrer&&(i="&app="+encodeURIComponent(t)),this.getRefreshUrl()+i+"&token_type=fragment"}var r=e.substring(5);return this.sendRequest(this.site.url+"?f=json&callback=security.updateSitePrincipal&token="+r),null},n.prototype.finish=function(){if(this.finished)return!1;for(this.finished=!0;0<this.scripts.length;){var e=this.scripts.pop();e.parentNode.removeChild(e)}return this.dialog&&this.dialog.parentNode&&this.dialog.parentNode.removeChild(this.dialog),this.frame&&this.frame.parentNode&&this.frame.parentNode.removeChild(this.frame),!0},n.prototype.updateSitePrincipal=function(e){return this.finished?(this._refreshPromise.isResolved||this._refreshPromiseResolve(),!1):e.rid===this.id&&(this.finish(),this.site.updatePrincipal(e.principal),this._refreshPromiseResolve(),console.log("Updated Principal (Refresh Successful)"),!0)},n.prototype.useSystemBrowser=function(){return!1},n.prototype.waitForSignIn=function(){return this._refreshPromise},n);function n(){var i=this;this.finished=!1,this.id=(new Date).valueOf().toString(),this.scripts=[],this._refreshPromise=new Promise(function(e,t){i._refreshPromiseResolve=e,i._refreshPromiseReject=t})}t.SecurityHelper=r})},"geocortex/essentials/ServiceHelper":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=(r.extractConnectionStringValue=function(e,t){if(0<e.length){var i=e.match("(^|;)[s]*"+t+"=([^;]*)");return null!==i?i[2]:""}return""},r);function r(){}t.ServiceHelper=i})},"geocortex/essentials/ServicePoint":function(){var r,m=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)});define(["require","exports","./Rx.light","./../geocortex"],function(t,i,n,r){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var s=(a.prototype.toString=function(){return this.message},a);function a(){}(i.ServiceRequestError=s).prototype.message="An error occurred while performing the operation.",s.prototype.details=new Array,s.prototype.name="ServiceRequestError";var o,l=(m(c,o=s),c);function c(){return null!==o&&o.apply(this,arguments)||this}(i.ServiceRequestAbortedError=l).prototype.message="The request was aborted.",l.prototype.name="ServiceRequestAbortedError";var u,p,h=(d.prototype.start=function(){try{this.promise=r.request(this),this.valid?this.registration=this.servicePoint.cancellationToken.register(this.error.bind(this)):this.promise.cancel()}catch(e){this.error(e)}},d.prototype.load=function(e){try{if(this.member){var t=e[this.member];if(t)for(var i=0;i<t.length&&this.valid;i++)this.observer.onNext(t[i])}else this.valid&&this.observer.onNext(e);this.complete()}catch(e){this.error(e)}},d.prototype.error=function(t){this.valid&&(this.valid=!1,this.promise.cancel(),this.registration.dispose(),this.observer.onError(e||new l))},d.prototype.complete=function(){this.valid&&(this.valid=!1,this.promise.cancel(),this.registration.dispose(),this.observer.onCompleted())},d.prototype.dispose=function(){this.valid&&(this.valid=!1,this.promise.cancel(),this.registration.dispose())},d);function d(){}h.prototype.handleAs="json",h.prototype.valid=!0,h.prototype.registration={dispose:function(){}};var f=(y.prototype.formatQuery=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];var r=function(e){var t=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];for(var r=e.length,n=0;n<t.length;n++){var s=e.indexOf(t[n]);0<=s&&s<r&&(r=s)}return s}(e,"?","!","#");return{query:e.substring(0,t),tail:e.substring(t)}}(e.format.apply(e,t));return function(e,t){p||((u=document.head.getElementsByTagName("base")[0])||((u=document.createElement("base")).setAttribute("href",window.location.href),document.head.appendChild(u)),p=document.createElement("a"));try{var i=u.getAttribute("href");u.setAttribute("href",e),p.setAttribute("href",t),t=p.href}finally{u.setAttribute("href",i)}return t}(this.baseAddress,r.query)+r.tail},y.prototype.getRequest=function(e,t){function i(e){this.observer=e,this.start()}(i.prototype=new h).servicePoint=this,i.prototype.query=e,i.prototype.member=t;var r=new n.AnonymousObservable;return r._subscribe=function(e){return new i(e)},r},y);function y(){}(i.ServicePoint=f).prototype.baseAddress=window.location.href,f.prototype.cancellationToken={dispose:function(){},register:function(e){return this}}})},"geocortex/essentials/Site":function(){var r,A=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)});define(["require","exports","./AsyncInitializable","./ArcGisPortalSecurityContext","./documents/DocumentStore","./Map","./GeocodingEndpoint","./GeometryEndpoint","./GeoprocessingEndpoint","./NamedExtent","./PrintTemplate","./TimeSliderProfile","./LayerCatalog","./Workflow","./SearchTable","./utilities/UrlUtilities","./utilities/SiteResourceIdComparer","./FeatureLayerService","geocortex/framework/utils/ArrayUtils","./SearchResults","./../geocortex","./SearchResultSet","./SearchResultFeature","./ServiceHelper","./MapServiceConstants","./RestHelperHTTPService","./SecurityHelper","geocortex/framework/utils/utils","./OAuth2Client","./WebMapReference","./utilities/SiteInitializationUtils","../geocortex","geocortex/framework/observables","./StreamLayerService"],function(e,t,i,a,r,o,n,s,l,c,u,p,h,d,f,y,m,v,g,_,S,L,b,T,E,I,x,w,M,R,O,D,C,P){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var F,U=(F=i.AsyncInitializable,A(k,F),k.prototype.initialize=function(e){var t=this;this.isInitialized||this._initializing||(this._initializedHandlerCalled=!1,this._initializing=!0,w.isNullOrUndefined(e)?O.detectAndConfigureCors(this.url).then(function(){O.downloadSite(t.url,t._handleSiteInitialization.bind(t),t._initSiteErrorHandler.bind(t))}):this._handleSiteInitialization(e))},k.prototype.getResourceById=function(e,t){return m.SiteResourceIdComparer.lookUp(e,t)},k.prototype.findWorkflowById=function(e){return this.getResourceById(this.workflows,e)},k.prototype.findPrintTemplateById=function(e){return this.getResourceById(this.printTemplates,e)},k.prototype.getFeatureServices=function(){var e=[];if(!this.essentialsMap)return e;for(var t=0,i=this.essentialsMap.mapServices;t<i.length;t++){var r=i[t];r instanceof v.FeatureLayerService&&e.push(r)}return e},k.prototype.getStreamServices=function(){var e=[];if(!this.essentialsMap)return e;for(var t=0,i=this.essentialsMap.mapServices;t<i.length;t++){var r=i[t];r instanceof P.StreamLayerService&&e.push(r)}return e},k.prototype.getMap=function(){return this._esriMap},k.prototype.getEssentialsVersion=function(){var e=3;if(this.currentVersion){var t=this.currentVersion.split(".");if(2<=t.length){var i=t[0]+"."+t[1];e=parseFloat(i)}}return e},k.prototype.getDefaultBatchGeocoder=function(){var e=g.firstOrDefault(this.geocodingEndpoints,function(e){return e.isDefaultBatchGeocoder});return!e&&0<this.geocodingEndpoints.length&&(e=this.geocodingEndpoints[0]),e},k.prototype.search=function(i,e,r,n){var t,s,a=this;e&&e(i);try{t=this.url+"/search";var o={};i&&i.toJson&&(o=i.toJson(this.getMap(),this.essentialsMap)),s=S.encodeJson(dojo.mixin({f:"json"},o))}catch(e){return void(n&&n(e))}s.hasOwnProperty("layers")&&s.layers&&S.request({url:t,content:s,load:function(e){var t=new _.SearchResults;t.queryParams=i,e?a._parseSearchResponse(t,e):t.error=new Error("Unexpected Error"),t.error&&n&&n(t.error),r&&r(t)},error:function(e){n&&n(e)},callbackParamName:"CallBack"})},k.prototype._parseSearchResponse=function(e,t){if(!t)throw new Error("_parseSearchResponse: required jsonObject argument was not supplied.");if(t.hasOwnProperty("error")&&t.error&&t.error.message)e.error=new Error(t.error.message);else if(t.hasOwnProperty("ResponseStatus")&&t.ResponseStatus&&t.ResponseStatus.ErrorCode)e.error=new Error(t.ResponseStatus.Message),e.error.name=t.ResponseStatus.ErrorCode;else if(t.hasOwnProperty("features")){var i=this._createFeatureSets(t.features,e.queryParams.returnHighlights);for(var r in i)i.hasOwnProperty(r)&&e.results.push(i[r])}},k.prototype._createFeatureSets=function(e,t){for(var i={},r=0,n=e;r<n.length;r++){var s=n[r],a=s.hasOwnProperty("mapServiceId")?s.mapServiceId:null,o=s.hasOwnProperty("layerId")?s.layerId:null,l=this.essentialsMap.findMapServiceById(a),c=l?l.findLayerOrTableById(o):null;if(c){var u=this._createFeature(s,c,t);i.hasOwnProperty(c.url)||(i[c.url]=new L.SearchResultSet({layer:c})),i[c.url].features.push(u)}}return i},k.prototype._createFeature=function(e,t,i){if(!e)throw new Error("_createSearchFeature: required jsonFeature argument was not supplied.");var r=this._jObjectToGraphic(e),n=new b.SearchResultFeature(r,t);return i&&this._assignHighlights(n,e),n},k.prototype._jObjectToGraphic=function(e){if(!e)throw new Error("_jObjectToGraphic: required jobject argument was not supplied.");var t=null;e.hasOwnProperty("geometry")&&e.geometry&&(t=esri.geometry.fromJson(e.geometry))&&t.spatialReference&&!e.geometry.spatialReference&&(t.spatialReference=new esri.SpatialReference(4326));var i={};return e.hasOwnProperty("attributes")&&e.attributes&&(i=JSON.parse(JSON.stringify(e.attributes))),new esri.Graphic(t,null,i,null)},k.prototype._assignHighlights=function(e,t){if(!e)throw new Error("_assignHighlights: required feature argument was not supplied.");if(!t)throw new Error("_assignHighlights: required jobject argument was not supplied.");var i={};t.hasOwnProperty("highlights")&&t.highlights&&(i=JSON.parse(JSON.stringify(t.highlights))),e.highlights=i},k.prototype._initAsyncCollection=function(e,t,i,r){if(e&&i&&r)for(var n=0;e&&n<e.length;n++)i[n]=new r(this.url+"/"+t+"/"+e[n].id),i[n].site=this,i[n]._configureObject(e[n],!1,n===e.length-1),!0===this.deepInitialize&&r!==d.Workflow&&(i[n].isInitialized=!0);this._siteInitializeUpdate()},k.prototype._initAsyncCollectionErrorHandler=function(e,t){e(),this._initializationFailedHandler(t),this._siteInitializeUpdate()},k.prototype._initGeocodingEndpointsHandler=function(e){this._geocodingEndpointsInitialized=!0,e&&this._initAsyncCollection(e.geocodingEndpoints,"geocoding",this.geocodingEndpoints,n.GeocodingEndpoint)},k.prototype._initGeometryEndpointsHandler=function(e){this._geometryEndpointsInitialized=!0,e&&this._initAsyncCollection(e.geometryEndpoints,"geometry",this.geometryEndpoints,s.GeometryEndpoint)},k.prototype._initKmlEndpointHandler=function(e){if(this._kmlServiceInitialized=!0,e&&e.connectionString){var t=T.ServiceHelper.extractConnectionStringValue(e.connectionString,"url");t&&(esri.config.defaults.kmlService=t)}},k.prototype.getLayerCatalog=function(e,t,i,r){var n=this.url+"/catalog/layercatalog/getcatalog";t(),S.request({url:n,content:{f:"json"},load:function(e){i(e)},error:r,callbackParamName:"CallBack"})},k.prototype.getLayerCatalogDetails=function(e,t,i,r){var n=this.url+"/catalog/layercatalog/getcatalogdetails",s={};s.ids=e.ids.join(),s.f="json",t(),S.request({url:n,content:s,load:function(e){i(e)},error:r,callbackParamName:"CallBack"})},k.prototype.getOfflineBasemaps=function(t,i){void 0===i&&(i=function(){});var e=this.url+"/offlinebasemaps";if("function"!=typeof t)throw new Error("loadComplete must be a function.");S.request({url:e,content:{f:"json"},load:function(e){e.error?i(new Error(e.error.message)):e.basemaps?t(e.basemaps):i(new Error("Unexpected result: "+JSON.stringify(e)))},error:i,callbackParamName:"CallBack"})},k.prototype._initGeoprocessingEndpointsHandler=function(e){this._geoprocessingEndpointsInitialized=!0,e&&this._initAsyncCollection(e.geoprocessingEndpoints,"geoprocessing",this.geoprocessingEndpoints,l.GeoprocessingEndpoint)},k._addQueryParameter=function(e,t){var i=e.split("#",2);e=i[0];var r=1<i.length?i[1]:"";return e+(-1<e.indexOf("?")?"&":"?")+t+r},k.prototype.canSignIn=function(){return this._signInEnabled&&!!this.principal&&!!this.principal.urls.signIn&&!this.principal.isAuthenticated&&!!this.principal.policy&&0<this.principal.policy.issuers.length},k.prototype._signIn=function(e,t){e=e||this.principal,t=t||e.urls.signIn,void 0===e.policy&&(e.policy={});var i=e.policy.hints;i&&(t=k._addQueryParameter(t,i)),t=k._addQueryParameter(t,"token_type=fragment"),this.signInRedirectUri&&t.indexOf("app=")<0?t=k._addQueryParameter(t,"app="+encodeURIComponent(this.signInRedirectUri)):!e.urls.referrer&&t.indexOf("app=")<0&&(t=k._addQueryParameter(t,"app="+encodeURIComponent(window.location.toString()))),this.onSignIn&&this.onSignIn({url:t}),window.addEventListener&&window.addEventListener("popstate",function(){location.hash.startsWith("#gcx-")&&location.reload()},!1),window.location.assign(t)},k.prototype.signIn=function(e){this._signIn(this.principal,e)},k.prototype.canSignOut=function(){return this._signOutEnabled&&!!this.principal&&this.principal.isAuthenticated&&!!this.principal.urls.signOut},k.prototype.signOut=function(){this.onSignOut&&this.onSignOut();var e=this.principal.urls.signOut;this.signOutRedirectUri?e=k._addQueryParameter(e,"app="+encodeURIComponent(this.signOutRedirectUri)):this._signOutRedirectUrl&&(e=k._addQueryParameter(e,"app="+encodeURIComponent(this._signOutRedirectUrl))),window.location.assign(e)},k.prototype.getTokenFromPrincipal=function(e,t){var i,r=this,n=null;if(t===E.MapServiceType.DYNAMIC?n=this.principal.tokens.arcgis:t===E.MapServiceType.FEATURE?n=this.principal.tokens.arcgis:t===E.MapServiceType.IMAGE?n=this.principal.tokens.arcgis:t===E.MapServiceType.TILED?n=this.principal.tokens.arcgis:t===E.MapServiceType.WEBTILED?n=this.principal.tokens.arcgis:t===E.MapServiceType.VECTORTILE?n=this.principal.tokens.arcgis:t===esri.IdentityManagerBase?n=this.principal.tokens.arcgis:t===k&&((i={})[this.url]=this.principal.tokens.site,n=i,this.layerCatalogs.forEach(function(e){var t=r.url.replace(r.id,e.siteId);n[t]=r.principal.tokens.site})),!n)return null;e=e.toLowerCase();var s=document.createElement("a");s.href=e.toLowerCase();var a=s.protocol,o=s.hostname,l=s.port;for(var c in e=s.href,n)if(n.hasOwnProperty(c)){var u=c.toLowerCase();if(o===u)return n[c];if(o.endsWith("."+u))return n[c];try{if(s.href=a+"://"+u,s.port=l,e.startsWith(s.href))return n[c]}catch(e){}try{if(s.href=u,e.startsWith(s.href)||e===s.href.rtrim("/"))return n[c]}catch(e){}}return null},k.prototype._initMapHandler=function(e){this._mapInitialized=!0,null!==e&&null!==e.site&&e.loadServiceLayersInMap(e.site.getMap()),this._siteInitializeUpdate()},k.prototype._initMapErrorHandler=function(e){this._mapInitialized=!0,this._initializationFailedHandler(e),this._siteInitializeUpdate()},k.prototype._initNamedExtentsHandler=function(e){this._namedExtentsInitialized=!0,e&&this._initAsyncCollection(e.namedExtents,"namedextents",this.namedExtents,c.NamedExtent)},k.prototype._initTimeSlidersHandler=function(e){this._timeSlidersInitialized=!0,e&&this._initAsyncCollection(e.timeSliders,"timesliders",this.timeSliders,p.TimeSliderProfile)},k.prototype._initOverviewMapHandler=function(){this._overviewMapInitialized=!0,this._siteInitializeUpdate()},k.prototype._initOverviewMapErrorHandler=function(e){this._overviewMapInitialized=!0,this._initializationFailedHandler(e),this._siteInitializeUpdate()},k.prototype._initPrintTemplatesHandler=function(i){var r=this,n=0;this._printTemplatesInitialized=!0,0<i.printTemplates.length&&null!=i.printTemplates[0].visible?this._initAsyncCollection(i.printTemplates,"printtemplates",this.printTemplates,u.PrintTemplate):i.printTemplates.forEach(function(e){S.request({url:r.url+"/printtemplates/"+e.id,content:{f:"json"},load:function(t){n++,i.printTemplates.forEach(function(e){e.id===t.id&&(e.visible=t.visible)}),n===i.printTemplates.length&&r._initAsyncCollection(i.printTemplates,"printtemplates",r.printTemplates,u.PrintTemplate)},callbackParamName:"CallBack"})})},k.prototype.updateServiceTokensIfStale=function(){if(this._serviceTokensStale)return this._getUpdatedServiceTokens();var e=new dojo.Deferred;return e.resolve(),e},k.prototype._getUpdatedServiceTokens=function(){var r=this;if(0!==this.updateInterval)return this._serviceTokenRefresh||(this._serviceTokenRefresh=new dojo.Deferred,this._updateServiceTokensOfAllSites(),new dojo.DeferredList(this._allDeferredDojosForUpdatingTokens).then(function(e){r._serviceTokensStale=!1;for(var t=0,i=e;t<i.length;t++)if(!i[t][0]){r._serviceTokensStale=!0,r._serviceTokenRefresh.reject(new Error("One or more service tokens failed to update")),r._serviceTokenRefresh=null;break}r._serviceTokenRefresh&&(r._serviceTokenRefresh.resolve(),r._serviceTokenRefresh=null),r._allDeferredDojosForUpdatingTokens=[]},function(e){r._allDeferredDojosForUpdatingTokens=[],r._serviceTokensStale=!0,r._serviceTokenRefresh.reject(e),r._serviceTokenRefresh=null})),this._serviceTokenRefresh;var e=new dojo.Deferred;return e.resolve(),e},k.prototype._updateServiceTokensBySendingRestRequest=function(e,t){var i=this.url;e&&(i=this.url.replace(this.id,e)),this._isTokenUpdateRequired(e)?S.request({url:i+"/update",content:{f:"json"},load:dojo.hitch(this,this._processServiceTokensHandler,e,t),error:dojo.hitch(this,this._processServiceTokensErrorHandler,t),callbackParamName:"CallBack"}):t.resolve()},k.prototype._isTokenUpdateRequired=function(e){if(!e)return!0;var t=this.essentialsMap.mapServices;if(0<t.length)for(var i=0,r=t;i<r.length;i++){var n=r[i];if(n.catalogId&&n.catalogId.split(".")[0]===e)return!0}return!1},k.prototype._processServiceTokensHandler=function(e,t,i){var r=this;i&&i.mapServiceTokens&&this._updateServiceTokens(this.essentialsMap,i.mapServiceTokens,e),e||(i&&i.overviewMapServiceTokens&&this._updateServiceTokens(this.overviewMap,i.overviewMapServiceTokens,e),i.geocodingServiceTokens&&i.geocodingServiceTokens.forEach(function(t){var e=r.geocodingEndpoints.filter(function(e){return e.id===t.id})[0];e&&(e.geocoderToken=t.token,dojo.publish("ServiceTokenRefreshed",{serviceUrl:e.geocoderUrl,token:t.token}))}),i.geometryServiceTokens&&i.geometryServiceTokens.forEach(function(t){var e=r.geometryEndpoints.filter(function(e){return e.id===t.id})[0];e&&(e.geometryServiceToken=t.token,dojo.publish("ServiceTokenRefreshed",{serviceUrl:e.geometryServiceUrl,token:t.token}))})),t.resolve()},k.prototype._processServiceTokensErrorHandler=function(e,t){this._serviceTokensStale=!0,e.reject(t),dojo.publish("ServiceTokenRefreshError",{error:t})},k.prototype._updateServiceTokens=function(e,t,i){if(e&&t)for(var r=0;t&&r<t.length;r++){var n=void 0;(n=i?e.findMapServiceById(i+"-"+t[r].id):e.findMapServiceById(t[r].id))&&n._updateServiceToken(t[r].token)}},k.prototype._updateServiceTokensFromPrincipal=function(e){if(e&&e.mapServices)for(var t=0,i=e.mapServices;t<i.length;t++){var r=i[t];if(r&&r.serviceUrl){var n=this.getTokenFromPrincipal(r.serviceUrl,esri.IdentityManagerBase)||this.getTokenFromPrincipal(r.serviceUrl,k);n&&r._updateServiceToken(n)}}},k.prototype.refreshPrincipal=function(){return this._refreshPrincipal(),x.SecurityHelper.waitForSignIn()},k.prototype._refreshPrincipal=function(){var e=this,t={site:this,handled:!1,resumeRefresh:function(){return x.SecurityHelper.beginRefresh(e)},suspendRefresh:function(){return x.SecurityHelper.cancel()}};dojo.publish("geocortex_sessionExpiring",t),t.handled||t.resumeRefresh()},k.prototype._refreshPrincipalAt=function(e,t){var i=this;if(!e)return!1;var r=new Date(e).valueOf();isNaN(r)&&(r=Date.parse(e));var n=r-(new Date).valueOf()-t;return n=Math.max(1e4,n),window.setTimeout(function(){return i._refreshPrincipal()},n),!0},k.prototype.updatePrincipal=function(e){this.principal=e,this._refreshPrincipalAt(e.expiry,3e5),O.updateDefaultToken(this.principal.tokens.site,this.url),this.principal.tokens&&this.principal.tokens.arcgis&&(this._updateServiceTokensFromPrincipal(this.essentialsMap),this._updateServiceTokensFromPrincipal(this.overviewMap)),this.onPrincipalUpdated&&this.onPrincipalUpdated()},k.prototype._getCredential=function(e,t){var i=this.getTokenFromPrincipal(e,esri.IdentityManagerBase)||this.getTokenFromPrincipal(e,k),r=new dojo.Deferred;if(i){var n=new esri.Credential;n.token=i,n.server=this._getCredentialServer(e),r.resolve(n)}else r.reject(new Error("No token available for service {0}".format(e)));return r},k.prototype._getCredentialServer=function(e){var t=e.toLowerCase(),i=t.indexOf("/rest/services");return-1===i&&(i=t.indexOf("/sharing")),-1===i&&"/"===t.substr(-1)&&(i=t.length-1),-1<i?e.substring(0,i):e},k.prototype._hookGetCredential=function(){var r=this;esri.IdentityManagerBase.prototype.getCredential=function(e,t){try{return r._getCredential(e,t)}catch(e){console.log("Error getting site credential: "+e);var i=new dojo.Deferred;return i.reject(e),i}}},k.prototype._initSiteHandler=function(e){var t=this;if(this._hookGetCredential(),!e)throw new Error("Incorrect site object returned from initialization");if(this.configPreprocessor&&(this.configPreprocessor(e),this.configPreprocessor=null),e.__loadedOffline&&(this._serviceTokensStale=!0),e.contentPolicy&&(w.isNullOrUndefined(e.contentPolicy.trustedUrls)?this.trustedUrls=[]:this.trustedUrls=e.contentPolicy.trustedUrls),e.layerCatalogs)if(0===e.layerCatalogs.length)this.layerCatalogs=[];else for(var i=0;i<e.layerCatalogs.length;i++)this.layerCatalogs[i]=new h.LayerCatalog(e.layerCatalogs[i].siteId);if(e.principal){var r=e.principal;if(void 0===r.policy&&(r.policy={}),r.policy.authenticate&&!r.isAuthenticated)return void this._signIn(r);this.updatePrincipal(e.principal),r.isAuthenticated&&dojo.publish("geocortex_authenticationSucceeded",[{username:r.label,token:r.tokens.site}])}else if(e.arcGisPortalAuthentication&&e.arcGisPortalAuthentication.clientID){var n=e.arcGisPortalAuthentication;if(this.arcGisPortalSecurityContext=new a.ArcGisPortalSecurityContext(n.url,n.domains,n.clientID),!this.arcGisPortalSecurityContext.initiate()){if(this.arcGisPortalSecurityContext.error)if(this.arcGisPortalSecurityContext.error.code===M.OAuth2Error.ACCESS_DENIED_ERROR_CODE)this.onUserSignInCancelled&&this.onUserSignInCancelled({tryAgainAction:dojo.hitch(this,function(){M.OAuth2Client.redirectToLogOnPage(this.arcGisPortalSecurityContext.getLogOnUrl(),this.arcGisPortalSecurityContext.clientId)})});else{var s=new Error;s.name=this.arcGisPortalSecurityContext.error.code,s.message=this.arcGisPortalSecurityContext.error.description,this._initializationFailedHandler(s)}return}I.RestHelperHTTPService.arcGisPortalToken=this.arcGisPortalSecurityContext.tokenResult}this.hasGeocodingEndpoints=!!e.hasGeocodingEndpoints,this.hasGeometryEndpoints=!!e.hasGeometryEndpoints,this.hasGeoprocessingEndpoints=!!e.hasGeoprocessingEndpoints,this.hasNamedExtents=!!e.hasNamedExtents,this.hasNorthArrow=!!e.hasNorthArrow,this.hasTimeSliders=!!e.hasTimeSliders,this.hasOverviewMap=!!e.hasOverviewMap,this.hasPrintTemplates=!!e.hasPrintTemplates,this.hasViewers=!!e.hasViewers,this.hasVirtualDirectory=!!e.hasVirtualDirectory,this.hasWorkflows=!!e.hasWorkflows,this.hasSearchTables=!!e.hasSearchTables,this.hasWebMaps=!!e.hasWebMaps,this.dataProvider=e.dataProvider,this.displayName=e.displayName,this.id=e.id,this._signInEnabled=!!e.signInEnabled,this._signOutEnabled=!!e.signOutEnabled,this._signOutRedirectUrl=e.signOutRedirectUrl,this.timeZoneId=e.timeZoneId,this.displayTimeZoneId=e.displayTimeZoneId,void 0===e.currentVersion?this.currentVersion="3.0":this.currentVersion=e.currentVersion,e.hasOwnProperty("updateInterval")?(this.updateInterval=parseInt(e.updateInterval,10),isNaN(this.updateInterval)&&(this.updateInterval=0)):this.updateInterval=0,0<this.updateInterval&&(this._tokenIntervalHandle=setInterval(function(){t._getUpdatedServiceTokens()},Math.max(60,1e3*this.updateInterval))),this.properties=S._getProperties(e.properties),this.extensions=S._getExtensions(e.extensions),this.essentialsMap=new o.Map(this.originalUrl+"/map"),this.essentialsMap.site=this,dojo.connect(this.essentialsMap,"onInitialized",dojo.hitch(this,this._initMapHandler)),dojo.connect(this.essentialsMap,"onInitializationFailed",dojo.hitch(this,this._initMapErrorHandler)),this.hasOverviewMap&&(this.overviewMap=new o.Map(this.originalUrl+"/overviewmap"),this.overviewMap.site=this,dojo.connect(this.overviewMap,"onInitialized",dojo.hitch(this,this._initOverviewMapHandler)),dojo.connect(this.overviewMap,"onInitializationFailed",dojo.hitch(this,this._initOverviewMapErrorHandler))),e.map&&e.map.layerList&&(this.layerListRestEndpoint=e.map.layerList),!this.deepInitialize||this.getEssentialsVersion()<3.3||void 0===e.map?(this.essentialsMap.initialize(),this.hasOverviewMap?this.overviewMap.initialize():this._overviewMapInitialized=!0,e.hasKmlServiceEndpoint?S.request({url:this.url+"/kmlService",content:{f:"json"},load:dojo.hitch(this,this._initKmlEndpointHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._kmlServiceInitialized=!0})),callbackParamName:"CallBack"}):this._kmlServiceInitialized=!0,this.hasGeocodingEndpoints?S.request({url:this.url+"/geocoding",content:{f:"json"},load:dojo.hitch(this,this._initGeocodingEndpointsHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._geocodingEndpointsInitialized=!0})),callbackParamName:"CallBack"}):this._geocodingEndpointsInitialized=!0,this.hasGeometryEndpoints?S.request({url:this.url+"/geometry",content:{f:"json"},load:dojo.hitch(this,this._initGeometryEndpointsHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._geometryEndpointsInitialized=!0})),callbackParamName:"CallBack"}):this._geometryEndpointsInitialized=!0,this.hasGeoprocessingEndpoints?S.request({url:this.url+"/geoprocessing",content:{f:"json"},load:dojo.hitch(this,this._initGeoprocessingEndpointsHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._geoprocessingEndpointsInitialized=!0})),callbackParamName:"CallBack"}):this._geoprocessingEndpointsInitialized=!0,this.hasNamedExtents?S.request({url:this.url+"/namedextents",content:{f:"json"},load:dojo.hitch(this,this._initNamedExtentsHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._namedExtentsInitialized=!0})),callbackParamName:"CallBack"}):this._namedExtentsInitialized=!0,this.hasPrintTemplates?S.request({url:this.url+"/printtemplates",content:{f:"json"},load:dojo.hitch(this,this._initPrintTemplatesHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._printTemplatesInitialized=!0})),callbackParamName:"CallBack"}):this._printTemplatesInitialized=!0,this.hasSearchTables?S.request({url:this.url+"/searchtables",content:{f:"json"},load:dojo.hitch(this,this._initSearchTablesHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._searchTablesInitialized=!0})),callbackParamName:"CallBack"}):this._searchTablesInitialized=!0,this.hasTimeSliders?S.request({url:this.url+"/timesliders",content:{f:"json"},load:dojo.hitch(this,this._initTimeSlidersHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._timeSlidersInitialized=!0})),callbackParamName:"CallBack"}):this._timeSlidersInitialized=!0,this.hasWorkflows?S.request({url:this.url+"/workflows",content:{f:"json"},load:dojo.hitch(this,this._initWorkflowsHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._workflowsInitialized=!0})),callbackParamName:"CallBack"}):this._workflowsInitialized=!0,this.hasWebMaps?S.request({url:this.url+"/webmaps",content:{f:"json"},load:dojo.hitch(this,this._initWebMapHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._webMapsInitialized=!0})),callbackParamName:"CallBack"}):this._webMapsInitialized=!0):(this._initGeocodingEndpointsHandler(e),this._initGeometryEndpointsHandler(e),this._initGeoprocessingEndpointsHandler(e),this._initTimeSlidersHandler(e),this._initKmlEndpointHandler(e.kmlServiceEndpoint),this.essentialsMap.initialize(e.map),this._initNamedExtentsHandler(e),e.overviewMap?this.overviewMap.initialize(e.overviewMap):(this._overviewMapInitialized=!0,this._siteInitializeUpdate()),this._initPrintTemplatesHandler(e),this._initWorkflowsHandler(e),this._initSearchTablesHandler(e),this._initWebMapHandler(e)),this.documentStore.initialize(this),this._siteInitializeUpdate()},k.prototype._updateServiceTokensOfAllSites=function(){var i=this;this.layerCatalogs&&0<this.layerCatalogs.length&&this.layerCatalogs.forEach(function(e){var t=new dojo.Deferred;i._allDeferredDojosForUpdatingTokens.push(t),i._updateServiceTokensBySendingRestRequest(e.siteId,t)});var e=new dojo.Deferred;this._allDeferredDojosForUpdatingTokens.push(e),this._updateServiceTokensBySendingRestRequest(null,e)},k.prototype._initSiteErrorHandler=function(e){var t=this,i=e,r=i.principal;!r||r.isAuthenticated||403!==i.code?(r&&r.isAuthenticated&&403===i.code&&r.urls.signOut&&(this._signOutEnabled=!0,this.principal=r),this._geocodingEndpointsInitialized=!0,this._geometryEndpointsInitialized=!0,this._geoprocessingEndpointsInitialized=!0,this._kmlServiceInitialized=!0,this._namedExtentsInitialized=!0,this._printTemplatesInitialized=!0,this._workflowsInitialized=!0,this._searchTablesInitialized=!0,this._timeSlidersInitialized=!0,this._initializationFailedHandler(e),this._siteInitializeUpdate()):D.isNative()?dojo.publish("SiteSignInRequired",{error:i.code,callback:function(){return t._signIn(r)}}):this._signIn(r)},k.prototype._initWorkflowsHandler=function(e){this._workflowsInitialized=!0,e&&this._initAsyncCollection(e.workflows,"workflows",this.workflows,d.Workflow)},k.prototype._initSearchTablesHandler=function(e){this._searchTablesInitialized=!0,e&&this._initAsyncCollection(e.searchTables,"searchTables",this.searchTables,f.SearchTable)},k.prototype._initWebMapHandler=function(e){this._webMapsInitialized=!0,e&&e.webMapsInfo?(this.webMapsInfo.layerTypes=e.webMapsInfo.layerTypes,this._initAsyncCollection(e.webMapsInfo.webMaps,"webmaps",this.webMapsInfo.webMaps,R.WebMapReference)):(this.hasAGOLRenderers.set(!1),this.esriLegendProcessed.set(!0))},k.prototype._siteInitializeUpdate=function(){this._geocodingEndpointsInitialized&&this._geometryEndpointsInitialized&&this._geoprocessingEndpointsInitialized&&this._kmlServiceInitialized&&this._mapInitialized&&this._namedExtentsInitialized&&this._overviewMapInitialized&&this._printTemplatesInitialized&&this._workflowsInitialized&&this._searchTablesInitialized&&this._timeSlidersInitialized&&this._webMapsInitialized&&(this._initializedHandlerCalled||(this._initializedHandlerCalled=!0,this.siteInitializationTime=(new Date).getTime(),this._initializedHandler(this)))},k.prototype._handleSiteInitialization=function(e){e&&e.hasFeatureLayers?dojo.addOnLoad(dojo.hitch(this,function(){this._initSiteHandler(e)})):this._initSiteHandler(e)},k);function k(e,t){var i=F.call(this,e)||this;return i.currentVersion=null,i.dataProvider=null,i.deepInitialize=!1,i.displayName=null,i.documentStore=new r.DocumentStore,i.updateInterval=null,i.essentialsMap=null,i.extensions=[],i.geocodingEndpoints=[],i.geometryEndpoints=[],i.geoprocessingEndpoints=[],i.layerListRestEndpoint=null,i.hasGeocodingEndpoints=!1,i.hasGeometryEndpoints=!1,i.hasGeoprocessingEndpoints=!1,i.hasNamedExtents=!1,i.hasNorthArrow=!1,i.hasTimeSliders=!1,i.hasOverviewMap=!1,i.hasPrintTemplates=!1,i.hasViewers=!1,i.hasVirtualDirectory=!1,i.hasWorkflows=!1,i.hasSearchTables=!1,i.hasWebMaps=!1,i.id=null,i.namedExtents=[],i.overviewMap=null,i.printTemplates=[],i.properties={},i.timeSliders=[],i.trustedUrls=[],i.layerCatalogs=[],i.serviceLayersLoaded=!1,i.url=null,i.workflows=[],i.searchTables=[],i.timeZoneId=null,i.displayTimeZoneId=null,i.webMapsInfo={layerTypes:null,webMaps:[]},i.hasAGOLRenderers=new C.Observable(null),i.esriLegendProcessed=new C.Observable(!1),i.defaultRenderers={},i.configPreprocessor=null,i.onLayerLoad=null,i.onLayerLoadError=null,i.onServiceLayersLoaded=function(){},i.onSignIn=null,i.onSignOut=null,i.onUserSignInCancelled=null,i.onPrincipalUpdated=null,i.principal={isAuthenticated:!1,label:null,identities:[],policy:{},urls:{},tokens:{arcgis:{},geocortex:{},site:null}},i.suspendLayersOnLoad=!0,i.useSiteFullExtentForWMTSServices=!1,i._geocodingEndpointsInitialized=!1,i._geometryEndpointsInitialized=!1,i._geoprocessingEndpointsInitialized=!1,i._kmlServiceInitialized=!1,i._mapInitialized=!1,i._namedExtentsInitialized=!1,i._overviewMapInitialized=!1,i._printTemplatesInitialized=!1,i._workflowsInitialized=!1,i._searchTablesInitialized=!1,i._timeSlidersInitialized=!1,i._webMapsInitialized=!1,i._initializedHandlerCalled=!1,i._signInEnabled=!1,i._signOutEnabled=!1,i._tokenIntervalHandle=null,i._serviceTokenRefresh=null,i._serviceTokensStale=!1,i._allDeferredDojosForUpdatingTokens=new Array,i.originalUrl=e,i.url=y.UrlUtilities.simplify(e),i._esriMap=t,i}t.Site=U})},"geocortex/essentials/StreamLayerService":function(){var r,o=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)});define(["require","exports","./MapService","./RestHelperHTTPService"],function(e,t,i,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n,s=(n=i.MapService,o(a,n),a.prototype._configureStreamSettings=function(e){if(e){var t={purgeOptions:{displayCount:1e4}};null!=e.maxDisplayCount&&(t.purgeOptions.displayCount=e.maxDisplayCount),null!=e.maxAge&&(t.purgeOptions.age=e.maxAge),null!=e.maxTrackPoints&&(t.maximumTrackPoints=e.maxTrackPoints),e.definitionExpression&&(t.definitionExpression=e.definitionExpression),e.geometryDefinition&&(t.geometryDefinition=new esri.geometry.Extent(e.geometryDefinition)),this._streamLayerOptions=t}},a.prototype._configureObject=function(e,t){if(void 0===e)throw new Error("Incorrect map service object returned from initialization");this._configureStreamSettings(e.streamSettings),n.prototype._configureObject.call(this,e,t)},a.prototype._createServiceLayer=function(){var e=this.serviceUrl;this.serviceToken&&(e=r.RestHelperHTTPService.appendTokenToUrl(e,this.serviceToken));var t=new esri.layers.StreamLayer(e,this._streamLayerOptions);t.id=this.id,t.loadError&&this._layerLoadErrorHandler(t.loadError),this._computeInitServiceLayerVisibility()?t.show():t.hide(),dojo.connect(t,"onError",this,this._layerLoadErrorHandler),dojo.connect(t,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded)),this.attributionDataUrl&&""!==this.attributionDataUrl?(t.attributionDataUrl=this.attributionDataUrl,t.hasAttributionData=!0):this.hasAttributionData&&(t.attributionDataUrl=this.url+"/Attribution",t.hasAttributionData=!0),this.serviceLayer=t,n.prototype.initiateServiceFailureTimer.call(this)},a.prototype._computeInitServiceLayerVisibility=function(){var e=this._initiallyVisible;return e&&this.layers&&1===this.layers.length&&(e=this.layers[0].isVisible()),e},a);function a(){var e=null!==n&&n.apply(this,arguments)||this;return e._streamLayerOptions=null,e}t.StreamLayerService=s})},"geocortex/essentials/TemplateParameter":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/TextField":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});function i(e,t,i,r){this.id=e,this.displayName=t,this.value=i,this.multiline=r}t.TextField=i})},"geocortex/essentials/TimeExtent":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/TimeInfo":function(){define(["require","exports","./utilities/StringUtilities"],function(e,t,l){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getGcxTimeInfo=function(e,t,i){var r=null,n=null;if(e&&e.timeExtent&&(r=e.timeExtent&&e.timeExtent.startTime instanceof Date?e.timeExtent.startTime.valueOf():parseInt(e.timeExtent[0],10),n=e.timeExtent&&e.timeExtent.endTime instanceof Date?e.timeExtent.endTime.valueOf():parseInt(e.timeExtent[1],10)),(!r||isNaN(r))&&!t||(!n||isNaN(n))&&!i)return null;var s=t?l.StringUtilities.getDateFromRestDateString(t):new Date(r),a=i?l.StringUtilities.getDateFromRestDateString(i):new Date(n),o={};return o.timeExtent={startTime:s,endTime:a},e&&(e.startTimeField&&(o.startTimeField=e.startTimeField),e.endTimeField&&(o.endTimeField=e.endTimeField),e.trackIdField&&(o.trackIdField=e.trackIdField),e.timeReference&&(o.timeReference={},null!=e.timeReference.respectsDaylightSaving&&(o.timeReference.respectsDaylightSavings=e.timeReference.respectsDaylightSaving),null!=e.timeReference.timeZone&&(o.timeReference.timeZone=e.timeReference.timeZone)),e.exportOptions&&(o.exportOptions={},null!=e.exportOptions.timeDataCumulative&&(o.exportOptions.timeDataCumulative=e.exportOptions.timeDataCumulative),null!=e.exportOptions.timeOffset&&(o.exportOptions.timeOffset=e.exportOptions.timeOffset),null!=e.exportOptions.timeOffsetUnits&&(o.exportOptions.timeOffsetUnits=e.exportOptions.timeOffsetUnits),null!=e.exportOptions.useTime&&(o.exportOptions.useTime=e.exportOptions.useTime))),o}})},"geocortex/essentials/TimeReference":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/TimeSliderMode":function(){define(["require","exports"],function(e,t){"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),(i=t.TimeSliderMode||(t.TimeSliderMode={}))[i.Extent=0]="Extent",i[i.Cumulative=1]="Cumulative",i[i.Instant=2]="Instant"})},"geocortex/essentials/TimeSliderProfile":function(){var r,u=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)});define(["require","exports","./AsyncInitializable","./TimeSliderMode","./TimeUnits","./utilities/StringUtilities","./../geocortex"],function(e,t,i,r,n,s,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o,l=(o=i.AsyncInitializable,u(c,o),c.prototype._configureObject=function(e,t){this.id=e.id,this.displayName=e.displayName,this.description=e.description,this.mode=r.TimeSliderMode[e.mode],this.displayFormat=e.displayFormat,this.timeExtent={startTime:s.StringUtilities.getDateFromRestDateString(e.startTime),endTime:s.StringUtilities.getDateFromRestDateString(e.endTime)},this.initialTimeExtent={startTime:s.StringUtilities.getDateFromRestDateString(e.initialStartTime),endTime:s.StringUtilities.getDateFromRestDateString(e.initialEndTime)},this.timeInterval=e.timeInterval,this.timeIntervalUnit=n.EssentialsTimeUnits[e.timeIntervalUnit],this.snapToTimeIntervals=e.snapToTimeIntervals,this.properties=a._getProperties(e.properties),this.extensions=a._getExtensions(e.extensions)},c);function c(e){return o.call(this,e)||this}t.TimeSliderProfile=l})},"geocortex/essentials/TimeUnits":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=(r.UNIT_CENTURIES="esriTimeUnitsCenturies",r.UNIT_DAYS="esriTimeUnitsDays",r.UNIT_DECADES="esriTimeUnitsDecades",r.UNIT_HOURS="esriTimeUnitsHours",r.UNIT_MILLISECONDS="esriTimeUnitsMilliseconds",r.UNIT_MINUTES="esriTimeUnitsMinutes",r.UNIT_MONTHS="esriTimeUnitsMonths",r.UNIT_SECONDS="esriTimeUnitsSeconds",r.UNIT_WEEKS="esriTimeUnitsWeeks",r.UNIT_YEARS="esriTimeUnitsYears",r.UNIT_UNKNOWN="esriTimeUnitsUnknown",r);function r(){}t.TimeUnits=i;var n=(s.Century=i.UNIT_CENTURIES,s.Day=i.UNIT_DAYS,s.Decade=i.UNIT_DECADES,s.Hour=i.UNIT_HOURS,s.MilliSecond=i.UNIT_MILLISECONDS,s.Minute=i.UNIT_MINUTES,s.Month=i.UNIT_MONTHS,s.Second=i.UNIT_SECONDS,s.Week=i.UNIT_WEEKS,s.Year=i.UNIT_YEARS,s);function s(){}t.EssentialsTimeUnits=n})},"geocortex/essentials/TokenResult":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});function i(){}t.TokenResult=i})},"geocortex/essentials/WebmapLayerType":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=(r.FEATURE_LAYER="ArcGISFeatureLayer",r.MAP_SERVICE="ArcGISMapServiceLayer",r.STREAM_SERVICE="ArcGISStreamLayer",r.TILED_MAP_SERVICE="ArcGISTiledMapServiceLayer",r.IMAGE_SERVICE="ArcGISImageServiceLayer",r.IMAGE_SERVICE_VECTOR="ArcGISImageServiceVectorLayer",r.TILED_IMAGE_SERVICE="ArcGISTiledImageServiceLayer",r.VECTOR_TILE_SERVICE="VectorTileLayer",r.BING_AERIAL="BingMapsAerial",r.BING_HYBRID="BingMapsHybrid",r.BING_ROAD="BingMapsRoad",r.BING_AERIAL_WITH_LABELS="BingMapsAerialWithLabels",r.OPEN_STREET_MAP="OpenStreetMap",r.WEB_TILED="WebTiledLayer",r.KML="KML",r.WMS="WMS",r.CSV="CSV",r.GEO_RSS="GeoRSS",r.GROUP_LAYER="GroupLayer",r);function r(){}t.WebmapLayerType=i})},"geocortex/essentials/WebMapReference":function(){var r,s=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)});define(["require","exports","./AsyncInitializable","./utilities/LayerUtilities","./GeoRssLayerService","./MapServiceConstants","geocortex/framework/utils/utils","./utilities/UrlUtilities","./utilities/GraphicsLayerUtilities","./LayerChart","geocortex/charting/infrastructure/Enums","geocortex/framework/utils/ArrayUtils"],function(e,t,i,c,u,p,m,d,v,y,g,_){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r,n=(r=i.AsyncInitializable,s(f,r),f.prototype.isLoading=function(){return this._isLoading},f.prototype._getUrlPortions=function(e){for(var t={id:null,path:null},i=0,r=this._arcgisSharingRegularExpressions;i<r.length;i++){var n=r[i],s=e.match(n);if(s&&0<s.length){t.id=s[2],t.path=s[1];break}}return t},f.prototype._loadWebMap=function(e,t,i){if(e&&e.path)this._loadPortalItem(e.path,e.id,this._processItemData.bind(this,e.path),this._onLoadingError,i);else{var r="Web map with address "+t+" cannot be loaded.",n=esri.urlToObject(t);if(n.query=n.query||{},n.query&&(n.query.webmap||n.query.id)){var s=n.query.webmap||n.query.id,a=void 0;esri.arcgis&&esri.arcgis.utils?a=esri.arcgis.utils.getItem:esri.arcgis.getItem&&(a=esri.arcgis.getItem),a&&a(s).then(function(e){e?this._processItemData(e.itemData):this._onLoadingError(new Error(r)),i.resolve(!1)})}else this._onLoadingError(new Error(r)),i.resolve(!1)}},f.prototype._initializeWebMap=function(e,t,i,r){var n=this;if(this.isLoading())r&&r(new Error("Currently loading web map."));else{this._isLoading=!0;var s=new dojo.Deferred;this._onLoadingComplete=dojo.hitch(this,i),this._onLoadingError=dojo.hitch(this,r),this._layerTypes=this.site.webMapsInfo.layerTypes;var a=this._getUrlPortions(e.url);this._loadWebMap(a,e.url,s),s.then(function(e){n._isLoading=e})}},f.prototype._loadPortalItem=function(e,a,o,l,c){var u=this;esri.arcgis&&esri.arcgis.Portal&&new esri.arcgis.Portal(e).on("ready",function(e){if(e){var t={q:"id:"+a},i=null;if(u.site.principal.isAuthenticated&&u.site.principal.tokens.arcgis)for(var r=0,n=Object.keys(u.site.principal.tokens.arcgis);r<n.length;r++){var s=n[r];if(-1<e.url.indexOf(s)){i=u.site.principal.tokens.arcgis[s],t.token=i;break}}e.queryItems(t).then(function(e){if(e&&0!==e.results.length){var t=e.results[0];esri.request({url:t.itemDataUrl,content:{token:i}}).then(function(e){o(e),c.resolve(!1)},function(e){l(new Error(e.message)),c.resolve(!1)})}})}})},f.prototype._processItemData=function(e,t){if(t){var i=t.operationalLayers;i&&this._processLayerCollection(e,i,"Operational");var r=t.baseMap.baseMapLayers;r&&this._processLayerCollection(e,r,"Base")}},f.prototype._processLayerCollection=function(s,e,a){var o=this;if(e){for(var t=[],i=function(t){var a=_.firstOrDefault(l.site.essentialsMap.mapServices.filter(function(e){return d.UrlUtilities.stripProtocol(e.serviceUrl)===d.UrlUtilities.stripProtocol(t.url)}));if(!a)return"continue";if(t.layers)for(var e=function(t){if(a.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer){var e=m.getProp(t,["layerDefinition","drawingInfo","renderer"]);if(e){var i=(a.serviceLayer.layerDrawingOptions||[]).slice(),r=esri.renderer.fromJson(e);if(r){var n=new esri.layers.LayerDrawingOptions;n.renderer=r,i[t.id]=n,a.serviceLayer.setLayerDrawingOptions(i,!1)}}}var s=_.firstOrDefault(a.layers.filter(function(e){return e.id.toString()===t.id.toString()}));s&&l._assignPopupToExistingLayer(t,s)},i=0,r=t.layers;i<r.length;i++)e(r[i]);else{f._rendererPromises.push(l._assignRendererToExistingLayer(s,t,a)),l._assignLabelingInfoToExistingLayer(s,t,a),l._assignDefinitionExpressionToExistingLayer(s,t,a);var n=_.firstOrDefault(a.layers);n&&l._assignPopupToExistingLayer(t,n)}},l=this,r=0,n=e;r<n.length;r++)i(n[r]);this._isFinalReference&&(0<f._rendererPromises.length?Promise.all(f._rendererPromises).then(function(){f._hasAgolRenderers?o.site.hasAGOLRenderers.set(!0):(o.site.hasAGOLRenderers.set(!1),o.site.esriLegendProcessed.set(!0))}):(this.site.hasAGOLRenderers.set(!1),this.site.esriLegendProcessed.set(!0)));for(var c=0,u=e;c<u.length;c++){var p=u[c];if(!this._layerTypes||!(!p.type&&0<=this._layerTypes.indexOf("Null")||p.type&&0<=this._layerTypes.indexOf(p.type))){var h=this._addLayerToMap(p);t.push(h)}}new dojo.DeferredList(t).then(function(e){if(e){for(var t=[],i=0,r=e;i<r.length;i++){var n=r[i][1];n&&0!==n.length&&(t=t.concat(n))}0<t.length&&o.site.essentialsMap.addServiceLayers(t,a)}},function(e){o._onLoadingError(new Error("There was an error loading a layer: "+e))})}},f.prototype._assignRendererToExistingLayer=function(e,t,i){function r(e){e&&(i.serviceLayer.renderer=e,n.site.defaultRenderers[i.id]=JSON.stringify(i.serviceLayer.renderer.toJson()),f._hasAgolRenderers=!0,i.serviceLayer.redraw())}var n=this,s=m.getProp(t,["layerDefinition","drawingInfo","renderer"]);if(s)r(esri.renderer.fromJson(s));else if(t.itemId){var a=new dojo.Deferred;return this._loadPortalItem(e,t.itemId,function(e){var t=m.getProp(e,["layers","0","layerDefinition","drawingInfo","renderer"]);t&&r(esri.renderer.fromJson(t))},this._onLoadingError,a),a}return(new dojo.Deferred).resolve()},f.prototype._assignLabelingInfoToExistingLayer=function(e,t,r){var i=m.getProp(t,["layerDefinition","drawingInfo","labelingInfo"]);if(i)r.serviceLayer.setLabelingInfo(i);else if(t.itemId){var n=new dojo.Deferred;return this._loadPortalItem(e,t.itemId,function(e){var t=m.getProp(e,["layers","0","layerDefinition","drawingInfo","labelingInfo"]);if(t&&t.length){var i=t.map(function(e){return new esri.layers.LabelClass(e)});r.serviceLayer.setLabelingInfo(i)}},this._onLoadingError,n),n}return(new dojo.Deferred).resolve()},f.prototype._assignDefinitionExpressionToExistingLayer=function(e,t,i){var r=m.getProp(t,["layerDefinition","definitionExpression"]);if(r)i.serviceLayer.setDefinitionExpression(r);else if(t.itemId){var n=new dojo.Deferred;return this._loadPortalItem(e,t.itemId,function(e){var t=m.getProp(e,["layers","0","layerDefinition","definitionExpression"]);t&&i.serviceLayer.setDefinitionExpression(t)},this._onLoadingError,n),n}},f.prototype._assignPopupToExistingLayer=function(e,r){var t=e.popupInfo;if(t&&r){if(t.mediaInfos){var i=t.mediaInfos.filter(function(e){return"image"===e.type});if(i&&0<i.length){m.isNullOrUndefined(t.description)&&(t.description="");for(var n=0,s=i;n<s.length;n++){var a=s[n];a.title&&(t.description+='<br/><span style="font-weight: bold">'+a.title+"</span><br/>"),a.value.linkURL?t.description+='<a href="'+a.value.linkURL+'" target="_blank"><img src="'+a.value.sourceURL+'" alt="'+a.title+'"></img></a><br/>':t.description+='<img src="'+a.value.sourceURL+'" alt="'+a.title+'"></img>'}}var o=t.mediaInfos.filter(function(e){return"barchart"===e.type||"columnchart"===e.type||"linechart"===e.type||"piechart"===e.type});if(o&&0<o.length)for(var l=0;l<o.length;l++){var c=o[l];if("barchart"===c.type||"columnchart"===c.type||"linechart"===c.type||"piechart"===c.type){var u="piechart"===c.type?"Pie":"Linear",p=new y.LayerChart({id:c.title||"Chart "+(l+1),displayName:c.title||"Chart "+(l+1),chartFeatureType:g.ChartFeatureType.SingleFeature,chartDefinition:{area:{background:[255,255,255,1],enableColorPalette:!0,enableCommonSeriesRange:!0,showToolTips:!0,showLabels:!1},category:{axis:{title:"",visible:!0},field:{name:r.displayField?r.displayField.name:r.primaryKeyField.name,displayName:r.displayField?r.displayField.displayName:r.primaryKeyField.displayName}},caption:c.caption,chartType:u,flipChart:"barchart"===c.type,series:c.value.fields.map(function(t,e){var i=_.firstOrDefault(r.fields.filter(function(e){return e.name===t}));return{axis:{title:"",showLabels:!0,showTicks:!0,visible:0===e},displayName:t,field:{name:t,displayName:t},title:i?i.alias||i.name:t}}),visible:!0},defaultChart:!0},r);p.caption=c.caption,r.charts.push(p)}}}if(t.description&&(r.featureDescription||(r.featureDescription=t.description),r.featureLongDescription||(r.featureLongDescription=t.description)),t.title&&(r.featureLabel=t.title),t.expressionInfos&&0<t.expressionInfos.length)for(var h=0,d=t.expressionInfos;h<d.length;h++){var f=d[h];r.arcadeExpressions.push({token:"expression/"+f.name,expression:f.expression})}r.showMapTips||(r.showMapTips=!0),r.identifiable||(r.identifiable=!0)}},f.prototype._addLayerToMap=function(t){var i=new dojo.Deferred,e=null;switch(t.type){case"CSV":var r=new dojo._Url(window.location.href),n=new dojo._Url(t.url);r.host===n.host&&r.port===n.port&&r.scheme===n.scheme||(t.url=esri.config.defaults.io.proxyUrl+t.url),c.LayerUtilities.createFeatureLayerFromCsv(t,null).then(function(e){e&&e.setVisibility&&e.setVisibility(t.visibility),i.resolve(e)},function(e){i.reject(e)});break;case"GeoRSS":var s=new u.GeoRssLayerService(t.url);s.essentialsMap=this.site.essentialsMap;var a={displayName:t.title,serviceType:p.MapServiceType.GEORSS,connectionString:"url="+t.url,feedImageUri:t.pointSymbol?t.pointSymbol.url:null,opacity:t.opacity,id:t.id||m.alphaNumericToken(),visible:t.visibility};s._configureObject(a),i.resolve(s);break;case"WebTiledLayer":if(!t.wmtsInfo&&esri.layers&&esri.layers.WebTiledLayer){var o={id:t.id,subDomains:t.subDomains,copyright:t.copyright};e=new esri.layers.WebTiledLayer(t.templateUrl,o),t.title&&(e.name=t.title)}i.resolve(e);break;case"WMS":i.resolve(null);break;default:var l=[];t.url||t.featureCollection&&l.push(this._createMarkupFromFeatureCollection(t,t.title)),i.resolve(l)}return i.promise},f.prototype._createMarkupFromFeatureCollection=function(e,t){for(var i=v.getInternalGraphicsLayer(t,this.site,v.GraphicsLayerType.Markup,!0),r=[],n=0,s=e.featureCollection.layers;n<s.length;n++){var a=s[n],o=m.getProp(a,["layerDefinition","drawingInfo","renderer"]),l=void 0;o&&(l=esri.renderer.fromJson(o),a.layerDefinition.drawingInfo.renderer=l.toJson());var c=m.getProp(a,["featureSet","features"]);if(c){for(var u=v.featureTypeSelector[a.featureSet.geometryType],p=0,h=c;p<h.length;p++){var d=h[p],f=new esri.Graphic(esri.geometry.fromJson(d.geometry),null,d.attributes,null);if(l){var y=d.symbol?esri.symbol.fromJson(d.symbol):l.getSymbol(f);"textsymbol"===y.type&&u===v.FeatureCollectionType.Point&&(u=v.FeatureCollectionType.Text),f.setSymbol(y)}i.add(f)}r.push(u),a.featureSet.features=[]}}return this.agolSchemas[i.id]={webMapLayer:e,featureTypes:r},i},f.prototype._configureObject=function(e,t,i){if(void 0===i&&(i=!0),void 0===e||void 0===e.id)throw new Error("Incorrect Web Map reference object returned from initialization");this._isFinalReference=i,this.displayName=e.displayName,this.id=e.id,t&&(this.isInitialized=!0),this._initializeWebMap(e,this.site,function(e){},function(e){throw e})},f._hasAgolRenderers=!1,f._rendererPromises=[],f);function f(e){var t=r.call(this,e)||this;return t.displayName=null,t.id=null,t.agolSchemas={},t._isLoading=!1,t._onLoadingComplete=null,t._onLoadingError=null,t._layerTypes=null,t._isFinalReference=!1,t._arcgisSharingRegularExpressions=[new RegExp("(https?://.*?/)home/item.html\\?id=(\\w*)"),new RegExp("(https?://.*?/)home/webmap/viewer.html\\?webmap=(\\w*)"),new RegExp("(https?://.*?/)explorer/\\?open=(\\w*)"),new RegExp("(https?://.*?/sharing)/content/items/(\\w*)/data"),new RegExp("(https?://.*?/sharing)/content/items/(\\w*)")],t.site=null,t}t.WebMapReference=n})},"geocortex/essentials/WFSLayerService":function(){var r,o=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)});define(["require","exports","./MapService","./RestHelperHTTPService"],function(e,t,i,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n,s=(n=i.MapService,o(a,n),a.prototype._configureWFSSettings=function(e){var t=this.serviceUrl.indexOf("?");if(this.baseUrl=-1<t?this.serviceUrl.substring(0,t):this.serviceUrl,this.layers.length<1||!this.layers[0].wfsLayerName)throw new Error("Failed to initialize WFS layer. Layer name or layer not defined.");var i=this.layers[0].wfsLayerName.split(":")[1],r={url:this.baseUrl,name:i,layerName:i,mode:this._defaultWFSLayerMode,swapXY:!1,swapXYFilter:!1,version:"1.0.0"};e&&(e.version&&(r.version=e.version),e.spatialReference?r.wkid=this.operationalSpatialReference=e.spatialReference.wkid:e.operationalSpatialReference&&(r.wkid=this.operationalSpatialReference=e.operationalSpatialReference),e.mode&&(r.mode=e.mode),e.customParameters&&(r.customParameters=e.customParameters),e.infoTemplate&&(r.infoTemplate=e.infoTemplate));var n=e.properties&&e.properties.filter(function(e){return"maxFeatures"===e.name})[0]||null,s=e.maxFeatures||n&&n.value||null;(s=parseInt(s,10))&&!isNaN(s)?r.maxFeatures=s:r.maxFeatures=r.mode===this._defaultWFSLayerMode?this._defaultMaxFeaturesInSnapshotMode:this._defaultMaxFeaturesInOnDemandMode,this._WFSLayerOptions=r},a.prototype._configureObject=function(e,t){if(void 0===e)throw new Error("Incorrect map service object returned from initialization");this._restWFSConfigObject=e,n.prototype._configureObject.call(this,e,t)},a.prototype._createServiceLayer=function(){var t=this;this._configureWFSSettings(this._restWFSConfigObject),this.serviceToken&&(this._WFSLayerOptions.url=r.RestHelperHTTPService.appendTokenToUrl(this.serviceUrl,this.serviceToken));var i=new esri.layers.WFSLayer(this._WFSLayerOptions);i.id=this.id,this.serviceLayer=i,dojo.connect(i,"onError",dojo.hitch(this,this._layerLoadErrorHandler)),dojo.connect(i,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded)),i.initialize(this._WFSLayerOptions,function(e){i.selectLayer(t._WFSLayerOptions,function(e){t._initiallyVisible&&t.layers[0].configuredVisible?i.show():i.hide(),t.attributionDataUrl&&""!==t.attributionDataUrl?(i.attributionDataUrl=t.attributionDataUrl,i.hasAttributionData=!0):t.hasAttributionData&&(i.attributionDataUrl=t.url+"/Attribution",i.hasAttributionData=!0),i.onLoad(i)})}),n.prototype.initiateServiceFailureTimer.call(this)},a);function a(){var e=null!==n&&n.apply(this,arguments)||this;return e._WFSLayerOptions=null,e._defaultMaxFeaturesInOnDemandMode=500,e._defaultMaxFeaturesInSnapshotMode=1e3,e._defaultWFSLayerMode="snapshot",e}t.WFSLayerService=s})},"geocortex/essentials/Workflow":function(){var r,a=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)});define(["require","exports","./AsyncInitializable","./../workflow/ArgumentInfo","./../workflow/ExternalActivityInfo","./../geocortex"],function(e,t,i,o,l,c){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r,n=(r=i.AsyncInitializable,a(s,r),s.prototype.getInputs=function(){return this._cloneArgumentInfoCollection(this._inputs)},s.prototype.getOutputsMetadata=function(){return this._cloneArgumentInfoCollection(this._outputs)},s.prototype._cloneArgumentInfoCollection=function(e){var t=null;if(null!==e){t=[];for(var i=0;i<e.length;i++)t.push(e[i]._internalClone())}return t},s.prototype._configureObject=function(e,t){if(void 0===e.id||void 0===e.displayName)throw new Error("Incorrect workflow object returned from initialization");var i,r;if(this.id=e.id,this.displayName=e.displayName,this.runOnStartup=!!e.runOnStartup,this.error=e.error,this._inputs=[],this._outputs=[],this.externalActivities=[],e.inputs)for(var n=0;n<e.inputs.length;n++)i=e.inputs[n],(r=new o.ArgumentInfo)._configureObject(i),this._inputs[n]=r;if(e.outputs)for(n=0;n<e.outputs.length;n++)i=e.outputs[n],(r=new o.ArgumentInfo)._configureObject(i),this._outputs[n]=r;if(e.externalActivities)for(n=0;n<e.externalActivities.length;n++){var s=e.externalActivities[n],a=new l.ExternalActivityInfo;a._configureObject(s),this.externalActivities[n]=a}this.properties=c._getProperties(e.properties),this.extensions=c._getExtensions(e.extensions)},s);function s(e){var t=r.call(this,e)||this;return t.displayName=null,t.error=null,t.extensions=[],t.externalActivities={},t.id=null,t.properties={},t.site=null,t._inputs=[],t._outputs=[],t}t.Workflow=n})},"geocortex/essentials/XmlUtils":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseObject=function i(e){if(e)try{if(3===e.nodeType||4===e.nodeType){var t=String.prototype.trim?e.nodeValue.trim():dojo.string.trim(e.nodeValue);return 0===t.length?null:t}if(1===e.nodeType){var r={},n=0;dojo.forEach(e.attributes,function(e){r[e.nodeName]=e.nodeValue});var s=e.childNodes;return dojo.forEach(s,function(e){var t=i(e);t&&(n++,r[e.nodeName]?(!1===dojo.isArray(r[e.nodeName])&&(r[e.nodeName]=[r[e.nodeName]]),r[e.nodeName].push(t)):r[e.nodeName]=t)}),1===n&&r["#text"]?r["#text"]:1===n&&r["#cdata-section"]?r["#cdata-section"]:r}}catch(e){throw new Error("Unable to parse XML object: "+e.toString())}return null},t.getAllNodes=function(e){var t=new dojo.NodeList;if(dojo.isIE)for(var i=e.childNodes,r=0;r<i.length;r++)t.push(i[r]);else t=dojo.query("*",e);return t},t.getNodes=function(e,i,t){var r=new dojo.NodeList;if(dojo.isIE){var n=t.getElementsByTagName(e);dojo.forEach(n,function(e){var t=e.getElementsByTagName(i);dojo.forEach(t,function(e){r.push(e)})})}else r=dojo.query(e+" > "+i,t);return r},t.getValue=function(e,t){if(e){var i;if("string"==typeof e){var r=e.split(" > ");i=this.getNodes(r[0],r[1],t)[0]}else i=e;return i.firstChild&&i.firstChild.nodeValue?i.firstChild.nodeValue:"Node not valid"}return"No Value"},t.getAttribute=function(e,t){if(e){if(dojo.isIE){for(var i=0;i<e.attributes.length;i++)if(e.attributes[i].nodeName===t)return e.attributes[i].nodeValue;return null}return e.getAttribute(t)}return"No Value"}})},"geocortex/essentials/catalog/CatalogEntry":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});function i(){this.id=null,this.displayName=null,this.entries=null,this.type=null,this.entries=[]}t.CatalogEntry=i})},"geocortex/essentials/catalog/LayerCatalogDetail":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});function i(){this.mapServiceId=null,this.entries=null,this.entries=[]}t.LayerCatalogDetail=i})},"geocortex/essentials/catalog/LayerCatalogDetailEntry":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/catalog/LayerCatalogDetailsParams":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});function i(){this.ids=null,this.ids=[]}t.LayerCatalogDetailsParams=i})},"geocortex/essentials/catalog/LayerCatalogParams":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});function i(){}t.LayerCatalogParams=i})},"geocortex/essentials/documents/BatchRequestBuilder":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.cloneDocument=function(e,t,i){return{action:"cloneDocument",id:e,document:t,createOnly:i}},t.createDocument=function(e,t){return{action:"createDocument",document:e,streamId:t}},t.createMoniker=function(e,t){return{action:"createMoniker",moniker:e,createOnly:t}},t.deleteDocument=function(e){return{action:"deleteDocument",id:e}},t.deleteMoniker=function(e){return{action:"deleteMoniker",id:e}},t.describe=function(e){return{action:"describe",streamId:e}},t.generateLinks=function(e){return{action:"generateLinks",count:e}},t.modifyDocument=function(e,t){return{action:"modifyDocument",document:e,streamId:t}},t.openDocument=function(e,t,i){return{action:"openDocument",id:e,streamId:t,startPosition:i}},t.peekDocument=function(e,t){return void 0===t&&(t=!1),{action:"peekDocument",id:e,throwIfMissing:t}},t.peekDocumentAccess=function(e){return{action:"peekDocumentAccess",id:e}},t.peekMoniker=function(e,t){return{action:"peekMoniker",id:e,throwIfMissing:t}},t.peekMonikerAccess=function(e){return{action:"peekMonikerAccess",id:e}},t.previewDocument=function(e,t){return{action:"previewDocument",id:e,streamId:t}},t.previewMoniker=function(e,t){return{action:"previewMoniker",id:e,streamId:t}},t.readDocument=function(e,t){return{action:"readDocument",id:e,format:t}},t.restoreDocument=function(e){return{action:"restoreDocument",globalId:e}},t.restoreMoniker=function(e){return{action:"restoreMoniker",globalId:e}},t.resumeDocument=function(e,t){return{action:"resumeDocument",globalId:e,streamId:t}},t.scrub=function(e){return{action:"scrub",scrubOptions:e}},t.searchDocuments=function(e){return{action:"searchDocuments",documentQuery:e}},t.searchMonikers=function(e){return{action:"searchMonikers",monikerQuery:e}},t.searchRoles=function(e){return{action:"searchRoles",searchClause:e}},t.searchUsers=function(e){return{action:"searchUsers",searchClause:e}},t.self=function(){return{action:"self"}},t.touchDocument=function(e,t,i){return{action:"touchDocument",id:e,modify:t,throwIfMissing:i}},t.updateDocument=function(e){return{action:"updateDocument",document:e}},t.updateMoniker=function(e){return{action:"updateMoniker",moniker:e}},t.writeDocument=function(e){return{action:"writeDocument",content:e}}})},"geocortex/essentials/documents/Document":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/documents/DocumentConstants":function(){define(["require","exports"],function(e,t){"use strict";var i,r,n,s,a,o,l,c;Object.defineProperty(t,"__esModule",{value:!0}),(i=t.DocumentField||(t.DocumentField={})).AUTHOR_DESCRIPTION="author.description",i.AUTHOR_ISSUER_TITLE="author.issuerTitle",i.AUTHOR_TITLE="author.title",i.DESCRIPTION="description",i.EDITOR_DESCRIPTION="editor.description",i.EDITOR_ISSUER_TITLE="editor.issuerTitle",i.EDITOR_TITLE="editor.title",i.FILE_TYPE="fileType",i.GRANT_TOKEN="grants.token",i.ISSUER_TITLE="issuerTitle",i.TAGS="tags",i.TIME_CREATION="timeOfCreation",i.TIME_LAST_ACCESS="timeOfLastAccess",i.TIME_LAST_MODIFICATION="timeOfLastModification",i.TITLE="title",(r=t.ContentType||(t.ContentType={})).BLOB="application/octet-stream",r.JSON="application/json",r.TEXT="text/plain",r.XML="application/xml",(n=t.DocumentFormat||(t.DocumentFormat={})).BLOB="blob",n.JSON="json",n.TEXT="text",n.XML="xml",(s=t.GrantKind||(t.GrantKind={})).FROZEN="frozen",s.OWNER="owner",s.READER="reader",s.WRITER="writer",s.READER_LINK="readerLink",s.WRITER_LINK="writerLink",s.GLOBAL_CREATE="global_create",s.GLOBAL_READER="global_reader",s.GLOBAL_WRITER="global_writer",(a=t.GrantID||(t.GrantID={})).PUBLIC="public",a.USER="user",(o=t.MonikerKind||(t.MonikerKind={})).LINK="link",o.ROLE="role",o.USER="user",o.POLICY="policy",(l=t.FilterMethod||(t.FilterMethod={})).RANGES="ranges",l.SPATIAL_DISJOINT="spatialDisjoint",l.SPATIAL_INTERSECTS="spatialIntersects",l.SPATIAL_WITHIN="spatialWithin",l.MATCHES="matches",l.VALUES="values",(c=t.FilterType||(t.FilterType={})).REQUIRE="require",c.EXCLUDE="exclude",c.INCLUDE="include"})},"geocortex/essentials/documents/DocumentStore":function(){define(["require","exports","./DocumentConstants","./../utilities/UrlUtilities","./../../geocortex","./BatchRequestBuilder"],function(e,t,a,i,n,c){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s="{0}_exact";t.LINK_QUERY_STRING_KEY="link";var r=(o.prototype.initialize=function(e){this._site=e;var t=/^(.*?)(\/*)$/.exec(e.originalUrl)[1];return this._rootUrl=i.UrlUtilities.simplify(t+"/../../documents"),this.supported=4.05<=e.getEssentialsVersion(),this.onInitializeAttempt()},o.prototype.onInitialized=function(){return this._initializeDeferred.promise},o.prototype.onInitializeAttempt=function(){var t=this;if(this._initializeAttemptThenable)return this._initializeAttemptThenable;if(this.supported)return this._initializeAttemptThenable=n.request({url:this._rootUrl+"/self",content:{f:"json"},handleAs:"json"},{usePost:!1}).then(o._processError).then(function(e){t._processSelf(e),t.isInitialized=!0,t._initializeDeferred.resolve()}).then(null,function(e){throw t._initializeAttemptThenable=null,e});var e=new Error("The Document Store is not supported in the current version of Essentials.");return this._initializeDeferred.reject(e),this._initializeAttemptThenable=(new dojo.Deferred).reject(e)},o.prototype.getRootUrl=function(){return this._verifySupported(),this._rootUrl+"/"},o.prototype.canCreate=function(){return 0<this.userMonikers.length},o.prototype.hasPolicyGrant=function(t){return this.policyMonikers.some(function(e){return e.grants.some(t)})},o.prototype.add=function(e){var t=this,i={document:dojo.mixin({},e)};void 0!==e.content&&(i.json=e.content,delete i.document.content);var r=c.writeDocument(i);return this.perform(r,!0).then(function(e){return e.document}).then(function(e){return t._processDocument(e)})},o.prototype.addFromFormData=function(e){throw new Error("Not implemented.")},o.prototype.addFromForm=function(e){throw new Error("Not implemented.")},o.prototype.getById=function(e,t,i){var r=this;if(void 0===t&&(t=!1),void 0===i&&(i=a.DocumentFormat.JSON),this._verifyDocId(e),t){var n=c.readDocument(e,i);return this.perform(n).then(function(e){return o._processReadDocumentResponse(e,i)}).then(function(e){return r._processDocument(e)})}var s=c.peekDocument(e);return this.perform(s).then(function(e){return e.document}).then(function(e){return r._processDocument(e)})},o.prototype.getContentUrl=function(e){throw new Error("Not implemented.")},o.prototype.updateById=function(e,t){var i=this;this._verifyDocId(e),t.timeOfLastModification||(t.timeOfLastModification=null),t.editor||(t.editor=null);var r=[];for(var n in t)t.hasOwnProperty(n)&&r.push(n);if(void 0!==t.content){var s={json:t.content};delete t.content,s.document=dojo.mixin({id:e,updates:r},t);var a=c.writeDocument(s);return this.perform(a,!0).then(function(e){return e.document}).then(function(e){return i._processDocument(e)})}var o=dojo.mixin({id:e,updates:r},t),l=c.updateDocument(o);return this.perform(l,!0).then(function(e){return e.document}).then(function(e){return i._processDocument(e)})},o.prototype.deleteById=function(e){var t=this;this._verifyDocId(e);var i=c.deleteDocument(e);return this.perform(i,!0).then(function(e){return e.document}).then(function(e){return t._processDocument(e)})},o.prototype.query=function(e){var t=this,i=dojo.mixin({},e);i.sort&&i.sort.forEach(function(t,e,i){o.matchesFilterFields.some(function(e){return e===t})&&(i[e]=s.format(t))}),i.sortDescending&&i.sortDescending.forEach(function(t,e,i){o.matchesFilterFields.some(function(e){return e===t})&&(i[e]=s.format(t))});var r=c.searchDocuments(i);return this.perform(r).then(function(e){return Array.isArray(e.matchingDocuments.results)&&e.matchingDocuments.results.forEach(function(e){return t._processDocument(e.entity)}),e.matchingDocuments})},o.prototype.perform=function(e,t){var i=this;if(void 0===t&&(t=!1),!e.action)throw new Error("The Document Store batch request does not contain an action");var r=e.action;return"perform"!==r&&delete e.action,this._guestLink&&(e.link=this._guestLink),e.f="json",this.onInitializeAttempt().then(function(){return i._verifySupported()}).then(function(){return n.request({url:i._rootUrl+"/"+r,content:n.encodeJson(e),handleAs:"json"},{usePost:t})}).then(o._processError)},o.prototype.isOwner=function(e){return!e||!e.access||e.access.change},o.prototype.isReadOnly=function(e){return!(!e||!e.access||!e.access.view||e.access.edit||e.access.change)},o.prototype.isPublic=function(e){return!!(e&&e.id&&e.grants)&&e.grants.some(function(e){return e.globalId===a.GrantID.PUBLIC&&(!1===e.revoke||!0===e.assert)})},o.prototype.setGuestLink=function(e){this._guestLink=e},o._processError=function(e){if(e.error)throw e.error;return e},o.prototype._processDocument=function(e){return e.timeOfCreation&&(e.timeOfCreation=new Date(e.timeOfCreation)),e.timeOfLastAccess&&(e.timeOfLastAccess=new Date(e.timeOfLastAccess)),e.timeOfLastModification&&(e.timeOfLastModification=new Date(e.timeOfLastModification)),e.timeOfDeletion&&(e.timeOfDeletion=new Date(e.timeOfDeletion)),e.timeOfExpiration&&(e.timeOfExpiration=new Date(e.timeOfExpiration)),e.access&&!e.access.monikerIds&&(e.access.monikerIds=this.userMonikers.map(function(e){return e.id})),e},o._processReadDocumentResponse=function(e,t){var i=e.content.document;return i.content=e.content[t],i},o.prototype._processSelf=function(e){if(this.self=e.monikers,this.userMonikers=e.monikers.filter(function(e){return e.kind===a.MonikerKind.USER}),this.policyMonikers=e.monikers.filter(function(e){return e.kind===a.MonikerKind.POLICY}),0<this.userMonikers.length){var t=this.userMonikers.map(function(e){return{string:"{0}|{1}".format(a.GrantKind.OWNER,e.globalId)}});this.userFilter={field:a.DocumentField.GRANT_TOKEN,method:a.FilterMethod.VALUES,range:t}}},o.prototype._verifyDocId=function(e){if(!e)throw new Error("The Document ID must be set.");if(/[/?#\s]/.test(e))throw new Error("The Document ID '{0}' contains illegal characters.".format(e))},o.prototype._verifySupported=function(){if(!this.supported)throw new Error("The Document Store is not supported in the current version of Essentials.")},o.matchesFilterFields=[a.DocumentField.TITLE,a.DocumentField.DESCRIPTION,a.DocumentField.ISSUER_TITLE,a.DocumentField.AUTHOR_TITLE,a.DocumentField.AUTHOR_DESCRIPTION,a.DocumentField.AUTHOR_ISSUER_TITLE,a.DocumentField.EDITOR_TITLE,a.DocumentField.EDITOR_DESCRIPTION,a.DocumentField.EDITOR_ISSUER_TITLE],o);function o(){this._initializeDeferred=new dojo.Deferred,this.supported=!1,this.isInitialized=!1,this.self=[],this.userMonikers=[],this.policyMonikers=[],this.userFilter={}}t.DocumentStore=r})},"geocortex/essentials/documents/Parameters":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/exportMap/BingEnvironment":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PRODUCTION="Production"})},"geocortex/essentials/exportMap/ExportContext":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/exportMap/ExportDynamicMapLayerDefinition":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/exportMap/ExportFeature":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/exportMap/ExportFeatureCollection":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/exportMap/ExportLayer":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/exportMap/ExportLayerFeatureSet":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/exportMap/ExportLayoutOptions":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/exportMap/ExportMapLayerDefinition":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/exportMap/ExportMapOptions":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/exportMap/ExportMapParameters":function(){define(["require","exports","./../ReportParameters"],function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});function r(){this.operationParameters=null,this.reportParameters=null,this.queryParameters=null,this.operationParameters={},this.reportParameters=new i.ReportParameters}t.ExportMapParameters=r})},"geocortex/essentials/exportMap/ExportMapService":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/exportMap/ExportMapTask":function(){define(["require","exports","./../FeatureLayerService","./../../geocortex","./../utilities/UrlUtilities","./../utilities/PrintUtilities","./../utilities/PromiseUtilities","./ExportMapTypes","./BingEnvironment","./../ReportParameters","./../utilities/GraphicsLayerUtilities","./../Field","./../WebmapLayerType","geocortex/framework/utils/utils","../LayerType"],function(e,t,d,n,T,E,I,r,s,h,a,o,f,b,y){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=(l.prototype._populateFromResource=function(e){e.hasOwnProperty("extentManager")?(this._esriMap=e.getMap(),this._essentialsRestUrl=e.url+"/export",this._site=e.site):e.hasOwnProperty("maximumResolution")?(this._esriMap=e.site.getMap(),this._essentialsRestUrl=e.url+"/print",this._site=e.site):e&&(this._esriMap=e.site.getMap(),this._essentialsRestUrl=e.url+"/run",this._site=e.site)},l.prototype.generateMapImageUrl=function(e){var i=this,r=new dojo.Deferred;return this._marshalContent(e).then(function(e){var t={url:i._essentialsRestUrl,content:e,load:r.resolve,error:r.reject,callbackParamName:"CallBack"};n.request(t)}),r},l.prototype.generateWebMapJson=function(e){var t,r=this,n=new dojo.Deferred;e.reportParameters&&e.reportParameters.scale&&(t=parseFloat(e.reportParameters.scale.scale));var i=new esri.tasks.PrintTask("http://3275ec4b-ad36-465e-97e9-a20acaae8d53/",{async:!1}),s=null;try{s=this._getWebMap(i,this._esriMap,t)}catch(e){n.reject(new Error("Could not create ExportContext definition. {0} Verify that subroutines have not changed.".format(e&&e.message?e.message:"Unable to determine cause.")))}return s.mapOptions.spatialReference&&s.mapOptions.spatialReference.wkid||!this._esriMap.spatialReference||!this._esriMap.spatialReference.wkid||(s.mapOptions.spatialReference=this._esriMap.spatialReference),s&&s.operationalLayers?new dojo.DeferredList(s.operationalLayers.map(function(e){return r._inferLayerType(e)})).then(function(e){for(var i=s.operationalLayers,t=0;t<i.length;t++)i[t].layerType=e[t][1];r._handleOperationalLayers(s).then(function(){for(var e=0;e<i.length;e++)if(!i[e].layerType){var t=i.splice(e,1)[0];console.warn("Removed layer from the map definition because it's type could not be inferred. Layer JSON:\n"+JSON.stringify(t,null,4)),e--}n.resolve(s)})}):n.reject(new Error("ExportContext definition was empty")),n},l.prototype._getWebMap=function(e,t,i){var r=new esri.tasks.PrintTemplate;((r.outScale=i)<t.getMaxScale()||i>t.getMinScale())&&(r.preserveScale=!1);for(var n=[],s=0,a=t.graphicsLayerIds;s<a.length;s++){var o=a[s];1===(u=t.getLayer(o)).opacity&&(u.setOpacity(.999),n.push(u))}try{return e._getPrintDefinition(t,r)}finally{for(var l=0,c=n;l<c.length;l++){var u;(u=c[l]).setOpacity(1)}}},l.prototype._getPrintingObjectForEssentials=function(e){var t=new dojo.Deferred,i=new esri.tasks.PrintTask("http://3275ec4b-ad36-465e-97e9-a20acaae8d53/",{async:!1}),r=null;try{r=this._getWebMap(i,this._esriMap,e)}catch(e){t.reject(new Error("Could not create ExportContext definition. {0} Verify that subroutines have not changed.".format(e&&e.message?e.message:"Unable to determine cause.")))}return r?(this._removeInternalLayers(r),this._handleFeatureLayers(r),this._handleDynamicLayerDefs(r),this._cleanOutVisibility(r),this._handleWebTiledLayers(r),this._handleLayersAttribution(r,this._esriMap),this._handleHeatmapRenderer(r,this._esriMap),this._handleClusters(r,this._esriMap),this._adjustMeasurementsMarkup(r),this._adjustPlotCoordinatesMarkup(r),this._removeAttributes(r),this._adjustText(r),this._setServiceVisibilities(r),this._adjustPlotCoordinatesMarkupOrder(r),this._finalizePrintingContext(r),this._convertSymbolsToBase64(r).then(function(e){return t.resolve(e)},function(e){return t.reject(new Error("Converting symbols to base64 failed: {0}".format(e&&e.message?e.message:"Unable to determine cause")))})):t.reject(new Error("ExportContext definition was empty")),t},l.prototype._removeInternalLayers=function(e){for(var t=e.operationalLayers.length-1;0<=t;t--){var i=e.operationalLayers[t].id;i&&-1<a.getGraphicsLayerIdsToExclude([a.excludeFromExportMapTaskName]).indexOf(i)&&e.operationalLayers.splice(t,1)}},l.prototype._convertSymbolsToBase64=function(t,o){void 0===o&&(o=!0);for(var i=new dojo.Deferred,l=[],c={},e=0,r=t.operationalLayers;e<r.length;e++){var n=r[e];if(n.featureCollection&&n.featureCollection.layers)for(var s=0,a=n.featureCollection.layers;s<a.length;s++){var u=a[s];if(u.featureSet&&u.featureSet.features)for(var p=0,h=u.featureSet.features;p<h.length;p++){var d=h[p];if(d&&d.symbol&&"esriPMS"===d.symbol.type){var f=d.symbol;f.url&&l.push(f)}}}}if(Modernizr&&Modernizr.canvas){for(var y=[],m=0,v=l;m<v.length;m++)if((b=(L=v[m]).url)&&!c.hasOwnProperty(b)&&!L.imageData){c[b]={url:null,data:null};var g=E.PrintUtilities.getImageAsBase64(b);y.push(g)}I.PromiseUtilities.settle(y).then(function(e){e.forEach(function(e){if(e.isFulfilled()){var t=e.value();t&&t.url&&t.data&&(c[t.url]={data:t.data})}else{var i=e.reason();i&&i.url&&(c[i.url]={url:T.UrlUtilities.simplify(i.url)})}for(var r=0,n=l;r<n.length;r++){var s=n[r],a=c[s.url];a&&(a.data?(s.imageData=a.data,delete s.url):a.url&&(s.url=a.url)),s.yoffset&&o&&(s.yoffset=-1*s.yoffset)}}),i.resolve(t)})}else{for(var _=0,S=l;_<S.length;_++){var L,b;(b=(L=S[_]).url)&&(L.url=T.UrlUtilities.simplify(b))}i.resolve(t)}return i},l.prototype._adjustMeasurementsMarkup=function(e){var t=this._getLayer(e,"_measurement");t&&t.id&&this._adjustSvgSymbols(t)},l.prototype._adjustMeasurementsMarkupForGP5=function(e){var t=this._getLayer(e,"_measurement");t&&t.id&&this._adjustSvgSymbolsForGP5(t)},l.prototype._adjustPlotCoordinatesMarkup=function(e){var t=this._getLayer(e,"_coordinates");t&&t.id&&this._adjustSvgSymbols(t)},l.prototype._adjustPlotCoordinatesMarkupForGP5=function(e){var t=this._getLayer(e,"_coordinates");t&&t.id&&this._adjustSvgSymbolsForGP5(t)},l.prototype._adjustPlotCoordinatesMarkupOrder=function(e){var t=this._getLayer(e,"_coordinates");if(t&&t.featureCollection&&t.featureCollection.layers)for(var i=null,r=null,n=0,s=t.featureCollection.layers;n<s.length;n++){var a=s[n];if(a.layerDefinition&&("pointLayer"===a.layerDefinition.name?i=a:"textLayer"===a.layerDefinition.name&&(r=a)),i&&r){if(i.featureSet&&i.featureSet.features&&0<i.featureSet.features.length&&r.featureSet&&r.featureSet.features&&0<r.featureSet.features.length&&r.featureSet.features.length/i.featureSet.features.length==1.5){for(var o=[];0<i.featureSet.features.length;)o.push(r.featureSet.features.pop()),o.push(r.featureSet.features.pop()),o.push(r.featureSet.features.pop()),o.push(i.featureSet.features.pop()),o.push(i.featureSet.features.pop());i.featureSet.features=o.reverse()}break}}},l.prototype._getLayer=function(e,t){for(var i=0,r=e.operationalLayers;i<r.length;i++){var n=r[i];if(n&&n.id&&-1<n.id.indexOf(t)&&n.featureCollection&&n.featureCollection.layers)return n}},l.prototype._adjustSvgSymbols=function(e){for(var t=e.id,i=[],r=0,n=this._esriMap.getLayer(t).graphics.filter(function(e){return!("simplemarkersymbol"!==e.symbol.type||!e.visible)});r<n.length;r++){var s=n[r];i.push(s.toJson())}for(var a=0,o=e.featureCollection.layers;a<o.length;a++){var l=o[a];if("pointLayer"===l.layerDefinition.name){l.featureSet.features=i;break}}},l.prototype._adjustSvgSymbolsForGP5=function(e){var t,i=e.id,r=e.featureCollection;if(r&&r.layers&&r.layers.length){var n=r.layers.filter(function(e){return"pointLayer"===e.layerDefinition.name});if(!n.length)return;var s=n[0];t=s.featureSet?s.featureSet.features:void 0}for(var a=[],o=0,l=this._esriMap.getLayer(i).graphics.filter(function(e){return!("simplemarkersymbol"!==e.symbol.type||!e.visible)});o<l.length;o++){var c=l[o];a.push(c.toJson())}for(var u=0;u<t.length;u++){var p=a[u].symbol;p.size||(p.size=t[u].symbol.width)}for(var h=0,d=e.featureCollection.layers;h<d.length;h++){var f=d[h];"pointLayer"===f.layerDefinition.name&&(f.featureSet.features=a)}},l.prototype._adjustText=function(e){for(var t=0,i=e.operationalLayers;t<i.length;t++){var r=i[t];if(r&&r.id&&r.featureCollection&&r.featureCollection.layers){for(var n=!1,s=0,a=r.featureCollection.layers;s<a.length;s++)if((v=a[s])&&v.layerDefinition&&"textLayer"===v.layerDefinition.name){n=!0;break}if(!n)continue;var o=r.id,l=[],c=this._esriMap.getLayer(o);if(c&&c.graphics){for(var u=0,p=c.graphics.filter(function(e){return!(!("textsymbol"===e.symbol.type||e.symbol instanceof esri.symbol.TextSymbol)||!e.visible)});u<p.length;u++){var h=p[u],d=E.PrintUtilities.adjustTextSymbol(h,c.id);if(d){var f=new esri.Graphic(h.toJson());f.symbol=d,l.push(f.toJson())}}for(var y=0,m=r.featureCollection.layers;y<m.length;y++){var v;"textLayer"===(v=m[y]).layerDefinition.name&&(v.featureSet.features=l)}}}}},l.prototype._setServiceVisibilities=function(e){if(e.operationalLayers)for(var t=0,i=e.operationalLayers;t<i.length;t++){var r=i[t],n=this._esriMap.getLayer(r.id);r&&(r.visibility=!n||n.visible)}},l.prototype._handleDynamicLayerDefs=function(e){if(this._site&&e.operationalLayers)for(var t=0,i=e.operationalLayers;t<i.length;t++){var r=i[t],n=r.id,s=this._site.essentialsMap.findMapServiceById(n);if(s&&s.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer){var a=s.serviceLayer;if(!r)continue;if(r.layers){for(var o=[],l=0,c=r.layers;l<c.length;l++){var u=c[l];if(u&&(u.id||0===u.id)){var p=u.id,h={id:p,name:u.name,geometryType:u.geometryType?u.geometryType:null};if(u.layerDefinition&&((u.layerDefinition.drawingInfo||u.layerDefinition.source)&&(h.layerDefinition||(h.layerDefinition={}),h.layerDefinition.drawingInfo=u.layerDefinition.drawingInfo,h.layerDefinition.source=u.layerDefinition.source),u.layerDefinition.definitionExpression&&(h.layerDefinition?h.layerDefinition.definitionExpression=u.layerDefinition.definitionExpression:h.layerDef=u.layerDefinition.definitionExpression)),p||0===p){var d=s.findLayerById(p.toString());d&&d.displayName&&h.layerDefinition&&(h.layerDefinition.displayName=d.displayName)}o.push(h)}}r.layers=o}a.gdbVersion&&(r.gdbVersion=a.gdbVersion),r.visibleLayers=s.serviceLayer.visibleLayers,r.visibility=!0}}},l.prototype._handleFeatureLayers=function(e){if(this._site&&e.operationalLayers)for(var t=e.operationalLayers,i=0;i<t.length;i++){var r=t[i].id,n=this._site.essentialsMap.findMapServiceById(r);if(n&&n.serviceLayer instanceof esri.layers.FeatureLayer){var s=n.serviceLayer,a=t[i],o={id:r,opacity:a.opacity,visibility:!0,url:a.url,minScale:a.minScale?a.minScale:0,maxScale:a.maxScale?a.maxScale:0};s.gdbVersion&&(o.gdbVersion=s.gdbVersion),a.layerDefinition?(a.layerDefinition.drawingInfo&&(o.drawingInfo=a.layerDefinition.drawingInfo),a.layerDefinition.definitionExpression&&(o.where=a.layerDefinition.definitionExpression)):o.where=s.getDefinitionExpression(),o.featureCollection=a.featureCollection,t[i]=o}}},l.prototype._cleanOutVisibility=function(e){if(e.operationalLayers)for(var t=0,i=e.operationalLayers;t<i.length;t++){var r=i[t];if(r.visibleLayers&&0<r.visibleLayers.length)for(var n=r.visibleLayers.length-1;0<=n;n--)-1==r.visibleLayers[n]&&r.visibleLayers.splice(n,1)}},l.prototype._handleWebTiledLayers=function(e){if(e.operationalLayers)for(var t=e.operationalLayers,i=0;i<t.length;i++)t[i].type===r.WEBTILED?t[i]={id:t[i].id,opacity:t[i].opacity,visibility:!0}:t[i].type!==r.BINGAERIAL&&t[i].type!==r.BINGAERIALLABELS&&t[i].type!==r.BINGHYBRID&&t[i].type!==r.BINGROADS||(t[i].type===r.BINGAERIALLABELS&&(t[i].type=r.BINGHYBRID),t[i]={id:t[i].id,opacity:t[i].opacity,visibility:!0,type:t[i].type,token:t[i].key,serverType:s.PRODUCTION})},l.prototype._handleLayersAttribution=function(e,a){var o=a.layerIds.concat(a.graphicsLayerIds),l=new RegExp(".*mapservices/([^/]*)/Attribution[^/]*");e.operationalLayers.forEach(function(e){for(var t in o)if(o.hasOwnProperty(t)){var i=o[t];if(e.id===i){var r=a.getLayer(i);if(r.hasAttributionData&&r.attributionDataUrl){var n=l.exec(r.attributionDataUrl);if(n&&1<n.length){var s=n[1];e.mapServiceId=s}}else!r.layerId||-1<e.id.indexOf("-")||(e.mapServiceId=r.layerId);break}}})},l.prototype._handleHeatmapRenderer=function(d,f){f.layerIds.concat(f.graphicsLayerIds).forEach(function(e){var t=f.getLayer(e);if(t.visible&&void 0!==t.renderer&&t.renderer instanceof esri.renderer.HeatmapRenderer)for(var i=null!==t.opacity&&void 0!==t.opacity?t.opacity:1,r=t.minScale?t.minScale:0,n=t.maxScale?t.maxScale:0,s=t.getDefinitionExpression()?t.getDefinitionExpression():"",a=t.gdbVersion?t.gdbVersion:"",o=t.renderer.toJson(),l=t.url,c=t.renderer.field?t.renderer.field:"",u={renderer:o},p={type:"HeatMap",id:e,opacity:i,minScale:r,maxScale:n,where:s,gdbVersion:a,url:l,layerDefinition:{name:t.name,geometryType:"esriGeometryPoint",displayField:c},drawingInfo:u},h=0;h<d.operationalLayers.length;h++)if(d.operationalLayers[h].id.startsWith("null_image")){d.operationalLayers[h]=p;break}})},l.prototype._handleClusters=function(_,S){var e=S.layerIds.concat(S.graphicsLayerIds),L="-cluster",r=[];_.operationalLayers.forEach(function(e,t,i){(e.id.endsWith(L)||e.id.endsWith("-explodedClusterLayer"))&&r.push(e.id)}),r.forEach(function(e){for(var t=0;t<_.operationalLayers.length;++t)if(_.operationalLayers[t].id===e){_.operationalLayers.splice(t,1);break}}),e.forEach(function(e){var t=S.getLayer(e);if(t.id.endsWith(L)&&t.visible&&void 0!==t.renderer&&t.renderer instanceof esri.renderer.ClassBreaksRenderer&&t.featureLayer&&t.singleFeatureLayer){for(var i=t.featureLayer,r=i.id,n=t.url,s=t.renderer.attributeField,a=t.clusterRadius.get(),o=t.maxFeaturesInCluster.get(),l=t._clusterLabelColor,c=t.singleFeatureLayer.renderer.toJson(),u=t.renderer.toJson(),p=i.name,h=null!==i.opacity&&void 0!==i.opacity?i.opacity:1,d=i.minScale?i.minScale:0,f=i.maxScale?i.maxScale:0,y=i.getDefinitionExpression()?i.getDefinitionExpression():"",m=i.gdbVersion?i.gdbVersion:"",v=0;v<_.operationalLayers.length;++v)if(_.operationalLayers[v].id===r){null===i.renderer&&_.operationalLayers.splice(v,1);break}var g={type:"Cluster",id:e,opacity:h,minScale:d,maxScale:f,where:y,gdbVersion:m,url:n,layerDefinition:{name:p,geometryType:"esriGeometryPoint",displayField:s},drawingInfo:{renderer:u,singleSymbolRenderer:c,labelColor:l,distance:a,maxFeaturesInCluster:o}};_.operationalLayers.splice(v,0,g)}})},l.prototype._removeAttributes=function(e){if(e.operationalLayers)for(var t=0,i=e.operationalLayers;t<i.length;t++){var r=i[t];if(r&&r.featureCollection&&r.featureCollection.layers)for(var n=0,s=r.featureCollection.layers;n<s.length;n++){var a=s[n];if((!(a&&a.layerDefinition&&a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.renderer)||"uniqueValue"!==a.layerDefinition.drawingInfo.renderer.type&&"classBreaks"!==a.layerDefinition.drawingInfo.renderer.type)&&a&&a.featureSet&&a.featureSet.features)for(var o=0,l=a.featureSet.features;o<l.length;o++){var c=l[o];c&&c.attributes&&delete c.attributes}}}},l.prototype._finalizePrintingContext=function(e){this._fixMapServiceIds(e,this._esriMap,this._site)},l.prototype._fixMapServiceIds=function(e,t,i){if(e.operationalLayers&&t&&i)for(var r=0,n=e.operationalLayers;r<n.length;r++){var s=n[r],a=s.id,o=t.getLayer(a);if(o&&(o instanceof esri.layers.WMSLayer||o instanceof esri.layers.TiledMapServiceLayer)){for(var l=null,c=0;c<i.essentialsMap.mapServices.length;c++)if(i.essentialsMap.mapServices[c].serviceLayer===o){l=i.essentialsMap.mapServices[c];break}l&&(s.id=l.id)}}},l.prototype._fixDisplayNames=function(e,t,i){if(e&&t&&i)for(var r=0,n=e;r<n.length;r++){for(var s=n[r],a=s.id,o=t.getLayer(a),l=null,c=i.essentialsMap.mapServices,u=0;u<c.length;u++)if(c[u].serviceLayer===o){l=c[u];break}l&&(l instanceof d.FeatureLayerService?l.layers&&0<l.layers.length&&(s.title=l.layers[0].displayName):(s.title=l.displayName,"WMS"===l.mapServiceType?this._fixWmsLayerDisplayNames(s.layers,l.layers):this._fixLayerDisplayNames(s.layers,l.layers)))}},l.prototype._fixLayerDisplayNames=function(e,r){if(e&&r)for(var t=function(t){var e=r.filter(function(e){return e.id===t.id.toString()});if(0<e.length){var i=e[0];t.name=i.displayName,t.layers&&n._fixLayerDisplayNames(t.layers,r)}},n=this,i=0,s=e;i<s.length;i++)t(s[i])},l.prototype._fixWmsLayerDisplayNames=function(e,r){if(e&&r)for(var t=function(t){var e=r.filter(function(e){return e.id===t.name.toString()});if(0<e.length){var i=e[0];t.title=i.displayName,t.layers&&n._fixWmsLayerDisplayNames(t.layers,r)}},n=this,i=0,s=e;i<s.length;i++)t(s[i])},l.prototype._marshalContent=function(c){var e,u=this,p=new dojo.Deferred;return c.reportParameters&&c.reportParameters.scale&&(e=parseFloat(c.reportParameters.scale.scale)),this._getPrintingObjectForEssentials(e).then(function(e){var t,i={f:"json",if:"WebMap,blankMap"};if(u._site&&(e.product="Geocortex Essentials "+u._site.currentVersion,u._site.displayTimeZoneId&&(i.displayTimeZoneId=u._site.displayTimeZoneId)),c.reportParameters){if(t=c.reportParameters,e.mapOptions||(e.mapOptions={extent:null}),delete e.mapOptions.scale,t.scale){var r=parseFloat(t.scale.scale);r&&!isNaN(r)&&(e.mapOptions.scale=r)}t.targetSpatialReference&&(e.mapOptions.spatialReference=t.targetSpatialReference),t.extentType===h.ReportParameters.CURRENT_EXTENT&&u._esriMap?e.mapOptions.extent=u._esriMap.extent:t.extentType===h.ReportParameters.FULL_EXTENT&&u._site&&u._site.essentialsMap?e.mapOptions.extent=u._site.essentialsMap.fullExtent:t.extentType===h.ReportParameters.INITIAL_EXTENT&&u._site&&u._site.essentialsMap?e.mapOptions.extent=u._site.essentialsMap.initialExtent:t.extentType===h.ReportParameters.CUSTOM_EXTENT&&t.customExtent&&(e.mapOptions.extent=t.customExtent);var n={dpi:null,outputSize:[]};if(t.imageWidth?n.outputSize[0]=t.imageWidth:n.outputSize[0]=u._esriMap.width,t.imageHeight?n.outputSize[1]=t.imageHeight:n.outputSize[1]=u._esriMap.height,t.resolution?n.dpi=t.resolution.dpi:n.dpi=96,e.exportOptions=n,t.grid&&t.grid.id){var s={grid:t.grid.id};e.layoutOptions=s}if(t.fields&&0<t.fields.length)for(var a=0,o=t.fields;a<o.length;a++){var l=o[a];i[l.id]=l.value}t.outputFormat&&(i.outputFormat=t.outputFormat),t.featureIds&&(i.featureIDs=t.featureIds.join(",")),t.includeGeoreferenceData&&(i.georef=t.includeGeoreferenceData),t.includeData&&(i.of=i.of?i.of+",includeData":"includeData")}c.queryParameters&&(i=dojo.mixin(c.queryParameters,i)).geometry&&(i.geometry=JSON.stringify(i.geometry)),c.operationParameters&&(i=dojo.mixin(c.operationParameters,i)),t.notificationEmailAddress&&(i.emailAddress=t.notificationEmailAddress),i.data=JSON.stringify(e),p.resolve(i)},function(e){return p.reject(new Error("Failed to serialize ExportContext content: {0}".format(e&&e.message?e.message:"Unable to determine cause")))}),p},l.prototype._inferLayerType=function(e){var t=new dojo.Deferred;if(e.layerType)return t.resolve(e.layerType),t;var i=e.type?e.type.toUpperCase():void 0;if(i){if(i===f.WebmapLayerType.WMS.toUpperCase())return t.resolve(f.WebmapLayerType.WMS),t;if(i===f.WebmapLayerType.WEB_TILED.toUpperCase())return t.resolve(f.WebmapLayerType.WEB_TILED),t;if("WMTS"===i)return t.resolve(f.WebmapLayerType.WEB_TILED),t;if(i===f.WebmapLayerType.BING_AERIAL.toUpperCase())return t.resolve(f.WebmapLayerType.BING_AERIAL),t;if(i===f.WebmapLayerType.BING_ROAD.toUpperCase())return t.resolve(f.WebmapLayerType.BING_ROAD),t;if(i===f.WebmapLayerType.BING_HYBRID.toUpperCase()||i===f.WebmapLayerType.BING_AERIAL_WITH_LABELS.toUpperCase())return t.resolve(f.WebmapLayerType.BING_HYBRID),t}if(e.url){var r=e.url,n=e.token;if(r.match(/.*\/MapServer\/\d{1,}\/?$/i)||r.match(/.*\/FeatureServer\/\d{1,}\/?$/i))return t.resolve(f.WebmapLayerType.FEATURE_LAYER),t;if(r.match(/.*\/StreamServer\/?$/i))return t.resolve(f.WebmapLayerType.STREAM_SERVICE),t;if(r.match(/.*\/ImageServer\/?\?|.*\/ImageServer\/?$/i))return this._getLayerData(r,n).then(function(e){return e.cacheType?f.WebmapLayerType.TILED_IMAGE_SERVICE:f.WebmapLayerType.IMAGE_SERVICE});if(r.match(/.*\/MapServer\/?(?:$|\?)/i))return this._getLayerData(r,n).then(function(e){return e.tileInfo?f.WebmapLayerType.TILED_MAP_SERVICE:f.WebmapLayerType.MAP_SERVICE});if(r.match(/.*\\.(csv|txt)$/i))return t.resolve(f.WebmapLayerType.CSV),t;if(r.match(/.*\\.kml$/i))return t.resolve(f.WebmapLayerType.KML),t;if(r.match(/.*(\\.xml|rss\/?)$/i))return t.resolve(f.WebmapLayerType.GEO_RSS),t}else{if(e.templateUrl&&e.tileInfo)return t.resolve(f.WebmapLayerType.WEB_TILED),t;if(e.featureCollection)return t.resolve(f.WebmapLayerType.FEATURE_LAYER),t;if(e.styleUrl)return t.resolve(f.WebmapLayerType.VECTOR_TILE_SERVICE),t;if(e.mapUrl)return t.resolve(f.WebmapLayerType.WMS),t;if(e.imageData){var s=void 0;if(this._site){var a=e.id,o=this._site.essentialsMap.findMapServiceById(a);o&&"VectorTile"===o.mapServiceType&&(s=f.WebmapLayerType.VECTOR_TILE_SERVICE)}return t.resolve(s),t}}return t.resolve(null),t},l.prototype._getLayerData=function(e,t){var i=new dojo.Deferred;return esri.request({url:e,content:{f:"json",token:t},handleAs:"json",callbackParamName:"callback"}).then(function(e){i.resolve(e)},function(e){i.reject(new Error("Could not infer type for layer {0}.".format(e&&e.message?e.message:"Request for layer data failed")))}),i},l.prototype._handleOperationalLayers=function(e){var t=new dojo.Deferred;if(e&&e.operationalLayers){var i=e.operationalLayers;return this._removeInternalLayers(e),this._adjustMeasurementsMarkupForGP5(e),this._adjustPlotCoordinatesMarkupForGP5(e),this._adjustPlotCoordinatesMarkupOrder(e),this._handleWmsLayers(i),this._handleWmtsLayers(i),this._fixDisplayNames(e.operationalLayers,this._esriMap,this._site),this._fixMapImageSublayerVisibility(e.operationalLayers,this._esriMap),this._handleVectorTileLayers(i),this._handleHeatmapRenderer(e,this._esriMap),this._handleStreamLayers(e.operationalLayers),this._fixHeatMapAndClusterLayers(e.operationalLayers),this._fixDynamicLayerDefsForGP5(e.operationalLayers),this._injectLegendOptions(e.operationalLayers),this._handleDrawingLayers(e.operationalLayers,this._esriMap),this._handleFeatureLayersForGP5(e.operationalLayers,this._esriMap),this._convertSymbolsToBase64(e,!1).then(function(e){return t.resolve(e)},function(e){return t.reject(new Error("Converting symbols to base64 failed: {0}".format(e&&e.message?e.message:"Unable to determine cause")))}),t}},l.prototype._handleWmtsLayers=function(e){for(var t=0,i=e;t<i.length;t++){var r=i[t];r.layerType!==f.WebmapLayerType.WEB_TILED||"WMTS"!==r.type.toUpperCase()||r.wmtsInfo||(r.wmtsInfo={customLayerParameters:r.customLayerParameters,customParameters:r.customParameters,layerIdentifier:r.layer,tileMatrixSet:r.tileMatrixSet,url:r.url})}},l.prototype._handleWmsLayers=function(e){for(var t=0,i=e;t<i.length;t++){var r=i[t];if(r.layerType===f.WebmapLayerType.WMS){r.layers||(r.layers=[]);var n=r.visibleLayers;if(0===r.layers.length&&n)for(var s=0,a=n;s<a.length;s++){var o=a[s];r.layers.push({name:o})}}}},l.prototype._handleVectorTileLayers=function(e){if(this._site&&e)for(var t=0,i=e;t<i.length;t++){var r=i[t];if(r.layerType===f.WebmapLayerType.VECTOR_TILE_SERVICE){var n=this._site.essentialsMap.findMapServiceById(r.id);if(!n)continue;var s=n.serviceLayer;if(!s)continue;var a=s.currentStyleInfo.styleUrl,o=s.currentStyleInfo.serviceUrl,l=esri.id,c=l._getServerInstanceRoot(a),u=l._getServerInstanceRoot(o);r.styleUrl=a,l._isServerRsrc(a)&&(r.token=n.serviceToken),n.serviceToken&&c.toLowerCase()!==u.toLowerCase()&&l._isServerRsrc(o)&&(r.serviceUrl=o,r.serviceToken=n.serviceToken),delete r.imageData}}},l.prototype._fixHeatMapAndClusterLayers=function(g){for(var e=0,t=g;e<t.length;e++)"HeatMap"!==(s=t[e]).type&&"Cluster"!==s.type||!s.drawingInfo||((s.layerDefinition||{}).drawingInfo=s.drawingInfo,delete s.drawingInfo,s.layerType=f.WebmapLayerType.FEATURE_LAYER,"HeatMap"!==s.type||s.url||s.featureCollection||!s.id.endsWith(":Local")||this._fixLocalHeatMapLayer(s));for(var _="-cluster",S="-explodedClusterLayer",i=[],r=0,n=g;r<n.length;r++){var s,a=void 0,o=(s=n[r]).id;o.endsWith(_)?a=o.substring(0,o.indexOf(_)):o.endsWith(S)&&(a=o.substring(0,o.indexOf(S))),void 0!==a&&i.indexOf(a)<0&&i.push(a)}for(var l=function(t){var e=void 0,i=void 0,r=g.filter(function(e){return e.id===t})[0],n=b.getProp(r,["featureCollection","layers","0","layerDefinition"]);if(n){var s=g.filter(function(e){return e.id===t+_}),a=g.filter(function(e){return e.id===t+S});i=a.length?a[0]:void 0,e=s.length?s[0]:void 0;var o=L._site.essentialsMap.findMapServiceById(t),l=!0;if(o&&o.serviceLayer instanceof esri.layers.FeatureLayer&&(l=o.layers[0].includeInLegend),i){i.showLegend=!0;var c=b.getProp(i,["featureCollection","layers","0","layerDefinition"]),u=b.getProp(e,["featureCollection","layers","0","layerDefinition"]);c&&(i.featureCollection.layers[0].showLegend=l,c.name=n.name,u&&(u.name="",e.featureCollection.layers[0].showLegend=l))}else e&&(e.showLegend=!0,(u=b.getProp(e,["featureCollection","layers","0","layerDefinition"]))&&(e.featureCollection.layers[0].showLegend=l,u.name=n.name))}var p=L._site.essentialsMap.findMapServiceById(t),h=b.getProp(p,["clusterLayer","rendererInformation"]),d=g.filter(function(e){return e.id===t+_})[0],f=b.getProp(d,["featureCollection","layers","0","layerDefinition","drawingInfo","renderer"]);if(h&&f&&f.classBreakInfos){var y=f.classBreakInfos;if(h.length===y.length)for(var m=0;m<h.length;m++){var v=h[m].rangeString.get();v&&(y[m].label=v)}for(m=h.length-1;0<=m;m--)h[m].isVisible.get()||f.classBreakInfos.splice(m,1)}},L=this,c=0,u=i;c<u.length;c++)l(u[c])},l.prototype._fixLocalHeatMapLayer=function(e){var t=this._esriMap.getLayer(e.id);if(t){var i=t.graphics;if(i){var r=[];i.forEach(function(e){r.push({geometry:e.geometry})});var n=e.geometryType,s={featureSet:{features:r,geometryType:n},layerDefinition:e.layerDefinition};e.featureCollection={},e.featureCollection.layers=[s],delete e.layerDefinition}}},l.prototype._fixDynamicLayerDefsForGP5=function(e){for(var t=0,i=e;t<i.length;t++){var r=i[t],n=this._site.essentialsMap.findMapServiceById(r.id);if(n&&n.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer){var s=n.layers,a=r.layers;if(a&&a.length&&s&&s.length)for(var o=function(t){if(!t.layerDefinition||!t.layerDefinition.drawingInfo)return"continue";if(void 0!==t.minScale&&null!==t.minScale)return"continue";if((s=s.filter(function(e){return e.id===t.id.toString()}))&&s.length){var e=s[0];e.minScale===1/0?t.minScale=0:t.minScale=e.minScale||0,t.maxScale=e.maxScale||0}},l=0,c=a;l<c.length;l++)o(c[l])}}},l.prototype._injectLegendOptions=function(e){for(var t=0,i=e;t<i.length;t++){var r=i[t],n=this._site.essentialsMap.findMapServiceById(r.id);if(n&&0<n.layers.length)if(n instanceof d.FeatureLayerService||n.serviceLayer instanceof esri.layers.WFSLayer)r.showLegend=n.layers[0].includeInLegend;else if(n.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer){r.sublayerIdsToHideInLegend=[];for(var s=0,a=n.layers;s<a.length;s++){var o=a[s];o.includeInLegend||r.sublayerIdsToHideInLegend.push(o.id)}}else if(n.serviceLayer instanceof esri.layers.ArcGISTiledMapServiceLayer&&!r.layers){var l=[],c=n.layers;if(c&&c.length)for(var u=0,p=c;u<p.length;u++){var h=p[u];h.type!==y.LayerType.GROUP_LAYER&&!1===h.includeInLegend&&l.push({id:parseInt(h.id,10),showLegend:h.includeInLegend})}r.layers=l}}},l.prototype._fixMapImageSublayerVisibility=function(e,t){if(e&&t)for(var i=e.length-1;0<=i;i--){var r=e[i];if(r.layerType===f.WebmapLayerType.MAP_SERVICE){var n=t.getLayer(r.id);if(n){var s=n.visibleLayers,a=n.layerInfos;if(a&&0<a.length){for(var o=a.length-1;0<=o;o--){var l=a[o];if(l.subLayerIds&&0<l.subLayerIds.length&&!s.includes(l.id.toString()))for(var c=0,u=l.subLayerIds;c<u.length;c++){var p=u[c];if(s.includes(p.toString())){s.push(l.id.toString());break}}}0<s.length?r.visibleLayers=s.map(function(e){return parseInt(e,10)}):r.visibleLayers=[-1]}}r.visibleLayers&&"-1"===r.visibleLayers.toString()&&e.splice(i,1)}}},l.prototype._verifyObjectIdField=function(e){var t=e.layerDefinition;if(t&&!t.objectIdField){var i=this._getObjectIdField(t);t.objectIdField=i,this._updateLayerDefinitionFields(t,i),this._addObjectIdAttribute(e,i)}},l.prototype._getObjectIdField=function(e){if(e&&e.objectIdField)return e.objectIdField;if(e&&e.fields&&0<e.fields.length)for(var t=0,i=e.fields;t<i.length;t++){var r=i[t];if(r.type===o.EsriFieldTypes.esriFieldTypeOID)return r.name}return this.DEFAULT_OBJECTID_FIELD},l.prototype._updateLayerDefinitionFields=function(e,t){e.fields=e.fields?e.fields:[];for(var i=0,r=e.fields;i<r.length;i++){var n=r[i];if(n.name===t&&n.type===o.EsriFieldTypes.esriFieldTypeOID)return}e.fields.push({name:t,type:o.EsriFieldTypes.esriFieldTypeOID})},l.prototype._addObjectIdAttribute=function(e,t){if(e&&e.featureSet&&e.featureSet.features&&0<e.featureSet.features.length)for(var i=1,r=0,n=e.featureSet.features;r<n.length;r++){var s=n[r];s.attributes=s.attributes?s.attributes:{},s.attributes[t]=i++}},l.prototype._handleDrawingLayers=function(e,t){if(e&&t)for(var i=0,r=e;i<r.length;i++){var n=r[i];if(n.layerType===f.WebmapLayerType.FEATURE_LAYER){var s=t.getLayer(n.id);s&&"esri.layers.GraphicsLayer"===s.declaredClass&&!s.renderer&&(n.showLegend=!1)}}},l.prototype._handleFeatureLayersForGP5=function(e,t){if(e&&t)for(var i=0,r=e;i<r.length;i++){var n=r[i];n.layerType===f.WebmapLayerType.FEATURE_LAYER&&(n.layerDefinition=n.layerDefinition||{},void 0!==n.minScale&&(n.layerDefinition.minScale||(n.layerDefinition.minScale=n.minScale),delete n.minScale),void 0!==n.maxScale&&(n.layerDefinition.maxScale||(n.layerDefinition.maxScale=n.maxScale),delete n.maxScale))}},l.prototype._handleStreamLayers=function(e){if(e)for(var t=0,i=e;t<i.length;t++){var r=i[t],n=b.getProp(r,["featureCollection","layers","0"]);if(n){var s=r.id,a=this._site.essentialsMap.findMapServiceById(s);a&&a.serviceLayer instanceof esri.layers.StreamLayer&&(n.showLegend=a.layers[0].includeInLegend)}}},l);function l(e){if(this.resource=null,this._esriMap=null,this._essentialsRestUrl=null,this._site=null,this.DEFAULT_OBJECTID_FIELD="defaultGcxObjectId",this._populateFromResource(e),!this._esriMap||!this._essentialsRestUrl)throw new Error("Unable to create ExportMapTask from the resource.")}t.ExportMapTask=i})},"geocortex/essentials/exportMap/ExportMapTypes":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WEBTILED="WebTiledLayer",t.BINGAERIAL="BingMapsAerial",t.BINGAERIALLABELS="BingMapsAerialWithLabels",t.BINGROADS="BingMapsRoad",t.BINGHYBRID="BingMapsHybrid"})},"geocortex/essentials/exportMap/ExportOptions":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/exportMap/ExportSymbol":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/serviceDiscovery/ResultItem":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/serviceDiscovery/ServiceDiscoveryProvider":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/serviceDiscovery/serviceDiscoveryServicePoint":function(){define(["require","exports","./../MapService","./../FeatureLayerService"],function(e,t,a,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=(r.prototype.postProcess=function(e){for(var t in e.thumbnailUrl||(e.thumbnailUrl=this.service.formatQuery("connections/{0}/preview?f=json&providerName={1}&url={2}",e.connection.id,e.serviceProviderName,e.url)),e.children)this.postProcess(e.children[t]);return e},r.prototype.findServices=function(e){var t=this.postProcess.bind(this.postProcess),i=this.service.formatQuery("connections/find?f=json&term={0}",e);return this.service.getRequest(i,"results").select(t)},r.prototype.expandService=function(e,t,i){if(1==arguments.length){var r=e;e=r.connection.id,t=r.serviceProviderName,i=r.url}var n=this.postProcess.bind(this.postProcess),s=this.service.formatQuery("connections/{0}/expand?f=json&providerName={1}&url={2}",e,t,i);return this.service.getRequest(s,null).select(n)},r.prototype.suggestHints=function(e){var t=this.service.formatQuery("connections/suggest?f=json&term={0}",e);return this.service.getRequest(t,"hints")},r.prototype.realizeMapService=function(e,t,r,i){if(1==arguments.length){var n=e;e=n.connection.id,t=n.serviceProviderName,r=n.url}var s=this.service.formatQuery("connections/{0}/realize?f=json&providerName={1}&url={2}&sr={3}",e,t,r,i);return this.service.getRequest(s,null).select(function(e){if(0<=e.serviceType.indexOf("FeatureLayer")){var t=new o.FeatureLayerService(r);return t._configureObject(e,!0),t}var i=new a.MapService(r);return i._configureObject(e,!0),i})},r);function r(e){this.service=e}t.ServiceDiscoveryServicePoint=i})},"geocortex/essentials/serviceDiscovery/SiteServiceDiscoveryProvider":function(){define(["require","exports","./../utilities/UrlUtilities","geocortex/framework/SimplePromise","./../../geocortex","./../ServiceHelper","./../utilities/ServiceDiscoveryUtilities","geocortex/framework/utils/HttpsUtils"],function(e,t,a,r,n,i,s,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var l=(c.prototype.initialize=function(e){this._site=e,this._rootUrl=a.UrlUtilities.resolveUrl(e.url,"/../../../connections",!0),this.supported=4.05<=e.getEssentialsVersion(),this.initialized=!0},c.prototype.getRootUrl=function(){return this._rootUrl},c.prototype.suggestHints=function(e){var r=this,t={f:"json",term:e};return this.sendRequest("suggest",t).then(function(e){var t=new Array;if(void 0!==r.isHttpsMode&&null!==r.isHttpsMode||(r.isHttpsMode=o.isHttpsMode()),r.isHttpsMode&&e&&e.hints&&0<e.hints.length){for(var i=0;i<e.hints.length-1;i++)e.hints[i].toLowerCase().startsWith("http://")||(e.hints[i+1].toLowerCase().startsWith("http://")?e.hints[i+1].toLowerCase().startsWith("https://")&&(t.push(e.hints[i]),t.push(e.hints[i+1]),i+=1):t.push(e.hints[i]));return e.hints[e.hints.length-1].toLowerCase().startsWith("http://")||t.push(e.hints[e.hints.length-1]),t}return e.hints})},c.prototype.findServices=function(e,t){var i=this,r={f:"json",term:e,whitelistOnly:!0};return t&&(r=dojo.mixin(r,t)),this.sendRequest("find",r).then(function(e){return Array.isArray(e.results)&&(void 0!==i.isHttpsMode&&null!==i.isHttpsMode||(i.isHttpsMode=o.isHttpsMode()),i.isHttpsMode&&(e.results=e.results.filter(function(e){return e.url.toLowerCase().startsWith("https")||e.url.toLowerCase().startsWith("http://www.bing.com/maps")})),e.results.forEach(function(e){return i._processItem(e)})),e.results})},c.prototype.expandService=function(e){var t=this,i=this._getConnectionId(e),r={f:"json",providerName:e.serviceProviderName,url:e.url};return this.sendRequest(i+"/expand",r).then(function(e){return t._processItem(e)})},c.prototype.realizeMapService=function(t,e){var i=this,r=this._getConnectionId(t),n={f:"json",providerName:t.serviceProviderName,url:t.url,sr:e,itemId:t.id||"null"};return this.sendRequest(r+"/realize",n).then(function(e){return i._createMapService(t,e)})},c.prototype.sendRequest=function(e,t){var i=this;return r.SimplePromise.resolve(null).then(function(){return i._verifyInitialized()}).then(function(){return i._verifySupported()}).then(function(){return t.f=t.f||"json",n.request({url:a.UrlUtilities.resolveUrl(i._rootUrl,e),content:n.encodeJson(t),handleAs:"json"})}).then(this._processError)},c.prototype._getConnectionId=function(e){return e.connection&&null!=e.connection.id?e.connection.id:"none"},c.prototype._processError=function(e){if(e&&e.error)throw e.error;return e},c.prototype._processItem=function(e){var t=e;if(t.connection&&null!=t.connection.id?t.isWhitelisted=!0:this.whitelistAgol&&"ArcGisOnlineDiscoveryProvider"===t.discoveryProviderName?t.isWhitelisted=!0:this.whitelistPortal&&"ArcGisPortalDiscoveryProvider"===t.discoveryProviderName?t.isWhitelisted=!0:t.isWhitelisted=!1,!t.thumbnailUrl){var i=this._getConnectionId(t)+"/preview?f=json&providerName="+t.serviceProviderName+"&url="+t.url;t.thumbnailUrl=a.UrlUtilities.resolveUrl(this._rootUrl,i)}if(t.children)for(var r=0,n=t.children;r<n.length;r++){var s=n[r];this._processItem(s)}return t},c.prototype._createMapService=function(e,t){return t.serviceUrl||(t.serviceUrl=e.url),!t.serviceUrl&&t.connectionString&&(t.serviceUrl=i.ServiceHelper.extractConnectionStringValue(t.connectionString,"url")),t.serviceUrl?s.ServiceDiscoveryUtilities.buildMapService(this._site.essentialsMap,t):r.SimplePromise.reject(new Error("SiteServiceDiscoveryProvider._createMapService: Cannot create map service, the service URL is required."))},c.prototype._verifySupported=function(){if(!this.supported)throw new Error("Service Discovery is not supported in the current version of Geocortex Essentials.")},c.prototype._verifyInitialized=function(){if(!this.initialized)throw new Error("The Service Discovery client is not initialized yet.")},c);function c(e,t){this.initialized=!1,this.supported=!1,this.whitelistAgol=!!e,this.whitelistPortal=!!t}t.SiteServiceDiscoveryProvider=l})},"geocortex/essentials/utilities/DecomposedUri":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=(o.prototype.recompose=function(){var e=this.schemeHostAndPath;return this.query&&this.anyProperties(this.query)&&(e+="?"+dojo.objectToQuery(this.query)),this.fragment&&this.anyProperties(this.fragment)&&(e+="#"+dojo.objectToQuery(this.fragment)),e},o.prototype.anyProperties=function(e){for(var t in e)return!0;return!1},o.getHost=function(e){if(!e)return null;var t=e.match(/^http[s]?:\/\/([^\/]*)/);return 1<t.length?t[1]:null},o.appendToPath=function(e,t){var i=new o(e);return i.schemeHostAndPath+=t,i.recompose()},o.removeQueryParameters=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];for(var r=new o(e),n=0,s=t;n<s.length;n++){var a=s[n];delete r.query[a]}return r.recompose()},o);function o(e){this.originalUri=e,this.schemeHostAndPath=e.match(/[^?|^#]*/)[0];var t=e.match(/\?([^#]*)/);this.query={},t&&1<t.length&&(this.query=dojo.queryToObject(t[1])),this.fragment=dojo.queryToObject(0<=e.indexOf("#")?e.substring(e.indexOf("#")+1,e.length):"")}t.DecomposedUri=i})},"geocortex/essentials/utilities/EncodeImageError":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/utilities/EncodeImageResult":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/utilities/ExifUtilities":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=(d.getPointFromExif=function(e){if(!e||!dojo.isArray(e.GPSLatitude)||!dojo.isArray(e.GPSLongitude))return null;var t=d.dmsToDecimal(e.GPSLatitude),i=d.dmsToDecimal(e.GPSLongitude);return"S"===e.GPSLatitudeRef&&(t*=-1),"W"===e.GPSLongitudeRef&&(i*=-1),new esri.geometry.Point(i,t)},d.dmsToDecimal=function(e){return 2<e.length?e[0]+e[1]/60+e[2]/3600:1<e.length?e[0]+e[1]/60:e[0]},d.getExifTagsFromImageBytes=function(e){if(0==e.byteLength)return{};var t=e.byteLength,i=new DataView(e);if(t<2||65496!=i.getUint16(0))return{};for(var r=2;r+4<t;r+=s+2){if(255!==i.getUint8(r))throw new Error("Expected start of a JPEG marker.");var n=i.getUint8(r+1),s=i.getUint16(r+2);if(t<r+s+2)throw new Error("Unexpected end of file.");if(225===n)return d.getExifTags(i,r+4,s-2)}return{}},d.base64ToArrayBuffer=function(e,t){t=t||e.match(/^data\:([^\;]+)\;base64,/im)[1]||"",e=e.replace(/^data\:([^\;]+)\;base64,/gim,"");for(var i=atob(e),r=i.length,n=new ArrayBuffer(r),s=new Uint8Array(n),a=0;a<r;a++)s[a]=i.charCodeAt(a);return n},d.getExifTags=function(e,t,i){if(i<6||1165519206!==e.getUint32(t)||0!==e.getUint16(t+4))throw new Error("EXIF header corrupted.");var r,n=e.getInt16(t+6);if(18761===n)r=!0;else{if(19789!==n)throw new Error("Unknown endian marker.");r=!1}if(42!==e.getUint16(t+8,r)){if(10752===e.getUint16(t+8,r))throw new Error("Endian marker test is backwards.");throw new Error("Endian marker test magic value is corrupted.")}var s,a=e.getUint32(t+10,r),o=d.readTags(e,t+6,t+6+a,d.TiffTags,r);if(o.ExifIFDPointer){var l=d.readTags(e,t+6,t+6+o.ExifIFDPointer,d.ExifTags,r);for(s in l)if(l.hasOwnProperty(s)){switch(s){case"ExifVersion":case"FlashpixVersion":l[s]=String.fromCharCode(l[s][0],l[s][1],l[s][2],l[s][3])}o[s]=l[s]}}if(o.GPSInfoIFDPointer){var c=d.readTags(e,t+6,t+6+o.GPSInfoIFDPointer,d.GPSTags,r);for(s in c)if(c.hasOwnProperty(s)){switch(s){case"GPSVersionID":c[s]=c[s][0]+"."+c[s][1]+"."+c[s][2]+"."+c[s][3]}o[s]=c[s]}}return o},d.readTags=function(e,t,i,r,n){for(var s={},a=e.getUint16(i,n),o=0;o<a;o++){var l=i+12*o+2,c=e.getUint16(l,n),u=r[c];s[u=u||c.toString(16)]=d.readTagValue(e,l,t,i,n)}return s},d.readTagValue=function(e,t,i,r,n){var s,a,o,l,c,u=e.getUint16(t+2,n),p=e.getUint32(t+4,n),h=e.getUint32(t+8,n)+i;switch(u){case 1:case 7:if(1==p)return e.getUint8(t+8);for(s=4<p?h:t+8,a=[],o=0;o<p;o++)a[o]=e.getUint8(s+o);return a;case 2:return d.getStringFromBytes(e,s=4<p?h:t+8,p-1);case 3:if(1==p)return e.getUint16(t+8,n);for(s=2<p?h:t+8,a=[],o=0;o<p;o++)a[o]=e.getUint16(s+2*o,n);return a;case 4:if(1==p)return e.getUint32(t+8,n);for(a=[],o=0;o<p;o++)a[o]=e.getUint32(h+4*o,n);return a;case 5:if(1==p)return(l=e.getUint32(h,n))/(c=e.getUint32(h+4,n));for(a=[],o=0;o<p;o++)l=e.getUint32(h+8*o,n),c=e.getUint32(h+4+8*o,n),a[o]=l/c;return a;case 9:if(1==p)return e.getInt32(t+8,n);for(a=[],o=0;o<p;o++)a[o]=e.getInt32(h+4*o,n);return a;case 10:if(1==p)return e.getInt32(h,n)/e.getInt32(h+4,n);for(a=[],o=0;o<p;o++)a[o]=e.getInt32(h+8*o,n)/e.getInt32(h+4+8*o,n);return a}return""},d.getStringFromBytes=function(e,t,i){for(var r="",n=t;n<t+i;n++)r+=String.fromCharCode(e.getUint8(n));return r},d.ExifTags={36864:"ExifVersion",40960:"FlashpixVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",37121:"ComponentsConfiguration",37122:"CompressedBitsPerPixel",37500:"MakerNote",37510:"UserComment",40964:"RelatedSoundFile",36867:"DateTimeOriginal",36868:"DateTimeDigitized",37520:"SubsecTime",37521:"SubsecTimeOriginal",37522:"SubsecTimeDigitized",33434:"ExposureTime",33437:"FNumber",34850:"ExposureProgram",34852:"SpectralSensitivity",34855:"ISOSpeedRatings",34856:"OECF",37377:"ShutterSpeedValue",37378:"ApertureValue",37379:"BrightnessValue",37380:"ExposureBias",37381:"MaxApertureValue",37382:"SubjectDistance",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37396:"SubjectArea",37386:"FocalLength",41483:"FlashEnergy",41484:"SpatialFrequencyResponse",41486:"FocalPlaneXResolution",41487:"FocalPlaneYResolution",41488:"FocalPlaneResolutionUnit",41492:"SubjectLocation",41493:"ExposureIndex",41495:"SensingMethod",41728:"FileSource",41729:"SceneType",41730:"CFAPattern",41985:"CustomRendered",41986:"ExposureMode",41987:"WhiteBalance",41988:"DigitalZoomRation",41989:"FocalLengthIn35mmFilm",41990:"SceneCaptureType",41991:"GainControl",41992:"Contrast",41993:"Saturation",41994:"Sharpness",41995:"DeviceSettingDescription",41996:"SubjectDistanceRange",40965:"InteroperabilityIFDPointer",42016:"ImageUniqueID"},d.TiffTags={256:"ImageWidth",257:"ImageHeight",34665:"ExifIFDPointer",34853:"GPSInfoIFDPointer",40965:"InteroperabilityIFDPointer",258:"BitsPerSample",259:"Compression",262:"PhotometricInterpretation",274:"Orientation",277:"SamplesPerPixel",284:"PlanarConfiguration",530:"YCbCrSubSampling",531:"YCbCrPositioning",282:"XResolution",283:"YResolution",296:"ResolutionUnit",273:"StripOffsets",278:"RowsPerStrip",279:"StripByteCounts",513:"JPEGInterchangeFormat",514:"JPEGInterchangeFormatLength",301:"TransferFunction",318:"WhitePoint",319:"PrimaryChromaticities",529:"YCbCrCoefficients",532:"ReferenceBlackWhite",306:"DateTime",270:"ImageDescription",271:"Make",272:"Model",305:"Software",315:"Artist",33432:"Copyright"},d.GPSTags={0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude",5:"GPSAltitudeRef",6:"GPSAltitude",7:"GPSTimeStamp",8:"GPSSatellites",9:"GPSStatus",10:"GPSMeasureMode",11:"GPSDOP",12:"GPSSpeedRef",13:"GPSSpeed",14:"GPSTrackRef",15:"GPSTrack",16:"GPSImgDirectionRef",17:"GPSImgDirection",18:"GPSMapDatum",19:"GPSDestLatitudeRef",20:"GPSDestLatitude",21:"GPSDestLongitudeRef",22:"GPSDestLongitude",23:"GPSDestBearingRef",24:"GPSDestBearing",25:"GPSDestDistanceRef",26:"GPSDestDistance",27:"GPSProcessingMethod",28:"GPSAreaInformation",29:"GPSDateStamp",30:"GPSDifferential"},d);function d(){}t.ExifUtilities=i})},"geocortex/essentials/utilities/GraphicsLayerUtilities":function(){define(["require","exports"],function(e,o){"use strict";var t,i;Object.defineProperty(o,"__esModule",{value:!0}),o.excludeFromExportMapTaskName="ExportMapTask",o.ExcludeFromEnum={WebMapName:"WebMap",ExportApplyStateName:"ExportApplyState",ExportMapTaskName:o.excludeFromExportMapTaskName},o.GraphicsLayerType={Pushpin:"Pushpin",Label:"Label",Highlight:"Highlight",Markup:"Markup"},(i=t=o.FeatureCollectionType||(o.FeatureCollectionType={}))[i.Polygon=0]="Polygon",i[i.Polyline=1]="Polyline",i[i.Point=2]="Point",i[i.Text=3]="Text",o.featureTypeSelector={esriGeometryPolygon:t.Polygon,esriGeometryPolyline:t.Polyline,esriGeometryPoint:t.Point,polygon:t.Polygon,polyline:t.Polyline,point:t.Point};var l=0,c=0,u=0,r={},p=[];function h(e,t,i){n(i,e,{autoEditable:!0,displayName:t})}function n(e,t,i){return!!(e&&e.essentialsMap&&e.essentialsMap.clickableGraphics)&&(!(!(t&&t instanceof esri.layers.GraphicsLayer)||e.essentialsMap.clickableGraphics.isLayerRegistered(t))&&(e.essentialsMap.clickableGraphics.register(t,i),!0))}function d(e,t,i,r){var n=i.getLayer(e);return!n&&t?($.isNumeric(r)||(r=i.graphicsLayerIds.length-l-c-u),(n=new esri.layers.GraphicsLayer).id=e,i.addLayer(n,r)):t=!1,{layer:n,create:t}}o.getGraphicsLayerIdsToExclude=function(e){var t=[];return e.forEach(function(e){r[e]&&r[e].forEach(function(e){t.indexOf(e)<0&&t.push(e)})}),t},o.addToGraphicsLayerIdsToExclude=function(e,t){t&&0<t.length&&e.forEach(function(e){r[e]||(r[e]=[]),r[e].indexOf(t)<0&&r[e].push(t)})},o.removeFromGraphicsLayerIdsToExclude=function(e,i){i&&0<i.length&&e.forEach(function(e){if(r[e]){var t=r[e].indexOf(i);0<=t&&r[e].splice(t,1)}})},o.getInternalGraphicsLayer=function(e,t,i,r){if(void 0===r&&(r=!1),!t)return null;var n,s=t.getMap();if(!s)return null;if(!i)return(n=d(e,!1,s,s.graphicsLayerIds.length-l-c-u)).layer;if(i===o.GraphicsLayerType.Pushpin)return(n=d(e,!0,s,s.graphicsLayerIds.length)).create&&l++,n.layer;if(i===o.GraphicsLayerType.Label)return(n=d(e,!0,s,s.graphicsLayerIds.length-l)).create&&c++,n.layer;if(i===o.GraphicsLayerType.Highlight)return(n=d(e,!0,s,s.graphicsLayerIds.length-l-c)).create&&u++,n.layer;if(i===o.GraphicsLayerType.Markup){var a=function(e,t,i,r,n){if(!i)return null;var s=i.getMap();if(!s)return null;var a=s.getLayer(e);a||($.isNumeric(n)||(n=s.graphicsLayerIds.length-1),(a=new esri.layers.GraphicsLayer).id=e,s.addLayer(a,n));r&&h(a,t,i);return a}(e,e,t,r,s.graphicsLayerIds.length-l-c-u);return-1===p.indexOf(a)&&p.push(a),a}},o.removeInternalGraphicsLayer=function(e,t,i){var r=t.getLayer(e);r&&(t.removeLayer(r),-1<p.indexOf(r)&&p.splice(p.indexOf(r),1),i===o.GraphicsLayerType.Pushpin&&0<l&&l--,i===o.GraphicsLayerType.Highlight&&0<u&&u--,i===o.GraphicsLayerType.Label&&0<c&&c--)},o.registerMarkupLayerAsClickable=h,o.registerStreamLayerAsClickable=function(e,t,i){n(t,e,{displayName:i,autoEditable:!1,canEdit:function(){return!1},canDelete:function(){return!1},canChangeStyles:function(){return!1}})},o.tryRegisterClickableLayer=n,o.addGraphicToLayer=function(e,t,i){if(e){var r=d(t,!1,i);if(r.layer)return r.layer.add(e),r.layer.visible||r.layer.setVisibility(!0),!0}return!1},o.getAllMarkupLayers=function(){return p}})},"geocortex/essentials/utilities/ImageUtilities":function(){define(["require","exports"],function(i,e){"use strict";function n(e,t,i,r){if(e<i&&t<r)return{width:e,height:t};var n=Math.min(i/e,r/t);return{width:e*n,height:t*n}}function s(t,s,a){return new Promise(function(n,e){i(["pica"],function(r){o(t).then(function(e){var t,i=document.createElement("canvas");i.width=s,i.height=a,function(){var e=window.navigator.userAgent;if(0<e.indexOf("MSIE "))return!0;if(0<e.indexOf("Trident/"))return!0;return!1}()&&(t={features:["js"]}),r(t).resize(e,i,{alpha:!0}).then(function(e){return n(i.toDataURL("image/png"))})})})})}function o(r){return new Promise(function(e,t){if("string"==typeof r){var i=new Image;i.onload=function(){e(i)},i.src=r}else e(r)})}Object.defineProperty(e,"__esModule",{value:!0}),e.calculateAspectRatioFit=n,e.resizeImage=s,e.resizeImageToMaxDimensions=function(e,i,r){return o(e).then(function(e){var t=n(e.width,e.height,i,r);return s(e,t.width,t.height)}).then(function(e){return e})},e.getRawByteDataFromDataUri=function(e){return decodeURIComponent(e.substring(e.indexOf("base64,")+7))}})},"geocortex/essentials/utilities/LayerUtilities":function(){define(["require","exports","geocortex/framework/utils/utils"],function(e,t,y){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=(r.createFeatureLayerFromCsv=function(p,h){var d=new dojo.Deferred;if(!p)return d.resolve(null),d;var f=new dojox.data.CsvStore({url:p.url,separator:p.columnDelimiter||","});return f.fetch({onComplete:function(e,t){var o,l,c=0,i=p.layerDefinition,u={layerDefinition:i,featureSet:{features:[],geometryType:"esriGeometryPoint"}},r=null,n=null;h&&(r=h.lowerBound||0,n=h.upperBound||e.length),(r||n)&&(e=e.slice(r,n)),dojo.forEach(e,function(i,e){0===e&&p.locationInfo&&(o=p.locationInfo.latitudeFieldName,l=p.locationInfo.longitudeFieldName),f.getIdentity(i);var t=f.getAttributes(i),r={};dojo.forEach(t,function(e){var t=Number(f.getValue(i,e));isNaN(t)?r[e]=f.getValue(i,e):r[e]=t}),r.__OBJECTID=c,c++;var n=parseFloat(r[o]),s=parseFloat(r[l]);if(!isNaN(n)&&!isNaN(s)){var a={geometry:new esri.geometry.Point(s,n).toJson(),attributes:r};u.featureSet.features.push(a)}});var s=new esri.layers.FeatureLayer(u),a=null;i&&i.drawingInfo&&i.drawingInfo.renderer&&i.drawingInfo.renderer.symbol&&"esriPMS"===i.drawingInfo.renderer.symbol.type&&(a=i.drawingInfo.renderer.symbol),null!=a&&(s.renderer.symbol.imageData=a.imageData,s.renderer.symbol.url=a.url),p.title&&(s.name=p.title),s.layerId=p.id||y.alphaNumericToken(),d.resolve(s)}}),d},r.decomposeFeatureLayerUrl=function(e){var t=/(.+?)\/([0-9]*)(\?.*)?$/g.exec(e);return{serviceUrl:t[1],layerId:parseInt(t[2]),queryString:t[3]}},r);function r(){}t.LayerUtilities=i})},"geocortex/essentials/utilities/PrintUtilities":function(){define(["require","exports","geocortex/framework/utils/utils"],function(e,t,m){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=(r.adjustTextSymbol=function(e,t){if(e&&e.symbol instanceof esri.symbol.TextSymbol){var i=function(e,t){t.font.size=m.isNullOrUndefined(e.font.size)||"number"!=typeof e.font.size?e.font.size:Math.round(e.font.size)+"px",t.x=e.x,t.y=e.y,t.xoffset=e.xoffset,t.yoffset=e.yoffset,t.align=e.align,t.angle=e.angle,t.color.hasOwnProperty("a")&&(t.color.a=0<=e.color.a&&e.color.a<=1?255*e.color.a:e.color.a)},r=new esri.symbol.TextSymbol(e.symbol.toJson());if(r.color=new esri.Color({r:e.symbol.color.r,g:e.symbol.color.g,b:e.symbol.color.b,a:e.symbol.color.a}),i(e.symbol,r),r.toJson&&"function"==typeof r.toJson){var n=r.toJson;r.toJson=function(){var e=n.call(r);return i(r,e),e}}var s=null,a=null;if(t){var o=document.getElementById(t+"_layer"),l=null;l=document.createElementNS("http://www.w3.org/2000/svg","text"),r.font&&(r.font.size&&l.setAttributeNS(null,"font-size",r.font.size.toString()),r.font.family&&l.setAttributeNS(null,"font-family",r.font.family)),l.setAttributeNS(null,"visibility","hidden"),l.textContent=r.text,o.appendChild(l);var c=l.getBBox();a=null===a?c.height:a,s=null===s?l.getComputedTextLength():s,o.removeChild(l)}else{var u=document.body,p=document.createElement("div"),h={fontFamily:r.font.family,fontSize:r.font.size,fontWeight:r.font.weight,padding:"0",position:"absolute",lineHeight:"1",visibility:"hidden"};for(var d in h)h.hasOwnProperty(d)&&(p.style[d]=h[d]);p.appendChild(document.createTextNode(r.text)),u.appendChild(p),s=p.clientWidth,a=p.clientHeight,u.removeChild(p)}if(r.xoffset=0===r.angle?r.xoffset:0,r.yoffset=0===r.angle?r.yoffset:0,(e.measurementId||e.coordinateId)&&e.attributes&&e.attributes.numberOfLines){if(e.measurementId?r.xoffset=-(s/2+a/4):r.xoffset=-(s/4+a/2),r.yoffset=e.attributes.numberOfLines&&1===e.attributes.numberOfLines?a/2:r.yoffset,"start"===r.verticalAlignment&&e.attributes.numberOfLines&&1<e.attributes.numberOfLines){var f=e.attributes.numberOfLines;r.yoffset=r.yoffset-.5*a/2+a*f/2}}else{switch(r.verticalAlignment){case"top":break;case"middle":r.yoffset+=a/2;break;default:r.yoffset+=.75*a}e.attributes&&e.attributes.customVerticalAlignment&&"middle"===e.attributes.customVerticalAlignment&&(r.xoffset=0,r.yoffset=0,r.yoffset+=Math.ceil(a/2));var y=r.horizontalAlignment||r.align||null;if(y)switch(y){case esri.symbol.TextSymbol.ALIGN_MIDDLE:case"center":case"justify":r.xoffset-=Math.ceil(s/2),e.coordinateId||(r.xoffset-=Math.ceil(a/4));break;case esri.symbol.TextSymbol.ALIGN_END:case"right":r.xoffset-=s}}return r}return null},r.adjustPictureMarkerSymbol=function(e){if(e&&e.symbol instanceof esri.symbol.PictureMarkerSymbol){var r=new esri.symbol.PictureMarkerSymbol(e.symbol.toJson());if(r.toJson&&"function"==typeof r.toJson){var n=r.toJson;r.toJson=function(){var e,t,i=n.call(r);return i.color=[0,0,0,255],isNaN(e=parseInt(r.width,10))||isNaN(t=parseInt(r.height,10))||(i.width=e,i.height=t,i.xoffset=isNaN(parseInt(i.xoffset,10))?e/2:i.xoffset+e/2,i.yoffset=isNaN(parseInt(i.yoffset,10))?t/2:i.yoffset-t/2),i}}return r}return null},r.getImageAsBase64=function(t,i){void 0===i&&(i="image/png");var r=new dojo.Deferred,n=document.createElement("canvas"),s=n.getContext("2d"),a=new Image;return a.onload=function(){n.height=a.height,n.width=a.width,s.drawImage(a,0,0);try{var e=n.toDataURL(i);r.resolve({url:t,data:e.replace(/^data:image\/(png|jpg);base64,/,"")})}catch(e){r.reject({url:t,error:e})}},a.onerror=function(e){r.reject({url:t,error:new Error("Failed to download image.")})},a.src=t,r},r);function r(){}t.PrintUtilities=i})},"geocortex/essentials/utilities/PromiseUtilities":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=(i.prototype.fulfill=function(e){this.state.fulfilled=!0,this.state.value=e},i.prototype.reject=function(e){this.state.rejected=!0,this.state.reason=e},i.prototype.isFulfilled=function(){return this.state.fulfilled},i.prototype.isRejected=function(){return this.state.rejected},i.prototype.isPending=function(){return!this.state.fulfilled&&!this.state.rejected},i.prototype.value=function(){return this.state.value},i.prototype.reason=function(){return this.state.reason},i);function i(){this.state={fulfilled:!1,rejected:!1}}var r=(s.settle=function(e){if(dojo.isArray(e))return s._settleImpl(e);if(e.then)return e.then(function(e){return s._settleImpl(e)});throw new Error("Unknown parameter type.  Must be an array of promises or a promise of array of promises.")},s._settleImpl=function(e){var i,t=new dojo.Deferred,r=e.map(function(e){var t=new n;return e&&"function"==typeof e.then?e.then(function(e){t.fulfill(e),i&&i()},function(e){t.reject(e),i&&i()}):t.fulfill(e),t});return(i=function(){r.every(function(e){return!e.isPending()})&&t.resolve(r)})(),t.promise},s);function s(){}t.PromiseUtilities=r})},"geocortex/essentials/utilities/ServiceDiscoveryUtilities":function(){define(["require","exports","./../MapService","./../FeatureLayerService","./../WFSLayerService","./../StreamLayerService","./../MapServiceConstants","geocortex/framework/SimplePromise","geocortex/framework/utils/utils"],function(e,t,m,v,g,_,S,i,L){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=(n.buildMapService=function(d,f,y){return void 0===y&&(y=!1),new i.SimplePromise(function(t,i){if(!d)throw new Error('ServiceDiscoveryUtilities.buildMapService: Parameter "essentialsMap" is required.');if(!f)throw new Error('ServiceDiscoveryUtilities.buildMapService: Parameter "serviceDefinition" is required.');var r,n,s,e={id:L.alphaNumericToken(),connectionString:f.serviceUrl?"url="+f.serviceUrl:void 0},a=dojo.mixin(e,f);if(a.drawingBehavior===S.DrawingBehavior.FEATURE_LAYER){if(!dojo.isObject(esri.layers.FeatureLayer))throw new Error("This Javascript application must require the esri.layers.FeatureLayer package in order to use a site with feature layers");r=new v.FeatureLayerService}else if(a.drawingBehavior===S.DrawingBehavior.GEORSS_LAYER){if(!dojo.isObject(esri.layers.GraphicsLayer))throw new Error("This Javascript application must require the esri.layers.GraphicsLayer package in order to use a site with GeoRSS layers");r=new geocortex.essentials.GeoRssLayerService}else if(a.drawingBehavior===S.DrawingBehavior.KML_SERVICE){if(!dojo.isObject(esri.layers.KMLLayer))throw new Error("This Javascript application must require the esri.layers.KMLLayer package in order to use a site with KML layers");r=new geocortex.essentials.KmlService}else if(a.drawingBehavior===S.DrawingBehavior.WFS_LAYER){if(!dojo.isObject(esri.layers.WFSLayer))throw new Error("This Javascript application must require the esri.layers.WFSLayer package in order to use a site with feature WFS layers");r=new g.WFSLayerService}else if(a.drawingBehavior===S.DrawingBehavior.STREAM_LAYER){if(!dojo.isObject(esri.layers.StreamLayer))throw new Error("This Javascript application must require the esri.layers.StreamLayer package in order to use a site with Stream layers");var o=a.layers[0];o&&a.displayName&&(o.displayName=a.displayName),r=new _.StreamLayerService}else r=new m.MapService;r.isUserCreated=!0,r.userLayerType=S.UserLayerType.LAYER_ADDITION,r.essentialsMap=d,r.initialize(a),r instanceof v.FeatureLayerService&&(r.moveEnabled=!0,r.rotateEnabled=!0,r.editVerticesEnabled=!0,r.scaleEnabled=!0);for(var l=0,c=r.layers;l<c.length;l++){var u=c[l];if(u.isUserCreated=!0,u.userLayerType=S.UserLayerType.LAYER_ADDITION,u.includeInLayerList=!0,u.includeInLegend=!0,u.site=d.site,y||(u.configuredVisible=!0,r.supportsLayerVisibility()?u.setVisibility(!0):u._visible=!0),u.subLayerIds&&0<u.subLayerIds.length)u.supportsIdentify=u.supportsQuery=u.identifiable=u.queryable=!1;else{u.identifiable=u.supportsIdentify,u.queryable=u.supportsQuery,u.searchable=!0,u.showMapTips=!0,(r instanceof _.StreamLayerService||r instanceof g.WFSLayerService)&&(u.identifiable=u.supportsIdentify=!0,u.queryable=u.supportsQuery=!1);var p=r.serviceLayer,h=p instanceof esri.layers.GraphicsLayer||p instanceof esri.layers.ArcGISDynamicMapServiceLayer;u.snappable=h,u.snappingEnabled=h}}if(r.serviceLayer.loaded)return t(r);n=r.serviceLayer.on("load",function(e){return n&&n.remove(),s&&s.remove(),t(r)}),s=r.serviceLayer.on("error",function(e){return n&&n.remove(),s&&s.remove(),i(e.error)})})},n);function n(){}t.ServiceDiscoveryUtilities=r})},"geocortex/essentials/utilities/SiteInitializationUtils":function(){define(["require","exports","./../../geocortex","./../RestHelperHTTPService","./../utilities/UrlUtilities"],function(e,t,o,r,a){"use strict";function l(e,t){if("string"==typeof e){var i=Math.max(t.indexOf("?"),t.indexOf("#"));0<=i&&(t=t.substr(0,i)),t=/^(.*?)\/*$/.exec(t)[1],r.RestHelperHTTPService.setDefaultToken(e,t+"/../../")}}function c(){var e=window.location.href,t=e.indexOf("#gcx-");if(0<=t){var i=e.substring(t+5);return window.location.replace("#"),i}return null}Object.defineProperty(t,"__esModule",{value:!0}),t.downloadSite=function(e,t,i,r){void 0===r&&(r=!0);var n=c();function s(){o.request({url:e,content:{f:"json",deep:r},load:function(e){t(e)},error:function(e){i(e)},callbackParamName:"CallBack"})}if(l(n,e),!n){var a=function(){window.removeEventListener?window.removeEventListener("popstate",a,!1):window.detachEvent&&window.detachEvent("onpopstate",a),(n=c())&&(l(n,e),s())};window.addEventListener?window.addEventListener("popstate",a,!1):window.attachEvent&&window.attachEvent("onpopstate",a)}s()},t.detectAndConfigureCors=function(e){var t=new dojo.Deferred;if(window.geocortexDisableEssentialsCorsDetection)return t.resolve(),t;var i=a.UrlUtilities.getUrlComponents(e),r=a.UrlUtilities.getUrlComponents(window.location.href);if(i.origin===r.origin)return t.resolve(),t;var n=(/(.*\/+)sites\/+[^\/]*\/?$/i.exec(e)||[])[1];if(n){var s=n+"info?f=json";dojo.xhrGet({url:s}).then(function(e){esri.config.defaults.io.corsEnabledServers.push(i.host),t.resolve()},function(e){t.resolve()})}else t.resolve();return t},t.updateDefaultToken=l})},"geocortex/essentials/utilities/SiteResourceIdComparer":function(){define(["require","exports","./StringUtilities"],function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=(r.equals=function(e,t){return!(!e||!t||e!==t&&!n.StringUtilities.endsWith(e,this.separator+t))},r.lookUp=function(e,t){if(e&&t){var i=0,r=null;for(i=0;i<e.length;++i)if((r=e[i]).id===t)return r;for(i=0;i<e.length;++i)if(r=e[i],n.StringUtilities.endsWith(r.id,this.separator+t))return r}return null},r.separator="-",r);function r(){}t.SiteResourceIdComparer=i})},"geocortex/essentials/utilities/StringUtilities":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=(r.endsWith=function(e,t){return-1!==e.indexOf(t,e.length-t.length)},r.replaceLayerTokens=function(e,t){if(t)switch(e.toLowerCase()){case"layerid":return t.id;case"layername":return t.name;case"layerdisplayname":return t.displayName;case"layerdescription":return t.description}return""},r.replaceMapServicetokens=function(e,t){if(t)switch(e.toLowerCase()){case"mapserviceid":return t.id;case"mapservicedisplayname":return t.displayName;case"mapserviceurl":return t.url;case"mapservicetoken":return t.serviceToken}return""},r.getDateFromRestDateString=function(e){if(!(e=e.trim())||!/^\/Date\(-?\d+\)\/$/.test(e))return null;var t=e.substring(e.indexOf("(")+1,e.indexOf(")"));return isNaN(t)?null:new Date(parseInt(t,10))},r);function r(){}t.StringUtilities=i,"function"!=typeof String.prototype.endsWith&&(String.prototype.endsWith=function(e){return i.endsWith(this,e)})})},"geocortex/essentials/utilities/Thenable":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/utilities/TimeZoneUtils":function(){define(["require","exports","geocortex/framework/utils/ArrayUtils"],function(e,a,r){"use strict";function n(e){if(!e)return null;var t,i=null;return t=e.timeZoneId,e.essentialsMap&&e.essentialsMap.site&&(i=e.essentialsMap.site.timeZoneId),r.firstOrDefault([t,i],function(e){return!!e})}function s(e,t){if(null==e)return null;if(!t)return e;var i=-moment.tz(e.getTime(),t).utcOffset();return moment(e).add(i,"minutes").toDate()}Object.defineProperty(a,"__esModule",{value:!0}),a.UTC_ZONE_ID="Etc/UTC",a.getTimeZoneFromLayer=function(e){if(!e)return null;var t,i=null;return t=e.timeZoneId,e.mapService&&(i=n(e.mapService)),r.firstOrDefault([t,i],function(e){return!!e})},a.getTimeZoneFromMapService=n,a.getDisplayTimeZoneFromMapService=function(e){return e&&e.essentialsMap&&e.essentialsMap.site?e.essentialsMap.site.displayTimeZoneId:null},a.correctDatesForDisplayInDisplayTimeZone=function(e,t,i){if(null==e)return null;if(t=t||a.UTC_ZONE_ID,!i)return s(e,t);var r=-(-e.getTimezoneOffset()-moment.tz(e.getTime(),i).utcOffset()),n=s(e,t);return moment(n).add(r,"minutes").toDate()},a.correctDatesForDisplayInLocalTime=s,a.correctDatesToSubmitInDatabaseTime=function(e,t,i){if(null==e)return null;t=t||a.UTC_ZONE_ID;var r=moment.tz(e.getTime(),t).utcOffset();if(!i)return moment(e).add(r,"minutes").toDate();var n=r-moment.tz(e.getTime(),i).utcOffset(),s=-e.getTimezoneOffset();return moment(e).add(s+n,"minutes").toDate()},a.correctDatesToQueryInDatabaseTime=function(e,t,i){if(null==e)return null;t=t||a.UTC_ZONE_ID;var r=moment.tz(e.getTime(),t).utcOffset();if(!i){var n=e.getTimezoneOffset();return moment(e).add(n+r,"minutes").toDate()}var s=r-moment.tz(e.getTime(),i).utcOffset();return moment(e).add(s,"minutes").toDate()}})},"geocortex/essentials/utilities/UrlUtilities":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=(s.simplify=function(e){var t=document.createElement("a");t.href=e;var i=t.href,r=i.charAt(i.length-1);return"/"!==r&&"\\"!==r||(i=i.substr(0,i.length-1)),i},s.getUrlComponents=function(e){var t=document.createElement("a");return t.href=e,{host:t.host,hostname:t.hostname,protocol:t.protocol,port:t.port,query:t.search,hash:t.hash,path:t.pathname,origin:t.protocol+"//"+t.host}},s.resolveUrl=function(e,t,i){void 0===i&&(i=!1);var r=e.endsWith("/")?"":"/",n=e+r+t;return i&&(n=s.simplify(n)),n},s.stripProtocol=function(e){return e?e.replace(s.protocolRegex,""):""},s.protocolRegex=/(^\w+:|^)\/\//,s);function s(){}t.UrlUtilities=i})}}})}();require({cache:{"geocortex/essentials":function(){}}});require({cache:{"geocortex/forms/DataItem":function(){define(["require","exports","./../workflow/WorkflowControllerProxy"],function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=(o.prototype.getValue=function(){var e=this.value;return null!=this.typeName&&(e=r._getObjectFromJsonWithType(e,this.typeName)),null!=this.value&&void 0!==this.value.__type&&delete e.__type,e},o);function o(e,t,r){this.display=e,this.value=t,this.typeName=r}t.DataItem=n})},"geocortex/forms/FileItem":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=(n.prototype.getDataUri=function(){return"data:"+this.fileType+";base64,"+this.fileDataBase64},n);function n(){this.fileName=null,this.fileDataBase64=null,this.fileSize=0,this.fileType=null}t.FileItem=r})},"geocortex/forms/FormButton":function(){define(["require","exports","geocortex/framework/observables"],function(e,t,o){"use strict";function r(e,t,r,n){this.label=new o.Observable(e),this.value=new o.Observable(t),this.isDefault=new o.Observable(n||!1),this.causesValidation=new o.Observable(r)}Object.defineProperty(t,"__esModule",{value:!0}),t.FormButton=r})},"geocortex/forms/FormDefinition":function(){define(["require","exports","geocortex/framework/observables","./../forms","./items/ContainerFormItem","./items"],function(e,t,m,c,f,p){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=(n.prototype.addCascading=function(e,t,r){0==this._cascadingMap.hasOwnProperty(e)&&(this._cascadingMap[e]=[]),this._cascadingMap[e].push({formItem:t,handler:r})},n.prototype.map=function(e){this._controlMap[e.itemID.get()]=e},n.prototype.render=function(e){},n.prototype.validate=function(){return this.containerFormItem.validate()},n.prototype.getResults=function(){return this.containerFormItem._getResults()},n.prototype.destroy=function(){this.containerFormItem._destroy()},n.prototype.getFormItemById=function(e){return this.containerFormItem.getFormItemById(e)},n);function n(e,t,r){this.version=null,this.inputData=null,this.containerFormItem=null,this.inputGeometry=null,this.knownTypes=null,this._formManager=null,this._version=1.1,this._formContainer=null,this._cascadingMap=null,this._controlMap=null,this.knownTypes=[],this.inputData=t,this.version=this._version,this._controlMap={},this._cascadingMap={},this.createElementDelegate=function(e,t){return p._processFormItem(e,t)};var n=null;if(e&&(n=dojox.xml.parser.parse(e)),r&&(this.inputGeometry=r),null!=n){var o=n.documentElement,i=c.getElementText(o,"Version");if(parseFloat(i)>this._version)throw new Error("Form version "+i+" is incompatible with current API version "+this._version);this.title=new m.Observable(c.getElementText(o,"Title")),this.maxWidth=new m.Observable(parseInt(c.getElementText(o,"MaxWidth"))),this.maxHeight=new m.Observable(parseInt(c.getElementText(o,"MaxHeight")));var s=c.getElement(o,"KnownTypes");if(null!=s)for(var a=0;a<s.childNodes.length;a++)this.knownTypes.push(s.childNodes[a].firstChild.data);this.containerFormItem=new f.ContainerFormItem(c.getElement(o,"ContainerFormItem"),this)}else this.containerFormItem=new f.ContainerFormItem(null,this),this.containerFormItem.itemID=new m.Observable("Group1"),this.title=new m.Observable(""),this.maxWidth=new m.Observable(NaN),this.maxHeight=new m.Observable(NaN);for(var l in this._cascadingMap)if(this._cascadingMap.hasOwnProperty(l))for(a=0;a<this._cascadingMap[l].length;++a){var u=this._cascadingMap[l][a];this._controlMap[l].queryTaskRunner.cascadingEvent.subscribe(u.formItem,u.handler)}}t.FormDefinition=r})},"geocortex/forms/getItemType":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getItemType=function(e){var t="";if(null!=e&&null!=e.attributes)for(var r=0;r<e.attributes.length;r++)if(0<=String(e.attributes[r].nodeName).indexOf("type")){var n=e.attributes[r].nodeValue,o=n.indexOf(":");0<=o&&o+1<n.length&&(n=n.substr(o+1)),t=n;break}return t}})},"geocortex/forms/items":function(){define(["require","exports","./getItemType","./items/AutoCompleteBoxFormItem","./items/CheckBoxFormItem","./items/ContainerFormItem","./items/ComboBoxFormItem","./items/DatePickerFormItem","./items/FilePickerFormItem","./items/GroupBoxFormItem","./items/HyperlinkFormItem","./items/ImageFormItem","./items/ListBoxFormItem","./items/MarkdownFormItem","./items/RadioButtonFormItem","./items/TextAreaFormItem","./items/TextBoxFormItem","./items/TimePickerFormItem"],function(e,t,o,i,s,a,l,u,m,c,f,p,d,h,b,g,v,y){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t._processFormItem=function r(e,t){var n=null;switch(o.getItemType(e)){case"AutoCompleteBoxFormItem":n=new i.AutoCompleteBoxFormItem(e,t);break;case"CheckBoxFormItem":n=new s.CheckBoxFormItem(e,t);break;case"ContainerFormItem":(n=new a.ContainerFormItem(e,t)).createElementDelegate=function(e,t){return r(e,t)};break;case"ComboBoxFormItem":n=new l.ComboBoxFormItem(e,t);break;case"DatePickerFormItem":n=new u.DatePickerFormItem(e,t);break;case"FilePickerFormItem":n=new m.FilePickerFormItem(e,t);break;case"GroupBoxFormItem":n=new c.GroupBoxFormItem(e,t);break;case"HyperlinkFormItem":n=new f.HyperlinkFormItem(e,t);break;case"ImageFormItem":n=new p.ImageFormItem(e,t);break;case"ListBoxFormItem":n=new d.ListBoxFormItem(e,t);break;case"MarkdownFormItem":n=new h.MarkdownFormItem(e,t);break;case"RadioButtonFormItem":n=new b.RadioButtonFormItem(e,t);break;case"TextAreaFormItem":n=new g.TextAreaFormItem(e,t);break;case"TextBoxFormItem":n=new v.TextBoxFormItem(e,t);break;case"TimePickerFormItem":n=new y.TimePickerFormItem(e,t)}return n.dataItems&&null!=t&&null!=t.inputData&&t.inputData.hasOwnProperty(n.itemID)&&n.dataItems.addItems(t.inputData.item(n.itemID)),n}})},"geocortex/forms/items/AutoCompleteBoxFormItem":function(){var n,m=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});define(["require","exports","./TextBoxFormItem","./QueryTaskFormItem","geocortex/framework/observables","./../../forms","./DataItemsFormItem"],function(e,t,r,n,o,i,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a,l=(a=r.TextBoxFormItem,m(u,a),u.prototype.clearDataItems=function(){this.dataItems.clear()},u);function u(e,t){var r=a.call(this,e,t)||this;return r.isBusy=new o.Observable(!1),r.formItemType="AutoCompleteBoxFormItem",e?(r.minimumPrefixLength=new o.Observable(parseInt(i.getElementText(e,"MinimumPrefixLength"))),r.minimumPopulateDelay=new o.Observable(parseInt(i.getElementText(e,"MinimumPopulateDelay")))):(r.minimumPrefixLength=new o.Observable(3),r.minimumPopulateDelay=new o.Observable(200)),s.initDataItemsFormItem(r,e,t),r.queryTaskRunner=new n.QueryTaskRunner(r,e,t),r}t.AutoCompleteBoxFormItem=l})},"geocortex/forms/items/CheckBoxFormItem":function(){var n,u=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});define(["require","exports","./FormItem","geocortex/framework/observables","./../../forms","./FormItemResult"],function(e,t,r,n,o,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s,a=(s=r.AbstractFormItem,u(l,s),l.prototype.getResult=function(){return new i.FormItemResult(this.argumentName.get(),this.checked.get())},l.prototype._render=function(){return o.renderFormItem(this)},l);function l(e,t){var r=s.call(this,e,t)||this;return r.formItemType="CheckBoxFormItem",e?(r.text=new n.Observable(o.getElementText(e,"Text")),r.checked=new n.Observable(o._parseBoolean(o.getElementText(e,"Checked"))),r.textLocation=new n.Observable(o.getElementText(e,"TextLocation"))):(r.text=new n.Observable(""),r.checked=new n.Observable(!1),r.textLocation=new n.Observable("Right")),r.checked.bind(null,function(e){return r._notifyResultChanged()}),r}t.CheckBoxFormItem=a})},"geocortex/forms/items/ComboBoxFormItem":function(){var n,d=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});define(["require","exports","./FormItem","./LabelContainer","./QueryTaskFormItem","geocortex/framework/observables","./../DataItem","./DataItemsFormItem","./../../forms","./FormItemResult","geocortex/framework/utils/utils"],function(e,t,r,s,a,l,n,u,m,o,c){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var f,i=(f=r.AbstractFormItem,d(p,f),p.prototype.clearDataItems=function(){this.dataItems.clear(),this.selected.set(null),this._defaultSet=!1},p.prototype.triggerCascading=function(e){null!=this.selected.get()&&e||this.queryTaskRunner.cascadingEvent.publish(null);var t=this.selected.get();null===t&&(t=e),null==t?this.queryTaskRunner.cascadingEvent.publish(null):this.queryTaskRunner.cascadingEvent.publish(t.value)},p.prototype.prepareForResults=function(){if(this.selectText.get()){var e=this.selectText.get(),t=new n.DataItem(e,"",null);this.dataItems.insertItem(0,t)}},p.prototype.handleResultsComplete=function(){this._defaultSet||(this._selectDefaultValue(),null!=this.selected.get()&&(this._defaultSet=!0,this.triggerCascading(this.selected.get())))},p.prototype.getResult=function(){if(null==this.selected.get())return new o.FormItemResult(this.argumentName.get(),null);var e=this.selected.get();return e?new o.FormItemResult(this.argumentName.get(),e.getValue()):new o.FormItemResult(this.argumentName.get(),null)},p.prototype._addOption=function(e,t){this.dataItems.addItem(new n.DataItem(e,t))},p.prototype._selectDefaultValue=function(){var e=dojo.filter(this.dataItems.getItems(),dojo.hitch(this,function(e){return!!this.defaultSelectedValue.get()&&e.value+""==this.defaultSelectedValue.get()+""}));0<e.length?this.selected.set(e[0]):0<this.dataItems.length()&&this.selected.set(this.dataItems.getAt(0))},p.prototype._render=function(){return m.renderFormItem(this)},p);function p(e,t){var r=f.call(this,e,t)||this;if(r._defaultSet=!1,r.selectText=new l.Observable,r.selected=new l.Observable,r.defaultSelectedValue=new l.Observable,r.isBusy=new l.Observable(!1),r.formItemType="ComboBoxFormItem",s.initLabelContainer(r,e,t),u.initDataItemsFormItem(r,e,t),r.queryTaskRunner=new a.QueryTaskRunner(r,e,t),e){var n=m.getElementText(e,"SelectText");n&&r.selectText.set(n);var o=m.getElementText(e,"SelectedValue");o&&r.defaultSelectedValue.set(o)}r.selected.bind(null,function(e){return r._notifyResultChanged()}),r.prepareForResults(),r.queryTaskRunner.isQueryable()||r._selectDefaultValue();var i=r.queryTaskRunner.queryCascadingID.get();return!c.isNullOrUndefined(i)&&""!==i||r.queryTaskRunner.performQuery(""),r}t.ComboBoxFormItem=i})},"geocortex/forms/items/ContainerFormItem":function(){var n,o=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});define(["require","exports","./FormItem","geocortex/framework/observables","./../../forms"],function(e,t,r,s,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var l,n=(l=r.AbstractFormItem,o(u,l),u.prototype.validate=function(){var e=[];if(this.isVisible.get()&&null!=this.formItems)for(var t=0;t<this.formItems.getLength();++t){var r=this.formItems.getAt(t);if(r.isVisible.get())for(var n=r.validate(),o=0;o<n.length;++o)e.push(n[o])}return e},u.prototype._getResults=function(){for(var e=[],t=0;t<this.formItems.getLength();++t){var r=this.formItems.getAt(t);if(r.isVisible.get())if(r instanceof u){var n=r._getResults();if(null!=n)for(var o=0;o<n.length;++o)e.push(n[o])}else{var i=r.getResult();null!=i&&e.push(i)}}return e},u.prototype._destroy=function(){for(var e=this.formItems.length()-1;0<=e;e--)this.formItems.getAt(e)._destroy();this.formItems.clear()},u.prototype._render=function(){return a.renderFormItem(this)},u.prototype.getFormItemById=function(e){for(var t=0,r=this.formItems.length();t<r;t++){var n=this.formItems.getAt(t);if(n.itemID.get()===e)return n;if(n.getFormItemById&&(n=n.getFormItemById(e)))return n}return null},u.prototype.applyVisibility=function(e){if(e){var t=!1,r=e.getResult();if(null!==r&&null!==r.value){var n=this.visibleControlValue.get();if(n)if(r.isList){var o=r.value;if(o)for(var i=0;i<o.length;i++)if(o[i].toString()===n){t=!0;break}}else t=!0===r.value||!1===r.value?r.value.toString().toUpperCase()===n.toUpperCase():r.value.toString()===n;else 1==r.value&&(t=!0)}this.isVisible.set(t)}},u.prototype.getDisplayName=function(){return null},u);function u(e,r){var t=l.call(this,e,r)||this;if(t.formItems=new s.ObservableCollection,t.formItemType="ContainerFormItem",t.createElementDelegate=function(e,t){return r.createElementDelegate(e,t)},e){t.orientation=new s.Observable(a.getElementText(e,"Orientation")),t.description=new s.Observable(a.getElementText(e,"Description")),t.maxWidth=new s.Observable(parseInt(a.getElementText(e,"MaxWidth"))),t.visibleControlID=new s.Observable(a.getElementText(e,"VisibleControlID")),t.visibleControlValue=new s.Observable(a.getElementText(e,"VisibleControlValue"));var n=a.getElement(e,"FormItems");if(null!=n)for(var o=0;o<n.childNodes.length;o++){var i=r.createElementDelegate(n.childNodes[o],t.formDefinition);null!=i&&(t.formItems.addItem(i),i.refresh=function(){var e=t.formItems.indexOf(t);0<=e&&(t.formItems.removeAt(e),t.formItems.insertItem(e,t))})}}else t.orientation=new s.Observable("Vertical"),t.description=new s.Observable(""),t.maxWidth=new s.Observable(NaN),t.visibleControlID=new s.Observable(""),t.visibleControlValue=new s.Observable("");return t}t.ContainerFormItem=n})},"geocortex/forms/items/DataItemsFormItem":function(){define(["require","exports","geocortex/framework/observables","./../DataItem","./../../forms"],function(e,t,u,m,c){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.initDataItemsFormItem=function(e,t,r){if(e.dataItems=new u.ObservableCollection,t){var n=c.getElement(t,"DataItems");if(null!=n)for(var o=0;o<n.childNodes.length;o++){var i=n.childNodes[o],s=new m.DataItem(c.getElementText(i,"Display"),c.getElementText(i,"Value"),c.getElementText(i,"TypeName"));null!=s&&e.dataItems.addItem(s)}}if(r){var a=r.inputData;if(a&&a.hasOwnProperty(e.itemID.get())){var l=a[e.itemID.get()];e.dataItems.addItems(l)}}}})},"geocortex/forms/items/DatePickerFormItem":function(){var n,s=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});define(["require","exports","./FormItem","./LabelContainer","geocortex/framework/observables","./TimePickerFormItem","./../../forms","geocortex/framework/utils/DateUtils","./FormItemResult"],function(e,t,r,p,d,h,b,g,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var v,n=(v=r.AbstractFormItem,s(i,v),i.prototype.getResult=function(){var e=this.date.get(),t=null===e?null:new Date(e.toString());if(t)if(isNaN(t.getTime()))t=this.initialDate.get();else{var r=0,n=!this.attached_pickerType||!this.attached_pickerType.get||-1<this.attached_pickerType.get().toLowerCase().indexOf("native");e instanceof Date||this.includeTimePicker.get()||!n||(r=6e4*t.getTimezoneOffset()),t="/Date({0})/".format(t.getTime()+r)}return new o.FormItemResult(this.argumentName.get(),t)},i.prototype._render=function(){return b.renderFormItem(this)},i);function i(e,t){var r=v.call(this,e,t)||this;r.nullable=new d.Observable(!1),r.readOnly=new d.Observable(!1),r.formItemType="DatePickerFormItem",p.initLabelContainer(r,e,t);var n=!0;if(e){for(var o=!0,i=e.getElementsByTagNameNS?e.getElementsByTagNameNS("http://schemas.datacontract.org/2004/07/Geocortex.Forms.Client.Items.Validation","ValidationItem"):e.getElementsByTagName("ValidationItem"),s=0;s<i.length;s++){var a=i[s].getAttributeNS("http://www.w3.org/2001/XMLSchema-instance","type");if(a&&0<=a.indexOf("RequiredValidationItem")){o=!1;break}}r.nullable.set(o),r.dateFormat=new d.Observable(b.getElementText(e,"DateFormat")),r.includeTimePicker=new d.Observable("true"===b.getElementText(e,"IncludeTimePicker"));var l=null;r.includeTimePicker.get()&&(r.timePickerItem=new h.TimePickerFormItem(b.getElement(e,"TimePickerItem")),l=r.timePickerItem.initialTime.get());var u=b.getElementText(e,"InitialDate");if(n=null===b.getElementText(e,"InitializeWithCurrentDate")?!u:"true"===b.getElementText(e,"InitializeWithCurrentDate"),u){if(g.containsTimezone(u)){var m=Math.max(u.lastIndexOf("Z"),u.lastIndexOf("+"),u.lastIndexOf("-"));0<m&&(u=u.substring(0,m))}u+=g.getTimezoneString()}var c=null;(n||u)&&(c=new Date(u)),c&&!isNaN(c.getTime())?(c.getTimezoneOffset()!=g.getTimezoneOffset()&&c.setTime(c.getTime()-6e4*(g.getTimezoneOffset()-c.getTimezoneOffset())),l&&(c.setHours(l.getHours()),c.setMinutes(l.getMinutes()),c.setSeconds(l.getSeconds())),r.initialDate=new d.Observable(c)):r.initialDate=new d.Observable(l)}else r.dateFormat=new d.Observable,r.initialDate=new d.Observable(null),r.includeTimePicker=new d.Observable(!1);if(n){var f=new Date;r.includeTimePicker.get()||(f.setHours(0),f.setMinutes(0),f.setSeconds(0)),r.date=new d.Observable(f),r.initialDate.set(f)}else r.date=new d.Observable(r.initialDate.get());return r.date.bind(null,function(e){return r._notifyResultChanged()}),r}t.DatePickerFormItem=n})},"geocortex/forms/items/FilePickerFormItem":function(){var n,c=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});define(["require","exports","./FormItem","./LabelContainer","geocortex/framework/observables","./../../forms","./FormItemResult","./../../workflow/ArgumentValueWrapper"],function(e,t,r,n,o,i,s,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var l,u=(l=r.AbstractFormItem,c(m,l),m.prototype.clear=function(){this.files.clear(),this.refresh()},m.prototype.getResult=function(){for(var e=[],t=0;t<this.files.getLength();++t){var r=this.files.getAt(t);r&&e.push(r)}var n=new a.ArgumentValueWrapper("System.Collections.Generic.List`1[[Geocortex.Forms.Client.FileItem, Geocortex.EssentialsWpfApi]]",e),o=new s.FormItemResult(this.argumentName.get(),n,!0);return o.isList=!0,o},m.prototype._render=function(){return i.renderFormItem(this)},m.prototype._isFileInputSupported=function(){if(navigator.userAgent.match(/(Android (1.0|1.1|1.5|1.6|2.0|2.1))|(Windows Phone (OS 7|8.0))|(XBLWP)|(ZuneWP)|(w(eb)?OSBrowser)|(webOS)|(Kindle\/(1.0|2.0|2.5|3.0))/))return!1;var e=document.createElement("input");return e.type="file",!e.disabled},m);function m(e,t){var r=l.call(this,e,t)||this;return r.files=new o.ObservableCollection,r.formItemType="FilePickerFormItem",r.isSupported=new o.Observable("undefined"!=typeof FileReader&&r._isFileInputSupported()),e?(r.acceptFileTypes=new o.Observable(i.getElementText(e,"AcceptFileTypes")),r.allowMultiple=new o.Observable(i._parseBoolean(i.getElementText(e,"AllowMultiple")))):(r.acceptFileTypes=new o.Observable(null),r.allowMultiple=new o.Observable(!1)),n.initLabelContainer(r,e,t),r.files.bind(null,function(e){return r._notifyResultChanged()}),r}t.FilePickerFormItem=u})},"geocortex/forms/items/FormItem":function(){define(["require","exports","geocortex/framework/observables","./../../forms","./../getItemType","./validation/NumericRangeValidationItem","./validation/RequiredValidationItem","./validation/RegexValidationItem","./validation/FileSizeValidationItem"],function(e,t,s,a,r,n,o,i,l){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var u=(m.prototype.getResult=function(){return null},m.prototype._notifyResultChanged=function(){dojo.publish("FormItemResultChangedEvent",[this])},m.prototype.refresh=function(){},m.prototype.validate=function(){var e=[];if(this.isValid.set(!0),null!=this.validationItems)for(var t=0;t<this.validationItems.length;t++){var r=this.getResult();null!=r&&(r=r.value);var n=this.validationItems[t].validate(r);n.isValid||(this.isValid.set(!1),e.push(n))}return e},m.prototype._render=function(){return document.createTextNode(this.itemID.get())},m.prototype._destroy=function(){},m);function m(e,t){if(this.isRequired=new s.Observable(!1),this.isValid=new s.Observable(!0),this.isVisible=new s.Observable(!0),this.argumentName=null,this.validationItems=[],this.formDefinition=t||null,this.attached_indicatorClass=new s.Observable(""),this.attached_showIndicator=new s.Observable(""),e){this.toolTip=new s.Observable(a.getElementText(e,"ToolTip")),this.itemID=new s.Observable(a.getElementText(e,"ItemID")),this.argumentName=new s.Observable(a.getElementText(e,"ArgumentName"));var r=a.getElementText(e,"IsVisible");r&&this.isVisible.set(a._parseBoolean(r));var n=a.getElement(e,"ValidationItems");if(null!=n)for(var o=0;o<n.childNodes.length;o++){var i=c(n.childNodes[o]);i instanceof geocortex.forms.items.validation.RequiredValidationItem&&this.isRequired.set(!0),null!=i&&this.validationItems.push(i)}}else this.toolTip=new s.Observable(""),this.itemID=new s.Observable(null),this.argumentName=new s.Observable(null)}function c(e){var t=null;switch(r.getItemType(e)){case"NumericRangeValidationItem":t=new n.NumericRangeValidationItem(e);break;case"RequiredValidationItem":t=new o.RequiredValidationItem(e);break;case"RegexValidationItem":t=new i.RegexValidationItem(e);break;case"FileSizeValidationItem":t=new l.FileSizeValidationItem(e)}return t}t.AbstractFormItem=u})},"geocortex/forms/items/FormItemResult":function(){define(["require","exports"],function(e,t){"use strict";function r(e,t,r){this.isList=!1,this.argumentName=e,this.value=t,this.wasSet=r||!1}Object.defineProperty(t,"__esModule",{value:!0}),t.FormItemResult=r})},"geocortex/forms/items/GroupBoxFormItem":function(){var n,l=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});define(["require","exports","./ContainerFormItem","geocortex/framework/observables","./../../forms"],function(e,t,r,n,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i,s=(i=r.ContainerFormItem,l(a,i),a.prototype._render=function(){return o.renderFormItem(this)},a.prototype.getDisplayName=function(){return this.header.get()},a);function a(e,t){var r=i.call(this,e,t)||this;return r.formItemType="GroupBoxFormItem",r.header=e?new n.Observable(o.getElementText(e,"Header")):new n.Observable(null),r}t.GroupBoxFormItem=s})},"geocortex/forms/items/HyperlinkFormItem":function(){var n,u=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});define(["require","exports","./FormItem","geocortex/framework/observables","./../../forms","./FormItemResult"],function(e,t,r,n,o,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s,a=(s=r.AbstractFormItem,u(l,s),l.prototype.getResult=function(){return new i.FormItemResult(this.argumentName.get(),this.wasClicked.get(),this.wasClicked.get())},l.prototype._render=function(){return o.renderFormItem(this)},l);function l(e,t){var r=s.call(this,e,t)||this;return r.wasClicked=new n.Observable(!1),r.formItemType="HyperlinkFormItem",e?(r.hyperlinkText=new n.Observable(o.getElementText(e,"HyperlinkText")),r.target=new n.Observable(o.getElementText(e,"Target")),r.uri=new n.Observable(o.getElementText(e,"Uri"))):(r.hyperlinkText=new n.Observable("Hyperlink"),r.target=new n.Observable("_blank"),r.uri=new n.Observable("")),r.wasClicked.bind(null,function(e){return r._notifyResultChanged()}),r}t.HyperlinkFormItem=a})},"geocortex/forms/items/ImageFormItem":function(){var n,l=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});define(["require","exports","./FormItem","geocortex/framework/observables","./../../forms"],function(e,t,r,i,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a,n=(a=r.AbstractFormItem,l(o,a),o.prototype._render=function(){return s.renderFormItem(this)},o);function o(e,t){var r=a.call(this,e,t)||this;if(r.formItemType="ImageFormItem",e){r.source=new i.Observable(s.getElementText(e,"Source")),r.width=new i.Observable(s.getElementText(e,"Width")),r.height=new i.Observable(s.getElementText(e,"Height"));var n=r.width.get(),o=r.height.get();n&&o?parseInt(n)>parseInt(o)?r.height.set("auto"):r.width.set("auto"):(r.width=new i.Observable("auto"),r.height=new i.Observable("auto"))}else r.source=new i.Observable(""),r.width=new i.Observable("auto"),r.height=new i.Observable("auto");return r}t.ImageFormItem=n})},"geocortex/forms/items/LabelContainer":function(){define(["require","exports","./LabelFormItem","./../../forms"],function(e,t,n,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.initLabelContainer=function(e,t,r){t?(e.label=new n.LabelFormItem(o.getElement(t,"Label")),""==e.label.toolTip.get()&&null!=e.toolTip&&e.label.toolTip.set(e.toolTip.get())):e.label=new n.LabelFormItem(null)}})},"geocortex/forms/items/LabelFormItem":function(){var n,l=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});define(["require","exports","./FormItem","geocortex/framework/observables","./../../forms"],function(e,t,r,n,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i,s=(i=r.AbstractFormItem,l(a,i),a.prototype._render=function(){return o.renderFormItem(this)},a);function a(e,t){var r=i.call(this,e,t)||this;return r.formItemType="LabelFormItem",e?(r.text=new n.Observable(o.getElementText(e,"Text")),r.labelForItemID=new n.Observable(o.getElementText(e,"LabelForItemID"))):(r.text=new n.Observable(null),r.labelForItemID=new n.Observable(null)),r}t.LabelFormItem=s})},"geocortex/forms/items/ListBoxFormItem":function(){var n,s=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});define(["require","exports","./FormItem","./LabelContainer","./QueryTaskFormItem","./LabelFormItem","geocortex/framework/observables","./DataItemsFormItem","./../../forms","./FormItemResult"],function(e,t,r,l,u,m,c,f,p,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var d,n=(d=r.AbstractFormItem,s(i,d),i.prototype.clearDataItems=function(){this.dataItems.clear()},i.prototype._setDefaults=function(){for(var e=0;e<this.dataItems.getItems().length;e++){var t=this.dataItems.getAt(e);this._selectedValuesLookup[t.value.toString()]&&this.selection.addItem(t)}},i.prototype.handleResultsComplete=function(){this._setDefaults()},i.prototype.triggerCascading=function(e){null!=this.selection&&e||this.queryTaskRunner.cascadingEvent.publish(null);var t=null;null!=this.selection&&(t=this.selection.getAt(0)),null==t&&null!=e&&(t=e),null==t?this.queryTaskRunner.cascadingEvent.publish(null):this.queryTaskRunner.cascadingEvent.publish(t.value)},i.prototype.getResult=function(){var e=null;if("single"==this.selectionMode.get().toLowerCase())return 0<this.selection.getLength()&&(e=(n=this.selection.getAt(0))?n.getValue():null),new o.FormItemResult(this.argumentName.get(),e,!0);for(var t=[],r=0;r<this.selection.getLength();++r){var n;(e=(n=this.selection.getAt(r))?n.getValue():null)&&t.push(e)}return(e=new o.FormItemResult(this.argumentName.get(),t,!0)).isList=!0,e},i.prototype._render=function(){return p.renderFormItem(this)},i);function i(e,t){var r=d.call(this,e,t)||this;if(r.selection=new c.ObservableCollection,r.selectedValues=new c.ObservableCollection,r._selectedValuesLookup=null,r.isBusy=new c.Observable(!1),r.formItemType="ListBoxFormItem",l.initLabelContainer(r,e,t),f.initDataItemsFormItem(r,e,t),r.size=new c.Observable(6),e){r.maxHeight=new c.Observable(parseInt(p.getElementText(e,"MaxHeight"))),r.selectionMode=new c.Observable(p.getElementText(e,"SelectionMode"));var n=p.getElementText(e,"Size");if(n){var o=parseInt(n);0<o&&r.size.set(o)}var i=p.getElement(e,"SelectedValues");if(i){var s;for(r._selectedValuesLookup={},s=0;s<i.childNodes.length;s++){var a=i.childNodes[s].textContent;r.selectedValues.addItem(a),r._selectedValuesLookup[a+""]=!0}r._setDefaults(),0===r.selection.length()&&0!==r.dataItems.getItems().length&&r.selection.addItem(r.dataItems.getAt(0))}}else r.label=new m.LabelFormItem(null,r.formDefinition),r.maxHeight=new c.Observable(NaN),r.selectionMode=new c.Observable("Single");return r.queryTaskRunner=new u.QueryTaskRunner(r,e,t),r.queryTaskRunner.queryCascadingID.get()||r.queryTaskRunner.performQuery(""),r.selection.bind(null,function(e){setTimeout(function(){r._notifyResultChanged()},0)}),r}t.ListBoxFormItem=n})},"geocortex/forms/items/MarkdownFormItem":function(){var n,l=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});define(["require","exports","./FormItem","geocortex/framework/observables","./../../forms"],function(e,t,r,n,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i,s=(i=r.AbstractFormItem,l(a,i),a.prototype._render=function(){return o.renderFormItem(this)},a);function a(e,t){var r=i.call(this,e,t)||this;return r.formItemType="MarkdownFormItem",r.plainText=e?new n.Observable(o.getElementText(e,"PlainText")):new n.Observable(""),r}t.MarkdownFormItem=s})},"geocortex/forms/items/QueryTaskFormItem":function(){define(["require","exports","geocortex/framework/observables","geocortex/framework/events/Event","./../../forms","./../../essentials/RestHelper","./../DataItem","./../../essentials/Field","./../../essentials/RestHelperHTTPService"],function(e,t,o,i,s,a,v,y,l){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=(n.prototype.triggerCascading=function(e){this.cascadingEvent.publish(e)},n.prototype.isQueryable=function(){return null!=this.queryServiceUrl.get()&&""!==dojo.trim(this.queryServiceUrl.get())&&null!=this.queryWhereClause.get()&&""!==dojo.trim(this.queryWhereClause.get())&&null!=this.queryDisplayOutputField.get()&&""!==dojo.trim(this.queryDisplayOutputField.get())},n.prototype.performQuery=function(e,h){var b=this;if(this.isQueryable()&&(this.formItem.dataItems.clear(),null!=e)){var t=null;this.filterByInputGeometry.get()&&null!=this.formItem.formDefinition&&this.formItem.formDefinition.inputGeometry&&(t=this.formItem.formDefinition.inputGeometry);var r,n=this.queryServiceUrl.get();if(this.proxyUrl.get()&&void 0===esri.getProxyRule(n)&&esri.addProxyRule({proxyUrl:this.proxyUrl.get(),urlPrefix:n}),this.token&&this.token.get()&&(n=l.RestHelperHTTPService.appendTokenToUrl(n,this.token.get())),this.layerSourceJson&&this.layerSourceJson.get()){var o=a.RestHelper.getJsonObjectFromJsonString(this.layerSourceJson.get()),i={source:a.RestHelper.getLayerSourceFromJsonObject(o)};r=new esri.tasks.QueryTask(n,i)}else r=new esri.tasks.QueryTask(n);var g,s=new esri.tasks.Query;s.returnGeometry=!1,s.geometry=t,s.outFields=[],s.where=this._getWhereClause(e),s.outFields.push(this.queryDisplayOutputField.get()),null!=this.queryValueOutputField.get()&&""!=dojo.trim(this.queryValueOutputField.get())&&this.queryValueOutputField.get()!=this.queryDisplayOutputField.get()&&s.outFields.push(this.queryValueOutputField.get()),s.outFields.every(function(e){return-1!==e.indexOf(".")})||(s.returnDistinctValues=!0),this.isBusy.set(!0),++this._queryId,g=b._queryId,r.execute(s,function(e){var t=[];if(g==b._queryId){for(var r=0;r<e.features.length;++r){var n,o=e.features[r].attributes,i=null;null!=b.queryDisplayOutputField.get()&&(i=o[b.queryDisplayOutputField.get().trim()]),n=null!=b.queryValueOutputField.get()&&""!=dojo.trim(b.queryValueOutputField.get())&&b.queryValueOutputField.get()!=b.queryDisplayOutputField.get()?o[b.queryValueOutputField.get().trim()]:i,t.push(new v.DataItem(i,n,null))}if(t.sort(function(e,t){return e.display<t.display?-1:1}),b.formatCallback){var s=y.EsriFieldTypes.esriFieldTypeString;if(e.fields){var a=e.fields.filter(function(e){return e.name===b.queryDisplayOutputField.get()})[0];a&&(s=a.type)}t.forEach(function(e){e.display=b.formatCallback(e.display,s)})}b.formItem.prepareForResults&&b.formItem.prepareForResults();for(var l,u={},m=[],c=0;c<t.length;++c){var f=t[c],p=(l=f).display+"-"+l.value;u.hasOwnProperty(p)||(u[p]=!0,m.push(f))}b.formItem.dataItems.addItems(m),b.isBusy.set(!1);var d=null;0<b.formItem.dataItems.getLength()&&(d=b.formItem.dataItems.getAt(0)),!0===h&&b.triggerCascading(null==d?null:d.value),b.formItem.handleResultsComplete&&b.formItem.handleResultsComplete()}})}},n.prototype._getWhereClause=function(e){var s=this,t=this.queryWhereClause.get();return t=(t=t.replace(/{1:([a-zA-Z0-9]+)(:[a-zA-Z0-9]+)?}/g,function(e,t,r){var n=s.formItem.formDefinition.getFormItemById(t);if(!n)return"{unknown form item "+t+"}";var o=n.getResult().value;if(!r)return o;if(":SQL"===r)return s._escapeForWhere(o);var i=/:[fF](\d+)/.exec(r);return i?parseFloat(o).toFixed(+i[1]):"{unknown format clause "+r+"}"})).format(this._escapeForWhere(e))},n.prototype._escapeForWhere=function(e){return e&&"number"==typeof e&&(e=e.toString()),(e||"").replace(/\'/g,"''")},n);function n(e,t,r){if(this.cascadingEvent=new i.Event("cascadingEvent"),this.isBusy=new o.Observable(!1),this._queryId=0,e.queryTaskRunner||(e.queryTaskRunner=this),e.queryTaskRunner!==this)throw new Error("FormItem in the constructor must be the QueryTaskFormItem containing the QueryTaskRunner");this.formItem=e,t?(this.queryDisplayOutputField=new o.Observable(s.getElementText(t,"QueryDisplayOutputField")),this.queryValueOutputField=new o.Observable(s.getElementText(t,"QueryValueOutputField")),this.queryServiceUrl=new o.Observable(s.getElementText(t,"QueryServiceUrl")),this.queryWhereClause=new o.Observable(s.getElementText(t,"QueryWhereClause")),this.filterByInputGeometry=new o.Observable(s._parseBoolean(s.getElementText(t,"FilterByInputGeometry"))),this.queryCascadingID=new o.Observable(s.getElementText(t,"QueryCascadingID")),this.proxyUrl=new o.Observable(s.getElementText(t,"ProxyUrl")),this.token=new o.Observable(s.getElementText(t,"Token")),s.getElementText(t,"LayerSourceJson")&&(this.layerSourceJson=new o.Observable(s.getElementText(t,"LayerSourceJson")))):(this.queryDisplayOutputField=new o.Observable(null),this.queryValueOutputField=new o.Observable(null),this.queryServiceUrl=new o.Observable(null),this.queryWhereClause=new o.Observable(null),this.filterByInputGeometry=new o.Observable(!1),this.queryCascadingID=new o.Observable(null),this.proxyUrl=new o.Observable(null),this.token=new o.Observable(null)),e.formDefinition&&e.formDefinition.map(e);var n=this.queryCascadingID.get();null!=n&&""!=n&&e.formDefinition.addCascading(n,e,function(e){e?this.queryTaskRunner.performQuery(e):(this.clearDataItems(),this.triggerCascading(null))}),e.isBusy||(e.isBusy=new o.Observable(!1)),e.isBusy.sync(this.isBusy)}t.QueryTaskRunner=r})},"geocortex/forms/items/RadioButtonFormItem":function(){var n,m=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});define(["require","exports","./FormItem","geocortex/framework/observables","./../../forms","./FormItemResult","./ContainerFormItem"],function(e,t,r,n,o,i,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a,l=(a=r.AbstractFormItem,m(u,a),u.prototype.getResult=function(){var e=this.__getRadioValueClosure,t=!!e&&e();return new i.FormItemResult(this.argumentName.get(),t)},u.prototype._render=function(){return o.renderFormItem(this)},u._findButtonsInGroup=function(t,e){var r=[];return e&&e.formItems.get().forEach(function(e){e instanceof u?e.groupName.get()===t&&r.push(e):e instanceof s.ContainerFormItem&&u._findButtonsInGroup(t,e).forEach(function(e){return r.push(e)})}),r},u);function u(e,t){var r=a.call(this,e,t)||this;return r.formItemType="RadioButtonFormItem",e?(r.text=new n.Observable(o.getElementText(e,"Text")),r.checked=new n.Observable(o._parseBoolean(o.getElementText(e,"Checked"))),r.textLocation=new n.Observable(o.getElementText(e,"TextLocation")),r.groupName=new n.Observable(o.getElementText(e,"GroupName"))):(r.text=new n.Observable(null),r.checked=new n.Observable(!1),r.textLocation=new n.Observable("Right"),r.groupName=new n.Observable(null)),r.checked.bind(null,function(e){e&&u._findButtonsInGroup(r.groupName.get(),r.formDefinition.containerFormItem).forEach(function(e){e!==r&&e.checked.set(!1)}),r._notifyResultChanged()}),r}t.RadioButtonFormItem=l})},"geocortex/forms/items/TextAreaFormItem":function(){var n,l=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});define(["require","exports","./TextBoxFormItem","geocortex/framework/observables","./../../forms"],function(e,t,r,n,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i,s=(i=r.TextBoxFormItem,l(a,i),a);function a(e,t){var r=i.call(this,e,t)||this;return r.formItemType="TextAreaFormItem",r.textboxHeight=e?new n.Observable(parseInt(o.getElementText(e,"TextboxHeight"))):new n.Observable(1),r}t.TextAreaFormItem=s})},"geocortex/forms/items/TextBoxFormItem":function(){var n,m=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});define(["require","exports","./FormItem","./LabelContainer","geocortex/framework/observables","./../../forms","./FormItemResult"],function(e,t,r,o,i,s,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a,l=(a=r.AbstractFormItem,m(u,a),u.prototype.getResult=function(){return new n.FormItemResult(this.argumentName.get(),this.text.get())},u.prototype._render=function(){return s.renderFormItem(this)},u);function u(e,t){var r=a.call(this,e,t)||this;if(r.formItemType="TextBoxFormItem",e){var n=s.getElementText(e,"DefaultText");r.defaultText=new i.Observable(n),r.text=new i.Observable(n),r.inputScope=new i.Observable(s.getElementText(e,"InputScope")),r.textboxWidth=new i.Observable(parseInt(s.getElementText(e,"TextboxWidth"))),r.readOnly=new i.Observable(s._parseBoolean(s.getElementText(e,"ReadOnly")))}else r.defaultText=new i.Observable(""),r.text=new i.Observable(""),r.inputScope=new i.Observable("Default"),r.textboxWidth=new i.Observable(NaN),r.readOnly=new i.Observable(!1);return o.initLabelContainer(r,e,t),r.text.bind(null,function(e){return r._notifyResultChanged()}),r}t.TextBoxFormItem=l})},"geocortex/forms/items/TimePickerFormItem":function(){var n,s=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});define(["require","exports","./FormItem","./LabelContainer","geocortex/framework/observables","./../../forms","geocortex/framework/utils/DateUtils","./FormItemResult"],function(e,t,r,u,m,c,f,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var p,o=(p=r.AbstractFormItem,s(i,p),i.prototype.getResult=function(){var e=this.time.get();return e&&(e=new Date(e.toString()),e="/Date({0})/".format(e.getTime())),new n.FormItemResult(this.argumentName.get(),e)},i.prototype._render=function(){return c.renderFormItem(this)},i);function i(e,t){var r=p.call(this,e,t)||this;if(r.initialTime=new m.Observable,r.nullable=new m.Observable(!1),r.timeFormat=new m.Observable,r.jQueryPickerTimeAsInfoMsg=new m.Observable(!1),r.formItemType="TimePickerFormItem",u.initLabelContainer(r,e,t),e){for(var n=!0,o=e.getElementsByTagNameNS?e.getElementsByTagNameNS("http://schemas.datacontract.org/2004/07/Geocortex.Forms.Client.Items.Validation","ValidationItem"):e.getElementsByTagName("ValidationItem"),i=0;i<o.length;i++){var s=o[i].getAttributeNS("http://www.w3.org/2001/XMLSchema-instance","type");if(s&&0<=s.indexOf("RequiredValidationItem")){n=!1;break}}r.nullable.set(n);var a=c.getElementText(e,"jQueryPickerTimeAsInfoMsg");a&&r.jQueryPickerTimeAsInfoMsg.set("true"===a);var l=c.getElementText(e,"InitialTime");(null===c.getElementText(e,"InitializeWithCurrentTime")?l:"true"!==c.getElementText(e,"InitializeWithCurrentTime"))?l?(f.containsTimezone(l)||(l+=f.getTimezoneString()),r.initialTime.set(Date.fromISO(l))):r.initialTime.set(null):r.initialTime.set(new Date),r.timeFormat.set(c.getElementText(e,"TimeFormat"))}else r.timeFormat.set("LongTime"),r.initialTime.set(new Date);return r.time=new m.Observable(r.initialTime.get()),r.time.bind(null,function(e){return r._notifyResultChanged()}),r}t.TimePickerFormItem=o})},"geocortex/forms/items/validation/FileSizeValidationItem":function(){var n,m=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});define(["require","exports","./ValidationItem","./../../../forms","./ValidationResult","./../../../workflow/ArgumentValueWrapper","./../../FileItem"],function(e,t,r,n,o,i,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a,l=(a=r.ValidationItem,m(u,a),u.prototype.validate=function(e){if(e instanceof i.ArgumentValueWrapper&&e.value&&e.value instanceof Array){for(var t=0,r=0;r<e.value.length;++r){var n=e.value[r];n&&n instanceof s.FileItem&&(t+=n.fileSize)}if(t>this.totalFileSize)return new o.ValidationResult(!1,this.message)}return new o.ValidationResult(!0,null)},u);function u(e){var t=a.call(this,e)||this;return t.totalFileSize=parseInt(n.getElementText(e,"TotalFileSize")),t}t.FileSizeValidationItem=l})},"geocortex/forms/items/validation/NumericRangeValidationItem":function(){var n,l=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});define(["require","exports","./ValidationItem","./../../../forms","./ValidationResult"],function(e,t,r,n,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i,s=(i=r.ValidationItem,l(a,i),a.prototype.validate=function(e){if(null==e||""===e)return new o.ValidationResult(!0,null);var t=parseFloat(e);return null==t||isNaN(t)||t<this.minimumValue||t>this.maximumValue?new o.ValidationResult(!1,this.message):new o.ValidationResult(!0,null)},a);function a(e){var t=i.call(this,e)||this;return t.minimumValue=parseFloat(n.getElementText(e,"MinimumValue")),t.maximumValue=parseFloat(n.getElementText(e,"MaximumValue")),t}t.NumericRangeValidationItem=s})},"geocortex/forms/items/validation/RegexValidationItem":function(){var n,l=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});define(["require","exports","./ValidationItem","./../../../forms","./ValidationResult"],function(e,t,r,n,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i,s=(i=r.ValidationItem,l(a,i),a.prototype.validate=function(e){if(null==e||""===e)return new o.ValidationResult(!0,null);var t="",r=this.expression;this.ignoreCase&&(t+="i"),'^(?(")(".+?"@)|(([0-9a-zA-Z]((\\.(?!\\.))|[-!#\\$%&\'\\*\\+/=\\?\\^`\\{\\}\\|~\\w])*)(?<=[0-9a-zA-Z])@))(?(\\[)(\\[(\\d{1,3}\\.){3}\\d{1,3}\\])|(([0-9a-zA-Z][-\\w]*[0-9a-zA-Z]\\.)+[a-zA-Z]{2,6}))$'==this.expression&&(r="^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,4}$");var n=null;try{n=new RegExp(r,t)}catch(e){}return null==n||n.test(e)?new o.ValidationResult(!0,null):new o.ValidationResult(!1,this.message)},a);function a(e){var t=i.call(this,e)||this;return t.expression=n.getElementText(e,"Expression"),t.ignoreCase=n._parseBoolean(n.getElementText(e,"IgnoreCase")),t}t.RegexValidationItem=s})},"geocortex/forms/items/validation/RequiredValidationItem":function(){var n,a=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});define(["require","exports","./ValidationItem","./ValidationResult"],function(e,t,r,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o,i=(o=r.ValidationItem,a(s,o),s.prototype.validate=function(e){var t=!0,r=null;return(null==e||"string"==typeof e&&""===dojo.trim(e)||void 0!==e.length&&e.length<=0||e.value&&dojo.isArray(e.value)&&0===e.value.length)&&(t=!1,r=this.message),new n.ValidationResult(t,r)},s);function s(e){return o.call(this,e)||this}t.RequiredValidationItem=i})},"geocortex/forms/items/validation/ValidationItem":function(){define(["require","exports","./../../../forms"],function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=(o.prototype.validate=function(e){throw new Error("Abstract method")},o);function o(e){this.message=r.getElementText(e,"Message")}t.ValidationItem=n})},"geocortex/forms/items/validation/ValidationResult":function(){define(["require","exports"],function(e,t){"use strict";function r(e,t){this.isValid=e,this.errorMessage=t}Object.defineProperty(t,"__esModule",{value:!0}),t.ValidationResult=r})}}});require({cache:{"geocortex/forms":function(){define(["require","exports"],function(e,t){"use strict";function n(e,t){var r=e.getElementsByTagName(t);if(1<=r.length){for(var n=0;n<r.length;n++)if(r[n].parentNode===e)return r[n]}else if(0<e.childNodes.length){var u=e.childNodes[0].prefix;if(""!==u&&1<=(r=e.getElementsByTagName(u+":"+t)).length)for(n=0;n<r.length;n++)if(r[n].parentNode===e)return r[n]}return null}Object.defineProperty(t,"__esModule",{value:!0}),t.getElement=n,t.getElementText=function(e,t){var r=n(e,t);return r?dojox.xml.parser.textContent(r):null},t.getAttributeValue=function(e,t){if(null!=e)for(var r=0;r<e.attributes.length;r++)if(e.attributes[r].name===t)return e.attributes[r].value;return null},t._parseBoolean=function(e){if(null!=e)switch(e.toLowerCase()){case"true":case"yes":case"1":return!0;case"false":case"no":case"0":case null:return!1;default:return Boolean(e)}return!1},t.renderFormItem=function(e){return geocortex.forms.renderFormItem(e)}})}}});require({cache:{"geocortex/geocortex":function(){define(["require","exports","./config","./hasProxy","./essentials/RestHelperHTTPService","./essentials/Extension"],function(e,r,a,s,c,t){"use strict";function u(e){var r=!1;try{var n=e.url.length;e.content&&(n+=dojo.objectToQuery(e.content).length);var t=new dojo._Url(e.url),o=window.location,i=n>a.config.io.postLength;if(!t.scheme&&!t.host&&!t.port)return!1;if(f()&&"https"===t.scheme)return!1;var s=!(o.protocol+"//"+o.hostname+(o.port?":"+o.port:"")==t.scheme+"://"+t.host+(t.port?":"+t.port:""));r=i&&s}catch(e){}return r}function f(){return/\bGeocortexApp\b/.test(navigator.userAgent)||/http:\/\/127.0.0.1(:[0-9]*)?\/viewerpackages\//gi.test(window.location.href)}Object.defineProperty(r,"__esModule",{value:!0}),r.deferredResolve=function(e,r){e&&-1===e.fired&&e.resolve(r)},r.deferredReject=function(e,r){e&&-1===e.fired&&e.reject(r)},r.encodeJson=function(e){var r=function e(r){var n,t=typeof r;if(null==r||"undefined"==t||"number"==t||"boolean"==t||"string"==t)return r;if("function"==typeof r.toJson&&(n=r.toJson()),dojo.isArray(r)){n=[];for(var o=0;o<r.length;o++){var i=r[o];"function"!=typeof i&&(n[o]=e(i))}}else if("object"==t)for(var o in n={},r)if(!("declaredClass"===o||-1<o.indexOf("_inherited")||void 0!==n[o])){var i=r[o];"function"!=typeof i&&(n[o]=e(i))}return n}(e),n={};for(var t in r)dojo.isArray(r[t])||"object"==typeof r[t]?n[t]=JSON.stringify(r[t]):n[t]=r[t];return n},r.request=function(e,r){(r=r||{}).gcx||(r.gcx={}),void 0===r.gcx.preventCache?e.preventCache=!0:r.gcx.preventCache?e.preventCache=!0:e.preventCache=!1,e.timeout=e.timeout||a.config.io.timeout,e.handleAs=e.handleAs||"json";var n=u(e),t=s.hasProxy();if(!n||t)return delete e.gcx,r.useProxy=n,r.hasOwnProperty("disableIdentityLookup")||(r.disableIdentityLookup=!0),new c.RestHelperHTTPService(e,r).send();var o=new Error("Cross-domain or large requests require a proxy.");dojo.isFunction(e.error)&&e.error(o);var i=new dojo.Deferred;return i.errback(o),i},r.requiresProxy=u,r.isNative=f,r.urlToQueryObject=function(e){var r=e.indexOf("?");return-1===r?null:dojo.queryToObject(e.substring(r+1))},r._getExtensions=function(e){var r=[];if(!e)return r;r.length=e.length;for(var n=0;n<e.length;n++)r[n]=new t.Extension(e[n].className,e[n].instance);return r},r._extensionsToJson=function(e){return(e||[]).map(function(e){return{className:e.className,instance:e.instance}})},r._getProperties=function(e){var r={};if(!e)return r;for(var n=0,t=e;n<t.length;n++){var o=t[n];r[o.name]=o.value}return r},r._propertiesToJson=function(r){return r?Object.keys(r).map(function(e){return{name:e,value:r[e]}}):[]},Date.now||(Date.now=function(){return+new Date})})}}});require({cache:{"geocortex/hasProxy":function(){define(["require","exports"],function(e,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.hasProxy=function(){var e=!1;try{e=esri._getProxyUrl()}catch(e){}return e}})}}});require({cache:{"geocortex/optimizer/EventRelay":function(){define(["require","exports","geocortex/framework/utils/TimeDelayedOperation"],function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=(i.prototype._logExtentChange=function(e){var t;if(this._enabled)if((t={data:[{name:"ArcGISExtents",columns:{}}]}).data[0].columns=[{type:"tinyint",name:"InitialExtent",key:"InitialExtent"},{type:"real",name:"XMinNew",key:"XMinNew"},{type:"real",name:"YMinNew",key:"YMinNew"},{type:"real",name:"XMaxNew",key:"XMaxNew"},{type:"real",name:"YMaxNew",key:"YMaxNew"}],t.data[0].rows=[{InitialExtent:this._firstExtentLogged?0:1,XMinNew:e.extent.xmin,YMinNew:e.extent.ymin,XMaxNew:e.extent.xmax,YMaxNew:e.extent.ymax}],this._queueData(t),this._firstExtentLogged=!0,e.lod)e.levelChange&&-1<this._previousScale&&this._logScaleChange(this._previousScale,e.lod.scale),this._previousScale=e.lod.scale;else{var n=this._map.getScale();null!==n&&(this._previousScale!=n&&-1<this._previousScale&&this._logScaleChange(this._previousScale,n),this._previousScale=n)}},i.prototype._logScaleChange=function(e,t){if(this._enabled){var n={data:[{name:"ArcGISScale",columns:[]}]};n.data[0].columns=[{type:"float",name:"ScaleOld",key:"ScaleOld"},{type:"float",name:"ScaleNew",key:"ScaleNew"}],n.data[0].rows=[{ScaleOld:e,ScaleNew:t}],this._queueData(n)}},i.prototype.logToolUsage=function(e,t){if(this._enabled){var n={data:[{name:"ArcGISTool",columns:[]}]};n.data[0].columns=[{type:"ustr",name:"Tool",key:"Tool"},{type:"ustr",name:"ToolData",key:"ToolData"}],n.data[0].rows=[{Tool:e,ToolData:t}],this._queueData(n)}},i.prototype._queueData=function(e){e.platform="js",e.data[0].columns.push({type:"now",name:"SampleTime",key:"SampleTime"},{type:"origin",name:"UserAddress",key:"UserAddress"},{type:"ustr",name:"SiteId",key:"SiteId"},{type:"ustr",name:"UserAgent",key:"UserAgent"},{type:"ustr",name:"UserName",key:"UserName"},{type:"ustr",name:"LayerList",key:"LayerList"},{type:"int",name:"SessionId",key:"SessionId"},{type:"ustr",name:"ClientType",key:"ClientType"},{type:"host",name:"MachineName",key:"MachineName"}),dojo.mixin(e.data[0].rows[0],{SiteId:this._siteId,UserAgent:navigator.userAgent,UserName:this.userName,LayerList:this._getCurrentLayerList(),SessionId:this._sessionId,ClientType:"JavaScript"}),this._pendingEvents.push(e),this._timer.reset()},i.prototype._flushQueue=function(){for(this._timer.stop();0<this._pendingEvents.length;){var e=this._pendingEvents.shift();this._logData(e)}},i.prototype._logData=function(e){try{dojo.xhrPost({url:this._endpointUrl,postData:JSON.stringify(e),timeout:1e4,load:dojo.hitch(this,this._handleLogSuccessResponse),error:dojo.hitch(this,this._handleLogErrorResponse)})}catch(e){console.log(e.message),this._incrementFailures()}},i.prototype._handleLogSuccessResponse=function(e){this._numConsecutiveFailures=0},i.prototype._handleLogErrorResponse=function(e){console.log(e),this._incrementFailures()},i.prototype._incrementFailures=function(){this._numConsecutiveFailures++,2<this._numConsecutiveFailures&&(dojo.disconnect(this._extentConnect),this._enabled=!1)},i.prototype._getCurrentLayerList=function(){for(var e="",t=this._map.layerIds,n=0;n<t.length;n++){var i,a=t[n],s=this._map.getLayer(a);if(null!=s&&s.visible&&s.visibleAtMapScale)if(s instanceof esri.layers.ArcGISDynamicMapServiceLayer){var o=s;for(i=0;i<o.visibleLayers.length;i++)null!=o.visibleLayers[i]&&-1!=o.visibleLayers[i]&&(e+=o.layerInfos.filter(function(e){return e.id==o.visibleLayers[i]})[0].name+"\\t")}else if(s instanceof esri.virtualearth.VETiledLayer)e+="Bing:"+s.mapStyle+"\\t";else if(s instanceof esri.layers.ArcGISImageServiceLayer)e+="Image:"+s.url+"\\t";else if(s instanceof esri.layers.ArcGISTiledMapServiceLayer){var r=s;for(i=0;i<r.layerInfos.length;i++)null!=r.layerInfos[i]&&(e+=r.layerInfos[i].name+"\\t")}}return 3<e.length&&(e=e.substring(0,e.length-2)),e},i.prototype._crc32=function(e){e=e.replace(/\r\n/g,"\n");for(var t="",n=0;n<e.length;n++){var i=e.charCodeAt(n);i<128?t+=String.fromCharCode(i):(127<i&&i<2048?t+=String.fromCharCode(i>>6|192):(t+=String.fromCharCode(i>>12|224),t+=String.fromCharCode(i>>6&63|128)),t+=String.fromCharCode(63&i|128))}var a,s=0;s^=-1;for(var o=0,r=(e=t).length;o<r;o++)a=255&(s^e.charCodeAt(o)),s=s>>>8^"0x"+"00000000 77073096 EE0E612C 990951BA 076DC419 706AF48F E963A535 9E6495A3 0EDB8832 79DCB8A4 E0D5E91E 97D2D988 09B64C2B 7EB17CBD E7B82D07 90BF1D91 1DB71064 6AB020F2 F3B97148 84BE41DE 1ADAD47D 6DDDE4EB F4D4B551 83D385C7 136C9856 646BA8C0 FD62F97A 8A65C9EC 14015C4F 63066CD9 FA0F3D63 8D080DF5 3B6E20C8 4C69105E D56041E4 A2677172 3C03E4D1 4B04D447 D20D85FD A50AB56B 35B5A8FA 42B2986C DBBBC9D6 ACBCF940 32D86CE3 45DF5C75 DCD60DCF ABD13D59 26D930AC 51DE003A C8D75180 BFD06116 21B4F4B5 56B3C423 CFBA9599 B8BDA50F 2802B89E 5F058808 C60CD9B2 B10BE924 2F6F7C87 58684C11 C1611DAB B6662D3D 76DC4190 01DB7106 98D220BC EFD5102A 71B18589 06B6B51F 9FBFE4A5 E8B8D433 7807C9A2 0F00F934 9609A88E E10E9818 7F6A0DBB 086D3D2D 91646C97 E6635C01 6B6B51F4 1C6C6162 856530D8 F262004E 6C0695ED 1B01A57B 8208F4C1 F50FC457 65B0D9C6 12B7E950 8BBEB8EA FCB9887C 62DD1DDF 15DA2D49 8CD37CF3 FBD44C65 4DB26158 3AB551CE A3BC0074 D4BB30E2 4ADFA541 3DD895D7 A4D1C46D D3D6F4FB 4369E96A 346ED9FC AD678846 DA60B8D0 44042D73 33031DE5 AA0A4C5F DD0D7CC9 5005713C 270241AA BE0B1010 C90C2086 5768B525 206F85B3 B966D409 CE61E49F 5EDEF90E 29D9C998 B0D09822 C7D7A8B4 59B33D17 2EB40D81 B7BD5C3B C0BA6CAD EDB88320 9ABFB3B6 03B6E20C 74B1D29A EAD54739 9DD277AF 04DB2615 73DC1683 E3630B12 94643B84 0D6D6A3E 7A6A5AA8 E40ECF0B 9309FF9D 0A00AE27 7D079EB1 F00F9344 8708A3D2 1E01F268 6906C2FE F762575D 806567CB 196C3671 6E6B06E7 FED41B76 89D32BE0 10DA7A5A 67DD4ACC F9B9DF6F 8EBEEFF9 17B7BE43 60B08ED5 D6D6A3E8 A1D1937E 38D8C2C4 4FDFF252 D1BB67F1 A6BC5767 3FB506DD 48B2364B D80D2BDA AF0A1B4C 36034AF6 41047A60 DF60EFC3 A867DF55 316E8EEF 4669BE79 CB61B38C BC66831A 256FD2A0 5268E236 CC0C7795 BB0B4703 220216B9 5505262F C5BA3BBE B2BD0B28 2BB45A92 5CB36A04 C2D7FFA7 B5D0CF31 2CD99E8B 5BDEAE1D 9B64C2B0 EC63F226 756AA39C 026D930A 9C0906A9 EB0E363F 72076785 05005713 95BF4A82 E2B87A14 7BB12BAE 0CB61B38 92D28E9B E5D5BE0D 7CDCEFB7 0BDBDF21 86D3D2D4 F1D4E242 68DDB3F8 1FDA836E 81BE16CD F6B9265B 6FB077E1 18B74777 88085AE6 FF0F6A70 66063BCA 11010B5C 8F659EFF F862AE69 616BFFD3 166CCF45 A00AE278 D70DD2EE 4E048354 3903B3C2 A7672661 D06016F7 4969474D 3E6E77DB AED16A4A D9D65ADC 40DF0B66 37D83BF0 A9BCAE53 DEBB9EC5 47B2CF7F 30B5FFE9 BDBDF21C CABAC28A 53B39330 24B4A3A6 BAD03605 CDD70693 54DE5729 23D967BF B3667A2E C4614AB8 5D681B02 2A6F2B94 B40BBE37 C30C8EA1 5A05DF1B 2D02EF8D".substr(9*a,8);return(s^=-1).toString()},i);function i(e,t,n,i){var a=this;this._timer=null,this._siteId="",this._endpointUrl="",this.userName="",this._extentConnect=null,this._numConsecutiveFailures=0,this._enabled=!0,this._sessionId="",this._previousScale=-1,this._firstExtentLogged=!1,this._map=e,t&&(this._siteId=t),this._endpointUrl=n||window.location.protocol+"//"+window.location.host+"/Geocortex/Optimizer/Rest/DataRelay/LogData.ashx?f=json",i&&(this.userName=i),this._pendingEvents=new Array,this._timer=new o.TimeDelayedAction(3e3,this._flushQueue,this);var s={};s.extent=this._map.extent,e.loaded?(this._logExtentChange(s),this._extentConnect=e.on("extent-change",dojo.hitch(this,"_logExtentChange"))):e.on("load",function(){a._logExtentChange(s),a._extentConnect=e.on("extent-change",dojo.hitch(a,"_logExtentChange"))}),this._sessionId=this._crc32((new Date).getTime()+""+navigator.userAgent)}t.EventRelay=n})}}});require({cache:{"geocortex/workflow/ActivityContext":function(){define(["require","exports","./ArgumentValueWrapper","./ArgumentInfo","./DefaultActivityHandlers","./WorkflowControllerProxy"],function(e,t,s,u,r,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=(n.prototype.dispatcher=function(){return this._dispatcher},n.prototype.workflow=function(){return this._workflow},n.prototype.getDisplayName=function(){return this._workflowState?this._workflowState.pendingExternalActivities[this._pendingIndex].displayName:""},n.prototype.getInputNames=function(){var e=[];if(this._workflowState)for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].inputs,r=0;r<t.length;r++)e.push(t[r].name);return e},n.prototype.getInputNamesByType=function(e){var t=[];if(this._workflowState)for(var r=this._workflowState.pendingExternalActivities[this._pendingIndex].inputs,i=0;i<r.length;i++)0===r[i].typeName.indexOf(e)&&t.push(r[i].name);return t},n.prototype.getOutputNames=function(){var e=[];if(this._workflowState)for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].outputs,r=0;r<t.length;r++)e.push(t[r].name);return e},n.prototype.getOutputNamesByType=function(e){var t=[];if(this._workflowState)for(var r=this._workflowState.pendingExternalActivities[this._pendingIndex].outputs,i=0;i<r.length;i++)0===r[i].typeName.indexOf(e)&&t.push(r[i].name);return t},n.prototype.getSite=function(){return null!=this._workflow?this._workflow.site:null},n.prototype.getEsriMap=function(){return null!=this._workflow&&null!=this._workflow.site?this._workflow.site.getMap():null},n.prototype.getValue=function(e){if(this._workflowState)for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].inputs,r=0;r<t.length;r++)if(t[r].name==e)return t[r].value;return null},n.prototype.getOutputValue=function(e){if(this._workflowState)for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].outputs,r=0;r<t.length;r++)if(t[r].name==e)return t[r].value;return null},n.prototype.getJsonValue=function(e){for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].inputs,r=0;r<t.length;r++)if(t[r].name==e)return JSON.stringify(t[r].value);return null},n.prototype.getOutputJsonValue=function(e){if(this._workflowState)for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].outputs,r=0;r<t.length;r++)if(t[r].name==e){var i=t[r].value;return i&&1===i.length&&(i=i[0]),JSON.stringify(i)}return null},n.prototype.setValue=function(e,t,r){if(this._workflowState){var i=!1,n=this._workflowState.pendingExternalActivities[this._pendingIndex].outputs,a=this._getRuntimeType(t);t&&t instanceof s.ArgumentValueWrapper&&(a=t.runtimeTypeName,t=t.value);for(var o=0;o<n.length;o++)if(n[o].name==e){var l;i=!0,(l=n[o])&&(l.value=t,null!=a&&(l.runtimeTypeName=a));break}!i&&r&&(a=a||"System.Object",(l=new u.ArgumentInfo).isRequired=!1,l.name=e,l.value=t,l.typeName=a,l.runtimeTypeName=a,this._workflowState.pendingExternalActivities[this._pendingIndex].outputs.push(l))}},n.prototype.getActivityTypeName=function(){var e="";if(this._workflowState&&(e=this._workflowState.pendingExternalActivities[this._pendingIndex].typeName)){var t=e.indexOf("`");0<=t&&(e=e.substring(0,t))}return e},n.prototype.getActivityExternalId=function(){return this._workflowState?this._workflowState.pendingExternalActivities[this._pendingIndex].externalId:""},n.prototype.getInputArgumentTypeName=function(e){if(this._workflowState)for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].inputs,r=0;r<t.length;r++)if(t[r].name==e)return t[r].typeName;return""},n.prototype.getInputArgumentRuntimeTypeName=function(e){for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].inputs,r=0;r<t.length;r++)if(t[r].name==e)return t[r].runtimeTypeName;return""},n.prototype.completeActivity=function(){if(this._workflowState){var e=this._workflowState.pendingExternalActivities[this._pendingIndex];if(e.isComplete)return;var t=this;"debugger"==this.getActivityExternalId()||e&&e.debug?r.showDebug(this,!1,function(){t._completeActivityInternal()}):this._completeActivityInternal()}},n.prototype.abortActivity=function(){if(this._workflowState){var e=this._workflowState.pendingExternalActivities[this._pendingIndex];e.isAborted=!0,this._workflowState.status="Aborted: "+e.displayName}null!=this._dispatcher&&this._dispatcher.activityAbort(this)},n.prototype._completeActivityInternal=function(){if(this._workflowState){var e=this._workflowState.pendingExternalActivities[this._pendingIndex];e.isComplete=!0,null!=this._dispatcher&&this._dispatcher.activityComplete(this),e.inputs=null;var t=this._workflowState.pendingExternalActivities[this._pendingIndex].syncToken,r=!0;if(""!=t)for(var i=this._workflowState.pendingExternalActivities,n=0;n<i.length;n++)if(i[n].syncToken==t&&!i[n].isComplete){r=!1;break}r&&(a._executeWorkflow(this._workflow,this._dispatcher,this._workflowState,null,this),dojo.isFunction(this.activityComplete)&&this.activityComplete(this))}},n.prototype._getRuntimeType=function(e){var t="System.Object";return e&&("function"==typeof e.isInstanceOf?e.isInstanceOf(esri.geometry.Extent)?t="ESRI.ArcGIS.Client.Geometry.Envelope":e.isInstanceOf(esri.geometry.Extent)?t="ESRI.ArcGIS.Client.Geometry.Envelope":e.isInstanceOf(esri.geometry.Point)?t="ESRI.ArcGIS.Client.Geometry.MapPoint":e.isInstanceOf(esri.geometry.Multipoint)?t="ESRI.ArcGIS.Client.Geometry.MultiPoint":e.isInstanceOf(esri.geometry.Polygon)?t="ESRI.ArcGIS.Client.Geometry.Polygon":e.isInstanceOf(esri.geometry.Polyline)?t="ESRI.ArcGIS.Client.Geometry.Polyline":e.isInstanceOf(esri.geometry.Geometry)?t="ESRI.ArcGIS.Client.Geometry.Geometry":e.isInstanceOf(esri.layers.LayerDataSource)?t="ESRI.ArcGIS.Client.LayerDataSource":e.isInstanceOf(esri.layers.LayerMapSource)&&(t="ESRI.ArcGIS.Client.LayerMapSource"):"string"==typeof e?t="System.String":"number"==typeof e?t="System.Double":"boolean"==typeof e?t="System.Boolean":"object"==typeof e&&(t="function"==typeof e.getMonth?"System.DateTime":"System.Object")),t},n);function n(e,t,r,i){this.activityComplete=null,this._dispatcher=e,this._pendingIndex=t,this._workflow=r,this._workflowState=i}t.ActivityContext=i})},"geocortex/workflow/ActivityDispatcher":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/workflow/ArgumentInfo":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=(i.prototype._configureObject=function(e){if(void 0===e.name||void 0===e.typeName)throw new Error("Incorrect argument info object returned from initialization");this.name=e.name,this.typeName=e.typeName,this.isRequired=e.isRequired,this.value=e.value,this.runtimeTypeName=e.runtimeTypeName},i.prototype._internalClone=function(){var e=new i(this.name,this.typeName,this.isRequired,dojo.clone(this.value));return e.runtimeTypeName=dojo.clone(this.runtimeTypeName),e},i);function i(e,t,r,i){this.runtimeTypeName=null,this.name=e||null,this.typeName=t||null,this.isRequired=!!r,this.value=i||null}t.ArgumentInfo=r})},"geocortex/workflow/ArgumentValueWrapper":function(){define(["require","exports"],function(e,t){"use strict";function r(e,t){this.runtimeTypeName=null,this.runtimeTypeName=e||null,this.value=t||null}Object.defineProperty(t,"__esModule",{value:!0}),t.ArgumentValueWrapper=r})},"geocortex/workflow/CacheActivityHandlers":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i={};t.handleGetExternalValue=function(e){var t=e.getValue("Key");if(null!=t){var r=i[t];void 0===r&&(r=null),e.setValue("Value",r)}e.completeActivity()},t.handleSetExternalValue=function(e){var t=e.getValue("Key"),r=e.getValue("Value");null!=t&&(i[t]=r),e.completeActivity()}})},"geocortex/workflow/DefaultActivityDispatcher":function(){define(["require","exports","./DialogActivityHandlers","./MapActivityHandlers","./DefaultActivityHandlers","./NativeActivityHandlers","./CacheActivityHandlers","./LayerActivityHandlers","./MapServiceActivityHandlers"],function(e,t,r,i,n,a,o,l,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var u=(c.prototype.registerDefaultHandlers=function(){this.registerActivityHandler("Geocortex.Workflow.Activities.Alert",r.handleAlert),this.registerActivityHandler("Geocortex.Workflow.Activities.CaptureGeometry",i.MapActivityHandlers.handleCaptureGeometry),this.registerActivityHandler("Geocortex.Workflow.Activities.Confirm",r.handleConfirm),this.registerActivityHandler("Geocortex.Workflow.Activities.ExportMap",i.MapActivityHandlers.handleExportMap),this.registerActivityHandler("Geocortex.Workflow.Activities.ExternalDelay",n.handleExternalDelay),this.registerActivityHandler("Geocortex.Workflow.Activities.GetBrowserUrl",n.handleGetBrowserUrl),this.registerActivityHandler("Geocortex.Workflow.Activities.GetCurrentPosition",a.handleGetCurrentPosition),this.registerActivityHandler("Geocortex.Workflow.Activities.GetExternalTimeInfo",n.handleGetExternalTimeInfo),this.registerActivityHandler("Geocortex.Workflow.Activities.GetExternalValue",o.handleGetExternalValue),this.registerActivityHandler("Geocortex.Workflow.Activities.GetGraphicsLayerContent",l.handleGetGraphicsLayerContent),this.registerActivityHandler("Geocortex.Workflow.Activities.GetLayerDefinition",l.handleGetLayerDefinition),this.registerActivityHandler("Geocortex.Workflow.Activities.GetLayerInfoByProperty",n.handleGetLayerInfoByProperty),this.registerActivityHandler("Geocortex.Workflow.Activities.GetLayerProperty",l.handleGetLayerProperty),this.registerActivityHandler("Geocortex.Workflow.Activities.GetLayerVisibility",l.handleGetLayerVisibility),this.registerActivityHandler("Geocortex.Workflow.Activities.GetMapExtent",i.MapActivityHandlers.handleGetMapExtent),this.registerActivityHandler("Geocortex.Workflow.Activities.GetMapInfo",i.MapActivityHandlers.handleGetMapInfo),this.registerActivityHandler("Geocortex.Workflow.Activities.GetMapServiceInfo",s.handleGetMapServiceInfo),this.registerActivityHandler("Geocortex.Workflow.Activities.GetPhoto",a.handleGetPhoto),this.registerActivityHandler("Geocortex.Workflow.Activities.PrintMap",i.MapActivityHandlers.handlePrintMap),this.registerActivityHandler("Geocortex.Workflow.Activities.Prompt",r.handlePrompt),this.registerActivityHandler("Geocortex.Workflow.Activities.RefreshMap",i.MapActivityHandlers.handleRefreshMap),this.registerActivityHandler("Geocortex.Workflow.Activities.RemoveMapService",s.handleRemoveMapService),this.registerActivityHandler("Geocortex.Workflow.Activities.Report",n.handleReport),this.registerActivityHandler("Geocortex.Workflow.Activities.SetExternalValue",o.handleSetExternalValue),this.registerActivityHandler("Geocortex.Workflow.Activities.SetLayerDefinition",l.handleSetLayerDefinition),this.registerActivityHandler("Geocortex.Workflow.Activities.SetLayerProperty",l.handleSetLayerProperty),this.registerActivityHandler("Geocortex.Workflow.Activities.SetLayerVisibility",l.handleSetLayerVisibility),this.registerActivityHandler("Geocortex.Workflow.Activities.SetMapExtent",i.MapActivityHandlers.handleSetMapExtent),this.registerActivityHandler("Geocortex.Workflow.Activities.SetMapServiceVisibility",s.handleSetMapServiceVisibility),this.registerActivityHandler("Geocortex.Workflow.Activities.UpdateGraphicsLayer",l.handleUpdateGraphicsLayer),this.registerActivityHandler("Geocortex.Workflow.Activities.WaitForGeoprocessorJobComplete",n.handleWaitForGeoprocessorJobComplete),this.registerActivityHandler("Geocortex.Workflow.Activities.SetImageServiceInfo",s.handleSetImageServiceInfo),this.registerActivityHandler("Geocortex.Workflow.Activities.SetMapServiceProperty",s.handleSetMapServiceProperty),this.registerExternalIdHandler("IntersectLayers",i.MapActivityHandlers.handleIntersectLayers),this.registerExternalIdHandler("GetPhoto",a.handleGetPhoto)},c.prototype.canHandleActivity=function(e){if(!e){var t=new Error("Null ActivityContext passed to canHandleActivity.");this.handleError(t,e)}if(null!=e.getActivityExternalId()&&null!=this._registeredExternalIdHandlers[e.getActivityExternalId()])return!0;var r=e.getActivityTypeName();return!(null==r||!this._registeredActivityHandlers[r])},c.prototype.registerExternalIdHandler=function(e,t){if(null!=e&&null!=t)this._registeredExternalIdHandlers[e]=t;else{var r=new Error("Null externalId or handler passed to registerExternalIdHandler.");this.handleError(r,null)}},c.prototype.registerActivityHandler=function(e,t){if(null!=e&&null!=t)this._registeredActivityHandlers[e]=t;else{var r=new Error("Null activityTypeName or handler passed to registerActivityHandler.");this.handleError(r,null)}},c.prototype.dispatch=function(e){if(null!=e){var t=e.getActivityTypeName(),r=e.getActivityExternalId();this.canHandleActivity(e)?(null!=r&&null!=this._registeredExternalIdHandlers[r]&&(0,this._registeredExternalIdHandlers[r])(e,this),null!=t&&this._registeredActivityHandlers[t]&&(0,this._registeredActivityHandlers[t])(e,this)):(i=new Error("Unknown activity type '"+t+"' or external ID '"+r+"' encountered."),this.handleUnhandledActivityErrorFunction(i,e))}else{var i=new Error("Null ActivityContext passed to dispatch.");this.handleError(i,e)}},c.prototype.handleError=function(e,t){null!=this._handleErrorFunction&&this._handleErrorFunction(e,t)},c.prototype.handleUnhandledActivityError=function(e,t){null!=this.handleUnhandledActivityErrorFunction?this.handleUnhandledActivityErrorFunction(e,t):this.handleError(e,t)},c.prototype.handleOpenReportUrl=function(e,t){null!=this.handleOpenReportUrlFunction?this.handleOpenReportUrlFunction(e,t):window.open(e)},c.prototype.webRequestBegin=function(e,t){null!=this._webRequestBeginFunction&&this._webRequestBeginFunction(e,t)},c.prototype.webRequestComplete=function(e,t){null!=this._webRequestCompleteFunction&&this._webRequestCompleteFunction(e,t)},c.prototype.abortMapBasedActivity=function(){if(this._drawObjectContext){if(!this._drawObjectContext.toolbar||!this._drawObjectContext.drawEvent||!this._drawObjectContext.activityContext)return!1;this._drawObjectContext.toolbar.deactivate(),dojo.disconnect(this._drawObjectContext.drawEvent),this._drawObjectContext.activityContext.abortActivity(),this._drawObjectContext=null}return!0},c.prototype.setDrawObjectContext=function(e){this._drawObjectContext=e},c.prototype.activityBegin=function(e){null!=this._activityBeginFunction&&this._activityBeginFunction(e)},c.prototype.activityComplete=function(e){null!=this._activityCompleteFunction&&this._activityCompleteFunction(e)},c.prototype.activityAbort=function(e){this.workflowAbort(e,e.workflow())},c.prototype.workflowComplete=function(e,t){null!=this._workflowCompleteFunction&&this._workflowCompleteFunction(e,t)},c.prototype.workflowAbort=function(e,t){null!=this._workflowAbortFunction&&this._workflowAbortFunction(e,t)},c);function c(e,t,r,i,n,a,o){this.isBusy=!1,this._drawObjectContext=null,this._registeredActivityHandlers={},this._registeredExternalIdHandlers={},this.handleUnhandledActivityErrorFunction=null,this.handleOpenReportUrlFunction=null,this.defaultFormContainerId="form-container-outer",this.defaultFormContentId="form-container",this._handleErrorFunction=e||null,this._activityBeginFunction=t||null,this._activityCompleteFunction=r||null,this._workflowAbortFunction=n||null,this._workflowCompleteFunction=i||null,this._webRequestBeginFunction=a||null,this._webRequestCompleteFunction=o||null,this.registerDefaultHandlers()}t.DefaultActivityDispatcher=u})},"geocortex/workflow/DefaultActivityHandlers":function(){define(["require","exports","./MapServiceActivityHandlers","./../essentials/ReportParameters","./../essentials/TextField","./../essentials/RestHelper","./../forms/FormDefinition","./../forms/items/TextBoxFormItem","./../forms/items/TextAreaFormItem","./../forms/items/LabelFormItem","./../essentials/MapServiceConstants","geocortex/framework/utils/utils"],function(e,t,_,L,k,M,p,d,f,y,h,v){"use strict";function l(e){switch(e){case"esriJobNew":return 0;case"esriJobSubmitted":return 1;case"esriJobWaiting":return 2;case"esriJobExecuting":return 3;case"esriJobSucceeded":return 4;case"esriJobFailed":return 5;case"esriJobTimedOut":return 6;case"esriJobCancelling":return 7;case"esriJobCancelled":return 8;case"esriJobDeleting":return 9;case"esriJobDeleted":return 10;default:return-1}}Object.defineProperty(t,"__esModule",{value:!0}),t.getPropertyIgnoreCase=function(e,t){for(var r in e)if(e.hasOwnProperty(r)&&r.toLowerCase()===t.toLowerCase())return r;return null},t.handleReport=function(r){var e=r.getValue("MapServiceId"),t=r.getValue("LayerId"),i=r.getValue("LayerName"),n=r.getValue("ReportId"),a=null,o=r.getSite();if(o&&e&&(t||i)&&n){var l=_.findMapServiceById(o,e);if(l){var s=null;t?s=l.findLayerOrTableById(t):i&&(s=l.findLayerOrTableByName(i)),null!=s&&(a=s.findReportById(n))}}if(a){var u=new esri.tasks.Query,c=new L.ReportParameters,p=r.getValue("ShowOpenReport"),d=r.getValue("Geometry"),f=r.getValue("OutSpatialReference"),y=r.getValue("Text"),h=r.getValue("Where"),v=r.getValue("OutputFormat"),g=r.getValue("Resolution"),m=r.getValue("CustomExtent"),w=r.getValue("SpatialRelationship"),S=r.getValue("ReportExtentType"),E=r.getValue("NotificationEmailAddress"),b=r.getValue("TextFields");if(S=S||L.ReportParameters.CURRENT_EXTENT,c.extentType=S,v&&(c.outputFormat=v),a.textFields)for(var A in a.textFields)if(a.textFields.hasOwnProperty(A)){var I=a.textFields[A],x=V(I);null!=x?c.fields.push(new k.TextField(I.id,I.displayName,x.Value,I.multiline)):c.fields.push(I)}E&&(c.notificationEmailAddress=E),g&&(c.resolution=g),m&&(c.customExtent=m),u.spatialRelationship=M.RestHelper._convertSpatialRelationshipFromDotnetIndex(w),d&&(u.geometry=d),f&&(u.outSpatialReference=f),y&&(u.text=y),h&&(u.where=h),a.run(u,c,function(e){var t=e?e.href:null;p&&t&&0<t.length&&r.dispatcher().handleOpenReportUrl(t,r),r.setValue("ResultUrl",t),r.completeActivity()},function(e){r.dispatcher().handleError(new Error("Error running report '"+e.message+"'"),r)})}else r.dispatcher().handleError(new Error("Cannot find report '"+n+"'"),r);function V(e){var t=null;if(b&&e)for(var r=0,i=b;r<i.length;r++){var n=i[r];if(n.Key===e.displayName||"tf_"+n.Key===e.id||n.Key===e.id){t=n;break}}return t}},t.showDebug=function(e,t,r){var i,n=new p.FormDefinition;if(n.maxHeight.set(600),n.maxWidth.set(500),null!=(i=t?(n.title.set("Debug - Input Arguments for "+e.getDisplayName()),n.containerFormItem.description.set("Input Arguments:"),e.getInputNames()):(n.title.set("Debug - Output Arguments for "+e.getDisplayName()),n.containerFormItem.description.set("Output Arguments:"),e.getOutputNames()))&&0<i.length)for(var a=0,o=i;a<o.length;a++){var l=o[a],s=void 0;(s=t?e.getValue(l):e.getOutputValue(l))&&"object"==typeof s&&(s=t?e.getJsonValue(l):e.getOutputJsonValue(l));var u=void 0;!s||String(s).length<100&&-1===String(s).indexOf("\n")?u=new d.TextBoxFormItem(null,n):(u=new f.TextAreaFormItem(null,n)).textboxHeight.set(100),u.label=new y.LabelFormItem(null,n),u.text.set(s),u.textboxWidth.set(300),u.label.text.set(l),u.readOnly.set(!0),n.containerFormItem.formItems.addItem(u)}var c=e.dispatcher();c&&"function"==typeof c._showDebugHandler?c._showDebugHandler(n,r):r&&r()},t.handleGetBrowserUrl=function(e){e.setValue("Url",window.location.href),e.completeActivity()},t.handleExternalDelay=function(e){var t=e.getValue("Milliseconds");if(null==t)throw new Error("External Delay: required Milliseconds argument was not supplied.");setTimeout(function(){e.completeActivity()},t)},t.handleGetExternalTimeInfo=function(e){var t=new Date;e.setValue("UtcOffset",-6e4*t.getTimezoneOffset()),e.completeActivity()},t.handleWaitForGeoprocessorJobComplete=function(r){var e=r.getValue("GeoprocessorUrl"),i=(r.getValue("Token"),r.getValue("ProxyURL"),r.getValue("UpdateDelay")),n=r.getValue("JobId"),a=!1;if(!e)throw new Error("GeoprocessorUrl parameter is missing.");if(!n)throw new Error("JobId parameter is missing.");var o=new esri.tasks.Geoprocessor(e);0<i&&o.setUpdateDelay(i),dojo.connect(o,"onError",function(e){r.setValue("Result",l(esri.tasks.JobInfo.STATUS_FAILED)),r.completeActivity()}),dojo.connect(o,"onStatusUpdate",function(e){if(!a){var t=e.jobStatus;t===esri.tasks.JobInfo.STATUS_CANCELLED||t===esri.tasks.JobInfo.STATUS_DELETED||t===esri.tasks.JobInfo.STATUS_FAILED||t===esri.tasks.JobInfo.STATUS_SUCCEEDED||t===esri.tasks.JobInfo.STATUS_TIMED_OUT?(a=!0,r.setValue("Result",l(t)),r.completeActivity()):window.setTimeout(function(){o.checkJobStatus(n)},i)}}),o.checkJobStatus(n)},t._getJobStatusCode=l,t.handleGetLayerInfoByProperty=function(e){if(!e)throw new Error("Get Map Service Info: required context was not supplied.");var t=e.getValue("PropertyName");if(null==t)throw new Error("Provide a Property Name: No property name available.");var r=e.getSite();if(!r)throw new Error("Set Layer Visibility: No site available.");for(var i=[],n=r.essentialsMap.mapServices,a={mapServiceUrl:"",mapServiceId:"",token:"",isVisible:!1,isDynamic:!1,propertyValue:null,id:"",name:"",displayName:"",layerUrl:""},o=null,l=0,s=n;l<s.length;l++)for(var u=s[l],c=0,p=u.layers.concat(u.tables);c<p.length;c++){var d=p[c];if(!v.isNullOrUndefined(d.properties[t])){if(a.mapServiceUrl=u.serviceUrl,a.mapServiceId=u.id,a.token=u.serviceToken,a.isVisible=d.isVisible(),a.isDynamic=d.isDynamic,a.propertyValue=d.properties[t],a.id=d.id,a.name=d.name,a.displayName=d.displayName,u.mapServiceType===h.MapServiceType.FEATURE?a.layerUrl=a.mapServiceUrl:a.layerUrl=a.mapServiceUrl+"/"+(a.isDynamic?"dynamicLayer":a.id),a.isDynamic){var f=n[0].serviceLayer;if(f&&f.dynamicLayerInfos)for(var y=0;y<f.dynamicLayerInfos.length;y++)if((o=f.dynamicLayerInfos[y])&&o.id.toString()===a.id){o.source&&(a.layerSourceJson=JSON.stringify(o.source.toJson()));break}}i.push(a),a={mapServiceUrl:"",mapServiceId:"",token:"",isVisible:!1,isDynamic:!1,propertyValue:null,id:"",name:"",displayName:"",layerUrl:""}}}e.setValue("LayersInfo",i),e.completeActivity()}})},"geocortex/workflow/DialogActivityHandlers":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleAlert=function(e){e.getValue("Title");var t=e.getValue("Text");alert(t),e.completeActivity()},t.handleConfirm=function(e){var t=e.getValue("Text"),r=confirm(t);null==r&&(r=!1),e.setValue("Result",r),e.completeActivity()},t.handlePrompt=function(e){var t=e.getValue("Description"),r=e.getValue("DefaultText"),i=prompt(t,r);e.setValue("Result",i),e.completeActivity()}})},"geocortex/workflow/ExternalActivityInfo":function(){define(["require","exports","./ArgumentInfo"],function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=(i.prototype._configureObject=function(e){if(void 0===e.id||void 0===e.displayName||void 0===e.typeName||void 0===e.instanceId)throw new Error("Incorrect external activity info object returned from initialization");var t;if(this.id=e.id,this.displayName=e.displayName,this.typeName=e.typeName,this.instanceId=e.instanceId,this.externalId=e.externalId,this.syncToken=e.syncToken,this.isComplete=e.isComplete,e.debug&&(this.debug=e.debug),this.inputs=[],this.outputs=[],e.inputs)for(t=0;t<e.inputs.length;t++){var r=e.inputs[t];(i=new n.ArgumentInfo)._configureObject(r),this.inputs[t]=i}if(e.outputs)for(t=0;t<e.outputs.length;t++){var i;r=e.outputs[t],(i=new n.ArgumentInfo)._configureObject(r),this.outputs[t]=i}},i);function i(e,t,r,i,n,a,o,l,s){this.debug=!1,this.id=e||null,this.displayName=t||null,this.typeName=r||null,this.instanceId=i||null,this.externalId=n||null,this.syncToken=a||null,this.isComplete=o||!1,this.isAborted=!1,this.inputs=l||[],this.outputs=s||[]}t.ExternalActivityInfo=r})},"geocortex/workflow/LayerActivityHandlers":function(){define(["require","exports","./MapServiceActivityHandlers","./DefaultActivityHandlers"],function(e,t,p,d){"use strict";function o(e){var t=e.site,r=e.mapServiceId,i=e.layerId,n=e.layerName,a=e.visible,o=p.findMapServiceById(t,r);if(!o)throw new Error("Set Layer Visibility: Unable to find map service with ID '"+r+"'");var l=null;if(i){if(!(l=o.findLayerById(i)))throw new Error("Set Layer Visibility: Unable to find layer with ID '"+i+"' in map service with ID '"+r+"'")}else{if(!n)throw new Error("Set Layer Visibility: must define layer ID or name");if(!(l=o.findLayerByName(n)))throw new Error("Set Layer Visibility: Unable to find layer with name '"+n+"' in map service with ID '"+r+"'")}l.setVisibility(a)}Object.defineProperty(t,"__esModule",{value:!0}),t.handleSetLayerProperty=function(e){var t="Set Layer Property",r=e.getValue("MapServiceId"),i=e.getValue("LayerId"),n=e.getValue("LayerName"),a=e.getValue("PropertyName"),o=e.getValue("Value");if(!r)throw new Error(t+": required MapServiceId argument was not supplied.");if(!i&&!n)throw new Error(t+": a LayerId or a LayerName argument must be supplied.");var l=e.getSite();if(!l)throw new Error(t+": No site available.");var s=p.findMapServiceById(l,r);if(!s||!s.serviceLayer)throw new Error(t+": Unable to find map service with ID '"+r+"'");var u=null;if(!(u=i?s.findLayerById(i):s.findLayerByName(n)))throw new Error(t+": Unable to find layer with Name '"+n+"' or ID '"+i+"'.");var c=d.getPropertyIgnoreCase(u,a);if(c)u[c]=o;else{if(!(c=d.getPropertyIgnoreCase(u.properties,a)))throw new Error(t+": Layer does not support the property '"+a+"'.");u.properties[c]=o}e.completeActivity()},t.handleGetLayerProperty=function(e){var t="Get Layer Property",r=e.getValue("MapServiceId"),i=e.getValue("LayerId"),n=e.getValue("LayerName"),a=e.getValue("PropertyName");if(!r)throw new Error(t+": required MapServiceId argument was not supplied.");if(!i&&!n)throw new Error(t+": a LayerId or a LayerName argument must be supplied.");var o=e.getSite();if(!o)throw new Error(t+": No site available.");var l=p.findMapServiceById(o,r);if(!l||!l.serviceLayer)throw new Error(t+": Unable to find map service with ID '"+r+"'");var s=null;if(!(s=i?l.findLayerById(i):l.findLayerByName(n)))throw new Error(t+": Unable to find layer with Name '"+n+"' or ID '"+i+"'.");var u=d.getPropertyIgnoreCase(s,a);if(u)e.setValue("Value",s[u]);else{if(!(u=d.getPropertyIgnoreCase(s.properties,a)))throw new Error(t+": Layer does not support the property '"+a+"'.");e.setValue("Value",s.properties[u])}e.completeActivity()},t.handleGetLayerVisibility=function(e){var t=e.getValue("MapServiceId"),r=e.getValue("LayerId"),i=e.getValue("LayerName"),n=e.getValue("EffectiveVisibility");if(!t)throw new Error("Get Layer Visibility: required MapServiceId argument was not supplied.");if(!r&&!i)throw new Error("Get Layer Visibility: a LayerId or a LayerName argument must be supplied.");var a=e.getSite();if(!a)throw new Error("Get Layer Visibility: No site available.");var o=p.findMapServiceById(a,t);if(!o)throw new Error("Get Layer Visibility: Unable to find map service with ID '"+t+"'");var l=null;if(r?l=o.findLayerById(r):i&&(l=o.findLayerByName(i)),!l)throw new Error("Get Layer Visibility: Unable to find layer with ID '"+r+"' in map service with ID '"+t+"'");var s=l.isVisible();if(n&&(s=!1,l.isVisible()&&o.isVisible()&&l.withinScaleRange(null)))for(var u=0,c=o.getVisibleLayers();u<c.length;u++)if(c[u]===l.id){s=!0;break}e.setValue("Visible",s),e.completeActivity()},t.handleSetLayerVisibility=function(e){var t=e.getValue("MapServiceId"),r=e.getValue("LayerId"),i=e.getValue("LayerName"),n=e.getValue("Visible");if(!t)throw new Error("Set Layer Visibility: required MapServiceId argument was not supplied.");if(!r&&!i)throw new Error("Set Layer Visibility: a LayerId or a LayerName argument must be supplied.");if(null===n)throw new Error("Set Layer Visibility: required Visible argument was not supplied.");var a=e.getSite();if(!a)throw new Error("Set Layer Visibility: No site available.");o({site:a,mapServiceId:t,layerId:r,layerName:i,visible:n}),e.completeActivity()},t.handleGetLayerDefinition=function(e){var t=e.getValue("MapServiceId"),r=e.getValue("LayerId"),i=e.getValue("LayerName");if(!t)throw new Error("Get Layer Definition: required MapServiceId argument was not supplied.");if(!r&&!i)throw new Error("Get Layer Definition: a LayerId or a LayerName argument must be supplied.");var n=null,a=e.getSite();if(a){var o=p.findMapServiceById(a,t);if(o&&o.serviceLayer){if(!r&&i){var l=o.findLayerByName(i);if(!l)throw new Error("Set Layer Definition: Unable to find layer with Name '"+i+"'.");r=l.id}o.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer?o.serviceLayer.layerDefinitions&&(n=o.serviceLayer.layerDefinitions[parseInt(r,10)]):o.serviceLayer instanceof esri.layers.FeatureLayer&&(n=o.serviceLayer.getDefinitionExpression())}}e.setValue("Definition",n),e.completeActivity()},t.handleSetLayerDefinition=function(e){var t=e.getValue("MapServiceId"),r=e.getValue("LayerId"),i=e.getValue("LayerName"),n=e.getValue("Definition");if(!t)throw new Error("Set Layer Definition: required MapServiceId argument was not supplied.");if(!r&&!i)throw new Error("Set Layer Definition: a LayerId or a LayerName argument must be supplied.");var a=e.getSite();if(!a)throw new Error("Set Layer Visibility: No site available.");var o=p.findMapServiceById(a,t);if(!o||!o.serviceLayer)throw new Error("Set Layer Definition: Unable to find map service with ID '"+t+"'");if(!r&&i){var l=o.findLayerByName(i);if(!l)throw new Error("Set Layer Definition: Unable to find layer with Name '"+i+"'.");r=l.id}if(o.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer){var s=o.serviceLayer;s.layerDefinitions||(s.layerDefinitions=[]),s.layerDefinitions[parseInt(r,10)]=n,s.setLayerDefinitions(s.layerDefinitions,!0)}else{if(!(o.serviceLayer instanceof esri.layers.FeatureLayer))throw new Error("Set Layer Definition: Map service type does not support layer definitions.");o.serviceLayer.setDefinitionExpression(n)}e.completeActivity()},t.handleGetGraphicsLayerContent=function(e){var t=e.getValue("GraphicsLayerId"),r=e.getValue("GeometryType"),i=null;null!==r&&(0===r?i="extent":1===r?i="multipoint":2===r?i="point":3===r?i="polygon":4===r&&(i="polyline"));var n=e.getEsriMap();if(null!=n&&null!=n.graphicsLayerIds)for(var a=0,o=n.graphicsLayerIds;a<o.length;a++){var l=o[a];if(t===l){var s=n.getLayer(l);if(null!=s&&null!=s.graphics){for(var u=new esri.tasks.FeatureSet,c=0,p=s.graphics;c<p.length;c++){var d=p[c];if(null!==i){if(null===d.geometry)continue;if(i!==d.geometry.type)continue}var f=new esri.Graphic(d.geometry,null,d.attributes,null);u.features.push(f)}e.setValue("Features",u)}break}}e.completeActivity()},t.handleUpdateGraphicsLayer=function(e){var t=e.getValue("GraphicsLayerId"),r=!!e.getValue("RemoveAllFeatures"),i=e.getValue("FeatureSet"),n=e.getValue("RendererJson"),a=e.getEsriMap();if(null==a)throw new Error("Update Graphics Layer: No map available.");var o=!1,l=p.findMapServiceByMap(a,t);if(l){if(!(l instanceof esri.layers.GraphicsLayer))throw new Error("Update Graphics Layer: The layer '"+t+"' is not a GraphicsLayer")}else l=new esri.layers.GraphicsLayer({id:t}),o=!0;try{if(l.suspend(),r&&l.clear(),i&&i.features)for(var s=i.features.length-1;0<=s;--s)l.add(i.features[s]);n&&(l.renderer=esri.renderer.fromJson(JSON.parse(n))),o&&a.addLayer(l)}finally{l.resume()}e.completeActivity()},t.setLayerVisibility=o})},"geocortex/workflow/MapActivityHandlers":function(){define(["require","exports","./../essentials/utilities/SiteResourceIdComparer","./../essentials/LayerType","./../essentials/ReportParameters","./../essentials/Resolution","./../essentials/Scale","./../essentials/TextField"],function(e,t,a,m,E,b,A,I){"use strict";var x;Object.defineProperty(t,"__esModule",{value:!0}),(x=t.MapActivityHandlers||(t.MapActivityHandlers={})).handleRefreshMap=function(e){var t=e.getValue("MapServiceId");if(null==e.getEsriMap())throw new Error("Refresh Map: no map available.");function r(e){var t=e.serviceLayer;if("function"==typeof t.refresh)if("boolean"==typeof t.disableClientCaching){var r=t.disableClientCaching;t.disableClientCaching=!0,t.refresh(),t.disableClientCaching=r}else t.refresh()}var i=e.workflow().site.essentialsMap.mapServices;if(t){var n=a.SiteResourceIdComparer.lookUp(i,t);n&&r(n)}else dojo.forEach(i,function(e){r(e)});e.completeActivity()},x.handleGetMapExtent=function(e){var t=e.getEsriMap();if(null==t)throw new Error("Get Map Extent: No map available.");e.setValue("Extent",t.extent),e.completeActivity()},x.handleGetMapInfo=function(e){var t=e.getEsriMap();if(null==t)throw new Error("Get Map Info: No map available.");e.setValue("Extent",t.extent),e.setValue("Scale",esri.geometry.getScale(t)),e.setValue("SpatialReference",t.spatialReference),e.setValue("Height",t.height),e.setValue("Width",t.width);var r=[];null!=t.layerIds&&(r=r.concat(t.layerIds)),null!=t.graphicsLayerIds&&(r=r.concat(t.graphicsLayerIds)),e.setValue("MapServiceIds",r),e.completeActivity()},x.handleSetMapExtent=function(e){var t=e.getValue("Extent");if(null==t)throw new Error("Set Map Extent: required Extent argument was not supplied.");var r=e.getEsriMap();if(null==r)throw new Error("Set Map Extent: No map available.");t.spatialReference&&(t.spatialReference.wkid||t.spatialReference.wkt)||(t.spatialReference=r.spatialReference);var i=e.getSite();i&&i.essentialsMap?setTimeout(function(){return i.essentialsMap.extentManager.setExtentWithPriority(t,10)},1e3):r.setExtent(t),e.completeActivity()},x.handleCaptureGeometry=function(i){var n=i.dispatcher();if(!n.abortMapBasedActivity())throw new Error("Could not deactivate current map based activity.");function r(e,t,r){r.deactivate(),dojo.disconnect(t),n.setDrawObjectContext(null),i.setValue("Result",e),i.completeActivity()}var a,e=i.getValue("CaptureType"),o=i.getEsriMap(),l=!0;if(null==o)throw new Error("Capture Geometry: No map available.");if("function"!=typeof esri.toolbars.Draw)throw new Error('dojo.require("esri.toolbars.draw") must be added to your client code to use CaptureGeometry activity.');var t=new esri.toolbars.Draw(o);a=dojo.connect(t,"onDrawComplete",dojo.hitch(a,function(e){r(e,a,t)}));var s=function(e){var t;switch(e){case 0:t=esri.toolbars.Draw.EXTENT;break;case 1:t=esri.toolbars.Draw.FREEHAND_POLYGON;break;case 2:t=esri.toolbars.Draw.FREEHAND_POLYLINE;break;case 3:t=esri.toolbars.Draw.LINE;break;case 4:t=esri.toolbars.Draw.POINT;break;case 5:t=esri.toolbars.Draw.MULTI_POINT;break;case 6:t=esri.toolbars.Draw.POLYGON;break;case 7:t=esri.toolbars.Draw.POLYLINE;break;case 8:r(o.extent,a,toolbar),l=!1;break;default:t=esri.toolbars.Draw.EXTENT}return t}(e);l&&t.activate(s),n.setDrawObjectContext({activityContext:i,toolbar:toolbar,drawEvent:a})},x._pickSupported=function(e,t){if(!e||e.length<=0)return null;if(t)for(var r=t.toUpperCase(),i=0,n=e;i<n.length;i++){var a=n[i];if(a&&a.toUpperCase()===r)return a}return e[0]},x.handleIntersectLayers=function(e){var t,n,a,o,r,l=[],s=[],u=[],c=[],p=null,d=null,f=null,y=!1,h=null,i=-1,v=e.getValue("InputLayers");if(v&&0<v.length)for(r=0;r<v.length;r++)0<=(i=v[r].lastIndexOf("\\\\"))&&(v[r]=v[r].substring(i+"\\\\".length));else e.dispatcher().handleError(new Error("Intersect Layers: no input layers provided."),e);function g(){p=n.mapServices[a],d=p.layers,h=[];var r=v.length,i="";for(d.forEach(function(e){i=e.name;for(var t=0;t<r;++t)if(i===v[t]){h.push(e);break}}),o=0;o<h.length;o++){switch(f=h[o],y=!1,f.type){case m.LayerType.FEATURE_LAYER:s.push(f.name),y=!0;break;case m.LayerType.GROUP_LAYER:u.push(f.name),y=!0;break;case m.LayerType.RASTER_LAYER:c.push(f.name),y=!0}y&&l.push(f.name)}}for((t=e.getSite())||e.dispatcher().handleError(new Error("Intersect Layers: no site available."),e),(n=t.essentialsMap)||e.dispatcher().handleError(new Error("Intersect Layers: no map available."),e),(!n.mapServices||n.mapServices.length<=0)&&e.dispatcher().handleError(new Error("Intersect Layers: no map service is configured for the map."),e),a=0;a<n.mapServices.length;a++)g();e.setValue("OutputLayers",l),e.setValue("FeatureLayers",s),e.setValue("GroupLayers",u),e.setValue("RasterLayers",c),e.completeActivity()},x.handleExportMap=function(r){var e,t=r.getValue("TargetSpatialReference"),i=r.getValue("CustomExtent"),n=r.getValue("Resolution"),a=r.getValue("OutputFormat"),o=r.getValue("Scale"),l=r.getValue("ImageHeight"),s=r.getValue("ImageWidth"),u=r.getValue("UseTransparentBackground"),c=null,p=null,d=null;(c=r.getSite())||r.dispatcher().handleError(new Error("Export Map: no site available."),r),(e=c.getMap())||r.dispatcher().handleError(new Error("Export Map: no map available."),r),(p=c.essentialsMap)||r.dispatcher().handleError(new Error("Export Map: no map available."),r),(d=new E.ReportParameters).outputFormat=x._pickSupported(p.supportedExportFormats,a),n&&(d.resolution=new b.Resolution("",n)),o&&(d.scale=new A.Scale("",o)),d.imageHeight=l||e.height,d.imageWidth=s||e.width,i&&(d.customExtent=i),d.extentType=i?E.ReportParameters.CUSTOM_EXTENT:E.ReportParameters.CURRENT_EXTENT,d.useTransparentBackground=u,t&&(d.targetSpatialReference=t),e&&d.populateMapGraphicsLayers(e),p.exportMap(d,function(e){var t=e?e.href:null;r.setValue("ResultUrl",t),r.completeActivity()},function(e){r.dispatcher().handleError(new Error("Error exporting map '"+e.message+"'"),r)})},x.handlePrintMap=function(r){var e=r.getValue("TargetSpatialReference"),t=r.getValue("TextFields"),i=r.getValue("CustomExtent"),n=r.getValue("NotificationEmailAddress"),a=r.getValue("Resolution"),o=r.getValue("OutputFormat"),l=r.getValue("Scale"),s=r.getValue("PrintTemplateId"),u=r.getValue("GridId"),c=null;(c=r.getSite())||r.dispatcher().handleError(new Error("Print Map: no site available."),r),c.getMap()||r.dispatcher().handleError(new Error("Print Map: no map available."),r);var p=c.findPrintTemplateById(s);p||r.dispatcher().handleError(new Error("Print Map: unable to find print template '"+s+"'."),r),p.isPrinting()&&r.dispatcher().handleError(new Error("Print Map: unable to perform print operation because print template '"+s+"' is busy."),r);var d=new E.ReportParameters;if(d.outputFormat=x._pickSupported(p.supportedOutputFormats,o),a&&(d.resolution=new b.Resolution("",a)),l&&(d.scale=new A.Scale("",l)),n&&(d.notificationEmailAddress=n),i&&(d.customExtent=i),d.extentType=i?E.ReportParameters.CUSTOM_EXTENT:E.ReportParameters.CURRENT_EXTENT,e&&(d.targetSpatialReference=e),p.textFields&&0<p.textFields.length&&t)for(var f=0,y=t;f<y.length;f++){var h=y[f];if(h)for(var v=0,g=p.textFields;v<g.length;v++){var m=g[v];if(h.Key===m.displayName){var w=new I.TextField(m.id,"",h.Value,!1);d.fields.push(w)}}}if(u){var S=dojo.filter(p.grids,function(e){return e.id===u});0<S.length&&(d.grid=S[0])}p.print(d,function(e){var t=e?e.href:null;r.setValue("ResultUrl",t),r.completeActivity()},function(e){r.dispatcher().handleError(new Error("Error printing map '"+e.message+"'"),r)})}})},"geocortex/workflow/MapServiceActivityHandlers":function(){define(["require","exports","./../essentials/utilities/SiteResourceIdComparer"],function(e,t,s){"use strict";function w(e,t){return t&&e&&e.essentialsMap&&e.essentialsMap.mapServices?s.SiteResourceIdComparer.lookUp(e.essentialsMap.mapServices,t):null}function S(e,t){if(!e||!t)return null;if(null!=e.layerIds)for(var r=0,i=e.layerIds;r<i.length;r++){var n=i[r];if(null!=(l=e.getLayer(n))&&s.SiteResourceIdComparer.equals(l.id,t))return l}if(null!=e.graphicsLayerIds)for(var a=0,o=e.graphicsLayerIds;a<o.length;a++){var l;if(n=o[a],null!=(l=e.getLayer(n))&&s.SiteResourceIdComparer.equals(l.id,t))return l}return null}Object.defineProperty(t,"__esModule",{value:!0}),t.findMapServiceById=w,t.findMapServiceByMap=S,t.handleRemoveMapService=function(e){var t=e.getValue("MapServiceId"),r=e.getEsriMap();if(null==r)throw new Error("Remove Map Service: No map available.");var i=S(r,t);if(i){r.removeLayer(i);var n=e.getSite();n&&n.essentialsMap&&n.essentialsMap.mapServices&&n.essentialsMap.removeServiceLayer(i)}e.completeActivity()},t.handleSetImageServiceInfo=function(a){var o=a.getValue("ImageServiceId"),l=a.getValue("BandIds"),s=a.getValue("MosaicRule"),u=a.getValue("RenderingRule"),c=a.getEsriMap();if(null==c)throw new Error("Set Image Service Info: No map available.");e(["esri/layers/RasterFunction"],function(e){var t=S(c,o);if(t instanceof esri.layers.ArcGISImageServiceLayer){var r=t;if(l&&r.setBandIds(l,!0),s){var i=new esri.layers.MosaicRule(s);i.method||(i=r.defaultMosaicRule),r.setMosaicRule(i,!0)}if(u){var n=new esri.layers.RasterFunction(u);n.functionName||(n=null),r.setRenderingRule(n,!0)}r.refresh()}a.completeActivity()})},t.handleSetMapServiceVisibility=function(e){var t=e.getValue("MapServiceId"),r=e.getValue("Visible");if(null==t)throw new Error("Set Map Service Visibility: required MapServiceId argument was not supplied.");if(null==r)throw new Error("Set Map Service Visibility: required Visible argument was not supplied.");var i=e.getEsriMap(),n=e.getSite();if(null==i)throw new Error("Set Map Service Visibility: No map available.");var a=null;if(null==(a=S(i,t)))throw new Error("Set Map Service Visibility: Unable to find map service with ID '"+t+"'");if(a.setVisibility(r),e.completeActivity(),n&&t){var o=w(n,t);dojo.publish("MapServiceVisibilityChangedEvent",o)}},t.handleGetMapServiceInfo=function(e){if(!e)throw new Error("Get Map Service Info: required context was not supplied.");var t=e.getValue("MapServiceId"),r=e.getValue("LayerName");if(null==t)throw new Error("Get Map Service Info: required MapServiceId argument was not supplied.");var i=null,n=null,a=null,o=null,l=!1,s=e.getEsriMap();if(null==s)throw new Error("Get Map Service Info: No map available.");var u=e.getSite(),c=null,p=null;if(null!=u&&null!=u.essentialsMap&&null!=(p=w(u,t))&&(c=p.serviceLayer,i=p.serviceUrl,n=p.findServiceToken(),l=p.isVisible()),null==c&&(c=S(s,t))&&(i=c.url,"boolean"==typeof c.visible&&(l=c.visible)),null!=r){var d=!1;if(c){if(c.supportsDynamicLayers&&c.dynamicLayerInfos)for(var f=0,y=c.dynamicLayerInfos;f<y.length;f++)if((g=y[f]).name===r||"{0}".format(g.id)===r){d=!0,a="dynamicLayer",o=g.source;break}if(!d&&c.layerInfos)for(var h=0,v=c.layerInfos;h<v.length;h++){var g;if(null!=(g=v[h])&&null!=g.id&&g.name===r){d=!0,a=g.id;break}}}if(!d&&p){var m=p.findLayerOrTableByName(r);m&&(d=!0,a=m.id)}}e.setValue("MapServiceUrl",i),e.setValue("Token",n),e.setValue("LayerId",a),e.setValue("Source",o),e.setValue("Visible",l),e.completeActivity()},t.handleSetMapServiceProperty=function(e){var t="Set Map Service Property",r=e.getValue("MapServiceId"),i=e.getValue("PropertyName"),n=e.getValue("Value");if(!r)throw new Error("{0}: required MapServiceId argument was not supplied.".format(t));if(!i)throw new Error("{0}: required PropertyName argument was not supplied.".format(t));var a=e.getEsriMap();if(!a)throw new Error("{0}: no map available.".format(t));var o=S(a,r);if(!o)throw new Error("{0}: unable to find map service with ID '{1}'.".format(t,r));if("gdbversion"===i.toLowerCase())if(o instanceof esri.layers.FeatureLayer){if(!o.isDataVersioned)throw new Error("{0}: map service with ID '{1}' is not versioned.".format(t,r));o.setGDBVersion(n)}else{if(!(o instanceof esri.layers.ArcGISDynamicMapServiceLayer))throw new Error("{0}: map service with ID '{1}' does not support GDB version.".format(t,r));o.setGDBVersion(n)}else if("visible"===i.toLowerCase())o.setVisibility(n);else{i="set"+i.toLowerCase();var l=null;for(var s in o)if(s.toLowerCase()===i){l=s;break}if(!l)throw new Error("{0}: map service property '{1}' does not exist.".format(t,i));o[l](n)}e.completeActivity()}})},"geocortex/workflow/NativeActivityHandlers":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleGetCurrentPosition=function(t){function r(e){t.setValue("ErrorCode",e.code),t.setValue("ErrorMessage",e.message),t.completeActivity()}function i(e){e?(t.setValue("Latitude",e.coords.latitude),t.setValue("Longitude",e.coords.longitude),t.setValue("Altitude",e.coords.altitude),t.setValue("Accuracy",e.coords.accuracy),t.setValue("AltitudeAccuracy",e.coords.altitudeAccuracy),t.setValue("Heading",e.coords.heading),t.setValue("Speed",e.coords.speed),t.setValue("Timestamp",e.timestamp),t.completeActivity()):r({code:3,message:"A geolocated position could not be obtained before the timeout."})}var e=t.getValue("UseMultipleReadings"),n=t.getValue("AccuracyThreshold")||10,a={enableHighAccuracy:t.getValue("EnableHighAccuracy"),timeout:t.getValue("Timeout")||2e4,maximumAge:t.getValue("MaximumAge")};if(navigator.geolocation)if(e){var o,l,s;l=setTimeout(function(){o&&navigator.geolocation.clearWatch(o),l&&clearTimeout(l),i(s)},a.timeout),o=navigator.geolocation.watchPosition(function(e){(!s||e.coords.accuracy<=n)&&(s=e),s.coords.accuracy<=n&&(clearTimeout(l),navigator.geolocation.clearWatch(o))},function(e){r(e)},a)}else navigator.geolocation.getCurrentPosition(function(e){i(e)},function(e){r(e)},a);else r({code:2,message:"Geolocation is not supported."})},t.handleGetPhoto=function(t){if(!navigator.camera)return t.setValue("Message","camera is not supported."),void t.completeActivity();var e={quality:t.getValue("Quality"),destinationType:t.getValue("DestinationType"),sourceType:t.getValue("SourceType"),allowEdit:t.getValue("AllowEdit"),encodingType:t.getValue("EncodingType"),targetWidth:t.getValue("TargetWidth"),targetHeight:t.getValue("TargetHeight")};navigator.camera.getPicture(function(e){t.setValue("ImageData",e),t.completeActivity()},function(e){t.setValue("Message",e),t.completeActivity()},e)}})},"geocortex/workflow/SimpleActivityDispatcher":function(){define(["require","exports","./DefaultActivityDispatcher"],function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=(i.prototype.dispatch=function(e){this._defaultActivityDispatcher.canHandleActivity(e)?this._defaultActivityDispatcher.dispatch(e):null!=this._dispatchFunction&&this._dispatchFunction(e)},i.prototype.handleError=function(e,t){null!=this._handleErrorFunction&&this._handleErrorFunction(e,t)},i.prototype.abortMapBasedActivity=function(){if(this._drawObjectContext){if(!this._drawObjectContext.toolbar||!this._drawObjectContext.drawEvent||!this._drawObjectContext.activityContext)return!1;this._drawObjectContext.toolbar.deactivate(),dojo.disconnect(this._drawObjectContext.drawEvent),this._drawObjectContext.activityContext.abortActivity(),this._drawObjectContext=null}return!0},i.prototype.setDrawObjectContext=function(e){this._drawObjectContext=e},i.prototype.activityBegin=function(e){null!=this._activityBeginFunction&&this._activityBeginFunction(e)},i.prototype.activityComplete=function(e){null!=this._activityCompleteFunction&&this._activityCompleteFunction(e)},i.prototype.activityAbort=function(e){this.workflowAbort(e,e.workflow())},i.prototype.webRequestBegin=function(e,t){null!=this._webRequestBeginFunction&&this._webRequestBeginFunction(e,t)},i.prototype.webRequestComplete=function(e,t){null!=this._webRequestCompleteFunction&&this._webRequestCompleteFunction(e,t)},i.prototype.workflowComplete=function(e,t){null!=this._workflowCompleteFunction&&this._workflowCompleteFunction(e,t)},i.prototype.workflowAbort=function(e,t){null!=this._workflowAbortFunction&&this._workflowAbortFunction(e,t)},i.prototype.handleOpenReportUrl=function(e,t){window.open(e)},i);function i(e,t,r,i,n,a,o,l){this._defaultActivityDispatcher=new s.DefaultActivityDispatcher,this._drawObjectContext=null,this.isBusy=null,this._dispatchFunction=e||null,this._handleErrorFunction=t||null,this._activityBeginFunction=r||null,this._activityCompleteFunction=i||null,this._workflowCompleteFunction=n||null,this._workflowAbortFunction=a||null,this._webRequestBeginFunction=o||null,this._webRequestCompleteFunction=l||null}t.SimpleActivityDispatcher=r})},"geocortex/workflow/WorkflowControllerProxy":function(){define(["require","exports","./WorkflowState","./ActivityContext","./../geocortex","./DefaultActivityHandlers","./ExternalActivityInfo","./ArgumentInfo"],function(e,t,s,u,c,p,a,o){"use strict";function i(t,r,e,i,n){var a={};if(null==t){var o=new Error("workflow cannot be null");if(null!=r)return void r.handleError(o,null);throw o}var l=t.url+"/run";if(i&&(y(i),a.inargs=JSON.stringify(i)),null!=e){for(var s=0,u=e.pendingExternalActivities;s<u.length;s++)y(u[s].outputs);a.workflow=JSON.stringify(e)}a=c.encodeJson(dojo.mixin({f:"json"},a)),null!=r&&(r.isBusy=!0),r.webRequestBegin(l,t),c.request({url:l,content:a,load:dojo.hitch(this,function(e){r.webRequestComplete(l,t),d(e,t,r)}),error:dojo.hitch(this,function(e){if(null==r)throw e;r.isBusy=!1,r.handleError(e,n)}),callbackParamName:"CallBack"},{usePost:!0})}function d(e,i,n){if(null!=n&&(n.isBusy=!1),e)if(e.error){var t=new Error("Error running workflow: "+e.error.message);f(n,t)}else{var a=new s.WorkflowState(e.instanceId,e.status,h(e.pendingExternalActivities),v(e.outputs),e.workflowData,e.instanceData);if("Completed"===a.status)null!=n&&n.workflowComplete(a.outputs,i);else if("WaitingForExternalActivities"===a.status){var o=a.pendingExternalActivities;if(null!=o)for(var r=function(e){var t=new u.ActivityContext(n,e,i,a);null!=n&&n.activityBegin(t);var r=o[e];y(r.inputs);try{"debugger"===t.getActivityExternalId()||r&&r.debug?p.showDebug(t,!0,function(){g(t)}):g(t)}catch(e){f(n,e,t)}},l=0;l<o.length;l++)r(l)}}}function f(e,t,r){if(null==e)throw t;e.handleError(t,r||null)}function y(e){if(null!=e)for(var t=0,r=e;t<r.length;t++){var i=r[t],n=function(e){var t=e,r=e.indexOf(",");return 0<r&&(t=e.substring(0,r)),t},a=n(i.runtimeTypeName);if(i.value=l(i.value,a),null==i.value){var o=n(i.typeName);i.value=l(i.value,o)}}}function l(e,t){var r=e;switch(t){case"ESRI.ArcGIS.Client.Tasks.FeatureSet":var i=e;if(null!=i){var n=new esri.tasks.FeatureSet(i);n.features=n.features||[],r=n}break;case"ESRI.ArcGIS.Client.Geometry.Geometry":case"ESRI.ArcGIS.Client.Geometry.Envelope":case"ESRI.ArcGIS.Client.Geometry.MapPoint":case"ESRI.ArcGIS.Client.Geometry.MultiPoint":case"ESRI.ArcGIS.Client.Geometry.Polygon":case"ESRI.ArcGIS.Client.Geometry.Polyline":var a=e;if(null!=a){var o=esri.geometry.fromJson(a);o&&o.spatialReference&&!a.spatialReference&&(o.spatialReference=null),r=o}break;case"ESRI.ArcGIS.Client.Geometry.SpatialReference":var l=e;null!=l&&(r=new esri.SpatialReference(l));break;case"ESRI.ArcGIS.Client.LayerMapSource":var s=e;s&&(r=new esri.layers.LayerMapSource(s));break;case"ESRI.ArcGIS.Client.LayerDataSource":var u=e;u&&(r=new esri.layers.LayerDataSource(u));break;case"ESRI.ArcGIS.Client.TimeExtent":if(e instanceof Array){var c=e;if(0<c.length){var p=new Date(c[0]),d=1<c.length?new Date(c[1]):p;r=new esri.TimeExtent(p,d)}}break;case"ESRI.ArcGIS.Client.Graphic":e&&(e.toJson?r=e.toJson():(r=new esri.Graphic,e.Geometry&&(r.geometry=esri.geometry.fromJson(e.Geometry)),e.Symbol&&r.setSymbol(esri.symbol.fromJson(e.Symbol))));break;case"System.DateTime":e instanceof Date&&(r="/Date("+e.getTime()+")/")}return r}function h(e){var t=[];if(null!=e)for(var r=0;r<e.length;r++){var i=e[r],n=new a.ExternalActivityInfo;n._configureObject(i),t[r]=n}return t}function v(e){var t=[];if(null!=e)for(var r=0;r<e.length;r++){var i=e[r],n=new o.ArgumentInfo;n._configureObject(i),t[r]=n}return t}function g(e){if(null==e.dispatcher())throw new Error("Unhandled activity: "+e.getActivityTypeName());e.dispatcher().dispatch(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.startWorkflow=function(e,t,r){i(e,t,null,r,null)},t._executeWorkflow=i,t._processWorkflowResults=d,t._handleErrorInternal=f,t._preProcessArguments=y,t._getObjectFromJsonWithType=l,t._getExternalActivities=h,t._getArguments=v,t._dispatch=g})},"geocortex/workflow/WorkflowState":function(){define(["require","exports"],function(e,t){"use strict";function r(e,t,r,i,n,a){this.instanceId=e,this.status=t,this.pendingExternalActivities=r,this.outputs=i,this.workflowData=n,this.instanceData=a}Object.defineProperty(t,"__esModule",{value:!0}),t.WorkflowState=r})}}});require({cache:{"geocortex/workflow":function(){}}});