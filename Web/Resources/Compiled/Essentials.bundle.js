require({cache:{"geocortex/config":function(){define(["require","exports"],function(e,o){"use strict";Object.defineProperty(o,"__esModule",{value:!0}),o.config={baseUrl:"http://localhost/",io:{errorHandler:function(e,o){dojo.publish("geocortex.Error",[e])},postLength:2e3,timeout:6e4},REST_version:"3.0",authenticationDialogId:null}})}}});!function(){require({cache:{"geocortex/essentials/ArcGisPortalSecurityContext":function(){define(["require","exports","./OAuth2Client","./utilities/DecomposedUri","./utilities/StringUtilities"],function(e,t,i,r,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t,i){this.baseUrl=e,this.domains=t,this.clientId=i}return e.prototype.initiate=function(){return this.tokenResult||(this.tokenResult=i.OAuth2Client.getTokenFromImplicitGrant()),this.tokenResult?(i.OAuth2Client.removeImplicitGrantParamsAndUpdateUrlHash(),!0):(this.error=i.OAuth2Client.getErrorFromImplicitGrant(),this.error||i.OAuth2Client.redirectToLogOnPage(this.getLogOnUrl(),this.clientId),i.OAuth2Client.removeImplicitGrantParamsAndUpdateUrlHash(),!1)},e.prototype.getLogOnUrl=function(){return this.baseUrl+"oauth2/authorize"},e.prototype.getToken=function(e){return this.tokenResult&&e&&this.appliesTo(e)?this.tokenResult.token:null},e.prototype.appliesTo=function(e){for(var t=r.DecomposedUri.getHost(e),i=0;i<this.domains.length;i++)if(n.StringUtilities.endsWith(t,this.domains[i]))return!0;return!1},e}();t.ArcGisPortalSecurityContext=s})},"geocortex/essentials/AsyncInitializable":function(){define(["require","exports","./../geocortex"],function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e){this.initializationFailure=null,this.isInitialized=!1,this.onInitializationFailed=null,this.onInitialized=null,this._initializing=!1,this.url=e,this._initializedHandler=dojo.hitch(this,this._initializedHandler),this._initializationFailedHandler=dojo.hitch(this,this._initializationFailedHandler),this._restLoadHandler=dojo.hitch(this,this._restLoadHandler),this._restErrorHandler=dojo.hitch(this,this._restErrorHandler)}return e.prototype.initialize=function(e){if(!this.isInitialized&&!this._initializing){var t=void 0!==e&&null!==e;if(t)this._restLoadHandler(!0,e);else{if(!this.url)throw new Error("Unable to initialize AsyncInitializable without a valid URL.");this._initializing=!0,i.request({url:this.url,content:{f:"json"},load:dojo.hitch(this,this._restLoadHandler,t),error:this._restErrorHandler,callbackParamName:"CallBack"})}}},e.prototype.doWhenInitialized=function(e,t){if(1===arguments.length&&(t=e,e=this),this.isInitialized)t.call(e,this);else var i=dojo.connect(this,"onInitialized",this,function(){dojo.disconnect(i),t.apply(e,arguments)})},e.prototype._configureObject=function(e,t){},e.prototype._initializationFailedHandler=function(e){this.initializationFailure=e,this.onInitializationFailed&&this.onInitializationFailed(e)},e.prototype._initializedHandler=function(e){this.isInitialized=!0,this.onInitialized&&this.onInitialized(e),this._initializing=!1},e.prototype._restErrorHandler=function(e){this._initializationFailedHandler(e),this._initializedHandler(this)},e.prototype._restLoadHandler=function(e,t){this._configureObject(t,e),this._initializedHandler(this)},e}();t.AsyncInitializable=r})},"geocortex/essentials/AuthenticationControlBlock":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){return function(){this.messageFromServer=null,this.password=null,this.pendingCalls=[],this.tokenService=null,this.tokenRootUri=null,this.targetRootUri=null,this.token=null,this.username=null}}();t.AuthenticationControlBlock=i})},"geocortex/essentials/AuthenticationControlBlockStore":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(){this._authenticationControlBlocks=[]}return e.prototype.add=function(e){null===this.find(e.tokenRootUri)&&this._authenticationControlBlocks.push(e)},e.prototype.remove=function(e){for(var t=0;t<this._authenticationControlBlocks.length;t++)if(this._authenticationControlBlocks[t]===e)return this._authenticationControlBlocks.splice(t,1),!0;return!1},e.prototype.find=function(e){for(var t=0;t<this._authenticationControlBlocks.length;t++){var i=this._authenticationControlBlocks[t],r=i.tokenRootUri,n=i.targetRootUri;if(0===e.toLowerCase().indexOf(r.toLowerCase())||0===e.toLowerCase().indexOf(n.toLowerCase()))return i}return null},e.prototype.removeAt=function(e){this._authenticationControlBlocks.splice(e,1)},e}();t.AuthenticationControlBlockStore=i})},"geocortex/essentials/BaseMap":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){return function(e){if(this.displayName=null,this.essentialsMap=null,this.extensions=[],this.id=null,this.iconUri=null,this.exportTilesMapServiceUri=null,this.properties={},this.services=[],!e)throw new Error("Essentials map is required for a basemap.");this.essentialsMap=e}}();t.BaseMap=i})},"geocortex/essentials/BaseMapService":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){return function(e){if(this.mapService=null,!e)throw new Error("Map service is required for a basemap service.");this.mapService=e}}();t.BaseMapService=i})},"geocortex/essentials/DataLink":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}();define(["require","exports","./AsyncInitializable","./../geocortex"],function(t,i,r,n){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var s=function(t){function i(e){var i=t.call(this,e)||this;return i.displayName=null,i.extensions=[],i.id=null,i.visible=null,i.isOneToOne=!1,i.layer=null,i.parameters=[],i.searches=[],i.properties={},i._numDataLinkingRequests=0,i}return e(i,t),i.prototype.isDataLinking=function(){return!!this._numDataLinkingRequests},i.prototype.performDataLinking=function(e,t,i){var r=this,s=function(e){i&&i(new Error(e))};!e&&this.parameters.length>0&&s("No FeatureSetParameters provided");for(var a=this.url+"/link",o=null,l=0;l<this.parameters.length;l++){for(var c=this.parameters[l],u="",p=0;p<e.features.length;p++){var h=e.features[p],d=h.attributes[c.featureField];if(!d&&this.layer&&this.layer.fields){for(var f,y=0;y<this.layer.fields.length;y++){var m=this.layer.fields[y];if(m.name===c.featureField){f=m;break}}if(f){var v;f.alias&&f.alias in h.attributes?v=f.alias:f.displayName&&f.displayName in h.attributes&&(v=f.displayName),v&&v in h.attributes&&h.attributes[v]}}u+=(0===u.length?"":",")+(d||0===d?this._prepParamValue(d):" ")}u&&u.length>0&&((o=null===o?{}:o)[c.id]=u)}if(o){var g=n.encodeJson(dojo.mixin({f:"json"},o));this._numDataLinkingRequests++;n.request({url:a,content:g,load:function(e){r._numDataLinkingRequests--,!e&&i&&i(new Error("No results")),e.error&&i&&i(e.error),t&&t(r._parseConvertDates(e.results))},error:function(e){r._numDataLinkingRequests--,i&&i(e)},callbackParamName:"CallBack"})}else s("Missing Feature Fields.")},i.prototype._configureObject=function(e,t){if(void 0===e||void 0===e.displayName||void 0===e.parameters)throw new Error("Incorrect data link object returned from initialization");if(this.displayName=e.displayName,this.id=e.id,this.visible=void 0===e.visible||e.visible,this.isOneToOne=!!e.isOneToOne,this.parameters=e.parameters,this.searches=e.searches,this.searches)for(var i=0,r=this.searches.length;i<r;i++)this.searches[i].dataLink=this;t&&(this.isInitialized=!0),this.properties=n._getProperties(e.properties),this.extensions=n._getExtensions(e.extensions)},i.prototype._parseConvertDates=function(e){for(var t in e)if(e.hasOwnProperty(t)){var i=e[t];if("string"==typeof i){if(i.length>6&&"/Date("===i.substring(0,6)){i=parseInt(i.substring(6));var r=new Date(i);e[t]=r}}else"object"==typeof i&&(e[t]=this._parseConvertDates(i))}return e},i.prototype._prepParamValue=function(e){var t="";return"number"==typeof e?t=e.toString():"string"==typeof e&&(t=e.replace(/,/g,"\\,")),t},i}(r.AsyncInitializable);i.DataLink=s})},"geocortex/essentials/DataLinkParameter":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){return function(){this.featureField=null,this.id=null,this.name=null,this.type=null}}();t.DataLinkParameter=i})},"geocortex/essentials/DataLinkSearch":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/DistanceUnit":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){this.name=e,this.type=t}return e.prototype.isLinear=function(){return!(this.type===r.DEGREES||this.type===r.RADIANS||this.type===r.GRADS||this.type===r.OTHER)},e}();t.DistanceUnit=i;var r;!function(e){e.OTHER="Other",e.INCHES="Inches",e.FEET="Feet",e.US_SURVEY_FEET="USSurveyFeet",e.YARDS="Yards",e.MILES="Miles",e.NAUTICAL_MILES="NauticalMiles",e.MILLIMETERS="Millimeters",e.CENTIMETERS="Centimeters",e.DECIMETERS="Decimeters",e.METERS="Meters",e.KILOMETERS="Kilometers",e.DEGREES="Degrees",e.RADIANS="Radians",e.GRADS="Grads"}(r=t.DistanceUnitType||(t.DistanceUnitType={}))})},"geocortex/essentials/EssentialsFeatureSet":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(){}return e.prototype.toJson=function(){return JSON.stringify(this)},e}();t.EssentialsFeatureSet=i})},"geocortex/essentials/EssentialsLayerInfo":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){return function(){}}();t.EssentialsLayerInfo=i})},"geocortex/essentials/ExportMapImageOptions":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){return function(e,t){void 0===t&&(t="Png"),this.defaultOutputFormat=t,this.allowIncludeGeoreferenceData=e}}();t.ExportMapImageOptions=i})},"geocortex/essentials/Extension":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){return function(e,t){this.className=e,this.instance=t}}();t.Extension=i})},"geocortex/essentials/ExtentManager":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i;!function(e){e[e.NONE=-1]="NONE",e[e.RESIZE=0]="RESIZE",e[e.REPOSITION=1]="REPOSITION",e[e.EXTENT_CHANGE=2]="EXTENT_CHANGE"}(i||(i={}));var r=function(){function e(e,t){var i=this;this._map=null,this._currentExtentChangePriority=-1,this._queuedExtentChangePriority=-1,this._queuedExtentChange=[],this._extentChangeInProgress=!1,this._fitTiledMapsToExtent=!1,this._newLayers=[],this._initialExtent=null,this.currentExtentChangeHandle=null,this._firstMapResizeExecuted=!1,this._map=e,this._fitTiledMapsToExtent=!!t,this._fitTiledMapsToExtent&&console.log("The fitTiledMapsToExtent parameter is active. When true, for maps that contain tiled map service layers, you are guaranteed to have the input extent shown completely on the map."),this._map.on("resize",dojo.hitch(this,this._onResize)),this._map.on("reposition",dojo.hitch(this,this._onReposition));var r=this._map.on("extent-change",function(){r.remove(),i._firstMapResizeExecuted=!0})}return e.prototype._onResize=function(e,t,i){this._firstMapResizeExecuted?this._handleNextExtentChange():this.firstResize()},e.prototype.firstResize=function(){this._firstMapResizeExecuted=!0;this._initialExtent&&this._map.extent&&!this._fitTiledMapsToExtent&&!this._map.extent.expand(1.75).contains(this._initialExtent)&&console.log("The 'fitTiledMapsToExtent' parameter may need to be set to true in configuration for the initial extent to be shown completely on the map."),this._handleNextExtentChange()},e.prototype._onReposition=function(e,t){this._handleNextExtentChange()},e.prototype._onExtentChange=function(){this._extentChangeInProgress&&(this._currentExtentChangePriority=-1,this._extentChangeInProgress=!1,this._handleNextExtentChange())},e.prototype.registerLayer=function(e){this._hasLoaded()||this._newLayers.push(e)},e.prototype._handleNextExtentChange=function(){if(this._hasLoaded())if(null!==this._queuedExtentChange[i.RESIZE]&&void 0!==this._queuedExtentChange[i.RESIZE]){var e=this._queuedExtentChange[i.RESIZE];this._queuedExtentChange[i.RESIZE]=null,e(this._map)}else if(null!==this._queuedExtentChange[i.REPOSITION]&&void 0!==this._queuedExtentChange[i.REPOSITION]){var t=this._queuedExtentChange[i.REPOSITION];this._queuedExtentChange[i.REPOSITION]=null,t(this._map)}else if(null!==this._queuedExtentChange[i.EXTENT_CHANGE]&&void 0!==this._queuedExtentChange[i.EXTENT_CHANGE]){this._extentChangeInProgress=!0,this._currentExtentChangePriority=this._queuedExtentChangePriority,this._queuedExtentChangePriority=-1;var r=this._queuedExtentChange[i.EXTENT_CHANGE];this._queuedExtentChange[i.EXTENT_CHANGE]=null,r(this._map)}},e.prototype.changeExtentWithPriority=function(e,t){var r=this,n=void 0!==t?t:5,s=function(t){null!==r.currentExtentChangeHandle&&r.currentExtentChangeHandle.cancel(),r.currentExtentChangeHandle=e(t),r.currentExtentChangeHandle.then(dojo.hitch(r,r._onExtentChange),dojo.hitch(r,r._onExtentChange))};if(this._isExtentChangeBlocked()){if(n<this._queuedExtentChangePriority)return;this._queuedExtentChangePriority=n,this._queuedExtentChange[i.EXTENT_CHANGE]=s}else{if(n<this._currentExtentChangePriority)return;this._currentExtentChangePriority=n,this._extentChangeInProgress=!0,s(this._map)}},e.prototype.setExtentWithPriority=function(e,t){var i=this;this.changeExtentWithPriority(function(t){return new Promise(function(r,n){t.setExtent(e,i._fitTiledMapsToExtent).then(r,r)})},t)},e.prototype.centerAtWithPriority=function(e,t){this.changeExtentWithPriority(function(t){var i=t.extent.getCenter(),r=t.extent.getWidth()/t.width,n=t.extent.getHeight()/t.height;return e&&(Math.abs(i.x-e.x)>=r||Math.abs(i.y-e.y)>=n)?new Promise(function(i,r){t.centerAt(e).then(i,i)}):Promise.resolve()},t)},e.prototype.setScaleWithPriority=function(e,t){this.changeExtentWithPriority(function(t){return e!==t.getScale()?new Promise(function(i,r){t.setScale(e).then(i,i)}):Promise.resolve()},t)},e.prototype.blockForResize=function(e,t,i){this._firstMapResizeExecuted&&(e===this._map.width&&t===this._map.height||this._resize(!this._isResizeBlocked()))},e.prototype.blockForReposition=function(){this._firstMapResizeExecuted&&this._resize(!this._isRepositionBlocked())},e.prototype._resize=function(e){var t=function(t){t.position.update(0,0),t.resize(e)};e?t(this._map):this._queuedExtentChange[i.RESIZE]=function(e){t(e)}},e.prototype._isExtentChangeBlocked=function(){return null!=this._queuedExtentChange[i.REPOSITION]||null!=this._queuedExtentChange[i.RESIZE]||!this._hasLoaded()},e.prototype._isRepositionBlocked=function(){return this._extentChangeInProgress||!this._hasLoaded()},e.prototype._isResizeBlocked=function(){return this._isRepositionBlocked()},e.prototype._hasLoaded=function(){return this._map&&this._map.loaded&&this._firstMapResizeExecuted},e}();t.ExtentManager=r})},"geocortex/essentials/FeatureCluster":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/FeatureHeatMap":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/FeatureHyperlink":function(){define(["require","exports","./RestHelper"],function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){return function(e,t){this.encodeUriReplacementValues=e.encodeUriReplacementValues,this.target=e.target,this.text=e.text,this.toolTip=e.toolTip;var r=null;t&&t.mapService&&t.mapService.essentialsMap&&(r=t.mapService.essentialsMap.site),this.uri=i.RestHelper.processClientSideTokens(r,e.uri),this.iconUri=i.RestHelper.processClientSideTokens(r,e.iconUri),this.layer=t}}();t.FeatureHyperlink=r})},"geocortex/essentials/FeatureLayerService":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}();define(["require","exports","./MapService","./../geocortex","./RestHelperHTTPService"],function(t,i,r,n,s){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var a=function(t){function i(e){var i=t.call(this,e)||this;return i.color=[255,0,0],i.selectionColor=[0,255,255],i.disableClientCaching=!1,i.onDemandCacheSize=1e3,i.outFields="",i.queryMode=esri.layers.FeatureLayer.MODE_ONDEMAND,i.tileHeight=null,i.tileWidth=null,i.where=null,i.canUpdate=null,i.canAdd=null,i.canDelete=null,i.canEdit=null,i.canAddAttachments=null,i.moveEnabled=null,i.rotateEnabled=null,i.editVerticesEnabled=null,i.scaleEnabled=null,i.renderer=null,i._colorSet=!1,i._initialFeatureCollection=null,i._serviceLayer=null,i.serviceUrl=e,i}return e(i,t),i.prototype.getEmptyFeatureCollection=function(){return JSON.parse(this._initialFeatureCollection)},i.prototype.restoreFeatureLayer=function(){if(!this._serviceLayer._mode)switch(this._serviceLayer.mode){case esri.layers.FeatureLayer.MODE_SNAPSHOT:this._serviceLayer._mode=new esri.layers._SnapshotMode(this._serviceLayer);break;case esri.layers.FeatureLayer.MODE_ONDEMAND:this._serviceLayer._mode=new esri.layers._OnDemandMode(this._serviceLayer);break;case esri.layers.FeatureLayer.MODE_SELECTION:this._serviceLayer._mode=new esri.layers._SelectionMode(this._serviceLayer)}this.replaceFeatureLayer(this._serviceLayer,!0,!0,!0),this.serviceLayer.resume(),this.serviceLayer.mode===esri.layers.FeatureLayer.MODE_SNAPSHOT&&0===this.serviceLayer.graphics.length&&this.serviceLayer.refresh()},i.prototype.replaceFeatureLayer=function(e,t,i,r){var n=this.serviceLayer;if(!e)throw new Error("featureLayer cannot be null in order to replace the feature layer.");var s=this._getEsriMap();if(!s)throw new Error("Unable to get access to the Esri map object to perform the Feature Layer replace.");if(!this.serviceLayer)throw new Error("ServiceLayer not present. Can't replace the the FeatureLayer");t&&(e.visible=n.visible,e.setMaxScale(n.maxScale),e.setMinScale(n.minScale)),i&&(e.opacity=n.opacity),r&&e.setRenderer(n.renderer);var a=dojo.indexOf(s.graphicsLayerIds,n.id);this.serviceLayer=e,n.suspend(),s.removeLayer(n),s.addLayer(e,a),n.url||this._cleanUpLayer(n)},i.prototype._cleanUpLayer=function(e){if(e.clear(),e._essentialsMetadata){var t=e._essentialsMetadata.eventHandlers,i=0;for(i=0;i<t.length;i++)dojo.disconnect(t[i])}},i.prototype.setOpacity=function(e){t.prototype.setOpacity.call(this,e),this.featureClustering&&this.featureClustering.enabled&&this.clusterLayer&&this.explodedClusterLayer&&(this.clusterLayer.setOpacity(this.opacity),this.explodedClusterLayer.setOpacity(this.opacity))},i.prototype.queryCount=function(e,t,i){if(this.isServiceLayerLoaded&&this.serviceLayer){this.serviceLayer.queryCount(e,function(e){t&&t(e)},function(e){i&&i(e)})}},i.prototype.queryFeatures=function(e,t,i){if(this.isServiceLayerLoaded&&this.serviceLayer)return this.serviceLayer.queryFeatures(e,t,i);var r=new Error("Esri layer has not finished loading");if(i)return i(r),null;var n=new dojo.Deferred;return n.reject(r),n},i.prototype.queryIds=function(e,t,i){if(this.isServiceLayerLoaded&&this.serviceLayer)return this.serviceLayer.queryIds(e,t,i);if(i){var r=new Error("Esri layer has not finished loading");i(r);var n=new dojo.Deferred;return n.reject(r),n}},i.prototype.queryRelatedFeatures=function(e,t,i){if(this.isServiceLayerLoaded&&this.serviceLayer)return this.serviceLayer.queryRelatedFeatures(e,t,i);if(i){var r=new Error("Esri layer has not finished loading");i(r);var n=new dojo.Deferred;return n.reject(r),n}},i.prototype._getEsriMap=function(){var e=null;return null!==this.essentialsMap&&null!==this.essentialsMap.site&&(e=this.essentialsMap.site.getMap()),e},i.prototype._configureObject=function(e,i){if(void 0===e||void 0===e.outFields||void 0===e.queryMode||void 0===e.where)throw new Error("Incorrect map service object returned from initialization");this._configurePropertiesAndrenderer(e),t.prototype._configureObject.call(this,e,i)},i.prototype._configurePropertiesAndrenderer=function(e){if(this.disableClientCaching=!!e.disableClientCaching,this.onDemandCacheSize=void 0===e.onDemandCacheSize||null===e.onDemandCacheSize?this.onDemandCacheSize:e.onDemandCacheSize,e.outFields||(e.outFields="*"),this.outFields=e.outFields,this.where=e.where,void 0===e.queryMode)this.queryMode=esri.layers.FeatureLayer.MODE_ONDEMAND;else switch(e.queryMode){case"Selection":case"SelectionOnly":this.queryMode=esri.layers.FeatureLayer.MODE_SELECTION;break;case"Snapshot":this.queryMode=esri.layers.FeatureLayer.MODE_SNAPSHOT;break;default:this.queryMode=esri.layers.FeatureLayer.MODE_ONDEMAND}if(e.tileHeight&&(this.tileHeight=e.tileHeight),e.tileWidth&&(this.tileWidth=e.tileWidth),e.selectionColor&&(this.selectionColor=e.selectionColor),e.color&&(this.color=e.color,this._colorSet=!0,this.color.length>3&&(this.color[3]=this.color[3]/255)),this.editVerticesEnabled=!e.hasOwnProperty("editVerticesEnabled")||e.editVerticesEnabled,this.moveEnabled=!e.hasOwnProperty("moveEnabled")||e.moveEnabled,this.scaleEnabled=!e.hasOwnProperty("scaleEnabled")||e.scaleEnabled,this.rotateEnabled=!e.hasOwnProperty("rotateEnabled")||e.rotateEnabled,e.renderer)try{this.renderer=esri.renderer.fromJson(e.renderer)}catch(e){}},i.prototype._updateServiceToken=function(e){if(t.prototype._updateServiceToken.call(this,e),this.serviceLayer){var i=this.serviceLayer._task;i&&i._url&&i._url.query&&(i._url.query.token=e)}},i.prototype._createServiceLayer=function(){t.prototype._createServiceLayer.call(this);var e=this.serviceUrl;this.serviceToken&&(e=s.RestHelperHTTPService.appendTokenToUrl(e,this.serviceToken));var i={};i.id=this.id,i.opacity=this.configuredOpacity,i.visible=this._computeInitServiceLayerVisibility(),this.outFields&&this.outFields.length>0&&(i.outFields=this.outFields.split(",")),null!==this.queryMode&&(i.mode=this.queryMode),null!==this.tileHeight&&null!==this.tileWidth&&this.queryMode==esri.layers.FeatureLayer.MODE_ONDEMAND&&(i.tileHeight=this.tileHeight,i.tileWidth=this.tileWidth),this.serviceLayer=new esri.layers.FeatureLayer(e,i),this.serviceLayer.setRenderer(this.renderer),this.attributionDataUrl&&""!==this.attributionDataUrl?(this.serviceLayer.attributionDataUrl=this.attributionDataUrl,this.serviceLayer.hasAttributionData=!0):this.hasAttributionData&&(this.serviceLayer.attributionDataUrl=this.url+"/Attribution",this.serviceLayer.hasAttributionData=!0),this._serviceLayer=this.serviceLayer,this.where&&this.serviceLayer.setDefinitionExpression(this.where),dojo.connect(this.serviceLayer,"onError",this,this._layerLoadErrorHandler),this.serviceLayer.loaded?this._handleLayerLoadEvent(this.serviceLayer):dojo.connect(this.serviceLayer,"onLoad",dojo.hitch(this,this._handleLayerLoadEvent)),t.prototype.initiateServiceFailureTimer.call(this)},i.prototype._computeInitServiceLayerVisibility=function(){var e=this._initiallyVisible;return e&&this.layers&&1===this.layers.length&&(e=this.layers[0].isVisible()),e},i.prototype._handleLayerLoadEvent=function(e){if(this.serviceLayer.version<10||this._colorSet){var t=null;if("esriGeometryPoint"==this.serviceLayer.geometryType){t=new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE,15,null,new esri.Color(this.selectionColor));var i=new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE,15,null,new esri.Color(this.color)),r=new esri.renderer.SimpleRenderer(i);this.serviceLayer.setRenderer(r)}else if("esriGeometryPolyline"==this.serviceLayer.geometryType){t=new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new esri.Color(this.selectionColor),1);var n=new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new esri.Color(this.color),1),s=new esri.renderer.SimpleRenderer(n);this.serviceLayer.setRenderer(s)}else if("esriGeometryPolygon"==this.serviceLayer.geometryType){t=new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new esri.Color([0,0,0]),1),new esri.Color(this.selectionColor));var a=new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new esri.Color([0,0,0]),1),new esri.Color(this.color)),o=new esri.renderer.SimpleRenderer(a);this.serviceLayer.setRenderer(o)}this.serviceLayer.setSelectionSymbol(t)}var l=this.serviceLayer.getEditCapabilities();this.canUpdate=l.canUpdate,this.canAdd=l.canCreate,this.canDelete=l.canDelete,this.canEdit=this.serviceLayer.isEditable(),this.canAddAttachments=!1,this.serviceLayer.capabilities&&(this.canAddAttachments=this.serviceLayer.version&&this.serviceLayer.version>=10.1&&this.serviceLayer.hasAttachments&&this.canEdit),this._initialFeatureCollection=JSON.stringify(this.serviceLayer.toJson()),this._handleServiceLayerLoaded(e)},i.prototype.hasOriginRelationships=function(){if(this.serviceLayer&&this.serviceLayer.version>=10.1&&this.serviceLayer.relationships&&this.serviceLayer.relationships.length>0){for(var e=0;e<this.serviceLayer.relationships.length;e++)if("esriRelRoleOrigin"===this.serviceLayer.relationships[e].role)return!0;return!1}return!1},i.prototype.getRelatedFeatureLayer=function(e,t,i){var r=new dojo.Deferred;if(this.serviceLayer.version<10.1){o=new Error("getRelatedFeatureLayer is only available for feature layer from ArcGIS 10.1 or greater.");return r&&-1==r.fired&&r.resolve(o),"function"==typeof i&&i(o),r}var a=this._getEsriRelation(e);if(!a){var o=new Error("Relation not found: "+e);return r&&r.reject(o),"function"==typeof i&&i(o),r}var l=this.serviceUrl.substring(0,this.serviceUrl.lastIndexOf("/")+1)+a.relatedTableId;this.serviceToken&&(l=s.RestHelperHTTPService.appendTokenToUrl(l,this.serviceToken)),void 0===esri.getProxyRule(l)&&null!==this.proxyUrl&&esri.addProxyRule({urlPrefix:l,proxyUrl:this.proxyUrl});var c=new esri.layers.FeatureLayer(l,{mode:esri.layers.FeatureLayer.MODE_SELECTION,outFields:["*"]});return dojo.connect(c,"onLoad",dojo.hitch(this,function(e){n.deferredResolve(r,e),"function"==typeof t&&t(e)})),dojo.connect(c,"onError",dojo.hitch(this,function(e){r&&-1==r.fired&&r.resolve(e),"function"==typeof i&&i(e)})),r},i.prototype._getEsriRelation=function(e){if("string"==typeof e&&(e=parseInt(e)),this.serviceLayer.relationships)for(var t=0;t<this.serviceLayer.relationships.length;t++)if(this.serviceLayer.relationships[t].id==e)return this.serviceLayer.relationships[t];return null},i.prototype._getRelation=function(e){return this.layers&&this.layers.length>0?this.layers[0]._getRelation(e):null},i}(r.MapService);i.FeatureLayerService=a})},"geocortex/essentials/Field":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){return function(){}}();i.esriFieldTypeSmallInteger="esriFieldTypeSmallInteger",i.esriFieldTypeInteger="esriFieldTypeInteger",i.esriFieldTypeSingle="esriFieldTypeSingle",i.esriFieldTypeDouble="esriFieldTypeDouble",i.esriFieldTypeString="esriFieldTypeString",i.esriFieldTypeDate="esriFieldTypeDate",i.esriFieldTypeOID="esriFieldTypeOID",i.esriFieldTypeGeometry="esriFieldTypeGeometry",i.esriFieldTypeBlob="esriFieldTypeBlob",i.esriFieldTypeRaster="esriFieldTypeRaster",i.esriFieldTypeGUID="esriFieldTypeGUID",i.esriFieldTypeGlobalID="esriFieldTypeGlobalID",i.esriFieldTypeXML="esriFieldTypeXML",t.EsriFieldTypes=i;var r=function(){return function(){}}();r.essentialsFieldTypeSmallInteger="Int16",r.essentialsFieldTypeInteger="Int32",r.essentialsFieldTypeSingle="Single",r.essentialsFieldTypeDouble="Double",r.essentialsFieldTypeString="String",r.essentialsFieldTypeDate="DateTime",r.essentialsFieldTypeGUID="Guid",r.essentialsFieldTypeObject="Object",t.EssentialsFieldTypes=r;var n=function(){function e(e){if(this.layer=null,!e||!e.layer)throw new Error("Layer is required.");this.layer=e.layer,this.alias=e.alias,this.dataType=e.dataType,this.displayName=e.displayName,this.focusField=!!e.focusField,this.hyperlinkLabel=e.hyperlinkLabel,this.name=e.name,this.searchable=!!e.searchable,this.visible=!!e.visible,this.editable=null===e.editable||void 0===e.editable||e.editable,this.format=e.format}return e.prototype.toJson=function(){return{alias:this.alias,dataType:this.dataType,displayName:this.displayName,focusField:this.focusField,hyperlinkLabel:this.hyperlinkLabel,name:this.name,searchable:this.searchable,visible:this.visible,editable:this.editable,format:this.format}},e.convertFromEsriType=function(e){if(!e||0!==e.indexOf("esriFieldType"))return e;switch(e){case i.esriFieldTypeGeometry:case i.esriFieldTypeBlob:case i.esriFieldTypeRaster:return r.essentialsFieldTypeObject;case i.esriFieldTypeDate:return r.essentialsFieldTypeDate;case i.esriFieldTypeDouble:return r.essentialsFieldTypeDouble;case i.esriFieldTypeGlobalID:return r.essentialsFieldTypeGUID;case i.esriFieldTypeInteger:case i.esriFieldTypeOID:return r.essentialsFieldTypeInteger;case i.esriFieldTypeSingle:return r.essentialsFieldTypeSingle;case i.esriFieldTypeSmallInteger:return r.essentialsFieldTypeSmallInteger;case i.esriFieldTypeGUID:case i.esriFieldTypeString:case i.esriFieldTypeXML:default:return r.essentialsFieldTypeString}},e.convertToEsriFieldType=function(e){switch(e){case r.essentialsFieldTypeObject:return i.esriFieldTypeBlob;case r.essentialsFieldTypeDate:return i.esriFieldTypeDate;case r.essentialsFieldTypeDouble:return i.esriFieldTypeDouble;case r.essentialsFieldTypeGUID:return i.esriFieldTypeGlobalID;case r.essentialsFieldTypeInteger:return i.esriFieldTypeInteger;case r.essentialsFieldTypeSingle:return i.esriFieldTypeSingle;case r.essentialsFieldTypeSmallInteger:return i.esriFieldTypeSmallInteger;case r.essentialsFieldTypeString:default:return i.esriFieldTypeString}},e}();t.Field=n})},"geocortex/essentials/GeocodingEndpoint":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}();define(["require","exports","./../geocortex","./AsyncInitializable","./ServiceHelper"],function(t,i,r,n,s){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var a=function(t){function i(e){var i=t.call(this,e)||this;return i.bingProperties=null,i.displayName=null,i.extensions=[],i.id=null,i.properties={},i.geocoderType=null,i.geocoderUrl=null,i.geocoderToken=null,i.includeInGlobalSearch=!1,i.iconUri=null,i.featureZoomScale=null,i.isDefaultReverseGeocoder=!1,i.site=null,i.parameters=[],i.globalSearchKey=null,i.isDefaultBatchGeocoder=!1,i}return e(i,t),i.prototype._configureObject=function(e){if(!(e.hasOwnProperty("id")&&e.hasOwnProperty("displayName")&&e.hasOwnProperty("serviceType")&&e.hasOwnProperty("connectionString")&&e.hasOwnProperty("globalSearchKey")&&e.hasOwnProperty("parameters")))throw new Error("Incorrect geocoding endpoint object returned from initialization");this.id=e.id,this.displayName=e.displayName,this.iconUri=e.iconUri,this.featureZoomScale=e.featureZoomScale,this.geocoderType=e.serviceType,this.includeInGlobalSearch=e.includeInGlobalSearch,this.isDefaultReverseGeocoder=e.isDefaultReverseGeocoder,this.globalSearchKey=e.globalSearchKey,this.isDefaultBatchGeocoder=e.isDefaultBatchGeocoder,this._processConnectionString(e.connectionString),this.properties=r._getProperties(e.properties),this.extensions=r._getExtensions(e.extensions),this.parameters=e.parameters},i.prototype._processConnectionString=function(e){var t=s.ServiceHelper.extractConnectionStringValue;if(this.geocoderType===o.BING_GEOCODER){this.bingProperties={};var i=t(e,"key");i&&i.length>0&&(this.bingProperties.bingMapsKey=i),(i=t(e,"culture"))&&i.length>0&&(this.bingProperties.culture=i)}else if(this.geocoderType===o.ARCGIS_GEOCODER){var r=t(e,"url");r&&r.length>0&&(this.geocoderUrl=r),this.geocoderToken=t(e,"token")}else console.error("Unknown geocoder type '"+this.geocoderType+"'")},i}(n.AsyncInitializable);i.GeocodingEndpoint=a;var o;!function(e){e.ARCGIS_GEOCODER="ArcGisGeocoder",e.BING_GEOCODER="BingGeocoder"}(o=i.GeocodingEndpointType||(i.GeocodingEndpointType={}))})},"geocortex/essentials/GeometryEndpoint":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}();define(["require","exports","./AsyncInitializable","./../geocortex","./ServiceHelper"],function(t,i,r,n,s){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var a=function(t){function i(e){var i=t.call(this,e)||this;return i.displayName=null,i.extensions=[],i.id=null,i.properties={},i.geometryServiceType=null,i.geometryServiceUrl=null,i.geometryServiceToken=null,i.site=null,i}return e(i,t),i.prototype._configureObject=function(e){if(void 0===e.id||void 0===e.displayName||void 0===e.connectionString)throw new Error("Incorrect geometry endpoint object returned from initialization");this.id=e.id,this.displayName=e.displayName,this.geometryServiceType=e.serviceType,this._processConnectionString(e.connectionString),this.properties=n._getProperties(e.properties),this.extensions=n._getExtensions(e.extensions)},i.prototype._processConnectionString=function(e){var t=s.ServiceHelper.extractConnectionStringValue;if(this.geometryServiceType===o.ARCGIS_GEOMETRY){var i=t(e,"url");i&&i.length>0&&(this.geometryServiceUrl=i),this.geometryServiceToken=t(e,"token")}else console.error("Unknown geometry service type '"+this.geometryServiceType+"'")},i}(r.AsyncInitializable);i.GeometryEndpoint=a;var o;(o=i.GeometryEndpointType||(i.GeometryEndpointType={})).ARCGIS_GEOMETRY="ArcGisGeometry"})},"geocortex/essentials/GeometryUtilities":function(){define(["require","exports"],function(e,t){"use strict";function i(e,t,i){return null==e||null==t?i:!!(e.isWebMercator&&t.isWebMercator&&e.isWebMercator()&&t.isWebMercator())||e.wkid===t.wkid&&(e.wkid>0||e.wkt.toLowerCase()==t.wkt.toLowerCase())}function r(e){var t=e.rings[0][0],i=e.rings[0][1],r=null,n=e.rings[0].slice(2,e.rings[0].length);n.push(t);for(var s=0;s<n.length;++s){var a=n[s],o=this.crossProduct(a,t,i);if(o>0&&!0===r||o<0&&!1===r)return!1;r=o>0,t=i,i=a}return!0}function n(e,t,i){return i||(i=[0,0]),(e[0]-i[0])*(t[1]-i[1])-(e[1]-i[1])*(t[0]-i[0])}Object.defineProperty(t,"__esModule",{value:!0}),t.spatialRefsAreEqual=i,t.envelopesAreEqual=function(e,t){return null==e||null==t?null==e&&null==t:i(e.spatialReference,t.spatialReference)&&e.xmin==t.xmin&&e.ymin==t.ymin&&e.xmax==t.xmax&&e.ymax==t.ymax},t.getExtent=function(e){if(e.length)var t=new esri.geometry.Extent(Number.MAX_VALUE,Number.MAX_VALUE,Number.MIN_VALUE,Number.MIN_VALUE,e[0].spatialReference);for(var i=0;i<e.length;++i){var r=e[i].getExtent();t.xmin=Math.min(r.xmin,t.xmin),t.ymin=Math.min(r.ymin,t.ymin),t.xmax=Math.min(r.xmax,t.xmax),t.xmax=Math.min(r.ymax,t.ymax)}return t},t.envelopeToPolygon=function(e){var t=new esri.geometry.Polygon(e.spatialReference);return t.addRing([[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]),t},t.isValidGeometry=function(e){if("polygon"!=e.type)return!0;var t=e;if(0==t.rings.length||t.rings.length<3)return!0;if(r(t)){var i=t.rings[0][0],s=t.rings[0][1],a=t.rings[0].slice(2,t.rings[0].length);for(a.push(i),h=0;h<a.length;++h){var o=a[h];if(n(i,o,s)>0)return!0;i=s,s=o}return!1}for(var l=0,c=0;c<t.rings.length;++c)for(var u=t.rings[c],p=0,h=0;h<u.length;++h)p=(h+1)%u.length,l+=u[h][0]*-u[p][1],l-=-u[h][1]*u[p][0];return l>0},t.isSelfIntersectingPolygon=function(e){if(esri.geometry.polygonSelfIntersecting)return esri.geometry.polygonSelfIntersecting(e);if(e.isSelfIntersecting)return e.isSelfIntersecting(e);throw new Error("No self intersection method found")},t.isConvex=r,t.pointInEnvelope=function(e,t){if(!this.spatialRefsAreEqual(e.spatialReference,t.spatialReference,!0))throw new Error("Mismatched spatial references.");return!(e.x<t.xmin||e.x>t.xmax||e.y<t.ymin||e.y>t.ymax)},t.clipEnvelope=function(e,t){if(!this.spatialRefsAreEqual(e.spatialReference,t.spatialReference,!0))throw new Error("Mismatched spatial references.");var i=new esri.geometry.Extent(e.xmin,e.ymin,e.xmax,e.ymax,e.spatialReference),r=function(e,t,i){return e<t?t:e>i?i:e};return i.xmin=r(e.xmin,t.xmin,t.xmax),i.xmin=r(e.ymin,t.ymin,t.ymax),i.xmin=r(e.xmax,t.xmin,t.xmax),i.xmin=r(e.ymax,t.ymin,t.ymax),i},t.scaleEnvelope=function(e,t,i){return new esri.geometry.Extent(e.xmin*t,e.ymin*i,e.xmax*t,e.ymax*i,e.spatialReference)},t.scaleEnvelopeWithoutTranslation=function(e,t){if(null==e)return null;var i=e.getCenter();return new esri.geometry.Extent(i.x-e.getWidth()*(t/2),i.y-e.getHeight()*(t/2),i.x+e.getWidth()*(t/2),i.y+e.getHeight()*(t/2),e.spatialReference)},t.computeDistance=function(e,t){var i=t.x-e.x,r=t.y-e.y;return Math.sqrt(i*i+r*r)},t.translateEnvelope=function(e,t,i){return new esri.geometry.Extent(e.xmin+t,e.ymin+i,e.xmax+t,e.ymax+i,e.spatialReference)},t.length=function(e){return Math.sqrt(e.x*e.x+e.y*e.y)},t.normalize=function(e){var t=this.length(e);return new esri.geometry.Point(e.x/t,e.y/t)},t.angle=function(e,t){if(!this.spatialRefsAreEqual(e.spatialReference,t.spatialReference,!0))throw new Error("Mismatched spatial references");return Math.acos(this.dotProduct(e,t)/Math.sqrt(this.dotProduct(e,e)*this.dotProduct(t,t)))},t.crossProduct=function(e,t,i){if(!this.spatialRefsAreEqual(e.spatialReference,t.spatialReference,!0))throw new Error("Mismatched spatial references");return i||(i=new esri.geometry.Point(0,0)),(e.x-i.x)*(t.y-i.y)-(e.y-i.y)*(t.x-i.x)},t.crossProductArray=n,t.dotProduct=function(e,t){if(!this.spatialRefsAreEqual(e.spatialReference,t.spatialReference,!0))throw new Error("Mismatched spatial references");return e.x*t.x+e.y*t.y},t.polygonMidpoint=function(e){if(0==e.length)throw new Error("Expected at least one point in polygonMidPoint.");for(var t=0,i=0,r=0;r<e.length;++r){var n=e[r];t+=n.x,i+=n.y}return t/=e.length,i/=e.length,new esri.geometry.Point(t,i,e[0].spatialReference)}})},"geocortex/essentials/GeoprocessingEndpoint":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}();define(["require","exports","./AsyncInitializable","./../geocortex","./ServiceHelper"],function(t,i,r,n,s){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var a=function(t){function i(e){var i=t.call(this,e)||this;return i.displayName=null,i.extensions=[],i.id=null,i.properties={},i.geoprocessorType=null,i.geoprocessorUrl=null,i.site=null,i}return e(i,t),i.prototype._configureObject=function(e){if(void 0===e.id||void 0===e.displayName||void 0===e.connectionString)throw new Error("Incorrect geoprocessing endpoint object returned from initialization");this.id=e.id,this.displayName=e.displayName,this.geoprocessorType=e.geoprocessorType||e.serviceType,this._processConnectionString(e.connectionString),this.properties=n._getProperties(e.properties),this.extensions=n._getExtensions(e.extensions)},i.prototype._processConnectionString=function(e){var t=s.ServiceHelper.extractConnectionStringValue;if(this.geoprocessorType!==o.ARCGIS_GEOPROCESSOR)throw new Error("Unknown geoprocessor type '"+this.geoprocessorType+"'");var i=t(e,"url");i&&i.length>0&&(this.geoprocessorUrl=i)},i}(r.AsyncInitializable);i.GeoprocessingEndpoint=a;var o;(o=i.GeoprocessingEndpointType||(i.GeoprocessingEndpointType={})).ARCGIS_GEOPROCESSOR="ArcGisGeoprocessor"})},"geocortex/essentials/GeoRssLayerService":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}();define(["require","exports","./MapService","./RestHelper","./XmlUtils","./RestHelperHTTPService"],function(t,i,r,n,s,a){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var o=function(t){function i(e){var i=t.call(this,e)||this;return i._colorSet=!1,i._layerLoadCompleted=null,i.color=null,i.feedUrl=null,i.feedImageUri=null,i.updateInterval=null,i.pictureSymbol=null,i.markerSymbol=null,i.geoRssLayer=null,i.mapSpatialReference=null,i.geometryService=null,i}return e(i,t),i.prototype._configureObject=function(e,r){if(void 0===e)throw new Error("Incorrect map service object returned from initialization");i.webMercatorSref=new esri.SpatialReference({wkid:102100}),i.wgs84Sref=new esri.SpatialReference({wkid:4326}),this.feedImageUri=e.feedImageUri,this.updateInterval=e.updateInterval,this.geoRssLayer=new esri.layers.GraphicsLayer({opacity:e.opacity,id:e.id,visible:e.visible}),dojo.connect(this.geoRssLayer,"onError",this,this._layerLoadErrorHandler),e.color&&(this.color=e.color,this._colorSet=!0,this.color.length>3&&(this.color[3]=this.color[3]/255)),t.prototype._configureObject.call(this,e,r),this.attributionDataUrl&&""!==this.attributionDataUrl?(this.geoRssLayer.attributionDataUrl=this.attributionDataUrl,this.geoRssLayer.hasAttributionData=!0):this.hasAttributionData&&(this.geoRssLayer.attributionDataUrl=this.url+"/Attribution",this.geoRssLayer.hasAttributionData=!0)},i.prototype._createServiceLayer=function(){var e=this,t=null;if(this.essentialsMap&&(t=this.essentialsMap.site,this.mapSpatialReference=this.essentialsMap.initialExtent.spatialReference),this.feedImageUri?(this.feedImageUri=n.RestHelper.processClientSideTokens(t,this.feedImageUri),this.pictureSymbol=new esri.symbol.PictureMarkerSymbol(this.feedImageUri,25,25)):this.markerSymbol=new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE,15,new esri.symbol.SimpleLineSymbol,new esri.Color(this.color)),this.feedUrl=this.serviceUrl,this._loadFeed(),this.updateInterval&&!isNaN(this.updateInterval)){this._layerLoadCompleted=!1;var i=setInterval(function(){e._layerLoadCompleted&&e._loadFeed(),e._layerLoadCompleted=!1},1e3*this.updateInterval);dojo.connect(window,"onunload",function(){clearInterval(i)})}this.serviceLayer=this.geoRssLayer},i.prototype._loadFeed=function(){esri.config.defaults.io.proxyUrl&&esri.request({url:this.serviceUrl,content:{},handleAs:"xml",load:dojo.hitch(this,this._handleFeed),error:function(e){e&&e.message&&"string"==typeof e.message&&alert(e.message)}})},i.prototype._handleFeed=function(e){var t="http://www.georss.org/georss",i=this._getFeedRoot(e);if(i){var r=i.nodeName,n=s.getAttribute(i,"xml:base"),a=[],o=null;if("feed"===r?o=s.getNodes("feed","entry",e):"rdf"===r?o=s.getNodes("rdf","item",e):"rss"===r&&(o=s.getNodes("channel","item",e)),o){var l=this.pictureSymbol||this.markerSymbol;o.forEach(dojo.hitch(this,function(e,i,o){var c,u,p,h=null;if(s.getAllNodes(e).forEach(dojo.hitch(this,function(e,i,a){e.nodeName&&("title"===e.nodeName&&(c=e.firstChild.nodeValue),"feed"===r?"summary"===e.nodeName&&(p=e.firstChild.nodeValue):"description"===e.nodeName&&(p=e.firstChild.nodeValue),"link"===e.nodeName&&(u="feed"===r?(n||"")+s.getAttribute(e,"href"):(n||"")+e.firstChild.nodeValue),("georss:where"===e.nodeName||"where"===e.nodeName&&e.namespaceURI===t)&&(h=this._getGMLGRSSPoint(e)),("georss:point"===e.nodeName||"point"===e.nodeName&&e.namespaceURI===t)&&(h=this._getSimpleGRSSPoint(e)),("geo:lat"===e.nodeName||"lat"===e.nodeName&&"http://www.w3.org/2003/01/geo/wgs84_pos#"===e.namespaceURI)&&(h=this._getW3CGRSSPoint(e)))})),h){var d={title:c,content:p,link:u};a.push(new esri.Graphic(h,l,d,null))}})),this.mapSpatialReference&&this._projectShapes(a,this.mapSpatialReference)}}},i.prototype._projectShapes=function(e,t){if(e&&t){for(var r=!1,n=i.webMercatorSref.wkid,s=i.wgs84Sref.wkid,o=0;o<e.length;o++){var l=e[o],c=null;l.geometry&&l.geometry.spatialReference.wkid!==t.wkid&&(t.wkid===n&&l.geometry.spatialReference.wkid===s?c=esri.geometry.geographicToWebMercator(l.geometry):t.wkid===s&&l.geometry.spatialReference.wkid===n?c=esri.geometry.webMercatorToGeographic(l.geometry):(c=esri.geometry.geographicToWebMercator(l.geometry),r=!0),l.geometry=c)}if(r){var u=[],p=this.geometryServiceUrl||this._getDefaultGeometryServiceUrl(),h=this.geometryServiceUrl?null:this._getDefaultGeometryServiceToken();null!==h&&(p=a.RestHelperHTTPService.appendTokenToUrl(p,h)),this.geometryService=new esri.tasks.GeometryService(p),dojo.forEach(e,function(e){u.push(e.geometry)});var d=new esri.tasks.ProjectParameters;return d.geometries=u,d.outSR=t,void this.geometryService.project(d,dojo.hitch(this,function(t){for(var i=0;i<t.length;i++)e[i].geometry=t[i];this._publishLayer(e)}),this._projectionError)}}this._publishLayer(e)},i.prototype._publishLayer=function(e){if(this.geoRssLayer){this.geoRssLayer.clear(),dojo.forEach(e,dojo.hitch(this,function(e){this.geoRssLayer.add(e)})),this.geoRssLayer.redraw();var t={esriLayer:this.geoRssLayer};dojo.publish("geoRssLayerLoaded",[t]),this._layerLoadCompleted=!0}},i.prototype._projectionError=function(e){},i.prototype._getSimpleGRSSPoint=function(e){var t=e.firstChild.nodeValue.split(" ");return new esri.geometry.Point(parseFloat(t[1]),parseFloat(t[0]),i.wgs84Sref)},i.prototype._getGMLGRSSPoint=function(e){var t=this._getNonTextNodeChild(e),r=this._getNonTextNodeChild(t).firstChild.nodeValue.split(" ");return new esri.geometry.Point(parseFloat(r[1]),parseFloat(r[0]),i.wgs84Sref)},i.prototype._getNonTextNodeChild=function(e){for(var t=e.childNodes,i=0;i<t.length;i++)if(3!==t[i].nodeType)return t[i]},i.prototype._getW3CGRSSPoint=function(e){if(!e.nextSibling)return null;var t=e.nextSibling;"#text"===e.nextSibling.nodeName&&(t=e.nextSibling.nextSibling);var r=e.firstChild.nodeValue,n=t.firstChild.nodeValue;return new esri.geometry.Point(parseFloat(n),parseFloat(r),i.wgs84Sref)},i.prototype._getFeedRoot=function(e){if(!e)throw new Error("The GeoRSS service at "+this.feedUrl+" returned an invalid response.");for(var t=e.childNodes,i=0;i<t.length;i++)if(t[i]&&"xml"!==t[i].nodeName.substring(0,3))return t[i];return null},i}(r.MapService);o.webMercatorSref=null,o.wgs84Sref=null,i.GeoRssLayerService=o})},"geocortex/essentials/KmlService":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}();define(["require","exports","./MapService"],function(t,i,r){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=function(t){function i(){var e=null!==t&&t.apply(this,arguments)||this;return e.updateInterval=null,e.serviceLayer=null,e.mapSpatialReference=null,e}return e(i,t),i.prototype._configureObject=function(e,i){if(void 0===e)throw new Error("Incorrect map service object returned from initialization");this.updateInterval=e.updateInterval,t.prototype._configureObject.call(this,e,i)},i.prototype._createServiceLayer=function(){var e=this;this.essentialsMap&&(this.essentialsMap.site,this.mapSpatialReference=this.essentialsMap.initialExtent.spatialReference);var t={id:this.id,outSR:this.mapSpatialReference};this.serviceLayer=new esri.layers.KMLLayer(this.serviceUrl,t),this._initiallyVisible?this.serviceLayer.show():this.serviceLayer.hide(),this.serviceLayer._options=t,this.attributionDataUrl&&""!==this.attributionDataUrl?(this.serviceLayer.attributionDataUrl=this.attributionDataUrl,this.serviceLayer.hasAttributionData=!0):this.hasAttributionData&&(this.serviceLayer.attributionDataUrl=this.url+"/Attribution",this.serviceLayer.hasAttributionData=!0);var i=this.serviceLayer.on("load",function(t){i.remove(),e.serviceLayer.setOpacity(e.configuredOpacity),e._initializeKmlLayers()});this.serviceLayer.on("error",function(t){return e._layerLoadErrorHandler(t)}),this.serviceLayer.setOpacity(this.configuredOpacity),this.updateInterval&&!isNaN(this.updateInterval)&&this.serviceLayer.setRefreshInterval(this.updateInterval)},i.prototype._updateStartHandler=function(){this._initializeKmlLayers()},i.prototype._initializeKmlLayers=function(){for(var e=this.serviceLayer.getLayers(),t=0;t<e.length;t++)if(e[t]instanceof esri.layers.FeatureLayer){var i=e[t];i.layerId=+this.id,i.name=this.displayName,i.displayField="name",e[t].spatialReference=this.mapSpatialReference}},i}(r.MapService);i.KmlService=n})},"geocortex/essentials/Layer":function(){var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}();define(["require","exports","./AsyncInitializable","./LayerChart","./DataLink","./Field","./FeatureHyperlink","./LayerHyperlink","./Report","./LayerStyle","./LayerQuery","./LayerType","./RefreshVisibility","./LayerThemeSetting","./TimeInfo","./../geocortex","./RestHelperHTTPService","./MapServiceConstants","./utilities/SiteResourceIdComparer","./RestHelper","geocortex/framework/utils/utils"],function(require,exports,AsyncInitializable_1,LayerChart_1,DataLink_1,Field_1,FeatureHyperlink_1,LayerHyperlink_1,Report_1,LayerStyle_1,LayerQuery_1,LayerType_1,RefreshVisibility_1,LayerThemeSetting_1,TimeInfo_1,geocortex_1,RestHelperHTTPService_1,MapServiceConstants_1,SiteResourceIdComparer_1,RestHelper_1,utils_1){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Layer=function(_super){function Layer(e){var t=_super.call(this,e)||this;return t.allowSymbolization=!1,t.canToggleLabels=!1,t.charts=[],t.configuredVisible=!1,t.dataLinks=[],t.dataProvider=null,t.defaultVisibility=!1,t.displayField=null,t.displayName=null,t.defaultDateFormat=null,t.defaultNumberFormat=null,t.description=null,t.drawIndex=null,t.dynamicDefinition=null,t.extensions=[],t.featureBorderColor=null,t.featureBorderWidth=null,t.featureDescription=null,t.featureFillColor=null,t.featureHyperlinks=[],t.featureLabel=null,t.featureLongDescription=null,t.featureType="None",t.featureZoomFactor=null,t.featureZoomScale=null,t.fields=[],t.fullExtent=null,t.hasAttachments=!1,t.hasDataLinks=!1,t.hasReports=!1,t.iconUri=null,t.id=null,t.identifiable=!1,t.identifiableAtAllScales=!1,t.includeInLayerList=!0,t.includeInLegend=!0,t.isDynamic=!1,t.isExpanded=!1,t.isUserCreated=!1,t.userLayerType=null,t.catalogId=null,t.layerHyperlinks=[],t.legendUrl=null,t.mapService=null,t.maxScale=0,t.minScale=0,t.name=null,t.parentLayerId=null,t.primaryKeyField=null,t.properties={},t.queryable=!1,t.queries=[],t.relationships=[],t.reports=[],t.searchable=!1,t.showFeatureHyperlinks="ShowAll",t.showLabels=!0,t.showMapTips=!1,t.snappable=!1,t.snappingEnabled=!1,t.supportsIdentify=!1,t.supportsQuery=!1,t.styleName=null,t.styles=[],t.subLayerIds=[],t.timeZoneId=null,t.type=LayerType_1.LayerType.UNKNOWN,t.visibleStateForRefresh=RefreshVisibility_1.RefreshVisibility.DEFAULT,t.wmsLayerName=null,t.wfsLayerName=null,t.inActiveTheme=!0,t.layerThemeSettings=[],t._visible=!1,t._featureLayerPromise=null,t._timeInfo=null,t._gcxTimeInfo=null,t.setInActiveTheme(!0),t}return __extends(Layer,_super),Layer.prototype.getFeatureLayer=function(){var e=this;if(!this._featureLayerPromise)if(this.mapService.serviceUrl&&this.mapService.serviceUrl.endsWith("/MapServer"))this._featureLayerPromise=new Promise(function(t,i){e.mapService._getLayersInfo(e.id).then(function(r){var n=null;if(r){if(r.layers&&r.layers.forEach(function(t){e.id!==t.id.toString()||(n=new esri.layers.FeatureLayer({layerDefinition:t}))}),!n&&r.tables&&r.tables.forEach(function(t){e.id!==t.id.toString()||(n=new esri.layers.FeatureLayer({layerDefinition:t}))}),n)return void t(n);if(e.isDynamic)if(e.mapService&&e.mapService.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer){var s=e.mapService.serviceLayer;if(s.dynamicLayerInfos){var a=null;for(var o in s.dynamicLayerInfos)if(s.dynamicLayerInfos.hasOwnProperty(o)&&s.dynamicLayerInfos[o].id==parseInt(e.id,10)){a=s.dynamicLayerInfos[o].source;break}if(a){var l=e.mapService.serviceUrl+"/dynamicLayer";e.mapService.serviceToken&&(l=RestHelperHTTPService_1.RestHelperHTTPService.appendTokenToUrl(l,e.mapService.serviceToken));var c=(n=new esri.layers.FeatureLayer(l,{source:a})).on("load",function(e){c.remove(),u.remove(),t(n)}),u=n.on("error",function(e){c.remove(),u.remove();var t=e.error&&e.error.message?e.error.message:"Could not determine underlying error.";i(new Error("Could not create a Feature Layer from the given dynamic layer source. Reason: {0}".format(t)))})}else i(new Error("Could not find LayerSource for the given dynamic layer."))}else i(new Error("No dynamicLayerInfos on the service layer."))}else i(new Error("The service layer is not an instance of esri.layers.ArcGISDynamicMapServiceLayer."));else i(new Error("The Essentials layer is not a dynamic layer."))}else i(new Error("The Essentials map service did not return information related to the service's layers."))}).catch(function(e){return i(e)})});else{var t;if(this.mapService.serviceLayer instanceof esri.layers.FeatureLayer)t=this.mapService.serviceLayer;else{var i=this.getLayerUrl();if(!i)return this._featureLayerPromise=Promise.reject(new Error("Cound not get layerUrl for creating feature layer")),this._featureLayerPromise;t=new esri.layers.FeatureLayer(i)}t.loaded?this._featureLayerPromise=Promise.resolve(t):this._featureLayerPromise=new Promise(function(i,r){var n=t.on("load",function(){if(n.remove(),s.remove(),e.wmsLayerName||e.wfsLayerName)for(var r=e.fields,a=t.fields.length-1;a>=0;a--){var o=t.fields[a];"gml:id"===o.name&&t.fields.splice(a,1),o.type=Field_1.Field.convertToEsriFieldType(r[a].dataType)}i(t)}),s=t.on("error",function(e){n.remove(),s.remove(),r(e)})})}return this._featureLayerPromise},Layer.prototype.getRelatedFeatureLayer=function(e,t,i){var r=new dojo.Deferred,n=function(e){geocortex_1.deferredResolve(r,e),"function"==typeof t&&t(e)},s=this._getRelation(e),a=this.getLayerUrl();if(!s||!a){var o=new Error("getRelatedFeatureLayer - Relation not found for: "+e+" or layerUrl is null");return r&&-1===r.fired&&r.resolve(o),"function"==typeof i&&i(o),r}var l=a.substring(0,a.lastIndexOf("/")+1)+s.relatedTableId;this.mapService&&this.mapService.serviceToken&&(l=RestHelperHTTPService_1.RestHelperHTTPService.appendTokenToUrl(l,this.mapService.serviceToken)),void 0===esri.getProxyRule(l)&&null!==this.mapService.proxyUrl&&esri.addProxyRule({urlPrefix:l,proxyUrl:this.mapService.proxyUrl});var c=new esri.layers.FeatureLayer(l,{mode:esri.layers.FeatureLayer.MODE_SELECTION,outFields:["*"]});return c.loaded?n(c):dojo.connect(c,"onLoad",dojo.hitch(this,n)),dojo.connect(c,"onError",dojo.hitch(this,function(e){r&&-1===r.fired&&r.resolve(e),"function"==typeof i&&i(e)})),r},Layer.prototype.areAllAncestorsVisible=function(){for(var e=this.mapService.findLayerById(this.parentLayerId);null!==e&&void 0!==e;){if(!e.isVisible())return!1;e=this.mapService.findLayerById(e.parentLayerId)}return!0},Layer.prototype.getLayerUrl=function(){if(this.mapService&&this.mapService.serviceUrl){if("FeatureLayer"===this.mapService.drawingBehavior)return this.mapService.serviceUrl;if(this.mapService.mapServiceType===MapServiceConstants_1.MapServiceType.WMS||this.mapService.mapServiceType===MapServiceConstants_1.MapServiceType.WFS){if(this.mapService.userLayerType===MapServiceConstants_1.UserLayerType.LAYER_ADDITION)return null;var e=this.mapService.url+"/layers/"+this.id,t=RestHelperHTTPService_1.RestHelperHTTPService.getTokenForScope(this.mapService.url);return t&&(e=RestHelperHTTPService_1.RestHelperHTTPService.appendTokenToUrl(e,t)),e}return this.mapService.serviceUrl+"/"+this.id}return null},Layer.prototype.getFieldByName=function(e){if(this.fields&&this.fields.length>0){if(!this._fieldLookup){this._fieldLookup={};for(var t=0,i=this.fields;t<i.length;t++){var r=i[t];this._fieldLookup[r.name]=r}}return this._fieldLookup[e]}return null},Layer.prototype.isVisible=function(){return this._visible},Layer.prototype.setVisibility=function(e,t){if(this.mapService){switch(this.mapService.mapServiceType){case MapServiceConstants_1.MapServiceType.DYNAMIC:case MapServiceConstants_1.MapServiceType.FEATURE:case MapServiceConstants_1.MapServiceType.WMS:case MapServiceConstants_1.MapServiceType.WFS:case MapServiceConstants_1.MapServiceType.WMTS:case MapServiceConstants_1.MapServiceType.GEORSS:case MapServiceConstants_1.MapServiceType.KML:case MapServiceConstants_1.MapServiceType.TILED:case MapServiceConstants_1.MapServiceType.STREAM:this._visible=e;break;default:this._visible=!0}this.mapService._setVisibility(this.id,this._visible,t)}},Layer.prototype.setInActiveTheme=function(e){this.inActiveTheme=e,dojo.publish("LayerInActiveThemeChangedEvent",this)},Layer.prototype.findReportById=function(e){return SiteResourceIdComparer_1.SiteResourceIdComparer.lookUp(this.reports,e)},Layer.prototype.withinScaleRange=function(e){return!!(0===this.maxScale&&this.minScale===1/0||isNaN(this.maxScale)&&isNaN(this.minScale))||(null==e&&(e=this.mapService.essentialsMap.calculateScale()),this.maxScale<e&&e<this.minScale)},Layer.prototype._configureDataLinks=function(e,t,i){for(var r=0;e&&r<e.length;r++){var n=this.dataLinks[r]=new DataLink_1.DataLink(this.url+"/datalinks/"+e[r].id);n.layer=this,n._configureObject(e[r],t)}},Layer.prototype._getUniqueId=function(){if(this.mapService){var e=[];if(dojo.forEach(this.mapService.layers,function(t){e.push(t.id)}),e.length>0){var t=Math.max.apply(null,e);return(++t).toString()}}return"0"},Layer.prototype.createFromDefinition=function(e){this._createFrom(e)},Layer.prototype._createFrom=function(e){if(this.defaultVisibility=e.defaultVisibility,this.configuredVisible=e.visible,this.displayName=e.displayName||e.name,this.description=e.description,this.featureDescription=e.featureDescription,e.hasOwnProperty("featureLongDescription")?this.featureLongDescription=e.featureLongDescription:this.featureLongDescription=e.featureDescription,this.featureLabel=e.featureLabel,this.featureType=e.featureType,this.featureZoomScale=e.featureZoomScale,this.featureZoomFactor=e.featureZoomFactor,this.hasDataLinks=e.hasDataLinks,this.hasReports=e.hasReports,this.hasAttachments=e.hasAttachments,e.hasOwnProperty("id")?this.id=e.id:this.id=this._getUniqueId(),this.name=e.name,this._populateOgcID(e.nativeID),this.parentLayerId=e.parentLayerId,this.subLayerIds=e.subLayerIds,this._visible=e.visible,this.styleName=e.styleName,this.legendUrl=e.legendUrl,this.isUserCreated=utils_1.isNullOrUndefined(e.isUserCreated)?this.isUserCreated:e.isUserCreated,this.userLayerType=utils_1.isNullOrUndefined(e.userLayerType)?this.userLayerType:e.userLayerType,this.isDynamic=e.isDynamic,this.dynamicDefinition=e.dynamicDefinition,this.dataProvider=e.dataProvider,this.defaultDateFormat=e.defaultDateFormat,this.defaultNumberFormat=e.defaultNumberFormat,this.timeZoneId=e.timeZoneId,e.fullExtent&&(this.fullExtent=new esri.geometry.Extent(e.fullExtent)),e.hasOwnProperty("drawIndex")&&(this.drawIndex=e.drawIndex),e.hasOwnProperty("identifiable")&&(this.identifiable=e.identifiable),e.hasOwnProperty("includeInLayerList")&&(this.includeInLayerList=e.includeInLayerList),e.hasOwnProperty("includeInLegend")&&(this.includeInLegend=e.includeInLegend),e.hasOwnProperty("featureBorderColor")&&(this.featureBorderColor=e.featureBorderColor,this.featureBorderColor&&this.featureBorderColor.length>=4&&this.featureBorderColor[3]>=1&&(this.featureBorderColor[3]/=255)),e.hasOwnProperty("featureBorderWidth")&&(this.featureBorderWidth=e.featureBorderWidth),e.hasOwnProperty("featureFillColor")&&(this.featureFillColor=e.featureFillColor,this.featureFillColor&&this.featureFillColor.length>=4&&this.featureFillColor[3]>=1&&(this.featureFillColor[3]/=255)),e.hasOwnProperty("minScale")&&!isNaN(e.minScale)&&0!==e.minScale?this.minScale=e.minScale:this.minScale=1/0,e.hasOwnProperty("maxScale")&&!isNaN(e.maxScale)?this.maxScale=e.maxScale:this.maxScale=0,this.mapService&&null!=this.mapService.minScale&&!isNaN(this.mapService.minScale)&&(this.minScale=Math.min(this.minScale,this.mapService.minScale)),this.mapService&&null!=this.mapService.maxScale&&!isNaN(this.mapService.maxScale)&&(this.maxScale=Math.max(this.maxScale,this.mapService.maxScale)),e.hasOwnProperty("queryable")&&(this.queryable=e.queryable),e.hasOwnProperty("searchable")&&(this.searchable=e.searchable),e.hasOwnProperty("snappable")&&(this.snappable=e.snappable),e.hasOwnProperty("snappingEnabled")&&(this.snappingEnabled=e.snappingEnabled),e.hasOwnProperty("showFeatureHyperlinks")&&(this.showFeatureHyperlinks=e.showFeatureHyperlinks),e.hasOwnProperty("canToggleLabels")&&(this.canToggleLabels=e.canToggleLabels),e.hasOwnProperty("showLabels")&&(this.showLabels=e.showLabels),e.hasOwnProperty("showMapTips")&&(this.showMapTips=e.showMapTips),e.hasOwnProperty("supportsIdentify")&&(this.supportsIdentify=e.supportsIdentify),e.hasOwnProperty("supportsQuery")&&(this.supportsQuery=e.supportsQuery),e.hasOwnProperty("layerHyperlinks"))for(t=0;t<e.layerHyperlinks.length;t++)this.layerHyperlinks[t]=new LayerHyperlink_1.LayerHyperlink(e.layerHyperlinks[t],this);if(void 0!==e.type&&(this.type=this._layerTypeStringToEssentialsLayerType(e.type)),e.fields)for(var t=0;t<e.fields.length;t++){var i=e.fields[t],r={layer:this,dataType:Field_1.Field.convertFromEsriType(i.type||i.dataType),alias:i.alias,displayName:i.displayName||i.alias||i.name,name:i.name,searchable:!0,visible:!0,focusField:!1,hyperlinkLabel:null,format:i.format};i.hasOwnProperty("searchable")&&(r.searchable=i.searchable),i.hasOwnProperty("visible")&&(r.visible=i.visible),this.fields[t]=new Field_1.Field(r)}this.primaryKeyField=this.getFieldByName(e.primaryKeyField),this.displayField=this.getFieldByName(e.displayField),e.properties&&(this.properties=geocortex_1._getProperties(e.properties),this.catalogId=this.properties.layerCatalogLookupId),e.extensions&&(this.extensions=geocortex_1._getExtensions(e.extensions)),this.isInitialized=!0},Layer.prototype._configureObject=function(results,deepInitialize){if(void 0===results||void 0===results.name||void 0===results.id)throw new Error("Incorrect layer object returned from initialization");this.allowSymbolization=results.allowSymbolization,this.defaultVisibility=results.defaultVisibility,this.configuredVisible=results.visible,this.displayName=results.displayName,this.description=results.description,this.featureDescription=results.featureDescription,results.hasOwnProperty("featureLongDescription")?this.featureLongDescription=results.featureLongDescription:this.featureLongDescription=results.featureDescription,this.featureLabel=results.featureLabel,this.featureType=void 0===results.featureType?this.featureType:results.featureType,this.featureZoomScale=void 0===results.featureZoomScale?this.featureZoomScale:results.featureZoomScale,this.featureZoomFactor=void 0===results.featureZoomFactor?this.featureZoomFactor:results.featureZoomFactor,this.hasDataLinks=utils_1.isNullOrUndefined(results.hasDataLinks)?this.hasDataLinks:results.hasDataLinks,this.hasReports=utils_1.isNullOrUndefined(results.hasReports)?this.hasReports:results.hasReports,this.hasAttachments=results.hasAttachments,this.id=results.id,this.name=results.name,this._populateOgcID(results.nativeID),this.parentLayerId=results.parentLayerId,this.subLayerIds=results.subLayerIds,this.styleName=results.styleName,this.legendUrl=results.legendUrl,this.catalogId=utils_1.isNullOrUndefined(results.catalogId)?this.catalogId:results.catalogId,this.isUserCreated=utils_1.isNullOrUndefined(results.isUserCreated)?this.isUserCreated:results.isUserCreated,this.userLayerType=utils_1.isNullOrUndefined(results.userLayerType)?this.userLayerType:results.userLayerType,this.isDynamic=void 0===results.isDynamic?this.isDynamic:results.isDynamic,this.dynamicDefinition=results.dynamicDefinition,this.dataProvider=results.dataProvider,this.defaultDateFormat=results.defaultDateFormat,this.defaultNumberFormat=results.defaultNumberFormat,this.timeZoneId=results.timeZoneId,this._timeInfo=results.timeInfo?results.timeInfo:null,this.queries=[],results.fullExtent&&(this.fullExtent=new esri.geometry.Extent(results.fullExtent));var site=null;if(this.mapService&&this.mapService.essentialsMap&&(site=this.mapService.essentialsMap.site),this.iconUri=RestHelper_1.RestHelper.processClientSideTokens(site,results.iconUri),results.hasOwnProperty("includeInLayerList")&&(this.includeInLayerList=results.includeInLayerList),this.isUserCreated)this._visible=void 0===results.initiallyVisible?!!results.visible:!!results.initiallyVisible;else if(null!=this.mapService.essentialsMap.layerThemesInfo.startupThemeId&&this.includeInLayerList?this._visible=!1:this._visible=void 0===results.initiallyVisible?!!results.visible:!!results.initiallyVisible,results.themeSettings&&results.themeSettings.length)for(var _i=0,_a=results.themeSettings;_i<_a.length;_i++){var themeSetting=_a[_i],layerTheme=this.mapService.essentialsMap.layerThemesInfo.getTheme(themeSetting.themeID);if(layerTheme){var isVisible=utils_1.isNullOrUndefined(themeSetting.visible)?this.configuredVisible:themeSetting.visible;this.layerThemeSettings.push(new LayerThemeSetting_1.LayerThemeSetting(layerTheme,isVisible)),layerTheme.id===this.mapService.essentialsMap.layerThemesInfo.startupThemeId&&this.includeInLayerList&&(this._visible=void 0===themeSetting.initiallyVisible?isVisible:themeSetting.initiallyVisible)}}results.hasOwnProperty("drawIndex")&&(this.drawIndex=results.drawIndex),results.hasOwnProperty("featureBorderColor")&&(this.featureBorderColor=results.featureBorderColor,this.featureBorderColor&&this.featureBorderColor.length>=4&&this.featureBorderColor[3]>=1&&(this.featureBorderColor[3]/=255)),results.hasOwnProperty("featureBorderWidth")&&(this.featureBorderWidth=results.featureBorderWidth),results.hasOwnProperty("featureFillColor")&&(this.featureFillColor=results.featureFillColor,this.featureFillColor&&this.featureFillColor.length>=4&&this.featureFillColor[3]>=1&&(this.featureFillColor[3]/=255)),results.hasOwnProperty("identifiable")&&(this.identifiable=results.identifiable),results.hasOwnProperty("includeInLegend")&&(this.includeInLegend=results.includeInLegend),results.hasOwnProperty("minScale")&&!isNaN(results.minScale)&&0!==results.minScale?this.minScale=results.minScale:this.minScale=1/0,results.hasOwnProperty("maxScale")&&!isNaN(results.maxScale)?this.maxScale=results.maxScale:this.maxScale=0,this.mapService&&null!=this.mapService.minScale&&!isNaN(this.mapService.minScale)&&(this.minScale=Math.min(this.minScale,this.mapService.minScale)),this.mapService&&null!=this.mapService.maxScale&&!isNaN(this.mapService.maxScale)&&(this.maxScale=Math.max(this.maxScale,this.mapService.maxScale)),results.hasOwnProperty("queryable")&&(this.queryable=results.queryable),results.hasOwnProperty("searchable")&&(this.searchable=results.searchable),results.hasOwnProperty("showFeatureHyperlinks")&&(this.showFeatureHyperlinks=results.showFeatureHyperlinks),results.hasOwnProperty("canToggleLabels")&&(this.canToggleLabels=results.canToggleLabels),results.hasOwnProperty("showLabels")&&(this.showLabels=results.showLabels),results.hasOwnProperty("showMapTips")&&(this.showMapTips=results.showMapTips),results.hasOwnProperty("snappable")&&(this.snappable=results.snappable),results.hasOwnProperty("snappingEnabled")&&(this.snappingEnabled=results.snappingEnabled),results.hasOwnProperty("supportsIdentify")&&(this.supportsIdentify=results.supportsIdentify),results.hasOwnProperty("supportsQuery")&&(this.supportsQuery=results.supportsQuery),void 0!==results.type&&(this.type=this._layerTypeStringToEssentialsLayerType(results.type)),this.type===LayerType_1.LayerType.GROUP_LAYER&&results.hasOwnProperty("isExpanded")&&(this.isExpanded=results.isExpanded);var i;if(results.featureHyperlinks)for(i=0;i<results.featureHyperlinks.length;i++)this.featureHyperlinks[i]=new FeatureHyperlink_1.FeatureHyperlink(results.featureHyperlinks[i],this);if(results.fields)for(i=0;i<results.fields.length;i++)results.fields[i].layer=this,this.fields[i]=new Field_1.Field(results.fields[i]);if(results.relationships)for(i=0;i<results.relationships.length;i++)results.relationships[i].displayName&&(results.relationships[i].name=results.relationships[i].displayName),results.relationships[i].id=parseInt(results.relationships[i].id,10),results.relationships[i].relatedTableId=parseInt(results.relationships[i].relatedTableId,10),this.relationships.push(results.relationships[i]);if(results.hasOwnProperty("layerHyperlinks"))for(i=0;i<results.layerHyperlinks.length;i++)this.layerHyperlinks[i]=new LayerHyperlink_1.LayerHyperlink(results.layerHyperlinks[i],this);if(results.hasOwnProperty("charts")&&dojo.isObject(eval("geocortex.charting.configuration.ChartDefinition")))for(i=0;i<results.charts.length;i++)this.charts.push(new LayerChart_1.LayerChart(results.charts[i],this));if(results.styles&&results.styles.length)for(i=0;i<results.styles.length;i++){var style=results.styles[i],rendererJson=style.definition;rendererJson&&this.styles.push(new LayerStyle_1.LayerStyle(rendererJson,style.displayName,style.id))}if(results.queries&&results.queries.length)for(i=0;i<results.queries.length;i++)this.queries.push(new LayerQuery_1.LayerQuery(results.queries[i]));this.primaryKeyField=this.getFieldByName(results.primaryKeyField),this.displayField=this.getFieldByName(results.displayField),this._configureDataLinks(results.dataLinks,deepInitialize,site),this._configureReports(results.reports,deepInitialize),deepInitialize&&(this.isInitialized=!0),this.properties=geocortex_1._getProperties(results.properties),this.extensions=geocortex_1._getExtensions(results.extensions)},Layer.prototype.toJson=function(){return{id:this.id,name:this.name,url:this.url,defaultVisibility:this.defaultVisibility,visible:this.configuredVisible,displayName:this.displayName,description:this.description,featureDescription:this.featureDescription,featureLongDescription:this.featureLongDescription,featureLabel:this.featureLabel,featureType:this.featureType,featureZoomScale:this.featureZoomScale,featureZoomFactor:this.featureZoomFactor,hasDataLinks:this.hasDataLinks,hasReports:this.hasReports,hasAttachments:this.hasAttachments,nativeID:this.wmsLayerName||this.wfsLayerName,parentLayerId:this.parentLayerId,subLayerIds:(this.subLayerIds||[]).slice(),styleName:this.styleName,legendUrl:this.legendUrl,isDynamic:this.isDynamic,dynamicDefinition:this.dynamicDefinition,dataProvider:this.dataProvider,defaultDateFormat:this.defaultDateFormat,defaultNumberFormat:this.defaultNumberFormat,timeZoneId:this.timeZoneId,fullExtent:this.fullExtent?this.fullExtent.toJson():void 0,drawIndex:this.drawIndex,identifiable:this.identifiable,isExpanded:this.isExpanded,includeInLayerList:this.includeInLayerList,includeInLegend:this.includeInLegend,featureBorderColor:this.featureBorderColor,featureBorderWidth:this.featureBorderWidth,featureFillColor:this.featureFillColor,minScale:this.minScale===1/0?0:this.minScale,maxScale:this.maxScale,queryable:this.queryable,searchable:this.searchable,snappable:this.snappable,snappingEnabled:this.snappingEnabled,showFeatureHyperlinks:this.showFeatureHyperlinks,canToggleLabels:this.canToggleLabels,showLabels:this.showLabels,showMapTips:this.showMapTips,supportsIdentify:this.supportsIdentify,supportsQuery:this.supportsQuery,layerHyperlinks:this.layerHyperlinks.map(function(e){return e.toJson()}),type:this._essentialsLayerTypeToLayerTypeString(this.type),fields:this.fields.map(function(e){return e.toJson()}),primaryKeyField:this.primaryKeyField?this.primaryKeyField.name:void 0,displayField:this.displayField?this.displayField.name:void 0,catalogId:this.catalogId?this.catalogId:void 0,isUserCreated:this.isUserCreated,userLayerType:this.userLayerType,properties:geocortex_1._propertiesToJson(this.properties),extensions:geocortex_1._extensionsToJson(this.extensions)}},Layer.prototype._configureReports=function(e,t){for(var i=0;e&&i<e.length;i++)this.reports[i]=new Report_1.Report(this.url+"/reports/"+e[i].id),this.reports[i].layer=this,this.mapService&&this.mapService.essentialsMap&&this.mapService.essentialsMap.site&&(this.reports[i].site=this.mapService.essentialsMap.site),this.reports[i]._configureObject(e[i],t)},Layer.prototype.getLayerTimeInfo=function(){var e=this;if(!this.mapService||!this.mapService.isTimeAware)return null;if(this._gcxTimeInfo)return this._gcxTimeInfo;var t=function(t){if(t)return e._timeInfo=t,e._gcxTimeInfo=TimeInfo_1.getGcxTimeInfo(e._timeInfo),e._gcxTimeInfo};this._timeInfo?t(this._timeInfo):function(){if(e.mapService.serviceLayer&&e.mapService.serviceLayer.url){var i=e.mapService.serviceLayer.url+"/"+e.id;geocortex_1.request({url:i,content:{f:"json"},load:function(e){return t(e.timeInfo)},error:function(e){console.log((e.message,e.message))},callbackParamName:"CallBack"})}}()},Layer.prototype.getObjectIdFieldName=function(){var e=null;return this.primaryKeyField&&(e=this.primaryKeyField.name),e},Layer.prototype._layerTypeStringToEssentialsLayerType=function(e){return"FeatureLayer"===e||"DynamicFeatureLayer"===e?LayerType_1.LayerType.FEATURE_LAYER:"GroupLayer"===e||"AnnotationLayer"===e?LayerType_1.LayerType.GROUP_LAYER:"RasterLayer"===e?LayerType_1.LayerType.RASTER_LAYER:"GeoRssLayer"===e?LayerType_1.LayerType.GEO_RSS_LAYER:"TableLayer"===e?LayerType_1.LayerType.TABLE_LAYER:LayerType_1.LayerType.UNKNOWN},Layer.prototype._essentialsLayerTypeToLayerTypeString=function(e){switch(e){case LayerType_1.LayerType.FEATURE_LAYER:return"FeatureLayer";case LayerType_1.LayerType.GROUP_LAYER:return"GroupLayer";case LayerType_1.LayerType.RASTER_LAYER:return"RasterLayer";case LayerType_1.LayerType.GEO_RSS_LAYER:return"GeoRssLayer";default:return"Unknown"}},Layer.prototype._getRelation=function(e){"string"==typeof e&&(e=parseInt(e,10));for(var t=0,i=this.relationships;t<i.length;t++){var r=i[t];if(r.id==e)return r}return null},Layer.prototype.getDefinitionExpression=function(e){var t=null,i=parseInt(this.id,10);if(e)if(e instanceof esri.layers.ArcGISDynamicMapServiceLayer){var r=e.layerDefinitions;r&&r[i]&&(t=r[i])}else if(e instanceof esri.layers.FeatureLayer){var n=e.getDefinitionExpression();n&&(t=n)}return t||this.dynamicDefinition&&(t=RestHelper_1.RestHelper.getDynamicExpressionFromJson(this.dynamicDefinition)),t},Layer.prototype._createDynamicLayerInfo=function(){var e=null;return this.isDynamic&&(e=RestHelper_1.RestHelper.getDynamicLayerInfoFromJson(this.dynamicDefinition,this.id),this.minScale<1/0&&(e.minScale=this.minScale),this.maxScale>0&&(e.maxScale=this.maxScale)),e},Layer.prototype.getLayerDrawingOptions=function(){var e=null;return this.isDynamic&&(e=RestHelper_1.RestHelper.getLayerDrawingOptionsFromJson(this.dynamicDefinition)),e},Layer.prototype.getLayerThemeSettings=function(e){for(var t=0,i=this.layerThemeSettings;t<i.length;t++){var r=i[t];if(r.theme===e||r.theme.id===e)return r}return null},Layer.prototype._syncProgramaticallyChangedLayerVisibility=function(e){this._visible=e},Layer.prototype._populateOgcID=function(e){if(!utils_1.isNullOrUndefined(e)&&this.mapService)switch(this.mapService.mapServiceType){case MapServiceConstants_1.MapServiceType.WMTS:case MapServiceConstants_1.MapServiceType.WMS:this.wmsLayerName=e;break;case MapServiceConstants_1.MapServiceType.WFS:this.wfsLayerName=e}},Layer}(AsyncInitializable_1.AsyncInitializable);exports.Layer=Layer})},"geocortex/essentials/LayerCatalog":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){return function(e){this.siteId=e}}();t.LayerCatalog=i})},"geocortex/essentials/LayerChart":function(){define(["require","exports","geocortex/charting/infrastructure/Enums","geocortex/charting/infrastructure/configuration/ChartDefinition"],function(require,exports,Enums_1,ChartDefinition_1){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var LayerChart=function(){function LayerChart(restLayerChart,layer){this.layer=null,dojo.isObject(eval("geocortex.charting.configuration.ChartDefinition"))&&(restLayerChart&&(this.id=restLayerChart.id,this.displayName=restLayerChart.displayName,this.defaultChart=restLayerChart.defaultChart,this.chartFeatureType=restLayerChart.chartFeatureType,this.chartDefinition=new ChartDefinition_1.ChartDefinition(restLayerChart.chartDefinition),this.chartDefinition.id=this.id,this.chartDefinition.displayName=this.displayName),layer&&(this.layer=layer,this._setFieldDisplayNames(this.chartDefinition,layer)))}return LayerChart.prototype._setFieldDisplayNames=function(e,t){if(t&&e){for(var i={},r=0;r<t.fields.length;r++){var n=t.fields[r];n&&(i[n.name]=n.displayName)}e.category.field.sourceType==Enums_1.ChartFieldSourceType.Field&&(e.category.field.displayName=i[e.category.field.name]||e.category.field.name);for(var s=0;s<e.series.length;s++){var a=e.series[s];a&&a.field.sourceType==Enums_1.ChartFieldSourceType.Field&&(a.field.displayName=i[a.field.name]||a.field.name)}}},LayerChart}();exports.LayerChart=LayerChart})},"geocortex/essentials/LayerHyperlink":function(){define(["require","exports","./RestHelper"],function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){this.encodeUriReplacementValues=e.encodeUriReplacementValues,this.target=e.target,this.text=e.text,this.toolTip=e.toolTip;var r=null;null!=t.mapServiceType?this.mapService=t:(this.layer=t,this.layer.mapService&&(this.mapService=this.layer.mapService)),this.mapService&&this.mapService.essentialsMap&&(r=this.mapService.essentialsMap.site),this.uri=i.RestHelper.processClientSideTokens(r,e.uri),this.iconUri=i.RestHelper.processClientSideTokens(r,e.iconUri)}return e.prototype.toJson=function(){return{encodeUriReplacementValues:this.encodeUriReplacementValues,iconUri:this.iconUri,target:this.target,text:this.text,toolTip:this.toolTip,uri:this.uri}},e}();t.LayerHyperlink=r})},"geocortex/essentials/LayerQuery":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){return function(e){e&&(this.id=e.id,this.displayName=e.displayName,this.query=e.query)}}();t.LayerQuery=i})},"geocortex/essentials/LayerStyle":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t,i,r){void 0===r&&(r=!1),this.rendererJson=e,this.displayName=t,this.id=i,this.enabled=r}return e.prototype.getRenderer=function(){var e=esri.renderer.fromJson(JSON.parse(this.rendererJson));return e instanceof esri.renderer.Renderer||console.error("Layer Style: '{0}'. Could not create a valid renderer from the stored JSON string: '{1}'".format(this.displayName,this.rendererJson)),e},e.prototype.setRenderer=function(e){e instanceof esri.renderer.Renderer?this.rendererJson=JSON.stringify(e.toJson()):esri.renderer.fromJson(JSON.parse(e))instanceof esri.renderer.Renderer?this.rendererJson=e:console.error("Layer Style: '{0}'. Supplied JSON string could not be used to create a valid renderer: '{1}'".format(this.displayName,e))},e.prototype.isSimple=function(){return"simple"===JSON.parse(this.rendererJson).type},e}();t.LayerStyle=i})},"geocortex/essentials/LayerTheme":function(){define(["require","exports","./../geocortex","./Layer","./LayerType"],function(e,t,i,r,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t,i){this.layerThemesInfo=e;var r="object"==typeof t?t:null;this._configureLayerTheme(r,t,i)}return e.prototype._configureLayerTheme=function(e,t,r){this.id=e?e.id:t,this.isDefaultTheme=null===this.id,this.isActive=!1,this.displayName=e?e.displayName:r,this.extensions=i._getExtensions(e?e.extensions:null),this.properties=e?e.properties:null},e.prototype.applyToMap=function(){var e=this;if(void 0==this.layerThemesInfo)throw new Error("Could not apply theme '{0}' to the map because the LayerThemesInfo property is not set on this LayerTheme.".format(this.displayName));var t=this.layerThemesInfo,i=t.map;if(void 0==i)throw new Error("Failed to apply theme '{0}' to map because the Map property is not set on the LayerThemesInfo object.".format(this.displayName));this.isActive=!0,(t.activeTheme&&t.activeTheme!==this||!t.activeTheme)&&(t.activeTheme&&(t.previousTheme=t.activeTheme,t.previousTheme.isActive=!1),t.activeTheme=this),t.themeChangeInProgress=!0,t.layerThemeChangingEvent({currTheme:t.activeTheme,prevTheme:t.previousTheme});for(var s=function(e,t){void 0===t&&(t=!1),e.setInActiveTheme(!0),o(e,e.configuredVisible,t)},a=function(t,i){void 0===i&&(i=!1);var r=t.getLayerThemeSettings(e.id);t.setInActiveTheme(null!=r);var n=!1;null!=r&&(n=void 0!=r.visible?r.visible:t.configuredVisible),o(t,n,i)},o=function(e,t,i){if(void 0===i&&(i=!1),e instanceof r.Layer){var s=e;if(s.mapService.supportsLayerVisibility())s.mapService.essentialsMap.site.getEssentialsVersion()>=4.02&&s.type===n.LayerType.GROUP_LAYER&&(t=!0);else if(1!==s.mapService.layers.length||!s.inActiveTheme||s.mapService.includeInLayerList)return}e.isUserCreated||e.setVisibility(t,i)},l=0;l<i.mapServices.length;l++){var c=i.mapServices[l],u=c.supportsLayerVisibility();this.isDefaultTheme?s(c):a(c);for(var p=0;p<c.layers.length;p++){var h=c.layers[p];this.isDefaultTheme?s(h,u):a(h,u)}u&&c.refresh()}i.refreshFilteredCollections(),t.themeChangeInProgress=!1,t.layerThemeChangedEvent({currTheme:t.activeTheme,prevTheme:t.previousTheme})},e}();t.LayerTheme=s})},"geocortex/essentials/LayerThemeEventArgs":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/LayerThemeSetting":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){return function(e,t){this.theme=e,this.visible=t}}();t.LayerThemeSetting=i})},"geocortex/essentials/LayerThemesInfo":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e){this.layerThemeChangedEvent=function(e){},this.themeChangeInProgress=!1,this.layerThemeChangingEvent=function(e){},this.layerThemesConfigured=!1,this.allowDefault=!1,this.themes=[],this.map=e}return e.prototype.applyTheme=function(e){if(this.layerThemesConfigured){var t=this.getTheme(e);t?t.applyToMap():console.log("Error: Theme with ID '{0}' could not be found and was not activated.".format(e))}else console.log("Warning: No layer themes have been configured by the essentials administrator.")},e.prototype.getTheme=function(e,t){if(void 0===t&&(t=!1),this.layerThemesConfigured)for(var i=0;i<this.themes.length;i++){if(this.themes[i].id===e)return this.themes[i];if(t&&this.themes[i].displayName.toLowerCase()===e.toLowerCase())return this.themes[i]}return null},e}();t.LayerThemesInfo=i})},"geocortex/essentials/LayerTimeOptions":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/LayerType":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){return function(){}}();i.UNKNOWN=0,i.FEATURE_LAYER=1,i.RASTER_LAYER=2,i.GROUP_LAYER=3,i.GEO_RSS_LAYER=4,i.TABLE_LAYER=5,t.LayerType=i})},"geocortex/essentials/LayerVisibilityEventManager":function(){define(["require","exports","./MapServiceConstants","./LayerType"],function(e,t,i,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){if(this._mapService=null,this._mapService=e,this._mapService.mapServiceType!=i.MapServiceType.WMS&&this._mapService.mapServiceType!=i.MapServiceType.DYNAMIC)throw new Error("LayerVisibilityEventManager: Only Dynamic and WMS Layer types supported.");var r=this;dojo.aspect.before(t,"setVisibleLayers",function(e,t){return r.beforeESRIsetVisibleLayers(e,t)}),dojo.aspect.after(t,"setVisibleLayers",function(e,t,i){r.afterESRIsetVisibleLayers(e,t,i)},!0)}return e.prototype.beforeESRIsetVisibleLayers=function(e,t){var n=[],s=[];if(void 0===t&&(t=!1),e.InternallyChangedLayer){var a=e.InternallyChangedLayer;return void 0!=a.mapServiceId&&void 0!=a.layerId&&void 0!=a.visibility&&n.push(a),c=[e,t,n]}if(this._mapService.mapServiceType==i.MapServiceType.DYNAMIC)s=dojo.clone(e);else if(this._mapService.mapServiceType==i.MapServiceType.WMS)for(var o=0;e&&o<e.length;o++){var l=this._findWmsLayerIdFromName(e[o]);if(!l||null===l){var c=[e,t,n];return console.error("WARNING: LayerVisibilityEventManager could not find layer corresponding to WMS name ["+e[o]+"] Possible Invalid configuration"),c}s.push(l.toString())}if(e&&this._mapService.mapServiceType==i.MapServiceType.DYNAMIC&&1===e.length&&"-1"==e[0]){for(var u=0;u<this._mapService.layers.length;u++){var p=this._mapService.layers[u].id,h=this._mapService.findLayerById(p);h.type!==r.LayerType.GROUP_LAYER&&(n.push({mapServiceId:this._mapService.id,layerId:p.toString(),visibility:!1}),h._syncProgramaticallyChangedLayerVisibility(!1))}return c=[e,t,n]}(e&&0===e.length||this._mapService.mapServiceType==i.MapServiceType.DYNAMIC&&1===e.length&&""===e[0])&&(s=this._mapService.getDefaultVisibleLayers());for(var d=this._getAllCurrentlyVisibleLayers(),f=0;d&&f<d.length;f++){p=d[f];s&&s.indexOf(p.toString())<0&&(v=this._mapService.findLayerById(p))&&v.type!==r.LayerType.GROUP_LAYER&&(n.push({mapServiceId:this._mapService.id,layerId:p.toString(),visibility:!1}),v._syncProgramaticallyChangedLayerVisibility(!1))}var y=this._mapService.getVisibleLayers();if(s&&s.length>0)for(var m=0;m<s.length;m++)if(this._mapService.mapServiceType==i.MapServiceType.DYNAMIC&&isNaN(parseInt(s[m]))&&(s[m]="0"),y&&y.indexOf(s[m].toString())<0){var v=this._mapService.findLayerById(s[m]);v&&(v.subLayerIds&&v.subLayerIds.length>0&&(this._deleteItemWithId(s[m],n),this._recursivelyUpdateSublayerVisibility(v,!0,n)),n.push({mapServiceId:this._mapService.id,layerId:s[m].toString(),visibility:!0}),v._syncProgramaticallyChangedLayerVisibility(!0),v.parentLayerId&&null!==v.parentLayerId&&void 0!==v.parentLayerId&&this._recursivelyUpdateAncestorVisibility(v,s,n))}return c=[e,t,n]},e.prototype.afterESRIsetVisibleLayers=function(e,t,i){i&&i.length>0&&dojo.publish("LayerVisibilityChange",new Array(i))},e.prototype._recursivelyUpdateAncestorVisibility=function(e,t,i){if(e&&e.parentLayerId&&null!==e.parentLayerId&&void 0!==e.parentLayerId){var r=this._mapService.findLayerById(e.parentLayerId);r.isVisible()||(this._deleteItemWithId(e.parentLayerId,i),r._syncProgramaticallyChangedLayerVisibility(!0),i.push({mapServiceId:this._mapService.id,layerId:e.parentLayerId.toString(),visibility:!0})),this._recursivelyUpdateAncestorVisibility(r,t,i)}},e.prototype._recursivelyUpdateSublayerVisibility=function(e,t,i){if(e.subLayerIds&&e.subLayerIds.length>0)for(var r=0;r<e.subLayerIds.length;r++){var n=this._mapService.findLayerById(e.subLayerIds[r]),s=n.id;n._syncProgramaticallyChangedLayerVisibility(t),this._deleteItemWithId(s,i),i.push({mapServiceId:this._mapService.id,layerId:s.toString(),visibility:t}),n.subLayerIds&&n.subLayerIds.length>0&&this._recursivelyUpdateSublayerVisibility(n,t,i)}},e.prototype._getAllCurrentlyVisibleLayers=function(){for(var e=[],t=0;t<this._mapService.layers.length;t++){var i=this._mapService.layers[t];i.isVisible()&&e.push(i.id.toString())}return e},e.prototype._findWmsLayerIdFromName=function(e){for(var t=0;t<this._mapService.layers.length;t++){var i=this._mapService.layers[t];if(e==i.wmsLayerName)return i.id}return null},e.prototype._deleteItemWithId=function(e,t){for(var i=0;i<t.length;i++)t[i].layerId==e&&t.splice(i,1)},e}();t.LayerVisibilityEventManager=n})},"geocortex/essentials/Map":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}();define(["require","exports","./AsyncInitializable","./BaseMap","./MapService","./LayerThemesInfo","./ExportMapImageOptions","./DistanceUnit","./ExtentManager","./utilities/UrlUtilities","./MapServiceConstants","./FeatureLayerService","geocortex/framework/utils/utils","./GeoRssLayerService","./KmlService","./StreamLayerService","./WFSLayerService","./exportMap/ExportMapTask","./exportMap/ExportMapParameters","./catalog/LayerCatalogDetail","./LayerTheme","./RestHelper","./../geocortex","./BaseMapService","./RestHelperHTTPService","geocortex/framework/utils/utils","geocortex/framework/utils/ArrayUtils"],function(t,i,r,n,s,a,o,l,c,u,p,h,d,f,y,m,v,g,_,S,L,T,b,E,I,x,w){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var M=function(t){function i(e){var i=t.call(this,e)||this;return i.baseMaps=[],i.fullExtent=null,i.initialExtent=null,i.fitTiledMapsToExtent=!1,i.mapServices=[],i.mapServicesFilteredView=[],i.layerThemesInfo=null,i.primaryMapService=null,i.supportedExportFormats=["BMP","JPEG","PNG","TIFF","GeoTIFF","PDF"],i.exportMapImageOptions=null,i.units=null,i.serviceLayersAdded=!1,i.extentManager=null,i.spatialReference=null,i.setExtentOnLoad=!0,i.isLoaded=!1,i._esriMap=null,i._onExportComplete=null,i._onExportError=null,i._suspendedLayers=[],i._canAddLayersUnsuspended=!1,i.originalUrl=e,i.url=u.UrlUtilities.simplify(e),i.layerThemesInfo=new a.LayerThemesInfo(i),i}return e(i,t),i.prototype.getMap=function(){return this._esriMap},i.prototype.allLayers=function(){for(var e=[],t=0,i=this.mapServices;t<i.length;t++)for(var r=0,n=i[t].layers;r<n.length;r++){var s=n[r];e.push(s)}return e},i.prototype.allTables=function(){for(var e=[],t=0,i=this.mapServices;t<i.length;t++)for(var r=0,n=i[t].tables;r<n.length;r++){var s=n[r];e.push(s)}return e},i.prototype.allLayersAndTables=function(){var e=[];return e=this.allLayers(),e=this.allTables().reduce(function(e,t){return e.push(t),e},e)},i.prototype.filteredLayers=function(){for(var e=[],t=0,i=this.mapServices;t<i.length;t++){var r=i[t];this._layerThemeMapServiceFilter(r)&&(e=e.concat(r.layers))}return e},i.prototype.loadServiceLayersInMap=function(e){if(!e)throw new Error("Must supply a map");this._esriMap=e,this.fitTiledMapsToExtent=!!e._fitTiledMapsToExtent,this.extentManager=new c.ExtentManager(e,this.fitTiledMapsToExtent);for(var t=0,i=this.mapServices;t<i.length;t++){var r=i[t],n=r.serviceLayer;n&&(this.extentManager.registerLayer(n),n.loaded||r.failureTimeoutThresholdExceeded?(this._layerLoadedUpdate(e),r._handleServiceLayerLoaded(n),r._handleDynamicLayers(n)):(dojo.connect(r,"onFailureTimeoutThresholdExceeded",dojo.hitch(this,this._layerLoadedUpdate,e)),dojo.connect(n,"onLoad",dojo.hitch(this,this._layerLoadedUpdate,e)),dojo.connect(n,"onError",dojo.hitch(this,this._layerLoadedUpdate,e))))}},i.prototype.calculateScale=function(){return esri.geometry.getScale(this.site.getMap())},i.prototype._addServiceLayers=function(e){for(var t=this.mapServices.length-1;t>=0;t--){var i=this.mapServices[t].serviceLayer;if(!i.loadError){this._canAddLayersUnsuspended||(i.suspend(),this._suspendedLayers.push(i)),(i instanceof esri.layers.DynamicMapServiceLayer||i instanceof esri.layers.TiledMapServiceLayer)&&i.fullExtent&&(x.isNullOrUndefined(i.fullExtent.xmax)||"NaN"===i.fullExtent.xmax.toString()||x.isNullOrUndefined(i.fullExtent.ymax)||"NaN"===i.fullExtent.ymax.toString()||x.isNullOrUndefined(i.fullExtent.xmin)||"NaN"===i.fullExtent.xmin.toString()||x.isNullOrUndefined(i.fullExtent.ymin)||"NaN"===i.fullExtent.ymin.toString())&&(i.fullExtent=i.initialExtent);try{e.addLayer(i)}catch(e){this.site.onLayerLoadError(e),this.mapServices[t].initializationFailure=e}}}this.site&&dojo.isObject(this.site)&&(this.site.serviceLayersLoaded=!0,dojo.isFunction(this.site.onServiceLayersLoaded)&&this.site.onServiceLayersLoaded(this.site))},i.prototype.addServiceLayers=function(e,t){var i=this;if(e||e.length){for(var r=[],n=this,a=function(e){var i=null,a=!1,o=p.MapServiceType.FEATURE;switch(e.opacity=e.opacity||1,e.type){case"Feature Layer":i=new h.FeatureLayerService(e.url);break;default:switch(e.declaredClass){case"esri.layers.WebTiledLayer":i=new s.MapService(e.tileServers[0]),o=p.MapServiceType.WEBTILED,a=!0}}if(i){i.serviceLayer=e,i.essentialsMap=n;var l=e.layerId||d.alphaNumericToken(),c={id:l,isExpanded:!0,includeInLayerList:a,serviceFunction:t,serviceType:o,layerOptions:null};c.layerOptions={id:l,name:e.name,description:e.description,displayField:e.displayField,includeInLayerList:!0,identifiable:!0,fullExtent:e.fullExtent,primaryKeyField:e.objectIdField,visible:e.visible},i._createFrom(c),r.push(i),dojo.connect(e,"onClick",function(e){dojo.publish("FeatureClickedEvent",dojo.mixin(e,{layer:i.layers[0],useFeaturePresenter:!0}))})}},o=0,l=e;o<l.length;o++)!function(e){if(e.getFeatureLayers){var t=e,i=t.getFeatureLayers();if(i&&i.length>0)return dojo.forEach(i,function(e){e.name=e.name||t.name,a(e)}),"continue"}a(e)}(l[o]);this.mapServices=this.mapServices.concat(r),dojo.forEach(r,function(e){return i._addToFilteredView(e)}),this._addServiceLayers(this.getMap()),dojo.forEach(r,function(e){dojo.publish("MapServiceAddedEvent",e)})}},i.prototype.removeServiceLayer=function(e){if(e&&this.mapServices.length)for(var t=0;t<this.mapServices.length;t++){var i=this.mapServices[t];if(i&&i.serviceLayer&&i.serviceLayer===e){this.mapServices.splice(t,1),dojo.publish("MapServiceRemovedEvent",i);break}}},i.prototype.enableUnsuspendedMapLayers=function(){this._suspendedLayers.forEach(function(e){e.resume()}),this._suspendedLayers=[],this._canAddLayersUnsuspended=!0},i.prototype.addMapService=function(e){var t=this.getMap(),i=this.site,r=e instanceof s.MapService?e:e.mapService,n=!(e instanceof s.MapService)&&!!e.respectVisibility;r.isUserCreated=!0,r.includeInLayerList=!(r instanceof h.FeatureLayerService||r instanceof v.WFSLayerService||r instanceof m.StreamLayerService),r.opacity=1;for(var a=0,o=r.layers;a<o.length;a++){var l=o[a];l.isUserCreated=!0,l.includeInLayerList=!0,l.includeInLegend=!0,l.site=i,n||(l.configuredVisible=!0,r.supportsLayerVisibility()?l.setVisibility(!0):l._visible=!0)}r.essentialsMap=this,this.mapServices.push(r),t.addLayer(r.serviceLayer),dojo.publish("MapServiceAddedEvent",r),n||r.setVisibility(!0)},i.prototype.removeMapService=function(e){if(e){var t=this.mapServices.indexOf(e);t>=0&&(this.mapServices.splice(t,1),dojo.publish("MapServiceRemovedEvent",e)),this._esriMap&&e.serviceLayer&&this._esriMap.removeLayer(e.serviceLayer)}},i.prototype._configureMapServices=function(e,t){for(var i=0;e&&i<e.length;i++){var r=e[i],n=this.originalUrl+"/mapservices/"+r.id;if(r.drawingBehavior===p.DrawingBehavior.FEATURE_LAYER){if(!dojo.isObject(esri.layers.FeatureLayer))throw new Error("This Javascript application must require the esri.layers.FeatureLayer package in order to use a site with feature layers");this.mapServices[i]=new h.FeatureLayerService(n)}else if(r.drawingBehavior===p.DrawingBehavior.GEORSS_LAYER){if(!dojo.isObject(esri.layers.GraphicsLayer))throw new Error("This Javascript application must require the esri.layers.GraphicsLayer package in order to use a site with GeoRSS layers");this.mapServices[i]=new f.GeoRssLayerService(n)}else if(r.drawingBehavior===p.DrawingBehavior.KML_SERVICE){if(!dojo.isObject(esri.layers.KMLLayer))throw new Error("This Javascript application must require the esri.layers.KMLLayer package in order to use a site with KML layers");this.mapServices[i]=new y.KmlService(n)}else if(r.drawingBehavior===p.DrawingBehavior.STREAM_LAYER){if(!dojo.isObject(esri.layers.StreamLayer))throw new Error("This Javascript application must require the esri.layers.StreamLayer package in order to use a site with stream layers");this.mapServices[i]=new m.StreamLayerService(n)}else if(r.drawingBehavior===p.DrawingBehavior.WFS_LAYER){if(!dojo.isObject(esri.layers.WFSLayer))throw new Error("This Javascript application must require the esri.layers.WFSLayer package in order to use a site with WFS layers");this.mapServices[i]=new v.WFSLayerService(n),this.mapServices[i].mapServiceType=p.MapServiceType.WFS}else this.mapServices[i]=new s.MapService(n);this.mapServices[i].essentialsMap=this,this.mapServices[i].initialize(r),dojo.publish("ServiceLayerInitializedEvent",this.mapServices[i].serviceLayer),this._addToFilteredView(this.mapServices[i])}},i.prototype._configureObject=function(e,t){if(void 0===e||void 0===e.mapServices)throw new Error("Incorrect map object returned from initialization");if(e.initialExtent&&(x.isNullOrUndefined(e.initialExtent.spatialReference)&&(i=w.firstOrDefault(e.mapServices,function(e){return e.fullExtent&&e.fullExtent.spatialReference}))&&(e.initialExtent.spatialReference=i.fullExtent.spatialReference),this.initialExtent=new esri.geometry.Extent(e.initialExtent)),e.fullExtent){if(x.isNullOrUndefined(e.fullExtent.spatialReference)){var i=w.firstOrDefault(e.mapServices,function(e){return e.fullExtent&&e.fullExtent.spatialReference});i&&(e.fullExtent.spatialReference=i.fullExtent.spatialReference)}this.fullExtent=new esri.geometry.Extent(e.fullExtent)}e.units&&(this.units=new l.DistanceUnit(e.units.name,e.units.type)),e.exportOptions&&(this.exportMapImageOptions=new o.ExportMapImageOptions(e.exportOptions.allowIncludeGeoreferenceData,e.exportOptions.defaultOutputFormat)),e.layerThemes&&(e.layerThemes.items&&e.layerThemes.items.length||e.layerThemes.allowDefault)&&this._configureLayerThemesInfo(e.layerThemes),this._configureMapServices(e.mapServices,t),dojo.isArray(e.baseMaps)&&this._configureBaseMaps(e.baseMaps),t&&(this.isInitialized=!0),this.primaryMapService=this.findMapServiceById(e.primaryMapServiceID)},i.prototype.findMapServiceById=function(e){for(var t=0,i=this.mapServices;t<i.length;t++){var r=i[t];if(r.id===e)return r}return null},i.prototype.setFeatureLayerExclusivelyVisible=function(e){for(var t=0,i=this.site.getFeatureServices();t<i.length;t++){var r=i[t];r.setVisibility(r.serviceLayer.id===e.id)}},i.prototype.exportMap=function(e,t,i){var r=this;this._onExportComplete=t,this._onExportError=i;var n=new g.ExportMapTask(this),s=new _.ExportMapParameters;s.reportParameters=e,n.generateMapImageUrl(s).then(function(e){return r._exportRestComplete(e)},function(e){return r._exportRestError(e)})},i.prototype.findLayerFromMatchingEsriFeatureLayer=function(e){if(e){for(var t=0;t<this.mapServices.length;t++)if((f=this.mapServices[t]).serviceLayer instanceof esri.layers.FeatureLayer){var i=f.serviceLayer;if(i.layerId===e.layerId&&i.name===e.name&&f.layers.length>0)return f.layers[0]}var r=this.allTables().filter(function(t){return t.id===e.layerId.toString()&&t.name===e.name})[0];if(r)return r;for(var n=function(e,t){var i=e.serviceUrl;return e.serviceToken&&t.search(/token=.[^&]*/g)>0&&(i=I.RestHelperHTTPService.appendTokenToUrl(i,e.serviceToken)),i},s=e.url.match(/.[^?]*/g)[0],a=0,o=this.mapServices;a<o.length;a++)if((y=n(f=o[a],s))===s&&f.layers.length>0)return f.layers[0];for(var l=new RegExp("[^/]*.$"),c=Number(s.match(l)),u=new RegExp("/[^/]*.$"),p=s.replace(u,""),h=0,d=this.mapServices;h<d.length;h++){var f=d[h],y=n(f,p);if(y===p){var m=f.findLayerOrTableById(c.toString());if(m)return m;if(f.layers.length>=c)return f.layers[c]}}return null}},i.prototype._exportRestComplete=function(e){var t=null;e?e.error&&(t=e.error):t=new Error("No results"),t&&this._onExportComplete&&this._onExportError(t),e&&this._onExportComplete&&this._onExportComplete(e)},i.prototype._exportRestError=function(e){this._onExportError&&this._onExportError(e)},i.prototype._layerLoadedUpdate=function(e){if(!this.serviceLayersAdded){for(var t=0,i=this.mapServices;t<i.length;t++){var r=i[t],n=r.serviceLayer;if(!r.initializationFailure&&r.failureTimeoutThresholdExceeded&&(r.initializationFailure=new Error("Map Service - {0}: Failure timeout threshold exceeded.".format(r.id))),!n.loaded&&!r.initializationFailure&&!r.failureTimeoutThresholdExceeded)return}this.serviceLayersAdded=!0,this.spatialReference=this.primaryMapService.serviceLayer.loadError?this.initialExtent.spatialReference:this.primaryMapService.serviceLayer.spatialReference,this.spatialReference&&this._switchSpatialReferenceGlobally(this.spatialReference),this._esriMap.spatialReference||(this._esriMap.spatialReference=this.spatialReference||this.initialExtent.spatialReference||this.fullExtent.spatialReference),!this._esriMap.extent&&this.initialExtent&&this._esriMap.setExtent(new esri.geometry.Extent(this.initialExtent.toJson())),this._addServiceLayers(e)}},i.prototype.applyCatalogLayersChange=function(e){e&&(this._applyCatalogChangesToDynamicLayers(e),this._applyCatalogChangesToWmsLayers(e))},i.prototype.applyStartupTheme=function(){this.layerThemesInfo.layerThemesConfigured&&this.layerThemesInfo.applyTheme(this.layerThemesInfo.startupThemeId||this.layerThemesInfo.themes[0].id)},i.prototype.refreshFilteredCollections=function(){var e=this;this.mapServicesFilteredView.length=0,dojo.forEach(this.mapServices,function(t){return e._addToFilteredView(t)});for(var t=0,i=this.mapServices;t<i.length;t++)i[t].refreshFilteredCollections()},i.prototype._switchSpatialReferenceGlobally=function(e){if(this.initialExtent&&(this.initialExtent=new esri.geometry.Extent(this.initialExtent.xmin,this.initialExtent.ymin,this.initialExtent.xmax,this.initialExtent.ymax,e)),this.fullExtent&&(this.fullExtent=new esri.geometry.Extent(this.fullExtent.xmin,this.fullExtent.ymin,this.fullExtent.xmax,this.fullExtent.ymax,e)),this.site.hasNamedExtents&&this.site.namedExtents&&this.site.namedExtents.length)for(var t=0,i=this.site.namedExtents;t<i.length;t++){var r=i[t];r.extent=new esri.geometry.Extent(r.extent.xmin,r.extent.ymin,r.extent.xmax,r.extent.ymax,e)}this._esriMap.spatialReference=e,this._esriMap.extent.spatialReference=e},i.prototype._applyCatalogChangesToWmsLayers=function(e){},i.prototype._applyCatalogChangesToDynamicLayers=function(e){var t=e.mapServiceId,i=[],r=new S.LayerCatalogDetail;r.mapServiceId=t;for(var n=0,s=e.entries;n<s.length;n++){var a=s[n];a.isDynamic&&i.push(a)}r.entries=i;var o=this.findMapServiceById(t);o&&o.applyCatalogLayersChange(r)},i.prototype._configureLayerThemesInfo=function(e){var t=this;if(!e)throw new Error("RestLayerThemesInfo object not defined. Cannot configure layer themes.");this.layerThemesInfo.layerThemesConfigured=!0,this.layerThemesInfo.allowDefault=!!x.isNullOrUndefined(e.allowDefault)||e.allowDefault,this.layerThemesInfo.startupThemeId=e.startupThemeID,this.layerThemesInfo.allowDefault&&this.layerThemesInfo.themes.push(new L.LayerTheme(this.layerThemesInfo,null,e.defaultThemeDisplayName||"")),e.items&&e.items.length&&dojo.forEach(e.items,function(e){t.layerThemesInfo.themes.push(new L.LayerTheme(t.layerThemesInfo,e))})},i.prototype._addToFilteredView=function(e){e&&this._layerThemeMapServiceFilter(e)&&this.mapServicesFilteredView.push(e)},i.prototype._layerThemeMapServiceFilter=function(e){return!e.essentialsMap.layerThemesInfo.layerThemesConfigured||e.inActiveTheme},i.prototype._configureBaseMaps=function(e){var t=this;e.forEach(function(e){var i=new n.BaseMap(t);i.displayName=e.displayName,i.id=e.id,e.iconUri&&(i.iconUri=T.RestHelper.processClientSideTokens(t.site,e.iconUri)),e.exportTilesMapServiceUri&&(i.exportTilesMapServiceUri=T.RestHelper.processClientSideTokens(t.site,e.exportTilesMapServiceUri)),i.properties=b._getProperties(e.properties),i.extensions=b._getExtensions(e.extensions),dojo.isArray(e.mapServices)&&e.mapServices.forEach(function(e){var r=t.findMapServiceById(e.id);r&&i.services.push(new E.BaseMapService(r))}),t.baseMaps.push(i)})},i}(r.AsyncInitializable);i.Map=M})},"geocortex/essentials/MapGrid":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){return function(){}}();t.MapGrid=i})},"geocortex/essentials/MapService":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}();define(["require","exports","./AsyncInitializable","./MapServiceConstants","./Layer","./LayerThemeSetting","./LayerHyperlink","./TimeInfo","./LayerVisibilityEventManager","./utilities/UrlUtilities","./../geocortex","./RestHelper","./../hasProxy","./RestHelperHTTPService","./RefreshVisibility","./ServiceHelper","geocortex/framework/SimplePromise","geocortex/framework/utils/utils","./LayerType","geocortex/framework/utils/ArrayUtils","./utilities/TimeZoneUtils"],function(t,i,r,n,s,a,o,l,c,u,p,h,d,f,y,m,v,g,_,S,L){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var T=function(i){function r(e){var t=i.call(this,e)||this;return t.bingProperties=null,t.baseMapGroup=null,t.configuredOpacity=1,t.configuredVisible=!1,t.copyright=null,t.attributionDataUrl=null,t.hasAttributionData=!1,t.dataProvider=null,t.description=null,t.defaultDateFormat=null,t.defaultNumberFormat=null,t.disableClientCaching=!1,t.displayName=null,t.drawingBehavior=null,t.essentialsMap=null,t.extensions=[],t.failureAction=n.FailureAction.WARN,t.failureTimeout=null,t.failureTimeoutThresholdExceeded=!1,t.onFailureTimeoutThresholdExceeded=function(){},t.featureClustering=null,t.geometryServiceUrl=null,t.hasLayerCatalog=!1,t.iconUri=null,t.id=null,t.catalogId=null,t.originalUrl=null,t.imageFormat=null,t.initializationFailure=null,t.includeInLayerList=!0,t.isExpanded=!0,t.isServiceLayerLoaded=!1,t.isUserCreated=!1,t.userLayerType=null,t.layers=[],t.tables=[],t.layersFilteredView=[],t.mapServiceFunction=null,t.mapServiceType=null,t.mapUrl=null,t.maxScale=null,t.minScale=null,t.opacity=1,t.opacityFilter=1,t.operationalSpatialReference=null,t.inActiveTheme=!0,t.layerThemeSettings=[],t.layerHyperlinks=[],t.properties={},t.proxyUrl=null,t.requestEncoding=null,t.instantSearch=!1,t.serverVersion=null,t.serviceLayer=null,t.serviceToken=null,t.serviceUrl=null,t.shortDisplayName=null,t.subDomains=[],t.supportsDynamicLayers=!1,t.tileMatrixSet=null,t.tileInfo=null,t.tileRestUrl=null,t.isTimeAware=!1,t.timeInfo=null,t.timeZoneId=null,t.timeAwareMode=null,t.updateInterval=null,t.heatMap=null,t.identifiable=!1,t.includeMosaicDatasetValues=!1,t.includeCatalogItems=!1,t._needsProxy=!1,t.layerVisibilityEventManager=null,t._updateIntervalId=null,t._delayedRefreshToken=null,t._layerInfoPromises={},t._styleUrl=null,t._tileScheme=null,t._restStartTimeOverrideString=null,t._restEndTimeOverrideString=null,t._layerSecurityProxy=!1,t._featureLayerPromise=null,t._initiallyVisible=!1,t.originalUrl=e,t.url&&(t.url=u.UrlUtilities.simplify(e)),t.setInActiveTheme(!0),t}return e(r,i),r.prototype._getLayersInfo=function(e){var t=this,i=this.findLayerById(e),r=function(e){return function(i,r){t.doWhenInitialized(function(n){var s={url:e,content:{f:"json"},load:function(e){if(t.serviceLayer instanceof esri.layers.FeatureLayer&&!e.layers||e.type){var r={},n=[e];r[e.type&&"table"===e.type.toLowerCase()?"tables":"layers"]=n,e=r}i(e)},error:function(e){return r(e)},callbackParamName:"CallBack",preventCache:!1};null!==t.serviceToken&&(s.content.token=t.serviceToken);var a={gcx:{preventCache:!1}};esri.request(s,a)})}};if(this._layerInfoPromises.all&&this._layerInfoPromises.all.isRejected()&&e&&this._layerInfoPromises[e]&&this._layerInfoPromises[e].isRejected())return this._layerInfoPromises[e];if(e&&this._layerInfoPromises[e]&&!this._layerInfoPromises[e].isRejected())return this._layerInfoPromises[e];if(this._layerInfoPromises.all&&!this._layerInfoPromises.all.isRejected())return this._layerInfoPromises.all;if(this.serviceUrl.endsWith("/MapServer")){var n=[];this.serviceLayer instanceof esri.layers.FeatureLayer?this._layerInfoPromises.all||n.push({layerId:"all",url:this.serviceUrl}):(e&&!this._layerInfoPromises[e]&&i&&!i.isDynamic&&n.push({layerId:e,url:this.serviceUrl+"/"+e}),this._layerInfoPromises.all||n.push({layerId:"all",url:this.serviceUrl+"/layers"})),n.forEach(function(e){t._layerInfoPromises[e.layerId]=new Promise(r(e.url))})}else this._layerInfoPromises.all||this._layerInfoPromises.all.isRejected()||(this._layerInfoPromises.all=Promise.resolve(null));return this._layerInfoPromises[e]||this._layerInfoPromises.all},r.prototype.getConfiguredVisibleLayers=function(){return this._getVisibleLayersOfType("configuredVisible")},r.prototype.getDefaultVisibleLayers=function(){return this._getVisibleLayersOfType("defaultVisibility")},r.prototype.getVisibleLayers=function(){return this._getVisibleLayersOfType("_visible")},r.prototype._getVisibleLayersOfType=function(e){for(var t=[],i=0,r=0,n=this.layers;r<n.length;r++){var s=n[r];s[e]&&null==s.parentLayerId&&(null==s.subLayerIds||0===s.subLayerIds.length?(i=this._addAnnotationSublayers(s,t,i),t[i++]=s.id):i=this._getVisibleGroupLayersOfType(e,s,t,i))}return t},r.prototype._addAnnotationSublayers=function(e,t,i){if(e.type===_.LayerType.RASTER_LAYER&&e.mapService.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer){var r=S.firstOrDefault(e.mapService.serviceLayer.layerInfos,function(t){return t.id.toString()===e.id});if(r&&r.subLayerIds&&r.subLayerIds.length>0)for(var n=0,s=r.subLayerIds;n<s.length;n++)!function(r){S.firstOrDefault(e.mapService.layers,function(e){return e.id===r.toString()})||(t[i++]=r.toString())}(s[n])}return i},r.prototype.isVisible=function(){var e=!1;return this.serviceLayer&&"boolean"==typeof this.serviceLayer.visible&&(e=this.serviceLayer.visible),e},r.prototype.isTiled=function(){return!!this.serviceLayer&&this.serviceLayer instanceof esri.layers.TiledMapServiceLayer},r.prototype.setVisibility=function(e){if(null!==this.serviceLayer){if(!this.supportsLayerVisibility()&&this.layers.length)for(var t=0,i=this.layers;t<i.length;t++){var r=i[t];r&&(r._visible=e)}e?this.serviceLayer.show():this.serviceLayer.hide()}},r.prototype.setOpacity=function(e){(null==e||isNaN(e))&&(e=1),e=Math.min(1,Math.max(0,e)),this.opacity=e,this.serviceLayer&&this.serviceLayer.setOpacity&&this.serviceLayer.setOpacity(e*this.opacityFilter)},r.prototype.setOpacityFilter=function(e){isNaN(e)&&(e=1),e=Math.min(1,Math.max(0,e)),this.opacityFilter=e,this.serviceLayer&&this.serviceLayer.setOpacity&&this.serviceLayer.setOpacity(e*this.opacity)},r.prototype.setInActiveTheme=function(e){this.inActiveTheme=e,dojo.publish("MapServiceInActiveThemeChangedEvent",this)},r.prototype.findServiceToken=function(){return this.serviceToken?this.serviceToken:this.essentialsMap&&this.essentialsMap.site&&this.essentialsMap.site.arcGisPortalSecurityContext?this.essentialsMap.site.arcGisPortalSecurityContext.getToken(this.serviceUrl):null},r.prototype._findById=function(e,t){for(var i=0,r=t;i<r.length;i++){var n=r[i];if(n.id==e)return n}return null},r.prototype._findByName=function(e,t){for(var i=0,r=t;i<r.length;i++){var n=r[i];if(n.name==e||n.displayName==e)return n}return null},r.prototype._findByNameAndId=function(e,t,i){if(0===i.length)return null;var r=[],s=["name","displayName"];i[0].mapService&&(i[0].mapService.mapServiceType===n.MapServiceType.WMS||i[0].mapService.mapServiceType===n.MapServiceType.WMTS?s.push("wmsLayerName"):i[0].mapService.mapServiceType===n.MapServiceType.WFS&&s.push("wfsLayerName"));for(var a=0,o=i;a<o.length;a++)for(var l=o[a],c=0,u=s;c<u.length;c++)if(l[u[c]]==e){r.push(l);break}for(var p=0,h=r;p<h.length;p++){var d=h[p];if(d.id==t)return d}return null},r.prototype.findLayerByName=function(e){return this._findByName(e,this.layers)},r.prototype.findLayerById=function(e){return this._findById(e,this.layers)},r.prototype.findTableByName=function(e){return this._findByName(e,this.tables)},r.prototype.findTableById=function(e){return this._findById(e,this.tables)},r.prototype.findTableByNameAndId=function(e,t){return this._findByNameAndId(e,t,this.tables)},r.prototype.findLayerByNameAndId=function(e,t){return this._findByNameAndId(e,t,this.layers)},r.prototype.findLayerOrTableByName=function(e){var t=this.findLayerByName(e);return t||(t=this.findTableByName(e)),t},r.prototype.findLayerOrTableById=function(e){var t=this.findLayerById(e);return t||(t=this.findTableById(e)),t},r.prototype.findLayerOrTableByNameAndId=function(e,t){var i=this.findLayerByNameAndId(e,t);return i||(i=this.findTableByNameAndId(e,t)),i},r.prototype.refresh=function(e,t){var i=this,r=this.serviceLayer;if(r&&"function"==typeof r.refresh){var n=function(){if(i._delayedRefreshToken=null,!0===t&&"function"==typeof r.setDisableClientCaching){var e=r.disableClientCaching;r.setDisableClientCaching(!0),r.refresh(),r.setDisableClientCaching(e)}else r.refresh()};this._delayedRefreshToken&&clearTimeout(this._delayedRefreshToken),"number"!=typeof e?n():this._delayedRefreshToken=setTimeout(n,e)}},r.prototype.refreshFilteredCollections=function(){var e=this;this.layersFilteredView.length=0,dojo.forEach(this.layers,function(t){return e._addToFilteredView(t)})},r.prototype._configureLayers=function(e,t){for(var i=0;e&&i<e.length;i++)this.layers[i]=new s.Layer(this.url+"/layers/"+e[i].id),this.layers[i].mapService=this,this.layers[i]._configureObject(e[i],t);this._createServiceLayer(),this.minScale&&this.serviceLayer.setMinScale(this.minScale),this.maxScale&&this.serviceLayer.setMaxScale(this.maxScale),this.disableClientCaching&&this.serviceLayer&&this.serviceLayer.setDisableClientCaching&&this.serviceLayer.setDisableClientCaching(!0)},r.prototype._configureTimeInfo=function(){if(!this.serviceLayer)throw new Error("_configureTimeInfo: The esri service layer must be created before attempting to populate time information.");var e=this.serviceLayer.timeInfo;e?(this.isTimeAware=!0,this.timeInfo=l.getGcxTimeInfo(e,this._restStartTimeOverrideString,this._restEndTimeOverrideString)):this.isTimeAware=!1},r.getGcxTimeInfo=function(e,t,i){return l.getGcxTimeInfo.apply(this,arguments)},r.prototype._configureTables=function(e,t){for(var i=0;e&&i<e.length;i++)this.tables[i]=new s.Layer(this.url+"/tables/"+e[i].id),this.tables[i].mapService=this,this.tables[i]._configureObject(e[i],t)},r.prototype._createFrom=function(e){var t=this;if(this.id=e.id,this.serviceUrl=e.serviceUrl,this.tileRestUrl=e.tileRestUrl,this.mapUrl=e.mapUrl,this.subDomains=(e.subDomains||[]).slice(),this.mapServiceType=e.serviceType,this.mapServiceFunction=e.serviceFunction,this.displayName=e.displayName||e.name,this.shortDisplayName=e.shortDisplayName,this.baseMapGroup=e.baseMapGroup,this.baseMapGroupIndex=e.baseMapGroupIndex,this.baseMapGroupIsMutuallyExclusive=e.baseMapGroupIsMutuallyExclusive,this.description=e.description,this.copyright=e.copyright,this.attributionDataUrl=e.attributionDataUrl,this.hasAttributionData=e.hasAttributionData,this.configuredVisible=!!e.visible,this._initiallyVisible=this.configuredVisible,this.disableClientCaching=!!e.disableClientCaching,this.instantSearch=!!e.instantSearch,this.configuredOpacity=e.opacity,this.opacity=this.configuredOpacity,this.imageFormat=e.format,this.isExpanded=e.isExpanded,this.isUserCreated=g.isNullOrUndefined(e.isUserCreated)?this.isUserCreated:e.isUserCreated,this.userLayerType=g.isNullOrUndefined(e.userLayerType)?this.userLayerType:e.userLayerType,this.serverVersion=e.serverVersion,this.failureAction=e.failureAction,this.failureTimeout=e.failureTimeout,this.tileMatrixSet=e.tileMatrixSet,this.requestEncoding=e.requestEncoding,this.operationalSpatialReference=e.operationalSpatialReference,this.dataProvider=e.dataProvider,this.minScale=e.minScale,this.maxScale=e.maxScale,this.identifiable=!!e.identifiable,this.includeCatalogItems=!!e.includeCatalogItems,this.includeMosaicDatasetValues=!!e.includeMosaicDatasetValues,this.defaultDateFormat=e.defaultDateFormat,this.defaultNumberFormat=e.defaultNumberFormat,this.timeZoneId=e.timeZoneId,this.serviceTag=e.serviceTag,e.timeAwareMode&&(this.timeAwareMode=e.timeAwareMode),e.tileInfo&&(this.tileInfo=dojo.clone(e.tileInfo),this.tileInfo.spatialReference&&(this.tileInfo.spatialReference.wkid?this.tileInfo.spatialReference=new esri.SpatialReference(this.tileInfo.spatialReference.wkid):this.tileInfo.spatialReference=new esri.SpatialReference(this.tileInfo.spatialReference.wkt))),this.supportsDynamicLayers=!1,this.includeInLayerList=e.includeInLayerList,this.drawingBehavior=e.drawingBehavior||n.DrawingBehavior.FEATURE_LAYER,e.layerOptions){var i=new s.Layer;i.mapService=this,i._createFrom(e.layerOptions),this.layers.push(i)}e.hasOwnProperty("layerHyperlinks")&&e.layerHyperlinks.forEach(function(e){t.layerHyperlinks.push(new o.LayerHyperlink(e,t))}),e.featureClustering&&(this.featureClustering={enabled:e.featureClustering.enabled,userCanToggle:e.featureClustering.userCanToggle,radius:e.featureClustering.radius,maximumFeatures:e.featureClustering.clusterSize,backgroundColor:e.featureClustering.backgroundColor,labelColor:e.featureClustering.labelColor}),e.featureHeatMap&&(this.heatMap={enabled:e.featureHeatMap.enabled,userCanToggle:e.featureHeatMap.userCanToggle,respectScaleRange:e.featureHeatMap.respectScaleRange,gradient:(e.featureHeatMap.gradient||[]).slice(),offset:(e.featureHeatMap.offset||[]).slice(),intensity:e.featureHeatMap.intensity,field:e.featureHeatMap.field,defaultRenderer:e.featureHeatMap.defaultRenderer?esri.renderer.fromJson(e.featureHeatMap.defaultRenderer):null,defaultMinScale:e.featureHeatMap.defaultMinScale,defaultMaxScale:e.featureHeatMap.defaultMaxScale,includeInLegend:e.featureHeatMap.includeInLegend}),e.properties&&(this.catalogId=p._getProperties(e.properties).layerCatalogLookupId),this.isInitialized=!0},r.prototype.createFromDefinition=function(e){this._createFrom(e)},r.prototype.toJson=function(){var e={id:this.id,url:this.url,serviceUrl:this.serviceUrl,mapUrl:this.mapUrl,tileRestUrl:this.tileRestUrl,subDomains:(this.subDomains||[]).slice(),serviceType:this.mapServiceType,serviceFunction:this.mapServiceFunction,displayName:this.displayName,shortDisplayName:this.shortDisplayName,baseMapGroup:this.baseMapGroup,baseMapGroupIndex:this.baseMapGroupIndex,baseMapGroupIsMutuallyExclusive:this.baseMapGroupIsMutuallyExclusive,description:this.description,copyright:this.copyright,attributionDataUrl:this.attributionDataUrl,hasAttributionData:this.hasAttributionData,visible:this.isVisible(),disableClientCaching:this.disableClientCaching,opacity:this.opacity,instantSearch:this.instantSearch,format:this.imageFormat,updateInterval:this.updateInterval,isExpanded:this.isExpanded,serverVersion:this.serverVersion,failureAction:this.failureAction,failureTimeout:this.failureTimeout,tileMatrixSet:this.tileMatrixSet,requestEncoding:this.requestEncoding,operationalSpatialReference:this.operationalSpatialReference,dataProvider:this.dataProvider,minScale:this.minScale,maxScale:this.maxScale,identifiable:this.identifiable,includeCatalogItems:this.includeCatalogItems,includeMosaicDatasetValues:this.includeMosaicDatasetValues,defaultDateFormat:this.defaultDateFormat,defaultNumberFormat:this.defaultNumberFormat,timeZoneId:this.timeZoneId,serviceTag:this.serviceTag,startTime:this._restStartTimeOverrideString,endTime:this._restEndTimeOverrideString,timeAwareMode:this.timeAwareMode,tileInfo:this.tileInfo&&"function"==typeof this.tileInfo.toJson?this.tileInfo.toJson():void 0,supportsDynamicLayers:this.supportsDynamicLayers,hasLayerCatalog:this.hasLayerCatalog,includeInLayerList:this.includeInLayerList,drawingBehavior:this.drawingBehavior,layerOptions:this.layers.map(function(e){return e.toJson()}),catalogId:this.catalogId,isUserCreated:this.isUserCreated,userLayerType:this.userLayerType,tables:this.tables.map(function(e){return e.toJson()}),layerHyperlinks:this.layerHyperlinks.map(function(e){return e.toJson()}),properties:p._propertiesToJson(this.properties),extensions:p._extensionsToJson(this.extensions)};return this.featureClustering&&(e.featureClustering=dojo.clone(this.featureClustering)),this.heatMap&&(e.featureHeatMap=dojo.clone(this.heatMap),e.featureHeatMap.defaultRenderer instanceof esri.renderer.Renderer&&(e.featureHeatMap.defaultRenderer=e.featureHeatMap.defaultRenderer.toJson())),e},r.prototype._configureObject=function(e,t){var i=this;if(g.isNullOrUndefined(e)||g.isNullOrUndefined(e.id)||g.isNullOrUndefined(e.displayName)||g.isNullOrUndefined(e.serviceType)||g.isNullOrUndefined(e.connectionString))throw new Error("Incorrect map service object returned from initialization");if(this.id=e.id,this.mapServiceType=e.serviceType,this.mapServiceFunction=g.isNullOrUndefined(e.serviceFunction)?this.mapServiceFunction:e.serviceFunction,this.displayName=e.displayName,this.shortDisplayName=e.shortDisplayName,this.baseMapGroup=e.baseMapGroup,this.baseMapGroupIndex=e.baseMapGroupIndex,this.baseMapGroupIsMutuallyExclusive=e.baseMapGroupIsMutuallyExclusive,this.description=g.isNullOrUndefined(e.description)?this.description:e.description,this.copyright=e.copyright,this.attributionDataUrl=e.attributionDataUrl,this.hasAttributionData=e.hasAttributionData,this.configuredVisible=!!e.visible,this.disableClientCaching=!!e.disableClientCaching,this.instantSearch=!!e.instantSearch,this.configuredOpacity=g.isNullOrUndefined(e.opacity)||null===e.opacity?this.configuredOpacity:e.opacity,this.opacity=this.configuredOpacity,this.imageFormat=g.isNullOrUndefined(e.format)?this.imageFormat:e.format,!g.isNullOrUndefined(e.updateInterval)){var r=e.updateInterval;r&&r<10&&0!==r&&(r=10),this.updateInterval=r,this._resetUpdateTimer()}if(this.tileRestUrl=e.tileRestUrl,this.mapUrl=e.mapUrl,this.subDomains=(e.subDomains||[]).slice(),this.isExpanded=g.isNullOrUndefined(e.isExpanded)?this.isExpanded:e.isExpanded,this.isUserCreated=g.isNullOrUndefined(e.isUserCreated)?this.isUserCreated:e.isUserCreated,this.userLayerType=g.isNullOrUndefined(e.userLayerType)?this.userLayerType:e.userLayerType,this.catalogId=g.isNullOrUndefined(e.catalogId)?this.catalogId:e.catalogId,this.serverVersion=e.serverVersion,this.failureAction=e.failureAction,this.failureTimeout=e.failureTimeout,this.tileMatrixSet=e.tileMatrixSet,this.requestEncoding=e.requestEncoding,this.operationalSpatialReference=e.operationalSpatialReference,this.dataProvider=e.dataProvider,this.minScale=e.minScale,this.maxScale=e.maxScale,this.identifiable=!!e.identifiable,this.includeCatalogItems=!!e.includeCatalogItems,this.includeMosaicDatasetValues=!!e.includeMosaicDatasetValues,this.defaultDateFormat=e.defaultDateFormat,this.defaultNumberFormat=e.defaultNumberFormat,this.timeZoneId=e.timeZoneId,this.serviceTag=e.serviceTag,this._restStartTimeOverrideString=e.startTime||null,this._restEndTimeOverrideString=e.endTime||null,e.timeAwareMode&&(this.timeAwareMode=e.timeAwareMode),e.tileInfo&&(this.tileInfo=dojo.clone(e.tileInfo),this.tileInfo.spatialReference&&(this.tileInfo.spatialReference.wkid?this.tileInfo.spatialReference=new esri.SpatialReference(this.tileInfo.spatialReference.wkid):this.tileInfo.spatialReference=new esri.SpatialReference(this.tileInfo.spatialReference.wkt))),"boolean"==typeof e.includeInLayerList&&(this.includeInLayerList=e.includeInLayerList),this.isUserCreated)this._initiallyVisible=void 0===e.initiallyVisible?!!e.visible:!!e.initiallyVisible;else if(null!=this.essentialsMap.layerThemesInfo.startupThemeId&&this.includeInLayerList?this._initiallyVisible=!1:this._initiallyVisible=void 0===e.initiallyVisible?!!e.visible:!!e.initiallyVisible,e.themeSettings&&e.themeSettings.length)for(var n=0,s=e.themeSettings;n<s.length;n++){var l=s[n],c=this.essentialsMap.layerThemesInfo.getTheme(l.themeID);if(c){var u=g.isNullOrUndefined(l.visible)?this.configuredVisible:l.visible;this.layerThemeSettings.push(new a.LayerThemeSetting(c,u)),c.id===this.essentialsMap.layerThemesInfo.startupThemeId&&this.includeInLayerList&&(this._initiallyVisible=void 0===l.initiallyVisible?u:l.initiallyVisible)}}if(this.supportsDynamicLayers=void 0===e.supportsDynamicLayers?this.supportsDynamicLayers:e.supportsDynamicLayers,this.hasLayerCatalog=void 0===e.hasLayerCatalog?this.hasLayerCatalog:e.hasLayerCatalog,e.iconUri){var d=null;this.essentialsMap&&(d=this.essentialsMap.site),this.iconUri=h.RestHelper.processClientSideTokens(d,e.iconUri)}e.featureClustering&&(this.featureClustering={enabled:e.featureClustering.enabled,userCanToggle:e.featureClustering.userCanToggle,radius:e.featureClustering.radius,maximumFeatures:e.featureClustering.clusterSize,backgroundColor:e.featureClustering.backgroundColor,labelColor:e.featureClustering.labelColor}),e.featureHeatMap&&(this.heatMap={enabled:e.featureHeatMap.enabled,userCanToggle:e.featureHeatMap.userCanToggle,respectScaleRange:e.featureHeatMap.respectScaleRange,gradient:(e.featureHeatMap.gradient||[]).slice(),offset:(e.featureHeatMap.offset||[]).slice(),intensity:e.featureHeatMap.intensity,field:e.featureHeatMap.field,defaultRenderer:e.featureHeatMap.defaultRenderer?esri.renderer.fromJson(e.featureHeatMap.defaultRenderer):null,defaultMinScale:e.featureHeatMap.defaultMinScale,defaultMaxScale:e.featureHeatMap.defaultMaxScale,includeInLegend:e.featureHeatMap.includeInLegend}),this.drawingBehavior=void 0===e.drawingBehavior?this.drawingBehavior:e.drawingBehavior,this._processConnectionString(e.connectionString,e),this._processProxyInfo(e.proxyInfo);var f=e.layers||e.layerOptions;this._configureLayers(f,t),this._configureTables(e.tables,t),e.hasOwnProperty("layerHyperlinks")&&e.layerHyperlinks.forEach(function(e){i.layerHyperlinks.push(new o.LayerHyperlink(e,i))}),t&&(this.isInitialized=!0),this.properties=p._getProperties(e.properties),this.extensions=p._getExtensions(e.extensions),this.setOpacity(this.configuredOpacity)},r.prototype._updateServiceToken=function(e){if(this.serviceToken=e,this.serviceLayer&&this.serviceLayer._url){var t=this.serviceLayer._url;if(t.query){t.query.token=e;var i=dojo.objectToQuery(t.query);this.serviceLayer.url=t.path+(i?"?"+i:"")}}this._updateCredentialForLayer(),dojo.publish("ServiceTokenRefreshed",{serviceUrl:this.serviceUrl,token:e})},r.prototype._addDefinitionExpression=function(e,t){if(!e)throw new Error("Expecting a layer");if((t=t||this.serviceLayer)instanceof esri.layers.ArcGISDynamicMapServiceLayer){var i=e.getDefinitionExpression(null);if(i){var r=parseInt(e.id,10),n=t.layerDefinitions||[];if(!r)throw new Error("Failed to add definition expression for "+e.displayName);n[r]=i,t.setLayerDefinitions(n)}}},r.prototype._removeDefinitionExpression=function(e,t){if(e&&(t=t||this.serviceLayer)&&t instanceof esri.layers.ArcGISDynamicMapServiceLayer){var i=parseInt(e.id,10);if(i&&t.layerDefinitions){var r=t.layerDefinitions;r[i]&&(r.splice(i,1),t.setLayerDefinitions(r))}}},r.prototype._createServiceLayer=function(){var e=this;if(null==this.serviceLayer){var i=this.serviceUrl;if(null!=this.serviceToken&&this.mapServiceType!==n.MapServiceType.VECTORTILE&&(i=f.RestHelperHTTPService.appendTokenToUrl(i,this.serviceToken)),"MapService"===this.drawingBehavior){var s;switch(this.mapServiceType){case n.MapServiceType.DYNAMIC:this._needsProxy&&(esri.config.defaults.io.alwaysUseProxy=!0);var a=new esri.layers.ArcGISDynamicMapServiceLayer(i,{id:this.id});this._applyAttributionUrl(a);var o=this.getVisibleLayers();0===o.length?a.setVisibleLayers&&(0===this.layers.length?a.setVisibleLayers(o,!1):a.setVisibleLayers(["-1"],!1)):a.setVisibleLayers&&a.setVisibleLayers(o,!1);for(var l=0,u=this.layers;l<u.length;l++){var p=u[l];this._addDefinitionExpression(p,a)}this.layerVisibilityEventManager=new c.LayerVisibilityEventManager(this,a),a.setImageFormat(this._getAgsDynamicImageFormat(this.imageFormat)),dojo.connect(a,"onError",this,this._layerLoadErrorHandler),dojo.connect(a,"onLoad",this,function(){this._handleServiceLayerLoaded(a),this._handleDynamicLayers(a)}),this._initiallyVisible?a.show():a.hide(),this.serviceLayer=a;break;case n.MapServiceType.TILED:var h=new esri.layers.ArcGISTiledMapServiceLayer(i,{id:this.id});this._applyAttributionUrl(h),dojo.connect(h,"onError",dojo.hitch(this,this._layerLoadErrorHandler)),dojo.connect(h,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded)),this._initiallyVisible?h.show():h.hide(),this.serviceLayer=h;break;case n.MapServiceType.IMAGE:var y=null;this._hasTileLevels()?y=new esri.layers.ArcGISTiledMapServiceLayer(i,{id:this.id}):(y=new esri.layers.ArcGISImageServiceLayer(i,{id:this.id})).setImageFormat(this._getAgsImageServiceImageFormat(this.imageFormat)),this._applyAttributionUrl(y),dojo.connect(y,"onError",this,this._layerLoadErrorHandler),dojo.connect(y,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded)),this._initiallyVisible?y.show():y.hide(),this.serviceLayer=y;break;case n.MapServiceType.BING:var m=new esri.virtualearth.VETiledLayer(this.bingProperties);dojo.connect(m,"onError",this,this._layerLoadErrorHandler),dojo.connect(m,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded)),this._initiallyVisible?m.show():m.hide(),this.serviceLayer=m;break;case n.MapServiceType.WMS:if(!dojo.isObject(esri.layers.WMSLayer))throw new Error("This Javascript application must require the esri.layers.wms package in order to use a site with a WMS service.");this._extendWms();for(var v=!1,_=0,S=this.layers;_<S.length;_++)if((p=S[_]).wmsLayerName){v=!0;break}var L;if(v){if(s={extent:this.essentialsMap.initialExtent,layerInfos:this._constructWmsLayerInfos(),version:this.serverVersion},L=new esri.layers.WMSLayer(i,{resourceInfo:s,visibleLayers:this._getWmsVisibleLayers()}),null!=this.operationalSpatialReference){var T=parseInt(this.operationalSpatialReference.replace(/^.*:/,""),10);L.spatialReferences.push(T),L.preferredSpatialReference=T}dojo.connect(L,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded))}else L=new esri.layers.WMSLayer(i),dojo.connect(L,"onLoad",dojo.hitch(this,this._finishWmsLayerConfiguration));if(this._restStartTimeOverrideString&&this._restEndTimeOverrideString&&!L.timeInfo){var b=r.getGcxTimeInfo(null,this._restStartTimeOverrideString,this._restEndTimeOverrideString);if(b){var E={timeExtent:new esri.TimeExtent(b.timeExtent.startTime,b.timeExtent.endTime)};L.timeInfo=E}}L.id=this.id,this._applyAttributionUrl(L),this.layerVisibilityEventManager=new c.LayerVisibilityEventManager(this,L),L.setImageFormat(this._getEsriWmsImageFormat()),L.__gcxWmsImageFormat=this.imageFormat,dojo.connect(L,"onError",this,this._layerLoadErrorHandler),this._initiallyVisible?L.show():L.hide(),this.serviceLayer=L,this._corsRequest(this._prefixProxy(i)).then(function(){L.refresh()},function(e){L.refresh()});break;case n.MapServiceType.WMTS:if(!dojo.isObject(esri.layers.WMTSLayer))throw new Error("This JavaScript application must require the esri.layers.wmts package in order to use a site with WMTS service.");if(0===this.layers.length)throw new Error("You must include at least one layer in your WMTS. Service "+this.displayName+" has 0 layers.");var I=this.layers[0].fullExtent?this.layers[0].fullExtent:this.essentialsMap.fullExtent;this.tileInfo&&this.tileInfo.dpi&&96!==this.tileInfo.dpi&&this.tileInfo.lods.forEach(function(t){return t.scale=t.scale/e.tileInfo.dpi*96}),this.tileInfo.dpi=96;var x={900913:102100,3857:102100};if(this.tileInfo){var w=x[this.tileInfo.spatialReference.wkid];if(w){var M=new esri.SpatialReference(w);this.tileInfo.spatialReference=M,g.isNullOrUndefined(x[I.spatialReference.wkid])||(I.spatialReference=M)}}4326===this.tileInfo.spatialReference.wkid&&this.tileInfo.origin.y>90&&(this.tileInfo.origin=new esri.geometry.Point(this.tileInfo.origin.x,90,this.tileInfo.spatialReference));var R={tileInfo:this.tileInfo,fullExtent:I,initialExtent:I,identifier:this.layers.length>0?this.layers[0].name:null,tileMatrixSet:this.tileMatrixSet,format:this._getEsriOgcImageFormat(),style:this.layers[0].styleName?this.layers[0].styleName:""},O=new esri.layers.WMTSLayerInfo(R),D={serviceMode:"KVP",resourceInfo:s={version:this.serverVersion,layerInfos:[O],getTileUrl:this._prefixProxy(this.mapUrl)},layerInfo:O,id:this.id},C=new esri.layers.WMTSLayer(i,D);if(this._applyAttributionUrl(C),C._url){var P=0,U=d.hasProxy()?2:1;C._url=C._url.replace(/\?/g,function(e){return P++,P<=U?"?":""})}dojo.connect(C,"onError",this,this._layerLoadErrorHandler),dojo.connect(C,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded)),this._initiallyVisible?C.show():C.hide(),this.serviceLayer=C;break;case n.MapServiceType.WEBTILED:var F=i.replace(/([^$])({[^}]*})/g,function(e,t,i){return t+"$"+i}),k={copyright:this.copyright,id:this.id,subDomains:null,tileInfo:this._tileScheme?this.tileInfo:null};F.indexOf("${subDomain}")>=0&&(k.subDomains=this.subDomains);var A=new esri.layers.WebTiledLayer(F,k);A.id=this.id,this._applyAttributionUrl(A),this._initiallyVisible?A.show():A.hide(),dojo.connect(A,"onError",this,this._layerLoadErrorHandler),dojo.connect(A,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded)),this.serviceLayer=A;break;case n.MapServiceType.VECTORTILE:var N=i;this._styleUrl&&(N=this._styleUrl),t(["esri/layers/VectorTileLayer"],function(t){e._addCredentialForLayer();var i=new t(N);i.id=e.id,i.loadError&&e._layerLoadErrorHandler(i.loadError),dojo.aspect.before(i,"_frame",dojo.hitch(i,function(){this._frameRequested&&this.spatialReference&&this._viewState&&!this._viewState.spatialReference&&(this._viewState.spatialReference=this.spatialReference)})),e._initiallyVisible?i.show():i.hide(),dojo.connect(i,"onError",e,e._layerLoadErrorHandler),dojo.connect(i,"onLoad",dojo.hitch(e,e._handleServiceLayerLoaded)),e._applyAttributionUrl(i),e.serviceLayer=i})}this.initiateServiceFailureTimer()}}},r.prototype.initiateServiceFailureTimer=function(){var e=this;this.failureTimeout&&!isNaN(this.failureTimeout)&&setTimeout(function(){e.serviceLayer&&(!e.serviceLayer||e.serviceLayer.loaded)||e.initializationFailure||(e.failureTimeoutThresholdExceeded=!0,e.onFailureTimeoutThresholdExceeded())},1e3*this.failureTimeout)},r.prototype._addCredentialForLayer=function(){var e=esri.id,t=this.findServiceToken(),i=e.credentials;if(t&&e&&i instanceof Array){for(var r=0;r<i.length;r++)if(i[r].server===this.url){i.splice(r,1);break}var n=new esri.Credential;n.token=t,this._layerSecurityProxy?n.server=this.url:n.server=esri.id._getServerInstanceRoot(this.serviceUrl),n.resources=[this.serviceUrl],n.scope=esri.id._isServerRsrc(this.serviceUrl)?"server":"portal",this.url.startsWith("https")?n.ssl=!0:n.ssl=!1,i.push(n)}},r.prototype._updateCredentialForLayer=function(){var e=esri.id,t=this.findServiceToken(),i=e.credentials;if(t&&e&&i instanceof Array)for(var r=0,n=i;r<n.length;r++){var s=n[r];if(s.server===this.url){s.token=this.serviceToken;break}}},r.prototype._applyAttributionUrl=function(e){if(this.attributionDataUrl&&""!==this.attributionDataUrl)e.attributionDataUrl=this.attributionDataUrl,e.hasAttributionData=!0;else if(this.hasAttributionData){e.attributionDataUrl=this.url+"/attribution",e.hasAttributionData=!0;var t=f.RestHelperHTTPService.getTokenForScope(e.attributionDataUrl);t&&(e.attributionDataUrl=f.RestHelperHTTPService.appendTokenToUrl(e.attributionDataUrl,t))}},r.prototype._prefixProxy=function(e){return this.proxyUrl?this.proxyUrl+"?"+e:e},r.prototype._constructWmsLayerInfos=function(){for(var e=[],t=0,i=this.layers;t<i.length;t++){var r=i[t];if(null!=r.wmsLayerName){var n=new esri.layers.WMSLayerInfo({name:r.wmsLayerName,title:r.name});n.styleName=r.styleName,e.push(n)}}return e},r.prototype._getWmsVisibleLayers=function(){for(var e=[],t=0,i=this.layers;t<i.length;t++){var r=i[t];r.isVisible()&&r.areAllAncestorsVisible()&&null!=r.wmsLayerName&&0===r.subLayerIds.length&&e.push(r.wmsLayerName)}return e},r.prototype._applyWmsLayerVisibility=function(){var e=this._getWmsVisibleLayers();this.serviceLayer.setVisibleLayers(e)},r.prototype._getEsriWmsImageFormat=function(){var e=this._getEsriOgcImageFormat();return"jpeg"===e&&(e="jpg"),e},r.prototype._getEsriOgcImageFormat=function(){return null!=this.imageFormat?this.imageFormat.replace(/^image\//,""):null},r.prototype._findWMSLayerName=function(e,t){for(var i in e)if(e.hasOwnProperty(i)){var r=e[i];if(r.title===t)return r.name;if(null!==r.subLayers&&r.subLayers.length>0){var n=this._findWMSLayerName(r.subLayers,t);if(null!==n)return n}}return null},r.prototype._finishWmsLayerConfiguration=function(e){for(var t,i=[],r=0,n=0,s=this.layers;n<s.length;n++){var a=s[n];!a.configuredVisible||null!==a.subLayerIds&&0!==a.subLayerIds.length||(null!==a.parentLayerId?this.findLayerById(a.parentLayerId).configuredVisible&&(t=this._getWMSLayerNameFromTitle(a.name),a.wmsLayerName=t,null!==t&&""!==t&&(i[r]=t,r++)):(t=this._getWMSLayerNameFromTitle(a.name),a.wmsLayerName=t,null!==t&&""!==t&&(i[r]=t,r++)))}this.serviceLayer.setVisibleLayers(i),this._handleServiceLayerLoaded(e)},r.prototype._handleServiceLayerLoaded=function(e){this._configureTimeInfo(),this.isServiceLayerLoaded=!0,this.essentialsMap&&this.essentialsMap.site&&dojo.isFunction(this.essentialsMap.site.onLayerLoad)&&this.essentialsMap.site.onLayerLoad(e)},r.prototype.convertToDynamicLayers=function(){var e=this.serviceLayer;e&&e instanceof esri.layers.ArcGISDynamicMapServiceLayer&&(e.dynamicLayerInfos||e.setDynamicLayerInfos(this._createDynamicLayerInfos(e)),e.layerDrawingOptions||(e.layerDrawingOptions=[]))},r.prototype._layerLoadErrorHandler=function(e){e&&e.message&&0===e.message.indexOf("Unable to load tile")||(this.initializationFailure=e,this.essentialsMap&&this.essentialsMap.site&&dojo.isFunction(this.essentialsMap.site.onLayerLoadError)&&(this._layerLoadErrorHandler=this.essentialsMap.site.onLayerLoadError))},r.prototype.remove=function(e){if(!e)throw new Error("Expecting a layer.");var t=this.serviceLayer;if(!(e.isDynamic&&this.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer&&this.serviceLayer))throw new Error("MapService - remove() - Unsupported Layer Type.");this.convertToDynamicLayers();var i=parseInt(e.id,10),r=this.findLayerById(e.id);null!=r&&(c=this.layers.indexOf(r))>-1&&(r.setInActiveTheme(!1),this.layers.splice(c,1),dojo.publish("CatalogLayerRemovedEvent",r));var n=this.getVisibleLayers();if(null==i)throw new Error("Could not convert Layer ID '"+e.id+"' into an integer!");var s=[];t.dynamicLayerInfos&&(s=dojo.clone(this.serviceLayer.dynamicLayerInfos));var a=[];if(t.layerDrawingOptions&&(a=this.serviceLayer.layerDrawingOptions),e.isDynamic){for(var o=null,l=0;l<s.length;l++)if(s[l].id===i){o=s[l];break}if(o){var c=s.indexOf(o);c>-1&&(s.splice(c,1),t.setDynamicLayerInfos(s,!0))}var u=[];for(var p in a)a.hasOwnProperty(p)&&p!==e.id&&(u[p]=dojo.clone(a[p]));this._removeDefinitionExpression(e,t),t.setLayerDrawingOptions(u)}n.indexOf(e.id)>-1&&n.splice(n.indexOf(e.id),1),this._syncLayerVisibilities(n)},r.prototype.add=function(e){if(!e)throw new Error("Expecting a layer");var t=this.serviceLayer;if(!(e.isDynamic&&t instanceof esri.layers.ArcGISDynamicMapServiceLayer))throw new Error("MapService - add() - Unsupported layer type..");this.convertToDynamicLayers();var i=this.getVisibleLayers();e.mapService=this;var r=[];t.dynamicLayerInfos&&(r=t.dynamicLayerInfos);var n=[];t.layerDrawingOptions&&(n=t.layerDrawingOptions);var s=void 0,a=void 0,o=parseInt(e.id,10);if(null==o)throw new Error("Could not convert Layer ID '"+e.id+"' into an integer!");(s=e._createDynamicLayerInfo()).name||(s.name=e.displayName),null!=s&&r.push(s),null!=(a=e.getLayerDrawingOptions())&&(n[o]=a),n.length>0&&t.setLayerDrawingOptions(n,!0),this._addDefinitionExpression(e,t),t.setDynamicLayerInfos(r),i.push(e.id),this._syncLayerVisibilities(i),this.layers.push(e),dojo.publish("CatalogLayerAddedEvent",e)},r.prototype.getDynamicLayerInfoById=function(e){var t=null;if(this.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer){var i=parseInt(e,10);if(!isNaN(i)){var r=this.serviceLayer.dynamicLayerInfos;if(r)for(var n=0;n<r.length;n++)r[n].id===i&&(t=r[n])}}return t},r.prototype._syncLayerVisibilities=function(e){for(var t=0,i=this.layers;t<i.length;t++){var r=i[t];e.indexOf(r.id)>-1?r.visibleStateForRefresh=y.RefreshVisibility.SHOW:r.visibleStateForRefresh=y.RefreshVisibility.HIDE}0===e.length&&e.push("-1"),this.serviceLayer.setVisibleLayers(e)},r.prototype._handleDynamicLayers=function(e){var t=this;if(this.supportsDynamicLayers){var i=dojo.some(this.layers,function(e){return e.isDynamic}),r=dojo.some(this.layers,function(e){return null!=e.drawIndex}),n=dojo.some(this.layers,function(e){return e.canToggleLabels&&!e.showLabels});if(i||r||n||this.hasLayerCatalog){var s=this.essentialsMap.getMap();if(s&&(s.spatialReference&&(s.spatialReference.wkid&&!(s.spatialReference.wkid<=0)||s.spatialReference.wkt&&s.spatialReference.wkt.trim())||null!=e.spatialReference&&e.spatialReference.wkt&&e.spatialReference.wkt.trim()&&(s.spatialReference=e.spatialReference),s.extent&&(!s.extent.spatialReference||(!s.extent.spatialReference.wkid||s.extent.spatialReference.wkid<=0)&&(!s.extent.spatialReference.wkt||!s.extent.spatialReference.wkt.trim()))&&null!=e.spatialReference&&e.spatialReference.wkt&&e.spatialReference.wkt.trim())){var a=new esri.geometry.Extent(s.extent);a.spatialReference=e.spatialReference,this.essentialsMap.extentManager.setExtentWithPriority(a,2)}var o=this._createDynamicLayerInfos(e),l=[];if(e.layerDrawingOptions&&(l=dojo.mixin([],e.layerDrawingOptions)),n&&dojo.forEach(this.layers,function(e,t){if(e.canToggleLabels){var i=e.getLayerDrawingOptions();if(null==i){i=new esri.layers.LayerDrawingOptions;var r=parseInt(e.id,10);l[r]=i}i.showLabels=e.showLabels}}),dojo.forEach(this.layers,function(e,t){if(e.isDynamic){var i=void 0,r=void 0,n=parseInt(e.id,10);if(isNaN(n))throw new Error("Could not convert Layer ID '"+e.id+"' into an integer!");(i=e._createDynamicLayerInfo()).name||(i.name=e.name),i&&o.splice(t,0,i),(r=e.getLayerDrawingOptions())&&(l[n]=r,null!=e.showLabels&&(r.showLabels=e.showLabels))}}),r){var c=dojo.clone(o),u=[];dojo.forEach(this.layers,function(e,t){null!=e&&null!=e.drawIndex&&u.push(e)}),u.sort(function(e,t){return e.drawIndex-t.drawIndex}),dojo.forEach(u,function(e,t){for(var i=null,r=null,n=0;n<c.length;n++){var s=c[n];if(s.id.toString()==e.id){i=s,r=n;break}}null!=i&&null!=r&&(c.splice(r,1),c.push(i))}),o=[],dojo.forEach(c,function(e,t){o.push(e)})}setTimeout(function(){e.visibleLayers;l.length>0&&e.setLayerDrawingOptions(l,!0),o.length>0&&e.setDynamicLayerInfos(o,!0);var i=t.getVisibleLayers();i.InternallyChangedLayer={},i.length>0?e.setVisibleLayers(i):(i.push("-1"),e.setVisibleLayers(i))})}}},r.prototype._createDynamicLayerInfos=function(e,t){g.isNullOrUndefined(t)&&(t=!0);var i=null;if(null!=e&&(i=e.createDynamicLayerInfosFromLayerInfos(),t))for(var r=i.length-1;r>=0;r--){var n=this.findLayerById(i[r].id.toString());(null==n||n.isDynamic)&&i.splice(r,1)}return i},r.prototype._getAgsDynamicImageFormat=function(e){if(void 0===e||null===e||e.length<1)return"png8";var t=e.toLowerCase();switch(t){case"png":case"png8":case"png24":case"png32":case"jpeg":case"jpg":case"gif":case"bmp":case"svg":case"svgz":case"emf":case"ps":case"pdf":return t;default:return"png8"}},r.prototype._getAgsImageServiceImageFormat=function(e){if(void 0===e||null===e||e.length<1)return null;var t=e.toLowerCase();switch(t){case"jpgpng":case"png":case"png8":case"png24":case"png32":case"jpeg":case"jpg":case"gif":case"bmp":case"tiff":return t;default:return null}},r.prototype._getVisibleGroupLayersOfType=function(e,t,i,r){if(t[e])for(var n=0,s=t.subLayerIds;n<s.length;n++){var a=s[n],o=this.findLayerById(a);o[e]&&(null!==o.subLayerIds&&o.subLayerIds.length>0?r=this._getVisibleGroupLayersOfType(e,o,i,r):dojo.indexOf(i,o.id)<0&&(i[r=this._addAnnotationSublayers(o,i,r)]=o.id,r++))}return r},r.prototype._getWMSLayerNameFromTitle=function(e){return this.serviceLayer instanceof esri.layers.WMSLayer?this._findWMSLayerName(this.serviceLayer.layerInfos,e):null},r.prototype._getPrincipalResult=function(e){if(this.essentialsMap&&this.essentialsMap.site&&this.essentialsMap.site.principal)return e(this.essentialsMap.site.principal)},r.prototype._processConnectionString=function(e,t){var i=m.ServiceHelper.extractConnectionStringValue;if(this.mapServiceType===n.MapServiceType.BING){this.bingProperties={};var r=void 0;(r=i(e,"mapStyle"))&&r.length>0&&(this.bingProperties.mapStyle=r),(r=i(e,"culture"))&&r.length>0&&(this.bingProperties.culture=r),(r=i(e,"key"))&&r.length>0&&(this.bingProperties.bingMapsKey=r)}else{var s=i(e,"url");if(s.length>0)this.serviceUrl=s.replace(/%3d/g,"=").replace(/%3D/g,"=").replace(/%3a/g,":").replace(/%3A/g,":");else if((this.mapServiceType===n.MapServiceType.DYNAMIC||this.mapServiceType===n.MapServiceType.TILED)&&this.essentialsMap.site.getEssentialsVersion()>=3.912||(this.mapServiceType===n.MapServiceType.FEATURE||this.mapServiceType===n.MapServiceType.IMAGE||this.mapServiceType===n.MapServiceType.STREAM||this.mapServiceType===n.MapServiceType.VECTORTILE)&&this.essentialsMap.site.getEssentialsVersion()>=4.01){if(this._layerSecurityProxy=!0,this.essentialsMap.site.getEssentialsVersion()<4.03)this.serviceUrl=this.url+"/MapServer";else{var a=this.essentialsMap.site.getEssentialsVersion()<4.05?"/GeoREST":"/rest/services/x";if(this.mapServiceType===n.MapServiceType.FEATURE){if(!(t&&t.layers&&t.layers.length>0&&t.layers[0]))throw new Error("Unable to configure FeatureLayer connection string. No child layer is specified.");this.serviceUrl=this.url+a+"/FeatureServer/"+t.layers[0].id}else this.mapServiceType===n.MapServiceType.IMAGE?this.serviceUrl=this.url+a+"/ImageServer":this.mapServiceType===n.MapServiceType.STREAM?this.serviceUrl=this.url+a+"/StreamServer":this.mapServiceType===n.MapServiceType.VECTORTILE?this.serviceUrl=this.url+a+"/VectorTileServer":this.serviceUrl=this.url+a+"/MapServer"}this._getPrincipalResult(function(e){return e.isAuthenticated})&&(this.serviceToken=this._getPrincipalResult(function(e){return e.tokens.site})),"3.912"===this.essentialsMap.site.currentVersion&&(this._needsProxy=!0)}var o=i(e,"geometryServiceUrl");o.length>0&&(this.geometryServiceUrl=o),this.mapServiceType===n.MapServiceType.VECTORTILE&&(this._styleUrl=i(e,"styleUrl")),this.mapServiceType===n.MapServiceType.WEBTILED&&(this._tileScheme=i(e,"tileScheme")),this.essentialsMap&&this.essentialsMap.site&&!this.serviceToken&&(this.serviceToken=this.essentialsMap.site.getTokenFromPrincipal(this.serviceUrl,this.mapServiceType));var l=i(e,"token"),c=this.essentialsMap&&this.essentialsMap.site?this.essentialsMap.site.arcGisPortalSecurityContext:null;l.length>0?this.serviceToken=l:c&&c.appliesTo(this.serviceUrl)&&c.tokenResult&&(this.serviceToken=c.tokenResult.token);var u=i(e,"proxy");u.length>0&&(this.proxyUrl=u,esri.addProxyRule({urlPrefix:this.serviceUrl,proxyUrl:u}),this.serviceUrl.indexOf("services.arcgis")>-1&&esri.addProxyRule({urlPrefix:this.serviceUrl.replace("services.arcgis","server.arcgis"),proxyUrl:u}));var p=i(e,"mapUrl");p.length>0&&(this.mapUrl=p.replace(/%3d/g,"=").replace(/%3D/g,"="));var h=i(e,"tileRestUrl");h.length>0&&(this.tileRestUrl=h.replace(/%3d/g,"=").replace(/%3D/g,"="));var d=i(e,"subDomains");d&&(this.subDomains=d.split(","))}},r.prototype._isLocalProxyInfo=function(e){return!!e&&("local-reverse-proxy"===e.type&&!!e.address)},r.prototype._processProxyInfo=function(e){if(this._isLocalProxyInfo(e)){for(var t=(this.url+"/../../../../../"+e.address).split("/"),i=t.indexOf("..");i>0;i=t.indexOf(".."))t.splice(i-1,2);this.serviceUrl=t.join("/")}},r.prototype.supportsLayerVisibility=function(){switch(this.mapServiceType){case n.MapServiceType.WMS:return!0;case n.MapServiceType.DYNAMIC:return null!==this.serviceLayer&&!!this.serviceLayer.visibleLayers;case n.MapServiceType.GRAPHICS:case n.MapServiceType.FEATURE:case n.MapServiceType.CSV:case n.MapServiceType.LABEL:case n.MapServiceType.STREAM:case n.MapServiceType.GEORSS:case n.MapServiceType.KML:case n.MapServiceType.BING:case n.MapServiceType.TILED:case n.MapServiceType.WMTS:case n.MapServiceType.IMAGE:case n.MapServiceType.WEBTILED:case n.MapServiceType.VECTORTILE:case n.MapServiceType.MAPIMAGE:case n.MapServiceType.UNKNOWN:default:return!1}},r.prototype._setVisibility=function(e,t,i){var r={mapServiceId:this.id,layerId:e,visibility:t};void 0===i&&(i=!1);var s,a,o;switch(this.mapServiceType){case n.MapServiceType.DYNAMIC:if(null!==this.serviceLayer){if(!this.serviceLayer.visibleLayers){t?this.serviceLayer.show():this.serviceLayer.hide(),dojo.publish("LayerVisibilityChange",[new Array(r)]);break}var l=this.getVisibleLayers();l.InternallyChangedLayer=r,0===l.length&&l.push("-1"),this.serviceLayer.setVisibleLayers&&this.serviceLayer.setVisibleLayers(l,i)}break;case n.MapServiceType.WMS:if(null!==this.serviceLayer){var c=[];for(c.InternallyChangedLayer=r,s=0,a=0;a<this.layers.length;a++)if((o=this.layers[a]).isVisible()&&(null===o.subLayerIds||0===o.subLayerIds.length)&&o.areAllAncestorsVisible()){var u=o.wmsLayerName;null!==u&&""!==u&&(c[s]=u,s++)}i?(this.serviceLayer.visibleLayers=c.slice(0),dojo.publish("LayerVisibilityChange",[new Array(r)])):this.serviceLayer.setVisibleLayers(c)}break;case n.MapServiceType.GRAPHICS:case n.MapServiceType.FEATURE:case n.MapServiceType.CSV:case n.MapServiceType.LABEL:case n.MapServiceType.STREAM:case n.MapServiceType.GEORSS:case n.MapServiceType.KML:case n.MapServiceType.BING:case n.MapServiceType.TILED:case n.MapServiceType.WMTS:case n.MapServiceType.IMAGE:case n.MapServiceType.WEBTILED:case n.MapServiceType.VECTORTILE:case n.MapServiceType.MAPIMAGE:case n.MapServiceType.WFS:if(null!==this.serviceLayer){if(1!==this.layers.length)throw new Error("Visibility of individual layers cannot be set for this Map Service: {0}".format(this.displayName));t?this.serviceLayer.show():this.serviceLayer.hide(),dojo.publish("LayerVisibilityChange",[new Array(r)])}break;default:throw new Error("Cannot set layer visibility. Unknown MapService type.")}},r.prototype._extendWms=function(){if(!r._wmsExtended){var e=esri.layers.WMSLayer._meta.hidden.getImageUrl,t=/.*images\/pixel.png$/,i=this;esri.layers.WMSLayer.extend({getImageUrl:function(r,s,a,o){var l=this;e.apply(this,[r,s,a,function(e){if(t.test(e))o(e);else{for(var r={},s=0;s<l.layerInfos.length;s++)r[l.layerInfos[s].name]=l.layerInfos[s].styleName;for(var a=[],s=0;s<l.visibleLayers.length;s++)a.push(r[l.visibleLayers[s]]);var c=a.join(","),u=e.substring(e.lastIndexOf("?")+1,e.length),p=dojo.queryToObject(u);if(p.STYLES=c,l.preferredSpatialReference&&(p[p.CRS?"CRS":"SRS"]="EPSG:"+l.preferredSpatialReference),l.__gcxWmsImageFormat&&(p.FORMAT=l.__gcxWmsImageFormat),i.timeAwareMode&&i.timeAwareMode!==n.TimeAwareMode.DISABLED){var h=l.getMap(),d=h&&h.timeExtent?h.timeExtent.startTime:l.timeInfo&&l.timeInfo.timeExtent&&l.timeInfo.timeExtent.startTime,f=h&&h.timeExtent?h.timeExtent.endTime:l.timeInfo&&l.timeInfo.timeExtent&&l.timeInfo.timeExtent.endTime;if(d&&f){var y=g.dateToISOStringNoMs(L.correctDatesToSubmitInDatabaseTime(d,L.getTimeZoneFromMapService(i),L.getDisplayTimeZoneFromMapService(i))),m=g.dateToISOStringNoMs(L.correctDatesToSubmitInDatabaseTime(f,L.getTimeZoneFromMapService(i),L.getDisplayTimeZoneFromMapService(i)));i.timeAwareMode===n.TimeAwareMode.RANGE&&(p.TIME=y+"/"+m),i.timeAwareMode===n.TimeAwareMode.INSTANT&&(p.TIME=m)}}l.disableClientCaching&&(p.t=Date.now());var v=e.substring(0,e.lastIndexOf("?")+1)+dojo.objectToQuery(p);o(v)}}])},setDisableClientCaching:function(e){this.disableClientCaching=!!e}}),r._wmsExtended=!0}},r.prototype._hasTileLevels=function(){return!!this.tileInfo&&(!!this.tileInfo.lods&&this.tileInfo.lods.length>0)},r.prototype.applyCatalogLayersChange=function(e){var t=this,i=!1,r=[];if(this.id==e.mapServiceId){for(var n=0,a=e.entries;n<a.length;n++){var o=a[n],l=this.findLayerById(o.id);l||(l=new s.Layer(this.url+"/layers/"+o.id),o.visible=!0,l.createFromDefinition(o),l.isUserCreated=!0,l.includeInLayerList=!0,l.setInActiveTheme(!0)),r.push(l)}var c=this.layers.filter(function(e){return e.isUserCreated&&r.indexOf(e)<0}),u=r.filter(function(e){return t.layers.indexOf(e)<0});return c.forEach(function(e){t.remove(e),i=!0}),u.forEach(function(e){t.add(e),i=!0}),i?(dojo.publish("MapServiceLayersChangedWithResultEvent",{mapService:this,newItems:[].concat(u),oldItems:[].concat(c)}),dojo.publish("CatalogLayersChangedEvent",this),u):[]}},r.prototype.getLayerThemeSettings=function(e){for(var t=0,i=this.layerThemeSettings;t<i.length;t++){var r=i[t];if(r.theme===e||r.theme.id===e)return r}return null},r.prototype.getFeatureLayer=function(){var e=this;if(this._featureLayerPromise)return this._featureLayerPromise;var t;if(this.serviceLayer instanceof esri.layers.FeatureLayer)t=this.serviceLayer;else{if(this.mapServiceType!==n.MapServiceType.IMAGE)return Promise.resolve(null);var i=this.serviceUrl;this.serviceToken&&(i=f.RestHelperHTTPService.appendTokenToUrl(i,this.serviceToken)),t=new esri.layers.FeatureLayer(i)}return t.loaded?this._featureLayerPromise=Promise.resolve(t):this._featureLayerPromise=new Promise(function(i,r){var n=t.on("load",function(){n.remove(),s.remove(),i(t)}),s=t.on("error",function(t){n.remove(),s.remove(),e._featureLayerPromise=null,r(t)})}),this._featureLayerPromise},r.prototype._resetUpdateTimer=function(){var e=this;g.isNullOrUndefined(this.updateInterval)||0===this.updateInterval?(window.clearInterval(this._updateIntervalId),this._updateIntervalId=null):(g.isNullOrUndefined(this._updateIntervalId)||window.clearInterval(this._updateIntervalId),this._updateIntervalId=setInterval(function(){e._onUpdateIntervalTick()},1e3*this.updateInterval))},r.prototype._onUpdateIntervalTick=function(){if(this.serviceLayer&&this.serviceLayer.refresh){var e=this;e.serviceLayer.setDisableClientCaching?(e.serviceLayer.setDisableClientCaching(!0),e.serviceLayer.refresh(),e.serviceLayer.setDisableClientCaching(e.disableClientCaching)):e.serviceLayer.refresh()}},r.prototype._addToFilteredView=function(e){e&&this._layerThemeLayerFilter(e)&&this.layersFilteredView.push(e)},r.prototype._layerThemeLayerFilter=function(e){return!e.mapService.essentialsMap.layerThemesInfo.layerThemesConfigured||e.inActiveTheme},r.prototype._getDefaultGeometryServiceUrl=function(){var e=this.essentialsMap?this.essentialsMap.site:null;return e&&e.geometryEndpoints&&e.geometryEndpoints.length>0?e.geometryEndpoints[0].geometryServiceUrl:null},r.prototype._getDefaultGeometryServiceToken=function(){var e=this.essentialsMap?this.essentialsMap.site:null;return e&&e.geometryEndpoints&&e.geometryEndpoints.length>0?e.geometryEndpoints[0].geometryServiceToken:null},r.prototype._corsRequest=function(e,i,r){var n=this;return new v.SimplePromise(function(s,a){try{t(["dojo/request"],function(t){return r=!!r,t(e,{headers:{"X-Requested-With":null},withCredentials:i=!!i}).response.then(function(e){return s()},function(t){return r?a(t):s(n._corsRequest(e,!i,!0))})})}catch(e){return console.log("Error in initializing WMS layer: "+e),a(e)}})},r}(r.AsyncInitializable);T._wmsExtended=!1,i.MapService=T})},"geocortex/essentials/MapServiceConstants":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});!function(e){e.DYNAMIC="Dynamic",e.TILED="Tiled",e.IMAGE="Image",e.BING="Bing",e.FEATURE="Feature",e.WMS="WMS",e.WFS="WFS",e.WMTS="WMTS",e.GEORSS="GeoRss",e.WEBTILED="WebTiled",e.VECTORTILE="VectorTile",e.KML="Kml",e.GRAPHICS="Graphics",e.LABEL="Label",e.STREAM="Stream",e.CSV="Csv",e.MAPIMAGE="MapImage",e.UNKNOWN="Unknown"}(t.MapServiceType||(t.MapServiceType={}));!function(e){e.OPERATIONAL="Operational",e.BASE="Base"}(t.MapServiceFunction||(t.MapServiceFunction={}));!function(e){e.MAP_SERVICE="MapService",e.FEATURE_LAYER="FeatureLayer",e.WFS_LAYER="WfsService",e.GEORSS_LAYER="GeoRssLayer",e.KML_SERVICE="KmlService",e.STREAM_LAYER="StreamLayer",e.GeoRSS_LAYER=e.GEORSS_LAYER}(t.DrawingBehavior||(t.DrawingBehavior={}));!function(e){e.IGNORE="Ignore",e.WARN="Warn",e.ERROR="Error"}(t.FailureAction||(t.FailureAction={}));!function(e){e.LAYER_ADDITION="LayerAddition",e.LAYER_CATALOG="LayerCatalog",e.UPLOAD="Upload"}(t.UserLayerType||(t.UserLayerType={}));!function(e){e.DISABLED="Disabled",e.INSTANT="Instant",e.RANGE="Range"}(t.TimeAwareMode||(t.TimeAwareMode={}))})},"geocortex/essentials/NamedExtent":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}();define(["require","exports","./AsyncInitializable","./../geocortex"],function(t,i,r,n){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var s=function(t){function i(e){var i=t.call(this,e)||this;return i.displayName=null,i.extensions=[],i.extent=null,i.id=null,i.properties={},i.site=null,i}return e(i,t),i.prototype.navigateTo=function(){if(this.site){var e=this.site.essentialsMap;e&&e.extentManager.setExtentWithPriority(this.extent,10)}},i.prototype._configureObject=function(e,t){if(void 0===e||void 0===e.id||void 0==e.displayName||void 0===e.extent)throw new Error("Incorrect named extent object returned from initialization");this.id=e.id,this.displayName=e.displayName,this.extent=new esri.geometry.Extent(e.extent),this.properties=n._getProperties(e.properties),this.extensions=n._getExtensions(e.extensions)},i}(r.AsyncInitializable);i.NamedExtent=s})},"geocortex/essentials/OAuth2Client":function(){define(["require","exports","./TokenResult","./utilities/DecomposedUri"],function(e,t,i,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(){}return e.getTokenFromImplicitGrant=function(){var e=window.location.href;if(e.indexOf("#")>0){var t=e.substring(e.indexOf("#")+1,e.length),r=dojo.queryToObject(t);if(!r.access_token)return null;var n=new i.TokenResult;n.token=r.access_token,n.userName=r.username;var s=parseInt(r.expires_in);return s&&(n.expiresOn=new Date((new Date).getTime()+1e3*s)),n}return null},e.getErrorFromImplicitGrant=function(){var e=window.location.href;if(e.indexOf("#")>0){var t=e.substring(e.indexOf("#")+1,e.length),i=dojo.queryToObject(t);if(i.error){var r=new s;return r.code=i.error,r.description=i.error_description,r}}return null},e.applicationHasImplicitGrant=function(){return e.hasFragmentParameter("access_token")},e.applicationHasImplicitGrantError=function(){return e.hasFragmentParameter("error")},e.hasFragmentParameter=function(e){var t=window.location.href;if(t.indexOf("#")<0)return!1;var i=(t=window.location.href).substring(t.indexOf("#")+1,t.length);return!!dojo.queryToObject(i)[e]},e.redirectToLogOnPage=function(t,i){var n=new r.DecomposedUri(window.location.href);e.removeImplicitGrantParams(n);var s=t+"?client_id="+encodeURIComponent(i)+"&response_type=token&redirect_uri="+encodeURIComponent(n.recompose())+"&expiration=20160";window.location.href=s},e.removeImplicitGrantParamsAndUpdateUrlHash=function(){var t=new r.DecomposedUri(window.location.href);e.removeImplicitGrantParams(t),window.location.hash=dojo.objectToQuery(t.fragment)},e.removeImplicitGrantParams=function(e){return delete e.fragment.access_token,delete e.fragment.username,delete e.fragment.expires_in,delete e.fragment.error,delete e.fragment.error_description,e},e}();t.OAuth2Client=n;var s=function(){return function(){}}();s.ACCESS_DENIED_ERROR_CODE="access_denied",t.OAuth2Error=s})},"geocortex/essentials/OfflineBasemap":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/Principal":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/PrintTemplate":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}();define(["require","exports","./AsyncInitializable","./Report","./exportMap/ExportMapParameters","./exportMap/ExportMapTask","./../geocortex"],function(t,i,r,n,s,a,o){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var l=function(t){function i(e){var i=t.call(this,e)||this;return i.description=null,i.displayName=null,i.extensions=[],i.id=null,i.visible=null,i.maximumResolution=300,i.properties=null,i.reportUrl=null,i.site=null,i.supportedMapScales=[],i.supportedOutputFormats=[],i.supportedResolutions=[],i.supportsEmailNotification=!1,i.textFields=[],i.grids=[],i.type=null,i.isDefault=!1,i.defaultMapScale=null,i.defaultMapScaleName=null,i.defaultResolution=null,i.defaultGrid=null,i.defaultOutputFormat=null,i._printing=!1,i._onPrintComplete=null,i._onPrintError=null,i.extensions=[],i.properties=[],i.supportedMapScales=[],i.supportedOutputFormats=[],i.supportedResolutions=[],i.textFields=[],i}return e(i,t),i.prototype.isPrinting=function(){return this._printing},i.prototype.print=function(e,t,i){var r=this;if(this.isPrinting())i&&i(new Error("Template already printing"));else{this._onPrintComplete=t,this._onPrintError=i,this._printing=!0;var n=new s.ExportMapParameters;n.reportParameters=e,new a.ExportMapTask(this).generateMapImageUrl(n).then(function(e){return r._printRestComplete(e)},function(e){return r._printRestError(e)})}},i.prototype._configureObject=function(e,t){if(void 0===e||void 0===e.id||void 0===e.displayName)throw new Error("Incorrect print template object returned from initialization");if(this.description=void 0===e.description?this.description:e.description,this.displayName=e.displayName,this.id=e.id,this.visible=void 0===e.visible||e.visible,this.reportUrl=e.reportUrl,this.type=e.type?e.type:n.ReportType.MAP_TEMPLATE_REPORT,this.mainMapWidth=e.mainMapWidth,this.mainMapHeight=e.mainMapHeight,this.maximumResolution=void 0===e.maximumResolution?this.maximumResolution:e.maximumResolution,this.supportedMapScales=void 0===e.supportedScales?this.supportedMapScales:e.supportedScales,this.supportedOutputFormats=void 0===e.supportedOutputFormats?this.supportedOutputFormats:e.supportedOutputFormats,this.supportedResolutions=void 0===e.supportedResolutions?this.supportedResolutions:e.supportedResolutions,this.supportsEmailNotification=!!e.supportsEmailNotification,this.textFields=void 0===e.textFields?this.textFields:e.textFields,this.grids=void 0===e.grids?this.grids:e.grids,t&&(this.isInitialized=!0),this.properties=o._getProperties(e.properties),this.extensions=o._getExtensions(e.extensions),this.isDefault=void 0===e.isDefault?this.isDefault:e.isDefault,this.defaultMapScaleName=void 0===e.defaultMapScale?null:e.defaultMapScale,this.defaultMapScaleName)for(s=0;s<this.supportedMapScales.length;s++)this.defaultMapScaleName===this.supportedMapScales[s].displayName&&(this.defaultMapScale=this.supportedMapScales[s]);var i=void 0===e.defaultResolution?null:e.defaultResolution;if(i)for(s=0;s<this.supportedResolutions.length;s++)i===this.supportedResolutions[s].displayName&&(this.defaultResolution=this.supportedResolutions[s]);var r=void 0===e.defaultGrid?null:e.defaultGrid;if(r)for(var s=0;s<this.grids.length;s++)r===this.grids[s].displayName&&(this.defaultGrid=this.grids[s]);this.defaultOutputFormat=void 0===e.defaultOutputFormat?this.defaultOutputFormat:e.defaultOutputFormat},i.prototype._printRestComplete=function(e){this._printing=!1;var t=null;e?e.error&&(t=e.error):t=new Error("Unexpected Error"),t?this._onPrintError&&this._onPrintError(t):this._onPrintComplete&&this._onPrintComplete(e)},i.prototype._printRestError=function(e){this._printing=!1,this._onPrintError&&this._onPrintError(e)},i}(r.AsyncInitializable);i.PrintTemplate=l})},"geocortex/essentials/RefreshVisibility":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){return function(){}}();i.DEFAULT="Default",i.SHOW="Show",i.HIDE="Hide",t.RefreshVisibility=i})},"geocortex/essentials/Report":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}();define(["require","exports","./AsyncInitializable","./exportMap/ExportMapTask","./exportMap/ExportMapParameters","./RestHelper","./../geocortex"],function(t,i,r,n,s,a,o){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var l=function(t){function i(e){var i=t.call(this,e)||this;return i.description=null,i.displayName=null,i.extensions=[],i.id=null,i.visible=!1,i.layer=null,i.properties={},i.reportUrl=null,i.type=null,i.supportedMapScales=[],i.supportedOutputFormats=[],i.supportedResolutions=[],i.textFields=[],i._running=!1,i._onRunReportComplete=null,i._onRunReportError=null,i}return e(i,t),i.prototype.isRunning=function(){return this._running},i.prototype.run=function(e,t,i,r){var o=this;if(this.isRunning()){if(r){var l=new Error("Report already running");l.name="ReportAlreadyRunning",r(l)}}else{this._running=!0;try{this._onRunReportComplete=i,this._onRunReportError=r;var c=new n.ExportMapTask(this),u=new s.ExportMapParameters;u.reportParameters=t,e&&(u.queryParameters=a.RestHelper._createRestParametersFromQuery(e)),c.generateMapImageUrl(u).then(function(e){return o._runRestComplete(e)},function(e){return o._runRestError(e)})}catch(l){if(this._running=!1,!this._onRunReportError)throw l;this._onRunReportError(l)}}},i.prototype._configureObject=function(e,t){if(void 0===e.id||void 0===e.displayName)throw new Error("Incorrect report object returned from initialization");this.id=e.id,this.visible=void 0===e.visible||e.visible,this.reportUrl=e.reportUrl,this.supportedOutputFormats=e.supportedOutputFormats,this.supportedResolutions=e.supportedResolutions,this.supportedMapScales=e.supportedScales,this.textFields=e.textFields,this.type=e.type,this.description=e.description,this.displayName=e.displayName,t&&(this.isInitialized=!0),this.properties=o._getProperties(e.properties),this.extensions=o._getExtensions(e.extensions)},i.prototype._runRestComplete=function(e){this._running=!1;var t=null;e?e.error&&(t=e.error):t=new Error("No results"),t&&this._onRunReportError&&this._onRunReportError(t),e&&this._onRunReportComplete&&this._onRunReportComplete(e)},i.prototype._runRestError=function(e){this._running=!1,this._onRunReportError&&this._onRunReportError(e)},i}(r.AsyncInitializable);i.Report=l;!function(e){e.LAYER_TEMPLATE_REPORT="Layer Template Report",e.LAYER_URL_REPORT="Layer URL Report",e.MAP_TEMPLATE_REPORT="Map Template Report",e.MAP_URL_REPORT="Map URL Report"}(i.ReportType||(i.ReportType={}))})},"geocortex/essentials/ReportParameters":function(){define(["require","exports","./MapServiceConstants","./utilities/PrintUtilities"],function(e,t,i,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(){this.customExtent=null,this.extentType="currentExtent",this.fields=[],this.grid=null,this.imageHeight=null,this.imageWidth=null,this.notificationEmailAddress=null,this.outputFormat=null,this.featureIds=null,this.resolution=null,this.scale=null}return e.prototype.toJson=function(t,r){if(!t||!r)throw new Error("Reporting parameter creation is missing a main map.");var n,s,a={},o=this.scale&&void 0!=this.scale.scale&&!isNaN(parseFloat(this.scale.scale))?parseFloat(this.scale.scale):t.getScale();this.scale&&void 0!=this.scale.scale&&(a.scale=this.scale.scale);var l;this.extentType==e.CURRENT_EXTENT&&null!==t?n=t.extent:this.extentType==e.FULL_EXTENT&&null!==r?n=r.fullExtent:this.extentType==e.INITIAL_EXTENT&&null!==r?n=r.initialExtent:this.extentType==e.CUSTOM_EXTENT&&null!==this.customExtent&&(n=this.customExtent),n&&(n.spatialReference&&(s=n.spatialReference.toJson())&&(s.wkid&&s.wkid>0?a.bboxSR=s.wkid:s.wkt&&(a.bboxSR=s.wkt)),a.bbox=n.xmin+","+n.ymin+","+n.xmax+","+n.ymax),this.targetSpatialReference&&(s=this.targetSpatialReference.toJson())&&(s.wkid&&s.wkid>0?a.targetSR=s.wkid:s.wkt&&(a.targetSR=s.wkt)),this.notificationEmailAddress&&(a.emailAddress=this.notificationEmailAddress),this.imageHeight&&this.imageHeight>0&&(a.imageHeight=this.imageHeight),this.imageWidth&&this.imageWidth>0&&(a.imageWidth=this.imageWidth),t.timeExtent&&(a.time="",t.timeExtent.startTime?a.time+=t.timeExtent.startTime.getTime():a.time+="null",a.time+=",",t.timeExtent.endTime?a.time+=t.timeExtent.endTime.getTime():a.time+="null");var c=[];if(null!==r){var u="",p="",h="";for(l=0;l<r.mapServices.length;l++){var d,f=r.mapServices[l],y="",m=f.serviceLayer,v="";if(m)if(!0===m.visible&&(p+=(""===p?"":";")+f.id+":"+m.opacity),f.mapServiceType===i.MapServiceType.DYNAMIC){d=m.layerDefinitions;var g=0;for(var _ in d)g>0&&(v+=","),v+='"'+_+'":"'+d[_].replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"',g++;if(g>0&&(h.length>1&&(h+=","),h+='"'+f.id+'":{',h+=v,h+="}"),!0===m.visible&&!0===m.isVisibleAtScale(o))if(m instanceof esri.layers.ArcGISDynamicMapServiceLayer){var S=m;S.visibleLayers&&"-1"!==S.visibleLayers.toString()&&(y=S.visibleLayers.toString())}else if(f.layers&&0!==f.layers.length){if(f.layers&&f.layers.length>0)for(L=0;L<f.layers.length;L++)(T=f.layers[L]).isVisible()&&T.areAllAncestorsVisible()&&(y+=(0===y.length?"":",")+T.id)}else y="*"}else if(!0===m.visible&&!0===m.isVisibleAtScale(o))if(f.layers&&0!==f.layers.length){if(f.layers&&f.layers.length>0)for(var L=0;L<f.layers.length;L++){var T=f.layers[L];T.isVisible()&&T.areAllAncestorsVisible()&&(y+=(0===y.length?"":",")+T.id)}}else y="*";var b=f.id;if(0===y.length?b+="(hide:*)":b+="(show:"+y+")",u+=(0===u.length?"":";")+b,f.hasOwnProperty("onDemandCacheSize")){var E={};E.id=f.id;var I=m.getSelectionSymbol();if(I&&I.color){var x=I.color.toRgba();E.selectionColor={r:x[0],g:x[1],b:x[2],a:x[3]}}E.mode=f.queryMode;var w=m.getDefinitionExpression();w&&(E.where=w),m.renderer&&(E.renderer=m.renderer.toJson()),E.selectedFeatures=[];var M=m.getSelectedFeatures();if(M&&M.length>0){var R=m.objectIdField;if(R)for(var O=0;O<M.length;O++){var D=M[O];if(D.attributes){var C=D.attributes[R];C&&E.selectedFeatures.push(C)}}}c.push(E)}}h.length>0&&(h="{"+h+"}",a.layerDefinitions=h),u.length>0&&(a.layers=u),p.length>0&&(a.opacity=p)}c.length>0&&(a.featureLayerOptions=c),this.outputFormat&&(a.outputFormat=this.outputFormat),this.featureIds&&(a.featureIds=this.featureIds),this.resolution&&(a.dpi=this.resolution.dpi),this.mapGraphicsLayers&&(a.graphics=this.mapGraphicsLayers.layers,a.symbols=this.mapGraphicsLayers.symbols),this.includeData&&(a.of=a.of?a.of+",includeData":"includeData"),this.includeGeoreferenceData&&(a.georef=this.includeGeoreferenceData),this.useTransparentBackground&&(a.useTransparentBackground=this.useTransparentBackground);for(var P=0;P<this.fields.length;P++){var U=this.fields[P];a[U.id]=U.value}return this.grid&&(a.grid=this.grid.id),a},e.prototype.populateMapGraphicsLayers=function(e){this.mapGraphicsLayers={layers:[],symbols:[]},this._extractGraphicInformation(e.graphics,this.mapGraphicsLayers.layers,this.mapGraphicsLayers.symbols);for(var t=0;t<e.graphicsLayerIds.length;t++){var i=e.getLayer(e.graphicsLayerIds[t]);!i.visible||i instanceof esri.layers.FeatureLayer&&i.url||this._extractGraphicInformation(i,this.mapGraphicsLayers.layers,this.mapGraphicsLayers.symbols)}},e.prototype._extractGraphicInformation=function(e,t,i){for(var n=0;n<e.graphics.length;n++){var s=e.graphics[n];if(s.visible){var a={},o=null;if(s.symbol?o=s.symbol:e.renderer&&e.renderer.getSymbol&&(o=e.renderer.getSymbol(s),s.symbol=o),!o)continue;i.push(o);for(var l=0;l<i.length-1;l++)if(i[l]==o){a.symbolID=i[l].id,o.id=a.symbolID,i.pop();break}if(void 0==a.symbolID){var c=i.length-1;i[c]instanceof esri.symbol.TextSymbol?i[c]=r.PrintUtilities.adjustTextSymbol(s,e.id):i[c]instanceof esri.symbol.PictureMarkerSymbol&&(i[c]=r.PrintUtilities.adjustPictureMarkerSymbol(s)),a.symbolID=(i.length-1).toString(),i[a.symbolID].id=a.symbolID}a.geometry=s.geometry,t.push({elements:[a],opacity:e.opacity})}}},e}();n.CURRENT_EXTENT="currentExtent",n.CUSTOM_EXTENT="customExtent",n.FULL_EXTENT="fullExtent",n.INITIAL_EXTENT="initialExtent",t.ReportParameters=n})},"geocortex/essentials/Resolution":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){return function(e,t){void 0!==e&&(this.displayName=e),void 0!==t&&(this.dpi=t)}}();t.Resolution=i})},"geocortex/essentials/RestEndpointResult":function(){define(["require","exports","./../geocortex"],function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){return function(e,t){this.error=t,this.resultObject=e,e&&(this.rawJson=i.encodeJson(e))}}();t.RestEndpointResult=r})},"geocortex/essentials/RestHelper":function(){define(["require","exports","./RestHelperHTTPService"],function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){}return e.processClientSideTokens=function(t,r){var n="";if(""!==r){var s="";t&&t.url&&(s=t.url),n=e._replaceToken("SiteRestUrl",r,s),n=e._replaceToken("VirtualDirectoryUrl",n,s+"/virtualdirectory");var a=window.location.href.substring(0,window.location.href.lastIndexOf("/"));n=e._replaceToken("HostUri",n,a);var o=s.substring(0,s.lastIndexOf("/sites/"))+"/virtualdirectory";n=e._replaceToken("RestVirtualDirectoryUrl",n,o);var l=i.RestHelperHTTPService.token;n=e._replaceToken("RestToken",n,l)}return n},e.validateDynamicDefinition=function(t){if(!t||!t.trim())throw new Error("The JSON string cannot be null, empty nor merely whitespace!");var i=e.getJsonObjectFromJsonString(t);if(i){if(null==i.source)throw"The source is required!";if(null==i.source.type)throw"The type is required!";if("mapLayer"==i.source.type){if(null==i.source.mapLayerId)throw"The mapLayerId is required for the mapLayer type!"}else{if("dataLayer"!=i.source.type)throw"The type '"+i.source.type.toString()+"' is not supported!";if(null==i.source.dataSource)throw"The dataSource is required for the dataLayer type!"}}},e.getJsonObjectFromJsonString=function(e){return JSON.parse(e)},e.getLayerSourceFromJsonObject=function(e){if("mapLayer"==e.type)return new esri.layers.LayerMapSource(e);var t=new esri.layers.LayerDataSource;switch(e.dataSource.type){case"table":t.dataSource=new esri.layers.TableDataSource(e.dataSource);break;case"queryTable":t.dataSource=new esri.layers.QueryDataSource(e.dataSource);break;case"raster":t.dataSource=new esri.layers.RasterDataSource(e.dataSource);break;case"joinTable":t.dataSource=new esri.layers.JoinDataSource(e.dataSource);break;default:throw"The type '"+e.type.toString()+"' not supported!"}return t},e.getDynamicLayerInfoFromJson=function(t,i){var r;e.validateDynamicDefinition(t);var n=e.getJsonObjectFromJsonString(t);if(n){if(r=new esri.layers.DynamicLayerInfo,n.id)r.id=n.id;else{if(null==i)throw"The Layer's ID is missing or invalid!";r.id=parseInt(i,10)}r.source=this.getLayerSourceFromJsonObject(n.source),null!=n.minScale&&(r.minScale=n.minScale),r.minScale<=0&&(r.minScale=1/0),null!=n.maxScale&&(r.maxScale=n.maxScale)}return r},e.getDynamicExpressionFromJson=function(t){var i;e.validateDynamicDefinition(t);var r=e.getJsonObjectFromJsonString(t);return r&&r.definitionExpression&&(i=r.definitionExpression),i},e.getLayerDrawingOptionsFromJson=function(t){var i;e.validateDynamicDefinition(t);var r,n=e.getJsonObjectFromJsonString(t);if(n&&n.drawingInfo){switch(r=dojo.clone(n.drawingInfo),i=new esri.layers.LayerDrawingOptions,r.renderer.type){case"simple":i.renderer=new esri.renderer.SimpleRenderer(r.renderer);break;case"uniqueValue":i.renderer=new esri.renderer.UniqueValueRenderer(r.renderer);break;case"classBreaks":i.renderer=new esri.renderer.ClassBreaksRenderer(r.renderer);break;default:throw"The type '"+r.renderer.type.toString()+"' not supported!"}if(r.labelingInfo&&r.labelingInfo instanceof Array){var s=r.labelingInfo;void 0===r.showLabels&&(r.showLabels=!0);for(var a=0;a<s.length;a++){var o=new esri.layers.LabelClass(s[a]);i.labelingInfo||(i.labelingInfo=[]),i.labelingInfo.push(o)}}i.transparency=r.transparency,i.scaleSymbols=r.scaleSymbols,i.showLabels=r.showLabels}return i},e._replaceToken=function(e,t,i){return t?t.replace("{"+e+"}",i):t},e._createRestParametersFromQuery=function(t){var i={};return t&&((i=t.toJson()).spatialRel=e._convertSpatialRelationshipToDotnet(i.spatialRel)),i},e._convertSpatialRelationshipToDotnet=function(e){switch(e){case esri.tasks.Query.SPATIAL_REL_CONTAINS:return"esriSpatialRelContains";case esri.tasks.Query.SPATIAL_REL_CROSSES:return"esriSpatialRelCrosses";case esri.tasks.Query.SPATIAL_REL_ENVELOPEINTERSECTS:return"esriSpatialRelEnvelopeIntersects";case esri.tasks.Query.SPATIAL_REL_INDEXINTERSECTS:return"esriSpatialRelIndexIntersects";case esri.tasks.Query.SPATIAL_REL_INTERSECTS:return"esriSpatialRelIntersects";case esri.tasks.Query.SPATIAL_REL_OVERLAPS:return"esriSpatialRelOverlaps";case esri.tasks.Query.SPATIAL_REL_RELATION:return"esriSpatialRelRelation";case esri.tasks.Query.SPATIAL_REL_TOUCHES:return"esriSpatialRelTouches";case esri.tasks.Query.SPATIAL_REL_WITHIN:return"esriSpatialRelWithin"}throw new Error("Unknown rel: "+e)},e._convertSpatialRelationshipFromDotnetIndex=function(e){switch(e){case 1:return esri.tasks.Query.SPATIAL_REL_CONTAINS;case 2:return esri.tasks.Query.SPATIAL_REL_CROSSES;case 3:return esri.tasks.Query.SPATIAL_REL_ENVELOPEINTERSECTS;case 4:return esri.tasks.Query.SPATIAL_REL_INDEXINTERSECTS;case 0:return esri.tasks.Query.SPATIAL_REL_INTERSECTS;case 5:return esri.tasks.Query.SPATIAL_REL_OVERLAPS;case 8:return esri.tasks.Query.SPATIAL_REL_RELATION;case 6:return esri.tasks.Query.SPATIAL_REL_TOUCHES;case 7:return esri.tasks.Query.SPATIAL_REL_WITHIN}throw new Error("Unknown rel: "+e)},e}();r.tokenDurationMinutes=20,t.RestHelper=r})},"geocortex/essentials/RestHelperHTTPService":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){this.requestObject=null,this.optionsObject=null,this._handle=null,this._error=null,this._deferred=new dojo.Deferred,void 0!==e&&(this.requestObject=e,dojo.isFunction(this.requestObject.error)&&(this._error=this.requestObject.error,this.requestObject.error=null),dojo.isFunction(this.requestObject.handle)&&(this._handle=this.requestObject.handle),this.requestObject.handle=dojo.hitch(this,this._handleProxy)),void 0!==t&&(this.optionsObject=t)}return e.getTokenForScope=function(e){var t=this._anchorScratch||(this._anchorScratch=document.createElement("a")),i=this._pathCleaner||(this._pathCleaner=/\/+/g);t.href=e;var r=t.hostname.toLowerCase(),n=("/"+t.pathname+"/").replace(i,"/").toLowerCase(),s=void 0,a=this.tokenScopes;for(var o in a){t.href=o;var l=t.hostname.toLowerCase(),c=("/"+t.pathname+"/").replace(i,"/").toLowerCase();if(r===l&&n.startsWith(c)){var u=a[o];s="string"==typeof u?u:!0===u?this.token:void 0}}return s},e.setDefaultToken=function(e,t){"string"==typeof e&&(this.token=e,this.tokenScopes[t]=!0)},e.appendTokenToUrl=function(t,i){var r=t;return t&&!e.urlHasToken(t)&&(r=e._appendParameter(t,"token",i)),r},e.urlHasToken=function(e){return/[?&]token=/.test(e)},e.getAuthenticationControlBlockStore=function(){return console.warn("RestHelperHTTPService.getAuthenticationControlBlockStore() is no longer supported."),null},e.prototype._handleProxy=function(e,t){!1===this._isUnauthorizedResponse(e)&&dojo.isFunction(this._handle)&&(console.log("Invoking original handle delegate"),this._handle(e,t))},e.prototype._requestCallback=function(e){this._deferred.resolve(e)},e.prototype._requestErrback=function(e){dojo.isFunction(this._error)&&this._error(e),this._deferred.reject(e)},e.prototype._isUnauthorizedResponse=function(e){return!(!e||401!==e.code)},e.prototype.send=function(){var t=e.getTokenForScope(this.requestObject.url);return void 0!==t&&(this.requestObject.content||(this.requestObject.content={}),this.requestObject.content.token=t),esri.request(this.requestObject,this.optionsObject).then(dojo.hitch(this,this._requestCallback),dojo.hitch(this,this._requestErrback)),this._deferred.promise},e._appendParameter=function(e,t,i){var r=e;return e&&t&&i&&(e.indexOf("?")>=0?r+="&":r+="?",r+=encodeURIComponent(t)+"="+encodeURIComponent(i)),r},e}();i.tokenScopes={},t.RestHelperHTTPService=i})},"geocortex/essentials/RestUtility":function(){define(["require","exports","./RestEndpointResult","./../geocortex"],function(e,t,i,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(){this._activeEndpointRequest=!1,this._onRequestComplete=null,this._onRequestError=null}return e.prototype.getCustomRestEndpoint=function(e,t,i,n,s){this._activeEndpointRequest?this._onEndpointRequestError(new Error("An operation is already in progress.")):(this._activeEndpointRequest=!0,this._onRequestComplete=i,this._onRequestError=n,r.request({url:e,content:t,load:dojo.hitch(this,this._onEndpointRequestComplete),error:dojo.hitch(this,this._onEndpointRequestError),callbackParamName:"CallBack"},s))},e.prototype._onEndpointRequestComplete=function(e){this._activeEndpointRequest=!1;try{e||(e={error:new Error("Expected results")}),e.error&&this._onRequestError&&this._onRequestError(e.error)}finally{this._onRequestComplete&&this._onRequestComplete(new i.RestEndpointResult(e,e.error))}},e.prototype._onEndpointRequestError=function(e){this._activeEndpointRequest=!1;try{this._onRequestError&&this._onRequestError(e)}finally{this._onRequestComplete&&this._onRequestComplete(new i.RestEndpointResult(null,e))}},e}();t.RestUtility=n})},"geocortex/essentials/Rx.light":function(){define(["require","exports"],function(e,t){"use strict";function i(){}Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){}return e.prototype.select=function(t){var i=this,r=new e;return r._subscribe=function(e){var r=!0,n={onNext:function(i){if(r)try{e.onNext(t(i))}catch(t){r=!1,e.onError(t)}},onError:function(t){r&&(r=!1,e.onError(t))},onCompleted:function(){r&&(r=!1,e.onCompleted())}},s=i._subscribe(n);return r?s:(s.dispose(),{dispose:function(){}})},r},e.prototype._subscribe=function(e){return{dispose:i}},e.prototype.subscribe=function(e,t,r){if(arguments.length>1){n={onNext:e||i,onError:t||i,onCompleted:r||i};return this._subscribe(n)}if(e instanceof Function){if(e.length>1){n={onNext:function(t){return e(t)},onError:function(t){return e(void 0,t)},onCompleted:function(){return e()}};return this._subscribe(n)}var n={onNext:e,onError:t||i,onCompleted:r||i};return this._subscribe(n)}return e?this._subscribe(e):this._subscribe({onNext:i,onError:i,onCompleted:i})},e}();t.AnonymousObservable=r})},"geocortex/essentials/Scale":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){return function(e,t){this.displayName=e,this.scale=t}}();t.Scale=i})},"geocortex/essentials/SearchQuery":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(){this.extent=null,this.maxResults=50,this.contains=!0,this.returnGeometry=!1,this.returnHighlights=!1,this.returnIdsOnly=!1,this.returnCountOnly=!1,this.searchText=null,this.outSpatialReference=null}return e.prototype.toJson=function(e,t){if(!e||!t)throw new Error("Search query parameter creation is missing a main map.");var i={searchText:this.searchText,contains:this.contains,returnGeometry:this.returnGeometry,returnHighlights:this.returnHighlights,returnIdsOnly:this.returnIdsOnly,returnCountOnly:this.returnCountOnly};this.extent&&(i.envelope="{0},{1},{2},{3}".format(this.extent.xmin,this.extent.ymin,this.extent.xmax,this.extent.ymax)),(this.returnGeometry||this.extent)&&this.outSpatialReference&&(i.outSR=this.outSpatialReference.toJson()),this.maxResults>0&&(i.maxResults=this.maxResults);var r=this.searchLayers;return r&&0!=r.length||(r=t.allLayers()),i.layers=this._getServiceStrings(r),i},e.prototype._getServiceStrings=function(e){for(var t="",i={},r=0;r<e.length;r++){var n=e[r];if(n&&n.searchable&&n.mapService&&n.mapService.instantSearch){var s=n.mapService.id;i.hasOwnProperty(s)||(i[s]=[]),i[s].push(n.id)}}for(var a in i)i.hasOwnProperty(a)&&(t+=0===t.length?"":";",t+="{0}(include:{1})".format(a,i[a].join(",")));return t},e}();t.SearchQuery=i})},"geocortex/essentials/SearchResultFeature":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){return function(e,t){this.esriFeature=null,this.layer=null,this.highlights={},this.esriFeature=e,this.layer=t}}();t.SearchResultFeature=i})},"geocortex/essentials/SearchResults":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){return function(){this.error=null,this.results=[],this.queryParams=null}}();t.SearchResults=i})},"geocortex/essentials/SearchResultSet":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){return function(e){this.features=[],this.layer=null,e&&e.hasOwnProperty("features")&&(this.features=e.features),e&&e.hasOwnProperty("layer")&&(this.layer=e.layer)}}();t.SearchResultSet=i})},"geocortex/essentials/SearchTable":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}();define(["require","exports","./AsyncInitializable","./RestHelper","./../geocortex"],function(t,i,r,n,s){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var a=function(t){function i(e){var i=t.call(this,e)||this;return i.displayName=null,i.parameters=[],i.id=null,i.site=null,i.featureDescription=null,i.featureLabel=null,i.featureLongDescription=null,i.iconUri=null,i.includeInGlobalSearch=!1,i._searching=!1,i._onSearchingComplete=null,i._onSearchingError=null,i}return e(i,t),i.prototype._configureObject=function(e,t){if(void 0===e||void 0===e.id||void 0==e.displayName)throw new Error("Incorrect search table object returned from initialization");this.id=e.id,this.displayName=e.displayName,this.parameters=e.parameters,this.featureDescription=e.featureDescription,this.featureLabel=e.featureLabel,this.featureLongDescription=e.featureLongDescription,this.iconUri=n.RestHelper.processClientSideTokens(this.site,e.iconUri),this.includeInGlobalSearch=e.includeInGlobalSearch},i.prototype.isSearching=function(){return this._searching},i.prototype.performSearch=function(e,t,i){var r=this,n=function(e){r._searching=!1,i&&i(new Error(e))};e||n("No searchParameters provided"),this.isSearching()&&n("Currently performing a search"),this._searching=!0,this._onSearchingComplete=dojo.hitch(this,t),this._onSearchingError=dojo.hitch(this,i);var a=this.url+"/search",o="";for(var l in e)e.hasOwnProperty(l)&&(o+=(o?"&":"")+encodeURIComponent(l)+"="+encodeURIComponent(e[l]));a+="?"+o,s.request({url:a,content:{f:"json"},handleAs:"json",load:dojo.hitch(this,this._searchRestComplete),error:dojo.hitch(this,this._searchRestError),callbackParamName:"CallBack"})},i.prototype._searchRestComplete=function(e){this._searching=!1,!e&&this._onSearchingError&&this._onSearchingError(new Error("No results")),e.error&&this._onSearchingError&&this._onSearchingError(e.error),this._onSearchingComplete&&this._onSearchingComplete(new esri.tasks.FeatureSet(e))},i.prototype._searchRestError=function(e){this._searching=!1,this._onSearchingError&&this._onSearchingError(e)},i}(r.AsyncInitializable);i.SearchTable=a})},"geocortex/essentials/SearchTableParameter":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){return function(){this.name=null,this.type=null}}();t.SearchTableParameter=i})},"geocortex/essentials/SecurityHelper":function(){define(["require","exports","../geocortex"],function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){var e=this;this.finished=!1,this.id=(new Date).valueOf().toString(),this.scripts=[],this._refreshPromise=new Promise(function(t,i){e._refreshPromiseResolve=t,e._refreshPromiseReject=i})}return e.getCurrent=function(){var e=window.security;return e&&!e.finished?e:null},e.beginRefresh=function(t){if(null!=e.getCurrent())return!1;var i=new e;return i.site=t,!!i.getExpirationNoticeUrl()&&(!!i.getRefreshUrl()&&(window.security=i,i.openFrame(),!0))},e.waitForSignIn=function(){var t=e.getCurrent();return t?t._refreshPromise:Promise.resolve()},e.cancel=function(){var t=e.getCurrent();return t&&(t._refreshPromise.isFulfilled||t._refreshPromiseReject("Canceled")),t&&t.finish()},e.prototype.openSystemBrowser=function(){var e=this,t=this.getRefreshUrl()+"&app="+this.site.signInRedirectUri+"&token_type=fragment&openSystemBrowser=true",i=/GeocortexApp\.iOS/.test(navigator.userAgent)?"_system":"_blank",r=function(){var t=location.hash;if(t.length>0&&t.startsWith("#gcx-")){window.removeEventListener?window.removeEventListener("popstate",r,!1):window.detachEvent&&window.detachEvent("onpopstate",r);var i=t.substring(5);e.sendRequest(e.site.url+"?f=json&callback=security.updateSitePrincipal&token="+i)}};window.addEventListener?window.addEventListener("popstate",r,!1):window.attachEvent&&window.attachEvent("onpopstate",r),window.open(t,i)},e.prototype.openFrame=function(){var e=this;this.frame=document.createElement("iframe"),this.frame.name="SignInHelper",this.frame.style.display="none",document.body.appendChild(this.frame),i.isNative()?(this.frame.src="SignInHelper.html",window.setTimeout(function(){e.finished||e.openSystemBrowser()},1e4)):(window.open("SignInHelper.html","SignInHelper"),window.setTimeout(function(){return e.openPopup()},15e3))},e.prototype.openPopup=function(){this.finished||(this.sendRequest(this.getExpirationNoticeUrl()+"?f=json&part=_html&callback=security.showContent"),window.open("SignInHelper.html","_blank"))},e.prototype.getExpirationNoticeUrl=function(){return this.site.principal&&this.site.principal.urls?this.site.principal.urls.expirationNotice:null},e.prototype.getRefreshUrl=function(){return this.site.principal&&this.site.principal.urls?this.site.principal.urls.refresh:null},e.prototype.sendRequest=function(e){if(!this.finished){var t=document.createElement("script");t.style.display="none",document.body.appendChild(t),this.scripts.push(t),t.type="text/javascript",t.src=e+"&rid="+this.id}},e.prototype.showContent=function(e){return!this.finished&&(e.rid==this.id&&(this.dialog&&this.dialog.parentNode&&this.dialog.parentNode.removeChild(this.dialog),this.dialog=document.createElement("div"),this.dialog.innerHTML=e.content,document.body.appendChild(this.dialog),!0))},e.prototype.handleSignIn=function(e,t){if(this.finished)return null;if(!(e.length>0&&e.startsWith("#gcx-"))){var i="";return null==this.site.principal.urls.referrer&&(i="&app="+encodeURIComponent(t)),this.getRefreshUrl()+i+"&token_type=fragment"}var r=e.substring(5);return this.sendRequest(this.site.url+"?f=json&callback=security.updateSitePrincipal&token="+r),null},e.prototype.finish=function(){if(this.finished)return!1;for(this.finished=!0;this.scripts.length>0;){var e=this.scripts.pop();e.parentNode.removeChild(e)}return this.dialog&&this.dialog.parentNode&&this.dialog.parentNode.removeChild(this.dialog),this.frame&&this.frame.parentNode&&this.frame.parentNode.removeChild(this.frame),!0},e.prototype.updateSitePrincipal=function(e){return this.finished?(this._refreshPromise.isResolved||this._refreshPromiseResolve(),!1):e.rid==this.id&&(this.finish(),this.site.updatePrincipal(e.principal),this._refreshPromiseResolve(),console.log("Updated Principal (Refresh Successful)"),!0)},e.prototype.useSystemBrowser=function(){return!1},e.prototype.waitForSignIn=function(){return this._refreshPromise},e}();t.SecurityHelper=r})},"geocortex/essentials/ServiceHelper":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(){}return e.extractConnectionStringValue=function(e,t){if(e.length>0){var i=e.match("(^|;)[s]*"+t+"=([^;]*)");return null!==i?i[2]:""}return""},e}();t.ServiceHelper=i})},"geocortex/essentials/ServicePoint":function(){var t=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}();define(["require","exports","./Rx.light","./../geocortex"],function(i,r,n,s){"use strict";function a(e,t){d||((h=document.head.getElementsByTagName("base")[0])||((h=document.createElement("base")).setAttribute("href",window.location.href),document.head.appendChild(h)),d=document.createElement("a"));try{var i=h.getAttribute("href");h.setAttribute("href",e),d.setAttribute("href",t),t=d.href}finally{h.setAttribute("href",i)}return t}function o(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];for(var r=e.length,n=0;n<t.length;n++){var s=e.indexOf(t[n]);s>=0&&s<r&&(r=s)}return s}function l(e){var t=o(e,"?","!","#");return{query:e.substring(0,t),tail:e.substring(t)}}Object.defineProperty(r,"__esModule",{value:!0});var c=function(){function e(){}return e.prototype.toString=function(){return this.message},e}();r.ServiceRequestError=c,c.prototype.message="An error occurred while performing the operation.",c.prototype.details=new Array,c.prototype.name="ServiceRequestError";var u=function(e){function i(){return null!==e&&e.apply(this,arguments)||this}return t(i,e),i}(c);r.ServiceRequestAbortedError=u,u.prototype.message="The request was aborted.",u.prototype.name="ServiceRequestAbortedError";var p=function(){function t(){}return t.prototype.start=function(){try{this.promise=s.request(this),this.valid?this.registration=this.servicePoint.cancellationToken.register(this.error.bind(this)):this.promise.cancel()}catch(e){this.error(e)}},t.prototype.load=function(e){try{if(this.member){var t=e[this.member];if(t)for(var i=0;i<t.length&&this.valid;i++)this.observer.onNext(t[i])}else this.valid&&this.observer.onNext(e);this.complete()}catch(e){this.error(e)}},t.prototype.error=function(t){this.valid&&(this.valid=!1,this.promise.cancel(),this.registration.dispose(),this.observer.onError(e||new u))},t.prototype.complete=function(){this.valid&&(this.valid=!1,this.promise.cancel(),this.registration.dispose(),this.observer.onCompleted())},t.prototype.dispose=function(){this.valid&&(this.valid=!1,this.promise.cancel(),this.registration.dispose())},t}();p.prototype.handleAs="json",p.prototype.valid=!0,p.prototype.registration={dispose:function(){}};var h,d,f=function(){function e(){}return e.prototype.formatQuery=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];var r=l(e.format.apply(e,t));return a(this.baseAddress,r.query)+r.tail},e.prototype.getRequest=function(e,t){var i=function(e){this.observer=e,this.start()};(i.prototype=new p).servicePoint=this,i.prototype.query=e,i.prototype.member=t;var r=new n.AnonymousObservable;return r._subscribe=function(e){return new i(e)},r},e}();r.ServicePoint=f,f.prototype.baseAddress=window.location.href,f.prototype.cancellationToken={dispose:function(){},register:function(e){return this}}})},"geocortex/essentials/Site":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}();define(["require","exports","./AsyncInitializable","./ArcGisPortalSecurityContext","./documents/DocumentStore","./Map","./GeocodingEndpoint","./GeometryEndpoint","./GeoprocessingEndpoint","./NamedExtent","./PrintTemplate","./TimeSliderProfile","./LayerCatalog","./Workflow","./SearchTable","./utilities/UrlUtilities","./utilities/SiteResourceIdComparer","./FeatureLayerService","geocortex/framework/utils/ArrayUtils","./SearchResults","./../geocortex","./SearchResultSet","./SearchResultFeature","./ServiceHelper","./MapServiceConstants","./RestHelperHTTPService","./SecurityHelper","geocortex/framework/utils/utils","./OAuth2Client","./WebMapReference","./utilities/SiteInitializationUtils","../geocortex"],function(t,i,r,n,s,a,o,l,c,u,p,h,d,f,y,m,v,g,_,S,L,T,b,E,I,x,w,M,R,O,D,C){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var P=function(t){function i(e,i){var r=t.call(this,e)||this;return r.currentVersion=null,r.dataProvider=null,r.deepInitialize=!1,r.displayName=null,r.documentStore=new s.DocumentStore,r.updateInterval=null,r.essentialsMap=null,r.extensions=[],r.geocodingEndpoints=[],r.geometryEndpoints=[],r.geoprocessingEndpoints=[],r.layerListRestEndpoint=null,r.hasGeocodingEndpoints=!1,r.hasGeometryEndpoints=!1,r.hasGeoprocessingEndpoints=!1,r.hasNamedExtents=!1,r.hasNorthArrow=!1,r.hasTimeSliders=!1,r.hasOverviewMap=!1,r.hasPrintTemplates=!1,r.hasViewers=!1,r.hasVirtualDirectory=!1,r.hasWorkflows=!1,r.hasSearchTables=!1,r.hasWebMaps=!1,r.id=null,r.namedExtents=[],r.overviewMap=null,r.printTemplates=[],r.properties={},r.timeSliders=[],r.trustedUrls=[],r.layerCatalogs=[],r.serviceLayersLoaded=!1,r.url=null,r.workflows=[],r.searchTables=[],r.timeZoneId=null,r.displayTimeZoneId=null,r.webMapsInfo={layerTypes:null,webMaps:[]},r.configPreprocessor=null,r.onLayerLoad=null,r.onLayerLoadError=null,r.onServiceLayersLoaded=function(){},r.onSignIn=null,r.onSignOut=null,r.onUserSignInCancelled=null,r.onPrincipalUpdated=null,r.principal={isAuthenticated:!1,label:null,identities:[],policy:{},urls:{},tokens:{arcgis:{},geocortex:{},site:null}},r.suspendLayersOnLoad=!0,r._geocodingEndpointsInitialized=!1,r._geometryEndpointsInitialized=!1,r._geoprocessingEndpointsInitialized=!1,r._kmlServiceInitialized=!1,r._mapInitialized=!1,r._namedExtentsInitialized=!1,r._overviewMapInitialized=!1,r._printTemplatesInitialized=!1,r._workflowsInitialized=!1,r._searchTablesInitialized=!1,r._timeSlidersInitialized=!1,r._webMapsInitialized=!1,r._initializedHandlerCalled=!1,r._signInEnabled=!1,r._signOutEnabled=!1,r._tokenIntervalHandle=null,r._serviceTokenRefresh=null,r._serviceTokensStale=!1,r._allDeferredDojosForUpdatingTokens=new Array,r.originalUrl=e,r.url=m.UrlUtilities.simplify(e),r._esriMap=i,r}return e(i,t),i.prototype.initialize=function(e){var t=this;this.isInitialized||this._initializing||(this._initializedHandlerCalled=!1,this._initializing=!0,M.isNullOrUndefined(e)?D.detectAndConfigureCors(this.url).then(function(){D.downloadSite(t.url,t._handleSiteInitialization.bind(t),t._initSiteErrorHandler.bind(t))}):this._handleSiteInitialization(e))},i.prototype.getResourceById=function(e,t){return v.SiteResourceIdComparer.lookUp(e,t)},i.prototype.findWorkflowById=function(e){return this.getResourceById(this.workflows,e)},i.prototype.findPrintTemplateById=function(e){return this.getResourceById(this.printTemplates,e)},i.prototype.getFeatureServices=function(){var e=[];if(!this.essentialsMap)return e;for(var t=0;t<this.essentialsMap.mapServices.length;t++){var i=this.essentialsMap.mapServices[t];i instanceof g.FeatureLayerService&&e.push(i)}return e},i.prototype.getMap=function(){return this._esriMap},i.prototype.getEssentialsVersion=function(){var e=3;if(this.currentVersion){var t=this.currentVersion.split(".");if(t.length>=2){var i=t[0]+"."+t[1];e=parseFloat(i)}}return e},i.prototype.getDefaultBatchGeocoder=function(){var e=_.firstOrDefault(this.geocodingEndpoints,function(e){return e.isDefaultBatchGeocoder});return!e&&this.geocodingEndpoints.length>0&&(e=this.geocodingEndpoints[0]),e},i.prototype.search=function(e,t,i,r){var n=this;t&&t(e);try{var s=this.url+"/search",a={};e&&e.toJson&&(a=e.toJson(this.getMap(),this.essentialsMap));var o=L.encodeJson(dojo.mixin({f:"json"},a))}catch(e){return void(r&&r(e))}o.hasOwnProperty("layers")&&o.layers&&L.request({url:s,content:o,load:function(t){var s=new S.SearchResults;s.queryParams=e,t?n._parseSearchResponse(s,t):s.error=new Error("Unexpected Error"),s.error&&r&&r(s.error),i&&i(s)},error:function(e){r&&r(e)},callbackParamName:"CallBack"})},i.prototype._parseSearchResponse=function(e,t){if(!t)throw new Error("_parseSearchResponse: required jsonObject argument was not supplied.");if(t.hasOwnProperty("error")&&t.error&&t.error.message)e.error=new Error(t.error.message);else if(t.hasOwnProperty("ResponseStatus")&&t.ResponseStatus&&t.ResponseStatus.ErrorCode)e.error=new Error(t.ResponseStatus.Message),e.error.name=t.ResponseStatus.ErrorCode;else if(t.hasOwnProperty("features")){var i=this._createFeatureSets(t.features,e.queryParams.returnHighlights);for(var r in i)i.hasOwnProperty(r)&&e.results.push(i[r])}},i.prototype._createFeatureSets=function(e,t){for(var i={},r=0;r<e.length;r++){var n=e[r],s=n.hasOwnProperty("mapServiceId")?n.mapServiceId:null,a=n.hasOwnProperty("layerId")?n.layerId:null,o=this.essentialsMap.findMapServiceById(s),l=o?o.findLayerOrTableById(a):null;if(l){var c=this._createFeature(n,l,t);i.hasOwnProperty(l.url)||(i[l.url]=new T.SearchResultSet({layer:l})),i[l.url].features.push(c)}}return i},i.prototype._createFeature=function(e,t,i){if(!e)throw new Error("_createSearchFeature: required jsonFeature argument was not supplied.");var r=this._jObjectToGraphic(e),n=new b.SearchResultFeature(r,t);return i&&this._assignHighlights(n,e),n},i.prototype._jObjectToGraphic=function(e){if(!e)throw new Error("_jObjectToGraphic: required jobject argument was not supplied.");var t=null;e.hasOwnProperty("geometry")&&e.geometry&&(t=esri.geometry.fromJson(e.geometry))&&t.spatialReference&&!e.geometry.spatialReference&&(t.spatialReference=new esri.SpatialReference(4326));var i={};return e.hasOwnProperty("attributes")&&e.attributes&&(i=JSON.parse(JSON.stringify(e.attributes))),new esri.Graphic(t,null,i,null)},i.prototype._assignHighlights=function(e,t){if(!e)throw new Error("_assignHighlights: required feature argument was not supplied.");if(!t)throw new Error("_assignHighlights: required jobject argument was not supplied.");var i={};t.hasOwnProperty("highlights")&&t.highlights&&(i=JSON.parse(JSON.stringify(t.highlights))),e.highlights=i},i.prototype._initAsyncCollection=function(e,t,i,r){if(e&&i&&r)for(var n=0;e&&n<e.length;n++)i[n]=new r(this.url+"/"+t+"/"+e[n].id),i[n].site=this,i[n]._configureObject(e[n]),!0===this.deepInitialize&&r!==f.Workflow&&(i[n].isInitialized=!0);this._siteInitializeUpdate()},i.prototype._initAsyncCollectionErrorHandler=function(e,t){e(),this._initializationFailedHandler(t),this._siteInitializeUpdate()},i.prototype._initGeocodingEndpointsHandler=function(e){this._geocodingEndpointsInitialized=!0,e&&this._initAsyncCollection(e.geocodingEndpoints,"geocoding",this.geocodingEndpoints,o.GeocodingEndpoint)},i.prototype._initGeometryEndpointsHandler=function(e){this._geometryEndpointsInitialized=!0,e&&this._initAsyncCollection(e.geometryEndpoints,"geometry",this.geometryEndpoints,l.GeometryEndpoint)},i.prototype._initKmlEndpointHandler=function(e){if(this._kmlServiceInitialized=!0,e&&e.connectionString){var t=E.ServiceHelper.extractConnectionStringValue(e.connectionString,"url");t&&(esri.config.defaults.kmlService=t)}},i.prototype.getLayerCatalog=function(e,t,i,r){var n=this.url+"/catalog/layercatalog/getcatalog";t();L.request({url:n,content:{f:"json"},load:function(e){i(e)},error:r,callbackParamName:"CallBack"})},i.prototype.getLayerCatalogDetails=function(e,t,i,r){var n=this.url+"/catalog/layercatalog/getcatalogdetails",s={};s.ids=e.ids.join(),s.f="json",t();L.request({url:n,content:s,load:function(e){i(e)},error:r,callbackParamName:"CallBack"})},i.prototype.getOfflineBasemaps=function(e,t){void 0===t&&(t=function(){});var i=this.url+"/offlinebasemaps";if("function"!=typeof e)throw new Error("loadComplete must be a function.");L.request({url:i,content:{f:"json"},load:function(i){i.error?t(new Error(i.error.message)):i.basemaps?e(i.basemaps):t(new Error("Unexpected result: "+JSON.stringify(i)))},error:t,callbackParamName:"CallBack"})},i.prototype._initGeoprocessingEndpointsHandler=function(e){this._geoprocessingEndpointsInitialized=!0,e&&this._initAsyncCollection(e.geoprocessingEndpoints,"geoprocessing",this.geoprocessingEndpoints,c.GeoprocessingEndpoint)},i._addQueryParameter=function(e,t){var i=e.split("#",2);e=i[0];var r=i.length>1?i[1]:"";return e+(e.indexOf("?")>-1?"&":"?")+t+r},i.prototype.canSignIn=function(){return this._signInEnabled&&!!this.principal&&!!this.principal.urls.signIn&&!this.principal.isAuthenticated&&!!this.principal.policy&&this.principal.policy.issuers.length>0},i.prototype._signIn=function(e,t){e||(e=this.principal),t||(t=e.urls.signIn),void 0===e.policy&&(e.policy={});var r=e.policy.hints;r&&(t=i._addQueryParameter(t,r)),t=i._addQueryParameter(t,"token_type=fragment"),this.signInRedirectUri&&t.indexOf("app=")<0?t=i._addQueryParameter(t,"app="+encodeURIComponent(this.signInRedirectUri)):!e.urls.referrer&&t.indexOf("app=")<0&&(t=i._addQueryParameter(t,"app="+encodeURIComponent(window.location.toString()))),this.onSignIn&&this.onSignIn({url:t}),window.addEventListener&&window.addEventListener("popstate",function(){location.hash.startsWith("#gcx-")&&location.reload()},!1),window.location.assign(t)},i.prototype.signIn=function(e){this._signIn(this.principal,e)},i.prototype.canSignOut=function(){return this._signOutEnabled&&!!this.principal&&this.principal.isAuthenticated&&!!this.principal.urls.signOut},i.prototype.signOut=function(){this.onSignOut&&this.onSignOut();var e=this.principal.urls.signOut;this.signOutRedirectUri?e=i._addQueryParameter(e,"app="+encodeURIComponent(this.signOutRedirectUri)):this._signOutRedirectUrl&&(e=i._addQueryParameter(e,"app="+encodeURIComponent(this._signOutRedirectUrl))),window.location.assign(e)},i.prototype.getTokenFromPrincipal=function(e,t){var r=this,n=null;if(t===I.MapServiceType.DYNAMIC?n=this.principal.tokens.arcgis:t===I.MapServiceType.FEATURE?n=this.principal.tokens.arcgis:t===I.MapServiceType.IMAGE?n=this.principal.tokens.arcgis:t===I.MapServiceType.TILED?n=this.principal.tokens.arcgis:t===I.MapServiceType.WEBTILED?n=this.principal.tokens.arcgis:t===I.MapServiceType.VECTORTILE?n=this.principal.tokens.arcgis:t===esri.IdentityManagerBase?n=this.principal.tokens.arcgis:t===i&&((p={})[this.url]=this.principal.tokens.site,n=p,this.layerCatalogs.forEach(function(e){var t=r.url.replace(r.id,e.siteId);n[t]=r.principal.tokens.site})),!n)return null;e=e.toLowerCase();var s=document.createElement("a");s.href=e.toLowerCase();var a=s.protocol,o=s.hostname,l=s.port;e=s.href;for(var c in n){var u=c.toLowerCase();if(o==u)return n[c];if(o.endsWith("."+u))return n[c];try{if(s.href=a+"://"+u,s.port=l,e.startsWith(s.href))return n[c]}catch(e){}try{if(s.href=u,e.startsWith(s.href))return n[c]}catch(e){}}return null;var p},i.prototype._initMapHandler=function(e){this._mapInitialized=!0,null!==e&&null!==e.site&&e.loadServiceLayersInMap(e.site.getMap()),this._siteInitializeUpdate()},i.prototype._initMapErrorHandler=function(e){this._mapInitialized=!0,this._initializationFailedHandler(e),this._siteInitializeUpdate()},i.prototype._initNamedExtentsHandler=function(e){this._namedExtentsInitialized=!0,e&&this._initAsyncCollection(e.namedExtents,"namedextents",this.namedExtents,u.NamedExtent)},i.prototype._initTimeSlidersHandler=function(e){this._timeSlidersInitialized=!0,e&&this._initAsyncCollection(e.timeSliders,"timesliders",this.timeSliders,h.TimeSliderProfile)},i.prototype._initOverviewMapHandler=function(){this._overviewMapInitialized=!0,this._siteInitializeUpdate()},i.prototype._initOverviewMapErrorHandler=function(e){this._overviewMapInitialized=!0,this._initializationFailedHandler(e),this._siteInitializeUpdate()},i.prototype._initPrintTemplatesHandler=function(e){var t=this,i=0;this._printTemplatesInitialized=!0,e.printTemplates.length>0&&null!=e.printTemplates[0].visible?this._initAsyncCollection(e.printTemplates,"printtemplates",this.printTemplates,p.PrintTemplate):e.printTemplates.forEach(function(r){L.request({url:t.url+"/printtemplates/"+r.id,content:{f:"json"},load:function(r){i++,e.printTemplates.forEach(function(e){e.id===r.id&&(e.visible=r.visible)}),i===e.printTemplates.length&&t._initAsyncCollection(e.printTemplates,"printtemplates",t.printTemplates,p.PrintTemplate)},callbackParamName:"CallBack"})})},i.prototype.updateServiceTokensIfStale=function(){if(!this._serviceTokensStale){var e=new dojo.Deferred;return e.resolve(),e}return this._getUpdatedServiceTokens()},i.prototype._getUpdatedServiceTokens=function(){var e=this;if(0===this.updateInterval){var t=new dojo.Deferred;return t.resolve(),t}return this._serviceTokenRefresh?this._serviceTokenRefresh:(this._serviceTokenRefresh=new dojo.Deferred,this._updateServiceTokensOfAllSites(),new dojo.DeferredList(this._allDeferredDojosForUpdatingTokens).then(function(t){e._serviceTokensStale=!1;for(var i=0;i<t.length;i++)if(!t[i][0]){e._serviceTokensStale=!0,e._serviceTokenRefresh.reject(new Error("One or more service tokens failed to update")),e._serviceTokenRefresh=null;break}e._serviceTokenRefresh&&(e._serviceTokenRefresh.resolve(),e._serviceTokenRefresh=null),e._allDeferredDojosForUpdatingTokens=[]},function(t){e._allDeferredDojosForUpdatingTokens=[],e._serviceTokensStale=!0,e._serviceTokenRefresh.reject(t),e._serviceTokenRefresh=null}),this._serviceTokenRefresh)},i.prototype._updateServiceTokensBySendingRestRequest=function(e,t){var i=this.url;e&&(i=this.url.replace(this.id,e)),this._isTokenUpdateRequired(e)?L.request({url:i+"/update",content:{f:"json"},load:dojo.hitch(this,this._processServiceTokensHandler,e,t),error:dojo.hitch(this,this._processServiceTokensErrorHandler,t),callbackParamName:"CallBack"}):t.resolve()},i.prototype._isTokenUpdateRequired=function(e){if(!e)return!0;var t=this.essentialsMap.mapServices;if(t.length>0)for(var i=0;i<t.length;i++){var r=t[i];if(r.catalogId&&r.catalogId.split(".")[0]==e)return!0}return!1},i.prototype._processServiceTokensHandler=function(e,t,i){var r=this;i&&i.mapServiceTokens&&this._updateServiceTokens(this.essentialsMap,i.mapServiceTokens,e),e||(i&&i.overviewMapServiceTokens&&this._updateServiceTokens(this.overviewMap,i.overviewMapServiceTokens,e),i.geocodingServiceTokens&&i.geocodingServiceTokens.forEach(function(e){var t=r.geocodingEndpoints.filter(function(t){return t.id===e.id})[0];t&&(t.geocoderToken=e.token,dojo.publish("ServiceTokenRefreshed",{serviceUrl:t.geocoderUrl,token:e.token}))}),i.geometryServiceTokens&&i.geometryServiceTokens.forEach(function(e){var t=r.geometryEndpoints.filter(function(t){return t.id===e.id})[0];t&&(t.geometryServiceToken=e.token,dojo.publish("ServiceTokenRefreshed",{serviceUrl:t.geometryServiceUrl,token:e.token}))})),t.resolve()},i.prototype._processServiceTokensErrorHandler=function(e,t){this._serviceTokensStale=!0,e.reject(t),dojo.publish("ServiceTokenRefreshError",{error:t})},i.prototype._updateServiceTokens=function(e,t,i){if(e&&t)for(var r=0;t&&r<t.length;r++){var n;(n=i?e.findMapServiceById(i+"-"+t[r].id):e.findMapServiceById(t[r].id))&&n._updateServiceToken(t[r].token)}},i.prototype._updateServiceTokensFromPrincipal=function(e){if(e&&e.mapServices)for(var t=0;t<e.mapServices.length;t++){var r=e.mapServices[t];if(r&&r.serviceUrl){var n=this.getTokenFromPrincipal(r.serviceUrl,esri.IdentityManagerBase)||this.getTokenFromPrincipal(r.serviceUrl,i);n&&r._updateServiceToken(n)}}},i.prototype.refreshPrincipal=function(){return this._refreshPrincipal(),w.SecurityHelper.waitForSignIn()},i.prototype._refreshPrincipal=function(){var e=this,t={site:this,handled:!1,resumeRefresh:function(){return w.SecurityHelper.beginRefresh(e)},suspendRefresh:function(){return w.SecurityHelper.cancel()}};dojo.publish("geocortex_sessionExpiring",t),t.handled||t.resumeRefresh()},i.prototype._refreshPrincipalAt=function(e,t){var i=this;if(!e)return!1;var r=new Date(e).valueOf();isNaN(r)&&(console.log("_refreshPrincipalAt: Date parse failed, most likely due to ECMAScript 5 support only. Using alternate method."),r=Date.parse(e),console.log("_refreshPrincipalAt: Parsed '"+e+"' as raw value '"+r.toString()+"'."));var n=r-(new Date).valueOf()-t;return n=Math.max(1e4,n),window.setTimeout(function(){return i._refreshPrincipal()},n),!0},i.prototype.updatePrincipal=function(e){this.principal=e,this._refreshPrincipalAt(e.expiry,3e5),D.updateDefaultToken(this.principal.tokens.site,this.url),this.principal.tokens&&this.principal.tokens.arcgis&&(this._updateServiceTokensFromPrincipal(this.essentialsMap),this._updateServiceTokensFromPrincipal(this.overviewMap)),this.onPrincipalUpdated&&this.onPrincipalUpdated()},i.prototype._getCredential=function(e,t){var r=this.getTokenFromPrincipal(e,esri.IdentityManagerBase)||this.getTokenFromPrincipal(e,i),n=new dojo.Deferred;if(r){var s=new esri.Credential;s.token=r,s.server=this._getCredentialServer(e),n.resolve(s)}else n.reject(new Error("No token available for service {0}".format(e)));return n},i.prototype._getCredentialServer=function(e){var t=e.toLowerCase(),i=t.indexOf("/rest/services");return-1===i&&(i=t.indexOf("/sharing")),-1===i&&"/"===t.substr(-1)&&(i=t.length-1),i>-1?e.substring(0,i):e},i.prototype._hookGetCredential=function(){var e=this;esri.IdentityManagerBase.prototype.getCredential=function(t,i){try{return e._getCredential(t,i)}catch(e){console.log("Error getting site credential: "+e);var r=new dojo.Deferred;return r.reject(e),r}}},i.prototype._initSiteHandler=function(e){var t=this;if(this._hookGetCredential(),!e)throw new Error("Incorrect site object returned from initialization");if(this.configPreprocessor&&(this.configPreprocessor(e),this.configPreprocessor=null),e.__loadedOffline&&(this._serviceTokensStale=!0),e.contentPolicy&&(M.isNullOrUndefined(e.contentPolicy.trustedUrls)?this.trustedUrls=[]:this.trustedUrls=e.contentPolicy.trustedUrls),e.layerCatalogs)if(0==e.layerCatalogs.length)this.layerCatalogs=[];else for(var i=0;i<e.layerCatalogs.length;i++)this.layerCatalogs[i]=new d.LayerCatalog(e.layerCatalogs[i].siteId);if(e.principal){var r=e.principal;if(void 0===r.policy&&(r.policy={}),r.policy.authenticate&&!r.isAuthenticated)return void this._signIn(r);this.updatePrincipal(e.principal),r.isAuthenticated&&dojo.publish("geocortex_authenticationSucceeded",[{username:r.label,token:r.tokens.site}])}else if(e.arcGisPortalAuthentication&&e.arcGisPortalAuthentication.clientID){var s=e.arcGisPortalAuthentication;if(this.arcGisPortalSecurityContext=new n.ArcGisPortalSecurityContext(s.url,s.domains,s.clientID),!this.arcGisPortalSecurityContext.initiate()){if(this.arcGisPortalSecurityContext.error)if(this.arcGisPortalSecurityContext.error.code==R.OAuth2Error.ACCESS_DENIED_ERROR_CODE)this.onUserSignInCancelled&&this.onUserSignInCancelled({tryAgainAction:dojo.hitch(this,function(){R.OAuth2Client.redirectToLogOnPage(this.arcGisPortalSecurityContext.getLogOnUrl(),this.arcGisPortalSecurityContext.clientId)})});else{var o=new Error;o.name=this.arcGisPortalSecurityContext.error.code,o.message=this.arcGisPortalSecurityContext.error.description,this._initializationFailedHandler(o)}return}x.RestHelperHTTPService.arcGisPortalToken=this.arcGisPortalSecurityContext.tokenResult}this.hasGeocodingEndpoints=!!e.hasGeocodingEndpoints,this.hasGeometryEndpoints=!!e.hasGeometryEndpoints,this.hasGeoprocessingEndpoints=!!e.hasGeoprocessingEndpoints,this.hasNamedExtents=!!e.hasNamedExtents,this.hasNorthArrow=!!e.hasNorthArrow,this.hasTimeSliders=!!e.hasTimeSliders,this.hasOverviewMap=!!e.hasOverviewMap,this.hasPrintTemplates=!!e.hasPrintTemplates,this.hasViewers=!!e.hasViewers,this.hasVirtualDirectory=!!e.hasVirtualDirectory,this.hasWorkflows=!!e.hasWorkflows,this.hasSearchTables=!!e.hasSearchTables,this.hasWebMaps=!!e.hasWebMaps,this.dataProvider=e.dataProvider,this.displayName=e.displayName,this.id=e.id,this._signInEnabled=!!e.signInEnabled,this._signOutEnabled=!!e.signOutEnabled,this._signOutRedirectUrl=e.signOutRedirectUrl,this.timeZoneId=e.timeZoneId,this.displayTimeZoneId=e.displayTimeZoneId,void 0===e.currentVersion?this.currentVersion="3.0":this.currentVersion=e.currentVersion,e.hasOwnProperty("updateInterval")?(this.updateInterval=parseInt(e.updateInterval),isNaN(this.updateInterval)&&(this.updateInterval=0)):this.updateInterval=0,this.updateInterval>0&&(this._tokenIntervalHandle=setInterval(function(){t._getUpdatedServiceTokens()},Math.max(60,1e3*this.updateInterval))),this.properties=L._getProperties(e.properties),this.extensions=L._getExtensions(e.extensions),this.essentialsMap=new a.Map(this.originalUrl+"/map"),this.essentialsMap.site=this,dojo.connect(this.essentialsMap,"onInitialized",dojo.hitch(this,this._initMapHandler)),dojo.connect(this.essentialsMap,"onInitializationFailed",dojo.hitch(this,this._initMapErrorHandler)),this.hasOverviewMap&&(this.overviewMap=new a.Map(this.originalUrl+"/overviewmap"),this.overviewMap.site=this,dojo.connect(this.overviewMap,"onInitialized",dojo.hitch(this,this._initOverviewMapHandler)),dojo.connect(this.overviewMap,"onInitializationFailed",dojo.hitch(this,this._initOverviewMapErrorHandler))),e.map&&e.map.layerList&&(this.layerListRestEndpoint=e.map.layerList),!this.deepInitialize||this.getEssentialsVersion()<3.3||void 0===e.map?(this.essentialsMap.initialize(),this.hasOverviewMap?this.overviewMap.initialize():this._overviewMapInitialized=!0,e.hasKmlServiceEndpoint?L.request({url:this.url+"/kmlService",content:{f:"json"},load:dojo.hitch(this,this._initKmlEndpointHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._kmlServiceInitialized=!0})),callbackParamName:"CallBack"}):this._kmlServiceInitialized=!0,this.hasGeocodingEndpoints?L.request({url:this.url+"/geocoding",content:{f:"json"},load:dojo.hitch(this,this._initGeocodingEndpointsHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._geocodingEndpointsInitialized=!0})),callbackParamName:"CallBack"}):this._geocodingEndpointsInitialized=!0,this.hasGeometryEndpoints?L.request({url:this.url+"/geometry",content:{f:"json"},load:dojo.hitch(this,this._initGeometryEndpointsHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._geometryEndpointsInitialized=!0})),callbackParamName:"CallBack"}):this._geometryEndpointsInitialized=!0,this.hasGeoprocessingEndpoints?L.request({url:this.url+"/geoprocessing",content:{f:"json"},load:dojo.hitch(this,this._initGeoprocessingEndpointsHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._geoprocessingEndpointsInitialized=!0})),callbackParamName:"CallBack"}):this._geoprocessingEndpointsInitialized=!0,this.hasNamedExtents?L.request({url:this.url+"/namedextents",content:{f:"json"},load:dojo.hitch(this,this._initNamedExtentsHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._namedExtentsInitialized=!0})),callbackParamName:"CallBack"}):this._namedExtentsInitialized=!0,this.hasPrintTemplates?L.request({url:this.url+"/printtemplates",content:{f:"json"},load:dojo.hitch(this,this._initPrintTemplatesHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._printTemplatesInitialized=!0})),callbackParamName:"CallBack"}):this._printTemplatesInitialized=!0,this.hasSearchTables?L.request({url:this.url+"/searchtables",content:{f:"json"},load:dojo.hitch(this,this._initSearchTablesHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._searchTablesInitialized=!0})),callbackParamName:"CallBack"}):this._searchTablesInitialized=!0,this.hasTimeSliders?L.request({url:this.url+"/timesliders",content:{f:"json"},load:dojo.hitch(this,this._initTimeSlidersHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._timeSlidersInitialized=!0})),callbackParamName:"CallBack"}):this._timeSlidersInitialized=!0,this.hasWorkflows?L.request({url:this.url+"/workflows",content:{f:"json"},load:dojo.hitch(this,this._initWorkflowsHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._workflowsInitialized=!0})),callbackParamName:"CallBack"}):this._workflowsInitialized=!0,this.hasWebMaps?L.request({url:this.url+"/webmaps",content:{f:"json"},load:dojo.hitch(this,this._initWebMapHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._webMapsInitialized=!0})),callbackParamName:"CallBack"}):this._webMapsInitialized=!0):(this._initGeocodingEndpointsHandler(e),this._initGeometryEndpointsHandler(e),this._initGeoprocessingEndpointsHandler(e),this._initTimeSlidersHandler(e),this._initKmlEndpointHandler(e.kmlServiceEndpoint),this.essentialsMap.initialize(e.map),this._initNamedExtentsHandler(e),e.overviewMap?this.overviewMap.initialize(e.overviewMap):(this._overviewMapInitialized=!0,this._siteInitializeUpdate()),this._initPrintTemplatesHandler(e),this._initWorkflowsHandler(e),this._initSearchTablesHandler(e),this._initWebMapHandler(e)),this.documentStore.initialize(this),this._siteInitializeUpdate()},i.prototype._updateServiceTokensOfAllSites=function(){var e=this;this.layerCatalogs&&this.layerCatalogs.length>0&&this.layerCatalogs.forEach(function(t){var i=new dojo.Deferred;e._allDeferredDojosForUpdatingTokens.push(i),e._updateServiceTokensBySendingRestRequest(t.siteId,i)});var t=new dojo.Deferred;this._allDeferredDojosForUpdatingTokens.push(t),this._updateServiceTokensBySendingRestRequest(null,t)},i.prototype._initSiteErrorHandler=function(e){var t=this,i=e,r=i.principal;!r||r.isAuthenticated||403!=i.code?(r&&r.isAuthenticated&&403==i.code&&r.urls.signOut&&(this._signOutEnabled=!0,this.principal=r),this._geocodingEndpointsInitialized=!0,this._geometryEndpointsInitialized=!0,this._geoprocessingEndpointsInitialized=!0,this._kmlServiceInitialized=!0,this._namedExtentsInitialized=!0,this._printTemplatesInitialized=!0,this._workflowsInitialized=!0,this._searchTablesInitialized=!0,this._timeSlidersInitialized=!0,this._initializationFailedHandler(e),this._siteInitializeUpdate()):C.isNative()?dojo.publish("SiteSignInRequired",{error:i.code,callback:function(){return t._signIn(r)}}):this._signIn(r)},i.prototype._initWorkflowsHandler=function(e){this._workflowsInitialized=!0,e&&this._initAsyncCollection(e.workflows,"workflows",this.workflows,f.Workflow)},i.prototype._initSearchTablesHandler=function(e){this._searchTablesInitialized=!0,e&&this._initAsyncCollection(e.searchTables,"searchTables",this.searchTables,y.SearchTable)},i.prototype._initWebMapHandler=function(e){this._webMapsInitialized=!0,e&&e.webMapsInfo&&(this.webMapsInfo.layerTypes=e.webMapsInfo.layerTypes,this._initAsyncCollection(e.webMapsInfo.webMaps,"webmaps",this.webMapsInfo.webMaps,O.WebMapReference))},i.prototype._siteInitializeUpdate=function(){this._geocodingEndpointsInitialized&&this._geometryEndpointsInitialized&&this._geoprocessingEndpointsInitialized&&this._kmlServiceInitialized&&this._mapInitialized&&this._namedExtentsInitialized&&this._overviewMapInitialized&&this._printTemplatesInitialized&&this._workflowsInitialized&&this._searchTablesInitialized&&this._timeSlidersInitialized&&this._webMapsInitialized&&(this._initializedHandlerCalled||(this._initializedHandlerCalled=!0,this.siteInitializationTime=(new Date).getTime(),this._initializedHandler(this)))},i.prototype._handleSiteInitialization=function(e){e&&e.hasFeatureLayers?dojo.addOnLoad(dojo.hitch(this,function(){this._initSiteHandler(e)})):this._initSiteHandler(e)},i}(r.AsyncInitializable);i.Site=P})},"geocortex/essentials/StreamLayerService":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}();define(["require","exports","./MapService","./RestHelperHTTPService"],function(t,i,r,n){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var s=function(t){function i(){var e=null!==t&&t.apply(this,arguments)||this;return e._streamLayerOptions=null,e}return e(i,t),i.prototype._configureStreamSettings=function(e){if(e){var t={purgeOptions:{displayCount:1e4}};null!=e.maxDisplayCount&&(t.purgeOptions.displayCount=e.maxDisplayCount),null!=e.maxAge&&(t.purgeOptions.maxAge=e.maxAge),null!=e.maxTrackPoints&&(t.maximumTrackPoints=e.maxTrackPoints),e.definitionExpression&&(t.definitionExpression=e.definitionExpression),e.geometryDefinition&&(t.geometryDefinition=new esri.geometry.Extent(e.geometryDefinition)),this._streamLayerOptions=t}},i.prototype._configureObject=function(e,i){if(void 0===e)throw new Error("Incorrect map service object returned from initialization");this._configureStreamSettings(e.streamSettings),t.prototype._configureObject.call(this,e,i)},i.prototype._createServiceLayer=function(){var e=this.serviceUrl;this.serviceToken&&(e=n.RestHelperHTTPService.appendTokenToUrl(e,this.serviceToken));var i=new esri.layers.StreamLayer(e,this._streamLayerOptions);i.id=this.id,i.loadError&&this._layerLoadErrorHandler(i.loadError),this._initiallyVisible?i.show():i.hide(),dojo.connect(i,"onError",this,this._layerLoadErrorHandler),dojo.connect(i,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded)),this.attributionDataUrl&&""!==this.attributionDataUrl?(i.attributionDataUrl=this.attributionDataUrl,i.hasAttributionData=!0):this.hasAttributionData&&(i.attributionDataUrl=this.url+"/Attribution",i.hasAttributionData=!0),this.serviceLayer=i,t.prototype.initiateServiceFailureTimer.call(this)},i}(r.MapService);i.StreamLayerService=s})},"geocortex/essentials/TemplateParameter":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/TextField":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){return function(e,t,i,r){this.id=e,this.displayName=t,this.value=i,this.multiline=r}}();t.TextField=i})},"geocortex/essentials/TimeExtent":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/TimeInfo":function(){define(["require","exports","./utilities/StringUtilities"],function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getGcxTimeInfo=function(e,t,r){var n=null,s=null;if(e&&e.timeExtent&&(n=e.timeExtent&&e.timeExtent.startTime instanceof Date?e.timeExtent.startTime.valueOf():parseInt(e.timeExtent[0],10),s=e.timeExtent&&e.timeExtent.endTime instanceof Date?e.timeExtent.endTime.valueOf():parseInt(e.timeExtent[1],10)),(!n||isNaN(n))&&!t||(!s||isNaN(s))&&!r)return null;var a=t?i.StringUtilities.getDateFromRestDateString(t):new Date(n),o=r?i.StringUtilities.getDateFromRestDateString(r):new Date(s),l={};return l.timeExtent={startTime:a,endTime:o},e&&(e.startTimeField&&(l.startTimeField=e.startTimeField),e.endTimeField&&(l.endTimeField=e.endTimeField),e.trackIdField&&(l.trackIdField=e.trackIdField),e.timeReference&&(l.timeReference={},void 0!=e.timeReference.respectsDaylightSaving&&(l.timeReference.respectsDaylightSavings=e.timeReference.respectsDaylightSaving),void 0!=e.timeReference.timeZone&&(l.timeReference.timeZone=e.timeReference.timeZone)),e.exportOptions&&(l.exportOptions={},void 0!=e.exportOptions.timeDataCumulative&&(l.exportOptions.timeDataCumulative=e.exportOptions.timeDataCumulative),void 0!=e.exportOptions.timeOffset&&(l.exportOptions.timeOffset=e.exportOptions.timeOffset),void 0!=e.exportOptions.timeOffsetUnits&&(l.exportOptions.timeOffsetUnits=e.exportOptions.timeOffsetUnits),void 0!=e.exportOptions.useTime&&(l.exportOptions.useTime=e.exportOptions.useTime))),l}})},"geocortex/essentials/TimeReference":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/TimeSliderMode":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});!function(e){e[e.Extent=0]="Extent",e[e.Cumulative=1]="Cumulative",e[e.Instant=2]="Instant"}(t.TimeSliderMode||(t.TimeSliderMode={}))})},"geocortex/essentials/TimeSliderProfile":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}();define(["require","exports","./AsyncInitializable","./TimeSliderMode","./TimeUnits","./utilities/StringUtilities","./../geocortex"],function(t,i,r,n,s,a,o){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var l=function(t){function i(e){return t.call(this,e)||this}return e(i,t),i.prototype._configureObject=function(e,t){this.id=e.id,this.displayName=e.displayName,this.description=e.description,this.mode=n.TimeSliderMode[e.mode],this.displayFormat=e.displayFormat,this.timeExtent={startTime:a.StringUtilities.getDateFromRestDateString(e.startTime),endTime:a.StringUtilities.getDateFromRestDateString(e.endTime)},this.initialTimeExtent={startTime:a.StringUtilities.getDateFromRestDateString(e.initialStartTime),endTime:a.StringUtilities.getDateFromRestDateString(e.initialEndTime)},this.timeInterval=e.timeInterval,this.timeIntervalUnit=s.EssentialsTimeUnits[e.timeIntervalUnit],this.snapToTimeIntervals=e.snapToTimeIntervals,this.properties=o._getProperties(e.properties),this.extensions=o._getExtensions(e.extensions)},i}(r.AsyncInitializable);i.TimeSliderProfile=l})},"geocortex/essentials/TimeUnits":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){return function(){}}();i.UNIT_CENTURIES="esriTimeUnitsCenturies",i.UNIT_DAYS="esriTimeUnitsDays",i.UNIT_DECADES="esriTimeUnitsDecades",i.UNIT_HOURS="esriTimeUnitsHours",i.UNIT_MILLISECONDS="esriTimeUnitsMilliseconds",i.UNIT_MINUTES="esriTimeUnitsMinutes",i.UNIT_MONTHS="esriTimeUnitsMonths",i.UNIT_SECONDS="esriTimeUnitsSeconds",i.UNIT_WEEKS="esriTimeUnitsWeeks",i.UNIT_YEARS="esriTimeUnitsYears",i.UNIT_UNKNOWN="esriTimeUnitsUnknown",t.TimeUnits=i;var r=function(){return function(){}}();r.Century=i.UNIT_CENTURIES,r.Day=i.UNIT_DAYS,r.Decade=i.UNIT_DECADES,r.Hour=i.UNIT_HOURS,r.MilliSecond=i.UNIT_MILLISECONDS,r.Minute=i.UNIT_MINUTES,r.Month=i.UNIT_MONTHS,r.Second=i.UNIT_SECONDS,r.Week=i.UNIT_WEEKS,r.Year=i.UNIT_YEARS,t.EssentialsTimeUnits=r})},"geocortex/essentials/TokenResult":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){return function(){}}();t.TokenResult=i})},"geocortex/essentials/WebmapLayerType":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){return function(){}}();i.FEATURE_LAYER="ArcGISFeatureLayer",i.MAP_SERVICE="ArcGISMapServiceLayer",i.STREAM_SERVICE="ArcGISStreamLayer",i.TILED_MAP_SERVICE="ArcGISTiledMapServiceLayer",i.IMAGE_SERVICE="ArcGISImageServiceLayer",i.IMAGE_SERVICE_VECTOR="ArcGISImageServiceVectorLayer",i.TILED_IMAGE_SERVICE="ArcGISTiledImageServiceLayer",i.VECTOR_TILE_SERVICE="VectorTileLayer",i.BING_AERIAL="BingMapsAerial",i.BING_HYBRID="BingMapsHybrid",i.BING_ROAD="BingMapsRoad",i.BING_AERIAL_WITH_LABELS="BingMapsAerialWithLabels",i.OPEN_STREET_MAP="OpenStreetMap",i.WEB_TILED="WebTiledLayer",i.KML="KML",i.WMS="WMS",i.CSV="CSV",i.GEO_RSS="GeoRSS",i.GROUP_LAYER="GroupLayer",t.WebmapLayerType=i})},"geocortex/essentials/WebMapReference":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}();define(["require","exports","./AsyncInitializable","./utilities/LayerUtilities","./GeoRssLayerService","./MapServiceConstants","geocortex/framework/utils/utils"],function(t,i,r,n,s,a,o){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var l=function(t){function i(e){var i=t.call(this,e)||this;return i.displayName=null,i.id=null,i._isLoading=!1,i._onLoadingComplete=null,i._onLoadingError=null,i._layerTypes=null,i._arcgisSharingRegularExpressions=[new RegExp("(https?://.*?/)home/item.html\\?id=(\\w*)"),new RegExp("(https?://.*?/)home/webmap/viewer.html\\?webmap=(\\w*)"),new RegExp("(https?://.*?/)explorer/\\?open=(\\w*)"),new RegExp("(https?://.*?/sharing)/content/items/(\\w*)/data"),new RegExp("(https?://.*?/sharing)/content/items/(\\w*)")],i.site=null,i}return e(i,t),i.prototype.isLoading=function(){return this._isLoading},i.prototype._getUrlPortions=function(e){for(var t={id:null,path:null},i=0;i<this._arcgisSharingRegularExpressions.length;++i){var r=this._arcgisSharingRegularExpressions[i],n=e.match(r);if(n&&n.length>0){t.id=n[2],t.path=n[1];break}}return t},i.prototype._loadWebMap=function(e,t,i){var r=this;if(e&&e.path){if(!esri.arcgis||!esri.arcgis.Portal)return;new esri.arcgis.Portal(e.path).on("ready",function(t){if(t){var n={q:"id:"+e.id};t.queryItems(n).then(function(e){if(e){var t=e.results[0];esri.request({url:t.itemDataUrl}).then(function(e){r._processItemData(e),i.resolve(!1)})}})}})}else{var n="Web map with address "+t+" cannot be loaded.",s=esri.urlToObject(t);if(s.query=s.query||{},s.query&&(s.query.webmap||s.query.id)){var a,o=s.query.webmap||s.query.id;esri.arcgis&&esri.arcgis.utils?a=esri.arcgis.utils.getItem:esri.arcgis.getItem&&(a=esri.arcgis.getItem),a&&a(o).then(function(e){e?this._processItemData(e.itemData):this._onLoadingError(new Error(n)),i.resolve(!1)})}else this._onLoadingError(new Error(n)),i.resolve(!1)}},i.prototype._initializeWebMap=function(e,t,i,r){var n=this;if(this.isLoading())r&&r(new Error("Currently loading web map."));else{this._isLoading=!0;var s=new dojo.Deferred;this._onLoadingComplete=dojo.hitch(this,i),this._onLoadingError=dojo.hitch(this,r),this._layerTypes=this.site.webMapsInfo.layerTypes;var a=this._getUrlPortions(e.url);this._loadWebMap(a,e.url,s),s.then(function(e){n._isLoading=e})}},i.prototype._processItemData=function(e){if(e){var t=e.operationalLayers;t&&this._processLayerCollection(t,"Operational");var i=e.baseMap.baseMapLayers;i&&this._processLayerCollection(i,"Base")}},i.prototype._processLayerCollection=function(e,t){var i=this;if(e){for(var r=[],n=0;n<e.length;++n){var s=e[n];if(!this._layerTypes||!(!s.type&&this._layerTypes.indexOf("Null")>=0||s.type&&this._layerTypes.indexOf(s.type)>=0)){var a=this._addLayerToMap(s);r.push(a)}}new dojo.DeferredList(r).then(function(e){if(e){for(var r=[],n=0;n<e.length;++n){var s=e[n][1];s&&(s.length>0?r=r.concat(s):r.push(s))}r.length>0&&i.site.essentialsMap.addServiceLayers(r,t)}},function(e){i._onLoadingError(new Error("There was an error loading a layer: "+e))})}},i.prototype._addLayerToMap=function(e){var t=new dojo.Deferred,i=null;this.site.getMap();switch(e.type){case"CSV":var r=new dojo._Url(window.location.href),l=new dojo._Url(e.url);r.host===l.host&&r.port===l.port&&r.scheme===l.scheme||(e.url=esri.config.defaults.io.proxyUrl+e.url),n.LayerUtilities.createFeatureLayerFromCsv(e,null).then(function(i){i&&i.setVisibility&&i.setVisibility(e.visibility),t.resolve(i)},function(e){t.reject(e)});break;case"GeoRSS":var c=new s.GeoRssLayerService(e.url);c.essentialsMap=this.site.essentialsMap;var u={displayName:e.title,serviceType:a.MapServiceType.GEORSS,connectionString:"url="+e.url,feedImageUri:e.pointSymbol?e.pointSymbol.url:null,opacity:e.opacity,id:e.id||o.alphaNumericToken(),visible:e.visibility};c._configureObject(u),t.resolve(c);break;case"WebTiledLayer":if(!e.wmtsInfo&&esri.layers&&esri.layers.WebTiledLayer){var p={id:e.id,subDomains:e.subDomains,copyright:e.copyright};i=new esri.layers.WebTiledLayer(e.templateUrl,p),e.title&&(i.name=e.title)}t.resolve(i);break;case"WMS":t.resolve(null);break;default:var h=null;e.url||e.featureCollection&&(h=this._addFeatureCollectionToMap(e.featureCollection)),t.resolve(h)}return t.promise},i.prototype._addFeatureCollectionToMap=function(e){var t=this.site.getMap(),i=[];return dojo.forEach(e.layers,function(e){var r=new esri.layers.FeatureLayer(e,{outSR:t.spatialReference});r.layerId=o.alphaNumericToken(),i.push(r)}),i},i.prototype._loadingRestComplete=function(e){this._isLoading=!1,!e&&this._onLoadingError&&this._onLoadingError(new Error("No results")),e.error&&this._onLoadingError&&this._onLoadingError(e.error),this._onLoadingComplete&&this._onLoadingComplete(e.results)},i.prototype._loadingRestError=function(e){this._isLoading=!1,this._onLoadingError&&this._onLoadingError(e)},i.prototype._configureObject=function(e,t){if(void 0===e||void 0===e.id)throw new Error("Incorrect Web Map reference object returned from initialization");this.displayName=e.displayName,this.id=e.id,t&&(this.isInitialized=!0),this._initializeWebMap(e,this.site,function(e){},function(e){throw e})},i}(r.AsyncInitializable);i.WebMapReference=l})},"geocortex/essentials/WFSLayerService":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}();define(["require","exports","./MapService","./RestHelperHTTPService"],function(t,i,r,n){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var s=function(t){function i(){var e=null!==t&&t.apply(this,arguments)||this;return e._WFSLayerOptions=null,e._defaultMaxFeaturesInOnDemandMode=500,e._defaultMaxFeaturesInSnapshotMode=1e3,e._defaultWFSLayerMode="snapshot",e}return e(i,t),i.prototype._configureWFSSettings=function(e){var t=this.serviceUrl.indexOf("?");if(this.baseUrl=t>-1?this.serviceUrl.substring(0,t):this.serviceUrl,this.layers.length<1||!this.layers[0].wfsLayerName)throw new Error("Failed to initialize WFS layer. Layer name or layer not defined.");var i=this.layers[0].wfsLayerName.split(":")[1],r={url:this.baseUrl,name:i,layerName:i,mode:this._defaultWFSLayerMode,swapXY:!1,swapXYFilter:!1,version:"1.0.0"};e&&(e.version&&(r.version=e.version),e.spatialReference?r.wkid=this.operationalSpatialReference=e.spatialReference.wkid:e.operationalSpatialReference&&(r.wkid=this.operationalSpatialReference=e.operationalSpatialReference),e.mode&&(r.mode=e.mode),e.customParameters&&(r.customParameters=e.customParameters),e.infoTemplate&&(r.infoTemplate=e.infoTemplate));var n=e.properties?e.properties.filter(function(e){return"maxFeatures"===e.name})[0]||null:null,s=e.maxFeatures||(n?n.value||null:null);(s=parseInt(s,10))&&!isNaN(s)?r.maxFeatures=s:r.maxFeatures=r.mode===this._defaultWFSLayerMode?this._defaultMaxFeaturesInSnapshotMode:this._defaultMaxFeaturesInOnDemandMode,this._WFSLayerOptions=r},i.prototype._configureObject=function(e,i){if(void 0===e)throw new Error("Incorrect map service object returned from initialization");this._restWFSConfigObject=e,t.prototype._configureObject.call(this,e,i)},i.prototype._createServiceLayer=function(){var e=this;this._configureWFSSettings(this._restWFSConfigObject),this.serviceToken&&(this._WFSLayerOptions.url=n.RestHelperHTTPService.appendTokenToUrl(this.serviceUrl,this.serviceToken));var i=new esri.layers.WFSLayer(this._WFSLayerOptions);i.id=this.id,this.serviceLayer=i,dojo.connect(i,"onError",dojo.hitch(this,this._layerLoadErrorHandler)),dojo.connect(i,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded)),i.initialize(this._WFSLayerOptions,function(t){i.selectLayer(e._WFSLayerOptions,function(t){e._initiallyVisible&&e.layers[0].configuredVisible?i.show():i.hide(),e.attributionDataUrl&&""!==e.attributionDataUrl?(i.attributionDataUrl=e.attributionDataUrl,i.hasAttributionData=!0):e.hasAttributionData&&(i.attributionDataUrl=e.url+"/Attribution",i.hasAttributionData=!0),i.onLoad(i)})}),t.prototype.initiateServiceFailureTimer.call(this)},i}(r.MapService);i.WFSLayerService=s})},"geocortex/essentials/Workflow":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}();define(["require","exports","./AsyncInitializable","./../workflow/ArgumentInfo","./../workflow/ExternalActivityInfo","./../geocortex"],function(t,i,r,n,s,a){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var o=function(t){function i(e){var i=t.call(this,e)||this;return i.displayName=null,i.error=null,i.extensions=[],i.externalActivities={},i.id=null,i.properties={},i.site=null,i._inputs=[],i._outputs=[],i}return e(i,t),i.prototype.getInputs=function(){return this._cloneArgumentInfoCollection(this._inputs)},i.prototype.getOutputsMetadata=function(){return this._cloneArgumentInfoCollection(this._outputs)},i.prototype._cloneArgumentInfoCollection=function(e){var t=null;if(null!==e){t=[];for(var i=0;i<e.length;i++)t.push(e[i]._internalClone())}return t},i.prototype._configureObject=function(e,t){if(void 0===e.id||void 0===e.displayName)throw new Error("Incorrect workflow object returned from initialization");var i,r;if(this.id=e.id,this.displayName=e.displayName,this.runOnStartup=!!e.runOnStartup,this.error=e.error,this._inputs=[],this._outputs=[],this.externalActivities=[],e.inputs)for(var o=0;o<e.inputs.length;o++)i=e.inputs[o],(r=new n.ArgumentInfo)._configureObject(i),this._inputs[o]=r;if(e.outputs)for(o=0;o<e.outputs.length;o++)i=e.outputs[o],(r=new n.ArgumentInfo)._configureObject(i),this._outputs[o]=r;if(e.externalActivities)for(o=0;o<e.externalActivities.length;o++){var l=e.externalActivities[o],c=new s.ExternalActivityInfo;c._configureObject(l),this.externalActivities[o]=c}this.properties=a._getProperties(e.properties),this.extensions=a._getExtensions(e.extensions)},i}(r.AsyncInitializable);i.Workflow=o})},"geocortex/essentials/XmlUtils":function(){define(["require","exports"],function(e,t){"use strict";function i(e){if(e)try{if(3===e.nodeType||4===e.nodeType){var t=String.prototype.trim?e.nodeValue.trim():dojo.string.trim(e.nodeValue);return 0===t.length?null:t}if(1===e.nodeType){var r={},n=0;dojo.forEach(e.attributes,function(e){r[e.nodeName]=e.nodeValue});var s=e.childNodes;return dojo.forEach(s,function(e){var t=i(e);t&&(n++,r[e.nodeName]?(!1===dojo.isArray(r[e.nodeName])&&(r[e.nodeName]=[r[e.nodeName]]),r[e.nodeName].push(t)):r[e.nodeName]=t)}),1===n&&r["#text"]?r["#text"]:1===n&&r["#cdata-section"]?r["#cdata-section"]:r}}catch(e){throw new Error("Unable to parse XML object: "+e.toString())}return null}Object.defineProperty(t,"__esModule",{value:!0}),t.parseObject=i,t.getAllNodes=function(e){var t=new dojo.NodeList;if(dojo.isIE)for(var i=e.childNodes,r=0;r<i.length;r++)t.push(i[r]);else t=dojo.query("*",e);return t},t.getNodes=function(e,t,i){var r=new dojo.NodeList;if(dojo.isIE){var n=i.getElementsByTagName(e);dojo.forEach(n,function(e,i,n){var s=e.getElementsByTagName(t);dojo.forEach(s,function(e,t,i){r.push(e)})})}else r=dojo.query(e+" > "+t,i);return r},t.getValue=function(e,t){if(e){var i=e;if(dojo.isString(e)){var r=e.split(" > ");i=this.getNodes(r[0],r[1],t)[0]}return i.firstChild&&i.firstChild.nodeValue?i.firstChild.nodeValue:"Node not valid"}return"No Value"},t.getAttribute=function(e,t){if(e){if(dojo.isIE){for(var i=0;i<e.attributes.length;i++)if(e.attributes[i].nodeName==t)return e.attributes[i].nodeValue;return null}return e.getAttribute(t)}return"No Value"}})},"geocortex/essentials/catalog/CatalogEntry":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){return function(){this.id=null,this.displayName=null,this.entries=null,this.type=null,this.entries=[]}}();t.CatalogEntry=i})},"geocortex/essentials/catalog/LayerCatalogDetail":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){return function(){this.mapServiceId=null,this.entries=null,this.entries=[]}}();t.LayerCatalogDetail=i})},"geocortex/essentials/catalog/LayerCatalogDetailEntry":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/catalog/LayerCatalogDetailsParams":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){return function(){this.ids=null,this.ids=[]}}();t.LayerCatalogDetailsParams=i})},"geocortex/essentials/catalog/LayerCatalogParams":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){return function(){}}();t.LayerCatalogParams=i})},"geocortex/essentials/documents/BatchRequestBuilder":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.cloneDocument=function(e,t,i){return{action:"cloneDocument",id:e,document:t,createOnly:i}},t.createDocument=function(e,t){return{action:"createDocument",document:e,streamId:t}},t.createMoniker=function(e,t){return{action:"createMoniker",moniker:e,createOnly:t}},t.deleteDocument=function(e){return{action:"deleteDocument",id:e}},t.deleteMoniker=function(e){return{action:"deleteMoniker",id:e}},t.describe=function(e){return{action:"describe",streamId:e}},t.generateLinks=function(e){return{action:"generateLinks",count:e}},t.modifyDocument=function(e,t){return{action:"modifyDocument",document:e,streamId:t}},t.openDocument=function(e,t,i){return{action:"openDocument",id:e,streamId:t,startPosition:i}},t.peekDocument=function(e,t){return void 0===t&&(t=!1),{action:"peekDocument",id:e,throwIfMissing:t}},t.peekDocumentAccess=function(e){return{action:"peekDocumentAccess",id:e}},t.peekMoniker=function(e,t){return{action:"peekMoniker",id:e,throwIfMissing:t}},t.peekMonikerAccess=function(e){return{action:"peekMonikerAccess",id:e}},t.previewDocument=function(e,t){return{action:"previewDocument",id:e,streamId:t}},t.previewMoniker=function(e,t){return{action:"previewMoniker",id:e,streamId:t}},t.readDocument=function(e,t){return{action:"readDocument",id:e,format:t}},t.restoreDocument=function(e){return{action:"restoreDocument",globalId:e}},t.restoreMoniker=function(e){return{action:"restoreMoniker",globalId:e}},t.resumeDocument=function(e,t){return{action:"resumeDocument",globalId:e,streamId:t}},t.scrub=function(e){return{action:"scrub",scrubOptions:e}},t.searchDocuments=function(e){return{action:"searchDocuments",documentQuery:e}},t.searchMonikers=function(e){return{action:"searchMonikers",monikerQuery:e}},t.searchRoles=function(e){return{action:"searchRoles",searchClause:e}},t.searchUsers=function(e){return{action:"searchUsers",searchClause:e}},t.self=function(){return{action:"self"}},t.touchDocument=function(e,t,i){return{action:"touchDocument",id:e,modify:t,throwIfMissing:i}},t.updateDocument=function(e){return{action:"updateDocument",document:e}},t.updateMoniker=function(e){return{action:"updateMoniker",moniker:e}},t.writeDocument=function(e){return{action:"writeDocument",content:e}}})},"geocortex/essentials/documents/Document":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/documents/DocumentConstants":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});!function(e){e.AUTHOR_DESCRIPTION="author.description",e.AUTHOR_ISSUER_TITLE="author.issuerTitle",e.AUTHOR_TITLE="author.title",e.DESCRIPTION="description",e.EDITOR_DESCRIPTION="editor.description",e.EDITOR_ISSUER_TITLE="editor.issuerTitle",e.EDITOR_TITLE="editor.title",e.FILE_TYPE="fileType",e.GRANT_TOKEN="grants.token",e.ISSUER_TITLE="issuerTitle",e.TAGS="tags",e.TIME_CREATION="timeOfCreation",e.TIME_LAST_ACCESS="timeOfLastAccess",e.TIME_LAST_MODIFICATION="timeOfLastModification",e.TITLE="title"}(t.DocumentField||(t.DocumentField={}));!function(e){e.BLOB="application/octet-stream",e.JSON="application/json",e.TEXT="text/plain",e.XML="application/xml"}(t.ContentType||(t.ContentType={}));!function(e){e.BLOB="blob",e.JSON="json",e.TEXT="text",e.XML="xml"}(t.DocumentFormat||(t.DocumentFormat={}));!function(e){e.FROZEN="frozen",e.OWNER="owner",e.READER="reader",e.WRITER="writer",e.READER_LINK="readerLink",e.WRITER_LINK="writerLink",e.GLOBAL_CREATE="global_create",e.GLOBAL_READER="global_reader",e.GLOBAL_WRITER="global_writer"}(t.GrantKind||(t.GrantKind={}));!function(e){e.PUBLIC="public",e.USER="user"}(t.GrantID||(t.GrantID={}));!function(e){e.LINK="link",e.ROLE="role",e.USER="user",e.POLICY="policy"}(t.MonikerKind||(t.MonikerKind={}));!function(e){e.RANGES="ranges",e.SPATIAL_DISJOINT="spatialDisjoint",e.SPATIAL_INTERSECTS="spatialIntersects",e.SPATIAL_WITHIN="spatialWithin",e.MATCHES="matches",e.VALUES="values"}(t.FilterMethod||(t.FilterMethod={}));!function(e){e.REQUIRE="require",e.EXCLUDE="exclude",e.INCLUDE="include"}(t.FilterType||(t.FilterType={}))})},"geocortex/essentials/documents/DocumentStore":function(){define(["require","exports","./DocumentConstants","./../utilities/UrlUtilities","./../../geocortex","./BatchRequestBuilder"],function(e,t,i,r,n,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.LINK_QUERY_STRING_KEY="link";var a=function(){function e(){this._initializeDeferred=new dojo.Deferred,this.supported=!1,this.isInitialized=!1,this.self=[],this.userMonikers=[],this.policyMonikers=[],this.userFilter={}}return e.prototype.initialize=function(e){this._site=e;var t=/^(.*?)(\/*)$/.exec(e.originalUrl)[1];return this._rootUrl=r.UrlUtilities.simplify(t+"/../../documents"),this.supported=e.getEssentialsVersion()>=4.05,this.onInitializeAttempt()},e.prototype.onInitialized=function(){return this._initializeDeferred.promise},e.prototype.onInitializeAttempt=function(){var t=this;if(this._initializeAttemptThenable)return this._initializeAttemptThenable;if(!this.supported){var i=new Error("The Document Store is not supported in the current version of Essentials.");return this._initializeDeferred.reject(i),this._initializeAttemptThenable=(new dojo.Deferred).reject(i)}return this._initializeAttemptThenable=n.request({url:this._rootUrl+"/self",content:{f:"json"},handleAs:"json"},{usePost:!1}).then(e._processError).then(function(e){t._processSelf(e),t.isInitialized=!0,t._initializeDeferred.resolve()}).then(null,function(e){throw t._initializeAttemptThenable=null,e})},e.prototype.getRootUrl=function(){return this._verifySupported(),this._rootUrl+"/"},e.prototype.canCreate=function(){return this.userMonikers.length>0},e.prototype.hasPolicyGrant=function(e){return this.policyMonikers.some(function(t){return t.grants.some(e)})},e.prototype.add=function(e){var t=this,i={document:dojo.mixin({},e)};void 0!==e.content&&(i.json=e.content,delete i.document.content);var r=s.writeDocument(i);return this.perform(r,!0).then(function(e){return e.document}).then(function(e){return t._processDocument(e)})},e.prototype.addFromFormData=function(e){throw new Error("Not implemented.")},e.prototype.addFromForm=function(e){throw new Error("Not implemented.")},e.prototype.getById=function(t,r,n){var a=this;if(void 0===r&&(r=!1),void 0===n&&(n=i.DocumentFormat.JSON),this._verifyDocId(t),r){var o=s.readDocument(t,n);return this.perform(o).then(function(t){return e._processReadDocumentResponse(t,n)}).then(function(e){return a._processDocument(e)})}var l=s.peekDocument(t);return this.perform(l).then(function(e){return e.document}).then(function(e){return a._processDocument(e)})},e.prototype.getContentUrl=function(e){throw new Error("Not implemented.")},e.prototype.updateById=function(e,t){var i=this;this._verifyDocId(e),t.timeOfLastModification||(t.timeOfLastModification=null),t.editor||(t.editor=null);var r=[];for(var n in t)t.hasOwnProperty(n)&&r.push(n);if(void 0!==t.content){var a={json:t.content};delete t.content,a.document=dojo.mixin({id:e,updates:r},t);var o=s.writeDocument(a);return this.perform(o,!0).then(function(e){return e.document}).then(function(e){return i._processDocument(e)})}var l=dojo.mixin({id:e,updates:r},t),c=s.updateDocument(l);return this.perform(c,!0).then(function(e){return e.document}).then(function(e){return i._processDocument(e)})},e.prototype.deleteById=function(e){var t=this;this._verifyDocId(e);var i=s.deleteDocument(e);return this.perform(i,!0).then(function(e){return e.document}).then(function(e){return t._processDocument(e)})},e.prototype.query=function(t){var i=this,r=dojo.mixin({},t);r.sort&&r.sort.forEach(function(t,i,r){e.matchesFilterFields.some(function(e){return e===t})&&(r[i]="{0}_exact".format(t))}),r.sortDescending&&r.sortDescending.forEach(function(t,i,r){e.matchesFilterFields.some(function(e){return e===t})&&(r[i]="{0}_exact".format(t))});var n=s.searchDocuments(r);return this.perform(n).then(function(e){return Array.isArray(e.matchingDocuments.results)&&e.matchingDocuments.results.forEach(function(e){return i._processDocument(e.entity)}),e.matchingDocuments})},e.prototype.perform=function(t,i){var r=this;if(void 0===i&&(i=!1),!t.action)throw new Error("The Document Store batch request does not contain an action");var s=t.action;return"perform"!==s&&delete t.action,this._guestLink&&(t.link=this._guestLink),t.f="json",this.onInitializeAttempt().then(function(){return r._verifySupported()}).then(function(){return n.request({url:r._rootUrl+"/"+s,content:n.encodeJson(t),handleAs:"json"},{usePost:i})}).then(e._processError)},e.prototype.isOwner=function(e){return!e||!e.access||e.access.change},e.prototype.isReadOnly=function(e){return!(!e||!e.access)&&(!!e.access.view&&!e.access.edit&&!e.access.change)},e.prototype.isPublic=function(e){return!!(e&&e.id&&e.grants)&&e.grants.some(function(e){return e.globalId===i.GrantID.PUBLIC&&(!1===e.revoke||!0===e.assert)})},e.prototype.setGuestLink=function(e){this._guestLink=e},e._processError=function(e){if(e.error)throw e.error;return e},e.prototype._processDocument=function(e){return e.timeOfCreation&&(e.timeOfCreation=new Date(e.timeOfCreation)),e.timeOfLastAccess&&(e.timeOfLastAccess=new Date(e.timeOfLastAccess)),e.timeOfLastModification&&(e.timeOfLastModification=new Date(e.timeOfLastModification)),e.timeOfDeletion&&(e.timeOfDeletion=new Date(e.timeOfDeletion)),e.timeOfExpiration&&(e.timeOfExpiration=new Date(e.timeOfExpiration)),e.access&&!e.access.monikerIds&&(e.access.monikerIds=this.userMonikers.map(function(e){return e.id})),e},e._processReadDocumentResponse=function(e,t){var i=e.content.document;return i.content=e.content[t],i},e.prototype._processSelf=function(e){if(this.self=e.monikers,this.userMonikers=e.monikers.filter(function(e){return e.kind===i.MonikerKind.USER}),this.policyMonikers=e.monikers.filter(function(e){return e.kind===i.MonikerKind.POLICY}),this.userMonikers.length>0){var t=this.userMonikers.map(function(e){return{string:"{0}|{1}".format(i.GrantKind.OWNER,e.globalId)}});this.userFilter={field:i.DocumentField.GRANT_TOKEN,method:i.FilterMethod.VALUES,range:t}}},e.prototype._verifyDocId=function(e){if(!e)throw new Error("The Document ID must be set.");if(/[/?#\s]/.test(e))throw new Error("The Document ID '{0}' contains illegal characters.".format(e))},e.prototype._verifySupported=function(){if(!this.supported)throw new Error("The Document Store is not supported in the current version of Essentials.")},e}();a.matchesFilterFields=[i.DocumentField.TITLE,i.DocumentField.DESCRIPTION,i.DocumentField.ISSUER_TITLE,i.DocumentField.AUTHOR_TITLE,i.DocumentField.AUTHOR_DESCRIPTION,i.DocumentField.AUTHOR_ISSUER_TITLE,i.DocumentField.EDITOR_TITLE,i.DocumentField.EDITOR_DESCRIPTION,i.DocumentField.EDITOR_ISSUER_TITLE],t.DocumentStore=a})},"geocortex/essentials/documents/Parameters":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/exportMap/BingEnvironment":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PRODUCTION="Production"})},"geocortex/essentials/exportMap/ExportContext":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/exportMap/ExportDynamicMapLayerDefinition":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/exportMap/ExportFeature":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/exportMap/ExportFeatureCollection":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/exportMap/ExportLayer":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/exportMap/ExportLayerFeatureSet":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/exportMap/ExportLayoutOptions":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/exportMap/ExportMapLayerDefinition":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/exportMap/ExportMapOptions":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/exportMap/ExportMapParameters":function(){define(["require","exports","./../ReportParameters"],function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){return function(){this.operationParameters=null,this.reportParameters=null,this.queryParameters=null,this.operationParameters={},this.reportParameters=new i.ReportParameters}}();t.ExportMapParameters=r})},"geocortex/essentials/exportMap/ExportMapService":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/exportMap/ExportMapTask":function(){define(["require","exports","./../FeatureLayerService","./../../geocortex","./../utilities/UrlUtilities","./../utilities/PrintUtilities","./../utilities/PromiseUtilities","./ExportMapTypes","./BingEnvironment","./../ReportParameters","./../utilities/GraphicsLayerUtilities","./../Field","./../WebmapLayerType"],function(e,t,i,r,n,s,a,o,l,c,u,p,h){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var d=function(){function e(e){if(this.resource=null,this._esriMap=null,this._essentialsRestUrl=null,this._site=null,this.DEFAULT_OBJECTID_FIELD="defaultGcxObjectId",this._populateFromResource(e),!this._esriMap||!this._essentialsRestUrl)throw new Error("Unable to create ExportMapTask from the resource.")}return e.prototype._populateFromResource=function(e){e.hasOwnProperty("extentManager")?(this._esriMap=e.getMap(),this._essentialsRestUrl=e.url+"/export",this._site=e.site):e.hasOwnProperty("maximumResolution")?(this._esriMap=e.site.getMap(),this._essentialsRestUrl=e.url+"/print",this._site=e.site):e&&(this._esriMap=e.site.getMap(),this._essentialsRestUrl=e.url+"/run",this._site=e.site)},e.prototype.generateMapImageUrl=function(e){var t=this,i=new dojo.Deferred;return this._marshalContent(e).then(function(e){var n={url:t._essentialsRestUrl,content:e,load:i.resolve,error:i.reject,callbackParamName:"CallBack"};r.request(n)}),i},e.prototype.generateWebMapJson=function(e){var t,i=this,r=new dojo.Deferred;e.reportParameters&&e.reportParameters.scale&&(t=parseFloat(e.reportParameters.scale.scale));var n=new esri.tasks.PrintTask("http://3275ec4b-ad36-465e-97e9-a20acaae8d53/",{async:!1}),s=null;try{s=this._getWebMap(n,this._esriMap,t)}catch(e){r.reject(new Error("Could not create ExportContext definition. {0} Verify that subroutines have not changed.".format(e&&e.message?e.message:"Unable to determine cause.")))}return s&&s.operationalLayers?new dojo.DeferredList(s.operationalLayers.map(function(e){return i._inferLayerType(e)})).then(function(e){for(var t=s.operationalLayers,n=0;n<t.length;n++)t[n].layerType=e[n][1];i._handleOperationalLayers(s);for(n=0;n<t.length;n++)if(!t[n].layerType){var a=t.splice(n,1)[0];console.warn("Removed layer from the map definition because it's type could not be inferred. Layer JSON:\n"+JSON.stringify(a,null,4)),n--}r.resolve(s)}):r.reject(new Error("ExportContext definition was empty")),r},e.prototype._getWebMap=function(e,t,i){var r=new esri.tasks.PrintTemplate;r.outScale=i;for(var n=[],s=0,a=t.graphicsLayerIds;s<a.length;s++){var o=a[s];1===(u=t.getLayer(o)).opacity&&(u.setOpacity(.999),n.push(u))}try{return e._getPrintDefinition(t,r)}finally{for(var l=0,c=n;l<c.length;l++){var u=c[l];u.setOpacity(1)}}},e.prototype._getPrintingObjectForEssentials=function(e){var t=new dojo.Deferred,i=new esri.tasks.PrintTask("http://3275ec4b-ad36-465e-97e9-a20acaae8d53/",{async:!1}),r=null;try{r=this._getWebMap(i,this._esriMap,e)}catch(e){t.reject(new Error("Could not create ExportContext definition. {0} Verify that subroutines have not changed.".format(e&&e.message?e.message:"Unable to determine cause.")))}return r?(this._removeInternalLayers(r),this._handleFeatureLayers(r),this._handleDynamicLayerDefs(r),this._cleanOutVisibility(r),this._handleWebTiledLayers(r),this._handleLayersAttribution(r,this._esriMap),this._handleHeatmapRenderer(r,this._esriMap),this._handleClusters(r,this._esriMap),this._adjustMeasurementsMarkup(r),this._adjustPlotCoordinatesMarkup(r),this._removeAttributes(r),this._adjustText(r),this._setServiceVisibilities(r),this._adjustPlotCoordinatesMarkupOrder(r),this._finalizePrintingContext(r),this._convertSymbolsToBase64(r).then(function(e){return t.resolve(e)},function(e){return t.reject(new Error("Converting symbols to base64 failed: {0}".format(e&&e.message?e.message:"Unable to determine cause")))})):t.reject(new Error("ExportContext definition was empty")),t},e.prototype._removeInternalLayers=function(e){for(var t=e.operationalLayers.length-1;t>=0;t--){var i=e.operationalLayers[t].id;i&&(u.getGraphicsLayerIdsToExclude([u.excludeFromExportMapTaskName]).indexOf(i)>-1&&e.operationalLayers.splice(t,1))}},e.prototype._convertSymbolsToBase64=function(e){for(var t=new dojo.Deferred,i=[],r={},o=0;o<e.operationalLayers.length;o++){var l=e.operationalLayers[o];if(l.featureCollection&&l.featureCollection.layers)for(var c=0;c<l.featureCollection.layers.length;c++){var u=l.featureCollection.layers[c];if(u.featureSet&&u.featureSet.features)for(var p=0;p<u.featureSet.features.length;p++){var h=u.featureSet.features[p];if(h&&h.symbol&&"esriPMS"===h.symbol.type){var d=h.symbol;d.url&&i.push(d)}}}}if(Modernizr&&Modernizr.canvas){for(var f=[],o=0;o<i.length;o++){var y=i[o].url;if(y&&(!r.hasOwnProperty(y)&&!i[o].imageData)){r[y]={url:null,data:null};var m=s.PrintUtilities.getImageAsBase64(y);f.push(m)}}a.PromiseUtilities.settle(f).then(function(s){s.forEach(function(e){if(e.isFulfilled()){var t=e.value();t&&t.url&&t.data&&(r[t.url]={data:t.data})}else{var s=e.reason();s&&s.url&&(r[s.url]={url:n.UrlUtilities.simplify(y)})}for(var a=0;a<i.length;a++){var o=i[a],l=r[o.url];l&&(l.data?(o.imageData=l.data,delete o.url):l.url&&(o.url=l.url)),o.yoffset&&(o.yoffset=-1*o.yoffset)}}),t.resolve(e)})}else{for(o=0;o<i.length;o++)(y=i[o].url)&&(i[o].url=n.UrlUtilities.simplify(y));t.resolve(e)}return t},e.prototype._adjustMeasurementsMarkup=function(e){var t=this._getLayer(e,"_measurement");t&&t.id&&this._adjustSvgSymbols(t)},e.prototype._adjustMeasurementsMarkupForGP5=function(e){var t=this._getLayer(e,"_measurement");t&&t.id&&this._adjustSvgSymbolsForGP5(t)},e.prototype._adjustPlotCoordinatesMarkup=function(e){var t=this._getLayer(e,"_coordinates");t&&t.id&&this._adjustSvgSymbols(t)},e.prototype._adjustPlotCoordinatesMarkupForGP5=function(e){var t=this._getLayer(e,"_coordinates");t&&t.id&&this._adjustSvgSymbolsForGP5(t)},e.prototype._adjustPlotCoordinatesMarkupOrder=function(e){var t=this._getLayer(e,"_coordinates");if(t&&t.featureCollection&&t.featureCollection.layers)for(var i=null,r=null,n=0;n<t.featureCollection.layers.length;n++){var s=t.featureCollection.layers[n];if(s.layerDefinition&&("pointLayer"===s.layerDefinition.name?i=s:"textLayer"===s.layerDefinition.name&&(r=s)),i&&r){if(i.featureSet&&i.featureSet.features&&i.featureSet.features.length>0&&r.featureSet&&r.featureSet.features&&r.featureSet.features.length>0&&r.featureSet.features.length/i.featureSet.features.length==1.5){for(var a=[];i.featureSet.features.length>0;)a.push(r.featureSet.features.pop()),a.push(r.featureSet.features.pop()),a.push(r.featureSet.features.pop()),a.push(i.featureSet.features.pop()),a.push(i.featureSet.features.pop());i.featureSet.features=a.reverse()}break}}},e.prototype._getLayer=function(e,t){for(var i=0;i<e.operationalLayers.length;i++){var r=e.operationalLayers[i];if(r&&r.id&&r.id.indexOf(t)>-1&&r.featureCollection&&r.featureCollection.layers)return r}},e.prototype._adjustSvgSymbols=function(e){for(var t=e.id,i=[],r=this._esriMap.getLayer(t).graphics.filter(function(e){return!("simplemarkersymbol"!=e.symbol.type||!e.visible)}),n=0;n<r.length;n++)i.push(r[n].toJson());for(n=0;n<e.featureCollection.layers.length;n++)if("pointLayer"===e.featureCollection.layers[n].layerDefinition.name){e.featureCollection.layers[n].featureSet.features=i;break}},e.prototype._adjustSvgSymbolsForGP5=function(e){var t,i=e.id,r=e.featureCollection;if(r&&r.layers&&r.layers.length){var n=r.layers.filter(function(e){return"pointLayer"===e.layerDefinition.name});if(!n.length)return;var s=n[0];t=s.featureSet?s.featureSet.features:void 0}for(var a=[],o=0,l=this._esriMap.getLayer(i).graphics.filter(function(e){return!("simplemarkersymbol"!==e.symbol.type||!e.visible)});o<l.length;o++){var c=l[o];a.push(c.toJson())}for(var u=0;u<t.length;u++){var p=a[u].symbol;p.size||(p.size=t[u].symbol.width)}for(var h=0,d=e.featureCollection.layers;h<d.length;h++){var f=d[h];"pointLayer"===f.layerDefinition.name&&(f.featureSet.features=a)}},e.prototype._adjustText=function(e){for(var t=0;t<e.operationalLayers.length;t++){var i=e.operationalLayers[t];if(i&&i.id&&i.featureCollection&&i.featureCollection.layers){for(var r=!1,n=0;n<i.featureCollection.layers.length;n++){var a=i.featureCollection.layers[n];if(a&&a.layerDefinition&&"textLayer"===a.layerDefinition.name){r=!0;break}}if(!r)continue;var o=i.id,l=[],c=this._esriMap.getLayer(o);if(c&&c.graphics){for(var u=c.graphics.filter(function(e){return!(!("textsymbol"==e.symbol.type||e.symbol instanceof esri.symbol.TextSymbol)||!e.visible)}),p=0;p<u.length;p++){var h=u[p],d=s.PrintUtilities.adjustTextSymbol(h,c.id);if(d){var f=new esri.Graphic(h.toJson());f.symbol=d,l.push(f.toJson())}}for(p=0;p<i.featureCollection.layers.length;p++)"textLayer"===i.featureCollection.layers[p].layerDefinition.name&&(i.featureCollection.layers[p].featureSet.features=l)}}}},e.prototype._setServiceVisibilities=function(e){if(e.operationalLayers)for(var t=e.operationalLayers,i=0;i<t.length;i++){var r=t[i],n=this._esriMap.getLayer(r.id);r&&(r.visibility=!n||n.visible)}},e.prototype._handleDynamicLayerDefs=function(e){if(this._site&&e.operationalLayers)for(var t=e.operationalLayers,i=0;i<t.length;i++){var r=t[i].id,n=this._site.essentialsMap.findMapServiceById(r);if(n&&n.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer){var s=t[i],a=n.serviceLayer;if(!s)continue;if(s.layers){for(var o=[],l=s.layers,c=0;c<l.length;c++){var u=l[c];if(u&&(u.id||0===u.id)){var p=u.id,h={id:p,name:u.name,geometryType:u.geometryType?u.geometryType:null};if(u.layerDefinition&&((u.layerDefinition.drawingInfo||u.layerDefinition.source)&&(h.layerDefinition||(h.layerDefinition={}),h.layerDefinition.drawingInfo=u.layerDefinition.drawingInfo,h.layerDefinition.source=u.layerDefinition.source),u.layerDefinition.definitionExpression&&(h.layerDefinition?h.layerDefinition.definitionExpression=u.layerDefinition.definitionExpression:h.layerDef=u.layerDefinition.definitionExpression)),p||0===p){var d=n.findLayerById(p.toString());d&&d.displayName&&h.layerDefinition&&(h.layerDefinition.displayName=d.displayName)}o.push(h)}}s.layers=o}a.gdbVersion&&(s.gdbVersion=a.gdbVersion),s.visibleLayers=n.serviceLayer.visibleLayers,s.visibility=!0}}},e.prototype._handleFeatureLayers=function(e){if(this._site&&e.operationalLayers)for(var t=e.operationalLayers,i=0;i<t.length;i++){var r=t[i].id,n=this._site.essentialsMap.findMapServiceById(r);if(n&&n.serviceLayer instanceof esri.layers.FeatureLayer){var s=n.serviceLayer,a=t[i],o={id:r,opacity:a.opacity,visibility:!0,url:a.url,minScale:a.minScale?a.minScale:0,maxScale:a.maxScale?a.maxScale:0};s.gdbVersion&&(o.gdbVersion=s.gdbVersion),a.layerDefinition?(a.layerDefinition.drawingInfo&&(o.drawingInfo=a.layerDefinition.drawingInfo),a.layerDefinition.definitionExpression&&(o.where=a.layerDefinition.definitionExpression)):o.where=s.getDefinitionExpression(),o.featureCollection=a.featureCollection,t[i]=o}}},e.prototype._cleanOutVisibility=function(e){if(e.operationalLayers)for(var t=e.operationalLayers,i=0;i<t.length;i++)if(t[i].visibleLayers)for(var r=0;r<t[i].visibleLayers.length;r++)if(-1==t[i].visibleLayers[r]){t[i].visibleLayers.splice(r,1);break}},e.prototype._handleWebTiledLayers=function(e){if(e.operationalLayers)for(var t=e.operationalLayers,i=0;i<t.length;i++)t[i].type===o.WEBTILED?t[i]={id:t[i].id,opacity:t[i].opacity,visibility:!0}:t[i].type!==o.BINGAERIAL&&t[i].type!==o.BINGAERIALLABELS&&t[i].type!==o.BINGHYBRID&&t[i].type!==o.BINGROADS||(t[i].type===o.BINGAERIALLABELS&&(t[i].type=o.BINGHYBRID),t[i]={id:t[i].id,opacity:t[i].opacity,visibility:!0,type:t[i].type,token:t[i].key,serverType:l.PRODUCTION})},e.prototype._handleLayersAttribution=function(e,t){var i=t.layerIds.concat(t.graphicsLayerIds),r=new RegExp(".*mapservices/([^/]*)/Attribution[^/]*");e.operationalLayers.forEach(function(e){for(var n in i)if(i.hasOwnProperty(n)){var s=i[n];if(e.id===s){var a=t.getLayer(s);if(a.hasAttributionData&&a.attributionDataUrl){var o=r.exec(a.attributionDataUrl);if(o&&o.length>1){var l=o[1];e.mapServiceId=l}}else!a.layerId||e.id.indexOf("-")>-1||(e.mapServiceId=a.layerId);break}}})},e.prototype._handleHeatmapRenderer=function(e,t){t.layerIds.concat(t.graphicsLayerIds).forEach(function(i){var r=t.getLayer(i);if(r.visible&&void 0!==r.renderer&&r.renderer instanceof esri.renderer.HeatmapRenderer)for(var n=null!==r.opacity&&void 0!==r.opacity?r.opacity:1,s=r.minScale?r.minScale:0,a=r.maxScale?r.maxScale:0,o=r.getDefinitionExpression()?r.getDefinitionExpression():"",l=r.gdbVersion?r.gdbVersion:"",c=r.renderer.toJson(),u=r.url,p=r.renderer.field?r.renderer.field:"",h={renderer:c},d={type:"HeatMap",id:i,opacity:n,minScale:s,maxScale:a,where:o,gdbVersion:l,url:u,layerDefinition:{name:r.name,geometryType:"esriGeometryPoint",displayField:p},drawingInfo:h},f=0;f<e.operationalLayers.length;f++)if(e.operationalLayers[f].id.startsWith("null_image")){e.operationalLayers[f]=d;break}})},e.prototype._handleClusters=function(e,t){var i=t.layerIds.concat(t.graphicsLayerIds),r=[];e.operationalLayers.forEach(function(e,t,i){e.id.endsWith("-cluster")&&r.push(e.id)}),r.forEach(function(t){for(var i=0;i<e.operationalLayers.length;++i)if(e.operationalLayers[i].id===t){e.operationalLayers.splice(i,1);break}}),i.forEach(function(i){var r=t.getLayer(i);if(r.id.endsWith("-cluster")&&r.visible&&void 0!==r.renderer&&r.renderer instanceof esri.renderer.ClassBreaksRenderer&&r.featureLayer&&r.singleFeatureLayer){for(var n=r.featureLayer,s=n.id,a=r.url,o=r.renderer.attributeField,l=r.clusterRadius.get(),c=r.maxFeaturesInCluster.get(),u=r._clusterLabelColor,p=r.singleFeatureLayer.renderer.toJson(),h=r.renderer.toJson(),d=n.name,f=null!==n.opacity&&void 0!==n.opacity?n.opacity:1,y=n.minScale?n.minScale:0,m=n.maxScale?n.maxScale:0,v=n.getDefinitionExpression()?n.getDefinitionExpression():"",g=n.gdbVersion?n.gdbVersion:"",_=0;_<e.operationalLayers.length;++_)if(e.operationalLayers[_].id===s){null===n.renderer&&e.operationalLayers.splice(_,1);break}if(0==r.singleFeatureLayer.graphics.length){var S={type:"Cluster",id:i,opacity:f,minScale:y,maxScale:m,where:v,gdbVersion:g,url:a,layerDefinition:{name:d,geometryType:"esriGeometryPoint",displayField:o},drawingInfo:{renderer:h,singleSymbolRenderer:p,labelColor:u,distance:l,maxFeaturesInCluster:c}};e.operationalLayers.splice(_,0,S)}}})},e.prototype._removeAttributes=function(e){if(e.operationalLayers)for(var t=0;t<e.operationalLayers.length;t++){var i=e.operationalLayers[t];if(i&&i.featureCollection&&i.featureCollection.layers)for(var r=0;r<i.featureCollection.layers.length;r++){var n=i.featureCollection.layers[r];if((!(n&&n.layerDefinition&&n.layerDefinition.drawingInfo&&n.layerDefinition.drawingInfo.renderer)||"uniqueValue"!==n.layerDefinition.drawingInfo.renderer.type&&"classBreaks"!==n.layerDefinition.drawingInfo.renderer.type)&&(n&&n.featureSet&&n.featureSet.features))for(var s=0;s<n.featureSet.features.length;s++){var a=n.featureSet.features[s];a&&a.attributes&&delete a.attributes}}}},e.prototype._finalizePrintingContext=function(e){this._fixMapServiceIds(e,this._esriMap,this._site)},e.prototype._fixMapServiceIds=function(e,t,i){if(e.operationalLayers&&t&&i)for(var r=e.operationalLayers,n=0;n<r.length;n++){var s=r[n].id,a=t.getLayer(s);if(a&&(a instanceof esri.layers.WMSLayer||a instanceof esri.layers.TiledMapServiceLayer)){for(var o=null,l=0;l<i.essentialsMap.mapServices.length;l++)if(i.essentialsMap.mapServices[l].serviceLayer==a){o=i.essentialsMap.mapServices[l];break}o&&(r[n].id=o.id)}}},e.prototype._fixDisplayNames=function(e,t,r){if(e&&t&&r)for(var n=0,s=e;n<s.length;n++){for(var a=s[n],o=a.id,l=t.getLayer(o),c=null,u=r.essentialsMap.mapServices,p=0;p<u.length;p++)if(u[p].serviceLayer===l){c=u[p];break}c&&(c instanceof i.FeatureLayerService?c.layers&&c.layers.length>0&&(a.title=c.layers[0].displayName):(a.title=c.displayName,"WMS"===c.mapServiceType?this._fixWmsLayerDisplayNames(a.layers,c.layers):this._fixLayerDisplayNames(a.layers,c.layers)))}},e.prototype._fixLayerDisplayNames=function(e,t){if(e&&t)for(var i=this,r=0,n=e;r<n.length;r++)!function(e){var r=t.filter(function(t){return t.id===e.id.toString()});if(r.length>0){var n=r[0];e.name=n.displayName,e.layers&&i._fixLayerDisplayNames(e.layers,t)}}(n[r])},e.prototype._fixWmsLayerDisplayNames=function(e,t){if(e&&t)for(var i=this,r=0,n=e;r<n.length;r++)!function(e){var r=t.filter(function(t){return t.id===e.name.toString()});if(r.length>0){var n=r[0];e.title=n.displayName,e.layers&&i._fixWmsLayerDisplayNames(e.layers,t)}}(n[r])},e.prototype._marshalContent=function(e){var t,i=this,r=new dojo.Deferred;return e.reportParameters&&e.reportParameters.scale&&(t=parseFloat(e.reportParameters.scale.scale)),this._getPrintingObjectForEssentials(t).then(function(t){var n={f:"json",if:"WebMap,blankMap"};if(i._site&&(t.product="Geocortex Essentials "+i._site.currentVersion,i._site.displayTimeZoneId&&(n.displayTimeZoneId=i._site.displayTimeZoneId)),e.reportParameters){var s=e.reportParameters;if(t.mapOptions||(t.mapOptions={extent:null}),delete t.mapOptions.scale,s.scale){var a=parseFloat(s.scale.scale);a&&!isNaN(a)&&(t.mapOptions.scale=a)}s.targetSpatialReference&&(t.mapOptions.spatialReference=s.targetSpatialReference),s.extentType==c.ReportParameters.CURRENT_EXTENT&&i._esriMap?t.mapOptions.extent=i._esriMap.extent:s.extentType==c.ReportParameters.FULL_EXTENT&&i._site&&i._site.essentialsMap?t.mapOptions.extent=i._site.essentialsMap.fullExtent:s.extentType==c.ReportParameters.INITIAL_EXTENT&&i._site&&i._site.essentialsMap?t.mapOptions.extent=i._site.essentialsMap.initialExtent:s.extentType==c.ReportParameters.CUSTOM_EXTENT&&s.customExtent&&(t.mapOptions.extent=s.customExtent);var o={dpi:null,outputSize:[]};if(s.imageWidth?o.outputSize[0]=s.imageWidth:o.outputSize[0]=i._esriMap.width,s.imageHeight?o.outputSize[1]=s.imageHeight:o.outputSize[1]=i._esriMap.height,s.resolution?o.dpi=s.resolution.dpi:o.dpi=96,t.exportOptions=o,s.grid&&s.grid.id){var l={grid:s.grid.id};t.layoutOptions=l}if(s.fields&&s.fields.length>0)for(var u=0;u<s.fields.length;u++)n[s.fields[u].id]=s.fields[u].value;s.outputFormat&&(n.outputFormat=s.outputFormat),s.featureIds&&(n.featureIDs=s.featureIds.join(",")),s.includeGeoreferenceData&&(n.georef=s.includeGeoreferenceData),s.includeData&&(n.of=n.of?n.of+",includeData":"includeData")}e.queryParameters&&(n=dojo.mixin(e.queryParameters,n)).geometry&&(n.geometry=JSON.stringify(n.geometry)),e.operationParameters&&(n=dojo.mixin(e.operationParameters,n)),s.notificationEmailAddress&&(n.emailAddress=s.notificationEmailAddress),n.data=JSON.stringify(t),r.resolve(n)},function(e){return r.reject(new Error("Failed to serialize ExportContext content: {0}".format(e&&e.message?e.message:"Unable to determine cause")))}),r},e.prototype._inferLayerType=function(e){var t=new dojo.Deferred;if(e.layerType)return t.resolve(e.layerType),t;var i=e.type?e.type.toUpperCase():void 0;if(i){if(i===h.WebmapLayerType.WMS.toUpperCase())return t.resolve(h.WebmapLayerType.WMS),t;if(i===h.WebmapLayerType.WEB_TILED.toUpperCase())return t.resolve(h.WebmapLayerType.WEB_TILED),t;if("WMTS"===i)return t.resolve(h.WebmapLayerType.WEB_TILED),t;if(i===h.WebmapLayerType.BING_AERIAL.toUpperCase())return t.resolve(h.WebmapLayerType.BING_AERIAL),t;if(i===h.WebmapLayerType.BING_ROAD.toUpperCase())return t.resolve(h.WebmapLayerType.BING_ROAD),t;if(i===h.WebmapLayerType.BING_HYBRID.toUpperCase()||i===h.WebmapLayerType.BING_AERIAL_WITH_LABELS.toUpperCase())return t.resolve(h.WebmapLayerType.BING_HYBRID),t}if(e.url){var r=e.url,n=e.token;if(r.match(/.*\/MapServer\/\d{1,}\/?$/i)||r.match(/.*\/FeatureServer\/\d{1,}\/?$/i))return t.resolve(h.WebmapLayerType.FEATURE_LAYER),t;if(r.match(/.*\/StreamServer\/?$/i))return t.resolve(h.WebmapLayerType.STREAM_SERVICE),t;if(r.match(/.*\/ImageServer\/?$/i))return this._getLayerData(r,n).then(function(e){return e.cacheType?h.WebmapLayerType.TILED_IMAGE_SERVICE:h.WebmapLayerType.IMAGE_SERVICE});if(r.match(/.*\/MapServer\/?(?:$|\?)/i))return this._getLayerData(r,n).then(function(e){return e.tileInfo?h.WebmapLayerType.TILED_MAP_SERVICE:h.WebmapLayerType.MAP_SERVICE});if(r.match(/.*\\.(csv|txt)$/i))return t.resolve(h.WebmapLayerType.CSV),t;if(r.match(/.*\\.kml$/i))return t.resolve(h.WebmapLayerType.KML),t;if(r.match(/.*(\\.xml|rss\/?)$/i))return t.resolve(h.WebmapLayerType.GEO_RSS),t}else{if(e.templateUrl&&e.tileInfo)return t.resolve(h.WebmapLayerType.WEB_TILED),t;if(e.featureCollection)return t.resolve(h.WebmapLayerType.FEATURE_LAYER),t;if(e.styleUrl)return t.resolve(h.WebmapLayerType.VECTOR_TILE_SERVICE),t;if(e.mapUrl)return t.resolve(h.WebmapLayerType.WMS),t;if(e.imageData){var s=void 0;if(this._site){var a=e.id,o=this._site.essentialsMap.findMapServiceById(a);o&&"VectorTile"===o.mapServiceType&&(s=h.WebmapLayerType.VECTOR_TILE_SERVICE)}return t.resolve(s),t}}return t.resolve(null),t},e.prototype._getLayerData=function(e,t){var i=new dojo.Deferred;return esri.request({url:e,content:{f:"json",token:t},handleAs:"json",callbackParamName:"callback"}).then(function(e){i.resolve(e)},function(e){i.reject(new Error("Could not infer type for layer {0}.".format(e&&e.message?e.message:"Request for layer data failed")))}),i},e.prototype._handleOperationalLayers=function(e){if(e&&e.operationalLayers){var t=e.operationalLayers;this._removeInternalLayers(e),this._adjustMeasurementsMarkupForGP5(e),this._adjustPlotCoordinatesMarkupForGP5(e),this._adjustPlotCoordinatesMarkupOrder(e),this._handleWmsLayers(t),this._handleWmtsLayers(t),this._fixDisplayNames(e.operationalLayers,this._esriMap,this._site),this._fixMapImageSublayerVisibility(e.operationalLayers,this._esriMap),this._handleVectorTileLayers(t),this._handleHeatmapRenderer(e,this._esriMap),this._handleClusters(e,this._esriMap),this._fixHeatMapAndClusterLayers(e.operationalLayers),this._fixDynamicLayerDefsForGP5(e.operationalLayers),this._injectLegendOptions(e.operationalLayers),this._handleDrawingLayers(e.operationalLayers,this._esriMap)}},e.prototype._handleWmtsLayers=function(e){for(var t=0,i=e;t<i.length;t++){var r=i[t];r.layerType!==h.WebmapLayerType.WEB_TILED||"WMTS"!==r.type.toUpperCase()||r.wmtsInfo||(r.wmtsInfo={customLayerParameters:r.customLayerParameters,customParameters:r.customParameters,layerIdentifier:r.layer,tileMatrixSet:r.tileMatrixSet,url:r.url})}},e.prototype._handleWmsLayers=function(e){for(var t=0,i=e;t<i.length;t++){var r=i[t];if(r.layerType===h.WebmapLayerType.WMS){r.layers||(r.layers=[]);var n=r.visibleLayers;if(0===r.layers.length&&n)for(var s=0,a=n;s<a.length;s++){var o=a[s];r.layers.push({name:o})}}}},e.prototype._handleVectorTileLayers=function(e){if(this._site&&e)for(var t=0,i=e;t<i.length;t++){var r=i[t];if(r.layerType===h.WebmapLayerType.VECTOR_TILE_SERVICE){var n=this._site.essentialsMap.findMapServiceById(r.id);if(!n)continue;var s=n.serviceLayer;if(!s)continue;var a=s.currentStyleInfo.styleUrl,o=s.currentStyleInfo.serviceUrl,l=esri.id,c=l._getServerInstanceRoot(a),u=l._getServerInstanceRoot(o);r.styleUrl=a,l._isServerRsrc(a)&&(r.token=n.serviceToken),n.serviceToken&&c.toLowerCase()!==u.toLowerCase()&&l._isServerRsrc(o)&&(r.serviceUrl=o,r.serviceToken=n.serviceToken),delete r.imageData}}},e.prototype._fixHeatMapAndClusterLayers=function(e){for(var t=0,i=e;t<i.length;t++){var r=i[t];if(("HeatMap"===r.type||"Cluster"===r.type)&&r.drawingInfo){var n=r.layerDefinition;(n=n||{}).drawingInfo=r.drawingInfo,delete r.drawingInfo,r.layerType=h.WebmapLayerType.FEATURE_LAYER}}},e.prototype._fixDynamicLayerDefsForGP5=function(e){for(var t=0,i=e;t<i.length;t++){var r=i[t],n=this._site.essentialsMap.findMapServiceById(r.id);if(n&&n.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer){var s=n.layers,a=r.layers;if(a&&a.length&&s&&s.length)for(var o=0,l=a;o<l.length;o++)!function(e){if(!e.layerDefinition||!e.layerDefinition.drawingInfo)return"continue";if(void 0!==e.minScale&&null!==e.minScale)return"continue";if((s=s.filter(function(t){return t.id===e.id.toString()}))&&s.length){var t=s[0];t.minScale===1/0?e.minScale=0:e.minScale=t.minScale||0,e.maxScale=t.maxScale||0}}(l[o])}}},e.prototype._injectLegendOptions=function(e){for(var t=0,r=e;t<r.length;t++){var n=r[t],s=this._site.essentialsMap.findMapServiceById(n.id);if(s&&s.layers.length>0)if(s instanceof i.FeatureLayerService)n.showLegend=s.layers[0].includeInLegend;else{n.sublayerIdsToHideInLegend=[];for(var a=0,o=s.layers;a<o.length;a++){var l=o[a];l.includeInLegend||n.sublayerIdsToHideInLegend.push(l.id)}if("Tiled"===s.mapServiceType){var c=s.serviceLayer.layerInfos;if(c&&c.length)for(var u=0,p=c;u<p.length;u++)!function(e){0===s.layers.filter(function(t){return t.id===e.id.toString()}).length&&n.sublayerIdsToHideInLegend.push(e.id)}(p[u])}}}},e.prototype._fixMapImageSublayerVisibility=function(e,t){if(e&&t)for(var i=0,r=e;i<r.length;i++){var n=r[i];if(n.layerType===h.WebmapLayerType.MAP_SERVICE){var s=t.getLayer(n.id);if(s){var a=s.visibleLayers,o=s.layerInfos;if(o&&o.length>0){for(var l=o.length-1;l>=0;l--){var c=o[l];if(c.subLayerIds&&c.subLayerIds.length>0&&!a.includes(c.id.toString()))for(var u=0,p=c.subLayerIds;u<p.length;u++){var d=p[u];if(a.includes(d.toString())){a.push(c.id.toString());break}}}n.visibleLayers=a.map(function(e){return parseInt(e,10)})}}}}},e.prototype._verifyObjectIdField=function(e){var t=e.layerDefinition;if(t&&!t.objectIdField){var i=this._getObjectIdField(t);t.objectIdField=i,this._updateLayerDefinitionFields(t,i),this._addObjectIdAttribute(e,i)}},e.prototype._getObjectIdField=function(e){if(e&&e.objectIdField)return e.objectIdField;if(e&&e.fields&&e.fields.length>0)for(var t=0,i=e.fields;t<i.length;t++){var r=i[t];if(r.type===p.EsriFieldTypes.esriFieldTypeOID)return r.name}return this.DEFAULT_OBJECTID_FIELD},e.prototype._updateLayerDefinitionFields=function(e,t){e.fields=e.fields?e.fields:[];for(var i=0,r=e.fields;i<r.length;i++){var n=r[i];if(n.name===t&&n.type===p.EsriFieldTypes.esriFieldTypeOID)return}e.fields.push({name:t,type:p.EsriFieldTypes.esriFieldTypeOID})},e.prototype._addObjectIdAttribute=function(e,t){if(e&&e.featureSet&&e.featureSet.features&&e.featureSet.features.length>0)for(var i=1,r=0,n=e.featureSet.features;r<n.length;r++){var s=n[r];s.attributes=s.attributes?s.attributes:{},s.attributes[t]=i++}},e.prototype._handleDrawingLayers=function(e,t){if(e&&t)for(var i=0,r=e;i<r.length;i++){var n=r[i];if(n.layerType===h.WebmapLayerType.FEATURE_LAYER){var s=t.getLayer(n.id);s&&"esri.layers.GraphicsLayer"===s.declaredClass&&!s.renderer&&(n.showLegend=!1)}}},e}();t.ExportMapTask=d})},"geocortex/essentials/exportMap/ExportMapTypes":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WEBTILED="WebTiledLayer",t.BINGAERIAL="BingMapsAerial",t.BINGAERIALLABELS="BingMapsAerialWithLabels",t.BINGROADS="BingMapsRoad",t.BINGHYBRID="BingMapsHybrid"})},"geocortex/essentials/exportMap/ExportOptions":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/exportMap/ExportSymbol":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/serviceDiscovery/ResultItem":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/serviceDiscovery/ServiceDiscoveryProvider":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/serviceDiscovery/serviceDiscoveryServicePoint":function(){define(["require","exports","./../MapService","./../FeatureLayerService"],function(e,t,i,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e){this.service=e}return e.prototype.postProcess=function(e){e.thumbnailUrl||(e.thumbnailUrl=this.service.formatQuery("connections/{0}/preview?f=json&providerName={1}&url={2}",e.connection.id,e.serviceProviderName,e.url));for(var t in e.children)this.postProcess(e.children[t]);return e},e.prototype.findServices=function(e){var t=this.postProcess.bind(this.postProcess),i=this.service.formatQuery("connections/find?f=json&term={0}",e);return this.service.getRequest(i,"results").select(t)},e.prototype.expandService=function(e,t,i){if(1==arguments.length){var r=e;e=r.connection.id,t=r.serviceProviderName,i=r.url}var n=this.postProcess.bind(this.postProcess),s=this.service.formatQuery("connections/{0}/expand?f=json&providerName={1}&url={2}",e,t,i);return this.service.getRequest(s,null).select(n)},e.prototype.suggestHints=function(e){var t=this.service.formatQuery("connections/suggest?f=json&term={0}",e);return this.service.getRequest(t,"hints")},e.prototype.realizeMapService=function(e,t,n,s){if(1==arguments.length){var a=e;e=a.connection.id,t=a.serviceProviderName,n=a.url}var o=this.service.formatQuery("connections/{0}/realize?f=json&providerName={1}&url={2}&sr={3}",e,t,n,s);return this.service.getRequest(o,null).select(function(e){if(e.serviceType.indexOf("FeatureLayer")>=0){var t=new r.FeatureLayerService(n);return t._configureObject(e,!0),t}var s=new i.MapService(n);return s._configureObject(e,!0),s})},e}();t.ServiceDiscoveryServicePoint=n})},"geocortex/essentials/serviceDiscovery/SiteServiceDiscoveryProvider":function(){define(["require","exports","./../utilities/UrlUtilities","geocortex/framework/SimplePromise","./../../geocortex","./../ServiceHelper","./../utilities/ServiceDiscoveryUtilities","geocortex/framework/utils/HttpsUtils"],function(e,t,i,r,n,s,a,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var l=function(){function e(){this.initialized=!1,this.supported=!1}return e.prototype.initialize=function(e){this._site=e,this._rootUrl=i.UrlUtilities.resolveUrl(e.url,"/../../../connections",!0),this.supported=e.getEssentialsVersion()>=4.05,this.initialized=!0},e.prototype.getRootUrl=function(){return this._rootUrl},e.prototype.suggestHints=function(e){var t=this,i={f:"json",term:e};return this.sendRequest("suggest",i).then(function(e){var i=new Array;if(void 0!==t.isHttpsMode&&null!==t.isHttpsMode||(t.isHttpsMode=o.isHttpsMode()),t.isHttpsMode&&e&&e.hints&&e.hints.length>0){for(var r=0;r<e.hints.length-1;r++)e.hints[r].toLowerCase().startsWith("http://")||(e.hints[r+1].toLowerCase().startsWith("http://")?e.hints[r+1].toLowerCase().startsWith("https://")&&(i.push(e.hints[r]),i.push(e.hints[r+1]),r+=1):i.push(e.hints[r]));return e.hints[e.hints.length-1].toLowerCase().startsWith("http://")||i.push(e.hints[e.hints.length-1]),i}return e.hints})},e.prototype.findServices=function(e,t){var i=this,r={f:"json",term:e,whitelistOnly:!0};return t&&(r=dojo.mixin(r,t)),this.sendRequest("find",r).then(function(e){return Array.isArray(e.results)&&(void 0!==i.isHttpsMode&&null!==i.isHttpsMode||(i.isHttpsMode=o.isHttpsMode()),i.isHttpsMode&&(e.results=e.results.filter(function(e){return e.url.toLowerCase().startsWith("https")||e.url.toLowerCase().startsWith("http://www.bing.com/maps")})),e.results.forEach(function(e){return i._processItem(e)})),e.results})},e.prototype.expandService=function(e){var t=this,i=this._getConnectionId(e),r={f:"json",providerName:e.serviceProviderName,url:e.url};return this.sendRequest(i+"/expand",r).then(function(e){return t._processItem(e)})},e.prototype.realizeMapService=function(e,t){var i=this,r=this._getConnectionId(e),n={f:"json",providerName:e.serviceProviderName,url:e.url,sr:t,itemId:e.id||"null"};return this.sendRequest(r+"/realize",n).then(function(t){return i._createMapService(e,t)})},e.prototype.sendRequest=function(e,t){var s=this;return r.SimplePromise.resolve(null).then(function(){return s._verifyInitialized()}).then(function(){return s._verifySupported()}).then(function(){return t.f=t.f||"json",n.request({url:i.UrlUtilities.resolveUrl(s._rootUrl,e),content:n.encodeJson(t),handleAs:"json"})}).then(this._processError)},e.prototype._getConnectionId=function(e){return e.connection&&null!=e.connection.id?e.connection.id:"none"},e.prototype._processError=function(e){if(e&&e.error)throw e.error;return e},e.prototype._processItem=function(e){var t=e;if(t.connection&&null!=t.connection.id?t.isWhitelisted=!0:t.isWhitelisted=!1,!t.thumbnailUrl){var r=this._getConnectionId(t)+"/preview?f=json&providerName="+t.serviceProviderName+"&url="+t.url;t.thumbnailUrl=i.UrlUtilities.resolveUrl(this._rootUrl,r)}if(t.children)for(var n=0,s=t.children;n<s.length;n++){var a=s[n];this._processItem(a)}return t},e.prototype._createMapService=function(e,t){return t.serviceUrl||(t.serviceUrl=e.url),!t.serviceUrl&&t.connectionString&&(t.serviceUrl=s.ServiceHelper.extractConnectionStringValue(t.connectionString,"url")),t.serviceUrl?a.ServiceDiscoveryUtilities.buildMapService(this._site.essentialsMap,t):r.SimplePromise.reject(new Error("SiteServiceDiscoveryProvider._createMapService: Cannot create map service, the service URL is required."))},e.prototype._verifySupported=function(){if(!this.supported)throw new Error("Service Discovery is not supported in the current version of Geocortex Essentials.")},e.prototype._verifyInitialized=function(){if(!this.initialized)throw new Error("The Service Discovery client is not initialized yet.")},e}();t.SiteServiceDiscoveryProvider=l})},"geocortex/essentials/utilities/DecomposedUri":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e){this.originalUri=e,this.schemeHostAndPath=e.match(/[^?|^#]*/)[0];var t=e.match(/\?([^#]*)/);this.query={},t&&t.length>1&&(this.query=dojo.queryToObject(t[1])),this.fragment=dojo.queryToObject(e.indexOf("#")>=0?e.substring(e.indexOf("#")+1,e.length):"")}return e.prototype.recompose=function(){var e=this.schemeHostAndPath;return this.query&&this.anyProperties(this.query)&&(e+="?"+dojo.objectToQuery(this.query)),this.fragment&&this.anyProperties(this.fragment)&&(e+="#"+dojo.objectToQuery(this.fragment)),e},e.prototype.anyProperties=function(e){for(var t in e)return!0;return!1},e.getHost=function(e){if(!e)return null;var t=e.match(/^http[s]?:\/\/([^\/]*)/);return t.length>1?t[1]:null},e.appendToPath=function(t,i){var r=new e(t);return r.schemeHostAndPath+=i,r.recompose()},e.removeQueryParameters=function(t){for(var i=[],r=1;r<arguments.length;r++)i[r-1]=arguments[r];for(var n=new e(t),s=0,a=i;s<a.length;s++){var o=a[s];delete n.query[o]}return n.recompose()},e}();t.DecomposedUri=i})},"geocortex/essentials/utilities/EncodeImageError":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/utilities/EncodeImageResult":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/utilities/ExifUtilities":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(){}return e.getPointFromExif=function(t){if(!t||!dojo.isArray(t.GPSLatitude)||!dojo.isArray(t.GPSLongitude))return null;var i=e.dmsToDecimal(t.GPSLatitude),r=e.dmsToDecimal(t.GPSLongitude);return"S"===t.GPSLatitudeRef&&(i*=-1),"W"===t.GPSLongitudeRef&&(r*=-1),new esri.geometry.Point(r,i)},e.dmsToDecimal=function(e){return e.length>2?e[0]+e[1]/60+e[2]/3600:e.length>1?e[0]+e[1]/60:e[0]},e.getExifTagsFromImageBytes=function(t){if(0==t.byteLength)return{};var i=t.byteLength,r=new DataView(t);if(i<2||65496!=r.getUint16(0))return{};for(var n=2;n+4<i;n+=a+2){if(255!==r.getUint8(n))throw new Error("Expected start of a JPEG marker.");var s=r.getUint8(n+1),a=r.getUint16(n+2);if(n+a+2>i)throw new Error("Unexpected end of file.");if(225===s)return e.getExifTags(r,n+4,a-2)}return{}},e.base64ToArrayBuffer=function(e,t){t=t||e.match(/^data\:([^\;]+)\;base64,/im)[1]||"",e=e.replace(/^data\:([^\;]+)\;base64,/gim,"");for(var i=atob(e),r=i.length,n=new ArrayBuffer(r),s=new Uint8Array(n),a=0;a<r;a++)s[a]=i.charCodeAt(a);return n},e.getExifTags=function(t,i,r){if(r<6||1165519206!==t.getUint32(i)||0!==t.getUint16(i+4))throw new Error("EXIF header corrupted.");var n,s=t.getInt16(i+6);if(18761===s)n=!0;else{if(19789!==s)throw new Error("Unknown endian marker.");n=!1}if(42!==t.getUint16(i+8,n)){if(10752===t.getUint16(i+8,n))throw new Error("Endian marker test is backwards.");throw new Error("Endian marker test magic value is corrupted.")}var a,o=t.getUint32(i+10,n),l=e.readTags(t,i+6,i+6+o,e.TiffTags,n);if(l.ExifIFDPointer){var c=e.readTags(t,i+6,i+6+l.ExifIFDPointer,e.ExifTags,n);for(a in c)if(c.hasOwnProperty(a)){switch(a){case"ExifVersion":case"FlashpixVersion":c[a]=String.fromCharCode(c[a][0],c[a][1],c[a][2],c[a][3])}l[a]=c[a]}}if(l.GPSInfoIFDPointer){var u=e.readTags(t,i+6,i+6+l.GPSInfoIFDPointer,e.GPSTags,n);for(a in u)if(u.hasOwnProperty(a)){switch(a){case"GPSVersionID":u[a]=u[a][0]+"."+u[a][1]+"."+u[a][2]+"."+u[a][3]}l[a]=u[a]}}return l},e.readTags=function(t,i,r,n,s){for(var a={},o=t.getUint16(r,s),l=0;l<o;l++){var c=r+12*l+2,u=t.getUint16(c,s),p=n[u];p||(p=u.toString(16)),a[p]=e.readTagValue(t,c,i,r,s)}return a},e.readTagValue=function(t,i,r,n,s){var a,o,l,c,u,p=t.getUint16(i+2,s),h=t.getUint32(i+4,s),d=t.getUint32(i+8,s)+r;switch(p){case 1:case 7:if(1==h)return t.getUint8(i+8);for(a=h>4?d:i+8,o=[],l=0;l<h;l++)o[l]=t.getUint8(a+l);return o;case 2:return a=h>4?d:i+8,e.getStringFromBytes(t,a,h-1);case 3:if(1==h)return t.getUint16(i+8,s);for(a=h>2?d:i+8,o=[],l=0;l<h;l++)o[l]=t.getUint16(a+2*l,s);return o;case 4:if(1==h)return t.getUint32(i+8,s);for(o=[],l=0;l<h;l++)o[l]=t.getUint32(d+4*l,s);return o;case 5:if(1==h)return c=t.getUint32(d,s),u=t.getUint32(d+4,s),c/u;for(o=[],l=0;l<h;l++)c=t.getUint32(d+8*l,s),u=t.getUint32(d+4+8*l,s),o[l]=c/u;return o;case 9:if(1==h)return t.getInt32(i+8,s);for(o=[],l=0;l<h;l++)o[l]=t.getInt32(d+4*l,s);return o;case 10:if(1==h)return t.getInt32(d,s)/t.getInt32(d+4,s);for(o=[],l=0;l<h;l++)o[l]=t.getInt32(d+8*l,s)/t.getInt32(d+4+8*l,s);return o}return""},e.getStringFromBytes=function(e,t,i){for(var r="",n=t;n<t+i;n++)r+=String.fromCharCode(e.getUint8(n));return r},e}();i.ExifTags={36864:"ExifVersion",40960:"FlashpixVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",37121:"ComponentsConfiguration",37122:"CompressedBitsPerPixel",37500:"MakerNote",37510:"UserComment",40964:"RelatedSoundFile",36867:"DateTimeOriginal",36868:"DateTimeDigitized",37520:"SubsecTime",37521:"SubsecTimeOriginal",37522:"SubsecTimeDigitized",33434:"ExposureTime",33437:"FNumber",34850:"ExposureProgram",34852:"SpectralSensitivity",34855:"ISOSpeedRatings",34856:"OECF",37377:"ShutterSpeedValue",37378:"ApertureValue",37379:"BrightnessValue",37380:"ExposureBias",37381:"MaxApertureValue",37382:"SubjectDistance",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37396:"SubjectArea",37386:"FocalLength",41483:"FlashEnergy",41484:"SpatialFrequencyResponse",41486:"FocalPlaneXResolution",41487:"FocalPlaneYResolution",41488:"FocalPlaneResolutionUnit",41492:"SubjectLocation",41493:"ExposureIndex",41495:"SensingMethod",41728:"FileSource",41729:"SceneType",41730:"CFAPattern",41985:"CustomRendered",41986:"ExposureMode",41987:"WhiteBalance",41988:"DigitalZoomRation",41989:"FocalLengthIn35mmFilm",41990:"SceneCaptureType",41991:"GainControl",41992:"Contrast",41993:"Saturation",41994:"Sharpness",41995:"DeviceSettingDescription",41996:"SubjectDistanceRange",40965:"InteroperabilityIFDPointer",42016:"ImageUniqueID"},i.TiffTags={256:"ImageWidth",257:"ImageHeight",34665:"ExifIFDPointer",34853:"GPSInfoIFDPointer",40965:"InteroperabilityIFDPointer",258:"BitsPerSample",259:"Compression",262:"PhotometricInterpretation",274:"Orientation",277:"SamplesPerPixel",284:"PlanarConfiguration",530:"YCbCrSubSampling",531:"YCbCrPositioning",282:"XResolution",283:"YResolution",296:"ResolutionUnit",273:"StripOffsets",278:"RowsPerStrip",279:"StripByteCounts",513:"JPEGInterchangeFormat",514:"JPEGInterchangeFormatLength",301:"TransferFunction",318:"WhitePoint",319:"PrimaryChromaticities",529:"YCbCrCoefficients",532:"ReferenceBlackWhite",306:"DateTime",270:"ImageDescription",271:"Make",272:"Model",305:"Software",315:"Artist",33432:"Copyright"},i.GPSTags={0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude",5:"GPSAltitudeRef",6:"GPSAltitude",7:"GPSTimeStamp",8:"GPSSatellites",9:"GPSStatus",10:"GPSMeasureMode",11:"GPSDOP",12:"GPSSpeedRef",13:"GPSSpeed",14:"GPSTrackRef",15:"GPSTrack",16:"GPSImgDirectionRef",17:"GPSImgDirection",18:"GPSMapDatum",19:"GPSDestLatitudeRef",20:"GPSDestLatitude",21:"GPSDestLongitudeRef",22:"GPSDestLongitude",23:"GPSDestBearingRef",24:"GPSDestBearing",25:"GPSDestDistanceRef",26:"GPSDestDistance",27:"GPSProcessingMethod",28:"GPSAreaInformation",29:"GPSDateStamp",30:"GPSDifferential"},t.ExifUtilities=i})},"geocortex/essentials/utilities/GraphicsLayerUtilities":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.excludeFromExportMapTaskName="ExportMapTask";var i={};t.getGraphicsLayerIdsToExclude=function(e){var t=[];return e.forEach(function(e){i[e]&&i[e].forEach(function(e){t.indexOf(e)<0&&t.push(e)})}),t},t.addToGraphicsLayerIdsToExclude=function(e,t){t&&t.length>0&&e.forEach(function(e){i[e]||(i[e]=[]),i[e].indexOf(t)<0&&i[e].push(t)})},t.removeFromGraphicsLayerIdsToExclude=function(e,t){t&&t.length>0&&e.forEach(function(e){if(i[e]){var r=i[e].indexOf(t);r>=0&&i[e].splice(r,1)}})}})},"geocortex/essentials/utilities/ImageUtilities":function(){define(["require","exports"],function(e,t){"use strict";function i(e,t,i,r){if(e<i&&t<r)return{width:e,height:t};var n=Math.min(i/e,r/t);return{width:e*n,height:t*n}}function r(t,i,r){return new Promise(function(a,o){e(["pica"],function(e){s(t).then(function(t){var s=document.createElement("canvas");s.width=i,s.height=r;var o;n()&&(o={features:["js"]}),e(o).resize(t,s,{alpha:!0}).then(function(e){return a(s.toDataURL("image/png"))})})})})}function n(){var e=window.navigator.userAgent;return e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0}function s(e){return new Promise(function(t,i){if("string"==typeof e){var r=new Image;r.onload=function(){t(r)},r.src=e}else t(e)})}Object.defineProperty(t,"__esModule",{value:!0}),t.calculateAspectRatioFit=i,t.resizeImage=r,t.resizeImageToMaxDimensions=function(e,t,n){return s(e).then(function(e){var s=i(e.width,e.height,t,n);return r(e,s.width,s.height)}).then(function(e){return e})},t.getRawByteDataFromDataUri=function(e){return decodeURIComponent(e.substring(e.indexOf("base64,")+7))}})},"geocortex/essentials/utilities/LayerUtilities":function(){define(["require","exports","geocortex/framework/utils/utils"],function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){}return e.createFeatureLayerFromCsv=function(e,t){var r=new dojo.Deferred;if(!e)return r.resolve(null),r;var n=new dojox.data.CsvStore({url:e.url,separator:e.columnDelimiter||","});return n.fetch({onComplete:function(s,a){var o,l,c=0,u=e.layerDefinition,p={layerDefinition:u,featureSet:{features:[],geometryType:"esriGeometryPoint"}},h=null,d=null;t&&(h=t.lowerBound||0,d=t.upperBound||s.length),(h||d)&&(s=s.slice(h,d)),dojo.forEach(s,function(t,i){0===i&&e.locationInfo&&(o=e.locationInfo.latitudeFieldName,l=e.locationInfo.longitudeFieldName);n.getIdentity(t);var r=n.getAttributes(t),s={};dojo.forEach(r,function(e){var i=Number(n.getValue(t,e));isNaN(i)?s[e]=n.getValue(t,e):s[e]=i}),s.__OBJECTID=c,c++;var a=parseFloat(s[o]),u=parseFloat(s[l]);if(!isNaN(a)&&!isNaN(u)){var h={geometry:new esri.geometry.Point(u,a).toJson(),attributes:s};p.featureSet.features.push(h)}});var f=new esri.layers.FeatureLayer(p),y=null;u&&u.drawingInfo&&u.drawingInfo.renderer&&u.drawingInfo.renderer.symbol&&"esriPMS"===u.drawingInfo.renderer.symbol.type&&(y=u.drawingInfo.renderer.symbol),null!=y&&(f.renderer.symbol.imageData=y.imageData,f.renderer.symbol.url=y.url),e.title&&(f.name=e.title),f.layerId=e.id||i.alphaNumericToken(),r.resolve(f)}}),r},e.decomposeFeatureLayerUrl=function(e){var t=/(.+?)\/([0-9]*)(\?.*)?$/g.exec(e);return{serviceUrl:t[1],layerId:parseInt(t[2]),queryString:t[3]}},e}();t.LayerUtilities=r})},"geocortex/essentials/utilities/PrintUtilities":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(){}return e.adjustTextSymbol=function(e,t){if(e&&e.symbol instanceof esri.symbol.TextSymbol){var i=function(e,t){t.font.size=void 0!=e.font.size&&"number"==typeof e.font.size?Math.round(e.font.size)+"px":e.font.size,t.x=e.x,t.y=e.y,t.xoffset=e.xoffset,t.yoffset=e.yoffset,t.align=e.align,t.angle=e.angle,t.color.hasOwnProperty("a")&&(t.color.a=e.color.a>=0&&e.color.a<=1?255*e.color.a:e.color.a)},r=new esri.symbol.TextSymbol(e.symbol.toJson());if(r.color=new esri.Color({r:e.symbol.color.r,g:e.symbol.color.g,b:e.symbol.color.b,a:e.symbol.color.a}),i(e.symbol,r),r.toJson&&"function"==typeof r.toJson){var n=r.toJson;r.toJson=function(){var e=n.call(r);return i(r,e),e}}var s=null,a=null;if(t){var o=document.getElementById(t+"_layer"),l=null;l=document.createElementNS("http://www.w3.org/2000/svg","text"),r.font&&(r.font.size&&l.setAttributeNS(null,"font-size",r.font.size.toString()),r.font.family&&l.setAttributeNS(null,"font-family",r.font.family)),l.setAttributeNS(null,"visibility","hidden"),l.textContent=r.text,o.appendChild(l);var c=l.getBBox();a=null===a?c.height:a,s=null===s?l.getComputedTextLength():s,o.removeChild(l)}else{var u=document.body,p=document.createElement("div"),h={fontFamily:r.font.family,fontSize:r.font.size,fontWeight:r.font.weight,padding:"0",position:"absolute",lineHeight:"1",visibility:"hidden"};for(var d in h)p.style[d]=h[d];p.appendChild(document.createTextNode(r.text)),u.appendChild(p),s=p.clientWidth,a=p.clientHeight,u.removeChild(p)}if(r.xoffset=0===r.angle?r.xoffset:0,r.yoffset=0===r.angle?r.yoffset:0,(e.measurementId||e.coordinateId)&&e.attributes&&e.attributes.numberOfLines){if(e.measurementId?r.xoffset=-(s/2+a/4):r.xoffset=-(s/4+a/2),r.yoffset=e.attributes.numberOfLines&&1==e.attributes.numberOfLines?a/2:r.yoffset,"start"==r.verticalAlignment&&e.attributes.numberOfLines&&e.attributes.numberOfLines>1){var f=e.attributes.numberOfLines;r.yoffset=r.yoffset-.5*a/2+a*f/2}}else{switch(r.verticalAlignment){case"top":break;case"middle":r.yoffset+=a/2;break;default:r.yoffset+=.75*a}e.attributes&&e.attributes.customVerticalAlignment&&"middle"===e.attributes.customVerticalAlignment&&(r.xoffset=0,r.yoffset=0,r.yoffset+=Math.ceil(a/2));var y=r.horizontalAlignment||r.align||null;if(y)switch(y){case esri.symbol.TextSymbol.ALIGN_MIDDLE:case"center":case"justify":r.xoffset-=Math.ceil(s/2),e.coordinateId||(r.xoffset-=Math.ceil(a/4));break;case esri.symbol.TextSymbol.ALIGN_END:case"right":r.xoffset-=s}}return r}return null},e.adjustPictureMarkerSymbol=function(e){if(e&&e.symbol instanceof esri.symbol.PictureMarkerSymbol){var t=new esri.symbol.PictureMarkerSymbol(e.symbol.toJson());if(t.toJson&&"function"==typeof t.toJson){var i=t.toJson;t.toJson=function(){var e,r,n=i.call(t);return n.color=[0,0,0,255],isNaN(e=parseInt(t.width,10))||isNaN(r=parseInt(t.height,10))||(n.width=e,n.height=r,n.xoffset=isNaN(parseInt(n.xoffset))?e/2:n.xoffset+e/2,n.yoffset=isNaN(parseInt(n.yoffset))?r/2:n.yoffset-r/2),n}}return t}return null},e.getImageAsBase64=function(e,t){void 0===t&&(t="image/png");var i=new dojo.Deferred,r=document.createElement("canvas"),n=r.getContext("2d"),s=new Image;return s.onload=function(){r.height=s.height,r.width=s.width,n.drawImage(s,0,0);try{var a=r.toDataURL(t);i.resolve({url:e,data:a.replace(/^data:image\/(png|jpg);base64,/,"")})}catch(t){i.reject({url:e,error:t})}},s.onerror=function(t){i.reject({url:e,error:new Error("Failed to download image.")})},s.src=e,i},e}();t.PrintUtilities=i})},"geocortex/essentials/utilities/PromiseUtilities":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(){this.state={fulfilled:!1,rejected:!1}}return e.prototype.fulfill=function(e){this.state.fulfilled=!0,this.state.value=e},e.prototype.reject=function(e){this.state.rejected=!0,this.state.reason=e},e.prototype.isFulfilled=function(){return this.state.fulfilled},e.prototype.isRejected=function(){return this.state.rejected},e.prototype.isPending=function(){return!this.state.fulfilled&&!this.state.rejected},e.prototype.value=function(){return this.state.value},e.prototype.reason=function(){return this.state.reason},e}(),r=function(){function e(){}return e.settle=function(t){if(dojo.isArray(t))return e._settleImpl(t);if(t.then)return t.then(function(t){return e._settleImpl(t)});throw new Error("Unknown parameter type.  Must be an array of promises or a promise of array of promises.")},e._settleImpl=function(e){var t,r=new dojo.Deferred,n=e.map(function(e){var r=new i;return e&&"function"==typeof e.then?e.then(function(e){r.fulfill(e),t&&t()},function(e){r.reject(e),t&&t()}):r.fulfill(e),r});return(t=function(){n.every(function(e){return!e.isPending()})&&r.resolve(n)})(),r.promise},e}();t.PromiseUtilities=r})},"geocortex/essentials/utilities/ServiceDiscoveryUtilities":function(){define(["require","exports","./../MapService","./../FeatureLayerService","./../WFSLayerService","./../StreamLayerService","./../MapServiceConstants","geocortex/framework/SimplePromise","geocortex/framework/utils/utils"],function(e,t,i,r,n,s,a,o,l){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var c=function(){function e(){}return e.buildMapService=function(e,t,c){return void 0===c&&(c=!1),new o.SimplePromise(function(o,u){if(!e)throw new Error('ServiceDiscoveryUtilities.buildMapService: Parameter "essentialsMap" is required.');if(!t)throw new Error('ServiceDiscoveryUtilities.buildMapService: Parameter "serviceDefinition" is required.');var p,h={id:l.alphaNumericToken(),connectionString:t.serviceUrl?"url="+t.serviceUrl:void 0},d=dojo.mixin(h,t);if(d.drawingBehavior===a.DrawingBehavior.FEATURE_LAYER){if(!dojo.isObject(esri.layers.FeatureLayer))throw new Error("This Javascript application must require the esri.layers.FeatureLayer package in order to use a site with feature layers");p=new r.FeatureLayerService}else if(d.drawingBehavior===a.DrawingBehavior.GEORSS_LAYER){if(!dojo.isObject(esri.layers.GraphicsLayer))throw new Error("This Javascript application must require the esri.layers.GraphicsLayer package in order to use a site with GeoRSS layers");p=new geocortex.essentials.GeoRssLayerService}else if(d.drawingBehavior===a.DrawingBehavior.KML_SERVICE){if(!dojo.isObject(esri.layers.KMLLayer))throw new Error("This Javascript application must require the esri.layers.KMLLayer package in order to use a site with KML layers");p=new geocortex.essentials.KmlService}else if(d.drawingBehavior===a.DrawingBehavior.WFS_LAYER){if(!dojo.isObject(esri.layers.WFSLayer))throw new Error("This Javascript application must require the esri.layers.WFSLayer package in order to use a site with feature WFS layers");p=new n.WFSLayerService}else if(d.drawingBehavior===a.DrawingBehavior.STREAM_LAYER){if(!dojo.isObject(esri.layers.StreamLayer))throw new Error("This Javascript application must require the esri.layers.StreamLayer package in order to use a site with Stream layers");var f=d.layers[0];f&&d.displayName&&(f.displayName=d.displayName),p=new s.StreamLayerService}else p=new i.MapService;p.isUserCreated=!0,p.userLayerType=a.UserLayerType.LAYER_ADDITION,p.essentialsMap=e,p.initialize(d),p instanceof r.FeatureLayerService&&(p.moveEnabled=!0,p.rotateEnabled=!0,p.editVerticesEnabled=!0,p.scaleEnabled=!0);for(var y=0,m=p.layers;y<m.length;y++){var v=m[y];if(v.isUserCreated=!0,v.userLayerType=a.UserLayerType.LAYER_ADDITION,v.includeInLayerList=!0,v.includeInLegend=!0,v.site=e.site,c||(v.configuredVisible=!0,p.supportsLayerVisibility()?v.setVisibility(!0):v._visible=!0),v.subLayerIds&&v.subLayerIds.length>0)v.supportsIdentify=v.supportsQuery=v.identifiable=v.queryable=!1;else{v.identifiable=v.supportsIdentify,v.queryable=v.supportsQuery,v.searchable=!0,v.showMapTips=!0,(p instanceof s.StreamLayerService||p instanceof n.WFSLayerService)&&(v.identifiable=v.supportsIdentify=!0,v.queryable=v.supportsQuery=!1);var g=p.serviceLayer,_=g instanceof esri.layers.GraphicsLayer||g instanceof esri.layers.ArcGISDynamicMapServiceLayer;v.snappable=_,v.snappingEnabled=_}}if(p.serviceLayer.loaded)return o(p);var S,L;S=p.serviceLayer.on("load",function(e){return S&&S.remove(),L&&L.remove(),o(p)}),L=p.serviceLayer.on("error",function(e){return S&&S.remove(),L&&L.remove(),u(e.error)})})},e}();t.ServiceDiscoveryUtilities=c})},"geocortex/essentials/utilities/SiteInitializationUtils":function(){define(["require","exports","./../../geocortex","./../RestHelperHTTPService","./../utilities/UrlUtilities"],function(e,t,i,r,n){"use strict";function s(e,t){if("string"==typeof e){var i=Math.max(t.indexOf("?"),t.indexOf("#"));i>=0&&(t=t.substr(0,i)),t=/^(.*?)\/*$/.exec(t)[1],r.RestHelperHTTPService.setDefaultToken(e,t+"/../../")}}function a(){var e=window.location.href,t=e.indexOf("#gcx-");if(t>=0){var i=e.substring(t+5);return window.location.replace("#"),i}return null}Object.defineProperty(t,"__esModule",{value:!0}),t.downloadSite=function(e,t,r,n){void 0===n&&(n=!0);var o=a();s(o,e);var l=function(){i.request({url:e,content:{f:"json",deep:n},load:function(e){t(e)},error:function(e){r(e)},callbackParamName:"CallBack"})};if(!o){var c=function(){window.removeEventListener?window.removeEventListener("popstate",c,!1):window.detachEvent&&window.detachEvent("onpopstate",c),(o=a())&&(s(o,e),l())};window.addEventListener?window.addEventListener("popstate",c,!1):window.attachEvent&&window.attachEvent("onpopstate",c)}l()},t.detectAndConfigureCors=function(e){var t=new dojo.Deferred;if(window.geocortexDisableEssentialsCorsDetection)return t.resolve(),t;var i=n.UrlUtilities.getUrlComponents(e),r=n.UrlUtilities.getUrlComponents(window.location.href);if(i.origin===r.origin)return t.resolve(),t;var s=(/(.*\/+)sites\/+[^\/]*\/?$/i.exec(e)||[])[1];if(s){var a=s+"info?f=json";dojo.xhrGet({url:a}).then(function(e){esri.config.defaults.io.corsEnabledServers.push(i.host),t.resolve()},function(e){t.resolve()})}else t.resolve();return t},t.updateDefaultToken=s})},"geocortex/essentials/utilities/SiteResourceIdComparer":function(){define(["require","exports","./StringUtilities"],function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){}return e.equals=function(e,t){return!(!e||!t||e!==t&&!i.StringUtilities.endsWith(e,this.separator+t))},e.lookUp=function(e,t){if(e&&t){var r=0,n=null;for(r=0;r<e.length;++r)if((n=e[r]).id===t)return n;for(r=0;r<e.length;++r)if(n=e[r],i.StringUtilities.endsWith(n.id,this.separator+t))return n}return null},e}();r.separator="-",t.SiteResourceIdComparer=r})},"geocortex/essentials/utilities/StringUtilities":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(){}return e.endsWith=function(e,t){return-1!==e.indexOf(t,e.length-t.length)},e.replaceLayerTokens=function(e,t){if(t)switch(e.toLowerCase()){case"layerid":return t.id;case"layername":return t.name;case"layerdisplayname":return t.displayName;case"layerdescription":return t.description}return""},e.replaceMapServicetokens=function(e,t){if(t)switch(e.toLowerCase()){case"mapserviceid":return t.id;case"mapservicedisplayname":return t.displayName;case"mapserviceurl":return t.url;case"mapservicetoken":return t.serviceToken}return""},e.getDateFromRestDateString=function(e){var t=/^\/Date\(-?\d+\)\/$/;if(!(e=e.trim())||!t.test(e))return null;var i=e.substring(e.indexOf("(")+1,e.indexOf(")"));return isNaN(i)?null:new Date(parseInt(i,10))},e}();t.StringUtilities=i,"function"!=typeof String.prototype.endsWith&&(String.prototype.endsWith=function(e){return i.endsWith(this,e)})})},"geocortex/essentials/utilities/Thenable":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/utilities/TimeZoneUtils":function(){define(["require","exports","geocortex/framework/utils/ArrayUtils"],function(e,t,i){"use strict";function r(e){if(!e)return null;var t=null,r=null;return t=e.timeZoneId,e.essentialsMap&&e.essentialsMap.site&&(r=e.essentialsMap.site.timeZoneId),i.firstOrDefault([t,r],function(e){return!!e})}function n(e,t){if(null===e||void 0===e)return null;if(!t)return e;var i=-moment.tz(e.getTime(),t).utcOffset();return moment(e).add(i,"minutes").toDate()}Object.defineProperty(t,"__esModule",{value:!0}),t.UTC_ZONE_ID="Etc/UTC",t.getTimeZoneFromLayer=function(e){if(!e)return null;var t=null,n=null;return t=e.timeZoneId,e.mapService&&(n=r(e.mapService)),i.firstOrDefault([t,n],function(e){return!!e})},t.getTimeZoneFromMapService=r,t.getDisplayTimeZoneFromMapService=function(e){return e&&e.essentialsMap&&e.essentialsMap.site?e.essentialsMap.site.displayTimeZoneId:null},t.correctDatesForDisplayInDisplayTimeZone=function(e,i,r){if(null===e||void 0===e)return null;if(i||(i=t.UTC_ZONE_ID),!r)return n(e,i);var s=-(-e.getTimezoneOffset()-moment.tz(e.getTime(),r).utcOffset()),a=n(e,i);return moment(a).add(s,"minutes").toDate()},t.correctDatesForDisplayInLocalTime=n,t.correctDatesToSubmitInDatabaseTime=function(e,i,r){if(null===e||void 0===e)return null;i||(i=t.UTC_ZONE_ID);var n=moment.tz(e.getTime(),i).utcOffset();if(!r)return moment(e).add(n,"minutes").toDate();var s=n-moment.tz(e.getTime(),r).utcOffset(),a=-e.getTimezoneOffset();return moment(e).add(a+s,"minutes").toDate()},t.correctDatesToQueryInDatabaseTime=function(e,i,r){if(null===e||void 0===e)return null;i||(i=t.UTC_ZONE_ID);var n=moment.tz(e.getTime(),i).utcOffset();if(!r){var s=e.getTimezoneOffset();return moment(e).add(s+n,"minutes").toDate()}var a=n-moment.tz(e.getTime(),r).utcOffset();return moment(e).add(a,"minutes").toDate()}})},"geocortex/essentials/utilities/UrlUtilities":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(){}return e.simplify=function(e){var t=document.createElement("a");t.href=e;var i=t.href,r=i.charAt(i.length-1);return"/"!==r&&"\\"!==r||(i=i.substr(0,i.length-1)),i},e.getUrlComponents=function(e){var t=document.createElement("a");return t.href=e,{host:t.host,hostname:t.hostname,protocol:t.protocol,port:t.port,query:t.search,hash:t.hash,path:t.pathname,origin:t.protocol+"//"+t.host}},e.resolveUrl=function(t,i,r){void 0===r&&(r=!1);var n=""+t+(t.endsWith("/")?"":"/")+i;return r&&(n=e.simplify(n)),n},e}();t.UrlUtilities=i})}}})}();require({cache:{"geocortex/essentials":function(){}}});require({cache:{"geocortex/forms/DataItem":function(){define(["require","exports","./../workflow/WorkflowControllerProxy"],function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t,r){this.display=e,this.value=t,this.typeName=r}return e.prototype.getValue=function(){var e=this.value;return null!=this.typeName&&(e=r._getObjectFromJsonWithType(e,this.typeName)),null!=this.value&&void 0!==this.value.__type&&delete e.__type,e},e}();t.DataItem=n})},"geocortex/forms/FileItem":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){this.fileName=null,this.fileDataBase64=null,this.fileSize=0,this.fileType=null}return e.prototype.getDataUri=function(){return"data:"+this.fileType+";base64,"+this.fileDataBase64},e}();t.FileItem=r})},"geocortex/forms/FormButton":function(){define(["require","exports","geocortex/framework/observables"],function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(e,t,n,o){this.label=new r.Observable(e),this.value=new r.Observable(t),this.isDefault=new r.Observable(o||!1),this.causesValidation=new r.Observable(n)};t.FormButton=n})},"geocortex/forms/FormDefinition":function(){define(["require","exports","geocortex/framework/observables","./../forms","./items/ContainerFormItem","./items"],function(e,t,r,n,o,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t,a){this.version=null,this.inputData=null,this.containerFormItem=null,this.inputGeometry=null,this.knownTypes=null,this._formManager=null,this._version=1.1,this._formContainer=null,this._cascadingMap=null,this._controlMap=null,this.knownTypes=[],this.inputData=t,this.version=this._version,this._controlMap={},this._cascadingMap={},this.createElementDelegate=function(e,t){return i._processFormItem(e,t)};var s=null;if(e&&(s=dojox.xml.parser.parse(e)),a&&(this.inputGeometry=a),null!=s){var l=s.documentElement,u=n.getElementText(l,"Version");if(parseFloat(u)>this._version)throw new Error("Form version "+u+" is incompatible with current API version "+this._version);this.title=new r.Observable(n.getElementText(l,"Title")),this.maxWidth=new r.Observable(parseInt(n.getElementText(l,"MaxWidth"))),this.maxHeight=new r.Observable(parseInt(n.getElementText(l,"MaxHeight")));var m=n.getElement(l,"KnownTypes");if(null!=m)for(f=0;f<m.childNodes.length;f++)this.knownTypes.push(m.childNodes[f].firstChild.data);this.containerFormItem=new o.ContainerFormItem(n.getElement(l,"ContainerFormItem"),this)}else this.containerFormItem=new o.ContainerFormItem(null,this),this.containerFormItem.itemID=new r.Observable("Group1"),this.title=new r.Observable(""),this.maxWidth=new r.Observable(NaN),this.maxHeight=new r.Observable(NaN);for(var c in this._cascadingMap)if(this._cascadingMap.hasOwnProperty(c))for(var f=0;f<this._cascadingMap[c].length;++f){var p=this._cascadingMap[c][f];this._controlMap[c].queryTaskRunner.cascadingEvent.subscribe(p.formItem,p.handler)}}return e.prototype.addCascading=function(e,t,r){0==this._cascadingMap.hasOwnProperty(e)&&(this._cascadingMap[e]=[]),this._cascadingMap[e].push({formItem:t,handler:r})},e.prototype.map=function(e){this._controlMap[e.itemID.get()]=e},e.prototype.render=function(e){},e.prototype.validate=function(){return this.containerFormItem.validate()},e.prototype.getResults=function(){return this.containerFormItem._getResults()},e.prototype.destroy=function(){this.containerFormItem._destroy()},e.prototype.getFormItemById=function(e){return this.containerFormItem.getFormItemById(e)},e}();t.FormDefinition=a})},"geocortex/forms/getItemType":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getItemType=function(e){var t="";if(null!=e&&null!=e.attributes)for(var r=0;r<e.attributes.length;r++)if(String(e.attributes[r].nodeName).indexOf("type")>=0){var n=e.attributes[r].nodeValue,o=n.indexOf(":");o>=0&&o+1<n.length&&(n=n.substr(o+1)),t=n;break}return t}})},"geocortex/forms/items":function(){define(["require","exports","./getItemType","./items/AutoCompleteBoxFormItem","./items/CheckBoxFormItem","./items/ContainerFormItem","./items/ComboBoxFormItem","./items/DatePickerFormItem","./items/FilePickerFormItem","./items/GroupBoxFormItem","./items/HyperlinkFormItem","./items/ImageFormItem","./items/ListBoxFormItem","./items/MarkdownFormItem","./items/RadioButtonFormItem","./items/TextAreaFormItem","./items/TextBoxFormItem","./items/TimePickerFormItem"],function(e,t,r,n,o,i,a,s,l,u,m,c,f,p,d,h,b,g){"use strict";function v(e,t){var y=null;switch(r.getItemType(e)){case"AutoCompleteBoxFormItem":y=new n.AutoCompleteBoxFormItem(e,t);break;case"CheckBoxFormItem":y=new o.CheckBoxFormItem(e,t);break;case"ContainerFormItem":(y=new i.ContainerFormItem(e,t)).createElementDelegate=function(e,t){return v(e,t)};break;case"ComboBoxFormItem":y=new a.ComboBoxFormItem(e,t);break;case"DatePickerFormItem":y=new s.DatePickerFormItem(e,t);break;case"FilePickerFormItem":y=new l.FilePickerFormItem(e,t);break;case"GroupBoxFormItem":y=new u.GroupBoxFormItem(e,t);break;case"HyperlinkFormItem":y=new m.HyperlinkFormItem(e,t);break;case"ImageFormItem":y=new c.ImageFormItem(e,t);break;case"ListBoxFormItem":y=new f.ListBoxFormItem(e,t);break;case"MarkdownFormItem":y=new p.MarkdownFormItem(e,t);break;case"RadioButtonFormItem":y=new d.RadioButtonFormItem(e,t);break;case"TextAreaFormItem":y=new h.TextAreaFormItem(e,t);break;case"TextBoxFormItem":y=new b.TextBoxFormItem(e,t);break;case"TimePickerFormItem":y=new g.TimePickerFormItem(e,t)}return y.dataItems&&null!=t&&null!=t.inputData&&t.inputData.hasOwnProperty(y.itemID)&&y.dataItems.addItems(t.inputData.item(y.itemID)),y}Object.defineProperty(t,"__esModule",{value:!0}),t._processFormItem=v})},"geocortex/forms/items/AutoCompleteBoxFormItem":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define(["require","exports","./TextBoxFormItem","./QueryTaskFormItem","geocortex/framework/observables","./../../forms","./DataItemsFormItem"],function(t,r,n,o,i,a,s){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var l=function(t){function r(e,r){var n=t.call(this,e,r)||this;return n.isBusy=new i.Observable(!1),n.formItemType="AutoCompleteBoxFormItem",e?(n.minimumPrefixLength=new i.Observable(parseInt(a.getElementText(e,"MinimumPrefixLength"))),n.minimumPopulateDelay=new i.Observable(parseInt(a.getElementText(e,"MinimumPopulateDelay")))):(n.minimumPrefixLength=new i.Observable(3),n.minimumPopulateDelay=new i.Observable(200)),s.initDataItemsFormItem(n,e,r),n.queryTaskRunner=new o.QueryTaskRunner(n,e,r),n}return e(r,t),r.prototype.clearDataItems=function(){this.dataItems.clear()},r}(n.TextBoxFormItem);r.AutoCompleteBoxFormItem=l})},"geocortex/forms/items/CheckBoxFormItem":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define(["require","exports","./FormItem","geocortex/framework/observables","./../../forms","./FormItemResult"],function(t,r,n,o,i,a){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var s=function(t){function r(e,r){var n=t.call(this,e,r)||this;return n.formItemType="CheckBoxFormItem",e?(n.text=new o.Observable(i.getElementText(e,"Text")),n.checked=new o.Observable(i._parseBoolean(i.getElementText(e,"Checked"))),n.textLocation=new o.Observable(i.getElementText(e,"TextLocation"))):(n.text=new o.Observable(""),n.checked=new o.Observable(!1),n.textLocation=new o.Observable("Right")),n.checked.bind(null,function(e){return n._notifyResultChanged()}),n}return e(r,t),r.prototype.getResult=function(){return new a.FormItemResult(this.argumentName.get(),this.checked.get())},r.prototype._render=function(){return i.renderFormItem(this)},r}(n.AbstractFormItem);r.CheckBoxFormItem=s})},"geocortex/forms/items/ComboBoxFormItem":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define(["require","exports","./FormItem","./LabelContainer","./QueryTaskFormItem","geocortex/framework/observables","./../DataItem","./DataItemsFormItem","./../../forms","./FormItemResult"],function(t,r,n,o,i,a,s,l,u,m){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var c=function(t){function r(e,r){var n=t.call(this,e,r)||this;if(n._defaultSet=!1,n.selectText=new a.Observable,n.selected=new a.Observable,n.defaultSelectedValue=new a.Observable,n.isBusy=new a.Observable(!1),n.formItemType="ComboBoxFormItem",o.initLabelContainer(n,e,r),l.initDataItemsFormItem(n,e,r),n.queryTaskRunner=new i.QueryTaskRunner(n,e,r),e){var s=u.getElementText(e,"SelectText");s&&n.selectText.set(s);var m=u.getElementText(e,"SelectedValue");m&&n.defaultSelectedValue.set(m)}n.selected.bind(null,function(e){return n._notifyResultChanged()}),n.prepareForResults(),n.queryTaskRunner.isQueryable()||n._selectDefaultValue();var c=n.queryTaskRunner.queryCascadingID.get();return null!=c&&""!=c||n.queryTaskRunner.performQuery(""),n}return e(r,t),r.prototype.clearDataItems=function(){this.dataItems.clear(),this.selected.set(null),this._defaultSet=!1},r.prototype._hasRealDataItem=function(){return null!=this.selected.get()},r.prototype.triggerCascading=function(e){null!=this.selected.get()&&e||this.queryTaskRunner.cascadingEvent.publish(null);var t=this.selected.get();null===t&&(t=e),null===t||void 0===t?this.queryTaskRunner.cascadingEvent.publish(null):this.queryTaskRunner.cascadingEvent.publish(t.value)},r.prototype.prepareForResults=function(){if(this.selectText.get()){var e=this.selectText.get(),t=new s.DataItem(e,"",null);this.dataItems.insertItem(0,t)}},r.prototype.handleResultsComplete=function(){this._defaultSet||(this._selectDefaultValue(),null!=this.selected.get()&&(this._defaultSet=!0,this.triggerCascading(this.selected.get())))},r.prototype.getResult=function(){if(null==this.selected.get())return new m.FormItemResult(this.argumentName.get(),null);var e=this.selected.get();return e?new m.FormItemResult(this.argumentName.get(),e.getValue()):new m.FormItemResult(this.argumentName.get(),null)},r.prototype._addOption=function(e,t){this.dataItems.addItem(new s.DataItem(e,t))},r.prototype._selectDefaultValue=function(){var e=dojo.filter(this.dataItems.getItems(),dojo.hitch(this,function(e){return!!this.defaultSelectedValue.get()&&e.value+""==this.defaultSelectedValue.get()+""}));e.length>0?this.selected.set(e[0]):this.dataItems.length()>0&&this.selected.set(this.dataItems.getAt(0))},r.prototype._render=function(){return u.renderFormItem(this)},r}(n.AbstractFormItem);r.ComboBoxFormItem=c})},"geocortex/forms/items/ContainerFormItem":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define(["require","exports","./FormItem","geocortex/framework/observables","./../../forms"],function(t,r,n,o,i){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var a=function(t){function r(e,r){var n=t.call(this,e,r)||this;if(n.formItems=new o.ObservableCollection,n.formItemType="ContainerFormItem",n.createElementDelegate=function(e,t){return r.createElementDelegate(e,t)},e){n.orientation=new o.Observable(i.getElementText(e,"Orientation")),n.description=new o.Observable(i.getElementText(e,"Description")),n.maxWidth=new o.Observable(parseInt(i.getElementText(e,"MaxWidth"))),n.visibleControlID=new o.Observable(i.getElementText(e,"VisibleControlID")),n.visibleControlValue=new o.Observable(i.getElementText(e,"VisibleControlValue"));var a=i.getElement(e,"FormItems");if(null!=a)for(var s=0;s<a.childNodes.length;s++){var l=r.createElementDelegate(a.childNodes[s],n.formDefinition);null!=l&&(n.formItems.addItem(l),l.refresh=function(){var e=n.formItems.indexOf(n);e>=0&&(n.formItems.removeAt(e),n.formItems.insertItem(e,n))})}}else n.orientation=new o.Observable("Vertical"),n.description=new o.Observable(""),n.maxWidth=new o.Observable(NaN),n.visibleControlID=new o.Observable(""),n.visibleControlValue=new o.Observable("");return n}return e(r,t),r.prototype.validate=function(){var e=[];if(this.isVisible.get()&&null!=this.formItems)for(var t=0;t<this.formItems.getLength();++t){var r=this.formItems.getAt(t);if(r.isVisible.get())for(var n=r.validate(),o=0;o<n.length;++o)e.push(n[o])}return e},r.prototype._getResults=function(){for(var e=[],t=0;t<this.formItems.getLength();++t){var n=this.formItems.getAt(t);if(n.isVisible.get())if(n instanceof r){var o=n._getResults();if(null!=o)for(var i=0;i<o.length;++i)e.push(o[i])}else{var a=n.getResult();null!=a&&e.push(a)}}return e},r.prototype._destroy=function(){for(var e=this.formItems.length()-1;e>=0;e--)this.formItems.getAt(e)._destroy();this.formItems.clear()},r.prototype._render=function(){return i.renderFormItem(this)},r.prototype.getFormItemById=function(e){for(var t=0,r=this.formItems.length();t<r;t++){var n=this.formItems.getAt(t);if(n.itemID.get()===e)return n;if(n.getFormItemById&&(n=n.getFormItemById(e)))return n}return null},r.prototype.applyVisibility=function(e){if(e){var t=!1,r=e.getResult();if(null!==r&&null!==r.value){var n=this.visibleControlValue.get();if(n)if(r.isList){var o=r.value;if(o)for(var i=0;i<o.length;i++)if(o[i].toString()===n){t=!0;break}}else t=!0===r.value||!1===r.value?r.value.toString().toUpperCase()===n.toUpperCase():r.value.toString()===n;else 1==r.value&&(t=!0)}this.isVisible.set(t)}},r.prototype.getDisplayName=function(){return null},r}(n.AbstractFormItem);r.ContainerFormItem=a})},"geocortex/forms/items/DataItemsFormItem":function(){define(["require","exports","geocortex/framework/observables","./../DataItem","./../../forms"],function(e,t,r,n,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.initDataItemsFormItem=function(e,t,i){if(e.dataItems=new r.ObservableCollection,t){var a=o.getElement(t,"DataItems");if(null!=a)for(var s=0;s<a.childNodes.length;s++){var l=a.childNodes[s],u=new n.DataItem(o.getElementText(l,"Display"),o.getElementText(l,"Value"),o.getElementText(l,"TypeName"));null!=u&&e.dataItems.addItem(u)}}if(i){var m=i.inputData;if(m&&m.hasOwnProperty(e.itemID.get())){var c=m[e.itemID.get()];e.dataItems.addItems(c)}}}})},"geocortex/forms/items/DatePickerFormItem":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define(["require","exports","./FormItem","./LabelContainer","geocortex/framework/observables","./TimePickerFormItem","./../../forms","geocortex/framework/utils/DateUtils","./FormItemResult"],function(t,r,n,o,i,a,s,l,u){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var m=function(t){function r(e,r){var n=t.call(this,e,r)||this;n.nullable=new i.Observable(!1),n.readOnly=new i.Observable(!1),n.formItemType="DatePickerFormItem",o.initLabelContainer(n,e,r);var u=!0;if(e){for(var m=!0,c=e.getElementsByTagNameNS?e.getElementsByTagNameNS("http://schemas.datacontract.org/2004/07/Geocortex.Forms.Client.Items.Validation","ValidationItem"):e.getElementsByTagName("ValidationItem"),f=0;f<c.length;f++){var p=c[f].getAttributeNS("http://www.w3.org/2001/XMLSchema-instance","type");if(p&&p.indexOf("RequiredValidationItem")>=0){m=!1;break}}n.nullable.set(m),n.dateFormat=new i.Observable(s.getElementText(e,"DateFormat")),n.includeTimePicker=new i.Observable("true"===s.getElementText(e,"IncludeTimePicker"));var d=null;n.includeTimePicker.get()&&(n.timePickerItem=new a.TimePickerFormItem(s.getElement(e,"TimePickerItem")),d=n.timePickerItem.initialTime.get());var h=s.getElementText(e,"InitialDate");if(u=null===s.getElementText(e,"InitializeWithCurrentDate")?!h:"true"===s.getElementText(e,"InitializeWithCurrentDate"),h){if(l.containsTimezone(h)){var b=Math.max(h.lastIndexOf("Z"),h.lastIndexOf("+"),h.lastIndexOf("-"));b>0&&(h=h.substring(0,b))}h+=l.getTimezoneString()}var g=null;(u||h)&&(g=new Date(h)),g&&!isNaN(g.getTime())?(g.getTimezoneOffset()!=l.getTimezoneOffset()&&g.setTime(g.getTime()-6e4*(l.getTimezoneOffset()-g.getTimezoneOffset())),d&&(g.setHours(d.getHours()),g.setMinutes(d.getMinutes()),g.setSeconds(d.getSeconds())),n.initialDate=new i.Observable(g)):n.initialDate=new i.Observable(d)}else n.dateFormat=new i.Observable,n.initialDate=new i.Observable(null),n.includeTimePicker=new i.Observable(!1);if(u){var v=new Date;n.includeTimePicker.get()||(v.setHours(0),v.setMinutes(0),v.setSeconds(0)),n.date=new i.Observable(v),n.initialDate.set(v)}else n.date=new i.Observable(n.initialDate.get());return n.date.bind(null,function(e){return n._notifyResultChanged()}),n}return e(r,t),r.prototype.getResult=function(){var e=this.date.get(),t=null===e?null:new Date(e.toString());if(t)if(isNaN(t.getTime()))t=this.initialDate.get();else{var r=0,n=!this.attached_pickerType||!this.attached_pickerType.get||this.attached_pickerType.get().toLowerCase().indexOf("native")>-1;e instanceof Date||this.includeTimePicker.get()||!n||(r=6e4*t.getTimezoneOffset()),t="/Date({0})/".format(t.getTime()+r)}return new u.FormItemResult(this.argumentName.get(),t)},r.prototype._render=function(){return s.renderFormItem(this)},r}(n.AbstractFormItem);r.DatePickerFormItem=m})},"geocortex/forms/items/FilePickerFormItem":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define(["require","exports","./FormItem","./LabelContainer","geocortex/framework/observables","./../../forms","./FormItemResult","./../../workflow/ArgumentValueWrapper"],function(t,r,n,o,i,a,s,l){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var u=function(t){function r(e,r){var n=t.call(this,e,r)||this;return n.files=new i.ObservableCollection,n.formItemType="FilePickerFormItem",n.isSupported=new i.Observable("undefined"!=typeof FileReader&&n._isFileInputSupported()),e?(n.acceptFileTypes=new i.Observable(a.getElementText(e,"AcceptFileTypes")),n.allowMultiple=new i.Observable(a._parseBoolean(a.getElementText(e,"AllowMultiple")))):(n.acceptFileTypes=new i.Observable(null),n.allowMultiple=new i.Observable(!1)),o.initLabelContainer(n,e,r),n.files.bind(null,function(e){return n._notifyResultChanged()}),n}return e(r,t),r.prototype.clear=function(){this.files.clear(),this.refresh()},r.prototype.getResult=function(){for(var e=[],t=0;t<this.files.getLength();++t){var r=this.files.getAt(t);r&&e.push(r)}var n=new l.ArgumentValueWrapper("System.Collections.Generic.List`1[[Geocortex.Forms.Client.FileItem, Geocortex.EssentialsWpfApi]]",e),o=new s.FormItemResult(this.argumentName.get(),n,!0);return o.isList=!0,o},r.prototype._render=function(){return a.renderFormItem(this)},r.prototype._isFileInputSupported=function(){if(navigator.userAgent.match(/(Android (1.0|1.1|1.5|1.6|2.0|2.1))|(Windows Phone (OS 7|8.0))|(XBLWP)|(ZuneWP)|(w(eb)?OSBrowser)|(webOS)|(Kindle\/(1.0|2.0|2.5|3.0))/))return!1;var e=document.createElement("input");return e.type="file",!e.disabled},r}(n.AbstractFormItem);r.FilePickerFormItem=u})},"geocortex/forms/items/FormItem":function(){define(["require","exports","geocortex/framework/observables","./../../forms","./../getItemType","./validation/NumericRangeValidationItem","./validation/RequiredValidationItem","./validation/RegexValidationItem","./validation/FileSizeValidationItem"],function(e,t,r,n,o,i,a,s,l){"use strict";function u(e){var t=null;switch(o.getItemType(e)){case"NumericRangeValidationItem":t=new i.NumericRangeValidationItem(e);break;case"RequiredValidationItem":t=new a.RequiredValidationItem(e);break;case"RegexValidationItem":t=new s.RegexValidationItem(e);break;case"FileSizeValidationItem":t=new l.FileSizeValidationItem(e)}return t}Object.defineProperty(t,"__esModule",{value:!0});var m=function(){function e(e,t){if(this.isRequired=new r.Observable(!1),this.isValid=new r.Observable(!0),this.isVisible=new r.Observable(!0),this.argumentName=null,this.validationItems=[],this.formDefinition=t||null,this.attached_indicatorClass=new r.Observable(""),this.attached_showIndicator=new r.Observable(""),e){this.toolTip=new r.Observable(n.getElementText(e,"ToolTip")),this.itemID=new r.Observable(n.getElementText(e,"ItemID")),this.argumentName=new r.Observable(n.getElementText(e,"ArgumentName"));var o=n.getElementText(e,"IsVisible");o&&this.isVisible.set(n._parseBoolean(o));var i=n.getElement(e,"ValidationItems");if(null!=i)for(var a=0;a<i.childNodes.length;a++){var s=u(i.childNodes[a]);s instanceof geocortex.forms.items.validation.RequiredValidationItem&&this.isRequired.set(!0),null!=s&&this.validationItems.push(s)}}else this.toolTip=new r.Observable(""),this.itemID=new r.Observable(null),this.argumentName=new r.Observable(null)}return e.prototype.getResult=function(){return null},e.prototype._notifyResultChanged=function(){dojo.publish("FormItemResultChangedEvent",[this])},e.prototype.refresh=function(){},e.prototype.validate=function(){var e=[];if(this.isValid.set(!0),null!=this.validationItems)for(var t=0;t<this.validationItems.length;t++){var r=this.getResult();null!=r&&(r=r.value);var n=this.validationItems[t].validate(r);n.isValid||(this.isValid.set(!1),e.push(n))}return e},e.prototype._render=function(){return document.createTextNode(this.itemID.get())},e.prototype._destroy=function(){},e}();t.AbstractFormItem=m})},"geocortex/forms/items/FormItemResult":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(e,t,r){this.isList=!1,this.argumentName=e,this.value=t,this.wasSet=r||!1};t.FormItemResult=r})},"geocortex/forms/items/GroupBoxFormItem":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define(["require","exports","./ContainerFormItem","geocortex/framework/observables","./../../forms"],function(t,r,n,o,i){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var a=function(t){function r(e,r){var n=t.call(this,e,r)||this;return n.formItemType="GroupBoxFormItem",n.header=e?new o.Observable(i.getElementText(e,"Header")):new o.Observable(null),n}return e(r,t),r.prototype._render=function(){return i.renderFormItem(this)},r.prototype.getDisplayName=function(){return this.header.get()},r}(n.ContainerFormItem);r.GroupBoxFormItem=a})},"geocortex/forms/items/HyperlinkFormItem":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define(["require","exports","./FormItem","geocortex/framework/observables","./../../forms","./FormItemResult"],function(t,r,n,o,i,a){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var s=function(t){function r(e,r){var n=t.call(this,e,r)||this;return n.wasClicked=new o.Observable(!1),n.formItemType="HyperlinkFormItem",e?(n.hyperlinkText=new o.Observable(i.getElementText(e,"HyperlinkText")),n.target=new o.Observable(i.getElementText(e,"Target")),n.uri=new o.Observable(i.getElementText(e,"Uri"))):(n.hyperlinkText=new o.Observable("Hyperlink"),n.target=new o.Observable("_blank"),n.uri=new o.Observable("")),n.wasClicked.bind(null,function(e){return n._notifyResultChanged()}),n}return e(r,t),r.prototype.getResult=function(){return new a.FormItemResult(this.argumentName.get(),this.wasClicked.get(),this.wasClicked.get())},r.prototype._render=function(){return i.renderFormItem(this)},r}(n.AbstractFormItem);r.HyperlinkFormItem=s})},"geocortex/forms/items/ImageFormItem":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define(["require","exports","./FormItem","geocortex/framework/observables","./../../forms"],function(t,r,n,o,i){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var a=function(t){function r(e,r){var n=t.call(this,e,r)||this;if(n.formItemType="ImageFormItem",e){n.source=new o.Observable(i.getElementText(e,"Source")),n.width=new o.Observable(i.getElementText(e,"Width")),n.height=new o.Observable(i.getElementText(e,"Height"));var a=n.width.get(),s=n.height.get();a&&s?parseInt(a)>parseInt(s)?n.height.set("auto"):n.width.set("auto"):(n.width=new o.Observable("auto"),n.height=new o.Observable("auto"))}else n.source=new o.Observable(""),n.width=new o.Observable("auto"),n.height=new o.Observable("auto");return n}return e(r,t),r.prototype._render=function(){return i.renderFormItem(this)},r}(n.AbstractFormItem);r.ImageFormItem=a})},"geocortex/forms/items/LabelContainer":function(){define(["require","exports","./LabelFormItem","./../../forms"],function(e,t,r,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.initLabelContainer=function(e,t,o){t?(e.label=new r.LabelFormItem(n.getElement(t,"Label")),""==e.label.toolTip.get()&&null!=e.toolTip&&e.label.toolTip.set(e.toolTip.get())):e.label=new r.LabelFormItem(null)}})},"geocortex/forms/items/LabelFormItem":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define(["require","exports","./FormItem","geocortex/framework/observables","./../../forms"],function(t,r,n,o,i){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var a=function(t){function r(e,r){var n=t.call(this,e,r)||this;return n.formItemType="LabelFormItem",e?(n.text=new o.Observable(i.getElementText(e,"Text")),n.labelForItemID=new o.Observable(i.getElementText(e,"LabelForItemID"))):(n.text=new o.Observable(null),n.labelForItemID=new o.Observable(null)),n}return e(r,t),r.prototype._render=function(){return i.renderFormItem(this)},r}(n.AbstractFormItem);r.LabelFormItem=a})},"geocortex/forms/items/ListBoxFormItem":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define(["require","exports","./FormItem","./LabelContainer","./QueryTaskFormItem","./LabelFormItem","geocortex/framework/observables","./DataItemsFormItem","./../../forms","./FormItemResult"],function(t,r,n,o,i,a,s,l,u,m){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var c=function(t){function r(e,r){var n=t.call(this,e,r)||this;if(n.selection=new s.ObservableCollection,n.selectedValues=new s.ObservableCollection,n._selectedValuesLookup=null,n.isBusy=new s.Observable(!1),n.formItemType="ListBoxFormItem",o.initLabelContainer(n,e,r),l.initDataItemsFormItem(n,e,r),n.size=new s.Observable(6),e){n.maxHeight=new s.Observable(parseInt(u.getElementText(e,"MaxHeight"))),n.selectionMode=new s.Observable(u.getElementText(e,"SelectionMode"));var m=u.getElementText(e,"Size");if(m){var c=parseInt(m);c>0&&n.size.set(c)}var f=u.getElement(e,"SelectedValues");if(f){n._selectedValuesLookup={};var p;for(p=0;p<f.childNodes.length;p++){var d=f.childNodes[p].textContent;n.selectedValues.addItem(d),n._selectedValuesLookup[d+""]=!0}n._setDefaults(),0===n.selection.length()&&0!==n.dataItems.getItems().length&&n.selection.addItem(n.dataItems.getAt(0))}}else n.label=new a.LabelFormItem(null,n.formDefinition),n.maxHeight=new s.Observable(NaN),n.selectionMode=new s.Observable("Single");return n.queryTaskRunner=new i.QueryTaskRunner(n,e,r),n.queryTaskRunner.queryCascadingID.get()||n.queryTaskRunner.performQuery(""),n.selection.bind(null,function(e){setTimeout(function(){n._notifyResultChanged()},0)}),n}return e(r,t),r.prototype.clearDataItems=function(){this.dataItems.clear()},r.prototype._setDefaults=function(){for(var e=0;e<this.dataItems.getItems().length;e++){var t=this.dataItems.getAt(e);this._selectedValuesLookup[t.value.toString()]&&this.selection.addItem(t)}},r.prototype.handleResultsComplete=function(){this._setDefaults()},r.prototype.triggerCascading=function(e){null!=this.selection&&e||this.queryTaskRunner.cascadingEvent.publish(null);var t=null;null!=this.selection&&(t=this.selection.getAt(0)),null==t&&null!=e&&(t=e),null==t?this.queryTaskRunner.cascadingEvent.publish(null):this.queryTaskRunner.cascadingEvent.publish(t.value)},r.prototype.getResult=function(){var e=null;if("single"==this.selectionMode.get().toLowerCase())return this.selection.getLength()>0&&(e=(n=this.selection.getAt(0))?n.getValue():null),new m.FormItemResult(this.argumentName.get(),e,!0);for(var t=[],r=0;r<this.selection.getLength();++r){var n=this.selection.getAt(r);(e=n?n.getValue():null)&&t.push(e)}return e=new m.FormItemResult(this.argumentName.get(),t,!0),e.isList=!0,e},r.prototype._render=function(){return u.renderFormItem(this)},r}(n.AbstractFormItem);r.ListBoxFormItem=c})},"geocortex/forms/items/MarkdownFormItem":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define(["require","exports","./FormItem","geocortex/framework/observables","./../../forms"],function(t,r,n,o,i){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var a=function(t){function r(e,r){var n=t.call(this,e,r)||this;return n.formItemType="MarkdownFormItem",n.plainText=e?new o.Observable(i.getElementText(e,"PlainText")):new o.Observable(""),n}return e(r,t),r.prototype._render=function(){return i.renderFormItem(this)},r}(n.AbstractFormItem);r.MarkdownFormItem=a})},"geocortex/forms/items/QueryTaskFormItem":function(){define(["require","exports","geocortex/framework/observables","geocortex/framework/events/Event","./../../forms","./../../essentials/RestHelper","./../DataItem","./../../essentials/Field","./../../essentials/RestHelperHTTPService"],function(e,t,r,n,o,i,a,s,l){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t,i){if(this.cascadingEvent=new n.Event("cascadingEvent"),this.isBusy=new r.Observable(!1),this._queryId=0,e.queryTaskRunner||(e.queryTaskRunner=this),e.queryTaskRunner!==this)throw new Error("FormItem in the constructor must be the QueryTaskFormItem containing the QueryTaskRunner");this.formItem=e,t?(this.queryDisplayOutputField=new r.Observable(o.getElementText(t,"QueryDisplayOutputField")),this.queryValueOutputField=new r.Observable(o.getElementText(t,"QueryValueOutputField")),this.queryServiceUrl=new r.Observable(o.getElementText(t,"QueryServiceUrl")),this.queryWhereClause=new r.Observable(o.getElementText(t,"QueryWhereClause")),this.filterByInputGeometry=new r.Observable(o._parseBoolean(o.getElementText(t,"FilterByInputGeometry"))),this.queryCascadingID=new r.Observable(o.getElementText(t,"QueryCascadingID")),this.proxyUrl=new r.Observable(o.getElementText(t,"ProxyUrl")),this.token=new r.Observable(o.getElementText(t,"Token")),o.getElementText(t,"LayerSourceJson")&&(this.layerSourceJson=new r.Observable(o.getElementText(t,"LayerSourceJson")))):(this.queryDisplayOutputField=new r.Observable(null),this.queryValueOutputField=new r.Observable(null),this.queryServiceUrl=new r.Observable(null),this.queryWhereClause=new r.Observable(null),this.filterByInputGeometry=new r.Observable(!1),this.queryCascadingID=new r.Observable(null),this.proxyUrl=new r.Observable(null),this.token=new r.Observable(null)),e.formDefinition&&e.formDefinition.map(e);var a=this.queryCascadingID.get();null!=a&&""!=a&&e.formDefinition.addCascading(a,e,function(e){e?this.queryTaskRunner.performQuery(e):(this.clearDataItems(),this.triggerCascading(null))}),e.isBusy||(e.isBusy=new r.Observable(!1)),e.isBusy.sync(this.isBusy)}return e.prototype.triggerCascading=function(e){this.cascadingEvent.publish(e)},e.prototype.isQueryable=function(){return null!=this.queryServiceUrl.get()&&""!==dojo.trim(this.queryServiceUrl.get())&&null!=this.queryWhereClause.get()&&""!==dojo.trim(this.queryWhereClause.get())&&null!=this.queryDisplayOutputField.get()&&""!==dojo.trim(this.queryDisplayOutputField.get())},e.prototype.performQuery=function(e,t){var r=this;if(this.isQueryable()&&(this.formItem.dataItems.clear(),null!=e)){var n=null;this.filterByInputGeometry.get()&&null!=this.formItem.formDefinition&&this.formItem.formDefinition.inputGeometry&&(n=this.formItem.formDefinition.inputGeometry);var o=this.queryServiceUrl.get();this.proxyUrl.get()&&void 0===esri.getProxyRule(o)&&esri.addProxyRule({proxyUrl:this.proxyUrl.get(),urlPrefix:o}),this.token&&this.token.get()&&(o=l.RestHelperHTTPService.appendTokenToUrl(o,this.token.get()));var u;if(this.layerSourceJson&&this.layerSourceJson.get()){var m=i.RestHelper.getJsonObjectFromJsonString(this.layerSourceJson.get()),c={source:i.RestHelper.getLayerSourceFromJsonObject(m)};u=new esri.tasks.QueryTask(o,c)}else u=new esri.tasks.QueryTask(o);var f=new esri.tasks.Query;f.returnGeometry=!1,f.geometry=n,f.outFields=[],f.where=this._getWhereClause(e),f.outFields.push(this.queryDisplayOutputField.get()),null!=this.queryValueOutputField.get()&&""!=dojo.trim(this.queryValueOutputField.get())&&this.queryValueOutputField.get()!=this.queryDisplayOutputField.get()&&f.outFields.push(this.queryValueOutputField.get()),f.outFields.every(function(e){return-1!==e.indexOf(".")})||(f.returnDistinctValues=!0),this.isBusy.set(!0),++this._queryId,function(){var e=r._queryId;u.execute(f,function(n){var o=[];if(e==r._queryId){for(var i=0;i<n.features.length;++i){var l=n.features[i].attributes,u=null;null!=r.queryDisplayOutputField.get()&&(u=l[r.queryDisplayOutputField.get().trim()]);var m;m=null!=r.queryValueOutputField.get()&&""!=dojo.trim(r.queryValueOutputField.get())&&r.queryValueOutputField.get()!=r.queryDisplayOutputField.get()?l[r.queryValueOutputField.get().trim()]:u,o.push(new a.DataItem(u,m,null))}if(o.sort(function(e,t){return e.display<t.display?-1:1}),r.formatCallback){var c=s.EsriFieldTypes.esriFieldTypeString;if(n.fields){var f=n.fields.filter(function(e){return e.name===r.queryDisplayOutputField.get()})[0];f&&(c=f.type)}o.forEach(function(e){e.display=r.formatCallback(e.display,c)})}r.formItem.prepareForResults&&r.formItem.prepareForResults();for(var p={},d=[],h=0;h<o.length;++h){var b=o[h],g=function(e){return e.display+"-"+e.value}(b);p.hasOwnProperty(g)||(p[g]=!0,d.push(b))}r.formItem.dataItems.addItems(d),r.isBusy.set(!1);var v=null;r.formItem.dataItems.getLength()>0&&(v=r.formItem.dataItems.getAt(0)),!0===t&&r.triggerCascading(null==v?null:v.value),r.formItem.handleResultsComplete&&r.formItem.handleResultsComplete()}})}()}},e.prototype._getWhereClause=function(e){var t=this,r=this.queryWhereClause.get();return r=r.replace(/{1:([a-zA-Z0-9]+)(:[a-zA-Z0-9]+)?}/g,function(e,r,n){var o=t.formItem.formDefinition.getFormItemById(r);if(!o)return"{unknown form item "+r+"}";var i=o.getResult().value;if(!n)return i;if(":SQL"===n)return t._escapeForWhere(i);var a=/:[fF](\d+)/.exec(n);return a?parseFloat(i).toFixed(+a[1]):"{unknown format clause "+n+"}"}),r=r.format(this._escapeForWhere(e))},e.prototype._escapeForWhere=function(e){return e&&"number"==typeof e&&(e=e.toString()),(e||"").replace(/\'/g,"''")},e}();t.QueryTaskRunner=u})},"geocortex/forms/items/RadioButtonFormItem":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define(["require","exports","./FormItem","geocortex/framework/observables","./../../forms","./FormItemResult","./ContainerFormItem"],function(t,r,n,o,i,a,s){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var l=function(t){function r(e,n){var a=t.call(this,e,n)||this;return a.formItemType="RadioButtonFormItem",e?(a.text=new o.Observable(i.getElementText(e,"Text")),a.checked=new o.Observable(i._parseBoolean(i.getElementText(e,"Checked"))),a.textLocation=new o.Observable(i.getElementText(e,"TextLocation")),a.groupName=new o.Observable(i.getElementText(e,"GroupName"))):(a.text=new o.Observable(null),a.checked=new o.Observable(!1),a.textLocation=new o.Observable("Right"),a.groupName=new o.Observable(null)),a.checked.bind(null,function(e){e&&r._findButtonsInGroup(a.groupName.get(),a.formDefinition.containerFormItem).forEach(function(e){e!==a&&e.checked.set(!1)}),a._notifyResultChanged()}),a}return e(r,t),r.prototype.getResult=function(){var e=this.__getRadioValueClosure,t=!!e&&e();return new a.FormItemResult(this.argumentName.get(),t)},r.prototype._render=function(){return i.renderFormItem(this)},r._findButtonsInGroup=function(e,t){var n=[];return t&&t.formItems.get().forEach(function(t){t instanceof r?t.groupName.get()===e&&n.push(t):t instanceof s.ContainerFormItem&&r._findButtonsInGroup(e,t).forEach(function(e){return n.push(e)})}),n},r}(n.AbstractFormItem);r.RadioButtonFormItem=l})},"geocortex/forms/items/TextAreaFormItem":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define(["require","exports","./TextBoxFormItem","geocortex/framework/observables","./../../forms"],function(t,r,n,o,i){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var a=function(t){function r(e,r){var n=t.call(this,e,r)||this;return n.formItemType="TextAreaFormItem",n.textboxHeight=e?new o.Observable(parseInt(i.getElementText(e,"TextboxHeight"))):new o.Observable(1),n}return e(r,t),r}(n.TextBoxFormItem);r.TextAreaFormItem=a})},"geocortex/forms/items/TextBoxFormItem":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define(["require","exports","./FormItem","./LabelContainer","geocortex/framework/observables","./../../forms","./FormItemResult"],function(t,r,n,o,i,a,s){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var l=function(t){function r(e,r){var n=t.call(this,e,r)||this;if(n.formItemType="TextBoxFormItem",e){var s=a.getElementText(e,"DefaultText");n.defaultText=new i.Observable(s),n.text=new i.Observable(s),n.inputScope=new i.Observable(a.getElementText(e,"InputScope")),n.textboxWidth=new i.Observable(parseInt(a.getElementText(e,"TextboxWidth"))),n.readOnly=new i.Observable(a._parseBoolean(a.getElementText(e,"ReadOnly")))}else n.defaultText=new i.Observable(""),n.text=new i.Observable(""),n.inputScope=new i.Observable("Default"),n.textboxWidth=new i.Observable(NaN),n.readOnly=new i.Observable(!1);return o.initLabelContainer(n,e,r),n.text.bind(null,function(e){return n._notifyResultChanged()}),n}return e(r,t),r.prototype.getResult=function(){return new s.FormItemResult(this.argumentName.get(),this.text.get())},r.prototype._render=function(){return a.renderFormItem(this)},r}(n.AbstractFormItem);r.TextBoxFormItem=l})},"geocortex/forms/items/TimePickerFormItem":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define(["require","exports","./FormItem","./LabelContainer","geocortex/framework/observables","./../../forms","geocortex/framework/utils/DateUtils","./FormItemResult"],function(t,r,n,o,i,a,s,l){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var u=function(t){function r(e,r){var n=t.call(this,e,r)||this;if(n.initialTime=new i.Observable,n.nullable=new i.Observable(!1),n.timeFormat=new i.Observable,n.jQueryPickerTimeAsInfoMsg=new i.Observable(!1),n.formItemType="TimePickerFormItem",o.initLabelContainer(n,e,r),e){for(var l=!0,u=e.getElementsByTagNameNS?e.getElementsByTagNameNS("http://schemas.datacontract.org/2004/07/Geocortex.Forms.Client.Items.Validation","ValidationItem"):e.getElementsByTagName("ValidationItem"),m=0;m<u.length;m++){var c=u[m].getAttributeNS("http://www.w3.org/2001/XMLSchema-instance","type");if(c&&c.indexOf("RequiredValidationItem")>=0){l=!1;break}}n.nullable.set(l);var f=a.getElementText(e,"jQueryPickerTimeAsInfoMsg");f&&n.jQueryPickerTimeAsInfoMsg.set("true"===f);var p=a.getElementText(e,"InitialTime");(null===a.getElementText(e,"InitializeWithCurrentTime")?p:"true"!==a.getElementText(e,"InitializeWithCurrentTime"))?p?(s.containsTimezone(p)||(p+=s.getTimezoneString()),n.initialTime.set(Date.fromISO(p))):n.initialTime.set(null):n.initialTime.set(new Date),n.timeFormat.set(a.getElementText(e,"TimeFormat"))}else n.timeFormat.set("LongTime"),n.initialTime.set(new Date);return n.time=new i.Observable(n.initialTime.get()),n.time.bind(null,function(e){return n._notifyResultChanged()}),n}return e(r,t),r.prototype.getResult=function(){var e=this.time.get();return e&&(e=new Date(e.toString()),e="/Date({0})/".format(e.getTime())),new l.FormItemResult(this.argumentName.get(),e)},r.prototype._render=function(){return a.renderFormItem(this)},r}(n.AbstractFormItem);r.TimePickerFormItem=u})},"geocortex/forms/items/validation/FileSizeValidationItem":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define(["require","exports","./ValidationItem","./../../../forms","./ValidationResult","./../../../workflow/ArgumentValueWrapper","./../../FileItem"],function(t,r,n,o,i,a,s){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var l=function(t){function r(e){var r=t.call(this,e)||this;return r.totalFileSize=parseInt(o.getElementText(e,"TotalFileSize")),r}return e(r,t),r.prototype.validate=function(e){if(e instanceof a.ArgumentValueWrapper&&e.value&&e.value instanceof Array){for(var t=0,r=0;r<e.value.length;++r){var n=e.value[r];n&&n instanceof s.FileItem&&(t+=n.fileSize)}if(t>this.totalFileSize)return new i.ValidationResult(!1,this.message)}return new i.ValidationResult(!0,null)},r}(n.ValidationItem);r.FileSizeValidationItem=l})},"geocortex/forms/items/validation/NumericRangeValidationItem":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define(["require","exports","./ValidationItem","./../../../forms","./ValidationResult"],function(t,r,n,o,i){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var a=function(t){function r(e){var r=t.call(this,e)||this;return r.minimumValue=parseFloat(o.getElementText(e,"MinimumValue")),r.maximumValue=parseFloat(o.getElementText(e,"MaximumValue")),r}return e(r,t),r.prototype.validate=function(e){if(null===e||void 0===e||""===e)return new i.ValidationResult(!0,null);var t=parseFloat(e);return null==t||isNaN(t)||t<this.minimumValue||t>this.maximumValue?new i.ValidationResult(!1,this.message):new i.ValidationResult(!0,null)},r}(n.ValidationItem);r.NumericRangeValidationItem=a})},"geocortex/forms/items/validation/RegexValidationItem":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define(["require","exports","./ValidationItem","./../../../forms","./ValidationResult"],function(t,r,n,o,i){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var a=function(t){function r(e){var r=t.call(this,e)||this;return r.expression=o.getElementText(e,"Expression"),r.ignoreCase=o._parseBoolean(o.getElementText(e,"IgnoreCase")),r}return e(r,t),r.prototype.validate=function(e){if(null===e||void 0===e||""===e)return new i.ValidationResult(!0,null);var t="",r=this.expression;this.ignoreCase&&(t+="i"),'^(?(")(".+?"@)|(([0-9a-zA-Z]((\\.(?!\\.))|[-!#\\$%&\'\\*\\+/=\\?\\^`\\{\\}\\|~\\w])*)(?<=[0-9a-zA-Z])@))(?(\\[)(\\[(\\d{1,3}\\.){3}\\d{1,3}\\])|(([0-9a-zA-Z][-\\w]*[0-9a-zA-Z]\\.)+[a-zA-Z]{2,6}))$'==this.expression&&(r="^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,4}$");var n=null;try{n=new RegExp(r,t)}catch(e){}return null==n||n.test(e)?new i.ValidationResult(!0,null):new i.ValidationResult(!1,this.message)},r}(n.ValidationItem);r.RegexValidationItem=a})},"geocortex/forms/items/validation/RequiredValidationItem":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define(["require","exports","./ValidationItem","./ValidationResult"],function(t,r,n,o){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var i=function(t){function r(e){return t.call(this,e)||this}return e(r,t),r.prototype.validate=function(e){var t=!0,r=null;return(void 0===e||null===e||"string"==typeof e&&""===dojo.trim(e)||void 0!==e.length&&e.length<=0||e.value&&dojo.isArray(e.value)&&0===e.value.length)&&(t=!1,r=this.message),new o.ValidationResult(t,r)},r}(n.ValidationItem);r.RequiredValidationItem=i})},"geocortex/forms/items/validation/ValidationItem":function(){define(["require","exports","./../../../forms"],function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e){this.message=r.getElementText(e,"Message")}return e.prototype.validate=function(e){throw new Error("Abstract method")},e}();t.ValidationItem=n})},"geocortex/forms/items/validation/ValidationResult":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(e,t){this.isValid=e,this.errorMessage=t};t.ValidationResult=r})}}});require({cache:{"geocortex/forms":function(){define(["require","exports"],function(e,t){"use strict";function r(e,t){var r=e.getElementsByTagName(t);if(r.length>=1){for(u=0;u<r.length;u++)if(r[u].parentNode===e)return r[u]}else if(e.childNodes.length>0){var n=e.childNodes[0].prefix;if(""!=n&&(r=e.getElementsByTagName(n+":"+t)).length>=1)for(var u=0;u<r.length;u++)if(r[u].parentNode===e)return r[u]}return null}Object.defineProperty(t,"__esModule",{value:!0}),t.getElement=r,t.getElementText=function(e,t){var n=r(e,t);return n?dojox.xml.parser.textContent(n):null},t.getAttributeValue=function(e,t){if(null!=e)for(var r=0;r<e.attributes.length;r++)if(e.attributes[r].name==t)return e.attributes[r].value;return null},t._parseBoolean=function(e){if(null!=e)switch(e.toLowerCase()){case"true":case"yes":case"1":return!0;case"false":case"no":case"0":case null:return!1;default:return Boolean(e)}return!1},t.renderFormItem=function(e){return geocortex.forms.renderFormItem(e)}})}}});require({cache:{"geocortex/geocortex":function(){define(["require","exports","./config","./hasProxy","./essentials/RestHelperHTTPService","./essentials/Extension"],function(e,r,n,t,o,i){"use strict";function s(e){var r,n=typeof e;if(null==e||"undefined"===n||"number"===n||"boolean"===n||"string"===n)return e;if("function"==typeof e.toJson&&(r=e.toJson()),dojo.isArray(e))for(r=[],t=0;t<e.length;t++)"function"!=typeof(o=e[t])&&(r[t]=s(o));else if("object"===n){r={};for(var t in e)if(!("declaredClass"==t||t.indexOf("_inherited")>-1||void 0!==r[t])){var o=e[t];"function"!=typeof o&&(r[t]=s(o))}}return r}function c(e){var r=!1;try{var t=e.url.length;e.content&&(t+=dojo.objectToQuery(e.content).length);var o=new dojo._Url(e.url),i=window.location,s=t>n.config.io.postLength;if(!o.scheme&&!o.host&&!o.port)return!1;if(a()&&"https"===o.scheme)return!1;var c=!(i.protocol+"//"+i.hostname+(i.port?":"+i.port:"")==o.scheme+"://"+o.host+(o.port?":"+o.port:""));r=s&&c}catch(e){}return r}function a(){return/\bGeocortexApp\b/.test(navigator.userAgent)||/http:\/\/127.0.0.1(:[0-9]*)?\/viewerpackages\//gi.test(window.location.href)}Object.defineProperty(r,"__esModule",{value:!0}),r.deferredResolve=function(e,r){e&&-1==e.fired&&e.resolve(r)},r.deferredReject=function(e,r){e&&-1==e.fired&&e.reject(r)},r.encodeJson=function(e){var r=s(e),n={};for(var t in r)dojo.isArray(r[t])||"object"==typeof r[t]?n[t]=JSON.stringify(r[t]):n[t]=r[t];return n},r.request=function(e,r){r||(r={}),r.gcx||(r.gcx={}),void 0===r.gcx.preventCache?e.preventCache=!0:r.gcx.preventCache?e.preventCache=!0:e.preventCache=!1,e.timeout=e.timeout||n.config.io.timeout,e.handleAs=e.handleAs||"json";var i=c(e),s=t.hasProxy();if(i&&!s){var a=new Error("Cross-domain or large requests require a proxy.");dojo.isFunction(e.error)&&e.error(a);var u=new dojo.Deferred;return u.errback(a),u}return delete e.gcx,r.useProxy=i,r.hasOwnProperty("disableIdentityLookup")||(r.disableIdentityLookup=!0),new o.RestHelperHTTPService(e,r).send()},r.requiresProxy=c,r.isNative=a,r.urlToQueryObject=function(e){var r=e.indexOf("?");return-1===r?null:dojo.queryToObject(e.substring(r+1))},r._getExtensions=function(e){var r=[];if(!e)return r;r.length=e.length;for(var n=0;n<e.length;n++)r[n]=new i.Extension(e[n].className,e[n].instance);return r},r._extensionsToJson=function(e){return(e||[]).map(function(e){return{className:e.className,instance:e.instance}})},r._getProperties=function(e){var r={};if(!e)return r;for(var n=0;n<e.length;n++)r[e[n].name]=e[n].value;return r},r._propertiesToJson=function(e){return e?Object.keys(e).map(function(r){return{name:r,value:e[r]}}):[]},Date.now||(Date.now=function(){return+new Date})})}}});require({cache:{"geocortex/hasProxy":function(){define(["require","exports"],function(e,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.hasProxy=function(){var e=!1;try{e=esri._getProxyUrl()}catch(e){}return e}})}}});require({cache:{"geocortex/optimizer/EventRelay":function(){define(["require","exports","geocortex/framework/utils/TimeDelayedOperation"],function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t,i,a){var s=this;this._timer=null,this._siteId="",this._endpointUrl="",this.userName="",this._extentConnect=null,this._numConsecutiveFailures=0,this._enabled=!0,this._sessionId="",this._previousScale=-1,this._firstExtentLogged=!1,this._map=e,t&&(this._siteId=t),this._endpointUrl=i||window.location.protocol+"//"+window.location.host+"/Geocortex/Optimizer/Rest/DataRelay/LogData.ashx?f=json",a&&(this.userName=a),this._pendingEvents=new Array,this._timer=new n.TimeDelayedAction(3e3,this._flushQueue,this);var o={};o.extent=this._map.extent,e.loaded?(this._logExtentChange(o),this._extentConnect=e.on("extent-change",dojo.hitch(this,"_logExtentChange"))):e.on("load",function(){s._logExtentChange(o),s._extentConnect=e.on("extent-change",dojo.hitch(s,"_logExtentChange"))}),this._sessionId=this._crc32((new Date).getTime()+""+navigator.userAgent)}return e.prototype._logExtentChange=function(e){if(this._enabled){var t;if(t={},t.data=[{name:"ArcGISExtents",columns:{}}],t.data[0].columns=[{type:"tinyint",name:"InitialExtent",key:"InitialExtent"},{type:"real",name:"XMinNew",key:"XMinNew"},{type:"real",name:"YMinNew",key:"YMinNew"},{type:"real",name:"XMaxNew",key:"XMaxNew"},{type:"real",name:"YMaxNew",key:"YMaxNew"}],t.data[0].rows=[{InitialExtent:this._firstExtentLogged?0:1,XMinNew:e.extent.xmin,YMinNew:e.extent.ymin,XMaxNew:e.extent.xmax,YMaxNew:e.extent.ymax}],this._queueData(t),this._firstExtentLogged=!0,e.lod)e.levelChange&&this._previousScale>-1&&this._logScaleChange(this._previousScale,e.lod.scale),this._previousScale=e.lod.scale;else{var n=this._map.getScale();null!==n&&(this._previousScale!=n&&this._previousScale>-1&&this._logScaleChange(this._previousScale,n),this._previousScale=n)}}},e.prototype._logScaleChange=function(e,t){if(this._enabled){var n={};n.data=[{name:"ArcGISScale",columns:[]}],n.data[0].columns=[{type:"float",name:"ScaleOld",key:"ScaleOld"},{type:"float",name:"ScaleNew",key:"ScaleNew"}],n.data[0].rows=[{ScaleOld:e,ScaleNew:t}],this._queueData(n)}},e.prototype.logToolUsage=function(e,t){if(this._enabled){var n={};n.data=[{name:"ArcGISTool",columns:[]}],n.data[0].columns=[{type:"ustr",name:"Tool",key:"Tool"},{type:"ustr",name:"ToolData",key:"ToolData"}],n.data[0].rows=[{Tool:e,ToolData:t}],this._queueData(n)}},e.prototype._queueData=function(e){e.platform="js",e.data[0].columns.push({type:"now",name:"SampleTime",key:"SampleTime"},{type:"origin",name:"UserAddress",key:"UserAddress"},{type:"ustr",name:"SiteId",key:"SiteId"},{type:"ustr",name:"UserAgent",key:"UserAgent"},{type:"ustr",name:"UserName",key:"UserName"},{type:"ustr",name:"LayerList",key:"LayerList"},{type:"int",name:"SessionId",key:"SessionId"},{type:"ustr",name:"ClientType",key:"ClientType"},{type:"host",name:"MachineName",key:"MachineName"}),dojo.mixin(e.data[0].rows[0],{SiteId:this._siteId,UserAgent:navigator.userAgent,UserName:this.userName,LayerList:this._getCurrentLayerList(),SessionId:this._sessionId,ClientType:"JavaScript"}),this._pendingEvents.push(e),this._timer.reset()},e.prototype._flushQueue=function(){for(this._timer.stop();this._pendingEvents.length>0;){var e=this._pendingEvents.shift();this._logData(e)}},e.prototype._logData=function(e){try{dojo.xhrPost({url:this._endpointUrl,postData:JSON.stringify(e),timeout:1e4,load:dojo.hitch(this,this._handleLogSuccessResponse),error:dojo.hitch(this,this._handleLogErrorResponse)})}catch(e){console.log(e.message),this._incrementFailures()}},e.prototype._handleLogSuccessResponse=function(e){this._numConsecutiveFailures=0},e.prototype._handleLogErrorResponse=function(e){console.log(e),this._incrementFailures()},e.prototype._incrementFailures=function(){++this._numConsecutiveFailures>2&&(dojo.disconnect(this._extentConnect),this._enabled=!1)},e.prototype._getCurrentLayerList=function(){for(var e="",t=this._map.layerIds,n=0;n<t.length;n++){var i=t[n],a=this._map.getLayer(i);if(null!=a&&a.visible&&a.visibleAtMapScale){var s;if(a instanceof esri.layers.ArcGISDynamicMapServiceLayer){var o=a;for(s=0;s<o.visibleLayers.length;s++)null!=o.visibleLayers[s]&&-1!=o.visibleLayers[s]&&(e+=o.layerInfos.filter(function(e){return e.id==o.visibleLayers[s]})[0].name+"\\t")}else if(a instanceof esri.virtualearth.VETiledLayer)e+="Bing:"+a.mapStyle+"\\t";else if(a instanceof esri.layers.ArcGISImageServiceLayer)e+="Image:"+a.url+"\\t";else if(a instanceof esri.layers.ArcGISTiledMapServiceLayer){var r=a;for(s=0;s<r.layerInfos.length;s++)null!=r.layerInfos[s]&&(e+=r.layerInfos[s].name+"\\t")}}}return e.length>3&&(e=e.substring(0,e.length-2)),e},e.prototype._crc32=function(e){e=e.replace(/\r\n/g,"\n");for(var t="",n=0;n<e.length;n++){var i=e.charCodeAt(n);i<128?t+=String.fromCharCode(i):i>127&&i<2048?(t+=String.fromCharCode(i>>6|192),t+=String.fromCharCode(63&i|128)):(t+=String.fromCharCode(i>>12|224),t+=String.fromCharCode(i>>6&63|128),t+=String.fromCharCode(63&i|128))}var a,s=0;s^=-1;for(var o=0,r=(e=t).length;o<r;o++)a=255&(s^e.charCodeAt(o)),s=s>>>8^"0x"+"00000000 77073096 EE0E612C 990951BA 076DC419 706AF48F E963A535 9E6495A3 0EDB8832 79DCB8A4 E0D5E91E 97D2D988 09B64C2B 7EB17CBD E7B82D07 90BF1D91 1DB71064 6AB020F2 F3B97148 84BE41DE 1ADAD47D 6DDDE4EB F4D4B551 83D385C7 136C9856 646BA8C0 FD62F97A 8A65C9EC 14015C4F 63066CD9 FA0F3D63 8D080DF5 3B6E20C8 4C69105E D56041E4 A2677172 3C03E4D1 4B04D447 D20D85FD A50AB56B 35B5A8FA 42B2986C DBBBC9D6 ACBCF940 32D86CE3 45DF5C75 DCD60DCF ABD13D59 26D930AC 51DE003A C8D75180 BFD06116 21B4F4B5 56B3C423 CFBA9599 B8BDA50F 2802B89E 5F058808 C60CD9B2 B10BE924 2F6F7C87 58684C11 C1611DAB B6662D3D 76DC4190 01DB7106 98D220BC EFD5102A 71B18589 06B6B51F 9FBFE4A5 E8B8D433 7807C9A2 0F00F934 9609A88E E10E9818 7F6A0DBB 086D3D2D 91646C97 E6635C01 6B6B51F4 1C6C6162 856530D8 F262004E 6C0695ED 1B01A57B 8208F4C1 F50FC457 65B0D9C6 12B7E950 8BBEB8EA FCB9887C 62DD1DDF 15DA2D49 8CD37CF3 FBD44C65 4DB26158 3AB551CE A3BC0074 D4BB30E2 4ADFA541 3DD895D7 A4D1C46D D3D6F4FB 4369E96A 346ED9FC AD678846 DA60B8D0 44042D73 33031DE5 AA0A4C5F DD0D7CC9 5005713C 270241AA BE0B1010 C90C2086 5768B525 206F85B3 B966D409 CE61E49F 5EDEF90E 29D9C998 B0D09822 C7D7A8B4 59B33D17 2EB40D81 B7BD5C3B C0BA6CAD EDB88320 9ABFB3B6 03B6E20C 74B1D29A EAD54739 9DD277AF 04DB2615 73DC1683 E3630B12 94643B84 0D6D6A3E 7A6A5AA8 E40ECF0B 9309FF9D 0A00AE27 7D079EB1 F00F9344 8708A3D2 1E01F268 6906C2FE F762575D 806567CB 196C3671 6E6B06E7 FED41B76 89D32BE0 10DA7A5A 67DD4ACC F9B9DF6F 8EBEEFF9 17B7BE43 60B08ED5 D6D6A3E8 A1D1937E 38D8C2C4 4FDFF252 D1BB67F1 A6BC5767 3FB506DD 48B2364B D80D2BDA AF0A1B4C 36034AF6 41047A60 DF60EFC3 A867DF55 316E8EEF 4669BE79 CB61B38C BC66831A 256FD2A0 5268E236 CC0C7795 BB0B4703 220216B9 5505262F C5BA3BBE B2BD0B28 2BB45A92 5CB36A04 C2D7FFA7 B5D0CF31 2CD99E8B 5BDEAE1D 9B64C2B0 EC63F226 756AA39C 026D930A 9C0906A9 EB0E363F 72076785 05005713 95BF4A82 E2B87A14 7BB12BAE 0CB61B38 92D28E9B E5D5BE0D 7CDCEFB7 0BDBDF21 86D3D2D4 F1D4E242 68DDB3F8 1FDA836E 81BE16CD F6B9265B 6FB077E1 18B74777 88085AE6 FF0F6A70 66063BCA 11010B5C 8F659EFF F862AE69 616BFFD3 166CCF45 A00AE278 D70DD2EE 4E048354 3903B3C2 A7672661 D06016F7 4969474D 3E6E77DB AED16A4A D9D65ADC 40DF0B66 37D83BF0 A9BCAE53 DEBB9EC5 47B2CF7F 30B5FFE9 BDBDF21C CABAC28A 53B39330 24B4A3A6 BAD03605 CDD70693 54DE5729 23D967BF B3667A2E C4614AB8 5D681B02 2A6F2B94 B40BBE37 C30C8EA1 5A05DF1B 2D02EF8D".substr(9*a,8);return(s^=-1).toString()},e}();t.EventRelay=i})}}});require({cache:{"geocortex/workflow/ActivityContext":function(){define(["require","exports","./ArgumentValueWrapper","./ArgumentInfo","./DefaultActivityHandlers","./WorkflowControllerProxy"],function(e,t,r,i,n,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t,r,i){this.activityComplete=null,this._dispatcher=e,this._pendingIndex=t,this._workflow=r,this._workflowState=i}return e.prototype.dispatcher=function(){return this._dispatcher},e.prototype.workflow=function(){return this._workflow},e.prototype.getDisplayName=function(){return this._workflowState?this._workflowState.pendingExternalActivities[this._pendingIndex].displayName:""},e.prototype.getInputNames=function(){var e=[];if(this._workflowState)for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].inputs,r=0;r<t.length;r++)e.push(t[r].name);return e},e.prototype.getInputNamesByType=function(e){var t=[];if(this._workflowState)for(var r=this._workflowState.pendingExternalActivities[this._pendingIndex].inputs,i=0;i<r.length;i++)0===r[i].typeName.indexOf(e)&&t.push(r[i].name);return t},e.prototype.getOutputNames=function(){var e=[];if(this._workflowState)for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].outputs,r=0;r<t.length;r++)e.push(t[r].name);return e},e.prototype.getOutputNamesByType=function(e){var t=[];if(this._workflowState)for(var r=this._workflowState.pendingExternalActivities[this._pendingIndex].outputs,i=0;i<r.length;i++)0===r[i].typeName.indexOf(e)&&t.push(r[i].name);return t},e.prototype.getSite=function(){return null!=this._workflow?this._workflow.site:null},e.prototype.getEsriMap=function(){return null!=this._workflow&&null!=this._workflow.site?this._workflow.site.getMap():null},e.prototype.getValue=function(e){if(this._workflowState)for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].inputs,r=0;r<t.length;r++)if(t[r].name==e)return t[r].value;return null},e.prototype.getOutputValue=function(e){if(this._workflowState)for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].outputs,r=0;r<t.length;r++)if(t[r].name==e)return t[r].value;return null},e.prototype.getJsonValue=function(e){for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].inputs,r=0;r<t.length;r++)if(t[r].name==e)return JSON.stringify(t[r].value);return null},e.prototype.getOutputJsonValue=function(e){if(this._workflowState)for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].outputs,r=0;r<t.length;r++)if(t[r].name==e){var i=t[r].value;return i&&1===i.length&&(i=i[0]),JSON.stringify(i)}return null},e.prototype.setValue=function(e,t,n){if(this._workflowState){var a=!1,o=this._workflowState.pendingExternalActivities[this._pendingIndex].outputs,l=this._getRuntimeType(t);t&&t instanceof r.ArgumentValueWrapper&&(l=t.runtimeTypeName,t=t.value);for(var s=0;s<o.length;s++)if(o[s].name==e){a=!0,(u=o[s])&&(u.value=t,null!=l&&(u.runtimeTypeName=l));break}if(!a&&n){l||(l="System.Object");var u=new i.ArgumentInfo;u.isRequired=!1,u.name=e,u.value=t,u.typeName=l,u.runtimeTypeName=l,this._workflowState.pendingExternalActivities[this._pendingIndex].outputs.push(u)}}},e.prototype.getActivityTypeName=function(){var e="";if(this._workflowState&&(e=this._workflowState.pendingExternalActivities[this._pendingIndex].typeName)){var t=e.indexOf("`");t>=0&&(e=e.substring(0,t))}return e},e.prototype.getActivityExternalId=function(){return this._workflowState?this._workflowState.pendingExternalActivities[this._pendingIndex].externalId:""},e.prototype.getInputArgumentTypeName=function(e){if(this._workflowState)for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].inputs,r=0;r<t.length;r++)if(t[r].name==e)return t[r].typeName;return""},e.prototype.getInputArgumentRuntimeTypeName=function(e){for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].inputs,r=0;r<t.length;r++)if(t[r].name==e)return t[r].runtimeTypeName;return""},e.prototype.completeActivity=function(){if(this._workflowState){var e=this._workflowState.pendingExternalActivities[this._pendingIndex];if(e.isComplete)return;var t=this;"debugger"==this.getActivityExternalId()||e&&e.debug?n.showDebug(this,!1,function(){t._completeActivityInternal()}):this._completeActivityInternal()}},e.prototype.abortActivity=function(){if(this._workflowState){var e=this._workflowState.pendingExternalActivities[this._pendingIndex];e.isAborted=!0,this._workflowState.status="Aborted: "+e.displayName}null!=this._dispatcher&&this._dispatcher.activityAbort(this)},e.prototype._completeActivityInternal=function(){if(this._workflowState){var e=this._workflowState.pendingExternalActivities[this._pendingIndex];e.isComplete=!0,null!=this._dispatcher&&this._dispatcher.activityComplete(this),e.inputs=null;var t=this._workflowState.pendingExternalActivities[this._pendingIndex].syncToken,r=!0;if(""!=t)for(var i=this._workflowState.pendingExternalActivities,n=0;n<i.length;n++)if(i[n].syncToken==t&&!i[n].isComplete){r=!1;break}r&&(a._executeWorkflow(this._workflow,this._dispatcher,this._workflowState,null,this),dojo.isFunction(this.activityComplete)&&this.activityComplete(this))}},e.prototype._getRuntimeType=function(e){var t="System.Object";return e&&("function"==typeof e.isInstanceOf?e.isInstanceOf(esri.geometry.Extent)?t="ESRI.ArcGIS.Client.Geometry.Envelope":e.isInstanceOf(esri.geometry.Extent)?t="ESRI.ArcGIS.Client.Geometry.Envelope":e.isInstanceOf(esri.geometry.Point)?t="ESRI.ArcGIS.Client.Geometry.MapPoint":e.isInstanceOf(esri.geometry.Multipoint)?t="ESRI.ArcGIS.Client.Geometry.MultiPoint":e.isInstanceOf(esri.geometry.Polygon)?t="ESRI.ArcGIS.Client.Geometry.Polygon":e.isInstanceOf(esri.geometry.Polyline)?t="ESRI.ArcGIS.Client.Geometry.Polyline":e.isInstanceOf(esri.geometry.Geometry)?t="ESRI.ArcGIS.Client.Geometry.Geometry":e.isInstanceOf(esri.layers.LayerDataSource)?t="ESRI.ArcGIS.Client.LayerDataSource":e.isInstanceOf(esri.layers.LayerMapSource)&&(t="ESRI.ArcGIS.Client.LayerMapSource"):"string"==typeof e?t="System.String":"number"==typeof e?t="System.Double":"boolean"==typeof e?t="System.Boolean":"object"==typeof e&&(t="function"==typeof e.getMonth?"System.DateTime":"System.Object")),t},e}();t.ActivityContext=o})},"geocortex/workflow/ActivityDispatcher":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/workflow/ArgumentInfo":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t,r,i){this.runtimeTypeName=null,this.name=e||null,this.typeName=t||null,this.isRequired=!!r,this.value=i||null}return e.prototype._configureObject=function(e){if(void 0===e.name||void 0===e.typeName)throw new Error("Incorrect argument info object returned from initialization");this.name=e.name,this.typeName=e.typeName,this.isRequired=e.isRequired,this.value=e.value,this.runtimeTypeName=e.runtimeTypeName},e.prototype._internalClone=function(){var t=new e(this.name,this.typeName,this.isRequired,dojo.clone(this.value));return t.runtimeTypeName=dojo.clone(this.runtimeTypeName),t},e}();t.ArgumentInfo=r})},"geocortex/workflow/ArgumentValueWrapper":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(e,t){this.runtimeTypeName=null,this.runtimeTypeName=e||null,this.value=t||null};t.ArgumentValueWrapper=r})},"geocortex/workflow/CacheActivityHandlers":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r={};t.handleGetExternalValue=function(e){var t=e.getValue("Key");if(null!=t){var i=r[t];void 0===i&&(i=null),e.setValue("Value",i)}e.completeActivity()},t.handleSetExternalValue=function(e){var t=e.getValue("Key"),i=e.getValue("Value");null!=t&&(r[t]=i),e.completeActivity()}})},"geocortex/workflow/DefaultActivityDispatcher":function(){define(["require","exports","./DialogActivityHandlers","./MapActivityHandlers","./DefaultActivityHandlers","./NativeActivityHandlers","./CacheActivityHandlers","./LayerActivityHandlers","./MapServiceActivityHandlers"],function(e,t,r,i,n,a,o,l,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t,r,i,n,a,o){this.isBusy=!1,this._drawObjectContext=null,this._registeredActivityHandlers={},this._registeredExternalIdHandlers={},this.handleUnhandledActivityErrorFunction=null,this.handleOpenReportUrlFunction=null,this.defaultFormContainerId="form-container-outer",this.defaultFormContentId="form-container",this._handleErrorFunction=e||null,this._activityBeginFunction=t||null,this._activityCompleteFunction=r||null,this._workflowAbortFunction=n||null,this._workflowCompleteFunction=i||null,this._webRequestBeginFunction=a||null,this._webRequestCompleteFunction=o||null,this.registerDefaultHandlers()}return e.prototype.registerDefaultHandlers=function(){this.registerActivityHandler("Geocortex.Workflow.Activities.Alert",r.handleAlert),this.registerActivityHandler("Geocortex.Workflow.Activities.CaptureGeometry",i.MapActivityHandlers.handleCaptureGeometry),this.registerActivityHandler("Geocortex.Workflow.Activities.Confirm",r.handleConfirm),this.registerActivityHandler("Geocortex.Workflow.Activities.ExportMap",i.MapActivityHandlers.handleExportMap),this.registerActivityHandler("Geocortex.Workflow.Activities.ExternalDelay",n.handleExternalDelay),this.registerActivityHandler("Geocortex.Workflow.Activities.GetBrowserUrl",n.handleGetBrowserUrl),this.registerActivityHandler("Geocortex.Workflow.Activities.GetCurrentPosition",a.handleGetCurrentPosition),this.registerActivityHandler("Geocortex.Workflow.Activities.GetExternalTimeInfo",n.handleGetExternalTimeInfo),this.registerActivityHandler("Geocortex.Workflow.Activities.GetExternalValue",o.handleGetExternalValue),this.registerActivityHandler("Geocortex.Workflow.Activities.GetGraphicsLayerContent",l.handleGetGraphicsLayerContent),this.registerActivityHandler("Geocortex.Workflow.Activities.GetLayerDefinition",l.handleGetLayerDefinition),this.registerActivityHandler("Geocortex.Workflow.Activities.GetLayerInfoByProperty",n.handleGetLayerInfoByProperty),this.registerActivityHandler("Geocortex.Workflow.Activities.GetLayerProperty",l.handleGetLayerProperty),this.registerActivityHandler("Geocortex.Workflow.Activities.GetLayerVisibility",l.handleGetLayerVisibility),this.registerActivityHandler("Geocortex.Workflow.Activities.GetMapExtent",i.MapActivityHandlers.handleGetMapExtent),this.registerActivityHandler("Geocortex.Workflow.Activities.GetMapInfo",i.MapActivityHandlers.handleGetMapInfo),this.registerActivityHandler("Geocortex.Workflow.Activities.GetMapServiceInfo",s.handleGetMapServiceInfo),this.registerActivityHandler("Geocortex.Workflow.Activities.GetPhoto",a.handleGetPhoto),this.registerActivityHandler("Geocortex.Workflow.Activities.PrintMap",i.MapActivityHandlers.handlePrintMap),this.registerActivityHandler("Geocortex.Workflow.Activities.Prompt",r.handlePrompt),this.registerActivityHandler("Geocortex.Workflow.Activities.RefreshMap",i.MapActivityHandlers.handleRefreshMap),this.registerActivityHandler("Geocortex.Workflow.Activities.RemoveMapService",s.handleRemoveMapService),this.registerActivityHandler("Geocortex.Workflow.Activities.Report",n.handleReport),this.registerActivityHandler("Geocortex.Workflow.Activities.SetExternalValue",o.handleSetExternalValue),this.registerActivityHandler("Geocortex.Workflow.Activities.SetLayerDefinition",l.handleSetLayerDefinition),this.registerActivityHandler("Geocortex.Workflow.Activities.SetLayerProperty",l.handleSetLayerProperty),this.registerActivityHandler("Geocortex.Workflow.Activities.SetLayerVisibility",l.handleSetLayerVisibility),this.registerActivityHandler("Geocortex.Workflow.Activities.SetMapExtent",i.MapActivityHandlers.handleSetMapExtent),this.registerActivityHandler("Geocortex.Workflow.Activities.SetMapServiceVisibility",s.handleSetMapServiceVisibility),this.registerActivityHandler("Geocortex.Workflow.Activities.UpdateGraphicsLayer",l.handleUpdateGraphicsLayer),this.registerActivityHandler("Geocortex.Workflow.Activities.WaitForGeoprocessorJobComplete",n.handleWaitForGeoprocessorJobComplete),this.registerActivityHandler("Geocortex.Workflow.Activities.SetImageServiceInfo",s.handleSetImageServiceInfo),this.registerActivityHandler("Geocortex.Workflow.Activities.SetMapServiceProperty",s.handleSetMapServiceProperty),this.registerExternalIdHandler("IntersectLayers",i.MapActivityHandlers.handleIntersectLayers),this.registerExternalIdHandler("GetPhoto",a.handleGetPhoto)},e.prototype.canHandleActivity=function(e){if(!e){var t=new Error("Null ActivityContext passed to canHandleActivity.");this.handleError(t,e)}if(null!=e.getActivityExternalId()&&null!=this._registeredExternalIdHandlers[e.getActivityExternalId()])return!0;var r=e.getActivityTypeName();return!(null==r||!this._registeredActivityHandlers[r])},e.prototype.registerExternalIdHandler=function(e,t){if(null!=e&&null!=t)this._registeredExternalIdHandlers[e]=t;else{var r=new Error("Null externalId or handler passed to registerExternalIdHandler.");this.handleError(r,null)}},e.prototype.registerActivityHandler=function(e,t){if(null!=e&&null!=t)this._registeredActivityHandlers[e]=t;else{var r=new Error("Null activityTypeName or handler passed to registerActivityHandler.");this.handleError(r,null)}},e.prototype.dispatch=function(e){if(null!=e){var t=e.getActivityTypeName(),r=e.getActivityExternalId();if(this.canHandleActivity(e)){if(null!=r&&null!=this._registeredExternalIdHandlers[r]&&(i=this._registeredExternalIdHandlers[r])(e,this),null!=t&&this._registeredActivityHandlers[t]){var i=this._registeredActivityHandlers[t];i(e,this)}}else n=new Error("Unknown activity type '"+t+"' or external ID '"+r+"' encountered."),this.handleUnhandledActivityErrorFunction(n,e)}else{var n=new Error("Null ActivityContext passed to dispatch.");this.handleError(n,e)}},e.prototype.handleError=function(e,t){null!=this._handleErrorFunction&&this._handleErrorFunction(e,t)},e.prototype.handleUnhandledActivityError=function(e,t){null!=this.handleUnhandledActivityErrorFunction?this.handleUnhandledActivityErrorFunction(e,t):this.handleError(e,t)},e.prototype.handleOpenReportUrl=function(e,t){null!=this.handleOpenReportUrlFunction?this.handleOpenReportUrlFunction(e,t):window.open(e)},e.prototype.webRequestBegin=function(e,t){null!=this._webRequestBeginFunction&&this._webRequestBeginFunction(e,t)},e.prototype.webRequestComplete=function(e,t){null!=this._webRequestCompleteFunction&&this._webRequestCompleteFunction(e,t)},e.prototype.abortMapBasedActivity=function(){if(this._drawObjectContext){if(!this._drawObjectContext.toolbar||!this._drawObjectContext.drawEvent||!this._drawObjectContext.activityContext)return!1;this._drawObjectContext.toolbar.deactivate(),dojo.disconnect(this._drawObjectContext.drawEvent),this._drawObjectContext.activityContext.abortActivity(),this._drawObjectContext=null}return!0},e.prototype.setDrawObjectContext=function(e){this._drawObjectContext=e},e.prototype.activityBegin=function(e){null!=this._activityBeginFunction&&this._activityBeginFunction(e)},e.prototype.activityComplete=function(e){null!=this._activityCompleteFunction&&this._activityCompleteFunction(e)},e.prototype.activityAbort=function(e){this.workflowAbort(e,e.workflow())},e.prototype.workflowComplete=function(e,t){null!=this._workflowCompleteFunction&&this._workflowCompleteFunction(e,t)},e.prototype.workflowAbort=function(e,t){null!=this._workflowAbortFunction&&this._workflowAbortFunction(e,t)},e}();t.DefaultActivityDispatcher=u})},"geocortex/workflow/DefaultActivityHandlers":function(){define(["require","exports","./MapServiceActivityHandlers","./../essentials/ReportParameters","./../essentials/TextField","./../essentials/RestHelper","./../forms/FormDefinition","./../forms/items/TextBoxFormItem","./../forms/items/TextAreaFormItem","./../forms/items/LabelFormItem","./../essentials/MapServiceConstants","geocortex/framework/utils/utils"],function(e,t,r,i,n,a,o,l,s,u,c,p){"use strict";function d(e){switch(e){case"esriJobNew":return 0;case"esriJobSubmitted":return 1;case"esriJobWaiting":return 2;case"esriJobExecuting":return 3;case"esriJobSucceeded":return 4;case"esriJobFailed":return 5;case"esriJobTimedOut":return 6;case"esriJobCancelling":return 7;case"esriJobCancelled":return 8;case"esriJobDeleting":return 9;case"esriJobDeleted":return 10;default:return-1}}Object.defineProperty(t,"__esModule",{value:!0}),t.getPropertyIgnoreCase=function(e,t){for(var r in e)if(e.hasOwnProperty(r)&&r.toLowerCase()===t.toLowerCase())return r;return null},t.handleReport=function(e){var t=e.getValue("MapServiceId"),o=e.getValue("LayerId"),l=e.getValue("LayerName"),s=e.getValue("ReportId"),u=null,c=e.getSite();if(c&&t&&(o||l)&&s){var p=r.findMapServiceById(c,t);if(p){var d=null;o?d=p.findLayerOrTableById(o):l&&(d=p.findLayerOrTableByName(l)),null!=d&&(u=d.findReportById(s))}}if(u){var f=new esri.tasks.Query,y=new i.ReportParameters,h=e.getValue("ShowOpenReport"),v=e.getValue("Geometry"),g=e.getValue("OutSpatialReference"),w=e.getValue("Text"),m=e.getValue("Where"),S=e.getValue("OutputFormat"),E=e.getValue("Resolution"),A=e.getValue("CustomExtent"),b=e.getValue("SpatialRelationship"),I=e.getValue("ReportExtentType"),x=e.getValue("NotificationEmailAddress"),V=e.getValue("TextFields");if(I||(I=i.ReportParameters.CURRENT_EXTENT),y.extentType=I,S&&(y.outputFormat=S),u.textFields)for(var _ in u.textFields)if(u.textFields.hasOwnProperty(_)){var L=u.textFields[_],k=function(e){var t=null;if(V&&e)for(var r=0,i=V;r<i.length;r++){var n=i[r];if(n.Key===e.displayName||"tf_"+n.Key===e.id||n.Key===e.id){t=n;break}}return t}(L);null!=k?y.fields.push(new n.TextField(L.id,L.displayName,k.Value,L.multiline)):y.fields.push(L)}x&&(y.notificationEmailAddress=x),E&&(y.resolution=E),A&&(y.customExtent=A),f.spatialRelationship=a.RestHelper._convertSpatialRelationshipFromDotnetIndex(b),v&&(f.geometry=v),g&&(f.outSpatialReference=g),w&&(f.text=w),m&&(f.where=m),u.run(f,y,function(t){var r=t?t.href:null;h&&r&&r.length>0&&e.dispatcher().handleOpenReportUrl(r,e),e.setValue("ResultUrl",r),e.completeActivity()},function(t){e.dispatcher().handleError(new Error("Error running report '"+t.message+"'"),e)})}else e.dispatcher().handleError(new Error("Cannot find report '"+s+"'"),e)},t.showDebug=function(e,t,r){var i=new o.FormDefinition;i.maxHeight.set(600),i.maxWidth.set(500);var n;if(t?(i.title.set("Debug - Input Arguments for "+e.getDisplayName()),i.containerFormItem.description.set("Input Arguments:"),n=e.getInputNames()):(i.title.set("Debug - Output Arguments for "+e.getDisplayName()),i.containerFormItem.description.set("Output Arguments:"),n=e.getOutputNames()),null!=n&&n.length>0)for(var a=0,c=n;a<c.length;a++){var p=c[a],d=void 0;(d=t?e.getValue(p):e.getOutputValue(p))&&"object"==typeof d&&(d=t?e.getJsonValue(p):e.getOutputJsonValue(p));var f=void 0;!d||String(d).length<100&&-1===String(d).indexOf("\n")?f=new l.TextBoxFormItem(null,i):(f=new s.TextAreaFormItem(null,i)).textboxHeight.set(100),f.label=new u.LabelFormItem(null,i),f.text.set(d),f.textboxWidth.set(300),f.label.text.set(p),f.readOnly.set(!0),i.containerFormItem.formItems.addItem(f)}var y=e.dispatcher();y&&"function"==typeof y._showDebugHandler?y._showDebugHandler(i,r):r&&r()},t.handleGetBrowserUrl=function(e){e.setValue("Url",window.location.href),e.completeActivity()},t.handleExternalDelay=function(e){var t=e.getValue("Milliseconds");if(null==t)throw new Error("External Delay: required Milliseconds argument was not supplied.");setTimeout(function(){e.completeActivity()},t)},t.handleGetExternalTimeInfo=function(e){var t=new Date;e.setValue("UtcOffset",-6e4*t.getTimezoneOffset()),e.completeActivity()},t.handleWaitForGeoprocessorJobComplete=function(e){var t=e.getValue("GeoprocessorUrl"),r=(e.getValue("Token"),e.getValue("ProxyURL"),e.getValue("UpdateDelay")),i=e.getValue("JobId"),n=!1;if(!t)throw new Error("GeoprocessorUrl parameter is missing.");if(!i)throw new Error("JobId parameter is missing.");var a=new esri.tasks.Geoprocessor(t);r>0&&a.setUpdateDelay(r),dojo.connect(a,"onError",function(t){e.setValue("Result",d(esri.tasks.JobInfo.STATUS_FAILED)),e.completeActivity()}),dojo.connect(a,"onStatusUpdate",function(t){if(!n){var o=t.jobStatus;o===esri.tasks.JobInfo.STATUS_CANCELLED||o===esri.tasks.JobInfo.STATUS_DELETED||o===esri.tasks.JobInfo.STATUS_FAILED||o===esri.tasks.JobInfo.STATUS_SUCCEEDED||o===esri.tasks.JobInfo.STATUS_TIMED_OUT?(n=!0,e.setValue("Result",d(o)),e.completeActivity()):window.setTimeout(function(){a.checkJobStatus(i)},r)}}),a.checkJobStatus(i)},t._getJobStatusCode=d,t.handleGetLayerInfoByProperty=function(e){if(!e)throw new Error("Get Map Service Info: required context was not supplied.");var t=e.getValue("PropertyName");if(null==t)throw new Error("Provide a Property Name: No property name available.");var r=e.getSite();if(!r)throw new Error("Set Layer Visibility: No site available.");for(var i=[],n=r.essentialsMap.mapServices,a={mapServiceUrl:"",mapServiceId:"",token:"",isVisible:!1,isDynamic:!1,propertyValue:null,id:"",name:"",displayName:"",layerUrl:""},o=null,l=0,s=n;l<s.length;l++)for(var u=s[l],d=0,f=u.layers.concat(u.tables);d<f.length;d++){var y=f[d];if(!p.isNullOrUndefined(y.properties[t])){if(a.mapServiceUrl=u.serviceUrl,a.mapServiceId=u.id,a.token=u.serviceToken,a.isVisible=y.isVisible(),a.isDynamic=y.isDynamic,a.propertyValue=y.properties[t],a.id=y.id,a.name=y.name,a.displayName=y.displayName,u.mapServiceType===c.MapServiceType.FEATURE?a.layerUrl=a.mapServiceUrl:a.layerUrl=a.mapServiceUrl+"/"+(a.isDynamic?"dynamicLayer":a.id),a.isDynamic){var h=n[0].serviceLayer;if(h&&h.dynamicLayerInfos)for(var v=0;v<h.dynamicLayerInfos.length;v++)if((o=h.dynamicLayerInfos[v])&&o.id.toString()===a.id){o.source&&(a.layerSourceJson=JSON.stringify(o.source.toJson()));break}}i.push(a),a={mapServiceUrl:"",mapServiceId:"",token:"",isVisible:!1,isDynamic:!1,propertyValue:null,id:"",name:"",displayName:"",layerUrl:""}}}e.setValue("LayersInfo",i),e.completeActivity()}})},"geocortex/workflow/DialogActivityHandlers":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleAlert=function(e){e.getValue("Title");var t=e.getValue("Text");alert(t),e.completeActivity()},t.handleConfirm=function(e){var t=e.getValue("Text"),r=confirm(t);null==r&&(r=!1),e.setValue("Result",r),e.completeActivity()},t.handlePrompt=function(e){var t=e.getValue("Description"),r=e.getValue("DefaultText"),i=prompt(t,r);e.setValue("Result",i),e.completeActivity()}})},"geocortex/workflow/ExternalActivityInfo":function(){define(["require","exports","./ArgumentInfo"],function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t,r,i,n,a,o,l,s){this.debug=!1,this.id=e||null,this.displayName=t||null,this.typeName=r||null,this.instanceId=i||null,this.externalId=n||null,this.syncToken=a||null,this.isComplete=o||!1,this.isAborted=!1,this.inputs=l||[],this.outputs=s||[]}return e.prototype._configureObject=function(e){if(void 0===e.id||void 0===e.displayName||void 0===e.typeName||void 0===e.instanceId)throw new Error("Incorrect external activity info object returned from initialization");this.id=e.id,this.displayName=e.displayName,this.typeName=e.typeName,this.instanceId=e.instanceId,this.externalId=e.externalId,this.syncToken=e.syncToken,this.isComplete=e.isComplete,e.debug&&(this.debug=e.debug),this.inputs=[],this.outputs=[];var t;if(e.inputs)for(t=0;t<e.inputs.length;t++)i=e.inputs[t],(n=new r.ArgumentInfo)._configureObject(i),this.inputs[t]=n;if(e.outputs)for(t=0;t<e.outputs.length;t++){var i=e.outputs[t],n=new r.ArgumentInfo;n._configureObject(i),this.outputs[t]=n}},e}();t.ExternalActivityInfo=i})},"geocortex/workflow/LayerActivityHandlers":function(){define(["require","exports","./MapServiceActivityHandlers","./DefaultActivityHandlers"],function(e,t,r,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleSetLayerProperty=function(e){var t=e.getValue("MapServiceId"),n=e.getValue("LayerId"),a=e.getValue("LayerName"),o=e.getValue("PropertyName"),l=e.getValue("Value");if(!t)throw new Error("Set Layer Property: required MapServiceId argument was not supplied.");if(!n&&!a)throw new Error("Set Layer Property: a LayerId or a LayerName argument must be supplied.");var s=e.getSite();if(!s)throw new Error("Set Layer Property: No site available.");var u=r.findMapServiceById(s,t);if(!u||!u.serviceLayer)throw new Error("Set Layer Property: Unable to find map service with ID '"+t+"'");var c=null;if(!(c=n?u.findLayerById(n):u.findLayerByName(a)))throw new Error("Set Layer Property: Unable to find layer with Name '"+a+"' or ID '"+n+"'.");var p=i.getPropertyIgnoreCase(c,o);if(p)c[p]=l;else{if(!(p=i.getPropertyIgnoreCase(c.properties,o)))throw new Error("Set Layer Property: Layer does not support the property '"+o+"'.");c.properties[p]=l}e.completeActivity()},t.handleGetLayerProperty=function(e){var t=e.getValue("MapServiceId"),n=e.getValue("LayerId"),a=e.getValue("LayerName"),o=e.getValue("PropertyName");if(!t)throw new Error("Get Layer Property: required MapServiceId argument was not supplied.");if(!n&&!a)throw new Error("Get Layer Property: a LayerId or a LayerName argument must be supplied.");var l=e.getSite();if(!l)throw new Error("Get Layer Property: No site available.");var s=r.findMapServiceById(l,t);if(!s||!s.serviceLayer)throw new Error("Get Layer Property: Unable to find map service with ID '"+t+"'");var u=null;if(!(u=n?s.findLayerById(n):s.findLayerByName(a)))throw new Error("Get Layer Property: Unable to find layer with Name '"+a+"' or ID '"+n+"'.");var c=i.getPropertyIgnoreCase(u,o);if(c)e.setValue("Value",u[c]);else{if(!(c=i.getPropertyIgnoreCase(u.properties,o)))throw new Error("Get Layer Property: Layer does not support the property '"+o+"'.");e.setValue("Value",u.properties[c])}e.completeActivity()},t.handleGetLayerVisibility=function(e){var t=e.getValue("MapServiceId"),i=e.getValue("LayerId"),n=e.getValue("LayerName"),a=e.getValue("EffectiveVisibility");if(!t)throw new Error("Get Layer Visibility: required MapServiceId argument was not supplied.");if(!i&&!n)throw new Error("Get Layer Visibility: a LayerId or a LayerName argument must be supplied.");var o=e.getSite();if(!o)throw new Error("Get Layer Visibility: No site available.");var l=r.findMapServiceById(o,t);if(!l)throw new Error("Get Layer Visibility: Unable to find map service with ID '"+t+"'");var s=null;if(i?s=l.findLayerById(i):n&&(s=l.findLayerByName(n)),!s)throw new Error("Get Layer Visibility: Unable to find layer with ID '"+i+"' in map service with ID '"+t+"'");var u=s.isVisible();if(a&&(u=!1,s.isVisible()&&l.isVisible()&&s.withinScaleRange(null)))for(var c=l.getVisibleLayers(),p=0;p<c.length;p++)if(c[p]==s.id){u=!0;break}e.setValue("Visible",u),e.completeActivity()},t.handleSetLayerVisibility=function(e){var t=e.getValue("MapServiceId"),i=e.getValue("LayerId"),n=e.getValue("LayerName"),a=e.getValue("Visible");if(!t)throw new Error("Set Layer Visibility: required MapServiceId argument was not supplied.");if(!i&&!n)throw new Error("Set Layer Visibility: a LayerId or a LayerName argument must be supplied.");if(null===a)throw new Error("Set Layer Visibility: required Visible argument was not supplied.");var o=e.getSite();if(!o)throw new Error("Set Layer Visibility: No site available.");var l=r.findMapServiceById(o,t);if(!l)throw new Error("Set Layer Visibility: Unable to find map service with ID '"+t+"'");var s=null;if(i){if(!(s=l.findLayerById(i)))throw new Error("Set Layer Visibility: Unable to find layer with ID '"+i+"' in map service with ID '"+t+"'")}else{if(!n)throw new Error("Set Layer Visibility: must define layer ID or name");if(!(s=l.findLayerByName(n)))throw new Error("Set Layer Visibility: Unable to find layer with name '"+n+"' in map service with ID '"+t+"'")}s.setVisibility(a),e.completeActivity()},t.handleGetLayerDefinition=function(e){var t=e.getValue("MapServiceId"),i=e.getValue("LayerId"),n=e.getValue("LayerName");if(!t)throw new Error("Get Layer Definition: required MapServiceId argument was not supplied.");if(!i&&!n)throw new Error("Get Layer Definition: a LayerId or a LayerName argument must be supplied.");var a=null,o=e.getSite();if(o){var l=r.findMapServiceById(o,t);if(l&&l.serviceLayer){if(!i&&n){var s=l.findLayerByName(n);if(!s)throw new Error("Set Layer Definition: Unable to find layer with Name '"+n+"'.");i=s.id}l.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer?l.serviceLayer.layerDefinitions&&(a=l.serviceLayer.layerDefinitions[parseInt(i)]):l.serviceLayer instanceof esri.layers.FeatureLayer&&(a=l.serviceLayer.getDefinitionExpression())}}e.setValue("Definition",a),e.completeActivity()},t.handleSetLayerDefinition=function(e){var t=e.getValue("MapServiceId"),i=e.getValue("LayerId"),n=e.getValue("LayerName"),a=e.getValue("Definition");if(!t)throw new Error("Set Layer Definition: required MapServiceId argument was not supplied.");if(!i&&!n)throw new Error("Set Layer Definition: a LayerId or a LayerName argument must be supplied.");var o=e.getSite();if(!o)throw new Error("Set Layer Visibility: No site available.");var l=r.findMapServiceById(o,t);if(!l||!l.serviceLayer)throw new Error("Set Layer Definition: Unable to find map service with ID '"+t+"'");if(!i&&n){var s=l.findLayerByName(n);if(!s)throw new Error("Set Layer Definition: Unable to find layer with Name '"+n+"'.");i=s.id}if(l.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer){var u=l.serviceLayer;u.layerDefinitions||(u.layerDefinitions=[]),u.layerDefinitions[parseInt(i)]=a,u.setLayerDefinitions(u.layerDefinitions,!0)}else{if(!(l.serviceLayer instanceof esri.layers.FeatureLayer))throw new Error("Set Layer Definition: Map service type does not support layer definitions.");l.serviceLayer.setDefinitionExpression(a)}e.completeActivity()},t.handleGetGraphicsLayerContent=function(e){var t=e.getValue("GraphicsLayerId"),r=e.getValue("GeometryType"),i=null;null!==r&&(0===r?i="extent":1===r?i="multipoint":2===r?i="point":3===r?i="polygon":4===r&&(i="polyline"));var n=e.getEsriMap();if(null!=n&&null!=n.graphicsLayerIds)for(var a=0;a<n.graphicsLayerIds.length;a++)if(t==n.graphicsLayerIds[a]){var o=n.getLayer(n.graphicsLayerIds[a]);if(null!=o&&null!=o.graphics){for(var l=new esri.tasks.FeatureSet,s=0;s<o.graphics.length;s++){var u=o.graphics[s];if(null!==i){if(null===u.geometry)continue;if(i!==u.geometry.type)continue}var c=new esri.Graphic(u.geometry,null,u.attributes,null);l.features.push(c)}e.setValue("Features",l)}break}e.completeActivity()},t.handleUpdateGraphicsLayer=function(e){var t=e.getValue("GraphicsLayerId"),i=!!e.getValue("RemoveAllFeatures"),n=e.getValue("FeatureSet"),a=e.getValue("RendererJson"),o=e.getEsriMap();if(null==o)throw new Error("Update Graphics Layer: No map available.");var l=!1,s=r.findMapServiceByMap(o,t);if(s){if(!(s instanceof esri.layers.GraphicsLayer))throw new Error("Update Graphics Layer: The layer '"+t+"' is not a GraphicsLayer")}else s=new esri.layers.GraphicsLayer({id:t}),l=!0;try{if(s.suspend(),i&&s.clear(),n&&n.features)for(var u=n.features.length-1;u>=0;--u)s.add(n.features[u]);a&&(s.renderer=esri.renderer.fromJson(JSON.parse(a))),l&&o.addLayer(s)}finally{s.resume()}e.completeActivity()}})},"geocortex/workflow/MapActivityHandlers":function(){define(["require","exports","./../essentials/utilities/SiteResourceIdComparer","./../essentials/LayerType","./../essentials/ReportParameters","./../essentials/Resolution","./../essentials/Scale","./../essentials/TextField"],function(e,t,r,i,n,a,o,l){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.handleRefreshMap=function(e){var t=e.getValue("MapServiceId");if(null==e.getEsriMap())throw new Error("Refresh Map: no map available.");var i=function(e){var t=e.serviceLayer;if("function"==typeof t.refresh)if("boolean"==typeof t.disableClientCaching){var r=t.disableClientCaching;t.disableClientCaching=!0,t.refresh(),t.disableClientCaching=r}else t.refresh()},n=e.workflow().site.essentialsMap.mapServices;if(t){var a=r.SiteResourceIdComparer.lookUp(n,t);a&&i(a)}else dojo.forEach(n,function(e){i(e)});e.completeActivity()},e.handleGetMapExtent=function(e){var t=e.getEsriMap();if(null==t)throw new Error("Get Map Extent: No map available.");e.setValue("Extent",t.extent),e.completeActivity()},e.handleGetMapInfo=function(e){var t=e.getEsriMap();if(null==t)throw new Error("Get Map Info: No map available.");e.setValue("Extent",t.extent),e.setValue("Scale",esri.geometry.getScale(t)),e.setValue("SpatialReference",t.spatialReference),e.setValue("Height",t.height),e.setValue("Width",t.width);var r=[];null!=t.layerIds&&(r=r.concat(t.layerIds)),null!=t.graphicsLayerIds&&(r=r.concat(t.graphicsLayerIds)),e.setValue("MapServiceIds",r),e.completeActivity()},e.handleSetMapExtent=function(e){var t=e.getValue("Extent");if(null==t)throw new Error("Set Map Extent: required Extent argument was not supplied.");var r=e.getEsriMap();if(null==r)throw new Error("Set Map Extent: No map available.");t.spatialReference&&(t.spatialReference.wkid||t.spatialReference.wkt)||(t.spatialReference=r.spatialReference);var i=e.getSite();i&&i.essentialsMap?i.essentialsMap.extentManager.setExtentWithPriority(t,10):r.setExtent(t),e.completeActivity()},e.handleCaptureGeometry=function(e){function t(t,i,n){n.deactivate(),dojo.disconnect(i),r.setDrawObjectContext(null),e.setValue("Result",t),e.completeActivity()}var r=e.dispatcher();if(!r.abortMapBasedActivity())throw new Error("Could not deactivate current map based activity.");var i=e.getValue("CaptureType"),n=e.getEsriMap();if(null==n)throw new Error("Capture Geometry: No map available.");if("function"!=typeof esri.toolbars.Draw)throw new Error('dojo.require("esri.toolbars.draw") must be added to your client code to use CaptureGeometry activity.');var a=new esri.toolbars.Draw(n),o=dojo.connect(a,"onDrawEnd",dojo.hitch(o,function(e){t(e,o,a)})),l=!0,s=function(e){var r;switch(e){case 0:r=esri.toolbars.Draw.EXTENT;break;case 1:r=esri.toolbars.Draw.FREEHAND_POLYGON;break;case 2:r=esri.toolbars.Draw.FREEHAND_POLYLINE;break;case 3:r=esri.toolbars.Draw.LINE;break;case 4:r=esri.toolbars.Draw.POINT;break;case 5:r=esri.toolbars.Draw.MULTI_POINT;break;case 6:r=esri.toolbars.Draw.POLYGON;break;case 7:r=esri.toolbars.Draw.POLYLINE;break;case 8:t(n.extent,o,a),l=!1;break;default:r=esri.toolbars.Draw.EXTENT}return r}(i);l&&a.activate(s),r.setDrawObjectContext({activityContext:e,toolbar:a,drawEvent:o})},e._pickSupported=function(e,t){if(!e||e.length<=0)return null;if(t)for(var r=t.toUpperCase(),i=0;i<e.length;i++){var n=e[i];if(n&&n.toUpperCase()===r)return e[i]}return e[0]},e.handleIntersectLayers=function(e){var t,r,n,a=[],o=[],l=[],s=[],u=null,c=null,p=null,d=null,f=!1,y=null,h=-1,v=e.getValue("InputLayers");if(v&&v.length>0)for(n=0;n<v.length;n++)(h=v[n].lastIndexOf("\\\\"))>=0&&(v[n]=v[n].substring(h+"\\\\".length));else e.dispatcher().handleError(new Error("Intersect Layers: no input layers provided."),e);for((u=e.getSite())||e.dispatcher().handleError(new Error("Intersect Layers: no site available."),e),(c=u.essentialsMap)||e.dispatcher().handleError(new Error("Intersect Layers: no map available."),e),(!c.mapServices||c.mapServices.length<=0)&&e.dispatcher().handleError(new Error("Intersect Layers: no map service is configured for the map."),e),t=0;t<c.mapServices.length;t++){p=c.mapServices[t].layers,y=[];var g=v.length,w="";for(p.forEach(function(e){w=e.name;for(var t=0;t<g;++t)if(w===v[t]){y.push(e);break}}),r=0;r<y.length;r++){switch(d=y[r],f=!1,d.type){case i.LayerType.FEATURE_LAYER:o.push(d.name),f=!0;break;case i.LayerType.GROUP_LAYER:l.push(d.name),f=!0;break;case i.LayerType.RASTER_LAYER:s.push(d.name),f=!0}f&&a.push(d.name)}}e.setValue("OutputLayers",a),e.setValue("FeatureLayers",o),e.setValue("GroupLayers",l),e.setValue("RasterLayers",s),e.completeActivity()},e.handleExportMap=function(t){var r=t.getValue("TargetSpatialReference"),i=t.getValue("CustomExtent"),l=t.getValue("Resolution"),s=t.getValue("OutputFormat"),u=t.getValue("Scale"),c=t.getValue("ImageHeight"),p=t.getValue("ImageWidth"),d=t.getValue("UseTransparentBackground"),f=null,y=null,h=null,v=null;(f=t.getSite())||t.dispatcher().handleError(new Error("Export Map: no site available."),t),(y=f.getMap())||t.dispatcher().handleError(new Error("Export Map: no map available."),t),(h=f.essentialsMap)||t.dispatcher().handleError(new Error("Export Map: no map available."),t),(v=new n.ReportParameters).outputFormat=e._pickSupported(h.supportedExportFormats,s),l&&(v.resolution=new a.Resolution("",l)),u&&(v.scale=new o.Scale("",u)),v.imageHeight=c||y.height,v.imageWidth=p||y.width,i&&(v.customExtent=i),v.extentType=i?n.ReportParameters.CUSTOM_EXTENT:n.ReportParameters.CURRENT_EXTENT,v.useTransparentBackground=d,r&&(v.targetSpatialReference=r),y&&v.populateMapGraphicsLayers(y),h.exportMap(v,function(e){var r=e?e.href:null;t.setValue("ResultUrl",r),t.completeActivity()},function(e){t.dispatcher().handleError(new Error("Error exporting map '"+e.message+"'"),t)})},e.handlePrintMap=function(t){var r=t.getValue("TargetSpatialReference"),i=t.getValue("TextFields"),s=t.getValue("CustomExtent"),u=t.getValue("NotificationEmailAddress"),c=t.getValue("Resolution"),p=t.getValue("OutputFormat"),d=t.getValue("Scale"),f=t.getValue("PrintTemplateId"),y=t.getValue("GridId"),h=null;(h=t.getSite())||t.dispatcher().handleError(new Error("Print Map: no site available."),t),h.getMap()||t.dispatcher().handleError(new Error("Print Map: no map available."),t);var v=h.findPrintTemplateById(f);v||t.dispatcher().handleError(new Error("Print Map: unable to find print template '"+f+"'."),t),v.isPrinting()&&t.dispatcher().handleError(new Error("Print Map: unable to perform print operation because print template '"+f+"' is busy."),t);var g=new n.ReportParameters;if(g.outputFormat=e._pickSupported(v.supportedOutputFormats,p),c&&(g.resolution=new a.Resolution("",c)),d&&(g.scale=new o.Scale("",d)),u&&(g.notificationEmailAddress=u),s&&(g.customExtent=s),g.extentType=s?n.ReportParameters.CUSTOM_EXTENT:n.ReportParameters.CURRENT_EXTENT,r&&(g.targetSpatialReference=r),v.textFields&&v.textFields.length>0&&i)for(var w=0;w<i.length;w++)if(i[w])for(var m=0;m<v.textFields.length;m++)if(i[w].Key===v.textFields[m].displayName){var S=new l.TextField(v.textFields[m].id,"",i[w].Value,!1);g.fields.push(S)}if(y){var E=dojo.filter(v.grids,function(e){return e.id==y});E.length>0&&(g.grid=E[0])}v.print(g,function(e){var r=e?e.href:null;t.setValue("ResultUrl",r),t.completeActivity()},function(e){t.dispatcher().handleError(new Error("Error printing map '"+e.message+"'"),t)})}}(t.MapActivityHandlers||(t.MapActivityHandlers={}))})},"geocortex/workflow/MapServiceActivityHandlers":function(){define(["require","exports","./../essentials/utilities/SiteResourceIdComparer"],function(e,t,r){"use strict";function i(e,t){return t&&e&&e.essentialsMap&&e.essentialsMap.mapServices?r.SiteResourceIdComparer.lookUp(e.essentialsMap.mapServices,t):null}function n(e,t){if(!e||!t)return null;if(null!=e.layerIds)for(i=0;i<e.layerIds.length;i++)if(null!=(n=e.getLayer(e.layerIds[i]))&&r.SiteResourceIdComparer.equals(n.id,t))return n;if(null!=e.graphicsLayerIds)for(var i=0;i<e.graphicsLayerIds.length;i++){var n=e.getLayer(e.graphicsLayerIds[i]);if(null!=n&&r.SiteResourceIdComparer.equals(n.id,t))return n}return null}Object.defineProperty(t,"__esModule",{value:!0}),t.findMapServiceById=i,t.findMapServiceByMap=n,t.handleRemoveMapService=function(e){var t=e.getValue("MapServiceId"),r=e.getEsriMap();if(null==r)throw new Error("Remove Map Service: No map available.");var i=n(r,t);if(i){r.removeLayer(i);var a=e.getSite();a&&a.essentialsMap&&a.essentialsMap.mapServices&&a.essentialsMap.removeServiceLayer(i)}e.completeActivity()},t.handleSetImageServiceInfo=function(t){var r=t.getValue("ImageServiceId"),i=t.getValue("BandIds"),a=t.getValue("MosaicRule"),o=t.getValue("RenderingRule"),l=t.getEsriMap();if(null==l)throw new Error("Set Image Service Info: No map available.");e(["esri/layers/RasterFunction"],function(e){var s=n(l,r);if(s instanceof esri.layers.ArcGISImageServiceLayer){var u=s;if(i&&u.setBandIds(i,!0),a){var c=new esri.layers.MosaicRule(a);c.method||(c=u.defaultMosaicRule),u.setMosaicRule(c,!0)}if(o){var p=new esri.layers.RasterFunction(o);p.functionName||(p=null),u.setRenderingRule(p,!0)}u.refresh()}t.completeActivity()})},t.handleSetMapServiceVisibility=function(e){var t=e.getValue("MapServiceId"),r=e.getValue("Visible");if(null==t)throw new Error("Set Map Service Visibility: required MapServiceId argument was not supplied.");if(null==r)throw new Error("Set Map Service Visibility: required Visible argument was not supplied.");var a=e.getEsriMap(),o=e.getSite();if(null==a)throw new Error("Set Map Service Visibility: No map available.");var l=null;if(null==(l=n(a,t)))throw new Error("Set Map Service Visibility: Unable to find map service with ID '"+t+"'");if(l.setVisibility(r),e.completeActivity(),o&&t){var s=i(o,t);dojo.publish("MapServiceVisibilityChangedEvent",s)}},t.handleGetMapServiceInfo=function(e){if(!e)throw new Error("Get Map Service Info: required context was not supplied.");var t=e.getValue("MapServiceId"),r=e.getValue("LayerName");if(null==t)throw new Error("Get Map Service Info: required MapServiceId argument was not supplied.");var a=null,o=null,l=null,s=null,u=!1,c=e.getEsriMap();if(null==c)throw new Error("Get Map Service Info: No map available.");var p=e.getSite(),d=null,f=null;if(null!=p&&null!=p.essentialsMap&&null!=(f=i(p,t))&&(d=f.serviceLayer,a=f.serviceUrl,o=f.findServiceToken(),u=f.isVisible()),null==d&&(d=n(c,t))&&(a=d.url,"boolean"==typeof d.visible&&(u=d.visible)),null!=r){var y=!1;if(d.supportsDynamicLayers&&d.dynamicLayerInfos)for(var h=d.dynamicLayerInfos,v=0;v<h.length;v++)if((g=h[v]).name===r||"{0}".format(g.id)===r){y=!0,l="dynamicLayer",s=g.source;break}if(!y&&d.layerInfos)for(var h=d.layerInfos,v=0;v<h.length;v++){var g=h[v];if(null!=g&&null!=g.id&&g.name==r){y=!0,l=g.id;break}}if(!y&&f){var w=f.findLayerOrTableByName(r);w&&(y=!0,l=w.id)}}e.setValue("MapServiceUrl",a),e.setValue("Token",o),e.setValue("LayerId",l),e.setValue("Source",s),e.setValue("Visible",u),e.completeActivity()},t.handleSetMapServiceProperty=function(e){var t="Set Map Service Property",r=e.getValue("MapServiceId"),i=e.getValue("PropertyName"),a=e.getValue("Value");if(!r)throw new Error("{0}: required MapServiceId argument was not supplied.".format(t));if(!i)throw new Error("{0}: required PropertyName argument was not supplied.".format(t));var o=e.getEsriMap();if(!o)throw new Error("{0}: no map available.".format(t));var l=n(o,r);if(!l)throw new Error("{0}: unable to find map service with ID '{1}'.".format(t,r));if("gdbversion"===i.toLowerCase())if(l instanceof esri.layers.FeatureLayer){if(!l.isDataVersioned)throw new Error("{0}: map service with ID '{1}' is not versioned.".format(t,r));l.setGDBVersion(a)}else{if(!(l instanceof esri.layers.ArcGISDynamicMapServiceLayer))throw new Error("{0}: map service with ID '{1}' does not support GDB version.".format(t,r));l.setGDBVersion(a)}else if("visible"===i.toLowerCase())l.setVisibility(a);else{i="set"+i.toLowerCase();var s=null;for(var u in l)if(u.toLowerCase()===i){s=u;break}if(!s)throw new Error("{0}: map service property '{1}' does not exist.".format(t,i));l[s](a)}e.completeActivity()}})},"geocortex/workflow/NativeActivityHandlers":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleGetCurrentPosition=function(e){var t=e.getValue("UseMultipleReadings"),r=e.getValue("AccuracyThreshold")||10,i={enableHighAccuracy:e.getValue("EnableHighAccuracy"),timeout:e.getValue("Timeout")||2e4,maximumAge:e.getValue("MaximumAge")},n=function(t){e.setValue("ErrorCode",t.code),e.setValue("ErrorMessage",t.message),e.completeActivity()},a=function(t){t?(e.setValue("Latitude",t.coords.latitude),e.setValue("Longitude",t.coords.longitude),e.setValue("Altitude",t.coords.altitude),e.setValue("Accuracy",t.coords.accuracy),e.setValue("AltitudeAccuracy",t.coords.altitudeAccuracy),e.setValue("Heading",t.coords.heading),e.setValue("Speed",t.coords.speed),e.setValue("Timestamp",t.timestamp),e.completeActivity()):n({code:3,message:"A geolocated position could not be obtained before the timeout."})};if(navigator.geolocation)if(t){var o,l,s,u=function(){o&&navigator.geolocation.clearWatch(o),l&&clearTimeout(l),a(s)};l=setTimeout(function(){u()},i.timeout),o=navigator.geolocation.watchPosition(function(e){(!s||e.coords.accuracy<=r)&&(s=e),s.coords.accuracy<=r&&(clearTimeout(l),navigator.geolocation.clearWatch(o))},function(e){n(e)},i)}else navigator.geolocation.getCurrentPosition(function(e){a(e)},function(e){n(e)},i);else n({code:2,message:"Geolocation is not supported."})},t.handleGetPhoto=function(e){if(!navigator.camera)return e.setValue("Message","camera is not supported."),void e.completeActivity();var t={quality:e.getValue("Quality"),destinationType:e.getValue("DestinationType"),sourceType:e.getValue("SourceType"),allowEdit:e.getValue("AllowEdit"),encodingType:e.getValue("EncodingType"),targetWidth:e.getValue("TargetWidth"),targetHeight:e.getValue("TargetHeight")};navigator.camera.getPicture(function(t){e.setValue("ImageData",t),e.completeActivity()},function(t){e.setValue("Message",t),e.completeActivity()},t)}})},"geocortex/workflow/SimpleActivityDispatcher":function(){define(["require","exports","./DefaultActivityDispatcher"],function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t,i,n,a,o,l,s){this._defaultActivityDispatcher=new r.DefaultActivityDispatcher,this._drawObjectContext=null,this.isBusy=null,this._dispatchFunction=e||null,this._handleErrorFunction=t||null,this._activityBeginFunction=i||null,this._activityCompleteFunction=n||null,this._workflowCompleteFunction=a||null,this._workflowAbortFunction=o||null,this._webRequestBeginFunction=l||null,this._webRequestCompleteFunction=s||null}return e.prototype.dispatch=function(e){this._defaultActivityDispatcher.canHandleActivity(e)?this._defaultActivityDispatcher.dispatch(e):null!=this._dispatchFunction&&this._dispatchFunction(e)},e.prototype.handleError=function(e,t){null!=this._handleErrorFunction&&this._handleErrorFunction(e,t)},e.prototype.abortMapBasedActivity=function(){if(this._drawObjectContext){if(!this._drawObjectContext.toolbar||!this._drawObjectContext.drawEvent||!this._drawObjectContext.activityContext)return!1;this._drawObjectContext.toolbar.deactivate(),dojo.disconnect(this._drawObjectContext.drawEvent),this._drawObjectContext.activityContext.abortActivity(),this._drawObjectContext=null}return!0},e.prototype.setDrawObjectContext=function(e){this._drawObjectContext=e},e.prototype.activityBegin=function(e){null!=this._activityBeginFunction&&this._activityBeginFunction(e)},e.prototype.activityComplete=function(e){null!=this._activityCompleteFunction&&this._activityCompleteFunction(e)},e.prototype.activityAbort=function(e){this.workflowAbort(e,e.workflow())},e.prototype.webRequestBegin=function(e,t){null!=this._webRequestBeginFunction&&this._webRequestBeginFunction(e,t)},e.prototype.webRequestComplete=function(e,t){null!=this._webRequestCompleteFunction&&this._webRequestCompleteFunction(e,t)},e.prototype.workflowComplete=function(e,t){null!=this._workflowCompleteFunction&&this._workflowCompleteFunction(e,t)},e.prototype.workflowAbort=function(e,t){null!=this._workflowAbortFunction&&this._workflowAbortFunction(e,t)},e.prototype.handleOpenReportUrl=function(e,t){window.open(e)},e}();t.SimpleActivityDispatcher=i})},"geocortex/workflow/WorkflowControllerProxy":function(){define(["require","exports","./WorkflowState","./ActivityContext","./../geocortex","./DefaultActivityHandlers","./ExternalActivityInfo","./ArgumentInfo"],function(e,t,r,i,n,a,o,l){"use strict";function s(e,t,r,i,a){var o={};if(null==e){var l=new Error("workflow cannot be null");if(null!=t)return void t.handleError(l,null);throw l}var s=e.url+"/run";if(i&&(p(i),o.inargs=JSON.stringify(i)),null!=r){for(var c=r.pendingExternalActivities,d=0;d<c.length;d++)p(c[d].outputs);o.workflow=JSON.stringify(r)}o=n.encodeJson(dojo.mixin({f:"json"},o)),null!=t&&(t.isBusy=!0),t.webRequestBegin(s,e),n.request({url:s,content:o,load:dojo.hitch(this,function(r){t.webRequestComplete(s,e),u(r,e,t)}),error:dojo.hitch(this,function(e){if(null==t)throw e;t.isBusy=!1,t.handleError(e,a)}),callbackParamName:"CallBack"},{usePost:!0})}function u(e,t,n){if(null!=n&&(n.isBusy=!1),e)if(e.error){var o=new Error("Error running workflow: "+e.error.message);c(n,o)}else{var l=new r.WorkflowState(e.instanceId,e.status,f(e.pendingExternalActivities),y(e.outputs),e.workflowData,e.instanceData);if("Completed"==l.status)null!=n&&n.workflowComplete(l.outputs,t);else if("WaitingForExternalActivities"==l.status){var s=l.pendingExternalActivities;if(null!=s)for(var u=0;u<s.length;u++){var d=new i.ActivityContext(n,u,t,l);null!=n&&n.activityBegin(d);var v=s[u];p(v.inputs);try{"debugger"===d.getActivityExternalId()||v&&v.debug?a.showDebug(d,!0,function(){h(d)}):h(d)}catch(o){c(n,o,d)}}}}}function c(e,t,r){if(null==e)throw t;e.handleError(t,r||null)}function p(e){if(null!=e)for(var t=0;t<e.length;t++){var r=function(e){var t=e,r=e.indexOf(",");return r>0&&(t=e.substring(0,r)),t},i=r(e[t].runtimeTypeName);if(e[t].value=d(e[t].value,i),null==e[t].value){var n=r(e[t].typeName);e[t].value=d(e[t].value,n)}}}function d(e,t){var r=e;switch(t){case"ESRI.ArcGIS.Client.Tasks.FeatureSet":var i=e;if(null!=i){var n=new esri.tasks.FeatureSet(i);n.features=n.features||[],r=n}break;case"ESRI.ArcGIS.Client.Geometry.Geometry":case"ESRI.ArcGIS.Client.Geometry.Envelope":case"ESRI.ArcGIS.Client.Geometry.MapPoint":case"ESRI.ArcGIS.Client.Geometry.MultiPoint":case"ESRI.ArcGIS.Client.Geometry.Polygon":case"ESRI.ArcGIS.Client.Geometry.Polyline":var a=e;if(null!=a){var o=esri.geometry.fromJson(a);o&&o.spatialReference&&!a.spatialReference&&(o.spatialReference=null),r=o}break;case"ESRI.ArcGIS.Client.Geometry.SpatialReference":var l=e;null!=l&&(r=new esri.SpatialReference(l));break;case"ESRI.ArcGIS.Client.LayerMapSource":(s=e)&&(r=new esri.layers.LayerMapSource(s));break;case"ESRI.ArcGIS.Client.LayerDataSource":var s=e;s&&(r=new esri.layers.LayerDataSource(s));break;case"ESRI.ArcGIS.Client.TimeExtent":if(e instanceof Array){var u=e;if(u.length>0){var c=new Date(u[0]),p=u.length>1?new Date(u[1]):c;r=new esri.TimeExtent(c,p)}}break;case"ESRI.ArcGIS.Client.Graphic":e&&(r=e.toJson());break;case"System.DateTime":e instanceof Date&&(r="/Date("+e.getTime()+")/")}return r}function f(e){var t=[];if(null!=e)for(var r=0;r<e.length;r++){var i=e[r],n=new o.ExternalActivityInfo;n._configureObject(i),t[r]=n}return t}function y(e){var t=[];if(null!=e)for(var r=0;r<e.length;r++){var i=e[r],n=new l.ArgumentInfo;n._configureObject(i),t[r]=n}return t}function h(e){if(null==e.dispatcher())throw new Error("Unhandled activity: "+e.getActivityTypeName());e.dispatcher().dispatch(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.startWorkflow=function(e,t,r){s(e,t,null,r,null)},t._executeWorkflow=s,t._processWorkflowResults=u,t._handleErrorInternal=c,t._preProcessArguments=p,t._getObjectFromJsonWithType=d,t._getExternalActivities=f,t._getArguments=y,t._dispatch=h})},"geocortex/workflow/WorkflowState":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(e,t,r,i,n,a){this.instanceId=e,this.status=t,this.pendingExternalActivities=r,this.outputs=i,this.workflowData=n,this.instanceData=a};t.WorkflowState=r})}}});require({cache:{"geocortex/workflow":function(){}}});