/*
	
	Copyright (c) 2016, Latitude Geographics Group Ltd.
	All rights reserved.
	       
	Redistribution is not permitted. 
	
	Use in binary form, without modification, is permitted provided that neither 
	the name of the organization nor the names of its contributors may be used 
	to endorse or promote products derived from this software without specific 
	prior written permission.
	       
	THIS SOFTWARE IS PROVIDED BY COPYRIGHT HOLDER ''AS IS'' AND ANY
	EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
	WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
	DISCLAIMED. IN NO EVENT SHALL LATITUDE GEOGRAPHICS GROUP LTD. BE LIABLE FOR ANY
	DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
	(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
	LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
	ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
	(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
	SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
*/

var __extends=this&&this.__extends||function(c,h){function f(){this.constructor=c}for(var d in h)h.hasOwnProperty(d)&&(c[d]=h[d]);c.prototype=null===h?Object.create(h):(f.prototype=h.prototype,new f)},geocortex;
(function(c){(function(h){var f=function(){function d(b){this.initializationFailure=null;this.isInitialized=!1;this.onInitialized=this.onInitializationFailed=null;this._initializing=!1;this.url=b;this._initializedHandler=dojo.hitch(this,this._initializedHandler);this._initializationFailedHandler=dojo.hitch(this,this._initializationFailedHandler);this._restLoadHandler=dojo.hitch(this,this._restLoadHandler);this._restErrorHandler=dojo.hitch(this,this._restErrorHandler)}d.prototype.initialize=function(b){if(!this.isInitialized&&
!this._initializing){var a=void 0!==b&&null!==b;if(a)this._restLoadHandler(!0,b);else{if(!this.url)throw Error("Unable to initialize AsyncInitializable without a valid URL.");this._initializing=!0;c.request({url:this.url,content:{f:"json"},load:dojo.hitch(this,this._restLoadHandler,a),error:this._restErrorHandler,callbackParamName:"CallBack"})}}};d.prototype.doWhenInitialized=function(b,a){1===arguments.length&&(a=b,b=this);if(this.isInitialized)a.call(b,this);else var g=dojo.connect(this,"onInitialized",
this,function(){dojo.disconnect(g);a.apply(b,arguments)})};d.prototype._configureObject=function(b,a){};d.prototype._initializationFailedHandler=function(b){this.initializationFailure=b;if(this.onInitializationFailed)this.onInitializationFailed(b)};d.prototype._initializedHandler=function(b){this.isInitialized=!0;if(this.onInitialized)this.onInitialized(b);this._initializing=!1};d.prototype._restErrorHandler=function(b){this._initializationFailedHandler(b);this._initializedHandler(this)};d.prototype._restLoadHandler=
function(b,a){this._configureObject(a,b);this._initializedHandler(this)};return d}();h.AsyncInitializable=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(c){(function(c){var d=function(){function b(a){this.originalUri=a;this.schemeHostAndPath=a.match(/[^?|^#]*/)[0];var g=a.match(/\?([^#]*)/);this.query={};g&&1<g.length&&(this.query=dojo.queryToObject(g[1]));this.fragment=dojo.queryToObject(0<=a.indexOf("#")?a.substring(a.indexOf("#")+1,a.length):"")}b.prototype.recompose=function(){var a=this.schemeHostAndPath;this.query&&this.anyProperties(this.query)&&(a+="?"+dojo.objectToQuery(this.query));this.fragment&&this.anyProperties(this.fragment)&&
(a+="#"+dojo.objectToQuery(this.fragment));return a};b.prototype.anyProperties=function(a){for(var g in a)return!0;return!1};b.getHost=function(a){if(!a)return null;a=a.match(/^http[s]?:\/\/([^\/]*)/);return 1<a.length?a[1]:null};b.appendToPath=function(a,g){var n=new b(a);n.schemeHostAndPath+=g;return n.recompose()};b.removeQueryParameters=function(a){for(var g=[],n=1;n<arguments.length;n++)g[n-1]=arguments[n];for(var n=new b(a),k=0;k<g.length;k++)delete n.query[g[k]];return n.recompose()};return b}();
c.DecomposedUri=d})(c.utilities||(c.utilities={}))})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(c){(function(c){var d=function(){function b(){}b.endsWith=function(a,g){return-1!==a.indexOf(g,a.length-g.length)};b.replaceLayerTokens=function(a,g){if(g)switch(a.toLowerCase()){case "layerid":return g.id;case "layername":return g.name;case "layerdisplayname":return g.displayName;case "layerdescription":return g.description}return""};b.replaceMapServicetokens=function(a,g){if(g)switch(a.toLowerCase()){case "mapserviceid":return g.id;case "mapservicedisplayname":return g.displayName;
case "mapserviceurl":return g.url;case "mapservicetoken":return g.serviceToken}return""};b.getDateFromRestDateString=function(a){a=a.trim();var g=/^\/Date\(-?\d+\)\/$/;if(!a||!g.test(a))return null;a=a.substring(a.indexOf("(")+1,a.indexOf(")"));return isNaN(a)?null:new Date(parseInt(a,10))};return b}();c.StringUtilities=d;"function"!==typeof String.prototype.endsWith&&(String.prototype.endsWith=function(b){return d.endsWith(this,b)})})(c.utilities||(c.utilities={}))})(c.essentials||(c.essentials=
{}))})(geocortex||(geocortex={}));(function(c){(function(c){var f=function(){return function(){}}();c.TokenResult=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(c){var f=function(){function b(){}b.getTokenFromImplicitGrant=function(){var a=window.location.href;if(0<a.indexOf("#")){var a=a.substring(a.indexOf("#")+1,a.length),g=dojo.queryToObject(a);if(!g.access_token)return null;a=new c.TokenResult;a.token=g.access_token;a.userName=g.username;if(g=parseInt(g.expires_in))a.expiresOn=new Date((new Date).getTime()+1E3*g);return a}return null};b.getErrorFromImplicitGrant=function(){var a=window.location.href;if(0<a.indexOf("#")&&(a=a.substring(a.indexOf("#")+
1,a.length),a=dojo.queryToObject(a),a.error)){var g=new d;g.code=a.error;g.description=a.error_description;return g}return null};b.applicationHasImplicitGrant=function(){return b.hasFragmentParameter("access_token")};b.applicationHasImplicitGrantError=function(){return b.hasFragmentParameter("error")};b.hasFragmentParameter=function(a){var g=window.location.href;if(0>g.indexOf("#"))return!1;g=window.location.href;g=g.substring(g.indexOf("#")+1,g.length);return!!dojo.queryToObject(g)[a]};b.redirectToLogOnPage=
function(a,g){var n=new c.utilities.DecomposedUri(window.location.href);b.removeImplicitGrantParams(n);n=a+"?client_id="+encodeURIComponent(g)+"&response_type=token&redirect_uri="+encodeURIComponent(n.recompose())+"&expiration=20160";window.location.href=n};b.removeImplicitGrantParamsAndUpdateUrlHash=function(){var a=new c.utilities.DecomposedUri(window.location.href);b.removeImplicitGrantParams(a);window.location.hash=dojo.objectToQuery(a.fragment)};b.removeImplicitGrantParams=function(a){delete a.fragment.access_token;
delete a.fragment.username;delete a.fragment.expires_in;delete a.fragment.error;delete a.fragment.error_description;return a};return b}();c.OAuth2Client=f;var d=function(){function b(){}b.ACCESS_DENIED_ERROR_CODE="access_denied";return b}();c.OAuth2Error=d})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(c){var f=function(){function d(b,a,g){this.baseUrl=b;this.domains=a;this.clientId=g}d.prototype.initiate=function(){this.tokenResult||(this.tokenResult=c.OAuth2Client.getTokenFromImplicitGrant());if(!this.tokenResult)return(this.error=c.OAuth2Client.getErrorFromImplicitGrant())||c.OAuth2Client.redirectToLogOnPage(this.getLogOnUrl(),this.clientId),c.OAuth2Client.removeImplicitGrantParamsAndUpdateUrlHash(),!1;c.OAuth2Client.removeImplicitGrantParamsAndUpdateUrlHash();return!0};
d.prototype.getLogOnUrl=function(){return this.baseUrl+"oauth2/authorize"};d.prototype.getToken=function(b){return this.tokenResult&&b?this.appliesTo(b)?this.tokenResult.token:null:null};d.prototype.appliesTo=function(b){b=c.utilities.DecomposedUri.getHost(b);for(var a=0;a<this.domains.length;a++)if(c.utilities.StringUtilities.endsWith(b,this.domains[a]))return!0;return!1};return d}();c.ArcGisPortalSecurityContext=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(c){var f=function(){return function(c){this.essentialsMap=this.displayName=null;this.extensions=[];this.exportTilesMapServiceUri=this.iconUri=this.id=null;this.properties={};this.services=[];if(!c)throw Error("Essentials map is required for a basemap.");this.essentialsMap=c}}();c.BaseMap=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(c){var f=function(){return function(c){this.mapService=null;if(!c)throw Error("Map service is required for a basemap service.");this.mapService=c}}();c.BaseMapService=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(h){(function(f){var d=function(){function b(a,g){this.isRequired=new Observable(!1);this.isValid=new Observable(!0);this.isVisible=new Observable(!0);this.argumentName=null;this.validationItems=[];this.formDefinition=g||null;this.attached_indicatorClass=new Observable("");this.attached_showIndicator=new Observable("");if(a){this.toolTip=new Observable(c.forms.getElementText(a,"ToolTip"));this.itemID=new Observable(c.forms.getElementText(a,"ItemID"));this.argumentName=new Observable(c.forms.getElementText(a,
"ArgumentName"));var b=c.forms.getElementText(a,"IsVisible");b&&this.isVisible.set(c.forms._parseBoolean(b));b=c.forms.getElement(a,"ValidationItems");if(null!=b)for(var k=0;k<b.childNodes.length;k++){var d=c.forms.items._processValidationItem(b.childNodes[k]);d instanceof c.forms.items.validation.RequiredValidationItem&&this.isRequired.set(!0);null!=d&&this.validationItems.push(d)}}else this.toolTip=new Observable(""),this.itemID=new Observable(null),this.argumentName=new Observable(null)}b.prototype.getResult=
function(){return null};b.prototype._notifyResultChanged=function(){dojo.publish("FormItemResultChangedEvent",[this])};b.prototype.refresh=function(){};b.prototype.validate=function(){var a=[];this.isValid.set(!0);if(null!=this.validationItems)for(var g=0;g<this.validationItems.length;g++){var b=this.getResult();null!=b&&(b=b.value);b=this.validationItems[g].validate(b);b.isValid||(this.isValid.set(!1),a.push(b))}return a};b.prototype._render=function(){return document.createTextNode(this.itemID.get())};
b.prototype._destroy=function(){};return b}();f.AbstractFormItem=d})(h.items||(h.items={}))})(c.forms||(c.forms={}))})(geocortex||(geocortex={}));
(function(c){(function(h){(function(f){var d=function(b){function a(a,n){b.call(this,a,n);this.formItemType="LabelFormItem";a?(this.text=new Observable(c.forms.getElementText(a,"Text")),this.labelForItemID=new Observable(c.forms.getElementText(a,"LabelForItemID"))):(this.text=new Observable(null),this.labelForItemID=new Observable(null))}__extends(a,b);a.prototype._render=function(){return c.forms.renderFormItem(this)};return a}(f.AbstractFormItem);f.LabelFormItem=d})(h.items||(h.items={}))})(c.forms||
(c.forms={}))})(geocortex||(geocortex={}));(function(c){(function(h){(function(f){f.initLabelContainer=function(d,b,a){b?(d.label=new f.LabelFormItem(c.forms.getElement(b,"Label")),""==d.label.toolTip.get()&&null!=d.toolTip&&d.label.toolTip.set(d.toolTip.get())):d.label=new c.forms.items.LabelFormItem(null)}})(h.items||(h.items={}))})(c.forms||(c.forms={}))})(geocortex||(geocortex={}));
(function(c){(function(c){(function(c){var d=function(){return function(b,a,g){this.isList=!1;this.argumentName=b;this.value=a;this.wasSet=g||!1}}();c.FormItemResult=d})(c.items||(c.items={}))})(c.forms||(c.forms={}))})(geocortex||(geocortex={}));
(function(c){(function(h){(function(f){var d=function(b){function a(a,n){var k=this;b.call(this,a,n);this.formItemType="TextBoxFormItem";if(a){var d=c.forms.getElementText(a,"DefaultText");this.defaultText=new Observable(d);this.text=new Observable(d);this.inputScope=new Observable(c.forms.getElementText(a,"InputScope"));this.textboxWidth=new Observable(parseInt(c.forms.getElementText(a,"TextboxWidth")));this.readOnly=new Observable(c.forms._parseBoolean(c.forms.getElementText(a,"ReadOnly")))}else this.defaultText=
new Observable(""),this.text=new Observable(""),this.inputScope=new Observable("Default"),this.textboxWidth=new Observable(NaN),this.readOnly=new Observable(!1);f.initLabelContainer(this,a,n);this.text.bind(null,function(a){return k._notifyResultChanged()})}__extends(a,b);a.prototype.getResult=function(){return new f.FormItemResult(this.argumentName.get(),this.text.get())};a.prototype._render=function(){return c.forms.renderFormItem(this)};return a}(f.AbstractFormItem);f.TextBoxFormItem=d})(h.items||
(h.items={}))})(c.forms||(c.forms={}))})(geocortex||(geocortex={}));(function(c){(function(h){(function(f){var d=function(b){function a(a,n){b.call(this,a,n);this.formItemType="TextAreaFormItem";this.textboxHeight=a?new Observable(parseInt(c.forms.getElementText(a,"TextboxHeight"))):new Observable(1)}__extends(a,b);return a}(f.TextBoxFormItem);f.TextAreaFormItem=d})(h.items||(h.items={}))})(c.forms||(c.forms={}))})(geocortex||(geocortex={}));
(function(c){(function(c){var f=function(){return function(c,b){this.className=c;this.instance=b}}();c.Extension=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(h){var f=function(){function d(b,a,g,n){var k=this;this._timer=null;this.userName=this._endpointUrl=this._siteId="";this._extentConnect=null;this._numConsecutiveFailures=0;this._enabled=!0;this._sessionId="";this._previousScale=-1;this._firstExtentLogged=!1;this._map=b;a&&(this._siteId=a);this._endpointUrl=g?g:window.location.protocol+"//"+window.location.host+"/Geocortex/Optimizer/Rest/DataRelay/LogData.ashx?f=json";n&&(this.userName=n);this._pendingEvents=[];this._timer=new c.framework.utils.TimeDelayedAction(3E3,
this._flushQueue,this);var d={};d.extent=this._map.extent;if(b.loaded)this._logExtentChange(d),this._extentConnect=b.on("extent-change",dojo.hitch(this,"_logExtentChange"));else b.on("load",function(){k._logExtentChange(d);k._extentConnect=b.on("extent-change",dojo.hitch(k,"_logExtentChange"))});this._sessionId=this._crc32((new Date).getTime()+""+navigator.userAgent)}d.prototype._logExtentChange=function(b){if(this._enabled){var a;a={data:[{name:"ArcGISExtents",columns:{}}]};a.data[0].columns=[{type:"tinyint",
name:"InitialExtent",key:"InitialExtent"},{type:"real",name:"XMinNew",key:"XMinNew"},{type:"real",name:"YMinNew",key:"YMinNew"},{type:"real",name:"XMaxNew",key:"XMaxNew"},{type:"real",name:"YMaxNew",key:"YMaxNew"}];a.data[0].rows=[{InitialExtent:this._firstExtentLogged?0:1,XMinNew:b.extent.xmin,YMinNew:b.extent.ymin,XMaxNew:b.extent.xmax,YMaxNew:b.extent.ymax}];this._queueData(a);this._firstExtentLogged=!0;b.lod?(b.levelChange&&-1<this._previousScale&&this._logScaleChange(this._previousScale,b.lod.scale),
this._previousScale=b.lod.scale):(b=this._map.getScale(),null!==b&&(this._previousScale!=b&&-1<this._previousScale&&this._logScaleChange(this._previousScale,b),this._previousScale=b))}};d.prototype._logScaleChange=function(b,a){if(this._enabled){var g={data:[{name:"ArcGISScale",columns:[]}]};g.data[0].columns=[{type:"float",name:"ScaleOld",key:"ScaleOld"},{type:"float",name:"ScaleNew",key:"ScaleNew"}];g.data[0].rows=[{ScaleOld:b,ScaleNew:a}];this._queueData(g)}};d.prototype.logToolUsage=function(b,
a){if(this._enabled){var g={data:[{name:"ArcGISTool",columns:[]}]};g.data[0].columns=[{type:"ustr",name:"Tool",key:"Tool"},{type:"ustr",name:"ToolData",key:"ToolData"}];g.data[0].rows=[{Tool:b,ToolData:a}];this._queueData(g)}};d.prototype._queueData=function(b){b.platform="js";b.data[0].columns.push({type:"now",name:"SampleTime",key:"SampleTime"},{type:"origin",name:"UserAddress",key:"UserAddress"},{type:"ustr",name:"SiteId",key:"SiteId"},{type:"ustr",name:"UserAgent",key:"UserAgent"},{type:"ustr",
name:"UserName",key:"UserName"},{type:"ustr",name:"LayerList",key:"LayerList"},{type:"int",name:"SessionId",key:"SessionId"},{type:"ustr",name:"ClientType",key:"ClientType"},{type:"host",name:"MachineName",key:"MachineName"});dojo.mixin(b.data[0].rows[0],{SiteId:this._siteId,UserAgent:navigator.userAgent,UserName:this.userName,LayerList:this._getCurrentLayerList(),SessionId:this._sessionId,ClientType:"JavaScript"});this._pendingEvents.push(b);this._timer.reset()};d.prototype._flushQueue=function(){for(this._timer.stop();0<
this._pendingEvents.length;){var b=this._pendingEvents.shift();this._logData(b)}};d.prototype._logData=function(b){try{dojo.xhrPost({url:this._endpointUrl,postData:JSON.stringify(b),timeout:1E4,load:dojo.hitch(this,this._handleLogSuccessResponse),error:dojo.hitch(this,this._handleLogErrorResponse)})}catch(a){this._incrementFailures()}};d.prototype._handleLogSuccessResponse=function(b){this._numConsecutiveFailures=0};d.prototype._handleLogErrorResponse=function(b){this._incrementFailures()};d.prototype._incrementFailures=
function(){this._numConsecutiveFailures++;2<this._numConsecutiveFailures&&(dojo.disconnect(this._extentConnect),this._enabled=!1)};d.prototype._getCurrentLayerList=function(){for(var b="",a=this._map.layerIds,g=0;g<a.length;g++){var n=this._map.getLayer(a[g]);if(null!=n&&n.visible&&n.visibleAtMapScale){var k;if(n instanceof esri.layers.ArcGISDynamicMapServiceLayer){var c=n;for(k=0;k<c.visibleLayers.length;k++)null!=c.visibleLayers[k]&&-1!=c.visibleLayers[k]&&(b+=c.layerInfos.filter(function(a){return a.id==
c.visibleLayers[k]})[0].name+"\\t")}else if(n instanceof esri.virtualearth.VETiledLayer)b+="Bing:"+n.mapStyle+"\\t";else if(n instanceof esri.layers.ArcGISImageServiceLayer)b+="Image:"+n.url+"\\t";else if(n instanceof esri.layers.ArcGISTiledMapServiceLayer)for(k=0;k<n.layerInfos.length;k++)null!=n.layerInfos[k]&&(b+=n.layerInfos[k].name+"\\t")}}3<b.length&&(b=b.substring(0,b.length-2));return b};d.prototype._crc32=function(b){b=b.replace(/\r\n/g,"\n");for(var a="",g=0;g<b.length;g++){var n=b.charCodeAt(g);
128>n?a+=String.fromCharCode(n):(127<n&&2048>n?a+=String.fromCharCode(n>>6|192):(a+=String.fromCharCode(n>>12|224),a+=String.fromCharCode(n>>6&63|128)),a+=String.fromCharCode(n&63|128))}b=a;for(var k,a=-1,g=0,n=b.length;g<n;g++)k=(a^b.charCodeAt(g))&255,k="0x"+"00000000 77073096 EE0E612C 990951BA 076DC419 706AF48F E963A535 9E6495A3 0EDB8832 79DCB8A4 E0D5E91E 97D2D988 09B64C2B 7EB17CBD E7B82D07 90BF1D91 1DB71064 6AB020F2 F3B97148 84BE41DE 1ADAD47D 6DDDE4EB F4D4B551 83D385C7 136C9856 646BA8C0 FD62F97A 8A65C9EC 14015C4F 63066CD9 FA0F3D63 8D080DF5 3B6E20C8 4C69105E D56041E4 A2677172 3C03E4D1 4B04D447 D20D85FD A50AB56B 35B5A8FA 42B2986C DBBBC9D6 ACBCF940 32D86CE3 45DF5C75 DCD60DCF ABD13D59 26D930AC 51DE003A C8D75180 BFD06116 21B4F4B5 56B3C423 CFBA9599 B8BDA50F 2802B89E 5F058808 C60CD9B2 B10BE924 2F6F7C87 58684C11 C1611DAB B6662D3D 76DC4190 01DB7106 98D220BC EFD5102A 71B18589 06B6B51F 9FBFE4A5 E8B8D433 7807C9A2 0F00F934 9609A88E E10E9818 7F6A0DBB 086D3D2D 91646C97 E6635C01 6B6B51F4 1C6C6162 856530D8 F262004E 6C0695ED 1B01A57B 8208F4C1 F50FC457 65B0D9C6 12B7E950 8BBEB8EA FCB9887C 62DD1DDF 15DA2D49 8CD37CF3 FBD44C65 4DB26158 3AB551CE A3BC0074 D4BB30E2 4ADFA541 3DD895D7 A4D1C46D D3D6F4FB 4369E96A 346ED9FC AD678846 DA60B8D0 44042D73 33031DE5 AA0A4C5F DD0D7CC9 5005713C 270241AA BE0B1010 C90C2086 5768B525 206F85B3 B966D409 CE61E49F 5EDEF90E 29D9C998 B0D09822 C7D7A8B4 59B33D17 2EB40D81 B7BD5C3B C0BA6CAD EDB88320 9ABFB3B6 03B6E20C 74B1D29A EAD54739 9DD277AF 04DB2615 73DC1683 E3630B12 94643B84 0D6D6A3E 7A6A5AA8 E40ECF0B 9309FF9D 0A00AE27 7D079EB1 F00F9344 8708A3D2 1E01F268 6906C2FE F762575D 806567CB 196C3671 6E6B06E7 FED41B76 89D32BE0 10DA7A5A 67DD4ACC F9B9DF6F 8EBEEFF9 17B7BE43 60B08ED5 D6D6A3E8 A1D1937E 38D8C2C4 4FDFF252 D1BB67F1 A6BC5767 3FB506DD 48B2364B D80D2BDA AF0A1B4C 36034AF6 41047A60 DF60EFC3 A867DF55 316E8EEF 4669BE79 CB61B38C BC66831A 256FD2A0 5268E236 CC0C7795 BB0B4703 220216B9 5505262F C5BA3BBE B2BD0B28 2BB45A92 5CB36A04 C2D7FFA7 B5D0CF31 2CD99E8B 5BDEAE1D 9B64C2B0 EC63F226 756AA39C 026D930A 9C0906A9 EB0E363F 72076785 05005713 95BF4A82 E2B87A14 7BB12BAE 0CB61B38 92D28E9B E5D5BE0D 7CDCEFB7 0BDBDF21 86D3D2D4 F1D4E242 68DDB3F8 1FDA836E 81BE16CD F6B9265B 6FB077E1 18B74777 88085AE6 FF0F6A70 66063BCA 11010B5C 8F659EFF F862AE69 616BFFD3 166CCF45 A00AE278 D70DD2EE 4E048354 3903B3C2 A7672661 D06016F7 4969474D 3E6E77DB AED16A4A D9D65ADC 40DF0B66 37D83BF0 A9BCAE53 DEBB9EC5 47B2CF7F 30B5FFE9 BDBDF21C CABAC28A 53B39330 24B4A3A6 BAD03605 CDD70693 54DE5729 23D967BF B3667A2E C4614AB8 5D681B02 2A6F2B94 B40BBE37 C30C8EA1 5A05DF1B 2D02EF8D".substr(9*
k,8),a=a>>>8^k;return(a^-1).toString()};return d}();h.EventRelay=f})(c.optimizer||(c.optimizer={}))})(geocortex||(geocortex={}));
(function(c){function h(c){var d,b,a=Array.isArray(c)?[]:{};b=typeof c;if(null!==c&&("number"===b||"boolean"===b||"string"===b))return c;"function"===typeof c.toJson&&(a=c.toJson());for(var g in c)if(!("declaredClass"==g||-1<g.indexOf("_inherited")||void 0!==a[g])&&(d=c[g],b=typeof d,null!==d&&void 0!==d&&"function"!==b))if(Array.isArray(d)){a[g]=[];b=0;for(var n=d.length;b<n;b++)a[g][b]=h(d[b])}else a[g]="object"===b?"function"===typeof d.toJson?d.toJson():h(d):d;return a}c.config={baseUrl:"http://localhost/",
io:{errorHandler:function(c,d){dojo.publish("geocortex.Error",[c])},postLength:2E3,timeout:6E4},REST_version:"3.0",authenticationDialogId:null};c.deferredResolve=function(c,d){c&&-1==c.fired&&c.resolve(d)};c.deferredReject=function(c,d){c&&-1==c.fired&&c.reject(d)};c.encodeJson=function(c){c=h(c);var d={},b;for(b in c)dojo.isArray(c[b])||"object"===typeof c[b]?d[b]=JSON.stringify(c[b]):d[b]=c[b];return d};c.request=function(f,d){d||(d={});d.gcx||(d.gcx={});f.preventCache=void 0===d.gcx.preventCache?
!0:d.gcx.preventCache?!0:!1;f.timeout=f.timeout||c.config.io.timeout;f.handleAs=f.handleAs||"json";var b=c.requiresProxy(f),a=c.hasProxy();if(b&&!a)return b=Error("Cross-domain or large requests require a proxy."),dojo.isFunction(f.error)&&f.error(b),a=new dojo.Deferred,a.errback(b),a;delete f.gcx;d.useProxy=b;d.hasOwnProperty("disableIdentityLookup")||(d.disableIdentityLookup=!0);return(new c.essentials.RestHelperHTTPService(f,d)).send()};c.hasProxy=function(){var c=!1;try{c=esri._getProxyUrl()}catch(d){}return c};
c.requiresProxy=function(f){var d=!1;try{if(require.has("esri-cors")){var b=c.essentials.utilities.UrlUtilities.getUrlComponents(f.url);if(0<=esri.config.defaults.io.corsEnabledServers.indexOf(b.host))return!1}var a=f.url.length;f.content&&(a+=dojo.objectToQuery(f.content).length);var g=new dojo._Url(f.url),n=window.location,k=a>c.config.io.postLength;if(!g.scheme&&!g.host&&!g.port||/\bGeocortexApp\b/.test(navigator.userAgent)&&"https"===g.scheme)return!1;var l=n.protocol+"//"+n.hostname+(n.port?
":"+n.port:"")!==g.scheme+"://"+g.host+(g.port?":"+g.port:""),d=k&&l}catch(m){}return d};c.urlToQueryObject=function(c){var d=c.indexOf("?");return-1===d?null:dojo.queryToObject(c.substring(d+1))};c._getExtensions=function(f){var d=[];if(!f)return d;d.length=f.length;for(var b=0;b<f.length;b++)d[b]=new c.essentials.Extension(f[b].className,f[b].instance);return d};c._extensionsToJson=function(c){return(c||[]).map(function(c){return{className:c.className,instance:c.instance}})};c._getProperties=function(c){var d=
{};if(!c)return d;for(var b=0;b<c.length;b++)d[c[b].name]=c[b].value;return d};c._propertiesToJson=function(c){return c?Object.keys(c).map(function(d){return{name:d,value:c[d]}}):[]}})(geocortex||(geocortex={}));Date.now||(Date.now=function(){return+new Date});
(function(c){(function(c){var f=function(){return function(){this.password=this.messageFromServer=null;this.pendingCalls=[];this.username=this.token=this.targetRootUri=this.tokenRootUri=this.tokenService=null}}();c.AuthenticationControlBlock=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(c){var f=function(){function c(){this._authenticationControlBlocks=[]}c.prototype.add=function(b){null===this.find(b.tokenRootUri)&&this._authenticationControlBlocks.push(b)};c.prototype.remove=function(b){for(var a=0;a<this._authenticationControlBlocks.length;a++)if(this._authenticationControlBlocks[a]===b)return this._authenticationControlBlocks.splice(a,1),!0;return!1};c.prototype.find=function(b){for(var a=0;a<this._authenticationControlBlocks.length;a++){var g=this._authenticationControlBlocks[a],
n=g.tokenRootUri,c=g.targetRootUri;if(0===b.toLowerCase().indexOf(n.toLowerCase())||0===b.toLowerCase().indexOf(c.toLowerCase()))return g}return null};c.prototype.removeAt=function(b){this._authenticationControlBlocks.splice(b,1)};return c}();c.AuthenticationControlBlockStore=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(h){var f=function(){function d(b,a){this._error=this._handle=this.optionsObject=this.requestObject=null;this._deferred=new dojo.Deferred;void 0!==b&&(this.requestObject=b,dojo.isFunction(this.requestObject.error)&&(this._error=this.requestObject.error,this.requestObject.error=null),dojo.isFunction(this.requestObject.handle)&&(this._handle=this.requestObject.handle),this.requestObject.handle=dojo.hitch(this,this._handleProxy));void 0!==a&&(this.optionsObject=a)}d.getTokenForScope=
function(b){var a=this._anchorScratch||(this._anchorScratch=document.createElement("a")),g=this._pathCleaner||(this._pathCleaner=/\/+/g);a.href=b;b=a.hostname.toLowerCase();var n=("/"+a.pathname+"/").replace(g,"/").toLowerCase(),c=void 0,d=this.tokenScopes,m;for(m in d){a.href=m;var f=a.hostname.toLowerCase(),h=("/"+a.pathname+"/").replace(g,"/").toLowerCase();b===f&&n.startsWith(h)&&(c=d[m],c="string"===typeof c?c:!0===c?this.token:void 0)}return c};d.setDefaultToken=function(b,a){"string"===typeof b&&
(this.token=b,this.tokenScopes[a]=!0)};d.getAuthenticationControlBlockStore=function(){return d._controlBlocks};d.prototype._handleProxy=function(b,a){!1===this._isUnauthorizedResponse(b)&&dojo.isFunction(this._handle)&&this._handle(b,a)};d.prototype._requestCallback=function(b){this._deferred.resolve(b)};d.prototype._requestErrback=function(b){this._isUnauthorizedResponse(b)?this._handleUnauthenticated(b):(dojo.isFunction(this._error)&&this._error(b),this._deferred.reject(b))};d.prototype._isUnauthorizedResponse=
function(b){return b&&401===b.code?!0:!1};d.prototype._handleUnauthenticated=function(b){if(b&&b.tokenService){if(!1===c.hasProxy())throw Error("No proxy page is configured - a proxy page is required to access secured Sites");var a=this.requestObject.url,g=b.tokenService,n=c.essentials.RestHelperHTTPService._controlBlocks.find(this.requestObject.url);if(null===n||null!==n.token&&""!==n.token){var k=new dojo._Url(a),g=k.scheme+"://"+k.host+(k.port&&"80"!==k.port?":"+k.port:"")+g;n||(n=new c.essentials.AuthenticationControlBlock);
n.messageFromServer=b.message;null===n.token?(n.tokenService=g,n.tokenRootUri=g.substring(0,g.lastIndexOf("/")),n.targetRootUri=a.substring(0,a.lastIndexOf("/")),n.pendingCalls.push(this),c.essentials.RestHelperHTTPService._controlBlocks.add(n),this._gatherCredentials().then(dojo.hitch(this,function(a){n.username=a.username;n.password=a.password;this._requestToken(n)}))):(n.token=null,n.pendingCalls=[],n.pendingCalls.push(this),this._requestToken(n))}else{b=!1;for(a=0;a<n.pendingCalls.length;a++)if(n.pendingCalls[a]===
this){b=!0;break}!1===b&&n.pendingCalls.push(this)}}else dojo.isFunction(this._error)&&this._error(b),this._deferred.reject(b)};d.prototype._gatherCredentials=function(b){var a;a=void 0===b?new dojo.Deferred:b;if(dijit.Dialog&&dijit.form&&dijit.form.TextBox&&dijit.form.Button){var g=c.essentials.RestHelperHTTPService._controlBlocks.find(this.requestObject.url);b=c.config.authenticationDialogId;var n;b?n=dijit.byId(b):b=c.config.authenticationDialogId="geocortex_authenticationDialog_default";n&&n instanceof
dijit.Dialog||(n=new dijit.Dialog({title:"Authentication Required",id:b,content:this._createAuthDialogContent()}));$(dojo.byId(b+"_message")).text(g.messageFromServer||"");g=dijit.byId(b+"_ok");b=dijit.byId(b+"_cancel");var k,d,m;k=dojo.connect(g,"onClick",function(){dojo.forEach([k,d,m],dojo.disconnect);var g=n.attr("value");a.resolve({username:g.username,password:g.password})});d=dojo.connect(b,"onClick",function(){dojo.forEach([k,d,m],dojo.disconnect);n.hide();a.cancel()});m=dojo.connect(n,"onCancel",
function(){dojo.forEach([k,d,m],dojo.disconnect);a.cancel()});n.show()}else dojo.require("dijit.Dialog"),dojo.require("dijit.form.TextBox"),dojo.require("dijit.form.Button"),dojo.addOnLoad(dojo.hitch(this,function(){this._gatherCredentials(a)}));return a};d.prototype._createAuthDialogContent=function(){var b=c.config.authenticationDialogId,a=new dijit.form.TextBox({name:"username",id:"gcx_auth_username"}),g=new dijit.form.TextBox({type:"password",name:"password",id:"gcx_auth_password"}),n=new dijit.form.Button({label:"OK",
type:"submit",id:b+"_ok"}),k=new dijit.form.Button({label:"Cancel",type:"button",id:b+"_cancel"}),d=dojo.create("div");dojo.create("div",{id:b+"_message"},d);var m=dojo.create("table",null,d),f=dojo.create("tr",null,m),h=dojo.create("tr",null,m),m=dojo.create("tr",null,m);dojo.place("<td><label for='gcx_auth_username'>Username: </label></td>",f);dojo.place("<td><label for='gcx_auth_password'>Password: </label></td>",h);f=dojo.create("td",null,f);h=dojo.create("td",null,h);m=dojo.create("td",{colspan:"2",
align:"center"},m);b=dojo.create("div",{id:b+"_actionbuttoncontainer"},m);a.placeAt(f);g.placeAt(h);n.placeAt(b);k.placeAt(b);return d};d.prototype._requestToken=function(b){esri.request({url:b.tokenService,content:{username:b.username,password:b.password,lifespan:"20",f:"json"},timeout:c.config.io.timeout,handleAs:"json"},{usePost:!0,disableIdentityLookup:!0}).then(dojo.hitch(this,this._onTokenRequestCompleted),dojo.hitch(this,this._onTokenRequestFault))};d.prototype._onTokenRequestFault=function(b){if(this._isUnauthorizedResponse(b)){var a=
c.essentials.RestHelperHTTPService._controlBlocks.find(this.requestObject.url);a.messageFromServer=b.message;this._gatherCredentials().then(dojo.hitch(this,function(g){a.username=g.username;a.password=g.password;this._requestToken(a)}))}else dojo.isFunction(this._error)&&this._error(b),this._deferred.errback(b)};d.prototype._onTokenRequestCompleted=function(b){var a=c.essentials.RestHelperHTTPService._controlBlocks.find(this.requestObject.url);if(b&&b.token)for(a.token=b.token,dojo.publish("geocortex_authenticationSucceeded",
[{username:a.username,token:a.token}]),b=a.pendingCalls.length-1;0<=b;b--){var g=a.pendingCalls[b];a.pendingCalls.pop();g.send()}else c.essentials.RestHelperHTTPService._controlBlocks.remove(a)};d.prototype.send=function(){if(null!==this.requestObject){var b=c.essentials.RestHelperHTTPService._controlBlocks.find(this.requestObject.url);null!==b&&null!==b.token&&(this.requestObject.content||(this.requestObject.content={}),-1===this.requestObject.url.indexOf("token=")&&(this.requestObject.url=this._appendParameter(this.requestObject.url,
"token",b.token)))}else-1!==this.requestObject.url.indexOf("token=")&&(this.requestObject.url=this.requestObject.url.replace("token=","oldtkn="));d.arcGisPortalToken&&(this.requestObject.content.arcGisPortalToken=d.arcGisPortalToken.token);b=d.getTokenForScope(this.requestObject.url);void 0!==b&&(this.requestObject.content.token=b);esri.request(this.requestObject,this.optionsObject).then(dojo.hitch(this,this._requestCallback),dojo.hitch(this,this._requestErrback));return this._deferred.promise};d.prototype._appendParameter=
function(b,a,g){var n=b,n=0<b.indexOf("?")?n+"&":n+"?";return n+=encodeURIComponent(a)+"="+encodeURIComponent(g)};d._controlBlocks=new c.essentials.AuthenticationControlBlockStore;d.tokenScopes={};return d}();h.RestHelperHTTPService=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(c){(function(c){function d(a,b,c){return null==a||null==b?c:a.isWebMercator&&b.isWebMercator&&a.isWebMercator()&&b.isWebMercator()?!0:a.wkid!==b.wkid?!1:0<a.wkid?!0:a.wkt.toLowerCase()==b.wkt.toLowerCase()}function b(a){var b=a.rings[0][0],c=a.rings[0][1],d=null;a=a.rings[0].slice(2,a.rings[0].length);a.push(b);for(var m=0;m<a.length;++m){var f=a[m],b=this.crossProduct(f,b,c);if(0<b&&!0===d||0>b&&!1===d)return!1;d=0<b;b=c;c=f}return!0}function a(a,b,c){c||(c=[0,0]);return(a[0]-
c[0])*(b[1]-c[1])-(a[1]-c[1])*(b[0]-c[0])}c.spatialRefsAreEqual=d;c.envelopesAreEqual=function(a,b){return null==a||null==b?null==a&&null==b:d(a.spatialReference,b.spatialReference)&&a.xmin==b.xmin&&a.ymin==b.ymin&&a.xmax==b.xmax&&a.ymax==b.ymax};c.getExtent=function(a){if(a.length)var b=new esri.geometry.Extent(Number.MAX_VALUE,Number.MAX_VALUE,Number.MIN_VALUE,Number.MIN_VALUE,a[0].spatialReference);for(var c=0;c<a.length;++c){var d=a[c].getExtent();b.xmin=Math.min(d.xmin,b.xmin);b.ymin=Math.min(d.ymin,
b.ymin);b.xmax=Math.min(d.xmax,b.xmax);b.xmax=Math.min(d.ymax,b.ymax)}return b};c.envelopeToPolygon=function(a){var b=new esri.geometry.Polygon(a.spatialReference);b.addRing([[a.xmin,a.ymin],[a.xmin,a.ymax],[a.xmax,a.ymax],[a.xmax,a.ymin],[a.xmin,a.ymin]]);return b};c.isValidGeometry=function(g){if("polygon"!=g.type||0==g.rings.length||3>g.rings.length)return!0;if(b(g)){var n=g.rings[0][0],c=g.rings[0][1];g=g.rings[0].slice(2,g.rings[0].length);g.push(n);for(var d=0;d<g.length;++d){var m=g[d];if(0<
a(n,m,c))return!0;n=c;c=m}return!1}for(c=n=0;c<g.rings.length;++c)for(var m=g.rings[c],f=0,d=0;d<m.length;++d)f=(d+1)%m.length,n+=m[d][0]*-m[f][1],n-=-m[d][1]*m[f][0];return 0<n};c.isSelfIntersectingPolygon=function(a){if(esri.geometry.polygonSelfIntersecting)return esri.geometry.polygonSelfIntersecting(a);if(a.isSelfIntersecting)return a.isSelfIntersecting(a);throw Error("No self intersection method found");};c.isConvex=b;c.pointInEnvelope=function(a,b){if(!this.spatialRefsAreEqual(a.spatialReference,
b.spatialReference,!0))throw Error("Mismatched spatial references.");return a.x<b.xmin||a.x>b.xmax||a.y<b.ymin||a.y>b.ymax?!1:!0};c.clipEnvelope=function(a,b){if(!this.spatialRefsAreEqual(a.spatialReference,b.spatialReference,!0))throw Error("Mismatched spatial references.");var c=new esri.geometry.Extent(a.xmin,a.ymin,a.xmax,a.ymax,a.spatialReference);c.xmin=a.xmin<b.xmin?b.xmin:a.xmin>b.xmax?b.xmax:a.xmin;c.xmin=a.ymin<b.ymin?b.ymin:a.ymin>b.ymax?b.ymax:a.ymin;c.xmin=a.xmax<b.xmin?b.xmin:a.xmax>
b.xmax?b.xmax:a.xmax;c.xmin=a.ymax<b.ymin?b.ymin:a.ymax>b.ymax?b.ymax:a.ymax;return c};c.scaleEnvelope=function(a,b,c){return new esri.geometry.Extent(a.xmin*b,a.ymin*c,a.xmax*b,a.ymax*c,a.spatialReference)};c.scaleEnvelopeWithoutTranslation=function(a,b){if(null==a)return null;var c=a.getCenter();return new esri.geometry.Extent(c.x-a.getWidth()*(b/2),c.y-a.getHeight()*(b/2),c.x+a.getWidth()*(b/2),c.y+a.getHeight()*(b/2),a.spatialReference)};c.computeDistance=function(a,b){var c=b.x-a.x,d=b.y-a.y;
return Math.sqrt(c*c+d*d)};c.translateEnvelope=function(a,b,c){return new esri.geometry.Extent(a.xmin+b,a.ymin+c,a.xmax+b,a.ymax+c,a.spatialReference)};c.length=function(a){return Math.sqrt(a.x*a.x+a.y*a.y)};c.normalize=function(a){var b=this.length(a);return new esri.geometry.Point(a.x/b,a.y/b)};c.angle=function(a,b){if(!this.spatialRefsAreEqual(a.spatialReference,b.spatialReference,!0))throw Error("Mismatched spatial references");return Math.acos(this.dotProduct(a,b)/Math.sqrt(this.dotProduct(a,
a)*this.dotProduct(b,b)))};c.crossProduct=function(a,b,c){if(!this.spatialRefsAreEqual(a.spatialReference,b.spatialReference,!0))throw Error("Mismatched spatial references");c||(c=new esri.geometry.Point(0,0));return(a.x-c.x)*(b.y-c.y)-(a.y-c.y)*(b.x-c.x)};c.crossProductArray=a;c.dotProduct=function(a,b){if(!this.spatialRefsAreEqual(a.spatialReference,b.spatialReference,!0))throw Error("Mismatched spatial references");return a.x*b.x+a.y*b.y};c.polygonMidpoint=function(a){if(0==a.length)throw Error("Expected at least one point in polygonMidPoint.");
for(var b=0,c=0,d=0;d<a.length;++d)var m=a[d],b=b+m.x,c=c+m.y;b/=a.length;c/=a.length;return new esri.geometry.Point(b,c,a[0].spatialReference)}})(c.GeometryUtilities||(c.GeometryUtilities={}))})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(h){var f=function(d){function b(a){d.call(this,a);this.baseMapGroup=this.bingProperties=null;this.configuredOpacity=1;this.configuredVisible=!1;this.attributionDataUrl=this.copyright=null;this.hasAttributionData=!1;this.defaultNumberFormat=this.defaultDateFormat=this.description=this.dataProvider=null;this.disableClientCaching=!1;this.essentialsMap=this.drawingBehavior=this.displayName=null;this.extensions=[];this.failureAction=c.essentials.FailureAction.WARN;this.failureTimeout=
null;this.failureTimeoutThresholdExceeded=!1;this.onFailureTimeoutThresholdExceeded=function(){};this.geometryServiceUrl=this.featureClustering=null;this.hasLayerCatalog=!1;this.initializationFailure=this.imageFormat=this.originalUrl=this.catalogId=this.id=this.iconUri=null;this.isExpanded=this.includeInLayerList=!0;this.isUserCreated=this.isServiceLayerLoaded=!1;this.userLayerType=null;this.layers=[];this.tables=[];this.layersFilteredView=[];this.minScale=this.maxScale=this.mapUrl=this.mapServiceType=
this.mapServiceFunction=null;this.opacityFilter=this.opacity=1;this.operationalSpatialReference=null;this.inActiveTheme=!0;this.layerThemeSettings=[];this.layerHyperlinks=[];this.properties={};this.requestEncoding=this.proxyUrl=null;this.instantSearch=!1;this.shortDisplayName=this.serviceUrl=this.serviceToken=this.serviceLayer=this.serverVersion=null;this.subDomains=[];this.supportsDynamicLayers=!1;this.tileRestUrl=this.tileInfo=this.tileMatrixSet=null;this.isTimeAware=!1;this.heatMap=this.updateInterval=
this.timeZoneId=this.timeInfo=null;this._needsProxy=this.includeCatalogItems=this.includeMosaicDatasetValues=this.identifiable=!1;this._featureLayerPromise=this._restEndTimeOverrideString=this._restStartTimeOverrideString=this._styleUrl=this._layersInfoPromise=this._delayedRefreshToken=this._updateIntervalId=this.layerVisibilityEventManager=null;this._initiallyVisible=!1;this.originalUrl=a;this.url&&(this.url=h.utilities.UrlUtilities.simplify(a));this.setInActiveTheme(!0)}__extends(b,d);b.prototype._getLayersInfo=
function(){var a=this;this._layersInfoPromise||(this._layersInfoPromise=new Promise(function(g,b){a.doWhenInitialized(function(c){a.serviceUrl.endsWith("/MapServer")?(c={url:a.serviceUrl+"/Layers",content:{f:"json"},load:function(a){g(a)},error:function(a){b(a)},callbackParamName:"CallBack",preventCache:!1},null!==a.serviceToken&&(c.content.token=a.serviceToken),esri.request(c,{gcx:{preventCache:!1}})):g(null)})}));return this._layersInfoPromise};b.prototype.getConfiguredVisibleLayers=function(){return this._getVisibleLayersOfType("configuredVisible")};
b.prototype.getDefaultVisibleLayers=function(){return this._getVisibleLayersOfType("defaultVisibility")};b.prototype.getVisibleLayers=function(){return this._getVisibleLayersOfType("_visible")};b.prototype._getVisibleLayersOfType=function(a){for(var g=[],b=0,c=0;c<this.layers.length;c++){var d=this.layers[c];d[a]&&null==d.parentLayerId&&(null==d.subLayerIds||0===d.subLayerIds.length?g[b++]=d.id:b=this._getVisibleGroupLayersOfType(a,d,g,b))}return g};b.prototype.isVisible=function(){var a=!1;this.serviceLayer&&
"boolean"===typeof this.serviceLayer.visible&&(a=this.serviceLayer.visible);return a};b.prototype.isTiled=function(){return this.serviceLayer?this.serviceLayer instanceof esri.layers.TiledMapServiceLayer:!1};b.prototype.setVisibility=function(a){if(null!==this.serviceLayer){if(!this.supportsLayerVisibility()&&this.layers.length)for(var g=0;g<this.layers.length;g++){var b=this.layers[g];b&&(b._visible=a)}a?this.serviceLayer.show():this.serviceLayer.hide()}};b.prototype.setOpacity=function(a){if(null==
a||isNaN(a))a=1;this.opacity=a=Math.min(1,Math.max(0,a));this.serviceLayer&&this.serviceLayer.setOpacity&&this.serviceLayer.setOpacity(a*this.opacityFilter)};b.prototype.setOpacityFilter=function(a){isNaN(a)&&(a=1);this.opacityFilter=a=Math.min(1,Math.max(0,a));this.serviceLayer&&this.serviceLayer.setOpacity&&this.serviceLayer.setOpacity(a*this.opacity)};b.prototype.setInActiveTheme=function(a){this.inActiveTheme=a;dojo.publish("MapServiceInActiveThemeChangedEvent",this)};b.prototype.findServiceToken=
function(){return this.serviceToken?this.serviceToken:this.essentialsMap&&this.essentialsMap.site&&this.essentialsMap.site.arcGisPortalSecurityContext?this.essentialsMap.site.arcGisPortalSecurityContext.getToken(this.serviceUrl):null};b.prototype._findById=function(a,g){for(var b=0;b<g.length;b++){var c=g[b];if(c.id==a)return c}return null};b.prototype._findByName=function(a,g){for(var b=0;b<g.length;b++){var c=g[b];if(c.name==a||c.displayName==a)return c}return null};b.prototype.findLayerByName=
function(a){return this._findByName(a,this.layers)};b.prototype.findLayerById=function(a){return this._findById(a,this.layers)};b.prototype.findTableByName=function(a){return this._findByName(a,this.tables)};b.prototype.findTableById=function(a){return this._findById(a,this.tables)};b.prototype.findLayerOrTableByName=function(a){var g=this.findLayerByName(a);g||(g=this.findTableByName(a));return g};b.prototype.findLayerOrTableById=function(a){var g=this.findLayerById(a);g||(g=this.findTableById(a));
return g};b.prototype.refresh=function(a,g){var b=this,c=this.serviceLayer;if(c&&"function"===typeof c.refresh){var d=function(){b._delayedRefreshToken=null;if(!0===a&&"function"===typeof c.setDisableClientCaching){var a=c.disableClientCaching;c.setDisableClientCaching(!0);c.refresh();c.setDisableClientCaching(a)}else c.refresh()};this._delayedRefreshToken&&clearTimeout(this._delayedRefreshToken);"number"!==typeof a?d():this._delayedRefreshToken=setTimeout(d,a)}};b.prototype.refreshFilteredCollections=
function(){var a=this;this.layersFilteredView.length=0;dojo.forEach(this.layers,function(g){return a._addToFilteredView(g)})};b.prototype._configureLayers=function(a,g){for(var b=0;a&&b<a.length;b++)this.layers[b]=new c.essentials.Layer(this.url+"/layers/"+a[b].id),this.layers[b].mapService=this,this.layers[b]._configureObject(a[b],g);this._createServiceLayer();this.minScale&&this.serviceLayer.setMinScale(this.minScale);this.maxScale&&this.serviceLayer.setMaxScale(this.maxScale);this.disableClientCaching&&
this.serviceLayer&&this.serviceLayer.setDisableClientCaching&&this.serviceLayer.setDisableClientCaching(!0)};b.prototype._configureTimeInfo=function(){if(!this.serviceLayer)throw Error("_configureTimeInfo: The esri service layer must be created before attempting to populate time information.");var a=this.serviceLayer.timeInfo;a?(this.isTimeAware=!0,this.timeInfo=b.getGcxTimeInfo(a,this._restStartTimeOverrideString,this._restEndTimeOverrideString)):this.isTimeAware=!1};b.getGcxTimeInfo=function(a,
g,b){var c=null,d=null;a&&(c=a.timeExtent&&a.timeExtent.startTime instanceof Date?a.timeExtent.startTime.valueOf():parseInt(a.timeExtent[0],10),d=a.timeExtent&&a.timeExtent.endTime instanceof Date?a.timeExtent.endTime.valueOf():parseInt(a.timeExtent[1],10));if((!c||isNaN(c))&&!g||(!d||isNaN(d))&&!b)return null;g=g?h.utilities.StringUtilities.getDateFromRestDateString(g):new Date(c);b=b?h.utilities.StringUtilities.getDateFromRestDateString(b):new Date(d);d={};d.timeExtent={startTime:g,endTime:b};a&&
(a.startTimeField&&(d.startTimeField=a.startTimeField),a.endTimeField&&(d.endTimeField=a.endTimeField),a.trackIdField&&(d.trackIdField=a.trackIdField),a.timeReference&&(d.timeReference={},void 0!=a.timeReference.respectsDaylightSaving&&(d.timeReference.respectsDaylightSavings=a.timeReference.respectsDaylightSaving),void 0!=a.timeReference.timeZone&&(d.timeReference.timeZone=a.timeReference.timeZone)),a.exportOptions&&(d.exportOptions={},void 0!=a.exportOptions.timeDataCumulative&&(d.exportOptions.timeDataCumulative=
a.exportOptions.timeDataCumulative),void 0!=a.exportOptions.timeOffset&&(d.exportOptions.timeOffset=a.exportOptions.timeOffset),void 0!=a.exportOptions.timeOffsetUnits&&(d.exportOptions.timeOffsetUnits=a.exportOptions.timeOffsetUnits),void 0!=a.exportOptions.useTime&&(d.exportOptions.useTime=a.exportOptions.useTime)));return d};b.prototype._configureTables=function(a,g){for(var b=0;a&&b<a.length;b++)this.tables[b]=new c.essentials.Layer(this.url+"/tables/"+a[b].id),this.tables[b].mapService=this,
this.tables[b]._configureObject(a[b],g)};b.prototype._createFrom=function(a){var g=this;this.id=a.id;this.serviceUrl=a.serviceUrl;this.tileRestUrl=a.tileRestUrl;this.mapUrl=a.mapUrl;this.subDomains=(a.subDomains||[]).slice();this.mapServiceType=a.serviceType;this.mapServiceFunction=a.serviceFunction;this.displayName=a.displayName||a.name;this.shortDisplayName=a.shortDisplayName;this.baseMapGroup=a.baseMapGroup;this.baseMapGroupIndex=a.baseMapGroupIndex;this.baseMapGroupIsMutuallyExclusive=a.baseMapGroupIsMutuallyExclusive;
this.description=a.description;this.copyright=a.copyright;this.attributionDataUrl=a.attributionDataUrl;this.hasAttributionData=a.hasAttributionData;this._initiallyVisible=this.configuredVisible=!!a.visible;this.disableClientCaching=!!a.disableClientCaching;this.instantSearch=!!a.instantSearch;this.opacity=this.configuredOpacity=a.opacity;this.imageFormat=a.format;this.isExpanded=a.isExpanded;this.isUserCreated=void 0==a.isUserCreated?this.isUserCreated:a.isUserCreated;this.userLayerType=void 0==a.userLayerType?
this.userLayerType:a.userLayerType;this.serverVersion=a.serverVersion;this.failureAction=a.failureAction;this.failureTimeout=a.failureTimeout;this.tileMatrixSet=a.tileMatrixSet;this.requestEncoding=a.requestEncoding;this.operationalSpatialReference=a.operationalSpatialReference;this.dataProvider=a.dataProvider;this.minScale=a.minScale;this.maxScale=a.maxScale;this.identifiable=!!a.identifiable;this.includeCatalogItems=!!a.includeCatalogItems;this.includeMosaicDatasetValues=!!a.includeMosaicDatasetValues;
this.defaultDateFormat=a.defaultDateFormat;this.defaultNumberFormat=a.defaultNumberFormat;this.timeZoneId=a.timeZoneId;a.tileInfo&&(this.tileInfo=dojo.clone(a.tileInfo),this.tileInfo.spatialReference&&(this.tileInfo.spatialReference=this.tileInfo.spatialReference.wkid?new esri.SpatialReference(this.tileInfo.spatialReference.wkid):new esri.SpatialReference(this.tileInfo.spatialReference.wkt)));this.supportsDynamicLayers=!1;this.includeInLayerList=a.includeInLayerList;this.drawingBehavior=a.drawingBehavior||
c.essentials.DrawingBehavior.FEATURE_LAYER;if(a.layerOptions){var b=new c.essentials.Layer;b.mapService=this;b._createFrom(a.layerOptions);this.layers.push(b)}a.hasOwnProperty("layerHyperlinks")&&a.layerHyperlinks.forEach(function(a){g.layerHyperlinks.push(new c.essentials.LayerHyperlink(a,g))});a.featureClustering&&(this.featureClustering={enabled:a.featureClustering.enabled,userCanToggle:a.featureClustering.userCanToggle,radius:a.featureClustering.radius,maximumFeatures:a.featureClustering.clusterSize,
backgroundColor:a.featureClustering.backgroundColor,labelColor:a.featureClustering.labelColor});a.featureHeatMap&&(this.heatMap={enabled:a.featureHeatMap.enabled,userCanToggle:a.featureHeatMap.userCanToggle,respectScaleRange:a.featureHeatMap.respectScaleRange,gradient:(a.featureHeatMap.gradient||[]).slice(),offset:(a.featureHeatMap.offset||[]).slice(),intensity:a.featureHeatMap.intensity,field:a.featureHeatMap.field,defaultRenderer:a.featureHeatMap.defaultRenderer?esri.renderer.fromJson(a.featureHeatMap.defaultRenderer):
null,defaultMinScale:a.featureHeatMap.defaultMinScale,defaultMaxScale:a.featureHeatMap.defaultMaxScale,includeInLegend:a.featureHeatMap.includeInLegend});a.properties&&(this.catalogId=c._getProperties(a.properties).layerCatalogLookupId);this.isInitialized=!0};b.prototype.createFromDefinition=function(a){this._createFrom(a)};b.prototype.toJson=function(){var a={id:this.id,url:this.url,serviceUrl:this.serviceUrl,mapUrl:this.mapUrl,tileRestUrl:this.tileRestUrl,subDomains:(this.subDomains||[]).slice(),
serviceType:this.mapServiceType,serviceFunction:this.mapServiceFunction,displayName:this.displayName,shortDisplayName:this.shortDisplayName,baseMapGroup:this.baseMapGroup,baseMapGroupIndex:this.baseMapGroupIndex,baseMapGroupIsMutuallyExclusive:this.baseMapGroupIsMutuallyExclusive,description:this.description,copyright:this.copyright,attributionDataUrl:this.attributionDataUrl,hasAttributionData:this.hasAttributionData,visible:this.isVisible(),disableClientCaching:this.disableClientCaching,opacity:this.opacity,
instantSearch:this.instantSearch,format:this.imageFormat,updateInterval:this.updateInterval,isExpanded:this.isExpanded,serverVersion:this.serverVersion,failureAction:this.failureAction,failureTimeout:this.failureTimeout,tileMatrixSet:this.tileMatrixSet,requestEncoding:this.requestEncoding,operationalSpatialReference:this.operationalSpatialReference,dataProvider:this.dataProvider,minScale:this.minScale,maxScale:this.maxScale,identifiable:this.identifiable,includeCatalogItems:this.includeCatalogItems,
includeMosaicDatasetValues:this.includeMosaicDatasetValues,defaultDateFormat:this.defaultDateFormat,defaultNumberFormat:this.defaultNumberFormat,timeZoneId:this.timeZoneId,startTime:this._restStartTimeOverrideString,endTime:this._restEndTimeOverrideString,tileInfo:this.tileInfo&&"function"===typeof this.tileInfo.toJson?this.tileInfo.toJson():void 0,supportsDynamicLayers:this.supportsDynamicLayers,hasLayerCatalog:this.hasLayerCatalog,includeInLayerList:this.includeInLayerList,drawingBehavior:this.drawingBehavior,
layerOptions:this.layers.map(function(a){return a.toJson()}),catalogId:this.catalogId,isUserCreated:this.isUserCreated,userLayerType:this.userLayerType,tables:this.tables.map(function(a){return a.toJson()}),layerHyperlinks:this.layerHyperlinks.map(function(a){return a.toJson()}),properties:c._propertiesToJson(this.properties),extensions:c._extensionsToJson(this.extensions)};this.featureClustering&&(a.featureClustering=dojo.clone(this.featureClustering));this.heatMap&&(a.featureHeatMap=dojo.clone(this.heatMap),
a.featureHeatMap.defaultRenderer instanceof esri.renderer.Renderer&&(a.featureHeatMap.defaultRenderer=a.featureHeatMap.defaultRenderer.toJson()));return a};b.prototype._configureObject=function(a,g){var b=this;if(void 0===a||void 0===a.id||void 0===a.displayName||void 0===a.serviceType||void 0==a.connectionString)throw Error("Incorrect map service object returned from initialization");this.id=a.id;this.mapServiceType=a.serviceType;this.mapServiceFunction=void 0===a.serviceFunction?this.mapServiceFunction:
a.serviceFunction;this.displayName=a.displayName;this.shortDisplayName=a.shortDisplayName;this.baseMapGroup=a.baseMapGroup;this.baseMapGroupIndex=a.baseMapGroupIndex;this.baseMapGroupIsMutuallyExclusive=a.baseMapGroupIsMutuallyExclusive;this.description=void 0===a.description?this.description:a.description;this.copyright=a.copyright;this.attributionDataUrl=a.attributionDataUrl;this.hasAttributionData=a.hasAttributionData;this.configuredVisible=!!a.visible;this.disableClientCaching=!!a.disableClientCaching;
this.instantSearch=!!a.instantSearch;this.opacity=this.configuredOpacity=void 0===a.opacity||null===a.opacity?this.configuredOpacity:a.opacity;this.imageFormat=void 0===a.format?this.imageFormat:a.format;if(void 0!==a.updateInterval){var k=a.updateInterval;k&&10>k&&0!==k&&(k=10);this.updateInterval=k;this._resetUpdateTimer()}this.tileRestUrl=a.tileRestUrl;this.mapUrl=a.mapUrl;this.subDomains=(a.subDomains||[]).slice();this.isExpanded=void 0==a.isExpanded?this.isExpanded:a.isExpanded;this.isUserCreated=
void 0==a.isUserCreated?this.isUserCreated:a.isUserCreated;this.userLayerType=void 0==a.userLayerType?this.userLayerType:a.userLayerType;this.catalogId=void 0==a.catalogId?this.catalogId:a.catalogId;this.serverVersion=a.serverVersion;this.failureAction=a.failureAction;this.failureTimeout=a.failureTimeout;this.tileMatrixSet=a.tileMatrixSet;this.requestEncoding=a.requestEncoding;this.operationalSpatialReference=a.operationalSpatialReference;this.dataProvider=a.dataProvider;this.minScale=a.minScale;
this.maxScale=a.maxScale;this.identifiable=!!a.identifiable;this.includeCatalogItems=!!a.includeCatalogItems;this.includeMosaicDatasetValues=!!a.includeMosaicDatasetValues;this.defaultDateFormat=a.defaultDateFormat;this.defaultNumberFormat=a.defaultNumberFormat;this.timeZoneId=a.timeZoneId;this._restStartTimeOverrideString=a.startTime||null;this._restEndTimeOverrideString=a.endTime||null;a.tileInfo&&(this.tileInfo=dojo.clone(a.tileInfo),this.tileInfo.spatialReference&&(this.tileInfo.spatialReference=
this.tileInfo.spatialReference.wkid?new esri.SpatialReference(this.tileInfo.spatialReference.wkid):new esri.SpatialReference(this.tileInfo.spatialReference.wkt)));"boolean"===typeof a.includeInLayerList&&(this.includeInLayerList=a.includeInLayerList);if(this.isUserCreated)this._initiallyVisible=void 0===a.initiallyVisible?!!a.visible:!!a.initiallyVisible;else if(this._initiallyVisible=null!=this.essentialsMap.layerThemesInfo.startupThemeId&&this.includeInLayerList?!1:void 0===a.initiallyVisible?!!a.visible:
!!a.initiallyVisible,a.themeSettings&&a.themeSettings.length)for(k=0;k<a.themeSettings.length;k++){var d=a.themeSettings[k],m=this.essentialsMap.layerThemesInfo.getTheme(d.themeID);if(m){var f=void 0==d.visible?this.configuredVisible:d.visible;this.layerThemeSettings.push(new h.LayerThemeSetting(m,f));m.id===this.essentialsMap.layerThemesInfo.startupThemeId&&this.includeInLayerList&&(this._initiallyVisible=void 0===d.initiallyVisible?f:d.initiallyVisible)}}this.supportsDynamicLayers=void 0===a.supportsDynamicLayers?
this.supportsDynamicLayers:a.supportsDynamicLayers;this.hasLayerCatalog=void 0===a.hasLayerCatalog?this.hasLayerCatalog:a.hasLayerCatalog;a.iconUri&&(k=null,this.essentialsMap&&(k=this.essentialsMap.site),this.iconUri=c.essentials.RestHelper.processClientSideTokens(k,a.iconUri));a.featureClustering&&(this.featureClustering={enabled:a.featureClustering.enabled,userCanToggle:a.featureClustering.userCanToggle,radius:a.featureClustering.radius,maximumFeatures:a.featureClustering.clusterSize,backgroundColor:a.featureClustering.backgroundColor,
labelColor:a.featureClustering.labelColor});a.featureHeatMap&&(this.heatMap={enabled:a.featureHeatMap.enabled,userCanToggle:a.featureHeatMap.userCanToggle,respectScaleRange:a.featureHeatMap.respectScaleRange,gradient:(a.featureHeatMap.gradient||[]).slice(),offset:(a.featureHeatMap.offset||[]).slice(),intensity:a.featureHeatMap.intensity,field:a.featureHeatMap.field,defaultRenderer:a.featureHeatMap.defaultRenderer?esri.renderer.fromJson(a.featureHeatMap.defaultRenderer):null,defaultMinScale:a.featureHeatMap.defaultMinScale,
defaultMaxScale:a.featureHeatMap.defaultMaxScale,includeInLegend:a.featureHeatMap.includeInLegend});this.drawingBehavior=void 0===a.drawingBehavior?this.drawingBehavior:a.drawingBehavior;this._processConnectionString(a.connectionString,a);this._processProxyInfo(a.proxyInfo);this._configureLayers(a.layers||a.layerOptions,g);this._configureTables(a.tables,g);a.hasOwnProperty("layerHyperlinks")&&a.layerHyperlinks.forEach(function(a){b.layerHyperlinks.push(new c.essentials.LayerHyperlink(a,b))});g&&(this.isInitialized=
!0);this.properties=c._getProperties(a.properties);this.extensions=c._getExtensions(a.extensions);this.setOpacity(this.configuredOpacity)};b.prototype._updateServiceToken=function(a){this.serviceToken=a;if(this.serviceLayer&&this.serviceLayer._url){var g=this.serviceLayer._url;if(g.query){g.query.token=a;var b=dojo.objectToQuery(g.query);this.serviceLayer.url=g.path+(b?"?"+b:"")}}dojo.publish("ServiceTokenRefreshed",{serviceUrl:this.serviceUrl,token:a})};b.prototype._addDefinitionExpression=function(a,
g){if(!a)throw Error("Expecting a layer");g=g||this.serviceLayer;if(g instanceof esri.layers.ArcGISDynamicMapServiceLayer){var b=a.getDefinitionExpression(null);if(b){var c=parseInt(a.id),d=g.layerDefinitions||[];if(c)d[c]=b,g.setLayerDefinitions(d);else throw Error("Failed to add definition expression for "+a.displayName);}}};b.prototype._removeDefinitionExpression=function(a,g){if(a&&(g=g||this.serviceLayer)&&g instanceof esri.layers.ArcGISDynamicMapServiceLayer){var b=parseInt(a.id);if(b&&g.layerDefinitions){var c=
g.layerDefinitions;c[b]&&(c.splice(b,1),g.setLayerDefinitions(c))}}};b.prototype._createServiceLayer=function(){var a=this;if(null==this.serviceLayer){var g=this.serviceUrl;null!==this.serviceToken&&(g=g+(-1<g.indexOf("?")?"&token=":"?token=")+encodeURIComponent(this.serviceToken));if("MapService"===this.drawingBehavior){var n;switch(this.mapServiceType){case c.essentials.MapServiceType.DYNAMIC:this._needsProxy&&(esri.config.defaults.io.alwaysUseProxy=!0);var d=new esri.layers.ArcGISDynamicMapServiceLayer(g,
{id:this.id});this._applyAttributionUrl(d);g=this.getVisibleLayers();0===g.length?d.setVisibleLayers&&(0===this.layers.length?d.setVisibleLayers(g,!1):d.setVisibleLayers(["-1"],!1)):d.setVisibleLayers&&d.setVisibleLayers(g,!1);for(n=0;n<this.layers.length;n++)this._addDefinitionExpression(this.layers[n],d);this.layerVisibilityEventManager=new h.LayerVisibilityEventManager(this,d);d.setImageFormat(this._getAgsDynamicImageFormat(this.imageFormat));dojo.connect(d,"onError",this,this._layerLoadErrorHandler);
dojo.connect(d,"onLoad",this,function(){this._handleServiceLayerLoaded(d);this._handleDynamicLayers(d)});this._initiallyVisible?d.show():d.hide();this.serviceLayer=d;break;case c.essentials.MapServiceType.TILED:g=new esri.layers.ArcGISTiledMapServiceLayer(g,{id:this.id});this._applyAttributionUrl(g);dojo.connect(g,"onError",dojo.hitch(this,this._layerLoadErrorHandler));dojo.connect(g,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded));this._initiallyVisible?g.show():g.hide();this.serviceLayer=
g;break;case c.essentials.MapServiceType.IMAGE:n=null;this._hasTileLevels()?n=new esri.layers.ArcGISTiledMapServiceLayer(g,{id:this.id}):(n=new esri.layers.ArcGISImageServiceLayer(g,{id:this.id}),n.setImageFormat(this._getAgsImageServiceImageFormat(this.imageFormat)));this._applyAttributionUrl(n);dojo.connect(n,"onError",this,this._layerLoadErrorHandler);dojo.connect(n,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded));this._initiallyVisible?n.show():n.hide();this.serviceLayer=n;break;case c.essentials.MapServiceType.BING:g=
new esri.virtualearth.VETiledLayer(this.bingProperties);dojo.connect(g,"onError",this,this._layerLoadErrorHandler);dojo.connect(g,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded));this._initiallyVisible?g.show():g.hide();this.serviceLayer=g;break;case c.essentials.MapServiceType.WMS:if(!dojo.isObject(esri.layers.WMSLayer))throw Error("This Javascript application must // dojo.require the esri.layers.wms package in order to use a site with a WMS service.");this._extendWms();var l=!1;for(n=0;n<
this.layers.length;n++)if(this.layers[n].wmsLayerName){l=!0;break}var m;l?(n={extent:this.essentialsMap.initialExtent,layerInfos:this._constructWmsLayerInfos(),version:this.serverVersion},m=new esri.layers.WMSLayer(g,{resourceInfo:n,visibleLayers:this._getWmsVisibleLayers()}),null!=this.operationalSpatialReference&&(n=parseInt(this.operationalSpatialReference.replace(/^.*:/,"")),m.spatialReferences.push(n),m.preferredSpatialReference=n),dojo.connect(m,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded))):
(m=new esri.layers.WMSLayer(g),dojo.connect(m,"onLoad",dojo.hitch(this,this._finishWmsLayerConfiguration)));this._restStartTimeOverrideString&&this._restEndTimeOverrideString&&!m.timeInfo&&(n=b.getGcxTimeInfo(null,this._restStartTimeOverrideString,this._restEndTimeOverrideString))&&(n={timeExtent:new esri.TimeExtent(n.timeExtent.startTime,n.timeExtent.endTime)},m.timeInfo=n);m.id=this.id;this._applyAttributionUrl(m);this.layerVisibilityEventManager=new h.LayerVisibilityEventManager(this,m);m.setImageFormat(this._getEsriWmsImageFormat());
m.__gcxWmsImageFormat=this.imageFormat;dojo.connect(m,"onError",this,this._layerLoadErrorHandler);this._initiallyVisible?m.show():m.hide();this.serviceLayer=m;this._corsRequest(this._prefixProxy(g)).then(function(){m.refresh()},function(a){m.refresh()});break;case c.essentials.MapServiceType.WMTS:if(!dojo.isObject(esri.layers.WMTSLayer))throw Error("This JavaScript application must // dojo.require the esri.layers.wmts package in order to use a site with WMTS service.");if(0==this.layers.length)throw Error("You must include at least one layer in your WMTS. Service "+
this.displayName+" has 0 layers.");this.tileInfo&&this.tileInfo.dpi&&this.tileInfo.lods.forEach(function(g){return g.scale=g.scale/a.tileInfo.dpi*96});n=c.essentials.GeometryUtilities.scaleEnvelopeWithoutTranslation(this.layers[0].fullExtent,1.1);null==n&&(n=c.essentials.GeometryUtilities.scaleEnvelopeWithoutTranslation(this.essentialsMap.fullExtent,1.1));l=new esri.layers.WMTSLayerInfo({tileInfo:this.tileInfo,fullExtent:n,initialExtent:n,identifier:0<this.layers.length?this.layers[0].name:null,tileMatrixSet:this.tileMatrixSet,
format:this._getEsriOgcImageFormat(),style:this.layers[0].styleName?this.layers[0].styleName:""});n={version:this.serverVersion,layerInfos:[l],getTileUrl:this._prefixProxy(this.mapUrl)};g=new esri.layers.WMTSLayer(g,{serviceMode:"KVP",resourceInfo:n,layerInfo:l});g.id=this.id;this._applyAttributionUrl(g);if(g._url){var f=0,p=c.hasProxy()?2:1;g._url=g._url.replace(/\?/g,function(a){f++;return f<=p?"?":""})}dojo.connect(g,"onError",this,this._layerLoadErrorHandler);dojo.connect(g,"onLoad",dojo.hitch(this,
this._handleServiceLayerLoaded));this._initiallyVisible?g.show():g.hide();this.serviceLayer=g;break;case c.essentials.MapServiceType.WEBTILED:g=g.replace(/([^$])({[^}]*})/g,function(a,g,b){return g+"$"+b});n={copyright:this.copyright,id:this.id,subDomains:null};0<=g.indexOf("${subDomain}")&&(n.subDomains=this.subDomains);g=new esri.layers.WebTiledLayer(g,n);g.id=this.id;this._applyAttributionUrl(g);this._initiallyVisible?g.show():g.hide();dojo.connect(g,"onError",this,this._layerLoadErrorHandler);
dojo.connect(g,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded));this.serviceLayer=g;break;case c.essentials.MapServiceType.VECTORTILE:var q=g;this._styleUrl&&(q=this._styleUrl,this.essentialsMap&&this.essentialsMap.site&&(g=this.essentialsMap.site.getTokenFromPrincipal(this._styleUrl,this.mapServiceType))&&(q=this._styleUrl+"?token="+g));require(["esri/layers/VectorTileLayer"],function(g){g=new g(q);g.id=a.id;g.loadError&&a._layerLoadErrorHandler(g.loadError);a._initiallyVisible?g.show():
g.hide();dojo.connect(g,"onError",a,a._layerLoadErrorHandler);dojo.connect(g,"onLoad",dojo.hitch(a,a._handleServiceLayerLoaded));a._applyAttributionUrl(g);a.serviceLayer=g})}this.initiateServiceFailureTimer()}}};b.prototype.initiateServiceFailureTimer=function(){var a=this;this.failureTimeout&&!isNaN(this.failureTimeout)&&setTimeout(function(){a.serviceLayer&&(!a.serviceLayer||a.serviceLayer.loaded)||a.initializationFailure||(a.failureTimeoutThresholdExceeded=!0,a.onFailureTimeoutThresholdExceeded())},
1E3*this.failureTimeout)};b.prototype._applyAttributionUrl=function(a){if(this.attributionDataUrl&&""!==this.attributionDataUrl)a.attributionDataUrl=this.attributionDataUrl,a.hasAttributionData=!0;else if(this.hasAttributionData){a.attributionDataUrl=this.url+"/attribution";a.hasAttributionData=!0;var g=h.RestHelperHTTPService.getTokenForScope(a.attributionDataUrl);g&&(a.attributionDataUrl+="?token="+g)}};b.prototype._prefixProxy=function(a){return this.proxyUrl?this.proxyUrl+"?"+a:a};b.prototype._constructWmsLayerInfos=
function(){for(var a=[],g=0;g<this.layers.length;g++){var b=this.layers[g];if(null!=b.wmsLayerName){var c=new esri.layers.WMSLayerInfo({name:b.wmsLayerName,title:b.name});c.styleName=b.styleName;a.push(c)}}return a};b.prototype._getWmsVisibleLayers=function(){for(var a=[],g=0;g<this.layers.length;g++){var b=this.layers[g];b.isVisible()&&b.areAllAncestorsVisible()&&null!=b.wmsLayerName&&0==b.subLayerIds.length&&a.push(b.wmsLayerName)}return a};b.prototype._applyWmsLayerVisibility=function(){var a=
this._getWmsVisibleLayers();this.serviceLayer.setVisibleLayers(a)};b.prototype._getEsriWmsImageFormat=function(){var a=this._getEsriOgcImageFormat();"jpeg"==a&&(a="jpg");return a};b.prototype._getEsriOgcImageFormat=function(){return null!=this.imageFormat?this.imageFormat.replace(/^image\//,""):null};b.prototype._findWMSLayerName=function(a,g){for(var b in a){var c=a[b];if(c.title===g)return c.name;if(null!==c.subLayers&&0<c.subLayers.length&&(c=this._findWMSLayerName(c.subLayers,g),null!==c))return c}return null};
b.prototype._finishWmsLayerConfiguration=function(a){for(var g=[],b=0,c,d=0;d<this.layers.length;d++){var m=this.layers[d];!m.configuredVisible||null!==m.subLayerIds&&0!==m.subLayerIds.length||(null!==m.parentLayerId?this.findLayerById(m.parentLayerId).configuredVisible&&(c=this._getWMSLayerNameFromTitle(m.name),m.wmsLayerName=c,null!==c&&""!==c&&(g[b]=c,b++)):(c=this._getWMSLayerNameFromTitle(m.name),m.wmsLayerName=c,null!==c&&""!==c&&(g[b]=c,b++)))}this.serviceLayer.setVisibleLayers(g);this._handleServiceLayerLoaded(a)};
b.prototype._handleServiceLayerLoaded=function(a){this._configureTimeInfo();this.isServiceLayerLoaded=!0;if(this.essentialsMap&&this.essentialsMap.site&&dojo.isFunction(this.essentialsMap.site.onLayerLoad))this.essentialsMap.site.onLayerLoad(a)};b.prototype.convertToDynamicLayers=function(){var a=this.serviceLayer;a&&a instanceof esri.layers.ArcGISDynamicMapServiceLayer&&(a.dynamicLayerInfos||a.setDynamicLayerInfos(this._createDynamicLayerInfos(a)),a.layerDrawingOptions||(a.layerDrawingOptions=[]))};
b.prototype._layerLoadErrorHandler=function(a){a&&a.message&&0==a.message.indexOf("Unable to load tile")||(this.initializationFailure=a,this.essentialsMap&&this.essentialsMap.site&&dojo.isFunction(this.essentialsMap.site.onLayerLoadError)&&(this._layerLoadErrorHandler=this.essentialsMap.site.onLayerLoadError))};b.prototype.remove=function(a){if(!a)throw Error("Expecting a layer.");var g=this.serviceLayer;if(a.isDynamic&&this.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer&&this.serviceLayer){this.convertToDynamicLayers();
var b=parseInt(a.id,10),c=this.findLayerById(a.id);if(null!=c){var d=this.layers.indexOf(c);-1<d&&(c.setInActiveTheme(!1),this.layers.splice(d,1),dojo.publish("CatalogLayerRemovedEvent",c))}c=this.getVisibleLayers();if(null!=b){var m=[];g.dynamicLayerInfos&&(m=dojo.clone(this.serviceLayer.dynamicLayerInfos));var f=[];g.layerDrawingOptions&&(f=this.serviceLayer.layerDrawingOptions);if(a.isDynamic){for(var d=null,h=0;h<m.length;h++)if(m[h].id===b){d=m[h];break}d&&(d=m.indexOf(d),-1<d&&(m.splice(d,1),
g.setDynamicLayerInfos(m,!0)));var b=[],q;for(q in f)f.hasOwnProperty(q)&&q!==a.id&&(b[q]=dojo.clone(f[q]));this._removeDefinitionExpression(a,g);g.setLayerDrawingOptions(b)}-1<c.indexOf(a.id)&&c.splice(c.indexOf(a.id),1);this._syncLayerVisibilities(c)}else throw"Could not convert Layer ID '"+a.id+"' into an integer!";}else throw"MapService - remove() - Unsupported Layer Type.";};b.prototype.add=function(a){if(!a)throw Error("Expecting a layer");var g=this.serviceLayer;if(a.isDynamic&&g instanceof
esri.layers.ArcGISDynamicMapServiceLayer){this.convertToDynamicLayers();var b=this.getVisibleLayers();a.mapService=this;var c=[];g.dynamicLayerInfos&&(c=g.dynamicLayerInfos);var d=[];g.layerDrawingOptions&&(d=g.layerDrawingOptions);var m,f=parseInt(a.id,10);if(null!=f)m=a._createDynamicLayerInfo(),m.name||(m.name=a.displayName),null!=m&&c.push(m),m=a.getLayerDrawingOptions(),null!=m&&(d[f]=m),0<d.length&&g.setLayerDrawingOptions(d,!0),this._addDefinitionExpression(a,g),g.setDynamicLayerInfos(c),b.push(a.id),
this._syncLayerVisibilities(b),this.layers.push(a),dojo.publish("CatalogLayerAddedEvent",a);else throw"Could not convert Layer ID '"+a.id+"' into an integer!";}else throw"MapService - add() - Unsupported layer type..";};b.prototype.getDynamicLayerInfoById=function(a){var g=null;if(this.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer&&(a=parseInt(a,10),!isNaN(a))){var b=this.serviceLayer.dynamicLayerInfos;if(b)for(var c=0;c<b.length;c++)b[c].id===a&&(g=b[c])}return g};b.prototype._syncLayerVisibilities=
function(a){for(var g=0;g<this.layers.length;g++)-1<a.indexOf(this.layers[g].id)?this.layers[g].visibleStateForRefresh=c.essentials.RefreshVisibility.SHOW:this.layers[g].visibleStateForRefresh=c.essentials.RefreshVisibility.HIDE;0==a.length&&a.push("-1");this.serviceLayer.setVisibleLayers(a)};b.prototype._handleDynamicLayers=function(a){var g=this;if(this.supportsDynamicLayers){var b=dojo.some(this.layers,function(a){return a.isDynamic}),c=dojo.some(this.layers,function(a){return null!=a.drawIndex}),
d=dojo.some(this.layers,function(a){return a.canToggleLabels&&!a.showLabels});if(b||c||d||this.hasLayerCatalog){if(b=this.essentialsMap.getMap())b.spatialReference&&(b.spatialReference.wkid&&!(0>=b.spatialReference.wkid)||b.spatialReference.wkt&&b.spatialReference.wkt.trim())||null==a.spatialReference||!a.spatialReference.wkt||!a.spatialReference.wkt.trim()||(b.spatialReference=a.spatialReference),!b.extent||b.extent.spatialReference&&(b.extent.spatialReference.wkid&&!(0>=b.extent.spatialReference.wkid)||
b.extent.spatialReference.wkt&&b.extent.spatialReference.wkt.trim())||null==a.spatialReference||!a.spatialReference.wkt||!a.spatialReference.wkt.trim()||(b=new esri.geometry.Extent(b.extent),b.spatialReference=a.spatialReference,this.essentialsMap.extentManager.setExtentWithPriority(b,2));var m=this._createDynamicLayerInfos(a),f=[];a.layerDrawingOptions&&(f=dojo.mixin([],a.layerDrawingOptions));d&&dojo.forEach(this.layers,function(a,g){if(a.canToggleLabels){var b=a.getLayerDrawingOptions();if(null==
b){var b=new esri.layers.LayerDrawingOptions,c=parseInt(a.id,10);f[c]=b}b.showLabels=a.showLabels}});dojo.forEach(this.layers,function(a,g){if(a.isDynamic){var b,c=parseInt(a.id,10);if(c){if(b=a._createDynamicLayerInfo(),b.name||(b.name=a.name),b&&m.splice(g,0,b),b=a.getLayerDrawingOptions())f[c]=b,null!=a.showLabels&&(b.showLabels=a.showLabels)}else throw"Could not convert Layer ID '"+a.id+"' into an integer!";}});if(c){var h=dojo.clone(m),q=[];dojo.forEach(this.layers,function(a,g){null!=a&&null!=
a.drawIndex&&q.push(a)});q.sort(function(a,g){return a.drawIndex-g.drawIndex});dojo.forEach(q,function(a,g){for(var b=null,c=null,n=0;n<h.length;n++){var d=h[n];if(d.id.toString()==a.id){b=d;c=n;break}}null!=b&&null!=c&&(h.splice(c,1),h.push(b))});m=[];dojo.forEach(h,function(a,g){m.push(a)})}setTimeout(function(){0<f.length&&a.setLayerDrawingOptions(f,!0);0<m.length&&a.setDynamicLayerInfos(m,!0);var b=g.getVisibleLayers();b.InternallyChangedLayer={};0<b.length||b.push("-1");a.setVisibleLayers(b)},
0)}}};b.prototype._createDynamicLayerInfos=function(a,g){void 0==g&&(g=!0);var b=null;if(null!=a&&(b=a.createDynamicLayerInfosFromLayerInfos(),g))for(var c=b.length-1;0<=c;c--){var d=this.findLayerById(b[c].id.toString());(null==d||d.isDynamic)&&b.splice(c,1)}return b};b.prototype._getAgsDynamicImageFormat=function(a){if("undefined"==typeof a||null===a||1>a.length)return"png8";a=a.toLowerCase();switch(a){case "png":case "png8":case "png24":case "png32":case "jpeg":case "jpg":case "gif":case "bmp":case "svg":case "svgz":case "emf":case "ps":case "pdf":return a;
default:return"png8"}};b.prototype._getAgsImageServiceImageFormat=function(a){if("undefined"==typeof a||null===a||1>a.length)return null;a=a.toLowerCase();switch(a){case "jpgpng":case "png":case "png8":case "png24":case "png32":case "jpeg":case "jpg":case "gif":case "bmp":case "tiff":return a;default:return null}};b.prototype._getVisibleGroupLayersOfType=function(a,g,b,c){if(g[a])for(var d=0;d<g.subLayerIds.length;d++){var m=this.findLayerById(g.subLayerIds[d]);m[a]&&(null!==m.subLayerIds&&0<m.subLayerIds.length?
c=this._getVisibleGroupLayersOfType(a,m,b,c):0>dojo.indexOf(b,m.id)&&(b[c]=m.id,c++))}return c};b.prototype._getWMSLayerNameFromTitle=function(a){return this.serviceLayer instanceof esri.layers.WMSLayer?this._findWMSLayerName(this.serviceLayer.layerInfos,a):null};b.prototype._getPrincipalResult=function(a){return this.essentialsMap&&this.essentialsMap.site&&this.essentialsMap.site.principal?a(this.essentialsMap.site.principal):void 0};b.prototype._processConnectionString=function(a,g){var b=c.essentials.ServiceHelper.extractConnectionStringValue;
if(this.mapServiceType==c.essentials.MapServiceType.BING){this.bingProperties={};var d;(d=b(a,"mapStyle"))&&0<d.length&&(this.bingProperties.mapStyle=d);(d=b(a,"culture"))&&0<d.length&&(this.bingProperties.culture=d);(d=b(a,"key"))&&0<d.length&&(this.bingProperties.bingMapsKey=d)}else{d=b(a,"url");if(0<d.length)this.serviceUrl=d.replace(/%3d/g,"=").replace(/%3D/g,"=");else if((this.mapServiceType===c.essentials.MapServiceType.DYNAMIC||this.mapServiceType===c.essentials.MapServiceType.TILED)&&3.912<=
this.essentialsMap.site.getEssentialsVersion()||(this.mapServiceType===c.essentials.MapServiceType.FEATURE||this.mapServiceType===c.essentials.MapServiceType.IMAGE||this.mapServiceType===c.essentials.MapServiceType.VECTORTILE)&&4.01<=this.essentialsMap.site.getEssentialsVersion()){if(4.03>this.essentialsMap.site.getEssentialsVersion())this.serviceUrl=this.url+"/MapServer";else if(d=4.05>this.essentialsMap.site.getEssentialsVersion()?"/GeoREST":"/rest/services/x",this.mapServiceType===c.essentials.MapServiceType.FEATURE)if(g&&
g.layers&&0<g.layers.length&&g.layers[0])this.serviceUrl=this.url+d+"/FeatureServer/"+g.layers[0].id;else throw Error("Unable to configure FeatureLayer connection string. No child layer is specified.");else this.serviceUrl=this.mapServiceType===c.essentials.MapServiceType.IMAGE?this.url+d+"/ImageServer":this.mapServiceType===c.essentials.MapServiceType.VECTORTILE?this.url+d+"/VectorTileServer":this.url+d+"/MapServer";this._getPrincipalResult(function(a){return a.isAuthenticated})&&(this.serviceToken=
this._getPrincipalResult(function(a){return a.tokens.site}));"3.912"===this.essentialsMap.site.currentVersion&&(this._needsProxy=!0)}d=b(a,"geometryServiceUrl");0<d.length&&(this.geometryServiceUrl=d);this.mapServiceType===c.essentials.MapServiceType.VECTORTILE&&(this._styleUrl=b(a,"styleUrl"));this.essentialsMap&&this.essentialsMap.site&&!this.serviceToken&&(this.serviceToken=this.essentialsMap.site.getTokenFromPrincipal(this.serviceUrl,this.mapServiceType));d=b(a,"token");var l=this.essentialsMap&&
this.essentialsMap.site?this.essentialsMap.site.arcGisPortalSecurityContext:null;0<d.length?this.serviceToken=d:l&&l.appliesTo(this.serviceUrl)&&l.tokenResult?this.serviceToken=l.tokenResult.token:null!=this.serviceUrl&&(d=c.essentials.RestHelperHTTPService.getAuthenticationControlBlockStore().find(this.serviceUrl))&&null!=d.token&&(this.serviceToken=d.token);d=b(a,"proxy");0<d.length&&(this.proxyUrl=d,esri.addProxyRule({urlPrefix:this.serviceUrl,proxyUrl:d}),-1<this.serviceUrl.indexOf("services.arcgis")&&
esri.addProxyRule({urlPrefix:this.serviceUrl.replace("services.arcgis","server.arcgis"),proxyUrl:d}));d=b(a,"mapUrl");0<d.length&&(this.mapUrl=d.replace(/%3d/g,"=").replace(/%3D/g,"="));d=b(a,"tileRestUrl");0<d.length&&(this.tileRestUrl=d.replace(/%3d/g,"=").replace(/%3D/g,"="));if(b=b(a,"subDomains"))this.subDomains=b.split(",")}};b.prototype._isLocalProxyInfo=function(a){return a&&"local-reverse-proxy"==a.type&&a.address?!0:!1};b.prototype._processProxyInfo=function(a){if(this._isLocalProxyInfo(a)){a=
(this.url+"/../../../../../"+a.address).split("/");for(var g=a.indexOf("..");0<g;g=a.indexOf(".."))a.splice(g-1,2);this.serviceUrl=a.join("/")}};b.prototype.supportsLayerVisibility=function(){switch(this.mapServiceType){case c.essentials.MapServiceType.WMS:return!0;case c.essentials.MapServiceType.DYNAMIC:return null!==this.serviceLayer&&!!this.serviceLayer.visibleLayers;default:return!1}};b.prototype._setVisibility=function(a,g,b){a={mapServiceId:this.id,layerId:a,visibility:g};void 0===b&&(b=!1);
var d,l;switch(this.mapServiceType){case c.essentials.MapServiceType.DYNAMIC:if(null!==this.serviceLayer){if(!this.serviceLayer.visibleLayers){g?this.serviceLayer.show():this.serviceLayer.hide();dojo.publish("LayerVisibilityChange",[Array(a)]);break}g=this.getVisibleLayers();g.InternallyChangedLayer=a;0===g.length&&g.push("-1");this.serviceLayer.setVisibleLayers&&this.serviceLayer.setVisibleLayers(g,b)}break;case c.essentials.MapServiceType.WMS:if(null!==this.serviceLayer){var m=[];m.InternallyChangedLayer=
a;for(d=g=0;d<this.layers.length;d++)l=this.layers[d],l.isVisible()&&(null===l.subLayerIds||0===l.subLayerIds.length)&&l.areAllAncestorsVisible()&&(l=l.wmsLayerName,null!==l&&""!==l&&(m[g]=l,g++));b?(this.serviceLayer.visibleLayers=m.slice(0),dojo.publish("LayerVisibilityChange",[Array(a)])):this.serviceLayer.setVisibleLayers(m)}break;case c.essentials.MapServiceType.GRAPHICS:case c.essentials.MapServiceType.FEATURE:case c.essentials.MapServiceType.CSV:case c.essentials.MapServiceType.LABEL:case c.essentials.MapServiceType.STREAM:case c.essentials.MapServiceType.GEORSS:case c.essentials.MapServiceType.KML:case c.essentials.MapServiceType.BING:case c.essentials.MapServiceType.TILED:case c.essentials.MapServiceType.WMTS:case c.essentials.MapServiceType.IMAGE:case c.essentials.MapServiceType.WEBTILED:case c.essentials.MapServiceType.VECTORTILE:case c.essentials.MapServiceType.MAPIMAGE:if(null!==
this.serviceLayer)if(1===this.layers.length)g?this.serviceLayer.show():this.serviceLayer.hide(),dojo.publish("LayerVisibilityChange",[Array(a)]);else throw Error("Visibility of individual layers cannot be set for this Map Service: {0}".format(this.displayName));break;default:throw Error("Cannot set layer visibility. Unknown MapService type.");}};b.prototype._extendWms=function(){if(!c.essentials.MapService._wmsExtended){var a=esri.layers.WMSLayer._meta.hidden.getImageUrl,g=/.*images\/pixel.png$/;
esri.layers.WMSLayer.extend({getImageUrl:function(b,c,d,m){var f=this;a.apply(this,[b,c,d,function(a){if(!g.test(a)){for(var b={},c=0;c<f.layerInfos.length;c++)b[f.layerInfos[c].name]=f.layerInfos[c].styleName;for(var n=[],c=0;c<f.visibleLayers.length;c++)n.push(b[f.visibleLayers[c]]);c=n.join(",");b=a.substring(a.lastIndexOf("?")+1,a.length);b=dojo.queryToObject(b);b.STYLES=c;f.preferredSpatialReference&&(b[b.CRS?"CRS":"SRS"]="EPSG:"+f.preferredSpatialReference);f.__gcxWmsImageFormat&&(b.FORMAT=
f.__gcxWmsImageFormat);c=(n=f.getMap())&&n.timeExtent?n.timeExtent.startTime:f.timeInfo&&f.timeInfo.timeExtent&&f.timeInfo.timeExtent.startTime;n=n&&n.timeExtent?n.timeExtent.endTime:f.timeInfo&&f.timeInfo.timeExtent&&f.timeInfo.timeExtent.endTime;c&&n&&(c=(new Date(c.getTime()-6E4*c.getTimezoneOffset())).toISOString(),n=(new Date(n.getTime()-6E4*n.getTimezoneOffset())).toISOString(),b.TIME=c+"/"+n);a=a.substring(0,a.lastIndexOf("?")+1)+dojo.objectToQuery(b)}m(a)}])}});c.essentials.MapService._wmsExtended=
!0}};b.prototype._hasTileLevels=function(){return this.tileInfo&&this.tileInfo.lods?0<this.tileInfo.lods.length?!0:!1:!1};b.prototype.applyCatalogLayersChange=function(a){var g=this,b=!1,d=[];if(this.id==a.mapServiceId){for(var l=0;l<a.entries.length;l++){var m=this.findLayerById(a.entries[l].id);m||(m=new c.essentials.Layer(this.url+"/layers/"+a.entries[l].id),a.entries[l].visible=!0,m.createFromDefinition(a.entries[l]),m.isUserCreated=!0,m.includeInLayerList=!0,m.setInActiveTheme(!0));d.push(m)}a=
this.layers.filter(function(a){return a.isUserCreated&&0>d.indexOf(a)});l=d.filter(function(a){return 0>g.layers.indexOf(a)});a.forEach(function(a){g.remove(a);b=!0});l.forEach(function(a){g.add(a);b=!0});return b?(dojo.publish("MapServiceLayersChangedWithResultEvent",{mapService:this,newItems:[].concat(l),oldItems:[].concat(a)}),dojo.publish("CatalogLayersChangedEvent",this),l):[]}};b.prototype.getLayerThemeSettings=function(a){for(var g=0;g<this.layerThemeSettings.length;g++){var b=this.layerThemeSettings[g];
if(b.theme===a||b.theme.id===a)return b}return null};b.prototype.getFeatureLayer=function(){var a=this;if(this._featureLayerPromise)return this._featureLayerPromise;var g;if(this.serviceLayer instanceof esri.layers.FeatureLayer)g=this.serviceLayer;else if(this.mapServiceType===h.MapServiceType.IMAGE){var b=this.serviceUrl;null!==this.serviceToken&&(b=b+(-1<b.indexOf("?")?"&token=":"?token=")+encodeURIComponent(this.serviceToken));g=new esri.layers.FeatureLayer(b)}else return Promise.resolve(null);
return this._featureLayerPromise=g.loaded?Promise.resolve(g):new Promise(function(b,c){var n=g.on("load",function(){n.remove();d.remove();b(g)}),d=g.on("error",function(b){n.remove();d.remove();a._featureLayerPromise=null;c(b)})})};b.prototype._resetUpdateTimer=function(){if(void 0!=this.updateInterval&&0!=this.updateInterval){void 0!=this._updateIntervalId&&window.clearInterval(this._updateIntervalId);var a=this;this._updateIntervalId=setInterval(function(){a._onUpdateIntervalTick()},1E3*this.updateInterval)}else window.clearInterval(this._updateIntervalId),
this._updateIntervalId=null};b.prototype._onUpdateIntervalTick=function(){this.serviceLayer&&this.serviceLayer.refresh&&(this.serviceLayer.setDisableClientCaching?(this.serviceLayer.setDisableClientCaching(!0),this.serviceLayer.refresh(),this.serviceLayer.setDisableClientCaching(this.disableClientCaching)):this.serviceLayer.refresh())};b.prototype._addToFilteredView=function(a){a&&this._layerThemeLayerFilter(a)&&this.layersFilteredView.push(a)};b.prototype._layerThemeLayerFilter=function(a){return a.mapService.essentialsMap.layerThemesInfo.layerThemesConfigured?
a.inActiveTheme:!0};b.prototype._getDefaultGeometryServiceUrl=function(){var a=this.essentialsMap?this.essentialsMap.site:null;return a&&a.geometryEndpoints&&0<a.geometryEndpoints.length?a.geometryEndpoints[0].geometryServiceUrl:null};b.prototype._getDefaultGeometryServiceToken=function(){var a=this.essentialsMap?this.essentialsMap.site:null;return a&&a.geometryEndpoints&&0<a.geometryEndpoints.length?a.geometryEndpoints[0].geometryServiceToken:null};b.prototype._corsRequest=function(a,b,n){var d=
this;return new c.framework.SimplePromise(function(c,m){try{require(["dojo/request"],function(f){b=!!b;n=!!n;return f(a,{headers:{"X-Requested-With":null},withCredentials:b}).response.then(function(a){return c()},function(f){return n?m(f):c(d._corsRequest(a,!b,!0))})})}catch(f){return m(f)}})};b._wmsExtended=!1;return b}(h.AsyncInitializable);h.MapService=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(h){var f=function(d){function b(a){d.call(this,a);this.color=[255,0,0];this.selectionColor=[0,255,255];this.disableClientCaching=!1;this.onDemandCacheSize=1E3;this.outFields="";this.queryMode=esri.layers.FeatureLayer.MODE_ONDEMAND;this.renderer=this.scaleEnabled=this.editVerticesEnabled=this.rotateEnabled=this.moveEnabled=this.canAddAttachments=this.canEdit=this.canDelete=this.canAdd=this.canUpdate=this.where=this.tileWidth=this.tileHeight=null;this._colorSet=!1;this._serviceLayer=
this._initialFeatureCollection=null;this.serviceUrl=a}__extends(b,d);b.prototype.getEmptyFeatureCollection=function(){return JSON.parse(this._initialFeatureCollection)};b.prototype.restoreFeatureLayer=function(){if(!this._serviceLayer._mode)switch(this._serviceLayer.mode){case esri.layers.FeatureLayer.MODE_SNAPSHOT:this._serviceLayer._mode=new esri.layers._SnapshotMode(this._serviceLayer);break;case esri.layers.FeatureLayer.MODE_ONDEMAND:this._serviceLayer._mode=new esri.layers._OnDemandMode(this._serviceLayer);
break;case esri.layers.FeatureLayer.MODE_SELECTION:this._serviceLayer._mode=new esri.layers._SelectionMode(this._serviceLayer)}this.replaceFeatureLayer(this._serviceLayer,!0,!0,!0);this.serviceLayer.resume();this.serviceLayer.mode===esri.layers.FeatureLayer.MODE_SNAPSHOT&&0===this.serviceLayer.graphics.length&&this.serviceLayer.refresh()};b.prototype.replaceFeatureLayer=function(a,b,c,d){var l=this.serviceLayer;if(!a)throw Error("featureLayer cannot be null in order to replace the feature layer.");
var m=this._getEsriMap();if(!m)throw Error("Unable to get access to the Esri map object to perform the Feature Layer replace.");if(!this.serviceLayer)throw Error("ServiceLayer not present. Can't replace the the FeatureLayer");b&&(a.visible=l.visible,a.setMaxScale(l.maxScale),a.setMinScale(l.minScale));c&&(a.opacity=l.opacity);d&&a.setRenderer(l.renderer);b=dojo.indexOf(m.graphicsLayerIds,l.id);this.serviceLayer=a;l.suspend();m.removeLayer(l);m.addLayer(a,b);l.url||this._cleanUpLayer(l)};b.prototype._cleanUpLayer=
function(a){a.clear();if(a._essentialsMetadata){a=a._essentialsMetadata.eventHandlers;for(var b=0,b=0;b<a.length;b++)dojo.disconnect(a[b])}};b.prototype.queryCount=function(a,b,c){this.isServiceLayerLoaded&&this.serviceLayer&&this.serviceLayer.queryCount(a,function(a){b&&b(a)},function(a){c&&c(a)})};b.prototype.queryFeatures=function(a,b,c){if(this.isServiceLayerLoaded&&this.serviceLayer)return this.serviceLayer.queryFeatures(a,b,c);a=Error("Esri layer has not finished loading");if(c)return c(a),
null;c=new dojo.Deferred;c.reject(a);return c};b.prototype.queryIds=function(a,b,c){if(this.isServiceLayerLoaded&&this.serviceLayer)return this.serviceLayer.queryIds(a,b,c);if(c)return a=Error("Esri layer has not finished loading"),c(a),c=new dojo.Deferred,c.reject(a),c};b.prototype.queryRelatedFeatures=function(a,b,c){if(this.isServiceLayerLoaded&&this.serviceLayer)return this.serviceLayer.queryRelatedFeatures(a,b,c);if(c)return a=Error("Esri layer has not finished loading"),c(a),c=new dojo.Deferred,
c.reject(a),c};b.prototype._getEsriMap=function(){var a=null;null!==this.essentialsMap&&null!==this.essentialsMap.site&&(a=this.essentialsMap.site.getMap());return a};b.prototype._configureObject=function(a,b){if(void 0===a||void 0===a.outFields||void 0===a.queryMode||void 0===a.where)throw Error("Incorrect map service object returned from initialization");this.disableClientCaching=!!a.disableClientCaching;this.onDemandCacheSize=void 0===a.onDemandCacheSize||null===a.onDemandCacheSize?this.onDemandCacheSize:
a.onDemandCacheSize;a.outFields||(a.outFields="*");this.outFields=a.outFields;this.where=a.where;if(void 0===a.queryMode)this.queryMode=esri.layers.FeatureLayer.MODE_ONDEMAND;else switch(a.queryMode){case "Selection":case "SelectionOnly":this.queryMode=esri.layers.FeatureLayer.MODE_SELECTION;break;case "Snapshot":this.queryMode=esri.layers.FeatureLayer.MODE_SNAPSHOT;break;default:this.queryMode=esri.layers.FeatureLayer.MODE_ONDEMAND}a.tileHeight&&(this.tileHeight=a.tileHeight);a.tileWidth&&(this.tileWidth=
a.tileWidth);a.selectionColor&&(this.selectionColor=a.selectionColor);a.color&&(this.color=a.color,this._colorSet=!0,3<this.color.length&&(this.color[3]/=255));this.editVerticesEnabled=a.hasOwnProperty("editVerticesEnabled")?a.editVerticesEnabled:!0;this.moveEnabled=a.hasOwnProperty("moveEnabled")?a.moveEnabled:!0;this.scaleEnabled=a.hasOwnProperty("scaleEnabled")?a.scaleEnabled:!0;this.rotateEnabled=a.hasOwnProperty("rotateEnabled")?a.rotateEnabled:!0;if(a.renderer)try{this.renderer=esri.renderer.fromJson(a.renderer)}catch(c){}d.prototype._configureObject.call(this,
a,b)};b.prototype._updateServiceToken=function(a){d.prototype._updateServiceToken.call(this,a);if(this.serviceLayer){var b=this.serviceLayer._task;b&&b._url&&b._url.query&&(b._url.query.token=a)}};b.prototype._createServiceLayer=function(){d.prototype._createServiceLayer.call(this);var a=this.serviceUrl;null!==this.serviceToken&&(a=a+"?token="+encodeURIComponent(this.serviceToken));var b={};b.id=this.id;b.opacity=this.configuredOpacity;b.visible=this._computeInitServiceLayerVisibility();this.outFields&&
0<this.outFields.length&&(b.outFields=this.outFields.split(","));null!==this.queryMode&&(b.mode=this.queryMode);null!==this.tileHeight&&null!==this.tileWidth&&this.queryMode==esri.layers.FeatureLayer.MODE_ONDEMAND&&(b.tileHeight=this.tileHeight,b.tileWidth=this.tileWidth);this.serviceLayer=new esri.layers.FeatureLayer(a,b);this.serviceLayer.setRenderer(this.renderer);this.attributionDataUrl&&""!==this.attributionDataUrl?(this.serviceLayer.attributionDataUrl=this.attributionDataUrl,this.serviceLayer.hasAttributionData=
!0):this.hasAttributionData&&(this.serviceLayer.attributionDataUrl=this.url+"/Attribution",this.serviceLayer.hasAttributionData=!0);this._serviceLayer=this.serviceLayer;this.where&&this.serviceLayer.setDefinitionExpression(this.where);dojo.connect(this.serviceLayer,"onError",this,this._layerLoadErrorHandler);this.serviceLayer.loaded?this._handleLayerLoadEvent(this.serviceLayer):dojo.connect(this.serviceLayer,"onLoad",dojo.hitch(this,this._handleLayerLoadEvent));d.prototype.initiateServiceFailureTimer.call(this)};
b.prototype._computeInitServiceLayerVisibility=function(){var a=this._initiallyVisible;a&&this.layers&&1===this.layers.length&&(a=this.layers[0].isVisible());return a};b.prototype._handleLayerLoadEvent=function(a){if(10>this.serviceLayer.version||this._colorSet){var b=null;if("esriGeometryPoint"==this.serviceLayer.geometryType){var b=new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE,15,null,new esri.Color(this.selectionColor)),c=new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE,
15,null,new esri.Color(this.color)),c=new esri.renderer.SimpleRenderer(c);this.serviceLayer.setRenderer(c)}else"esriGeometryPolyline"==this.serviceLayer.geometryType?(b=new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new esri.Color(this.selectionColor),1),c=new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new esri.Color(this.color),1),c=new esri.renderer.SimpleRenderer(c),this.serviceLayer.setRenderer(c)):"esriGeometryPolygon"==this.serviceLayer.geometryType&&
(b=new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new esri.Color([0,0,0]),1),new esri.Color(this.selectionColor)),c=new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new esri.Color([0,0,0]),1),new esri.Color(this.color)),c=new esri.renderer.SimpleRenderer(c),this.serviceLayer.setRenderer(c));this.serviceLayer.setSelectionSymbol(b)}b=
this.serviceLayer.getEditCapabilities();this.canUpdate=b.canUpdate;this.canAdd=b.canCreate;this.canDelete=b.canDelete;this.canEdit=this.serviceLayer.isEditable();this.canAddAttachments=!1;this.serviceLayer.capabilities&&(this.canAddAttachments=this.serviceLayer.version&&10.1<=this.serviceLayer.version&&this.serviceLayer.hasAttachments&&this.canEdit);this._initialFeatureCollection=JSON.stringify(this.serviceLayer.toJson());this._handleServiceLayerLoaded(a)};b.prototype.hasOriginRelationships=function(){if(this.serviceLayer&&
10.1<=this.serviceLayer.version&&this.serviceLayer.relationships&&0<this.serviceLayer.relationships.length)for(var a=0;a<this.serviceLayer.relationships.length;a++)if("esriRelRoleOrigin"===this.serviceLayer.relationships[a].role)return!0;return!1};b.prototype.getRelatedFeatureLayer=function(a,b,n){var d=new dojo.Deferred;if(10.1>this.serviceLayer.version)return a=Error("getRelatedFeatureLayer is only available for feature layer from ArcGIS 10.1 or greater."),d&&-1==d.fired&&d.resolve(a),"function"==
typeof n&&n(a),d;var l=this._getEsriRelation(a);if(!l)return a=Error("Relation not found: "+a),d&&d.reject(a),"function"==typeof n&&n(a),d;a=this.serviceUrl.substring(0,this.serviceUrl.lastIndexOf("/")+1)+l.relatedTableId;this.serviceToken&&(a+=-1<a.indexOf("?")?"&token=":"?token=",a+=encodeURIComponent(this.serviceToken));void 0===esri.getProxyRule(a)&&null!==this.proxyUrl&&esri.addProxyRule({urlPrefix:a,proxyUrl:this.proxyUrl});a=new esri.layers.FeatureLayer(a,{mode:esri.layers.FeatureLayer.MODE_SELECTION,
outFields:["*"]});dojo.connect(a,"onLoad",dojo.hitch(this,function(a){c.deferredResolve(d,a);"function"==typeof b&&b(a)}));dojo.connect(a,"onError",dojo.hitch(this,function(a){d&&-1==d.fired&&d.resolve(a);"function"==typeof n&&n(a)}));return d};b.prototype._getEsriRelation=function(a){"string"==typeof a&&(a=parseInt(a));if(this.serviceLayer.relationships)for(var b=0;b<this.serviceLayer.relationships.length;b++)if(this.serviceLayer.relationships[b].id==a)return this.serviceLayer.relationships[b];return null};
b.prototype._getRelation=function(a){return this.layers&&0<this.layers.length?this.layers[0]._getRelation(a):null};return b}(h.MapService);h.FeatureLayerService=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(c){var f=function(){function c(b,a,g,n){this.runtimeTypeName=null;this.name=b||null;this.typeName=a||null;this.isRequired=!!g;this.value=n||null}c.prototype._configureObject=function(b){if("undefined"==typeof b.name||"undefined"==typeof b.typeName)throw Error("Incorrect argument info object returned from initialization");this.name=b.name;this.typeName=b.typeName;this.isRequired=b.isRequired;this.value=b.value;this.runtimeTypeName=b.runtimeTypeName};c.prototype._internalClone=
function(){var b=new c(this.name,this.typeName,this.isRequired,dojo.clone(this.value));b.runtimeTypeName=dojo.clone(this.runtimeTypeName);return b};return c}();c.ArgumentInfo=f})(c.workflow||(c.workflow={}))})(geocortex||(geocortex={}));
(function(c){(function(h){var f=function(){function d(b,a,g,c,d,l,m,f,h){this.debug=!1;this.id=b||null;this.displayName=a||null;this.typeName=g||null;this.instanceId=c||null;this.externalId=d||null;this.syncToken=l||null;this.isComplete=m||!1;this.isAborted=!1;this.inputs=f||[];this.outputs=h||[]}d.prototype._configureObject=function(b){if("undefined"==typeof b.id||"undefined"==typeof b.displayName||"undefined"==typeof b.typeName||"undefined"==typeof b.instanceId)throw Error("Incorrect external activity info object returned from initialization");
this.id=b.id;this.displayName=b.displayName;this.typeName=b.typeName;this.instanceId=b.instanceId;this.externalId=b.externalId;this.syncToken=b.syncToken;this.isComplete=b.isComplete;b.debug&&(this.debug=b.debug);this.inputs=[];this.outputs=[];var a;if(b.inputs)for(a=0;a<b.inputs.length;a++){var g=b.inputs[a],n=new c.workflow.ArgumentInfo;n._configureObject(g);this.inputs[a]=n}if(b.outputs)for(a=0;a<b.outputs.length;a++)g=b.outputs[a],n=new c.workflow.ArgumentInfo,n._configureObject(g),this.outputs[a]=
n};return d}();h.ExternalActivityInfo=f})(c.workflow||(c.workflow={}))})(geocortex||(geocortex={}));
(function(c){(function(h){var f=function(d){function b(a){d.call(this,a);this.error=this.displayName=null;this.extensions=[];this.externalActivities={};this.id=null;this.properties={};this.site=null;this._inputs=[];this._outputs=[]}__extends(b,d);b.prototype.getInputs=function(){return this._cloneArgumentInfoCollection(this._inputs)};b.prototype.getOutputsMetadata=function(){return this._cloneArgumentInfoCollection(this._outputs)};b.prototype._cloneArgumentInfoCollection=function(a){var b=null;if(null!==
a)for(var b=[],c=0;c<a.length;c++)b.push(a[c]._internalClone());return b};b.prototype._configureObject=function(a,b){if(void 0===a.id||void 0===a.displayName)throw Error("Incorrect workflow object returned from initialization");var n,d;this.id=a.id;this.displayName=a.displayName;this.runOnStartup=!!a.runOnStartup;this.error=a.error;this._inputs=[];this._outputs=[];this.externalActivities=[];if(a.inputs)for(var l=0;l<a.inputs.length;l++)n=a.inputs[l],d=new c.workflow.ArgumentInfo,d._configureObject(n),
this._inputs[l]=d;if(a.outputs)for(l=0;l<a.outputs.length;l++)n=a.outputs[l],d=new c.workflow.ArgumentInfo,d._configureObject(n),this._outputs[l]=d;if(a.externalActivities)for(l=0;l<a.externalActivities.length;l++)n=a.externalActivities[l],d=new c.workflow.ExternalActivityInfo,d._configureObject(n),this.externalActivities[l]=d;this.properties=c._getProperties(a.properties);this.extensions=c._getExtensions(a.extensions)};return b}(h.AsyncInitializable);h.Workflow=f})(c.essentials||(c.essentials={}))})(geocortex||
(geocortex={}));
(function(c){(function(h){var f=function(d){function b(a){d.call(this,a);this.id=this.displayName=null;this._isLoading=!1;this._layerTypes=this._onLoadingError=this._onLoadingComplete=null;this._arcgisSharingRegularExpressions=[/(https?:\/\/.*?\/)home\/item.html\?id=(\w*)/,/(https?:\/\/.*?\/)home\/webmap\/viewer.html\?webmap=(\w*)/,/(https?:\/\/.*?\/)explorer\/\?open=(\w*)/,/(https?:\/\/.*?\/sharing)\/content\/items\/(\w*)\/data/,/(https?:\/\/.*?\/sharing)\/content\/items\/(\w*)/];this.site=null}
__extends(b,d);b.prototype.isLoading=function(){return this._isLoading};b.prototype._getUrlPortions=function(a){for(var b={id:null,path:null},c=0;c<this._arcgisSharingRegularExpressions.length;++c){var d=a.match(this._arcgisSharingRegularExpressions[c]);if(d&&0<d.length){b.id=d[2];b.path=d[1];break}}return b};b.prototype._loadWebMap=function(a,b,c){var d=this;if(!a||!a.path){var l="Web map with address "+b+" cannot be loaded.";b=esri.urlToObject(b);b.query=b.query||{};if(b.query&&(b.query.webmap||
b.query.id)){b=b.query.webmap||b.query.id;var m;esri.arcgis&&esri.arcgis.utils?m=esri.arcgis.utils.getItem:esri.arcgis.getItem&&(m=esri.arcgis.getItem);m&&m(b).then(function(a){a?this._processItemData(a.itemData):this._onLoadingError(Error(l));c.resolve(!1)})}else this._onLoadingError(Error(l)),c.resolve(!1)}else if(esri.arcgis&&esri.arcgis.Portal)(new esri.arcgis.Portal(a.path)).on("ready",function(b){b&&b.queryItems({q:"id:"+a.id}).then(function(a){a&&esri.request({url:a.results[0].itemDataUrl}).then(function(a){d._processItemData(a);
c.resolve(!1)})})})};b.prototype._initializeWebMap=function(a,b,c,d){var l=this;this.isLoading()?d&&d(Error("Currently loading web map.")):(this._isLoading=!0,b=new dojo.Deferred,this._onLoadingComplete=dojo.hitch(this,c),this._onLoadingError=dojo.hitch(this,d),this._layerTypes=this.site.webMapsInfo.layerTypes,c=this._getUrlPortions(a.url),this._loadWebMap(c,a.url,b),b.then(function(a){l._isLoading=a}))};b.prototype._processItemData=function(a){if(a){var b=a.operationalLayers;b&&this._processLayerCollection(b,
"Operational");(a=a.baseMap.baseMapLayers)&&this._processLayerCollection(a,"Base")}};b.prototype._processLayerCollection=function(a,b){var c=this;if(a){for(var d=[],l=0;l<a.length;++l){var m=a[l];this._layerTypes&&(!m.type&&0<=this._layerTypes.indexOf("Null")||m.type&&0<=this._layerTypes.indexOf(m.type))||(m=this._addLayerToMap(m),d.push(m))}(new dojo.DeferredList(d)).then(function(a){if(a){for(var d=[],k=0;k<a.length;++k){var l=a[k][1];l&&(0<l.length?d=d.concat(l):d.push(l))}0<d.length&&c.site.essentialsMap.addServiceLayers(d,
b)}},function(a){c._onLoadingError(Error("There was an error loading a layer: "+a))})}};b.prototype._addLayerToMap=function(a){var b=new dojo.Deferred,n=null;this.site.getMap();switch(a.type){case "CSV":var n=new dojo._Url(window.location.href),d=new dojo._Url(a.url);if(n.host!==d.host||n.port!==d.port||n.scheme!==d.scheme)a.url=esri.config.defaults.io.proxyUrl+a.url;c.essentials.utilities.LayerUtilities.createFeatureLayerFromCsv(a,null).then(function(c){c&&c.setVisibility&&c.setVisibility(a.visibility);
b.resolve(c)},function(a){b.reject(a)});break;case "GeoRSS":n=new h.GeoRssLayerService(a.url);n.essentialsMap=this.site.essentialsMap;d={displayName:a.title,serviceType:c.essentials.MapServiceType.GEORSS,connectionString:"url="+a.url,feedImageUri:a.pointSymbol?a.pointSymbol.url:null,opacity:a.opacity,id:a.id||c.framework.utils.alphaNumericToken(),visible:a.visibility};n._configureObject(d);b.resolve(n);break;case "WebTiledLayer":!a.wmtsInfo&&esri.layers&&esri.layers.WebTiledLayer&&(n=new esri.layers.WebTiledLayer(a.templateUrl,
{id:a.id,subDomains:a.subDomains,copyright:a.copyright}),a.title&&(n.name=a.title));b.resolve(n);break;case "WMS":b.resolve(null);break;default:n=null,a.url||a.featureCollection&&(n=this._addFeatureCollectionToMap(a.featureCollection)),b.resolve(n)}return b.promise};b.prototype._addFeatureCollectionToMap=function(a){var b=this.site.getMap(),n=[];dojo.forEach(a.layers,function(a){a=new esri.layers.FeatureLayer(a,{outSR:b.spatialReference});a.layerId=c.framework.utils.alphaNumericToken();n.push(a)});
return n};b.prototype._loadingRestComplete=function(a){this._isLoading=!1;!a&&this._onLoadingError&&this._onLoadingError(Error("No results"));a.error&&this._onLoadingError&&this._onLoadingError(a.error);this._onLoadingComplete&&this._onLoadingComplete(a.results)};b.prototype._loadingRestError=function(a){this._isLoading=!1;this._onLoadingError&&this._onLoadingError(a)};b.prototype._configureObject=function(a,b){if(void 0===a||void 0===a.id)throw Error("Incorrect Web Map reference object returned from initialization");
this.displayName=a.displayName;this.id=a.id;b&&(this.isInitialized=!0);this._initializeWebMap(a,this.site,function(a){},function(a){throw a;})};return b}(h.AsyncInitializable);h.WebMapReference=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));(function(c){(function(c){var f=function(){return function(){}}();c.MapGrid=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(c){var f=function(){return function(c,b){this.name=c;this.type=b}}();c.DistanceUnit=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){c=c.essentials||(c.essentials={});c=c.DistanceUnitType||(c.DistanceUnitType={});c.OTHER="Other";c.INCHES="Inches";c.FEET="Feet";c.US_SURVEY_FEET="USSurveyFeet";c.YARDS="Yards";c.MILES="Miles";c.NAUTICAL_MILES="NauticalMiles";c.MILLIMETERS="Millimeters";c.CENTIMETERS="Centimeters";c.DECIMETERS="Decimeters";c.METERS="Meters";c.KILOMETERS="Kilometers";c.DEGREES="Degrees";c.RADIANS="Radians";c.GRADS="Grads"})(geocortex||(geocortex={}));
(function(c){(function(c){var f;(function(b){b[b.NONE=-1]="NONE";b[b.RESIZE=0]="RESIZE";b[b.REPOSITION=1]="REPOSITION";b[b.EXTENT_CHANGE=2]="EXTENT_CHANGE"})(f||(f={}));var d=function(){function b(a,b){this._map=null;this._queuedExtentChangePriority=this._currentExtentChangePriority=-1;this._queuedExtentChange=[];this._fitTiledMapsToExtent=this._extentChangeInProgress=!1;this._newLayers=[];this.currentExtentChangeHandle=this._initialExtent=null;this._firstMapResizeExecuted=!1;this._map=a;this._fitTiledMapsToExtent=
!!b;this._map.on("resize",dojo.hitch(this,this._onResize));this._map.on("reposition",dojo.hitch(this,this._onReposition))}b.prototype.setInitialExtent=function(a){var b=this;if(this._map&&this._map.loaded)this._setInitialExtentImpl(a);else this._map.on("load",function(){return b._setInitialExtentImpl(a)})};b.prototype._setInitialExtentImpl=function(a){this._initialExtent=a;var b=esri.config.defaults.map.panDuration;esri.config.defaults.map.panDuration=0;this._map.reposition();this._map.setExtent(a,
this._fitTiledMapsToExtent);esri.config.defaults.map.panDuration=b;this._firstMapResizeExecuted=!0};b.prototype._onResize=function(a,b,c){this._firstMapResizeExecuted?this._handleNextExtentChange():(this._firstMapResizeExecuted=!0,this.firstResize())};b.prototype._onReposition=function(a,b){this._handleNextExtentChange()};b.prototype._onExtentChange=function(){this._extentChangeInProgress&&(this._currentExtentChangePriority=-1,this._extentChangeInProgress=!1,this._handleNextExtentChange())};b.prototype.registerLayer=
function(a){this._hasLoaded()||this._newLayers.push(a)};b.prototype.firstResize=function(){this._initialExtent&&this._map.extent&&!this._fitTiledMapsToExtent&&this._map.extent.expand(1.75).contains(this._initialExtent);this._handleNextExtentChange()};b.prototype._handleNextExtentChange=function(){if(this._hasLoaded())if(null!==this._queuedExtentChange[f.RESIZE]&&"undefined"!==typeof this._queuedExtentChange[f.RESIZE]){var a=this._queuedExtentChange[f.RESIZE];this._queuedExtentChange[f.RESIZE]=null;
a(this._map)}else null!==this._queuedExtentChange[f.REPOSITION]&&"undefined"!==typeof this._queuedExtentChange[f.REPOSITION]?(a=this._queuedExtentChange[f.REPOSITION],this._queuedExtentChange[f.REPOSITION]=null,a(this._map)):null!==this._queuedExtentChange[f.EXTENT_CHANGE]&&"undefined"!==typeof this._queuedExtentChange[f.EXTENT_CHANGE]&&(this._extentChangeInProgress=!0,this._currentExtentChangePriority=this._queuedExtentChangePriority,this._queuedExtentChangePriority=-1,a=this._queuedExtentChange[f.EXTENT_CHANGE],
this._queuedExtentChange[f.EXTENT_CHANGE]=null,a(this._map))};b.prototype.changeExtentWithPriority=function(a,b){var c=this,d="undefined"!==typeof b?b:5,l=function(b){null!==c.currentExtentChangeHandle&&c.currentExtentChangeHandle.cancel();c.currentExtentChangeHandle=a(b);c.currentExtentChangeHandle.then(dojo.hitch(c,c._onExtentChange),dojo.hitch(c,c._onExtentChange))};this._isExtentChangeBlocked()?d<this._queuedExtentChangePriority||(this._queuedExtentChangePriority=d,this._queuedExtentChange[f.EXTENT_CHANGE]=
l):d<this._currentExtentChangePriority||(this._currentExtentChangePriority=d,this._extentChangeInProgress=!0,l(this._map))};b.prototype.setExtentWithPriority=function(a,b){var c=this;this.changeExtentWithPriority(function(b){return b.setExtent(a,c._fitTiledMapsToExtent)},b)};b.prototype.centerAtWithPriority=function(a,b){this.changeExtentWithPriority(function(b){var g=b.extent.getCenter(),c=b.extent.getWidth()/b.width,d=b.extent.getHeight()/b.height;if(Math.abs(g.x-a.x)>=c||Math.abs(g.y-a.y)>=d)return b.centerAt(a);
b=new dojo.Deferred;b.resolve();return b},b)};b.prototype.setScaleWithPriority=function(a,b){this.changeExtentWithPriority(function(b){if(a!==b.getScale())return b.setScale(a);b=new dojo.Deferred;b.resolve();return b},b)};b.prototype.blockForResize=function(a,b,c){if(a!=this._map.width||b!=this._map.height)this._isResizeBlocked()?this._queuedExtentChange[f.RESIZE]=function(a){a.position.update(0,0);a.resize(c)}:(this._map.position.update(0,0),this._map.resize(c))};b.prototype.blockForReposition=function(){this._isRepositionBlocked()?
this._queuedExtentChange[f.REPOSITION]=function(a){a.position.update(0,0);a.resize()}:(this._map.position.update(0,0),this._map.resize())};b.prototype._isExtentChangeBlocked=function(){return null!=this._queuedExtentChange[f.REPOSITION]||null!=this._queuedExtentChange[f.RESIZE]||!this._hasLoaded()};b.prototype._isRepositionBlocked=function(){return this._extentChangeInProgress||!this._hasLoaded()};b.prototype._isResizeBlocked=function(){return this._isRepositionBlocked()};b.prototype._hasLoaded=function(){return this._map&&
this._map.loaded&&this._firstMapResizeExecuted};return b}();c.ExtentManager=d})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(h){var f=function(d){function b(a){d.call(this,a);this.baseMaps=[];this.initialExtent=this.fullExtent=null;this.fitTiledMapsToExtent=!1;this.mapServices=[];this.mapServicesFilteredView=[];this.primaryMapService=this.layerThemesInfo=null;this.supportedExportFormats="BMP JPEG PNG TIFF GeoTIFF PDF".split(" ");this.units=this.exportMapImageOptions=null;this.serviceLayersAdded=!1;this.spatialReference=this.extentManager=null;this.setExtentOnLoad=!0;this._onExportError=this._onExportComplete=
this._esriMap=null;this.originalUrl=a;this.url=h.utilities.UrlUtilities.simplify(a);this.layerThemesInfo=new c.essentials.LayerThemesInfo(this)}__extends(b,d);b.prototype.getMap=function(){return this._esriMap};b.prototype.allLayers=function(){for(var a=[],b=0;b<this.mapServices.length;b++)for(var c=this.mapServices[b],d=0;d<c.layers.length;d++)a.push(c.layers[d]);return a};b.prototype.allTables=function(){for(var a=[],b=0;b<this.mapServices.length;b++)for(var c=this.mapServices[b],d=0;d<c.tables.length;d++)a.push(c.tables[d]);
return a};b.prototype.allLayersAndTables=function(){var a=[],a=this.allLayers();return a=this.allTables().reduce(function(a,b){a.push(b);return a},a)};b.prototype.filteredLayers=function(){for(var a=[],b=0;b<this.mapServices.length;b++){var c=this.mapServices[b];this._layerThemeMapServiceFilter(c)&&(a=a.concat(c.layers))}return a};b.prototype.loadServiceLayersInMap=function(a){if(!a)throw Error("Must supply a map");this._esriMap=a;this.fitTiledMapsToExtent=!!a._fitTiledMapsToExtent;this.extentManager=
new h.ExtentManager(a,this.fitTiledMapsToExtent);for(var b=0;b<this.mapServices.length;b++){var c=this.mapServices[b],d=c.serviceLayer;d&&(this.extentManager.registerLayer(d),d.loaded||c.failureTimeoutThresholdExceeded?(this._layerLoadedUpdate(a),c._handleServiceLayerLoaded(d),c._handleDynamicLayers(d)):(dojo.connect(c,"onFailureTimeoutThresholdExceeded",dojo.hitch(this,this._layerLoadedUpdate,a)),dojo.connect(d,"onLoad",dojo.hitch(this,this._layerLoadedUpdate,a)),dojo.connect(d,"onError",dojo.hitch(this,
this._layerLoadedUpdate,a))))}};b.prototype.calculateScale=function(){return esri.geometry.getScale(this.site.getMap())};b.prototype._addServiceLayers=function(a){for(var b=this.mapServices.length-1;0<=b;b--)a.addLayer(this.mapServices[b].serviceLayer);this.setExtentOnLoad&&this.initialExtent&&this.extentManager.setInitialExtent(this.initialExtent);if(null!==this.site&&dojo.isObject(this.site)&&(this.site.serviceLayersLoaded=!0,dojo.isFunction(this.site.onServiceLayersLoaded)))this.site.onServiceLayersLoaded(this.site)};
b.prototype.addServiceLayers=function(a,b){var d=this,k=this;if(a||a.length){for(var l=[],m=function(a){var d=null,n=!1,m=c.essentials.MapServiceType.FEATURE;a.opacity=a.opacity||1;switch(a.type){case "Feature Layer":d=new c.essentials.FeatureLayerService(a.url);break;default:switch(a.declaredClass){case "esri.layers.WebTiledLayer":d=new c.essentials.MapService(a.tileServers[0]),m=c.essentials.MapServiceType.WEBTILED,n=!0}}if(d){d.serviceLayer=a;d.essentialsMap=k;var f=a.layerId||c.framework.utils.alphaNumericToken(),
n={id:f,isExpanded:!0,includeInLayerList:n,serviceFunction:b,serviceType:m,layerOptions:null};n.layerOptions={id:f,name:a.name,description:a.description,displayField:a.displayField,includeInLayerList:!0,identifiable:!0,fullExtent:a.fullExtent,primaryKeyField:a.objectIdField,visible:a.visible};d._createFrom(n);l.push(d);dojo.connect(a,"onClick",function(a){dojo.publish("FeatureClickedEvent",dojo.mixin(a,{layer:d.layers[0],useFeaturePresenter:!0}))})}},f=0;f<a.length;++f){var p=a[f];if(p instanceof
h.GeoRssLayerService)l.push(p);else{if(p.getFeatureLayers){var q=p,s=q.getFeatureLayers();if(s&&0<s.length){dojo.forEach(s,function(a){a.name=a.name||q.name;m(a)});continue}}m(p)}}this.mapServices=this.mapServices.concat(l);dojo.forEach(l,function(a){return d._addToFilteredView(a)});this._addServiceLayers(this.getMap());dojo.forEach(l,function(a){dojo.publish("MapServiceAddedEvent",a)})}};b.prototype.removeServiceLayer=function(a){if(a&&this.mapServices.length)for(var b=0;b<this.mapServices.length;b++){var c=
this.mapServices[b];if(c&&c.serviceLayer&&c.serviceLayer===a){this.mapServices.splice(b,1);dojo.publish("MapServiceRemovedEvent",c);break}}};b.prototype.addMapService=function(a){var b=this.getMap(),c=this.site;a.isUserCreated=!0;a.includeInLayerList=!(a instanceof h.FeatureLayerService);a.opacity=1;for(var d=0,l=a.layers;d<l.length;d++){var m=l[d];m.isUserCreated=!0;m.includeInLayerList=!0;m.includeInLegend=!0;m.site=c;m.configuredVisible=!0;a.supportsLayerVisibility()?m.setVisibility(!0):m._visible=
!0}a.essentialsMap=this;this.mapServices.push(a);b.addLayer(a.serviceLayer);dojo.publish("MapServiceAddedEvent",a);a.setVisibility(!0)};b.prototype.removeMapService=function(a){if(a){var b=this.mapServices.indexOf(a);0<=b&&(this.mapServices.splice(b,1),dojo.publish("MapServiceRemovedEvent",a));this._esriMap&&a.serviceLayer&&this._esriMap.removeLayer(a.serviceLayer)}};b.prototype._configureMapServices=function(a,b){for(var d=0;a&&d<a.length;d++){var k=a[d],l=this.originalUrl+"/mapservices/"+k.id;if(k.drawingBehavior==
c.essentials.DrawingBehavior.FEATURE_LAYER){if(!dojo.isObject(esri.layers.FeatureLayer))throw Error("This Javascript application must // dojo.require the esri.layers.FeatureLayer package in order to use a site with feature layers");this.mapServices[d]=new c.essentials.FeatureLayerService(l)}else if(k.drawingBehavior==c.essentials.DrawingBehavior.GEORSS_LAYER){if(!dojo.isObject(esri.layers.GraphicsLayer))throw Error("This Javascript application must // dojo.require the esri.layers.GraphicsLayer package in order to use a site with GeoRSS layers");
this.mapServices[d]=new c.essentials.GeoRssLayerService(l)}else if(k.drawingBehavior==c.essentials.DrawingBehavior.KML_SERVICE){if(!dojo.isObject(esri.layers.KMLLayer))throw Error("This Javascript application must // dojo.require the esri.layers.KMLLayer package in order to use a site with KML layers");this.mapServices[d]=new c.essentials.KmlService(l)}else this.mapServices[d]=new c.essentials.MapService(l);this.mapServices[d].essentialsMap=this;this.mapServices[d].initialize(k);dojo.publish("ServiceLayerInitializedEvent",
this.mapServices[d].serviceLayer);this._addToFilteredView(this.mapServices[d])}};b.prototype._configureObject=function(a,b){if(void 0===a||void 0===a.mapServices)throw Error("Incorrect map object returned from initialization");a.initialExtent&&(this.initialExtent=new esri.geometry.Extent(a.initialExtent));a.fullExtent&&(this.fullExtent=new esri.geometry.Extent(a.fullExtent));a.units&&(this.units=new c.essentials.DistanceUnit(a.units.name,a.units.type));a.exportOptions&&(this.exportMapImageOptions=
new c.essentials.ExportMapImageOptions(a.exportOptions.allowIncludeGeoreferenceData,a.exportOptions.defaultOutputFormat));a.layerThemes&&(a.layerThemes.items&&a.layerThemes.items.length||a.layerThemes.allowDefault)&&this._configureLayerThemesInfo(a.layerThemes);this._configureMapServices(a.mapServices,b);dojo.isArray(a.baseMaps)&&this._configureBaseMaps(a.baseMaps);b&&(this.isInitialized=!0);this.primaryMapService=this.findMapServiceById(a.primaryMapServiceID)};b.prototype.findMapServiceById=function(a){for(var b=
0;b<this.mapServices.length;b++)if(this.mapServices[b].id==a)return this.mapServices[b];return null};b.prototype.setFeatureLayerExclusivelyVisible=function(a){for(var b=this.site.getFeatureServices(),c=0;c<b.length;c++){var d=b[c];d.setVisibility(d.serviceLayer.id===a.id)}};b.prototype.exportMap=function(a,b,d){var k=this;this._onExportComplete=b;this._onExportError=d;b=new c.essentials.exportMap.ExportMapTask(this);d=new c.essentials.exportMap.ExportMapParameters;d.reportParameters=a;b.generateMapImageUrl(d).then(function(a){return k._exportRestComplete(a)},
function(a){return k._exportRestError(a)})};b.prototype.findLayerFromMatchingEsriFeatureLayer=function(a){if(a){for(var b=0;b<this.mapServices.length;b++){var c=this.mapServices[b];if(c.serviceLayer instanceof esri.layers.FeatureLayer){var d=c.serviceLayer;if(d.layerId==a.layerId&&d.name==a.name&&0<c.layers.length)return c.layers[0]}}for(var d=function(a,b){var g=a.serviceUrl;a.serviceToken&&0<b.search(/token=.[^&]*/g)&&(g+="?token="+a.serviceToken);return g},l=a.url.match(/.[^?]*/g)[0],b=0;b<this.mapServices.length;b++){var c=
this.mapServices[b],m=d(c,l);if(m===l&&0<c.layers.length)return c.layers[0]}a=Number(l.match(/[^/]*.$/));l=l.replace(/\/[^/]*.$/,"");for(b=0;b<this.mapServices.length;b++)if(c=this.mapServices[b],m=d(c,l),m===l){if(m=c.findLayerOrTableById(a.toString()))return m;if(c.layers.length>=a)return c.layers[a]}return null}};b.prototype._exportRestComplete=function(a){var b=null;a?a.error&&(b=a.error):b=Error("No results");b&&this._onExportComplete&&this._onExportError(b);a&&this._onExportComplete&&this._onExportComplete(a)};
b.prototype._exportRestError=function(a){this._onExportError&&this._onExportError(a)};b.prototype._layerLoadedUpdate=function(a){if(!this.serviceLayersAdded){for(var b=0;b<this.mapServices.length;b++){var c=this.mapServices[b],d=c.serviceLayer;!c.initializationFailure&&c.failureTimeoutThresholdExceeded&&(c.initializationFailure=Error("Map Service - {0}: Failure timeout threshold exceeded.".format(c.id)));if(!d.loaded&&!c.initializationFailure&&!c.failureTimeoutThresholdExceeded)return}this.serviceLayersAdded=
!0;(this.spatialReference=this.primaryMapService.serviceLayer.spatialReference)&&this.spatialReference.wkt&&this._switchSpatialReferenceGlobally(this.spatialReference);this._esriMap.spatialReference||(this._esriMap.spatialReference=this.spatialReference||this.initialExtent.spatialReference||this.fullExtent.spatialReference);!this._esriMap.extent&&this.initialExtent&&this._esriMap.setExtent(new esri.geometry.Extent(this.initialExtent.toJson()));this._addServiceLayers(a)}};b.prototype.applyCatalogLayersChange=
function(a){a&&(this._applyCatalogChangesToDynamicLayers(a),this._applyCatalogChangesToWmsLayers(a))};b.prototype.applyStartupTheme=function(){this.layerThemesInfo.layerThemesConfigured&&this.layerThemesInfo.applyTheme(this.layerThemesInfo.startupThemeId||this.layerThemesInfo.themes[0].id)};b.prototype.refreshFilteredCollections=function(){var a=this;this.mapServicesFilteredView.length=0;dojo.forEach(this.mapServices,function(b){return a._addToFilteredView(b)});for(var b=0;b<this.mapServices.length;b++)this.mapServices[b].refreshFilteredCollections()};
b.prototype._switchSpatialReferenceGlobally=function(a){this.initialExtent&&(this.initialExtent=new esri.geometry.Extent(this.initialExtent.xmin,this.initialExtent.ymin,this.initialExtent.xmax,this.initialExtent.ymax,a));this.fullExtent&&(this.fullExtent=new esri.geometry.Extent(this.fullExtent.xmin,this.fullExtent.ymin,this.fullExtent.xmax,this.fullExtent.ymax,a));if(this.site.hasNamedExtents&&this.site.namedExtents&&this.site.namedExtents.length)for(var b=0;b<this.site.namedExtents.length;b++){var c=
this.site.namedExtents[b];c.extent=new esri.geometry.Extent(c.extent.xmin,c.extent.ymin,c.extent.xmax,c.extent.ymax,a)}this._esriMap.spatialReference=a};b.prototype._applyCatalogChangesToWmsLayers=function(a){};b.prototype._applyCatalogChangesToDynamicLayers=function(a){var b=a.mapServiceId,d=[],k=new c.essentials.catalog.LayerCatalogDetail;k.mapServiceId=b;for(var l=0;l<a.entries.length;l++)a.entries[l].isDynamic&&d.push(a.entries[l]);k.entries=d;(a=this.findMapServiceById(b))&&a.applyCatalogLayersChange(k)};
b.prototype._configureLayerThemesInfo=function(a){var b=this;if(!a)throw Error("RestLayerThemesInfo object not defined. Cannot configure layer themes.");this.layerThemesInfo.layerThemesConfigured=!0;this.layerThemesInfo.allowDefault=void 0!=a.allowDefault?a.allowDefault:!0;this.layerThemesInfo.startupThemeId=a.startupThemeID;this.layerThemesInfo.allowDefault&&this.layerThemesInfo.themes.push(new h.LayerTheme(this.layerThemesInfo,null,a.defaultThemeDisplayName||""));a.items&&a.items.length&&dojo.forEach(a.items,
function(a){b.layerThemesInfo.themes.push(new h.LayerTheme(b.layerThemesInfo,a))})};b.prototype._addToFilteredView=function(a){a&&this._layerThemeMapServiceFilter(a)&&this.mapServicesFilteredView.push(a)};b.prototype._layerThemeMapServiceFilter=function(a){return a.essentialsMap.layerThemesInfo.layerThemesConfigured?a.inActiveTheme:!0};b.prototype._configureBaseMaps=function(a){var b=this;a.forEach(function(a){var d=new h.BaseMap(b);d.displayName=a.displayName;d.id=a.id;a.iconUri&&(d.iconUri=c.essentials.RestHelper.processClientSideTokens(b.site,
a.iconUri));a.exportTilesMapServiceUri&&(d.exportTilesMapServiceUri=c.essentials.RestHelper.processClientSideTokens(b.site,a.exportTilesMapServiceUri));d.properties=c._getProperties(a.properties);d.extensions=c._getExtensions(a.extensions);dojo.isArray(a.mapServices)&&a.mapServices.forEach(function(a){(a=b.findMapServiceById(a.id))&&d.services.push(new h.BaseMapService(a))});b.baseMaps.push(d)})};return b}(h.AsyncInitializable);h.Map=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(c){var f=function(){return function(c,b){this.displayName=c;this.scale=b}}();c.Scale=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));(function(c){(function(c){var f=function(){return function(c,b){void 0!==c&&(this.displayName=c);void 0!==b&&(this.dpi=b)}}();c.Resolution=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(c){var f=function(){return function(c,b,a,g){this.id=c;this.displayName=b;this.value=a;this.multiline=g}}();c.TextField=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(h){var f=function(){function d(){this.customExtent=null;this.extentType="currentExtent";this.fields=[];this.scale=this.resolution=this.featureIds=this.outputFormat=this.notificationEmailAddress=this.imageWidth=this.imageHeight=this.grid=null}d.prototype.toJson=function(b,a){if(!b||!a)throw Error("Reporting parameter creation is missing a main map.");var g={},d,k,l=this.scale&&void 0!=this.scale.scale&&!isNaN(parseFloat(this.scale.scale))?parseFloat(this.scale.scale):b.getScale();
this.scale&&void 0!=this.scale.scale&&(g.scale=this.scale.scale);this.extentType==c.essentials.ReportParameters.CURRENT_EXTENT&&null!==b?d=b.extent:this.extentType==c.essentials.ReportParameters.FULL_EXTENT&&null!==a?d=a.fullExtent:this.extentType==c.essentials.ReportParameters.INITIAL_EXTENT&&null!==a?d=a.initialExtent:this.extentType==c.essentials.ReportParameters.CUSTOM_EXTENT&&null!==this.customExtent&&(d=this.customExtent);d&&(d.spatialReference&&(k=d.spatialReference.toJson())&&(k.wkid&&0<k.wkid?
g.bboxSR=k.wkid:k.wkt&&(g.bboxSR=k.wkt)),g.bbox=d.xmin+","+d.ymin+","+d.xmax+","+d.ymax);this.targetSpatialReference&&(k=this.targetSpatialReference.toJson())&&(k.wkid&&0<k.wkid?g.targetSR=k.wkid:k.wkt&&(g.targetSR=k.wkt));this.notificationEmailAddress&&(g.emailAddress=this.notificationEmailAddress);this.imageHeight&&0<this.imageHeight&&(g.imageHeight=this.imageHeight);this.imageWidth&&0<this.imageWidth&&(g.imageWidth=this.imageWidth);b.timeExtent&&(g.time="",g.time=b.timeExtent.startTime?g.time+
b.timeExtent.startTime.getTime():g.time+"null",g.time+=",",g.time=b.timeExtent.endTime?g.time+b.timeExtent.endTime.getTime():g.time+"null");k=[];if(null!==a){var m="",f="",h="";for(d=0;d<a.mapServices.length;d++){var q=a.mapServices[d],s="",t=q.serviceLayer,u,v="";if(t)if(!0===t.visible&&(f+=(""===f?"":";")+q.id+":"+t.opacity),q.mapServiceType===c.essentials.MapServiceType.DYNAMIC){u=t.layerDefinitions;var x=0,w;for(w in u)0<x&&(v+=","),v+='"'+w+'":"'+u[w].replace(/\\/g,"\\\\").replace(/"/g,'\\"')+
'"',x++;0<x&&(1<h.length&&(h+=","),h+='"'+q.id+'":{',h+=v,h+="}");if(!0===t.visible&&!0===t.isVisibleAtScale(l))if(t instanceof esri.layers.ArcGISDynamicMapServiceLayer)u=t,u.visibleLayers&&"-1"!==u.visibleLayers.toString()&&(s=u.visibleLayers.toString());else if(!q.layers||0===q.layers.length)s="*";else if(q.layers&&0<q.layers.length)for(u=0;u<q.layers.length;u++)v=q.layers[u],v.isVisible()&&v.areAllAncestorsVisible()&&(s+=(0===s.length?"":",")+v.id)}else if(!0===t.visible&&!0===t.isVisibleAtScale(l))if(!q.layers||
0===q.layers.length)s="*";else if(q.layers&&0<q.layers.length)for(u=0;u<q.layers.length;u++)v=q.layers[u],v.isVisible()&&v.areAllAncestorsVisible()&&(s+=(0===s.length?"":",")+v.id);u=q.id;u=0===s.length?u+"(hide:*)":u+("(show:"+s+")");m+=(0===m.length?"":";")+u;if(q instanceof c.essentials.FeatureLayerService){s={};s.id=q.id;(u=t.getSelectionSymbol())&&u.color&&(u=u.color.toRgba(),s.selectionColor={r:u[0],g:u[1],b:u[2],a:u[3]});s.mode=q.queryMode;if(q=t.getDefinitionExpression())s.where=q;t.renderer&&
(s.renderer=t.renderer.toJson());s.selectedFeatures=[];if((q=t.getSelectedFeatures())&&0<q.length&&(t=t.objectIdField))for(u=0;u<q.length;u++)v=q[u],v.attributes&&(v=v.attributes[t])&&s.selectedFeatures.push(v);k.push(s)}}0<h.length&&(g.layerDefinitions="{"+h+"}");0<m.length&&(g.layers=m);0<f.length&&(g.opacity=f)}0<k.length&&(g.featureLayerOptions=k);this.outputFormat&&(g.outputFormat=this.outputFormat);this.featureIds&&(g.featureIds=this.featureIds);this.resolution&&(g.dpi=this.resolution.dpi);
this.mapGraphicsLayers&&(g.graphics=this.mapGraphicsLayers.layers,g.symbols=this.mapGraphicsLayers.symbols);this.includeData&&(g.of=g.of?g.of+",includeData":"includeData");this.includeGeoreferenceData&&(g.georef=this.includeGeoreferenceData);this.useTransparentBackground&&(g.useTransparentBackground=this.useTransparentBackground);for(l=0;l<this.fields.length;l++)w=this.fields[l],g[w.id]=w.value;this.grid&&(g.grid=this.grid.id);return g};d.prototype.populateMapGraphicsLayers=function(b){this.mapGraphicsLayers=
{layers:[],symbols:[]};this._extractGraphicInformation(b.graphics,this.mapGraphicsLayers.layers,this.mapGraphicsLayers.symbols);for(var a=0;a<b.graphicsLayerIds.length;a++){var g=b.getLayer(b.graphicsLayerIds[a]);!g.visible||g instanceof esri.layers.FeatureLayer&&g.url||this._extractGraphicInformation(g,this.mapGraphicsLayers.layers,this.mapGraphicsLayers.symbols)}};d.prototype._extractGraphicInformation=function(b,a,g){for(var d=0;d<b.graphics.length;d++){var k=b.graphics[d];if(k.visible){var l=
{},m=null;k.symbol?m=k.symbol:b.renderer&&b.renderer.getSymbol&&(m=b.renderer.getSymbol(k),k.symbol=m);if(m){g.push(m);for(var f=0;f<g.length-1;f++)if(g[f]==m){l.symbolID=g[f].id;m.id=l.symbolID;g.pop();break}void 0==l.symbolID&&(m=g.length-1,g[m]instanceof esri.symbol.TextSymbol?g[m]=c.essentials.utilities.PrintUtilities.adjustTextSymbol(k,b.id):g[m]instanceof esri.symbol.PictureMarkerSymbol&&(g[m]=c.essentials.utilities.PrintUtilities.adjustPictureMarkerSymbol(k)),l.symbolID=(g.length-1).toString(),
g[l.symbolID].id=l.symbolID);l.geometry=k.geometry;a.push({elements:[l],opacity:b.opacity})}}}};d.CURRENT_EXTENT="currentExtent";d.CUSTOM_EXTENT="customExtent";d.FULL_EXTENT="fullExtent";d.INITIAL_EXTENT="initialExtent";return d}();h.ReportParameters=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(h){var f=function(d){function b(a){d.call(this,a);this.displayName=this.description=null;this.extensions=[];this.visible=this.id=null;this.maximumResolution=300;this.site=this.properties=null;this.supportedMapScales=[];this.supportedOutputFormats=[];this.supportedResolutions=[];this.supportsEmailNotification=!1;this.textFields=[];this.grids=[];this.type=c.essentials.ReportType.MAP_TEMPLATE_REPORT;this.isDefault=!1;this.defaultOutputFormat=this.defaultGrid=this.defaultResolution=
this.defaultMapScaleName=this.defaultMapScale=null;this._printing=!1;this._onPrintError=this._onPrintComplete=null;this.extensions=[];this.properties=[];this.supportedMapScales=[];this.supportedOutputFormats=[];this.supportedResolutions=[];this.textFields=[]}__extends(b,d);b.prototype.isPrinting=function(){return this._printing};b.prototype.print=function(a,b,d){var k=this;this.isPrinting()?d&&d(Error("Template already printing")):(this._onPrintComplete=b,this._onPrintError=d,this._printing=!0,b=
new c.essentials.exportMap.ExportMapParameters,b.reportParameters=a,(new c.essentials.exportMap.ExportMapTask(this)).generateMapImageUrl(b).then(function(a){return k._printRestComplete(a)},function(a){return k._printRestError(a)}))};b.prototype._configureObject=function(a,b){if(void 0===a||void 0===a.id||void 0===a.displayName)throw Error("Incorrect print template object returned from initialization");this.description=void 0===a.description?this.description:a.description;this.displayName=a.displayName;
this.id=a.id;this.visible=void 0===a.visible?!0:a.visible;this.mainMapWidth=a.mainMapWidth;this.mainMapHeight=a.mainMapHeight;this.maximumResolution=void 0===a.maximumResolution?this.maximumResolution:a.maximumResolution;this.supportedMapScales=void 0===a.supportedScales?this.supportedMapScales:a.supportedScales;this.supportedOutputFormats=void 0===a.supportedOutputFormats?this.supportedOutputFormats:a.supportedOutputFormats;this.supportedResolutions=void 0===a.supportedResolutions?this.supportedResolutions:
a.supportedResolutions;this.supportsEmailNotification=!!a.supportsEmailNotification;this.textFields=void 0===a.textFields?this.textFields:a.textFields;this.grids=void 0===a.grids?this.grids:a.grids;b&&(this.isInitialized=!0);this.properties=c._getProperties(a.properties);this.extensions=c._getExtensions(a.extensions);this.isDefault=void 0===a.isDefault?this.isDefault:a.isDefault;if(this.defaultMapScaleName=void 0===a.defaultMapScale?null:a.defaultMapScale)for(var d=0;d<this.supportedMapScales.length;d++)this.defaultMapScaleName===
this.supportedMapScales[d].displayName&&(this.defaultMapScale=this.supportedMapScales[d]);var k=void 0===a.defaultResolution?null:a.defaultResolution;if(k)for(d=0;d<this.supportedResolutions.length;d++)k===this.supportedResolutions[d].displayName&&(this.defaultResolution=this.supportedResolutions[d]);if(k=void 0===a.defaultGrid?null:a.defaultGrid)for(d=0;d<this.grids.length;d++)k===this.grids[d].displayName&&(this.defaultGrid=this.grids[d]);this.defaultOutputFormat=void 0===a.defaultOutputFormat?
this.defaultOutputFormat:a.defaultOutputFormat};b.prototype._printRestComplete=function(a){this._printing=!1;var b=null;a?a.error&&(b=a.error):b=Error("Unexpected Error");b?this._onPrintError&&this._onPrintError(b):this._onPrintComplete&&this._onPrintComplete(a)};b.prototype._printRestError=function(a){this._printing=!1;this._onPrintError&&this._onPrintError(a)};return b}(h.AsyncInitializable);h.PrintTemplate=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(h){var f=function(d){function b(a){d.call(this,a);this.displayName=null;this.extensions=[];this.id=this.extent=null;this.properties={};this.site=null}__extends(b,d);b.prototype.navigateTo=function(){if(this.site){var a=this.site.essentialsMap;a&&a.extentManager.setExtentWithPriority(this.extent,10)}};b.prototype._configureObject=function(a,b){if(void 0===a||void 0===a.id||void 0==a.displayName||void 0===a.extent)throw Error("Incorrect named extent object returned from initialization");
this.id=a.id;this.displayName=a.displayName;this.extent=new esri.geometry.Extent(a.extent);this.properties=c._getProperties(a.properties);this.extensions=c._getExtensions(a.extensions)};return b}(h.AsyncInitializable);h.NamedExtent=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(h){var f=function(d){function b(a){d.call(this,a);this.displayName=null;this.extensions=[];this.id=null;this.properties={};this.site=this.geoprocessorUrl=this.geoprocessorType=null}__extends(b,d);b.prototype._configureObject=function(a){if(void 0===a.id||void 0===a.displayName||void 0===a.connectionString)throw Error("Incorrect geoprocessing endpoint object returned from initialization");this.id=a.id;this.displayName=a.displayName;this.geoprocessorType=a.geoprocessorType||a.serviceType;
this._processConnectionString(a.connectionString);this.properties=c._getProperties(a.properties);this.extensions=c._getExtensions(a.extensions)};b.prototype._processConnectionString=function(a){var b=c.essentials.ServiceHelper.extractConnectionStringValue;if(this.geoprocessorType===c.essentials.GeoprocessingEndpointType.ARCGIS_GEOPROCESSOR)(a=b(a,"url"))&&0<a.length&&(this.geoprocessorUrl=a);else throw Error("Unknown geoprocessor type '"+this.geoprocessorType+"'");};return b}(h.AsyncInitializable);
h.GeoprocessingEndpoint=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));(function(c){c=c.essentials||(c.essentials={});(c.GeoprocessingEndpointType||(c.GeoprocessingEndpointType={})).ARCGIS_GEOPROCESSOR="ArcGisGeoprocessor"})(geocortex||(geocortex={}));
(function(c){(function(h){var f=function(d){function b(a){d.call(this,a);this.displayName=null;this.extensions=[];this.id=null;this.properties={};this.site=this.geometryServiceToken=this.geometryServiceUrl=this.geometryServiceType=null}__extends(b,d);b.prototype._configureObject=function(a){if(void 0===a.id||void 0===a.displayName||void 0===a.connectionString)throw Error("Incorrect geometry endpoint object returned from initialization");this.id=a.id;this.displayName=a.displayName;this.geometryServiceType=
a.serviceType;this._processConnectionString(a.connectionString);this.properties=c._getProperties(a.properties);this.extensions=c._getExtensions(a.extensions)};b.prototype._processConnectionString=function(a){var b=c.essentials.ServiceHelper.extractConnectionStringValue;if(this.geometryServiceType===c.essentials.GeometryEndpointType.ARCGIS_GEOMETRY){var d=b(a,"url");d&&0<d.length&&(this.geometryServiceUrl=d);this.geometryServiceToken=b(a,"token")}};return b}(h.AsyncInitializable);h.GeometryEndpoint=
f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));(function(c){c=c.essentials||(c.essentials={});(c.GeometryEndpointType||(c.GeometryEndpointType={})).ARCGIS_GEOMETRY="ArcGisGeometry"})(geocortex||(geocortex={}));
(function(c){(function(c){var f=function(){function c(){}c.extractConnectionStringValue=function(b,a){if(0<b.length){var g=b.match("(^|;)[s]*"+a+"=([^;]*)");if(null!==g)return g[2]}return""};return c}();c.ServiceHelper=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(h){var f=function(d){function b(a){d.call(this,a);this.displayName=this.bingProperties=null;this.extensions=[];this.id=null;this.properties={};this.geocoderToken=this.geocoderUrl=this.geocoderType=null;this.includeInGlobalSearch=!1;this.iconUri=null;this.isDefaultReverseGeocoder=!1;this.site=null;this.parameters=[];this.globalSearchKey=null;this.isDefaultBatchGeocoder=!1}__extends(b,d);b.prototype._configureObject=function(a){if(!(a.hasOwnProperty("id")&&a.hasOwnProperty("displayName")&&
a.hasOwnProperty("serviceType")&&a.hasOwnProperty("connectionString")&&a.hasOwnProperty("globalSearchKey")&&a.hasOwnProperty("parameters")))throw Error("Incorrect geocoding endpoint object returned from initialization");this.id=a.id;this.displayName=a.displayName;this.iconUri=a.iconUri;this.geocoderType=a.serviceType;this.includeInGlobalSearch=a.includeInGlobalSearch;this.isDefaultReverseGeocoder=a.isDefaultReverseGeocoder;this.globalSearchKey=a.globalSearchKey;this.isDefaultBatchGeocoder=a.isDefaultBatchGeocoder;
this._processConnectionString(a.connectionString);this.properties=c._getProperties(a.properties);this.extensions=c._getExtensions(a.extensions);this.parameters=a.parameters};b.prototype._processConnectionString=function(a){var b=c.essentials.ServiceHelper.extractConnectionStringValue;if(this.geocoderType===c.essentials.GeocodingEndpointType.BING_GEOCODER){this.bingProperties={};var d=b(a,"key");d&&0<d.length&&(this.bingProperties.bingMapsKey=d);(d=b(a,"culture"))&&0<d.length&&(this.bingProperties.culture=
d)}else this.geocoderType===c.essentials.GeocodingEndpointType.ARCGIS_GEOCODER&&((d=b(a,"url"))&&0<d.length&&(this.geocoderUrl=d),this.geocoderToken=b(a,"token"))};return b}(h.AsyncInitializable);h.GeocodingEndpoint=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));(function(c){c=c.essentials||(c.essentials={});c=c.GeocodingEndpointType||(c.GeocodingEndpointType={});c.ARCGIS_GEOCODER="ArcGisGeocoder";c.BING_GEOCODER="BingGeocoder"})(geocortex||(geocortex={}));
(function(c){(function(c){(function(c){var d=function(){function b(){}b.equals=function(a,b){return a&&b&&(a===b||c.StringUtilities.endsWith(a,this.separator+b))?!0:!1};b.lookUp=function(a,b){if(a&&b){for(var d=0,k=null,d=0;d<a.length;++d)if(k=a[d],k.id===b)return k;for(d=0;d<a.length;++d)if(k=a[d],c.StringUtilities.endsWith(k.id,this.separator+b))return k}return null};b.separator="-";return b}();c.SiteResourceIdComparer=d})(c.utilities||(c.utilities={}))})(c.essentials||(c.essentials={}))})(geocortex||
(geocortex={}));
(function(c){(function(c){var f=function(){function c(){this.finished=!1;this.id=(new Date).valueOf().toString();this.scripts=[]}c.getCurrent=function(){var b=window.security;return b&&!b.finished?b:null};c.beginRefresh=function(b){if(null!=c.getCurrent())return!1;var a=new c;a.site=b;if(!a.getExpirationNoticeUrl()||!a.getRefreshUrl())return!1;window.security=a;a.openFrame();return!0};c.cancel=function(){var b=c.getCurrent();return b&&b.finish()};c.prototype.openSystemBrowser=function(){var b=this,
a=this.getRefreshUrl()+"&app="+this.site.signInRedirectUri+"&token_type=fragment",g=/GeocortexApp\.iOS/.test(navigator.userAgent)?"_system":"_blank",c=function(){var a=location.hash;0<a.length&&a.startsWith("#gcx-")&&(window.removeEventListener?window.removeEventListener("popstate",c,!1):window.detachEvent&&window.detachEvent("onpopstate",c),a=a.substring(5),b.sendRequest(b.site.url+"?f=json&callback=security.updateSitePrincipal&token="+a))};window.addEventListener?window.addEventListener("popstate",
c,!1):window.attachEvent&&window.attachEvent("onpopstate",c);window.open(a,g)};c.prototype.openFrame=function(){var b=this;this.frame=document.createElement("iframe");this.frame.name="SignInHelper";this.frame.style.display="none";document.body.appendChild(this.frame);/\bGeocortexApp\b/.test(navigator.userAgent)?this.frame.src="SignInHelper.html":(window.open("SignInHelper.html","SignInHelper"),window.setTimeout(function(){return b.openPopup()},15E3))};c.prototype.openPopup=function(){this.finished||
(this.sendRequest(this.getExpirationNoticeUrl()+"?f=json&part=_html&callback=security.showContent"),window.open("SignInHelper.html","_blank"))};c.prototype.getExpirationNoticeUrl=function(){return this.site.principal&&this.site.principal.urls?this.site.principal.urls.expirationNotice:null};c.prototype.getRefreshUrl=function(){return this.site.principal&&this.site.principal.urls?this.site.principal.urls.refresh:null};c.prototype.sendRequest=function(b){if(!this.finished){var a=document.createElement("script");
a.style.display="none";document.body.appendChild(a);this.scripts.push(a);a.type="text/javascript";a.src=b+"&rid="+this.id}};c.prototype.showContent=function(b){if(this.finished||b.rid!=this.id)return!1;this.dialog&&this.dialog.parentNode&&this.dialog.parentNode.removeChild(this.dialog);this.dialog=document.createElement("div");this.dialog.innerHTML=b.content;document.body.appendChild(this.dialog);return!0};c.prototype.handleSignIn=function(b,a){if(this.finished)return null;if(0<b.length&&b.startsWith("#gcx-")){var g=
b.substring(5);this.sendRequest(this.site.url+"?f=json&callback=security.updateSitePrincipal&token="+g)}else return g="",null==this.site.principal.urls.referrer&&(g="&app="+encodeURIComponent(a)),this.getRefreshUrl()+g+"&token_type=fragment";return null};c.prototype.finish=function(){if(this.finished)return!1;for(this.finished=!0;0<this.scripts.length;){var b=this.scripts.pop();b.parentNode.removeChild(b)}this.dialog&&this.dialog.parentNode&&this.dialog.parentNode.removeChild(this.dialog);this.frame&&
this.frame.parentNode&&this.frame.parentNode.removeChild(this.frame);return!0};c.prototype.updateSitePrincipal=function(b){if(this.finished||b.rid!=this.id)return!1;this.finish();this.site.updatePrincipal(b.principal);return!0};c.prototype.useSystemBrowser=function(){return!1};return c}();c.SecurityHelper=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(h){var f=function(d){function b(a,b){d.call(this,a);this.dataProvider=this.currentVersion=null;this.deepInitialize=!1;this.displayName=null;this.documentStore=new h.documents.DocumentStore;this.essentialsMap=this.updateInterval=null;this.extensions=[];this.geocodingEndpoints=[];this.geometryEndpoints=[];this.geoprocessingEndpoints=[];this.layerListRestEndpoint=null;this.hasWebMaps=this.hasSearchTables=this.hasWorkflows=this.hasVirtualDirectory=this.hasViewers=this.hasPrintTemplates=
this.hasOverviewMap=this.hasTimeSliders=this.hasNorthArrow=this.hasNamedExtents=this.hasGeoprocessingEndpoints=this.hasGeometryEndpoints=this.hasGeocodingEndpoints=!1;this.id=null;this.namedExtents=[];this.overviewMap=null;this.printTemplates=[];this.properties={};this.timeSliders=[];this.trustedUrls=[];this.layerCatalogs=[];this.serviceLayersLoaded=!1;this.url=null;this.workflows=[];this.searchTables=[];this.displayTimeZoneId=this.timeZoneId=null;this.webMapsInfo={layerTypes:null,webMaps:[]};this.onLayerLoadError=
this.onLayerLoad=this.configPreprocessor=null;this.onServiceLayersLoaded=function(){};this.onUserSignInCancelled=this.onSignOut=this.onSignIn=null;this.principal={isAuthenticated:!1,label:null,identities:[],policy:{},urls:{},tokens:{arcgis:{},geocortex:{},site:null}};this._signOutEnabled=this._signInEnabled=this._initializedHandlerCalled=this._webMapsInitialized=this._timeSlidersInitialized=this._searchTablesInitialized=this._workflowsInitialized=this._printTemplatesInitialized=this._overviewMapInitialized=
this._namedExtentsInitialized=this._mapInitialized=this._kmlServiceInitialized=this._geoprocessingEndpointsInitialized=this._geometryEndpointsInitialized=this._geocodingEndpointsInitialized=!1;this._serviceTokenRefresh=this._tokenIntervalHandle=null;this._serviceTokensStale=!1;this._allDeferredDojosForUpdatingTokens=[];this.originalUrl=a;this.url=h.utilities.UrlUtilities.simplify(a);this._esriMap=b}__extends(b,d);b.prototype.initialize=function(){var a=this;this._detectAndConfigureCors().then(function(){a._initialize()})};
b.prototype.getResourceById=function(a,b){return c.essentials.utilities.SiteResourceIdComparer.lookUp(a,b)};b.prototype.findWorkflowById=function(a){return this.getResourceById(this.workflows,a)};b.prototype.findPrintTemplateById=function(a){return this.getResourceById(this.printTemplates,a)};b.prototype.getFeatureServices=function(){var a=[];if(!this.essentialsMap)return a;for(var b=0;b<this.essentialsMap.mapServices.length;b++){var d=this.essentialsMap.mapServices[b];d instanceof c.essentials.FeatureLayerService&&
a.push(d)}return a};b.prototype.getMap=function(){return this._esriMap};b.prototype.getEssentialsVersion=function(){var a=3;if(this.currentVersion){var b=this.currentVersion.split(".");2<=b.length&&(a=parseFloat(b[0]+"."+b[1]))}return a};b.prototype.getDefaultBatchGeocoder=function(){var a=c.framework.utils.ArrayUtils.firstOrDefault(this.geocodingEndpoints,function(a){return a.isDefaultBatchGeocoder});!a&&0<this.geocodingEndpoints.length&&(a=this.geocodingEndpoints[0]);return a};b.prototype.search=
function(a,b,d,k){var l=this;b&&b(a);try{var m=this.url+"/search";b={};a&&a.toJson&&(b=a.toJson(this.getMap(),this.essentialsMap));var f=c.encodeJson(dojo.mixin({f:"json"},b))}catch(p){k&&k(p);return}b=function(b){var g=new h.SearchResults;g.queryParams=a;b?l._parseSearchResponse(g,b):g.error=Error("Unexpected Error");g.error&&k&&k(g.error);d&&d(g)};var q=function(a){k&&k(a)};f.hasOwnProperty("layers")&&f.layers&&c.request({url:m,content:f,load:b,error:q,callbackParamName:"CallBack"})};b.prototype._parseSearchResponse=
function(a,b){if(!b)throw Error("_parseSearchResponse: required jsonObject argument was not supplied.");if(b.hasOwnProperty("error")&&b.error&&b.error.message)a.error=Error(b.error.message);else if(b.hasOwnProperty("ResponseStatus")&&b.ResponseStatus&&b.ResponseStatus.ErrorCode)a.error=Error(b.ResponseStatus.Message),a.error.name=b.ResponseStatus.ErrorCode;else if(b.hasOwnProperty("features")){var c=this._createFeatureSets(b.features,a.queryParams.returnHighlights),d;for(d in c)c.hasOwnProperty(d)&&
a.results.push(c[d])}};b.prototype._createFeatureSets=function(a,b){for(var c={},d=0;d<a.length;d++){var l=a[d],m=l.hasOwnProperty("mapServiceId")?l.mapServiceId:null,f=l.hasOwnProperty("layerId")?l.layerId:null;if(f=(m=this.essentialsMap.findMapServiceById(m))?m.findLayerOrTableById(f):null)l=this._createFeature(l,f,b),c.hasOwnProperty(f.url)||(c[f.url]=new h.SearchResultSet({layer:f})),c[f.url].features.push(l)}return c};b.prototype._createFeature=function(a,b,c){if(!a)throw Error("_createSearchFeature: required jsonFeature argument was not supplied.");
var d=this._jObjectToGraphic(a);b=new h.SearchResultFeature(d,b);c&&this._assignHighlights(b,a);return b};b.prototype._jObjectToGraphic=function(a){if(!a)throw Error("_jObjectToGraphic: required jobject argument was not supplied.");var b=null;a.hasOwnProperty("geometry")&&a.geometry&&(b=esri.geometry.fromJson(a.geometry))&&b.spatialReference&&!a.geometry.spatialReference&&(b.spatialReference=new esri.SpatialReference(4326));var c={};a.hasOwnProperty("attributes")&&a.attributes&&(c=JSON.parse(JSON.stringify(a.attributes)));
return new esri.Graphic(b,null,c,null)};b.prototype._assignHighlights=function(a,b){if(!a)throw Error("_assignHighlights: required feature argument was not supplied.");if(!b)throw Error("_assignHighlights: required jobject argument was not supplied.");var c={};b.hasOwnProperty("highlights")&&b.highlights&&(c=JSON.parse(JSON.stringify(b.highlights)));a.highlights=c};b.prototype._initAsyncCollection=function(a,b,d,k){if(a&&d&&k)for(var l=0;a&&l<a.length;l++)d[l]=new k(this.url+"/"+b+"/"+a[l].id),d[l].site=
this,d[l]._configureObject(a[l]),!0===this.deepInitialize&&k!==c.essentials.Workflow&&(d[l].isInitialized=!0);this._siteInitializeUpdate()};b.prototype._initAsyncCollectionErrorHandler=function(a,b){a();this._initializationFailedHandler(b);this._siteInitializeUpdate()};b.prototype._initGeocodingEndpointsHandler=function(a){this._geocodingEndpointsInitialized=!0;a&&this._initAsyncCollection(a.geocodingEndpoints,"geocoding",this.geocodingEndpoints,c.essentials.GeocodingEndpoint)};b.prototype._initGeometryEndpointsHandler=
function(a){this._geometryEndpointsInitialized=!0;a&&this._initAsyncCollection(a.geometryEndpoints,"geometry",this.geometryEndpoints,c.essentials.GeometryEndpoint)};b.prototype._initKmlEndpointHandler=function(a){this._kmlServiceInitialized=!0;a&&a.connectionString&&(a=c.essentials.ServiceHelper.extractConnectionStringValue(a.connectionString,"url"))&&(esri.config.defaults.kmlService=a)};b.prototype.getLayerCatalog=function(a,b,d,k){a=this.url+"/catalog/layercatalog/getcatalog";b();c.request({url:a,
content:{f:"json"},load:function(a){d(a)},error:k,callbackParamName:"CallBack"})};b.prototype.getLayerCatalogDetails=function(a,b,d,k){var l=this.url+"/catalog/layercatalog/getcatalogdetails",m={};m.ids=a.ids.join();m.f="json";b();c.request({url:l,content:m,load:function(a){d(a)},error:k,callbackParamName:"CallBack"})};b.prototype.getOfflineBasemaps=function(a,b){void 0===b&&(b=function(){});var d=this.url+"/offlinebasemaps";if("function"!=typeof a)throw Error("loadComplete must be a function.");
c.request({url:d,content:{f:"json"},load:function(c){c.error?b(Error(c.error.message)):c.basemaps?a(c.basemaps):b(Error("Unexpected result: "+JSON.stringify(c)))},error:b,callbackParamName:"CallBack"})};b.prototype._initGeoprocessingEndpointsHandler=function(a){this._geoprocessingEndpointsInitialized=!0;a&&this._initAsyncCollection(a.geoprocessingEndpoints,"geoprocessing",this.geoprocessingEndpoints,c.essentials.GeoprocessingEndpoint)};b._getTokenFromFragment=function(){var a=window.location.href,
b=a.indexOf("#gcx-");return 0<=b?(a=a.substring(b+5),window.location.replace("#"),a):null};b._addQueryParameter=function(a,b){var c=a.split("#",2);a=c[0];c=1<c.length?c[1]:"";return a+(-1<a.indexOf("?")?"&":"?")+b+c};b.prototype.canSignIn=function(){return this._signInEnabled&&!!this.principal&&!!this.principal.urls.signIn&&!this.principal.isAuthenticated&&!!this.principal.policy&&0<this.principal.policy.issuers.length};b.prototype._signIn=function(a,c){a||(a=this.principal);c||(c=a.urls.signIn);
void 0===a.policy&&(a.policy={});var d=a.policy.hints;d&&(c=b._addQueryParameter(c,d));c=b._addQueryParameter(c,"token_type=fragment");this.signInRedirectUri&&0>c.indexOf("app=")?c=b._addQueryParameter(c,"app="+encodeURIComponent(this.signInRedirectUri)):!a.urls.referrer&&0>c.indexOf("app=")&&(c=b._addQueryParameter(c,"app="+encodeURIComponent(window.location.toString())));if(this.onSignIn)this.onSignIn({url:c});window.addEventListener&&window.addEventListener("popstate",function(){location.hash.startsWith("#gcx-")&&
location.reload()},!1);window.location.assign(c)};b.prototype.signIn=function(a){this._signIn(this.principal,a)};b.prototype.canSignOut=function(){return this._signOutEnabled&&!!this.principal&&this.principal.isAuthenticated&&!!this.principal.urls.signOut};b.prototype.signOut=function(){if(this.onSignOut)this.onSignOut();var a=this.principal.urls.signOut;this.signOutRedirectUri?a=b._addQueryParameter(a,"app="+encodeURIComponent(this.signOutRedirectUri)):this._signOutRedirectUrl&&(a=b._addQueryParameter(a,
"app="+encodeURIComponent(this._signOutRedirectUrl)));window.location.assign(a)};b.prototype.getTokenFromPrincipal=function(a,b){var d=null;b===h.MapServiceType.DYNAMIC?d=this.principal.tokens.arcgis:b===h.MapServiceType.FEATURE?d=this.principal.tokens.arcgis:b===h.MapServiceType.IMAGE?d=this.principal.tokens.arcgis:b===h.MapServiceType.TILED?d=this.principal.tokens.arcgis:b===h.MapServiceType.WEBTILED?d=this.principal.tokens.arcgis:b===h.MapServiceType.VECTORTILE?d=this.principal.tokens.arcgis:b===
esri.IdentityManagerBase?d=this.principal.tokens.arcgis:b===c.essentials.Site&&(d=(t={},t[this.url]=this.principal.tokens.site,t));if(!d)return null;a=a.toLowerCase();t=document.createElement("a");t.href=a.toLowerCase();var k=t.protocol,l=t.hostname,m=t.port;a=t.href;for(var f in d){var p=f.toLowerCase();if(l==p||l.endsWith("."+p))return d[f];try{if(t.href=k+"://"+p,t.port=m,a.startsWith(t.href))return d[f]}catch(q){}try{if(t.href=p,a.startsWith(t.href))return d[f]}catch(s){}}return null;var t};b.prototype._updateDefaultToken=
function(a){if("string"===typeof a){var b=this.url,c=Math.max(b.indexOf("?"),b.indexOf("#"));0<=c&&(b=b.substr(0,c));b=/^(.*?)\/*$/.exec(b)[1];h.RestHelperHTTPService.setDefaultToken(a,b+"/../../")}};b.prototype._detectAndConfigureCors=function(){var a=new dojo.Deferred;if(window.geocortexDisableEssentialsCorsDetection)return a.resolve(),a;var b=h.utilities.UrlUtilities.getUrlComponents(this.url),c=h.utilities.UrlUtilities.getUrlComponents(window.location.href);if(b.origin===c.origin)return a.resolve(),
a;(c=(/(.*\/+)sites\/+[^\/]*\/?$/i.exec(this.url)||[])[1])?dojo.xhrGet({url:c+"info?f=json"}).then(function(c){esri.config.defaults.io.corsEnabledServers.push(b.host);a.resolve()},function(b){a.resolve()}):a.resolve();return a};b.prototype._initialize=function(){var a=this;if(!this.isInitialized&&!this._initializing){var g=b._getTokenFromFragment();this._updateDefaultToken(g);if(!g){var d=function(){window.removeEventListener?window.removeEventListener("popstate",d,!1):window.detachEvent&&window.detachEvent("onpopstate",
d);if(!a.isInitialized&&a._initializing){var g=b._getTokenFromFragment();g&&(a._updateDefaultToken(g),c.request({url:a.url,content:{f:"json",deep:a.deepInitialize},load:dojo.hitch(a,a._verifySiteDependencies),error:dojo.hitch(a,a._initSiteErrorHandler),callbackParamName:"CallBack"}))}};window.addEventListener?window.addEventListener("popstate",d,!1):window.attachEvent&&window.attachEvent("onpopstate",d)}this._initializedHandlerCalled=!1;this._initializing=!0;c.request({url:this.url,content:{f:"json",
deep:this.deepInitialize},load:dojo.hitch(this,this._verifySiteDependencies),error:dojo.hitch(this,this._initSiteErrorHandler),callbackParamName:"CallBack"})}};b.prototype._initMapHandler=function(a){this._mapInitialized=!0;null!==a&&null!==a.site&&a.loadServiceLayersInMap(a.site.getMap());this._siteInitializeUpdate()};b.prototype._initMapErrorHandler=function(a){this._mapInitialized=!0;this._initializationFailedHandler(a);this._siteInitializeUpdate()};b.prototype._initNamedExtentsHandler=function(a){this._namedExtentsInitialized=
!0;a&&this._initAsyncCollection(a.namedExtents,"namedextents",this.namedExtents,c.essentials.NamedExtent)};b.prototype._initTimeSlidersHandler=function(a){this._timeSlidersInitialized=!0;a&&this._initAsyncCollection(a.timeSliders,"timesliders",this.timeSliders,c.essentials.TimeSliderProfile)};b.prototype._initOverviewMapHandler=function(){this._overviewMapInitialized=!0;this._siteInitializeUpdate()};b.prototype._initOverviewMapErrorHandler=function(a){this._overviewMapInitialized=!0;this._initializationFailedHandler(a);
this._siteInitializeUpdate()};b.prototype._initPrintTemplatesHandler=function(a){var b=this,d=0;this._printTemplatesInitialized=!0;0<a.printTemplates.length&&null!=a.printTemplates[0].visible?this._initAsyncCollection(a.printTemplates,"printtemplates",this.printTemplates,c.essentials.PrintTemplate):a.printTemplates.forEach(function(k){c.request({url:b.url+"/printtemplates/"+k.id,content:{f:"json"},load:function(k){d++;a.printTemplates.forEach(function(a){a.id===k.id&&(a.visible=k.visible)});d===a.printTemplates.length&&
b._initAsyncCollection(a.printTemplates,"printtemplates",b.printTemplates,c.essentials.PrintTemplate)},callbackParamName:"CallBack"})})};b.prototype.updateServiceTokensIfStale=function(){if(!this._serviceTokensStale){var a=new dojo.Deferred;a.resolve();return a}return this._getUpdatedServiceTokens()};b.prototype._getUpdatedServiceTokens=function(){var a=this;if(0===this.updateInterval){var b=new dojo.Deferred;b.resolve();return b}if(this._serviceTokenRefresh)return this._serviceTokenRefresh;this._serviceTokenRefresh=
new dojo.Deferred;this._updateServiceTokensOfAllSites();(new dojo.DeferredList(this._allDeferredDojosForUpdatingTokens)).then(function(b){a._serviceTokensStale=!1;for(var c=0;c<b.length;c++)if(!b[c][0]){a._serviceTokensStale=!0;a._serviceTokenRefresh.reject(Error("One or more service tokens failed to update"));a._serviceTokenRefresh=null;break}a._serviceTokenRefresh&&(a._serviceTokenRefresh.resolve(),a._serviceTokenRefresh=null);a._allDeferredDojosForUpdatingTokens=[]},function(b){a._allDeferredDojosForUpdatingTokens=
[];a._serviceTokensStale=!0;a._serviceTokenRefresh.reject(b);a._serviceTokenRefresh=null});return this._serviceTokenRefresh};b.prototype._updateServiceTokensBySendingRestRequest=function(a,b){var d=this.url;a&&(d=this.url.replace(this.id,a));this._isTokenUpdateRequired(a)?c.request({url:d+"/update",content:{f:"json"},load:dojo.hitch(this,this._processServiceTokensHandler,a,b),error:dojo.hitch(this,this._processServiceTokensErrorHandler,b),callbackParamName:"CallBack"}):b.resolve()};b.prototype._isTokenUpdateRequired=
function(a){if(!a)return!0;var b=this.essentialsMap.mapServices;if(0<b.length)for(var c=0;c<b.length;c++){var d=b[c];if(d.catalogId&&d.catalogId.split(".")[0]==a)return!0}return!1};b.prototype._processServiceTokensHandler=function(a,b,c){var d=this;c&&c.mapServiceTokens&&this._updateServiceTokens(this.essentialsMap,c.mapServiceTokens,a);a||(c&&c.overviewMapServiceTokens&&this._updateServiceTokens(this.overviewMap,c.overviewMapServiceTokens,a),c.geocodingServiceTokens&&c.geocodingServiceTokens.forEach(function(a){var b=
d.geocodingEndpoints.filter(function(b){return b.id===a.id})[0];b&&(b.geocoderToken=a.token,dojo.publish("ServiceTokenRefreshed",{serviceUrl:b.geocoderUrl,token:a.token}))}),c.geometryServiceTokens&&c.geometryServiceTokens.forEach(function(a){var b=d.geometryEndpoints.filter(function(b){return b.id===a.id})[0];b&&(b.geometryServiceToken=a.token,dojo.publish("ServiceTokenRefreshed",{serviceUrl:b.geometryServiceUrl,token:a.token}))}));b.resolve()};b.prototype._processServiceTokensErrorHandler=function(a,
b){this._serviceTokensStale=!0;a.reject(b);dojo.publish("ServiceTokenRefreshError",{error:b})};b.prototype._updateServiceTokens=function(a,b,c){if(a&&b)for(var d=0;b&&d<b.length;d++){var l;(l=c?a.findMapServiceById(c+"-"+b[d].id):a.findMapServiceById(b[d].id))&&l._updateServiceToken(b[d].token)}};b.prototype._updateServiceTokensFromPrincipal=function(a){if(a&&a.mapServices)for(var b=0;b<a.mapServices.length;b++){var c=a.mapServices[b];if(c&&c.serviceUrl){var d=this.getTokenFromPrincipal(c.serviceUrl,
esri.IdentityManagerBase);d&&c._updateServiceToken(d)}}};b.prototype._refreshPrincipal=function(){var a=this,b={site:this,handled:!1,resumeRefresh:function(){return h.SecurityHelper.beginRefresh(a)},suspendRefresh:function(){return h.SecurityHelper.cancel()}};dojo.publish("geocortex_sessionExpiring",b);b.handled||b.resumeRefresh()};b.prototype._refreshPrincipalAt=function(a,b){var c=this;if(!a)return!1;var d=(new Date(a)).valueOf();isNaN(d)&&(d=Date.parse(a));d=d-(new Date).valueOf()-b;d=Math.max(1E4,
d);window.setTimeout(function(){return c._refreshPrincipal()},d);return!0};b.prototype.updatePrincipal=function(a){this.principal=a;this._refreshPrincipalAt(a.expiry,3E5);this._updateDefaultToken(this.principal.tokens.site);this.principal.tokens&&this.principal.tokens.arcgis&&(this._updateServiceTokensFromPrincipal(this.essentialsMap),this._updateServiceTokensFromPrincipal(this.overviewMap))};b.prototype._getCredential=function(a,b){var c=this.getTokenFromPrincipal(a,esri.IdentityManagerBase),d=new dojo.Deferred;
if(c){var l=new esri.Credential;l.token=c;l.server=this._getCredentialServer(a);d.resolve(l)}else d.reject(Error("No token available for service {0}".format(a)));return d};b.prototype._getCredentialServer=function(a){var b=a.toLowerCase(),c=b.indexOf("/rest/services");-1===c&&(c=b.indexOf("/sharing"));-1===c&&"/"===b.substr(-1)&&(c=b.length-1);return-1<c?a.substring(0,c):a};b.prototype._hookGetCredential=function(){var a=this;esri.IdentityManagerBase.prototype.getCredential=function(b,c){try{return a._getCredential(b,
c)}catch(d){var l=new dojo.Deferred;l.reject(d);return l}}};b.prototype._initSiteHandler=function(a){var b=this;this._hookGetCredential();if(!a)throw Error("Incorrect site object returned from initialization");this.configPreprocessor&&(this.configPreprocessor(a),this.configPreprocessor=null);a.contentPolicy&&(c.framework.utils.isNullOrUndefined(a.contentPolicy.trustedUrls)?this.trustedUrls=[]:this.trustedUrls=a.contentPolicy.trustedUrls);if(a.layerCatalogs)if(0==a.layerCatalogs.length)this.layerCatalogs=
[];else for(var d=0;d<a.layerCatalogs.length;d++)this.layerCatalogs[d]=new c.essentials.LayerCatalog(a.layerCatalogs[d].siteId);if(a.principal){d=a.principal;void 0===d.policy&&(d.policy={});if(d.policy.authenticate&&!d.isAuthenticated){this._signIn(d);return}this.principal=d;d.isAuthenticated&&dojo.publish("geocortex_authenticationSucceeded",[{username:d.label,token:d.tokens.site}]);this._refreshPrincipalAt(this.principal.expiry,3E5)}else if(a.arcGisPortalAuthentication&&a.arcGisPortalAuthentication.clientID){d=
a.arcGisPortalAuthentication;this.arcGisPortalSecurityContext=new h.ArcGisPortalSecurityContext(d.url,d.domains,d.clientID);if(!this.arcGisPortalSecurityContext.initiate()){if(this.arcGisPortalSecurityContext.error)if(this.arcGisPortalSecurityContext.error.code==h.OAuth2Error.ACCESS_DENIED_ERROR_CODE){if(this.onUserSignInCancelled)this.onUserSignInCancelled({tryAgainAction:dojo.hitch(this,function(){h.OAuth2Client.redirectToLogOnPage(this.arcGisPortalSecurityContext.getLogOnUrl(),this.arcGisPortalSecurityContext.clientId)})})}else a=
Error(),a.name=this.arcGisPortalSecurityContext.error.code,a.message=this.arcGisPortalSecurityContext.error.description,this._initializationFailedHandler(a);return}h.RestHelperHTTPService.arcGisPortalToken=this.arcGisPortalSecurityContext.tokenResult}this.hasGeocodingEndpoints=!!a.hasGeocodingEndpoints;this.hasGeometryEndpoints=!!a.hasGeometryEndpoints;this.hasGeoprocessingEndpoints=!!a.hasGeoprocessingEndpoints;this.hasNamedExtents=!!a.hasNamedExtents;this.hasNorthArrow=!!a.hasNorthArrow;this.hasTimeSliders=
!!a.hasTimeSliders;this.hasOverviewMap=!!a.hasOverviewMap;this.hasPrintTemplates=!!a.hasPrintTemplates;this.hasViewers=!!a.hasViewers;this.hasVirtualDirectory=!!a.hasVirtualDirectory;this.hasWorkflows=!!a.hasWorkflows;this.hasSearchTables=!!a.hasSearchTables;this.hasWebMaps=!!a.hasWebMaps;this.dataProvider=a.dataProvider;this.displayName=a.displayName;this.id=a.id;this._signInEnabled=!!a.signInEnabled;this._signOutEnabled=!!a.signOutEnabled;this._signOutRedirectUrl=a.signOutRedirectUrl;this.timeZoneId=
a.timeZoneId;this.displayTimeZoneId=a.displayTimeZoneId;this.currentVersion=void 0===a.currentVersion?"3.0":a.currentVersion;a.hasOwnProperty("updateInterval")?(this.updateInterval=parseInt(a.updateInterval),isNaN(this.updateInterval)&&(this.updateInterval=0)):this.updateInterval=0;var k=c.essentials.RestHelperHTTPService.getAuthenticationControlBlockStore().find(this.url);k&&setInterval(function(){(new c.essentials.RestHelperHTTPService)._requestToken(k)},Math.max(6E4,6E4*c.essentials.RestHelper.tokenDurationMinutes-
12E4));0<this.updateInterval&&(this._tokenIntervalHandle=setInterval(function(){b._getUpdatedServiceTokens()},Math.max(60,1E3*this.updateInterval)));this.properties=c._getProperties(a.properties);this.extensions=c._getExtensions(a.extensions);this.essentialsMap=new c.essentials.Map(this.originalUrl+"/map");this.essentialsMap.site=this;dojo.connect(this.essentialsMap,"onInitialized",dojo.hitch(this,this._initMapHandler));dojo.connect(this.essentialsMap,"onInitializationFailed",dojo.hitch(this,this._initMapErrorHandler));
this.hasOverviewMap&&(this.overviewMap=new c.essentials.Map(this.originalUrl+"/overviewmap"),this.overviewMap.site=this,dojo.connect(this.overviewMap,"onInitialized",dojo.hitch(this,this._initOverviewMapHandler)),dojo.connect(this.overviewMap,"onInitializationFailed",dojo.hitch(this,this._initOverviewMapErrorHandler)));a.map&&a.map.layerList&&(this.layerListRestEndpoint=a.map.layerList);!this.deepInitialize||3.3>this.getEssentialsVersion()||void 0===a.map?(this.essentialsMap.initialize(),this.hasOverviewMap?
this.overviewMap.initialize():this._overviewMapInitialized=!0,a.hasKmlServiceEndpoint?c.request({url:this.url+"/kmlService",content:{f:"json"},load:dojo.hitch(this,this._initKmlEndpointHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._kmlServiceInitialized=!0})),callbackParamName:"CallBack"}):this._kmlServiceInitialized=!0,this.hasGeocodingEndpoints?c.request({url:this.url+"/geocoding",content:{f:"json"},load:dojo.hitch(this,this._initGeocodingEndpointsHandler),
error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._geocodingEndpointsInitialized=!0})),callbackParamName:"CallBack"}):this._geocodingEndpointsInitialized=!0,this.hasGeometryEndpoints?c.request({url:this.url+"/geometry",content:{f:"json"},load:dojo.hitch(this,this._initGeometryEndpointsHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._geometryEndpointsInitialized=!0})),callbackParamName:"CallBack"}):this._geometryEndpointsInitialized=
!0,this.hasGeoprocessingEndpoints?c.request({url:this.url+"/geoprocessing",content:{f:"json"},load:dojo.hitch(this,this._initGeoprocessingEndpointsHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._geoprocessingEndpointsInitialized=!0})),callbackParamName:"CallBack"}):this._geoprocessingEndpointsInitialized=!0,this.hasNamedExtents?c.request({url:this.url+"/namedextents",content:{f:"json"},load:dojo.hitch(this,this._initNamedExtentsHandler),error:dojo.hitch(this,
this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._namedExtentsInitialized=!0})),callbackParamName:"CallBack"}):this._namedExtentsInitialized=!0,this.hasPrintTemplates?c.request({url:this.url+"/printtemplates",content:{f:"json"},load:dojo.hitch(this,this._initPrintTemplatesHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._printTemplatesInitialized=!0})),callbackParamName:"CallBack"}):this._printTemplatesInitialized=!0,this.hasSearchTables?
c.request({url:this.url+"/searchtables",content:{f:"json"},load:dojo.hitch(this,this._initSearchTablesHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._searchTablesInitialized=!0})),callbackParamName:"CallBack"}):this._searchTablesInitialized=!0,this.hasTimeSliders?c.request({url:this.url+"/timesliders",content:{f:"json"},load:dojo.hitch(this,this._initTimeSlidersHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,
function(){this._timeSlidersInitialized=!0})),callbackParamName:"CallBack"}):this._timeSlidersInitialized=!0,this.hasWorkflows?c.request({url:this.url+"/workflows",content:{f:"json"},load:dojo.hitch(this,this._initWorkflowsHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._workflowsInitialized=!0})),callbackParamName:"CallBack"}):this._workflowsInitialized=!0,this.hasWebMaps?c.request({url:this.url+"/webmaps",content:{f:"json"},load:dojo.hitch(this,
this._initWebMapHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._webMapsInitialized=!0})),callbackParamName:"CallBack"}):this._webMapsInitialized=!0):(this._initGeocodingEndpointsHandler(a),this._initGeometryEndpointsHandler(a),this._initGeoprocessingEndpointsHandler(a),this._initTimeSlidersHandler(a),this._initKmlEndpointHandler(a.kmlServiceEndpoint),this.essentialsMap.initialize(a.map),this._initNamedExtentsHandler(a),a.overviewMap?this.overviewMap.initialize(a.overviewMap):
(this._overviewMapInitialized=!0,this._siteInitializeUpdate()),this._initPrintTemplatesHandler(a),this._initWorkflowsHandler(a),this._initSearchTablesHandler(a),this._initWebMapHandler(a));this.documentStore.initialize(this);this._siteInitializeUpdate()};b.prototype._updateServiceTokensOfAllSites=function(){var a=this;this.layerCatalogs&&0<this.layerCatalogs.length&&this.layerCatalogs.forEach(function(b){var c=new dojo.Deferred;a._allDeferredDojosForUpdatingTokens.push(c);a._updateServiceTokensBySendingRestRequest(b.siteId,
c)});var b=new dojo.Deferred;this._allDeferredDojosForUpdatingTokens.push(b);this._updateServiceTokensBySendingRestRequest(null,b)};b.prototype._initSiteErrorHandler=function(a){var b=a.principal;b&&!b.isAuthenticated&&403==a.code?this._signIn(b):(b&&b.isAuthenticated&&403==a.code&&b.urls.signOut&&(this._signOutEnabled=!0,this.principal=b),this._timeSlidersInitialized=this._searchTablesInitialized=this._workflowsInitialized=this._printTemplatesInitialized=this._namedExtentsInitialized=this._kmlServiceInitialized=
this._geoprocessingEndpointsInitialized=this._geometryEndpointsInitialized=this._geocodingEndpointsInitialized=!0,this._initializationFailedHandler(a),this._siteInitializeUpdate())};b.prototype._initWorkflowsHandler=function(a){this._workflowsInitialized=!0;a&&this._initAsyncCollection(a.workflows,"workflows",this.workflows,c.essentials.Workflow)};b.prototype._initSearchTablesHandler=function(a){this._searchTablesInitialized=!0;a&&this._initAsyncCollection(a.searchTables,"searchTables",this.searchTables,
c.essentials.SearchTable)};b.prototype._initWebMapHandler=function(a){this._webMapsInitialized=!0;a&&a.webMapsInfo&&(this.webMapsInfo.layerTypes=a.webMapsInfo.layerTypes,this._initAsyncCollection(a.webMapsInfo.webMaps,"webmaps",this.webMapsInfo.webMaps,c.essentials.WebMapReference))};b.prototype._siteInitializeUpdate=function(){this._geocodingEndpointsInitialized&&this._geometryEndpointsInitialized&&this._geoprocessingEndpointsInitialized&&this._kmlServiceInitialized&&this._mapInitialized&&this._namedExtentsInitialized&&
this._overviewMapInitialized&&this._printTemplatesInitialized&&this._workflowsInitialized&&this._searchTablesInitialized&&this._timeSlidersInitialized&&this._webMapsInitialized&&!this._initializedHandlerCalled&&(this._initializedHandlerCalled=!0,this._initializedHandler(this))};b.prototype._verifySiteDependencies=function(a){a&&a.hasFeatureLayers?dojo.addOnLoad(dojo.hitch(this,function(){this._initSiteHandler(a)})):this._initSiteHandler(a)};return b}(h.AsyncInitializable);h.Site=f})(c.essentials||
(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(c){var f=function(){function d(){}d.processClientSideTokens=function(b,a){var g="";if(""!==a){var n="";b&&b.url&&(n=b.url);var g=d._replaceToken("SiteRestUrl",a,n),g=d._replaceToken("VirtualDirectoryUrl",g,n+"/virtualdirectory"),k=window.location.href.substring(0,window.location.href.lastIndexOf("/")),g=d._replaceToken("HostUri",g,k),n=n.substring(0,n.lastIndexOf("/sites/"))+"/virtualdirectory",g=d._replaceToken("RestVirtualDirectoryUrl",g,n),g=d._replaceToken("RestToken",g,
c.RestHelperHTTPService.token)}return g};d.validateDynamicDefinition=function(b){if(!b||!b.trim())throw Error("The JSON string cannot be null, empty nor merely whitespace!");if(b=d.getJsonObjectFromJsonString(b)){if(null==b.source)throw"The source is required!";if(null==b.source.type)throw"The type is required!";if("mapLayer"==b.source.type){if(null==b.source.mapLayerId)throw"The mapLayerId is required for the mapLayer type!";}else if("dataLayer"==b.source.type){if(null==b.source.dataSource)throw"The dataSource is required for the dataLayer type!";
}else throw"The type '"+b.source.type.toString()+"' is not supported!";}};d.getJsonObjectFromJsonString=function(b){return JSON.parse(b)};d.getLayerSourceFromJsonObject=function(b){if("mapLayer"==b.type)return new esri.layers.LayerMapSource(b);var a=new esri.layers.LayerDataSource;switch(b.dataSource.type){case "table":a.dataSource=new esri.layers.TableDataSource(b.dataSource);break;case "queryTable":a.dataSource=new esri.layers.QueryDataSource(b.dataSource);break;case "raster":a.dataSource=new esri.layers.RasterDataSource(b.dataSource);
break;case "joinTable":a.dataSource=new esri.layers.JoinDataSource(b.dataSource);break;default:throw"The type '"+b.type.toString()+"' not supported!";}return a};d.getDynamicLayerInfoFromJson=function(b,a){var c;d.validateDynamicDefinition(b);var n=d.getJsonObjectFromJsonString(b);if(n){c=new esri.layers.DynamicLayerInfo;if(n.id)c.id=n.id;else if(null!=a)c.id=parseInt(a,10);else throw"The Layer's ID is missing or invalid!";c.source=this.getLayerSourceFromJsonObject(n.source);null!=n.minScale&&(c.minScale=
n.minScale);0>=c.minScale&&(c.minScale=Infinity);null!=n.maxScale&&(c.maxScale=n.maxScale)}return c};d.getDynamicExpressionFromJson=function(b){var a;d.validateDynamicDefinition(b);(b=d.getJsonObjectFromJsonString(b))&&b.definitionExpression&&(a=b.definitionExpression);return a};d.getLayerDrawingOptionsFromJson=function(b){var a;d.validateDynamicDefinition(b);if((b=d.getJsonObjectFromJsonString(b))&&b.drawingInfo){b=dojo.clone(b.drawingInfo);a=new esri.layers.LayerDrawingOptions;switch(b.renderer.type){case "simple":a.renderer=
new esri.renderer.SimpleRenderer(b.renderer);break;case "uniqueValue":a.renderer=new esri.renderer.UniqueValueRenderer(b.renderer);break;case "classBreaks":a.renderer=new esri.renderer.ClassBreaksRenderer(b.renderer);break;default:throw"The type '"+b.renderer.type.toString()+"' not supported!";}if(b.labelingInfo&&b.labelingInfo instanceof Array){var c=b.labelingInfo;void 0===b.showLabels&&(b.showLabels=!0);for(var n=0;n<c.length;n++){var k=new esri.layers.LabelClass(c[n]);a.labelingInfo||(a.labelingInfo=
[]);a.labelingInfo.push(k)}}a.transparency=b.transparency;a.scaleSymbols=b.scaleSymbols;a.showLabels=b.showLabels}return a};d._replaceToken=function(b,a,c){return a?a.replace("{"+b+"}",c):a};d._createRestParametersFromQuery=function(b){var a={};b&&(a=b.toJson(),a.spatialRel=d._convertSpatialRelationshipToDotnet(a.spatialRel));return a};d._convertSpatialRelationshipToDotnet=function(b){switch(b){case esri.tasks.Query.SPATIAL_REL_CONTAINS:return"esriSpatialRelContains";case esri.tasks.Query.SPATIAL_REL_CROSSES:return"esriSpatialRelCrosses";
case esri.tasks.Query.SPATIAL_REL_ENVELOPEINTERSECTS:return"esriSpatialRelEnvelopeIntersects";case esri.tasks.Query.SPATIAL_REL_INDEXINTERSECTS:return"esriSpatialRelIndexIntersects";case esri.tasks.Query.SPATIAL_REL_INTERSECTS:return"esriSpatialRelIntersects";case esri.tasks.Query.SPATIAL_REL_OVERLAPS:return"esriSpatialRelOverlaps";case esri.tasks.Query.SPATIAL_REL_RELATION:return"esriSpatialRelRelation";case esri.tasks.Query.SPATIAL_REL_TOUCHES:return"esriSpatialRelTouches";case esri.tasks.Query.SPATIAL_REL_WITHIN:return"esriSpatialRelWithin"}throw Error("Unknown rel: "+
b);};d._convertSpatialRelationshipFromDotnetIndex=function(b){switch(b){case 1:return esri.tasks.Query.SPATIAL_REL_CONTAINS;case 2:return esri.tasks.Query.SPATIAL_REL_CROSSES;case 3:return esri.tasks.Query.SPATIAL_REL_ENVELOPEINTERSECTS;case 4:return esri.tasks.Query.SPATIAL_REL_INDEXINTERSECTS;case 0:return esri.tasks.Query.SPATIAL_REL_INTERSECTS;case 5:return esri.tasks.Query.SPATIAL_REL_OVERLAPS;case 8:return esri.tasks.Query.SPATIAL_REL_RELATION;case 6:return esri.tasks.Query.SPATIAL_REL_TOUCHES;
case 7:return esri.tasks.Query.SPATIAL_REL_WITHIN}throw Error("Unknown rel: "+b);};d.tokenDurationMinutes=20;return d}();c.RestHelper=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(h){var f=function(){return function(d,b){this.encodeUriReplacementValues=d.encodeUriReplacementValues;this.target=d.target;this.text=d.text;this.toolTip=d.toolTip;var a=null;b&&b.mapService&&b.mapService.essentialsMap&&(a=b.mapService.essentialsMap.site);this.uri=c.essentials.RestHelper.processClientSideTokens(a,d.uri);this.iconUri=c.essentials.RestHelper.processClientSideTokens(a,d.iconUri);this.layer=b}}();h.FeatureHyperlink=f})(c.essentials||(c.essentials={}))})(geocortex||
(geocortex={}));
(function(c){(function(h){var f=function(d){function b(a){d.call(this,a);this.displayName=this.description=null;this.extensions=[];this.id=null;this.visible=!1;this.layer=null;this.properties={};this.supportedMapScales=[];this.supportedOutputFormats=[];this.supportedResolutions=[];this.textFields=[];this._running=!1;this._onRunReportError=this._onRunReportComplete=null}__extends(b,d);b.prototype.isRunning=function(){return this._running};b.prototype.run=function(a,b,d,k){var l=this;if(this.isRunning())k&&
(a=Error("Report already running"),a.name="ReportAlreadyRunning",k(a));else{this._running=!0;try{this._onRunReportComplete=d;this._onRunReportError=k;var m=new h.exportMap.ExportMapTask(this),f=new h.exportMap.ExportMapParameters;f.reportParameters=b;a&&(f.queryParameters=c.essentials.RestHelper._createRestParametersFromQuery(a));m.generateMapImageUrl(f).then(function(a){return l._runRestComplete(a)},function(a){return l._runRestError(a)})}catch(p){if(this._running=!1,this._onRunReportError)this._onRunReportError(p);
else throw p;}}};b.prototype._configureObject=function(a,b){if(void 0===a.id||void 0===a.displayName)throw Error("Incorrect report object returned from initialization");this.id=a.id;this.visible=void 0===a.visible?!0:a.visible;this.supportedOutputFormats=a.supportedOutputFormats;this.supportedResolutions=a.supportedResolutions;this.supportedMapScales=a.supportedScales;this.textFields=a.textFields;this.description=a.description;this.displayName=a.displayName;b&&(this.isInitialized=!0);this.properties=
c._getProperties(a.properties);this.extensions=c._getExtensions(a.extensions)};b.prototype._runRestComplete=function(a){this._running=!1;var b=null;a?a.error&&(b=a.error):b=Error("No results");b&&this._onRunReportError&&this._onRunReportError(b);a&&this._onRunReportComplete&&this._onRunReportComplete(a)};b.prototype._runRestError=function(a){this._running=!1;this._onRunReportError&&this._onRunReportError(a)};return b}(h.AsyncInitializable);h.Report=f})(c.essentials||(c.essentials={}))})(geocortex||
(geocortex={}));(function(c){c=c.essentials||(c.essentials={});c=c.ReportType||(c.ReportType={});c.LAYER_TEMPLATE_REPORT="Layer Template Report";c.MAP_TEMPLATE_REPORT="Map Template Report"})(geocortex||(geocortex={}));(function(c){(function(c){var f=function(){function c(){}c.UNKNOWN=0;c.FEATURE_LAYER=1;c.RASTER_LAYER=2;c.GROUP_LAYER=3;c.GEO_RSS_LAYER=4;c.TABLE_LAYER=5;return c}();c.LayerType=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(c){var f=function(){function a(){}a.esriFieldTypeSmallInteger="esriFieldTypeSmallInteger";a.esriFieldTypeInteger="esriFieldTypeInteger";a.esriFieldTypeSingle="esriFieldTypeSingle";a.esriFieldTypeDouble="esriFieldTypeDouble";a.esriFieldTypeString="esriFieldTypeString";a.esriFieldTypeDate="esriFieldTypeDate";a.esriFieldTypeOID="esriFieldTypeOID";a.esriFieldTypeGeometry="esriFieldTypeGeometry";a.esriFieldTypeBlob="esriFieldTypeBlob";a.esriFieldTypeRaster="esriFieldTypeRaster";
a.esriFieldTypeGUID="esriFieldTypeGUID";a.esriFieldTypeGlobalID="esriFieldTypeGlobalID";a.esriFieldTypeXML="esriFieldTypeXML";return a}();c.EsriFieldTypes=f;var d=function(){function a(){}a.essentialsFieldTypeSmallInteger="Int16";a.essentialsFieldTypeInteger="Int32";a.essentialsFieldTypeSingle="Single";a.essentialsFieldTypeDouble="Double";a.essentialsFieldTypeString="String";a.essentialsFieldTypeDate="DateTime";a.essentialsFieldTypeGUID="Guid";a.essentialsFieldTypeObject="Object";return a}();c.EssentialsFieldTypes=
d;var b=function(){function a(a){this.layer=null;if(!a||!a.layer)throw Error("Layer is required.");this.layer=a.layer;this.alias=a.alias;this.dataType=a.dataType;this.displayName=a.displayName;this.focusField=!!a.focusField;this.hyperlinkLabel=a.hyperlinkLabel;this.name=a.name;this.searchable=!!a.searchable;this.visible=!!a.visible;this.format=a.format}a.prototype.toJson=function(){return{alias:this.alias,dataType:this.dataType,displayName:this.displayName,focusField:this.focusField,hyperlinkLabel:this.hyperlinkLabel,
name:this.name,searchable:this.searchable,visible:this.visible,format:this.format}};a.convertFromEsriType=function(a){if(!a||0!==a.indexOf("esriFieldType"))return a;switch(a){case f.esriFieldTypeGeometry:case f.esriFieldTypeBlob:case f.esriFieldTypeRaster:return d.essentialsFieldTypeObject;case f.esriFieldTypeDate:return d.essentialsFieldTypeDate;case f.esriFieldTypeDouble:return d.essentialsFieldTypeDouble;case f.esriFieldTypeGlobalID:return d.essentialsFieldTypeGUID;case f.esriFieldTypeInteger:case f.esriFieldTypeOID:return d.essentialsFieldTypeInteger;
case f.esriFieldTypeSingle:return d.essentialsFieldTypeSingle;case f.esriFieldTypeSmallInteger:return d.essentialsFieldTypeSmallInteger;default:return d.essentialsFieldTypeString}};a.convertToEsriFieldType=function(a){switch(a){case c.EssentialsFieldTypes.essentialsFieldTypeObject:return f.esriFieldTypeBlob;case c.EssentialsFieldTypes.essentialsFieldTypeDate:return f.esriFieldTypeDate;case c.EssentialsFieldTypes.essentialsFieldTypeDouble:return f.esriFieldTypeDouble;case c.EssentialsFieldTypes.essentialsFieldTypeGUID:return f.esriFieldTypeGlobalID;
case c.EssentialsFieldTypes.essentialsFieldTypeInteger:return f.esriFieldTypeInteger;case c.EssentialsFieldTypes.essentialsFieldTypeSingle:return f.esriFieldTypeSingle;case c.EssentialsFieldTypes.essentialsFieldTypeSmallInteger:return f.esriFieldTypeSmallInteger;case c.EssentialsFieldTypes.essentialsFieldTypeString:return f.esriFieldTypeString;default:return f.esriFieldTypeString}};return a}();c.Field=b})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(h){var f=function(){function d(b,a){this.encodeUriReplacementValues=b.encodeUriReplacementValues;this.target=b.target;this.text=b.text;this.toolTip=b.toolTip;var g=null;a instanceof h.Layer?(this.layer=a,this.layer.mapService&&(this.mapService=this.layer.mapService)):a instanceof h.MapService&&(this.mapService=a);this.mapService&&this.mapService.essentialsMap&&(g=this.mapService.essentialsMap.site);this.uri=c.essentials.RestHelper.processClientSideTokens(g,b.uri);this.iconUri=
c.essentials.RestHelper.processClientSideTokens(g,b.iconUri)}d.prototype.toJson=function(){return{encodeUriReplacementValues:this.encodeUriReplacementValues,iconUri:this.iconUri,target:this.target,text:this.text,toolTip:this.toolTip,uri:this.uri}};return d}();h.LayerHyperlink=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(h){var f=function(d){function b(a){d.call(this,a);this.canToggleLabels=this.allowSymbolization=!1;this.charts=[];this.configuredVisible=!1;this.dataLinks=[];this.dataProvider=null;this.defaultVisibility=!1;this.dynamicDefinition=this.drawIndex=this.description=this.defaultNumberFormat=this.defaultDateFormat=this.displayName=this.displayField=null;this.extensions=[];this.featureFillColor=this.featureDescription=this.featureBorderWidth=this.featureBorderColor=null;this.featureHyperlinks=
[];this.featureLongDescription=this.featureLabel=null;this.featureType="None";this.featureZoomScale=this.featureZoomFactor=null;this.fields=[];this.fullExtent=null;this.hasReports=this.hasDataLinks=this.hasAttachments=!1;this.id=this.iconUri=null;this.identifiableAtAllScales=this.identifiable=!1;this.includeInLegend=this.includeInLayerList=!0;this.isUserCreated=this.isExpanded=this.isDynamic=!1;this.catalogId=this.userLayerType=null;this.layerHyperlinks=[];this.mapService=this.legendUrl=null;this.minScale=
this.maxScale=0;this.primaryKeyField=this.parentLayerId=this.name=null;this.properties={};this.queryable=!1;this.relationships=[];this.reports=[];this.searchable=!1;this.showFeatureHyperlinks="ShowAll";this.showLabels=!0;this.supportsQuery=this.supportsIdentify=this.snappingEnabled=this.snappable=this.showMapTips=!1;this.styleName=null;this.styles=[];this.subLayerIds=[];this.timeZoneId=null;this.type=c.essentials.LayerType.UNKNOWN;this.visibleStateForRefresh=c.essentials.RefreshVisibility.DEFAULT;
this.wmsLayerName=null;this.inActiveTheme=!0;this.layerThemeSettings=[];this._visible=!1;this._gcxTimeInfo=this._timeInfo=this._featureLayerPromise=null;this.setInActiveTheme(!0)}__extends(b,d);b.prototype.getFeatureLayer=function(){var a=this;if(!this._featureLayerPromise)if(this.mapService.serviceUrl&&this.mapService.serviceUrl.endsWith("/MapServer"))this._featureLayerPromise=new Promise(function(b,c){a.mapService._getLayersInfo().then(function(g){var d=null;if(g&&g.layers)if(g.layers.forEach(function(b){a.id===
b.id.toString()&&(d=new esri.layers.FeatureLayer({layerDefinition:b}))}),!d&&g.tables&&g.tables.forEach(function(b){a.id===b.id.toString()&&(d=new esri.layers.FeatureLayer({layerDefinition:b}))}),d)b(d);else if(a.isDynamic&&a.mapService&&a.mapService.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer){var f=a.mapService.serviceLayer;if(f.dynamicLayerInfos){g=null;for(var h in f.dynamicLayerInfos)if(f.dynamicLayerInfos.hasOwnProperty(h)&&f.dynamicLayerInfos[h].id==parseInt(a.id)){g=f.dynamicLayerInfos[h].source;
break}if(g){h=a.mapService.serviceUrl+"/dynamicLayer";var d=new esri.layers.FeatureLayer(a.mapService.serviceToken?h+"?token="+a.mapService.serviceToken:h,{source:g}),q=d.on("load",function(a){q.remove();s.remove();b(d)}),s=d.on("error",function(a){q.remove();s.remove();c(Error("Could not create a Feature Layer from the given dynamic layer source. Reason: {0}".format(a.error&&a.error.message?a.error.message:"Could not determine underlying error.")))})}else c(Error("Could not find LayerSource for the given dynamic layer."))}}})});
else{var b;b=this.mapService.serviceLayer instanceof esri.layers.FeatureLayer?this.mapService.serviceLayer:new esri.layers.FeatureLayer(this.getLayerUrl());this._featureLayerPromise=b.loaded?Promise.resolve(b):new Promise(function(c,d){var l=b.on("load",function(){l.remove();f.remove();if(a.wmsLayerName)for(var d=a.fields,k=b.fields.length-1;0<=k;k--){var q=b.fields[k];"gml:id"===q.name&&b.fields.splice(k,1);q.type=h.Field.convertToEsriFieldType(d[k].dataType)}c(b)}),f=b.on("error",function(a){l.remove();
f.remove();d(a)})})}return this._featureLayerPromise};b.prototype.getRelatedFeatureLayer=function(a,b,d){var k=new dojo.Deferred,l=function(a){c.deferredResolve(k,a);"function"==typeof b&&b(a)},f=this._getRelation(a);if(!f)return l=Error("Relation not found: "+a),k&&-1==k.fired&&k.resolve(l),"function"==typeof d&&d(l),k;a=this.getLayerUrl();f=a.substring(0,a.lastIndexOf("/")+1)+f.relatedTableId;this.mapService&&this.mapService.serviceToken&&(f+=-1<f.indexOf("?")?"&token=":"?token=",f+=encodeURIComponent(this.mapService.serviceToken));
void 0===esri.getProxyRule(f)&&null!==this.mapService.proxyUrl&&esri.addProxyRule({urlPrefix:f,proxyUrl:this.mapService.proxyUrl});f=new esri.layers.FeatureLayer(f,{mode:esri.layers.FeatureLayer.MODE_SELECTION,outFields:["*"]});f.loaded?l(f):dojo.connect(f,"onLoad",dojo.hitch(this,l));dojo.connect(f,"onError",dojo.hitch(this,function(a){k&&-1==k.fired&&k.resolve(a);"function"==typeof d&&d(a)}));return k};b.prototype.areAllAncestorsVisible=function(){for(var a=this.mapService.findLayerById(this.parentLayerId);null!==
a&&void 0!==a;){if(!a.isVisible())return!1;a=this.mapService.findLayerById(a.parentLayerId)}return!0};b.prototype.getLayerUrl=function(){if(this.mapService&&this.mapService.serviceUrl){if("FeatureLayer"===this.mapService.drawingBehavior)return this.mapService.serviceUrl;if("WMS"===this.mapService.mapServiceType){var a=this.mapService.url+"/layers/"+this.id,b=h.RestHelperHTTPService.getTokenForScope(this.mapService.url);b&&(a+=-1<a.indexOf("?")?"&token=":"?token=",a+=encodeURIComponent(b));return a}return this.mapService.serviceUrl+
"/"+this.id}return null};b.prototype.getFieldByName=function(a){if(this.fields&&0<this.fields.length){if(!this._fieldLookup){this._fieldLookup={};for(var b=0;b<this.fields.length;b++){var c=this.fields[b];this._fieldLookup[c.name]=c}}return this._fieldLookup[a]}return null};b.prototype.isVisible=function(){return this._visible};b.prototype.setVisibility=function(a,b){if(this.mapService){switch(this.mapService.mapServiceType){case c.essentials.MapServiceType.DYNAMIC:case c.essentials.MapServiceType.FEATURE:case c.essentials.MapServiceType.WMS:case c.essentials.MapServiceType.WMTS:case c.essentials.MapServiceType.GEORSS:case c.essentials.MapServiceType.KML:case c.essentials.MapServiceType.TILED:this._visible=
a;break;default:this._visible=!0}this.mapService._setVisibility(this.id,this._visible,b)}};b.prototype.setInActiveTheme=function(a){this.inActiveTheme=a;dojo.publish("LayerInActiveThemeChangedEvent",this)};b.prototype.findReportById=function(a){return c.essentials.utilities.SiteResourceIdComparer.lookUp(this.reports,a)};b.prototype.withinScaleRange=function(a){if(0==this.maxScale&&Infinity==this.minScale||isNaN(this.maxScale)&&isNaN(this.minScale))return!0;null==a&&(a=this.mapService.essentialsMap.calculateScale());
return this.maxScale<a&&a<this.minScale};b.prototype._configureDataLinks=function(a,b,d){for(d=0;a&&d<a.length;d++){var k=this.dataLinks[d]=new c.essentials.DataLink(this.url+"/datalinks/"+a[d].id);k.layer=this;k._configureObject(a[d],b)}};b.prototype._idIsUnique=function(a){if(this.mapService&&a){var b=[];dojo.forEach(this.mapService.layers,function(a){b.push(a.id)});if(0>b.indexOf(a))return!0}return!1};b.prototype._getUniqueId=function(){if(this.mapService){var a=[];dojo.forEach(this.mapService.layers,
function(b){a.push(b.id)});if(0<a.length){var b=Math.max.apply(null,a);b++;return b.toString()}}return"0"};b.prototype.createFromDefinition=function(a){this._createFrom(a)};b.prototype._createFrom=function(a){this.defaultVisibility=a.defaultVisibility;this.configuredVisible=a.visible;this.displayName=a.displayName||a.name;this.description=a.description;this.featureDescription=a.featureDescription;a.hasOwnProperty("featureLongDescription")?this.featureLongDescription=a.featureLongDescription:this.featureLongDescription=
a.featureDescription;this.featureLabel=a.featureLabel;this.featureType=a.featureType;this.featureZoomScale=a.featureZoomScale;this.featureZoomFactor=a.featureZoomFactor;this.hasDataLinks=a.hasDataLinks;this.hasReports=a.hasReports;this.hasAttachments=a.hasAttachments;a.hasOwnProperty("id")?this.id=a.id:this.id=this._getUniqueId();this.name=a.name;this.wmsLayerName=a.nativeID;this.parentLayerId=a.parentLayerId;this.subLayerIds=a.subLayerIds;this._visible=a.visible;this.styleName=a.styleName;this.legendUrl=
a.legendUrl;this.isUserCreated=void 0==a.isUserCreated?this.isUserCreated:a.isUserCreated;this.userLayerType=void 0==a.userLayerType?this.userLayerType:a.userLayerType;this.isDynamic=a.isDynamic;this.dynamicDefinition=a.dynamicDefinition;this.dataProvider=a.dataProvider;this.defaultDateFormat=a.defaultDateFormat;this.defaultNumberFormat=a.defaultNumberFormat;this.timeZoneId=a.timeZoneId;a.fullExtent&&(this.fullExtent=new esri.geometry.Extent(a.fullExtent));a.hasOwnProperty("drawIndex")&&(this.drawIndex=
a.drawIndex);a.hasOwnProperty("identifiable")&&(this.identifiable=a.identifiable);a.hasOwnProperty("includeInLayerList")&&(this.includeInLayerList=a.includeInLayerList);a.hasOwnProperty("includeInLegend")&&(this.includeInLegend=a.includeInLegend);a.hasOwnProperty("featureBorderColor")&&(this.featureBorderColor=a.featureBorderColor)&&4<=this.featureBorderColor.length&&1<=this.featureBorderColor[3]&&(this.featureBorderColor[3]/=255);a.hasOwnProperty("featureBorderWidth")&&(this.featureBorderWidth=a.featureBorderWidth);
a.hasOwnProperty("featureFillColor")&&(this.featureFillColor=a.featureFillColor)&&4<=this.featureFillColor.length&&1<=this.featureFillColor[3]&&(this.featureFillColor[3]/=255);a.hasOwnProperty("minScale")&&!isNaN(a.minScale)&&0!=a.minScale?this.minScale=a.minScale:this.minScale=Infinity;a.hasOwnProperty("maxScale")&&!isNaN(a.maxScale)?this.maxScale=a.maxScale:this.maxScale=0;this.mapService&&null!=this.mapService.minScale&&!isNaN(this.mapService.minScale)&&(this.minScale=Math.min(this.minScale,this.mapService.minScale));
this.mapService&&null!=this.mapService.maxScale&&!isNaN(this.mapService.maxScale)&&(this.maxScale=Math.max(this.maxScale,this.mapService.maxScale));a.hasOwnProperty("queryable")&&(this.queryable=a.queryable);a.hasOwnProperty("searchable")&&(this.searchable=a.searchable);a.hasOwnProperty("snappable")&&(this.snappable=a.snappable);a.hasOwnProperty("snappingEnabled")&&(this.snappingEnabled=a.snappingEnabled);a.hasOwnProperty("showFeatureHyperlinks")&&(this.showFeatureHyperlinks=a.showFeatureHyperlinks);
a.hasOwnProperty("canToggleLabels")&&(this.canToggleLabels=a.canToggleLabels);a.hasOwnProperty("showLabels")&&(this.showLabels=a.showLabels);a.hasOwnProperty("showMapTips")&&(this.showMapTips=a.showMapTips);a.hasOwnProperty("supportsIdentify")&&(this.supportsIdentify=a.supportsIdentify);a.hasOwnProperty("supportsQuery")&&(this.supportsQuery=a.supportsQuery);if(a.hasOwnProperty("layerHyperlinks"))for(b=0;b<a.layerHyperlinks.length;b++)this.layerHyperlinks[b]=new c.essentials.LayerHyperlink(a.layerHyperlinks[b],
this);void 0!==a.type&&(this.type=this._layerTypeStringToEssentialsLayerType(a.type));if(a.fields)for(var b=0;b<a.fields.length;b++){var d=a.fields[b],k={layer:this,dataType:c.essentials.Field.convertFromEsriType(d.type||d.dataType),alias:d.alias,displayName:d.displayName||d.alias||d.name,name:d.name,searchable:!0,visible:!0,focusField:!1,hyperlinkLabel:null,format:d.format};d.hasOwnProperty("searchable")&&(k.searchable=d.searchable);d.hasOwnProperty("visible")&&(k.visible=d.visible);this.fields[b]=
new c.essentials.Field(k)}this.primaryKeyField=this.getFieldByName(a.primaryKeyField);this.displayField=this.getFieldByName(a.displayField);a.properties&&(this.properties=c._getProperties(a.properties),this.catalogId=this.properties.layerCatalogLookupId);a.extensions&&(this.extensions=c._getExtensions(a.extensions));this.isInitialized=!0};b.prototype._configureObject=function(a,b){if(void 0===a||void 0===a.name||void 0===a.id)throw Error("Incorrect layer object returned from initialization");this.allowSymbolization=
a.allowSymbolization;this.defaultVisibility=a.defaultVisibility;this.configuredVisible=a.visible;this.displayName=a.displayName;this.description=a.description;this.featureDescription=a.featureDescription;a.hasOwnProperty("featureLongDescription")?this.featureLongDescription=a.featureLongDescription:this.featureLongDescription=a.featureDescription;this.featureLabel=a.featureLabel;this.featureType=void 0===a.featureType?this.featureType:a.featureType;this.featureZoomScale=void 0===a.featureZoomScale?
this.featureZoomScale:a.featureZoomScale;this.featureZoomFactor=void 0===a.featureZoomFactor?this.featureZoomFactor:a.featureZoomFactor;this.hasDataLinks=void 0==a.hasDataLinks?this.hasDataLinks:a.hasDataLinks;this.hasReports=void 0==a.hasReports?this.hasReports:a.hasReports;this.hasAttachments=a.hasAttachments;this.id=a.id;this.name=a.name;this.wmsLayerName=a.nativeID;this.parentLayerId=a.parentLayerId;this.subLayerIds=a.subLayerIds;this.styleName=a.styleName;this.legendUrl=a.legendUrl;this.catalogId=
void 0==a.catalogId?this.catalogId:a.catalogId;this.isUserCreated=void 0==a.isUserCreated?this.isUserCreated:a.isUserCreated;this.userLayerType=void 0==a.userLayerType?this.userLayerType:a.userLayerType;this.isDynamic=void 0===a.isDynamic?this.isDynamic:a.isDynamic;this.dynamicDefinition=a.dynamicDefinition;this.dataProvider=a.dataProvider;this.defaultDateFormat=a.defaultDateFormat;this.defaultNumberFormat=a.defaultNumberFormat;this.timeZoneId=a.timeZoneId;this._timeInfo=a.timeInfo?a.timeInfo:null;
a.fullExtent&&(this.fullExtent=new esri.geometry.Extent(a.fullExtent));var d=null;this.mapService&&this.mapService.essentialsMap&&(d=this.mapService.essentialsMap.site);this.iconUri=c.essentials.RestHelper.processClientSideTokens(d,a.iconUri);a.hasOwnProperty("includeInLayerList")&&(this.includeInLayerList=a.includeInLayerList);if(this.isUserCreated)this._visible=void 0===a.initiallyVisible?!!a.visible:!!a.initiallyVisible;else if(this._visible=null!=this.mapService.essentialsMap.layerThemesInfo.startupThemeId&&
this.includeInLayerList?!1:void 0===a.initiallyVisible?!!a.visible:!!a.initiallyVisible,a.themeSettings&&a.themeSettings.length)for(var k=0;k<a.themeSettings.length;k++){var l=a.themeSettings[k],f=this.mapService.essentialsMap.layerThemesInfo.getTheme(l.themeID);if(f){var r=void 0==l.visible?this.configuredVisible:l.visible;this.layerThemeSettings.push(new h.LayerThemeSetting(f,r));f.id===this.mapService.essentialsMap.layerThemesInfo.startupThemeId&&this.includeInLayerList&&(this._visible=void 0===
l.initiallyVisible?r:l.initiallyVisible)}}a.hasOwnProperty("drawIndex")&&(this.drawIndex=a.drawIndex);a.hasOwnProperty("featureBorderColor")&&(this.featureBorderColor=a.featureBorderColor)&&4<=this.featureBorderColor.length&&1<=this.featureBorderColor[3]&&(this.featureBorderColor[3]/=255);a.hasOwnProperty("featureBorderWidth")&&(this.featureBorderWidth=a.featureBorderWidth);a.hasOwnProperty("featureFillColor")&&(this.featureFillColor=a.featureFillColor)&&4<=this.featureFillColor.length&&1<=this.featureFillColor[3]&&
(this.featureFillColor[3]/=255);a.hasOwnProperty("identifiable")&&(this.identifiable=a.identifiable);a.hasOwnProperty("includeInLegend")&&(this.includeInLegend=a.includeInLegend);a.hasOwnProperty("minScale")&&!isNaN(a.minScale)&&0!=a.minScale?this.minScale=a.minScale:this.minScale=Infinity;a.hasOwnProperty("maxScale")&&!isNaN(a.maxScale)?this.maxScale=a.maxScale:this.maxScale=0;this.mapService&&null!=this.mapService.minScale&&!isNaN(this.mapService.minScale)&&(this.minScale=Math.min(this.minScale,
this.mapService.minScale));this.mapService&&null!=this.mapService.maxScale&&!isNaN(this.mapService.maxScale)&&(this.maxScale=Math.max(this.maxScale,this.mapService.maxScale));a.hasOwnProperty("queryable")&&(this.queryable=a.queryable);a.hasOwnProperty("searchable")&&(this.searchable=a.searchable);a.hasOwnProperty("showFeatureHyperlinks")&&(this.showFeatureHyperlinks=a.showFeatureHyperlinks);a.hasOwnProperty("canToggleLabels")&&(this.canToggleLabels=a.canToggleLabels);a.hasOwnProperty("showLabels")&&
(this.showLabels=a.showLabels);a.hasOwnProperty("showMapTips")&&(this.showMapTips=a.showMapTips);a.hasOwnProperty("snappable")&&(this.snappable=a.snappable);a.hasOwnProperty("snappingEnabled")&&(this.snappingEnabled=a.snappingEnabled);a.hasOwnProperty("supportsIdentify")&&(this.supportsIdentify=a.supportsIdentify);a.hasOwnProperty("supportsQuery")&&(this.supportsQuery=a.supportsQuery);void 0!==a.type&&(this.type=this._layerTypeStringToEssentialsLayerType(a.type));this.type==c.essentials.LayerType.GROUP_LAYER&&
a.hasOwnProperty("isExpanded")&&(this.isExpanded=a.isExpanded);if(a.featureHyperlinks)for(k=0;k<a.featureHyperlinks.length;k++)this.featureHyperlinks[k]=new c.essentials.FeatureHyperlink(a.featureHyperlinks[k],this);if(a.fields)for(k=0;k<a.fields.length;k++)a.fields[k].layer=this,this.fields[k]=new c.essentials.Field(a.fields[k]);if(a.relationships)for(k=0;k<a.relationships.length;k++)a.relationships[k].displayName&&(a.relationships[k].name=a.relationships[k].displayName),a.relationships[k].id=parseInt(a.relationships[k].id),
a.relationships[k].relatedTableId=parseInt(a.relationships[k].relatedTableId),this.relationships.push(a.relationships[k]);if(a.hasOwnProperty("layerHyperlinks"))for(k=0;k<a.layerHyperlinks.length;k++)this.layerHyperlinks[k]=new c.essentials.LayerHyperlink(a.layerHyperlinks[k],this);if(a.hasOwnProperty("charts")&&c.charting&&dojo.isObject(c.charting.configuration.ChartDefinition))for(k=0;k<a.charts.length;k++)this.charts.push(new c.essentials.LayerChart(a.charts[k],this));if(a.styles&&a.styles.length)for(k=
0;k<a.styles.length;k++)l=a.styles[k],(f=l.definition)&&this.styles.push(new h.LayerStyle(f,l.displayName,l.id));this.primaryKeyField=this.getFieldByName(a.primaryKeyField);this.displayField=this.getFieldByName(a.displayField);this._configureDataLinks(a.dataLinks,b,d);this._configureReports(a.reports,b);b&&(this.isInitialized=!0);this.properties=c._getProperties(a.properties);this.extensions=c._getExtensions(a.extensions)};b.prototype.toJson=function(){return{id:this.id,name:this.name,url:this.url,
defaultVisibility:this.defaultVisibility,visible:this.configuredVisible,displayName:this.displayName,description:this.description,featureDescription:this.featureDescription,featureLongDescription:this.featureLongDescription,featureLabel:this.featureLabel,featureType:this.featureType,featureZoomScale:this.featureZoomScale,featureZoomFactor:this.featureZoomFactor,hasDataLinks:this.hasDataLinks,hasReports:this.hasReports,hasAttachments:this.hasAttachments,nativeID:this.wmsLayerName,parentLayerId:this.parentLayerId,
subLayerIds:(this.subLayerIds||[]).slice(),styleName:this.styleName,legendUrl:this.legendUrl,isDynamic:this.isDynamic,dynamicDefinition:this.dynamicDefinition,dataProvider:this.dataProvider,defaultDateFormat:this.defaultDateFormat,defaultNumberFormat:this.defaultNumberFormat,timeZoneId:this.timeZoneId,fullExtent:this.fullExtent?this.fullExtent.toJson():void 0,drawIndex:this.drawIndex,identifiable:this.identifiable,isExpanded:this.isExpanded,includeInLayerList:this.includeInLayerList,includeInLegend:this.includeInLegend,
featureBorderColor:this.featureBorderColor,featureBorderWidth:this.featureBorderWidth,featureFillColor:this.featureFillColor,minScale:Infinity===this.minScale?0:this.minScale,maxScale:this.maxScale,queryable:this.queryable,searchable:this.searchable,snappable:this.snappable,snappingEnabled:this.snappingEnabled,showFeatureHyperlinks:this.showFeatureHyperlinks,canToggleLabels:this.canToggleLabels,showLabels:this.showLabels,showMapTips:this.showMapTips,supportsIdentify:this.supportsIdentify,supportsQuery:this.supportsQuery,
layerHyperlinks:this.layerHyperlinks.map(function(a){return a.toJson()}),type:this._essentialsLayerTypeToLayerTypeString(this.type),fields:this.fields.map(function(a){return a.toJson()}),primaryKeyField:this.primaryKeyField?this.primaryKeyField.name:void 0,displayField:this.displayField?this.displayField.name:void 0,catalogId:this.catalogId?this.catalogId:void 0,isUserCreated:this.isUserCreated,userLayerType:this.userLayerType,properties:c._propertiesToJson(this.properties),extensions:c._extensionsToJson(this.extensions)}};
b.prototype._configureReports=function(a,b){for(var d=0;a&&d<a.length;d++)this.reports[d]=new c.essentials.Report(this.url+"/reports/"+a[d].id),this.reports[d].layer=this,this.mapService&&this.mapService.essentialsMap&&this.mapService.essentialsMap.site&&(this.reports[d].site=this.mapService.essentialsMap.site),this.reports[d]._configureObject(a[d],b)};b.prototype.getLayerTimeInfo=function(){var a=this;if(!this.mapService||!this.mapService.isTimeAware)return null;if(this._gcxTimeInfo)return this._gcxTimeInfo;
var b=function(b){if(b)return a._timeInfo=b,a._gcxTimeInfo=h.MapService.getGcxTimeInfo(a._timeInfo),a._gcxTimeInfo},d=function(){a.mapService.serviceLayer&&a.mapService.serviceLayer.url&&c.request({url:a.mapService.serviceLayer.url+"/"+a.id,content:{f:"json"},load:function(a){return b(a.timeInfo)},error:function(a){},callbackParamName:"CallBack"})};this._timeInfo?b(this._timeInfo):d()};b.prototype.getObjectIdFieldName=function(){var a=null;this.primaryKeyField&&(a=this.primaryKeyField.name);return a};
b.prototype._layerTypeStringToEssentialsLayerType=function(a){return"FeatureLayer"==a||"DynamicFeatureLayer"==a?c.essentials.LayerType.FEATURE_LAYER:"GroupLayer"==a||"AnnotationLayer"==a?c.essentials.LayerType.GROUP_LAYER:"RasterLayer"==a?c.essentials.LayerType.RASTER_LAYER:"GeoRssLayer"==a?c.essentials.LayerType.GEO_RSS_LAYER:"TableLayer"==a?c.essentials.LayerType.TABLE_LAYER:c.essentials.LayerType.UNKNOWN};b.prototype._essentialsLayerTypeToLayerTypeString=function(a){switch(a){case c.essentials.LayerType.FEATURE_LAYER:return"FeatureLayer";
case c.essentials.LayerType.GROUP_LAYER:return"GroupLayer";case c.essentials.LayerType.RASTER_LAYER:return"RasterLayer";case c.essentials.LayerType.GEO_RSS_LAYER:return"GeoRssLayer";default:return"Unknown"}};b.prototype._getRelation=function(a){"string"==typeof a&&(a=parseInt(a));for(var b=0;b<this.relationships.length;b++)if(this.relationships[b].id==a)return this.relationships[b];return null};b.prototype.getDefinitionExpression=function(a){var b=null,d=parseInt(this.id);a&&(a instanceof esri.layers.ArcGISDynamicMapServiceLayer?
(a=a.layerDefinitions)&&a[d]&&(b=a[d]):a instanceof esri.layers.FeatureLayer&&(d=a.getDefinitionExpression())&&(b=d));b||this.dynamicDefinition&&(b=c.essentials.RestHelper.getDynamicExpressionFromJson(this.dynamicDefinition));return b};b.prototype._createDynamicLayerInfo=function(){var a=null;this.isDynamic&&(a=c.essentials.RestHelper.getDynamicLayerInfoFromJson(this.dynamicDefinition,this.id),Infinity>this.minScale&&(a.minScale=this.minScale),0<this.maxScale&&(a.maxScale=this.maxScale));return a};
b.prototype.getLayerDrawingOptions=function(){var a=null;this.isDynamic&&(a=c.essentials.RestHelper.getLayerDrawingOptionsFromJson(this.dynamicDefinition));return a};b.prototype.getLayerThemeSettings=function(a){for(var b=0;b<this.layerThemeSettings.length;b++){var c=this.layerThemeSettings[b];if(c.theme===a||c.theme.id===a)return c}return null};b.prototype._syncProgramaticallyChangedLayerVisibility=function(a){this._visible=a};return b}(h.AsyncInitializable);h.Layer=f})(c.essentials||(c.essentials=
{}))})(geocortex||(geocortex={}));(function(c){(function(c){var f=function(){return function(){this.type=this.name=this.id=this.featureField=null}}();c.DataLinkParameter=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(h){var f=function(d){function b(a){d.call(this,a);this.displayName=null;this.extensions=[];this.visible=this.id=null;this.isOneToOne=!1;this.layer=null;this.parameters=[];this.searches=[];this.properties={};this._numDataLinkingRequests=0}__extends(b,d);b.prototype.isDataLinking=function(){return!!this._numDataLinkingRequests};b.prototype.performDataLinking=function(a,b,d){var k=this;!a&&0<this.parameters.length&&d&&d(Error("No FeatureSetParameters provided"));for(var l=this.url+
"/link",f=null,h=0;h<this.parameters.length;h++){for(var p=this.parameters[h],q="",s=0;s<a.features.length;s++){var t=a.features[s],u=t.attributes[p.featureField];if(!u&&this.layer&&this.layer.fields){for(var v,x=0;x<this.layer.fields.length;x++){var w=this.layer.fields[x];if(w.name===p.featureField){v=w;break}}if(v){var y;v.alias&&v.alias in t.attributes?y=v.alias:v.displayName&&v.displayName in t.attributes&&(y=v.displayName);y&&y in t.attributes&&u==t.attributes[y]}}q+=(0===q.length?"":",")+(u?
this._prepParamValue(u):" ")}q&&0<q.length&&(f=null===f?{}:f,f[p.id]=q)}f?(a=c.encodeJson(dojo.mixin({f:"json"},f)),this._numDataLinkingRequests++,c.request({url:l,content:a,load:function(a){k._numDataLinkingRequests--;!a&&d&&d(Error("No results"));a.error&&d&&d(a.error);b&&b(k._parseConvertDates(a.results))},error:function(a){k._numDataLinkingRequests--;d&&d(a)},callbackParamName:"CallBack"})):d&&d(Error("Missing Feature Fields."))};b.prototype._configureObject=function(a,b){if(void 0===a||void 0===
a.displayName||void 0===a.parameters)throw Error("Incorrect data link object returned from initialization");this.displayName=a.displayName;this.id=a.id;this.visible=void 0===a.visible?!0:a.visible;this.isOneToOne=!!a.isOneToOne;this.parameters=a.parameters;if(this.searches=a.searches)for(var d=0,k=this.searches.length;d<k;d++)this.searches[d].dataLink=this;b&&(this.isInitialized=!0);this.properties=c._getProperties(a.properties);this.extensions=c._getExtensions(a.extensions)};b.prototype._parseConvertDates=
function(a){for(var b in a)if(a.hasOwnProperty(b)){var c=a[b];"string"===typeof c?6<c.length&&"/Date("===c.substring(0,6)&&(c=parseInt(c.substring(6)),a[b]=new Date(c)):"object"===typeof c&&(a[b]=this._parseConvertDates(c))}return a};b.prototype._prepParamValue=function(a){var b="";"number"===typeof a?b=a.toString():"string"===typeof a&&(b=a.replace(/,/g,"\\,"));return b};return b}(h.AsyncInitializable);h.DataLink=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(c){(function(c){(function(c){c.AUTHOR_DESCRIPTION="author.description";c.AUTHOR_ISSUER_TITLE="author.issuerTitle";c.AUTHOR_TITLE="author.title";c.DESCRIPTION="description";c.EDITOR_DESCRIPTION="editor.description";c.EDITOR_ISSUER_TITLE="editor.issuerTitle";c.EDITOR_TITLE="editor.title";c.FILE_TYPE="fileType";c.GRANT_TOKEN="grants.token";c.ISSUER_TITLE="issuerTitle";c.TAGS="tags";c.TIME_CREATION="timeOfCreation";c.TIME_LAST_ACCESS="timeOfLastAccess";c.TIME_LAST_MODIFICATION=
"timeOfLastModification";c.TITLE="title"})(c.DocumentField||(c.DocumentField={}));(function(c){c.BLOB="application/octet-stream";c.JSON="application/json";c.TEXT="text/plain";c.XML="application/xml"})(c.ContentType||(c.ContentType={}));(function(c){c.BLOB="blob";c.JSON="json";c.TEXT="text";c.XML="xml"})(c.DocumentFormat||(c.DocumentFormat={}));(function(c){c.FROZEN="frozen";c.OWNER="owner";c.READER="reader";c.WRITER="writer";c.READER_LINK="readerLink";c.WRITER_LINK="writerLink";c.GLOBAL_CREATE="global_create";
c.GLOBAL_READER="global_reader";c.GLOBAL_WRITER="global_writer"})(c.GrantKind||(c.GrantKind={}));(function(c){c.PUBLIC="public";c.USER="user"})(c.GrantID||(c.GrantID={}));(function(c){c.LINK="link";c.ROLE="role";c.USER="user";c.POLICY="policy"})(c.MonikerKind||(c.MonikerKind={}));(function(c){c.RANGES="ranges";c.SPATIAL_DISJOINT="spatialDisjoint";c.SPATIAL_INTERSECTS="spatialIntersects";c.SPATIAL_WITHIN="spatialWithin";c.MATCHES="matches";c.VALUES="values"})(c.FilterMethod||(c.FilterMethod={}));(function(c){c.REQUIRE=
"require";c.EXCLUDE="exclude";c.INCLUDE="include"})(c.FilterType||(c.FilterType={}))})(c.documents||(c.documents={}))})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(h){(function(f){f.LINK_QUERY_STRING_KEY="link";var d=function(){function b(){this._initializeDeferred=new dojo.Deferred;this.isInitialized=this.supported=!1;this.self=[];this.userMonikers=[];this.policyMonikers=[];this.userFilter={}}b.prototype.initialize=function(a){this._site=a;var b=/^(.*?)(\/*)$/.exec(a.originalUrl)[1];this._rootUrl=h.utilities.UrlUtilities.simplify(b+"/../../documents");this.supported=4.05<=a.getEssentialsVersion();return this.onInitializeAttempt()};b.prototype.onInitialized=
function(){return this._initializeDeferred.promise};b.prototype.onInitializeAttempt=function(){var a=this;if(this._initializeAttemptThenable)return this._initializeAttemptThenable;if(!this.supported){var d=Error("The Document Store is not supported in the current version of Essentials.");this._initializeDeferred.reject(d);return this._initializeAttemptThenable=(new dojo.Deferred).reject(d)}return this._initializeAttemptThenable=c.request({url:this._rootUrl+"/self",content:{f:"json"},handleAs:"json"},
{usePost:!1}).then(b._processError).then(function(b){a._processSelf(b);a.isInitialized=!0;a._initializeDeferred.resolve()}).then(null,function(b){a._initializeAttemptThenable=null;throw b;})};b.prototype.getRootUrl=function(){this._verifySupported();return this._rootUrl+"/"};b.prototype.canCreate=function(){return 0<this.userMonikers.length};b.prototype.hasPolicyGrant=function(a){return this.policyMonikers.some(function(b){return b.grants.some(a)})};b.prototype.add=function(a){var b=this,c={document:dojo.mixin({},
a)};void 0!==a.content&&(c.json=a.content,delete c.document.content);a=f.BatchRequestBuilder.writeDocument(c);return this.perform(a,!0).then(function(a){return a.document}).then(function(a){return b._processDocument(a)})};b.prototype.addFromFormData=function(a){throw Error("Not implemented.");};b.prototype.addFromForm=function(a){throw Error("Not implemented.");};b.prototype.getById=function(a,c,d){var k=this;void 0===c&&(c=!1);void 0===d&&(d=f.DocumentFormat.JSON);this._verifyDocId(a);if(c)return a=
f.BatchRequestBuilder.readDocument(a,d),this.perform(a).then(function(a){return b._processReadDocumentResponse(a,d)}).then(function(a){return k._processDocument(a)});a=f.BatchRequestBuilder.peekDocument(a);return this.perform(a).then(function(a){return a.document}).then(function(a){return k._processDocument(a)})};b.prototype.getContentUrl=function(a){throw Error("Not implemented.");};b.prototype.updateById=function(a,b){var c=this;this._verifyDocId(a);b.timeOfLastModification||(b.timeOfLastModification=
null);b.editor||(b.editor=null);var d=[],l;for(l in b)b.hasOwnProperty(l)&&d.push(l);if(void 0!==b.content)return l={json:b.content},delete b.content,l.document=dojo.mixin({id:a,updates:d},b),d=f.BatchRequestBuilder.writeDocument(l),this.perform(d,!0).then(function(a){return a.document}).then(function(a){return c._processDocument(a)});d=dojo.mixin({id:a,updates:d},b);d=f.BatchRequestBuilder.updateDocument(d);return this.perform(d,!0).then(function(a){return a.document}).then(function(a){return c._processDocument(a)})};
b.prototype.deleteById=function(a){var b=this;this._verifyDocId(a);a=f.BatchRequestBuilder.deleteDocument(a);return this.perform(a,!0).then(function(a){return a.document}).then(function(a){return b._processDocument(a)})};b.prototype.query=function(a){var c=this;a=dojo.mixin({},a);a.sort&&a.sort.forEach(function(a,c,d){b.matchesFilterFields.some(function(b){return b===a})&&(d[c]="{0}_exact".format(a))});a.sortDescending&&a.sortDescending.forEach(function(a,c,d){b.matchesFilterFields.some(function(b){return b===
a})&&(d[c]="{0}_exact".format(a))});a=f.BatchRequestBuilder.searchDocuments(a);return this.perform(a).then(function(a){Array.isArray(a.matchingDocuments.results)&&a.matchingDocuments.results.forEach(function(a){return c._processDocument(a.entity)});return a.matchingDocuments})};b.prototype.perform=function(a,d){var n=this;void 0===d&&(d=!1);if(!a.action)throw Error("The Document Store batch request does not contain an action");var k=a.action;"perform"!==k&&delete a.action;this._guestLink&&(a.link=
this._guestLink);a.f="json";return this.onInitializeAttempt().then(function(){return n._verifySupported()}).then(function(){return c.request({url:n._rootUrl+"/"+k,content:c.encodeJson(a),handleAs:"json"},{usePost:d})}).then(b._processError)};b.prototype.isOwner=function(a){return a&&a.access?a.access.change:!0};b.prototype.isReadOnly=function(a){return a&&a.access?!!a.access.view&&!a.access.edit&&!a.access.change:!1};b.prototype.isPublic=function(a){return a&&a.id&&a.grants?a.grants.some(function(a){return a.globalId===
f.GrantID.PUBLIC&&(!1===a.revoke||!0===a.assert)}):!1};b.prototype.setGuestLink=function(a){this._guestLink=a};b._processError=function(a){if(a.error)throw a.error;return a};b.prototype._processDocument=function(a){a.timeOfCreation&&(a.timeOfCreation=new Date(a.timeOfCreation));a.timeOfLastAccess&&(a.timeOfLastAccess=new Date(a.timeOfLastAccess));a.timeOfLastModification&&(a.timeOfLastModification=new Date(a.timeOfLastModification));a.timeOfDeletion&&(a.timeOfDeletion=new Date(a.timeOfDeletion));
a.timeOfExpiration&&(a.timeOfExpiration=new Date(a.timeOfExpiration));a.access&&!a.access.monikerIds&&(a.access.monikerIds=this.userMonikers.map(function(a){return a.id}));return a};b._processReadDocumentResponse=function(a,b){var c=a.content.document;c.content=a.content[b];return c};b.prototype._processSelf=function(a){this.self=a.monikers;this.userMonikers=a.monikers.filter(function(a){return a.kind===f.MonikerKind.USER});this.policyMonikers=a.monikers.filter(function(a){return a.kind===f.MonikerKind.POLICY});
0<this.userMonikers.length&&(a=this.userMonikers.map(function(a){return{string:"{0}|{1}".format(f.GrantKind.OWNER,a.globalId)}}),this.userFilter={field:f.DocumentField.GRANT_TOKEN,method:f.FilterMethod.VALUES,range:a})};b.prototype._verifyDocId=function(a){if(!a)throw Error("The Document ID must be set.");if(/[/?#\s]/.test(a))throw Error("The Document ID '{0}' contains illegal characters.".format(a));};b.prototype._verifySupported=function(){if(!this.supported)throw Error("The Document Store is not supported in the current version of Essentials.");
};b.matchesFilterFields=[f.DocumentField.TITLE,f.DocumentField.DESCRIPTION,f.DocumentField.ISSUER_TITLE,f.DocumentField.AUTHOR_TITLE,f.DocumentField.AUTHOR_DESCRIPTION,f.DocumentField.AUTHOR_ISSUER_TITLE,f.DocumentField.EDITOR_TITLE,f.DocumentField.EDITOR_DESCRIPTION,f.DocumentField.EDITOR_ISSUER_TITLE];return b}();f.DocumentStore=d})(h.documents||(h.documents={}))})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(c){(function(c){(function(c){c.cloneDocument=function(b,a,c){return{action:"cloneDocument",id:b,document:a,createOnly:c}};c.createDocument=function(b,a){return{action:"createDocument",document:b,streamId:a}};c.createMoniker=function(b,a){return{action:"createMoniker",moniker:b,createOnly:a}};c.deleteDocument=function(b){return{action:"deleteDocument",id:b}};c.deleteMoniker=function(b){return{action:"deleteMoniker",id:b}};c.describe=function(b){return{action:"describe",streamId:b}};
c.generateLinks=function(b){return{action:"generateLinks",count:b}};c.modifyDocument=function(b,a){return{action:"modifyDocument",document:b,streamId:a}};c.openDocument=function(b,a,c){return{action:"openDocument",id:b,streamId:a,startPosition:c}};c.peekDocument=function(b,a){void 0===a&&(a=!1);return{action:"peekDocument",id:b,throwIfMissing:a}};c.peekDocumentAccess=function(b){return{action:"peekDocumentAccess",id:b}};c.peekMoniker=function(b,a){return{action:"peekMoniker",id:b,throwIfMissing:a}};
c.peekMonikerAccess=function(b){return{action:"peekMonikerAccess",id:b}};c.previewDocument=function(b,a){return{action:"previewDocument",id:b,streamId:a}};c.previewMoniker=function(b,a){return{action:"previewMoniker",id:b,streamId:a}};c.readDocument=function(b,a){return{action:"readDocument",id:b,format:a}};c.restoreDocument=function(b){return{action:"restoreDocument",globalId:b}};c.restoreMoniker=function(b){return{action:"restoreMoniker",globalId:b}};c.resumeDocument=function(b,a){return{action:"resumeDocument",
globalId:b,streamId:a}};c.scrub=function(b){return{action:"scrub",scrubOptions:b}};c.searchDocuments=function(b){return{action:"searchDocuments",documentQuery:b}};c.searchMonikers=function(b){return{action:"searchMonikers",monikerQuery:b}};c.searchRoles=function(b){return{action:"searchRoles",searchClause:b}};c.searchUsers=function(b){return{action:"searchUsers",searchClause:b}};c.self=function(){return{action:"self"}};c.touchDocument=function(b,a,c){return{action:"touchDocument",id:b,modify:a,throwIfMissing:c}};
c.updateDocument=function(b){return{action:"updateDocument",document:b}};c.updateMoniker=function(b){return{action:"updateMoniker",moniker:b}};c.writeDocument=function(b){return{action:"writeDocument",content:b}}})(c.BatchRequestBuilder||(c.BatchRequestBuilder={}))})(c.documents||(c.documents={}))})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(c){var f=function(){return function(c,b){void 0===b&&(b="Png");this.defaultOutputFormat=b;this.allowIncludeGeoreferenceData=c}}();c.ExportMapImageOptions=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));(function(c){c=c.essentials||(c.essentials={});c=c.exportMap||(c.exportMap={});(c.BingEnvironment||(c.BingEnvironment={})).PRODUCTION="Production"})(geocortex||(geocortex={}));
(function(c){(function(c){var f=function(){function c(b,a,d,n){void 0===n&&(n=!1);this.rendererJson=b;this.displayName=a;this.id=d;this.enabled=n}c.prototype.getRenderer=function(){return esri.renderer.fromJson(JSON.parse(this.rendererJson))};c.prototype.setRenderer=function(b){b instanceof esri.renderer.Renderer?this.rendererJson=JSON.stringify(b.toJson()):esri.renderer.fromJson(JSON.parse(b))instanceof esri.renderer.Renderer&&(this.rendererJson=b)};c.prototype.isSimple=function(){return"simple"===
JSON.parse(this.rendererJson).type?!0:!1};return c}();c.LayerStyle=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));(function(c){(function(c){var f=function(){return function(c){this.siteId=c}}();c.LayerCatalog=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(h){var f=function(d){function b(a){d.call(this,a);this.displayName=null;this.parameters=[];this.iconUri=this.featureLongDescription=this.featureLabel=this.featureDescription=this.site=this.id=null;this._searching=this.includeInGlobalSearch=!1;this._onSearchingError=this._onSearchingComplete=null}__extends(b,d);b.prototype._configureObject=function(a,b){if(void 0===a||void 0===a.id||void 0==a.displayName)throw Error("Incorrect search table object returned from initialization");
this.id=a.id;this.displayName=a.displayName;this.parameters=a.parameters;this.featureDescription=a.featureDescription;this.featureLabel=a.featureLabel;this.featureLongDescription=a.featureLongDescription;this.iconUri=c.essentials.RestHelper.processClientSideTokens(this.site,a.iconUri);this.includeInGlobalSearch=a.includeInGlobalSearch};b.prototype.isSearching=function(){return this._searching};b.prototype.performSearch=function(a,b,d){a||(this._searching=!1,d&&d(Error("No searchParameters provided")));
this.isSearching()&&(this._searching=!1,d&&d(Error("Currently performing a search")));this._searching=!0;this._onSearchingComplete=dojo.hitch(this,b);this._onSearchingError=dojo.hitch(this,d);b=this.url+"/search";d="";for(var k in a)a.hasOwnProperty(k)&&(d+=(d?"&":"")+k+"="+a[k]);c.request({url:b+("?"+d),content:{f:"json"},handleAs:"json",load:dojo.hitch(this,this._searchRestComplete),error:dojo.hitch(this,this._searchRestError),callbackParamName:"CallBack"})};b.prototype._searchRestComplete=function(a){this._searching=
!1;!a&&this._onSearchingError&&this._onSearchingError(Error("No results"));a.error&&this._onSearchingError&&this._onSearchingError(a.error);this._onSearchingComplete&&this._onSearchingComplete(new esri.tasks.FeatureSet(a))};b.prototype._searchRestError=function(a){this._searching=!1;this._onSearchingError&&this._onSearchingError(a)};return b}(h.AsyncInitializable);h.SearchTable=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(c){var f=function(){return function(){this.type=this.name=null}}();c.SearchTableParameter=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));(function(c){c=c.essentials||(c.essentials={});c=c.TimeSliderMode||(c.TimeSliderMode={});c[c.Extent=0]="Extent";c[c.Cumulative=1]="Cumulative";c[c.Instant=2]="Instant"})(geocortex||(geocortex={}));
(function(c){(function(h){var f=function(d){function b(a){d.call(this,a)}__extends(b,d);b.prototype._configureObject=function(a,b){this.id=a.id;this.displayName=a.displayName;this.description=a.description;this.mode=h.TimeSliderMode[a.mode];this.displayFormat=a.displayFormat;this.timeExtent={startTime:h.utilities.StringUtilities.getDateFromRestDateString(a.startTime),endTime:h.utilities.StringUtilities.getDateFromRestDateString(a.endTime)};this.initialTimeExtent={startTime:h.utilities.StringUtilities.getDateFromRestDateString(a.initialStartTime),
endTime:h.utilities.StringUtilities.getDateFromRestDateString(a.initialEndTime)};this.timeInterval=a.timeInterval;this.timeIntervalUnit=h.EssentialsTimeUnits[a.timeIntervalUnit];this.snapToTimeIntervals=a.snapToTimeIntervals;this.properties=c._getProperties(a.properties);this.extensions=c._getExtensions(a.extensions)};return b}(h.AsyncInitializable);h.TimeSliderProfile=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(c){var f=function(){function b(){}b.UNIT_CENTURIES="esriTimeUnitsCenturies";b.UNIT_DAYS="esriTimeUnitsDays";b.UNIT_DECADES="esriTimeUnitsDecades";b.UNIT_HOURS="esriTimeUnitsHours";b.UNIT_MILLISECONDS="esriTimeUnitsMilliseconds";b.UNIT_MINUTES="esriTimeUnitsMinutes";b.UNIT_MONTHS="esriTimeUnitsMonths";b.UNIT_SECONDS="esriTimeUnitsSeconds";b.UNIT_WEEKS="esriTimeUnitsWeeks";b.UNIT_YEARS="esriTimeUnitsYears";b.UNIT_UNKNOWN="esriTimeUnitsUnknown";return b}();c.TimeUnits=f;var d=
function(){function b(){}b.Century=f.UNIT_CENTURIES;b.Day=f.UNIT_DAYS;b.Decade=f.UNIT_DECADES;b.Hour=f.UNIT_HOURS;b.MilliSecond=f.UNIT_MILLISECONDS;b.Minute=f.UNIT_MINUTES;b.Month=f.UNIT_MONTHS;b.Second=f.UNIT_SECONDS;b.Week=f.UNIT_WEEKS;b.Year=f.UNIT_YEARS;return b}();c.EssentialsTimeUnits=d})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(h){(function(f){var d=function(){function b(){this.supported=this.initialized=!1}b.prototype.initialize=function(a){this._site=a;this._rootUrl=h.utilities.UrlUtilities.resolveUrl(a.url,"/../../../connections",!0);this.supported=4.05<=a.getEssentialsVersion();this.initialized=!0};b.prototype.getRootUrl=function(){return this._rootUrl};b.prototype.suggestHints=function(a){return this.sendRequest("suggest",{f:"json",term:a}).then(function(a){return a.hints})};b.prototype.findServices=
function(a,b){var c=this,d={f:"json",term:a,whitelistOnly:!0};b&&(d=dojo.mixin(d,b));return this.sendRequest("find",d).then(function(a){Array.isArray(a.results)&&a.results.forEach(function(a){return c._processItem(a)});return a.results})};b.prototype.expandService=function(a){var b=this,c=this._getConnectionId(a);return this.sendRequest(c+"/expand",{f:"json",providerName:a.serviceProviderName,url:a.url}).then(function(a){return b._processItem(a)})};b.prototype.realizeMapService=function(a,b){var c=
this,d=this._getConnectionId(a);return this.sendRequest(d+"/realize",{f:"json",providerName:a.serviceProviderName,url:a.url,sr:b,itemId:a.id||"null"}).then(function(b){return c._createMapService(a,b)})};b.prototype.sendRequest=function(a,b){var d=this;return c.framework.SimplePromise.resolve(null).then(function(){return d._verifyInitialized()}).then(function(){return d._verifySupported()}).then(function(){b.f=b.f||"json";return c.request({url:h.utilities.UrlUtilities.resolveUrl(d._rootUrl,a),content:c.encodeJson(b),
handleAs:"json"})}).then(this._processError)};b.prototype._getConnectionId=function(a){return a.connection&&null!=a.connection.id?a.connection.id:"none"};b.prototype._processError=function(a){if(a&&a.error)throw a.error;return a};b.prototype._processItem=function(a){a.isWhitelisted=a.connection&&null!=a.connection.id?!0:!1;if(!a.thumbnailUrl){var b=this._getConnectionId(a)+"/preview?f=json&providerName="+a.serviceProviderName+"&url="+a.url;a.thumbnailUrl=h.utilities.UrlUtilities.resolveUrl(this._rootUrl,
b)}if(a.children)for(var b=0,c=a.children;b<c.length;b++)this._processItem(c[b]);return a};b.prototype._createMapService=function(a,b){b.serviceUrl||(b.serviceUrl=a.url);!b.serviceUrl&&b.connectionString&&(b.serviceUrl=h.ServiceHelper.extractConnectionStringValue(b.connectionString,"url"));return b.serviceUrl?h.utilities.ServiceDiscoveryUtilities.buildMapService(this._site.essentialsMap,b):c.framework.SimplePromise.reject(Error("SiteServiceDiscoveryProvider._createMapService: Cannot create map service, the service URL is required."))};
b.prototype._verifySupported=function(){if(!this.supported)throw Error("Service Discovery is not supported in the current version of Geocortex Essentials.");};b.prototype._verifyInitialized=function(){if(!this.initialized)throw Error("The Service Discovery client is not initialized yet.");};return b}();f.SiteServiceDiscoveryProvider=d})(h.serviceDiscovery||(h.serviceDiscovery={}))})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){c=c.essentials||(c.essentials={});c=c.exportMap||(c.exportMap={});c=c.ExportMapTypes||(c.ExportMapTypes={});c.WEBTILED="WebTiledLayer";c.BINGAERIAL="BingMapsAerial";c.BINGAERIALLABELS="BingMapsAerialWithLabels";c.BINGROADS="BingMapsRoad";c.BINGHYBRID="BingMapsHybrid"})(geocortex||(geocortex={}));
(function(c){(function(h){(function(f){var d=function(){function b(a){this._site=this._essentialsRestUrl=this._esriMap=this.resource=null;this._internalLayerIdsToRemove=["snapping_graphics","snapping_helper_graphics"];this._populateFromResource(a);if(!this._esriMap||!this._essentialsRestUrl)throw Error("Unable to create ExportMapTask from the resource.");}b.prototype._populateFromResource=function(a){a instanceof h.Map?(this._esriMap=a.getMap(),this._essentialsRestUrl=a.url+"/export",this._site=a.site):
a instanceof h.PrintTemplate?(this._esriMap=a.site.getMap(),this._essentialsRestUrl=a.url+"/print",this._site=a.site):a instanceof h.Report&&(this._esriMap=a.site.getMap(),this._essentialsRestUrl=a.url+"/run",this._site=a.site)};b.prototype.generateMapImageUrl=function(a){var b=this,d=new dojo.Deferred;this._marshalContent(a).then(function(a){c.request({url:b._essentialsRestUrl,content:a,load:d.resolve,error:d.reject,callbackParamName:"CallBack"})});return d};b.prototype._getWebMap=function(a,b,c){var d=
new esri.tasks.PrintTemplate;d.outScale=c;c=[];for(var l=0,f=b.graphicsLayerIds;l<f.length;l++){var h=b.getLayer(f[l]);1===h.opacity&&(h.setOpacity(0.999),c.push(h))}try{return a._getPrintDefinition(b,d)}finally{for(a=0;a<c.length;a++)h=c[a],h.setOpacity(1)}};b.prototype._getPrintingObjectForEssentials=function(a){var b=new dojo.Deferred,c=new esri.tasks.PrintTask("http://3275ec4b-ad36-465e-97e9-a20acaae8d53/",{async:!1}),d=null;try{d=this._getWebMap(c,this._esriMap,a)}catch(l){b.reject(Error("Could not create ExportContext definition. {0} Verify that subroutines have not changed.".format(l&&
l.message?l.message:"Unable to determine cause.")))}d?(this._removeInternalLayers(d),this._handleFeatureLayers(d),this._handleDynamicLayerDefs(d),this._cleanOutVisibility(d),this._handleWebTiledLayers(d),this._handleLayersAttribution(d,this._esriMap),this._handleHeatmapRenderer(d,this._esriMap),this._handleClusters(d,this._esriMap),this._adjustMeasurementsMarkup(d),this._adjustPlotCoordinatesMarkup(d),this._removeAttributes(d),this._adjustText(d),this._setServiceVisibilities(d),this._adjustPlotCoordinatesMarkupOrder(d),
this._finalizePrintingContext(d),this._convertSymbolsToBase64(d).then(function(a){return b.resolve(a)},function(a){return b.reject(Error("Converting symbols to base64 failed: {0}".format(a&&a.message?a.message:"Unable to determine cause")))})):b.reject(Error("ExportContext definition was empty"));return b};b.prototype._removeInternalLayers=function(a){for(var b=a.operationalLayers.length-1;0<=b;b--){var c=a.operationalLayers[b].id;c&&-1<this._internalLayerIdsToRemove.indexOf(c)&&a.operationalLayers.splice(b,
1)}};b.prototype._convertSymbolsToBase64=function(a){for(var b=new dojo.Deferred,c=[],d={},l=0;l<a.operationalLayers.length;l++){var f=a.operationalLayers[l];if(f.featureCollection&&f.featureCollection.layers)for(var r=0;r<f.featureCollection.layers.length;r++){var p=f.featureCollection.layers[r];if(p.featureSet&&p.featureSet.features)for(var q=0;q<p.featureSet.features.length;q++){var s=p.featureSet.features[q];s&&s.symbol&&"esriPMS"===s.symbol.type&&(s=s.symbol,s.url&&c.push(s))}}}if(Modernizr&&
Modernizr.canvas){f=[];for(l=0;l<c.length;l++)!(t=c[l].url)||d.hasOwnProperty(t)||c[l].imageData||(d[t]={url:null,data:null},r=h.utilities.PrintUtilities.getImageAsBase64(t),f.push(r));h.utilities.PromiseUtilities.settle(f).then(function(l){l.forEach(function(a){a.isFulfilled()?(a=a.value())&&a.url&&a.data&&(d[a.url]={data:a.data}):(a=a.reason())&&a.url&&(d[a.url]={url:h.utilities.UrlUtilities.simplify(t)});for(a=0;a<c.length;a++){var b=c[a],g=d[b.url];g&&(g.data?(b.imageData=g.data,delete b.url):
g.url&&(b.url=g.url));b.yoffset&&(b.yoffset*=-1)}});b.resolve(a)})}else{for(l=0;l<c.length;l++){var t=c[l].url;t&&(c[l].url=h.utilities.UrlUtilities.simplify(t))}b.resolve(a)}return b};b.prototype._adjustMeasurementsMarkup=function(a){(a=this._getLayer(a,"_measurement"))&&a.id&&this._adjustSvgSymbols(a)};b.prototype._adjustPlotCoordinatesMarkup=function(a){(a=this._getLayer(a,"_coordinates"))&&a.id&&this._adjustSvgSymbols(a)};b.prototype._adjustPlotCoordinatesMarkupOrder=function(a){var b=this._getLayer(a,
"_coordinates");if(b&&b.featureCollection&&b.featureCollection.layers)for(var c=a=null,d=0;d<b.featureCollection.layers.length;d++){var l=b.featureCollection.layers[d];l.layerDefinition&&("pointLayer"===l.layerDefinition.name?a=l:"textLayer"===l.layerDefinition.name&&(c=l));if(a&&c){if(a.featureSet&&a.featureSet.features&&0<a.featureSet.features.length&&c.featureSet&&c.featureSet.features&&0<c.featureSet.features.length&&1.5===c.featureSet.features.length/a.featureSet.features.length){for(b=[];0<
a.featureSet.features.length;)b.push(c.featureSet.features.pop()),b.push(c.featureSet.features.pop()),b.push(c.featureSet.features.pop()),b.push(a.featureSet.features.pop()),b.push(a.featureSet.features.pop());a.featureSet.features=b.reverse()}break}}};b.prototype._getLayer=function(a,b){for(var c=0;c<a.operationalLayers.length;c++){var d=a.operationalLayers[c];if(d&&d.id&&-1<d.id.indexOf(b)&&d.featureCollection&&d.featureCollection.layers)return d}};b.prototype._adjustSvgSymbols=function(a){for(var b=
[],c=this._esriMap.getLayer(a.id).graphics.filter(function(a){return"simplemarkersymbol"==a.symbol.type&&a.visible?!0:!1}),d=0;d<c.length;d++)b.push(c[d].toJson());for(d=0;d<a.featureCollection.layers.length;d++)if("pointLayer"===a.featureCollection.layers[d].layerDefinition.name){a.featureCollection.layers[d].featureSet.features=b;break}};b.prototype._adjustText=function(a){for(var b=0;b<a.operationalLayers.length;b++){var c=a.operationalLayers[b];if(c&&c.id&&c.featureCollection&&c.featureCollection.layers){for(var d=
!1,l=0;l<c.featureCollection.layers.length;l++){var f=c.featureCollection.layers[l];if(f&&f.layerDefinition&&"textLayer"===f.layerDefinition.name){d=!0;break}}if(d&&(d=[],(l=this._esriMap.getLayer(c.id))&&l.graphics)){for(var f=l.graphics.filter(function(a){return("textsymbol"==a.symbol.type||a.symbol instanceof esri.symbol.TextSymbol)&&a.visible?!0:!1}),r=0;r<f.length;r++){var p=f[r],q=h.utilities.PrintUtilities.adjustTextSymbol(p,l.id);q&&(p=new esri.Graphic(p.toJson()),p.symbol=q,d.push(p.toJson()))}for(r=
0;r<c.featureCollection.layers.length;r++)"textLayer"===c.featureCollection.layers[r].layerDefinition.name&&(c.featureCollection.layers[r].featureSet.features=d)}}}};b.prototype._setServiceVisibilities=function(a){if(a.operationalLayers){a=a.operationalLayers;for(var b=0;b<a.length;b++){var c=a[b],d=this._esriMap.getLayer(c.id);c&&(c.visibility=d?d.visible:!0)}}};b.prototype._handleDynamicLayerDefs=function(a){if(this._site&&a.operationalLayers){a=a.operationalLayers;for(var b=0;b<a.length;b++){var c=
this._site.essentialsMap.findMapServiceById(a[b].id);if(c&&c.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer){var d=a[b],l=c.serviceLayer;if(d){if(d.layers){for(var f=[],h=d.layers,p=0;p<h.length;p++){var q=h[p];if(q&&(q.id||0===q.id)){var s=q.id,t={id:s,name:q.name,geometryType:q.geometryType?q.geometryType:null};if(q.layerDefinition){if(q.layerDefinition.drawingInfo||q.layerDefinition.source)t.layerDefinition||(t.layerDefinition={}),t.layerDefinition.drawingInfo=q.layerDefinition.drawingInfo,
t.layerDefinition.source=q.layerDefinition.source;q.layerDefinition.definitionExpression&&(t.layerDefinition?t.layerDefinition.definitionExpression=q.layerDefinition.definitionExpression:t.layerDef=q.layerDefinition.definitionExpression)}(s||0===s)&&(q=c.findLayerById(s.toString()))&&q.displayName&&t.layerDefinition&&(t.layerDefinition.displayName=q.displayName);f.push(t)}}d.layers=f}l.gdbVersion&&(d.gdbVersion=l.gdbVersion);d.visibleLayers=c.serviceLayer.visibleLayers;d.visibility=!0}}}}};b.prototype._handleFeatureLayers=
function(a){if(this._site&&a.operationalLayers){a=a.operationalLayers;for(var b=0;b<a.length;b++){var c=a[b].id,d=this._site.essentialsMap.findMapServiceById(c);if(d&&d.serviceLayer instanceof esri.layers.FeatureLayer){var d=d.serviceLayer,l=a[b],c={id:c,opacity:l.opacity,visibility:!0,url:l.url,minScale:l.minScale?l.minScale:0,maxScale:l.maxScale?l.maxScale:0};d.gdbVersion&&(c.gdbVersion=d.gdbVersion);l.layerDefinition?(l.layerDefinition.drawingInfo&&(c.drawingInfo=l.layerDefinition.drawingInfo),
l.layerDefinition.definitionExpression&&(c.where=l.layerDefinition.definitionExpression)):c.where=d.getDefinitionExpression();c.featureCollection=l.featureCollection;a[b]=c}}}};b.prototype._cleanOutVisibility=function(a){if(a.operationalLayers){a=a.operationalLayers;for(var b=0;b<a.length;b++)if(a[b].visibleLayers)for(var c=0;c<a[b].visibleLayers.length;c++)if(-1==a[b].visibleLayers[c]){a[b].visibleLayers.splice(c,1);break}}};b.prototype._handleWebTiledLayers=function(a){if(a.operationalLayers){a=
a.operationalLayers;for(var b=0;b<a.length;b++)if(a[b].type===f.ExportMapTypes.WEBTILED)a[b]={id:a[b].id,opacity:a[b].opacity,visibility:!0};else if(a[b].type===f.ExportMapTypes.BINGAERIAL||a[b].type===f.ExportMapTypes.BINGAERIALLABELS||a[b].type===f.ExportMapTypes.BINGHYBRID||a[b].type===f.ExportMapTypes.BINGROADS)a[b].type===f.ExportMapTypes.BINGAERIALLABELS&&(a[b].type=f.ExportMapTypes.BINGHYBRID),a[b]={id:a[b].id,opacity:a[b].opacity,visibility:!0,type:a[b].type,token:a[b].key,serverType:f.BingEnvironment.PRODUCTION}}};
b.prototype._handleLayersAttribution=function(a,b){var c=b.layerIds.concat(b.graphicsLayerIds),d=/.*mapservices\/([^/]*)\/Attribution[^/]*/;a.operationalLayers.forEach(function(a){for(var f in c)if(c.hasOwnProperty(f)){var h=c[f];if(a.id===h){f=b.getLayer(h);f.hasAttributionData&&f.attributionDataUrl?(f=d.exec(f.attributionDataUrl))&&1<f.length&&(a.mapServiceId=f[1]):!f.layerId||-1<a.id.indexOf("-")||(a.mapServiceId=f.layerId);break}}})};b.prototype._handleHeatmapRenderer=function(a,b){b.layerIds.concat(b.graphicsLayerIds).forEach(function(c){var d=
b.getLayer(c);if(d.visible&&void 0!==d.renderer&&d.renderer instanceof esri.renderer.HeatmapRenderer){var f=d.minScale?d.minScale:0,m=d.maxScale?d.maxScale:0,h=d.getDefinitionExpression()?d.getDefinitionExpression():"",p=d.gdbVersion?d.gdbVersion:"",q=d.renderer.toJson();c={type:"HeatMap",id:c,opacity:1,minScale:f,maxScale:m,where:h,gdbVersion:p,url:d.url,layerDefinition:{name:d.name,geometryType:"esriGeometryPoint",displayField:d.renderer.field?d.renderer.field:""},drawingInfo:{renderer:q}};for(d=
0;d<a.operationalLayers.length;d++)if(a.operationalLayers[d].id.startsWith("null_image")){a.operationalLayers[d]=c;break}}})};b.prototype._handleClusters=function(a,b){var c=b.layerIds.concat(b.graphicsLayerIds),d=[];a.operationalLayers.forEach(function(a,b,c){a.id.endsWith("-cluster")&&d.push(a.id)});d.forEach(function(b){for(var c=0;c<a.operationalLayers.length;++c)if(a.operationalLayers[c].id===b){a.operationalLayers.splice(c,1);break}});c.forEach(function(c){var d=b.getLayer(c);if(d.id.endsWith("-cluster")&&
d.visible&&void 0!==d.renderer&&d.renderer instanceof esri.renderer.ClassBreaksRenderer&&d.featureLayer&&d.singleFeatureLayer){for(var n=d.featureLayer,k=n.id,f=d.url,h=d.renderer.attributeField,t=d.clusterRadius.get(),u=d.maxFeaturesInCluster.get(),v=d._clusterLabelColor,x=d.singleFeatureLayer.renderer.toJson(),w=d.renderer.toJson(),y=n.name,A=n.minScale?n.minScale:0,B=n.maxScale?n.maxScale:0,C=n.getDefinitionExpression()?n.getDefinitionExpression():"",D=n.gdbVersion?n.gdbVersion:"",z=0;z<a.operationalLayers.length;++z)if(a.operationalLayers[z].id===
k){null===n.renderer&&a.operationalLayers.splice(z,1);break}0==d.singleFeatureLayer.graphics.length&&a.operationalLayers.splice(z,0,{type:"Cluster",id:c,opacity:1,minScale:A,maxScale:B,where:C,gdbVersion:D,url:f,layerDefinition:{name:y,geometryType:"esriGeometryPoint",displayField:h},drawingInfo:{renderer:w,singleSymbolRenderer:x,labelColor:v,distance:t,maxFeaturesInCluster:u}})}})};b.prototype._removeAttributes=function(a){if(a.operationalLayers)for(var b=0;b<a.operationalLayers.length;b++){var c=
a.operationalLayers[b];if(c&&c.featureCollection&&c.featureCollection.layers)for(var d=0;d<c.featureCollection.layers.length;d++){var f=c.featureCollection.layers[d];if((!(f&&f.layerDefinition&&f.layerDefinition.drawingInfo&&f.layerDefinition.drawingInfo.renderer)||"uniqueValue"!==f.layerDefinition.drawingInfo.renderer.type&&"classBreaks"!==f.layerDefinition.drawingInfo.renderer.type)&&f&&f.featureSet&&f.featureSet.features)for(var m=0;m<f.featureSet.features.length;m++){var h=f.featureSet.features[m];
h&&h.attributes&&delete h.attributes}}}};b.prototype._finalizePrintingContext=function(a){this._fixMapServiceIds(a,this._esriMap,this._site)};b.prototype._fixMapServiceIds=function(a,b,c){if(a.operationalLayers&&b&&c){a=a.operationalLayers;for(var d=0;d<a.length;d++){var f=b.getLayer(a[d].id);if(f&&(f instanceof esri.layers.WMSLayer||f instanceof esri.layers.TiledMapServiceLayer)){for(var m=null,h=0;h<c.essentialsMap.mapServices.length;h++)if(c.essentialsMap.mapServices[h].serviceLayer==f){m=c.essentialsMap.mapServices[h];
break}m&&(a[d].id=m.id)}}}};b.prototype._marshalContent=function(a){var b=this,d=new dojo.Deferred,k;a.reportParameters&&a.reportParameters.scale&&(k=parseFloat(a.reportParameters.scale.scale));this._getPrintingObjectForEssentials(k).then(function(k){var f={f:"json","if":"WebMap,blankMap"};b._site&&(k.product="Geocortex Essentials "+b._site.currentVersion,b._site.displayTimeZoneId&&(f.displayTimeZoneId=b._site.displayTimeZoneId));if(a.reportParameters){var h=a.reportParameters;k.mapOptions||(k.mapOptions=
{extent:null});delete k.mapOptions.scale;if(h.scale){var p=parseFloat(h.scale.scale);p&&!isNaN(p)&&(k.mapOptions.scale=p)}h.targetSpatialReference&&(k.mapOptions.spatialReference=h.targetSpatialReference);h.extentType==c.essentials.ReportParameters.CURRENT_EXTENT&&b._esriMap?k.mapOptions.extent=b._esriMap.extent:h.extentType==c.essentials.ReportParameters.FULL_EXTENT&&b._site&&b._site.essentialsMap?k.mapOptions.extent=b._site.essentialsMap.fullExtent:h.extentType==c.essentials.ReportParameters.INITIAL_EXTENT&&
b._site&&b._site.essentialsMap?k.mapOptions.extent=b._site.essentialsMap.initialExtent:h.extentType==c.essentials.ReportParameters.CUSTOM_EXTENT&&h.customExtent&&(k.mapOptions.extent=h.customExtent);p={dpi:null,outputSize:[]};p.outputSize[0]=h.imageWidth?h.imageWidth:b._esriMap.width;p.outputSize[1]=h.imageHeight?h.imageHeight:b._esriMap.height;p.dpi=h.resolution?h.resolution.dpi:96;k.exportOptions=p;h.grid&&h.grid.id&&(k.layoutOptions={grid:h.grid.id});if(h.fields&&0<h.fields.length)for(p=0;p<h.fields.length;p++)f[h.fields[p].id]=
h.fields[p].value;h.outputFormat&&(f.outputFormat=h.outputFormat);h.featureIds&&(f.featureIDs=h.featureIds.join(","));h.includeGeoreferenceData&&(f.georef=h.includeGeoreferenceData);h.includeData&&(f.of=f.of?f.of+",includeData":"includeData")}a.queryParameters&&(f=dojo.mixin(a.queryParameters,f),f.geometry&&(f.geometry=JSON.stringify(f.geometry)));a.operationParameters&&(f=dojo.mixin(a.operationParameters,f));h.notificationEmailAddress&&(f.emailAddress=h.notificationEmailAddress);f.data=JSON.stringify(k);
d.resolve(f)},function(a){return d.reject(Error("Failed to serialize ExportContext content: {0}".format(a&&a.message?a.message:"Unable to determine cause")))});return d};return b}();f.ExportMapTask=d})(h.exportMap||(h.exportMap={}))})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(c){(function(c){var d=function(){function a(){this.state={fulfilled:!1,rejected:!1}}a.prototype.fulfill=function(a){this.state.fulfilled=!0;this.state.value=a};a.prototype.reject=function(a){this.state.rejected=!0;this.state.reason=a};a.prototype.isFulfilled=function(){return this.state.fulfilled};a.prototype.isRejected=function(){return this.state.rejected};a.prototype.isPending=function(){return!this.state.fulfilled&&!this.state.rejected};a.prototype.value=function(){return this.state.value};
a.prototype.reason=function(){return this.state.reason};return a}(),b=function(){function a(){}a.settle=function(b){if(dojo.isArray(b))return a._settleImpl(b);if(b.then)return b.then(function(b){return a._settleImpl(b)});throw Error("Unknown parameter type.  Must be an array of promises or a promise of array of promises.");};a._settleImpl=function(a){var b=new dojo.Deferred,c,f=a.map(function(a){var b=new d;a&&"function"==typeof a.then?a.then(function(a){b.fulfill(a);c&&c()},function(a){b.reject(a);
c&&c()}):b.fulfill(a);return b});c=function(){f.every(function(a){return!a.isPending()})&&b.resolve(f)};c();return b.promise};return a}();c.PromiseUtilities=b})(c.utilities||(c.utilities={}))})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(h){(function(f){var d=function(){function b(){}b.buildMapService=function(a,b){return new c.framework.SimplePromise(function(d,k){if(!a)throw Error('ServiceDiscoveryUtilities.buildMapService: Parameter "essentialsMap" is required.');if(!b)throw Error('ServiceDiscoveryUtilities.buildMapService: Parameter "serviceDefinition" is required.');var f,m={id:c.framework.utils.alphaNumericToken(),connectionString:b.serviceUrl?"url="+b.serviceUrl:void 0},m=dojo.mixin(m,b);if(m.drawingBehavior===
c.essentials.DrawingBehavior.FEATURE_LAYER){if(!dojo.isObject(esri.layers.FeatureLayer))throw Error("This Javascript application must // dojo.require the esri.layers.FeatureLayer package in order to use a site with feature layers");f=new h.FeatureLayerService}else if(m.drawingBehavior===c.essentials.DrawingBehavior.GEORSS_LAYER){if(!dojo.isObject(esri.layers.GraphicsLayer))throw Error("This Javascript application must // dojo.require the esri.layers.GraphicsLayer package in order to use a site with GeoRSS layers");
f=new c.essentials.GeoRssLayerService}else if(m.drawingBehavior===c.essentials.DrawingBehavior.KML_SERVICE){if(!dojo.isObject(esri.layers.KMLLayer))throw Error("This Javascript application must // dojo.require the esri.layers.KMLLayer package in order to use a site with KML layers");f=new c.essentials.KmlService}else f=new h.MapService;f.isUserCreated=!0;f.userLayerType=h.UserLayerType.LAYER_ADDITION;f.essentialsMap=a;f.initialize(m);f instanceof h.FeatureLayerService&&(f.moveEnabled=!0,f.rotateEnabled=
!0,f.editVerticesEnabled=!0,f.scaleEnabled=!0);for(var m=0,r=f.layers;m<r.length;m++){var p=r[m];p.isUserCreated=!0;p.userLayerType=h.UserLayerType.LAYER_ADDITION;p.includeInLayerList=!0;p.includeInLegend=!0;p.site=a.site;p.configuredVisible=!0;f.supportsLayerVisibility()?p.setVisibility(!0):p._visible=!0;if(p.subLayerIds&&0<p.subLayerIds.length)p.supportsIdentify=p.supportsQuery=p.identifiable=p.queryable=!1;else{p.identifiable=p.supportsIdentify;p.queryable=p.supportsQuery;p.searchable=!0;p.showMapTips=
!0;var q=f.serviceLayer,q=q instanceof esri.layers.GraphicsLayer||q instanceof esri.layers.ArcGISDynamicMapServiceLayer;p.snappable=q;p.snappingEnabled=q}}if(f.serviceLayer.loaded)return d(f);var s,t;s=f.serviceLayer.on("load",function(a){s&&s.remove();t&&t.remove();return d(f)});t=f.serviceLayer.on("error",function(a){s&&s.remove();t&&t.remove();return k(a.error)})})};return b}();f.ServiceDiscoveryUtilities=d})(h.utilities||(h.utilities={}))})(c.essentials||(c.essentials={}))})(geocortex||(geocortex=
{}));(function(c){(function(c){var f=function(){return function(){}}();c.EssentialsLayerInfo=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(c){(function(c){function d(){}var b=function(){function a(){}a.prototype.select=function(b){var c=this,d=new a;d._subscribe=function(a){var d=!0,f=c._subscribe({onNext:function(c){if(d)try{a.onNext(b(c))}catch(n){d=!1,a.onError(n)}},onError:function(b){d&&(d=!1,a.onError(b))},onCompleted:function(){d&&(d=!1,a.onCompleted())}});if(d)return f;f.dispose();return{dispose:function(){}}};return d};a.prototype._subscribe=function(a){return{dispose:d}};a.prototype.subscribe=function(a,
b,c){if(1<arguments.length){var f={onNext:a||d,onError:b||d,onCompleted:c||d};return this._subscribe(f)}if(a instanceof Function){if(1<a.length)return f={onNext:function(b){return a(b)},onError:function(b){return a(void 0,b)},onCompleted:function(){return a()}},this._subscribe(f);f={onNext:a,onError:b||d,onCompleted:c||d};return this._subscribe(f)}return a?this._subscribe(a):this._subscribe({onNext:d,onError:d,onCompleted:d})};return a}();c.AnonymousObservable=b})(c.Rx||(c.Rx={}))})(c.essentials||
(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(h){function f(a){for(var b=[],c=1;c<arguments.length;c++)b[c-1]=arguments[c];for(var c=a.length,d=0;d<b.length;d++){var g=a.indexOf(b[d]);0<=g&&g<c&&(c=g)}return g}var d=function(){function a(){}a.prototype.toString=function(){return this.message};return a}();h.ServiceRequestError=d;d.prototype.message="An error occurred while performing the operation.";d.prototype.details=[];d.prototype.name="ServiceRequestError";var b=function(a){function b(){a.apply(this,arguments)}__extends(b,
a);return b}(d);h.ServiceRequestAbortedError=b;b.prototype.message="The request was aborted.";b.prototype.name="ServiceRequestAbortedError";var a=function(){function a(){}a.prototype.start=function(){try{this.promise=c.request(this),this.valid?this.registration=this.servicePoint.cancellationToken.register(this.error.bind(this)):this.promise.cancel()}catch(a){this.error(a)}};a.prototype.load=function(a){try{if(this.member){var b=a[this.member];if(b)for(a=0;a<b.length;a++)if(this.valid)this.observer.onNext(b[a]);
else break}else if(this.valid)this.observer.onNext(a);this.complete()}catch(c){this.error(c)}};a.prototype.error=function(a){this.valid&&(this.valid=!1,this.promise.cancel(),this.registration.dispose(),this.observer.onError(e||new b))};a.prototype.complete=function(){this.valid&&(this.valid=!1,this.promise.cancel(),this.registration.dispose(),this.observer.onCompleted())};a.prototype.dispose=function(){this.valid&&(this.valid=!1,this.promise.cancel(),this.registration.dispose())};return a}();a.prototype.handleAs=
"json";a.prototype.valid=!0;a.prototype.registration={dispose:function(){}};var g,n,d=function(){function b(){}b.prototype.formatQuery=function(a){var b,c;b=[];for(c=1;c<arguments.length;c++)b[c-1]=arguments[c];c=a.format.apply(a,b);var d=f(c,"?","!","#");b=c.substring(0,d);c=c.substring(d);d=this.baseAddress;n||(g=document.head.getElementsByTagName("base")[0],g||(g=document.createElement("base"),g.setAttribute("href",window.location.href),document.head.appendChild(g)),n=document.createElement("a"));
try{var k=g.getAttribute("href");g.setAttribute("href",d);n.setAttribute("href",b);b=n.href}finally{g.setAttribute("href",k)}return b+c};b.prototype.getRequest=function(b,c){var d=function(a){this.observer=a;this.start()};d.prototype=new a;d.prototype.servicePoint=this;d.prototype.query=b;d.prototype.member=c;var g=new h.Rx.AnonymousObservable;g._subscribe=function(a){return new d(a)};return g};return b}();h.ServicePoint=d;d.prototype.baseAddress=window.location.href;d.prototype.cancellationToken=
{dispose:function(){},register:function(a){return this}}})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(c){var f=function(){function c(){this.extent=null;this.maxResults=50;this.contains=!0;this.returnCountOnly=this.returnIdsOnly=this.returnHighlights=this.returnGeometry=!1;this.outSpatialReference=this.searchText=null}c.prototype.toJson=function(b,a){if(!b||!a)throw Error("Search query parameter creation is missing a main map.");var c={searchText:this.searchText,contains:this.contains,returnGeometry:this.returnGeometry,returnHighlights:this.returnHighlights,returnIdsOnly:this.returnIdsOnly,
returnCountOnly:this.returnCountOnly};this.extent&&(c.envelope="{0},{1},{2},{3}".format(this.extent.xmin,this.extent.ymin,this.extent.xmax,this.extent.ymax));(this.returnGeometry||this.extent)&&this.outSpatialReference&&(c.outSR=this.outSpatialReference.toJson());0<this.maxResults&&(c.maxResults=this.maxResults);var d=this.searchLayers;d&&0!=d.length||(d=a.allLayers());c.layers=this._getServiceStrings(d);return c};c.prototype._getServiceStrings=function(b){for(var a="",c={},d=0;d<b.length;d++){var f=
b[d];if(f&&f.searchable&&f.mapService&&f.mapService.instantSearch){var l=f.mapService.id;c.hasOwnProperty(l)||(c[l]=[]);c[l].push(f.id)}}for(var h in c)c.hasOwnProperty(h)&&(a+=0===a.length?"":";",a+="{0}(include:{1})".format(h,c[h].join(",")));return a};return c}();c.SearchQuery=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(c){var f=function(){return function(c){this.features=[];this.layer=null;c&&c.hasOwnProperty("features")&&(this.features=c.features);c&&c.hasOwnProperty("layer")&&(this.layer=c.layer)}}();c.SearchResultSet=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(c){var f=function(){return function(c,b){this.layer=this.esriFeature=null;this.highlights={};this.esriFeature=c;this.layer=b}}();c.SearchResultFeature=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(c){(function(f){var d=function(){function b(a){this.service=a}b.prototype.postProcess=function(a){a.thumbnailUrl||(a.thumbnailUrl=this.service.formatQuery("connections/{0}/preview?f=json&providerName={1}&url={2}",a.connection.id,a.serviceProviderName,a.url));for(var b in a.children)this.postProcess(a.children[b]);return a};b.prototype.findServices=function(a){var b=this.postProcess.bind(this.postProcess);a=this.service.formatQuery("connections/find?f=json&term={0}",a);return this.service.getRequest(a,
"results").select(b)};b.prototype.expandService=function(a,b,c){if(1==arguments.length){var d=a;a=d.connection.id;b=d.serviceProviderName;c=d.url}var d=this.postProcess.bind(this.postProcess),f=this.service.formatQuery("connections/{0}/expand?f=json&providerName={1}&url={2}",a,b,c);return this.service.getRequest(f,null).select(d)};b.prototype.suggestHints=function(a){a=this.service.formatQuery("connections/suggest?f=json&term={0}",a);return this.service.getRequest(a,"hints")};b.prototype.realizeMapService=
function(a,b,d,f){if(1==arguments.length){var l=a;a=l.connection.id;b=l.serviceProviderName;d=l.url}l=this.service.formatQuery("connections/{0}/realize?f=json&providerName={1}&url={2}&sr={3}",a,b,d,f);return this.service.getRequest(l,null).select(function(a){if(0<=a.serviceType.indexOf("FeatureLayer")){var b=new c.FeatureLayerService(d);b._configureObject(a,!0);return b}b=new c.MapService(d);b._configureObject(a,!0);return b})};return b}();f.ServiceDiscoveryServicePoint=d})(c.serviceDiscovery||(c.serviceDiscovery=
{}))})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(c){(function(c){var d=function(){function b(){}b.simplify=function(a){var b=document.createElement("a");b.href=a;a=b.href;b=a.charAt(a.length-1);if("/"===b||"\\"===b)a=a.substr(0,a.length-1);return a};b.getUrlComponents=function(a){var b=document.createElement("a");b.href=a;return{host:b.host,hostname:b.hostname,protocol:b.protocol,port:b.port,query:b.search,hash:b.hash,path:b.pathname,origin:b.protocol+"//"+b.host}};b.resolveUrl=function(a,c,d){void 0===d&&(d=!1);var f=a.endsWith("/")?
"":"/";a=""+a+f+c;d&&(a=b.simplify(a));return a};return b}();c.UrlUtilities=d})(c.utilities||(c.utilities={}))})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(c){(function(f){var d=function(){return function(){this.queryParameters=this.reportParameters=this.operationParameters=null;this.operationParameters={};this.reportParameters=new c.ReportParameters}}();f.ExportMapParameters=d})(c.exportMap||(c.exportMap={}))})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(h){(function(f){var d=function(b){function a(a,d){b.call(this,a,d);this.formItemType="MarkdownFormItem";this.plainText=a?new Observable(c.forms.getElementText(a,"PlainText")):new Observable("")}__extends(a,b);a.prototype._render=function(){return c.forms.renderFormItem(this)};return a}(f.AbstractFormItem);f.MarkdownFormItem=d})(h.items||(h.items={}))})(c.forms||(c.forms={}))})(geocortex||(geocortex={}));
(function(c){(function(c){var f=function(){return function(c,b){this.runtimeTypeName=null;this.runtimeTypeName=c||null;this.value=b||null}}();c.ArgumentValueWrapper=f})(c.workflow||(c.workflow={}))})(geocortex||(geocortex={}));
(function(c){(function(h){(function(f){var d=function(){function b(){}b.createFeatureLayerFromCsv=function(a,b){var d=new dojo.Deferred;if(!a)return d.resolve(null),d;var f=new dojox.data.CsvStore({url:a.url,separator:a.columnDelimiter||","});f.fetch({onComplete:function(l,h){var r,p,q=0,s=a.layerDefinition,t={layerDefinition:s,featureSet:{features:[],geometryType:"esriGeometryPoint"}},u=null,v=null;b&&(u=b.lowerBound||0,v=b.upperBound||l.length);if(u||v)l=l.slice(u,v);dojo.forEach(l,function(b,c){0===
c&&a.locationInfo&&(r=a.locationInfo.latitudeFieldName,p=a.locationInfo.longitudeFieldName);f.getIdentity(b);var d=f.getAttributes(b),g={};dojo.forEach(d,function(a){var c=Number(f.getValue(b,a));isNaN(c)?g[a]=f.getValue(b,a):g[a]=c});g.__OBJECTID=q;q++;var d=parseFloat(g[r]),n=parseFloat(g[p]);isNaN(d)||isNaN(n)||(d={geometry:(new esri.geometry.Point(n,d)).toJson(),attributes:g},t.featureSet.features.push(d))});u=new esri.layers.FeatureLayer(t);v=null;s&&s.drawingInfo&&s.drawingInfo.renderer&&s.drawingInfo.renderer.symbol&&
"esriPMS"===s.drawingInfo.renderer.symbol.type&&(v=s.drawingInfo.renderer.symbol);null!=v&&(u.renderer.symbol.imageData=v.imageData,u.renderer.symbol.url=v.url);a.title&&(u.name=a.title);u.layerId=a.id||c.framework.utils.alphaNumericToken();d.resolve(u)}});return d};b.decomposeFeatureLayerUrl=function(a){a=/(.+?)\/([0-9]*)(\?.*)?$/g.exec(a);return{serviceUrl:a[1],layerId:parseInt(a[2]),queryString:a[3]}};return b}();f.LayerUtilities=d})(h.utilities||(h.utilities={}))})(c.essentials||(c.essentials=
{}))})(geocortex||(geocortex={}));(function(c){(function(c){var f=function(){return function(){this.error=null;this.results=[];this.queryParams=null}}();c.SearchResults=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));(function(c){(function(c){(function(c){var d=function(){return function(){this.type=this.entries=this.displayName=this.id=null;this.entries=[]}}();c.CatalogEntry=d})(c.catalog||(c.catalog={}))})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(c){(function(c){var d=function(){return function(){this.ids=null;this.ids=[]}}();c.LayerCatalogDetailsParams=d})(c.catalog||(c.catalog={}))})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));(function(c){(function(c){(function(c){var d=function(){return function(){}}();c.LayerCatalogParams=d})(c.catalog||(c.catalog={}))})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(c){(function(c){var d=function(){return function(){this.entries=this.mapServiceId=null;this.entries=[]}}();c.LayerCatalogDetail=d})(c.catalog||(c.catalog={}))})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));(function(c){(function(c){var f=function(){function c(){}c.DEFAULT="Default";c.SHOW="Show";c.HIDE="Hide";return c}();c.RefreshVisibility=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(c){(function(c){var d=function(){function b(){}b.adjustTextSymbol=function(a,b){if(a&&a.symbol instanceof esri.symbol.TextSymbol){var c=function(a,b){b.font.size=void 0!=a.font.size&&"number"===typeof a.font.size?Math.round(a.font.size)+"px":a.font.size;b.x=a.x;b.y=a.y;b.xoffset=a.xoffset;b.yoffset=a.yoffset;b.align=a.align;b.angle=a.angle;b.color.hasOwnProperty("a")&&(b.color.a=0<=a.color.a&&1>=a.color.a?255*a.color.a:a.color.a)},d=new esri.symbol.TextSymbol(a.symbol.toJson());
d.color=new esri.Color({r:a.symbol.color.r,g:a.symbol.color.g,b:a.symbol.color.b,a:a.symbol.color.a});c(a.symbol,d);if(d.toJson&&"function"===typeof d.toJson){var f=d.toJson;d.toJson=function(){var a=f.call(d);c(d,a);return a}}var h=null,r=null;if(b){var p=document.getElementById(b+"_layer"),q=null,q=document.createElementNS("http://www.w3.org/2000/svg","text");q.setAttributeNS(null,"font-size",d.font.size);q.setAttributeNS(null,"font-family",d.font.family);q.setAttributeNS(null,"visibility","hidden");
q.textContent=d.text;p.appendChild(q);var s=q.getBBox(),r=null===r?s.height:r,h=null===h?q.getComputedTextLength():h}else{p=document.body;q=document.createElement("div");h={fontFamily:d.font.family,fontSize:d.font.size,fontWeight:d.font.weight,padding:"0",position:"absolute",lineHeight:"1",visibility:"hidden"};for(s in h)q.style[s]=h[s];q.appendChild(document.createTextNode(d.text));p.appendChild(q);h=q.clientWidth;r=q.clientHeight}p.removeChild(q);d.xoffset=0===d.angle?d.xoffset:0;d.yoffset=0===
d.angle?d.yoffset:0;if((a.measurementId||a.coordinateId)&&a.attributes&&a.attributes.numberOfLines)d.xoffset=a.measurementId?-(h/2+r/4):-(h/4+r/2),d.yoffset=a.attributes.numberOfLines&&1==a.attributes.numberOfLines?r/2:d.yoffset,"start"==d.verticalAlignment&&a.attributes.numberOfLines&&1<a.attributes.numberOfLines&&(d.yoffset=d.yoffset-0.5*r/2+r*a.attributes.numberOfLines/2);else{switch(d.verticalAlignment){case "top":break;case "middle":d.yoffset+=r/2;break;default:d.yoffset+=0.75*r}a.attributes&&
a.attributes.customVerticalAlignment&&"middle"===a.attributes.customVerticalAlignment&&(d.xoffset=0,d.yoffset=0,d.yoffset+=Math.ceil(r/2));if(p=d.horizontalAlignment||d.align||null)switch(p){case esri.symbol.TextSymbol.ALIGN_MIDDLE:case "center":case "justify":d.xoffset-=Math.ceil(h/2);a.coordinateId||(d.xoffset-=Math.ceil(r/4));break;case esri.symbol.TextSymbol.ALIGN_END:case "right":d.xoffset-=h}}return d}return null};b.adjustPictureMarkerSymbol=function(a){if(a&&a.symbol instanceof esri.symbol.PictureMarkerSymbol){var b=
new esri.symbol.PictureMarkerSymbol(a.symbol.toJson());if(b.toJson&&"function"===typeof b.toJson){var c=b.toJson;b.toJson=function(){var a=c.call(b),d,f;a.color=[0,0,0,255];isNaN(d=parseInt(b.width,10))||isNaN(f=parseInt(b.height,10))||(a.width=d,a.height=f,a.xoffset=isNaN(parseInt(a.xoffset))?d/2:a.xoffset+d/2,a.yoffset=isNaN(parseInt(a.yoffset))?f/2:a.yoffset-f/2);return a}}return b}return null};b.getImageAsBase64=function(a,b){void 0===b&&(b="image/png");var c=new dojo.Deferred,d=document.createElement("canvas"),
f=d.getContext("2d"),h=new Image;h.onload=function(){d.height=h.height;d.width=h.width;f.drawImage(h,0,0);try{var r=d.toDataURL(b);c.resolve({url:a,data:r.replace(/^data:image\/(png|jpg);base64,/,"")})}catch(p){c.reject({url:a,error:p})}};h.onerror=function(b){c.reject({url:a,error:Error("Failed to download image.")})};h.src=a;return c};return b}();c.PrintUtilities=d})(c.utilities||(c.utilities={}))})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(c){var f=function(){function c(){}c.prototype.toJson=function(){return JSON.stringify(this)};return c}();c.EssentialsFeatureSet=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(h){var f=function(){function d(b,a){this.layer=null;c.charting&&dojo.isObject(c.charting.configuration.ChartDefinition)&&(b&&(this.id=b.id,this.displayName=b.displayName,this.defaultChart=b.defaultChart,this.chartFeatureType=b.chartFeatureType,this.chartDefinition=new c.charting.configuration.ChartDefinition(b.chartDefinition),this.chartDefinition.id=this.id,this.chartDefinition.displayName=this.displayName),a&&(this.layer=a,this._setFieldDisplayNames(this.chartDefinition,a)))}
d.prototype._setFieldDisplayNames=function(b,a){if(a&&b){for(var d={},f=0;f<a.fields.length;f++){var k=a.fields[f];k&&(d[k.name]=k.displayName)}b.category.field.sourceType==c.charting.ChartFieldSourceType.Field&&(b.category.field.displayName=d[b.category.field.name]||b.category.field.name);for(f=0;f<b.series.length;f++)(k=b.series[f])&&k.field.sourceType==c.charting.ChartFieldSourceType.Field&&(k.field.displayName=d[k.field.name]||k.field.name)}};return d}();h.LayerChart=f})(c.essentials||(c.essentials=
{}))})(geocortex||(geocortex={}));(function(c){(function(c){var f=function(){return function(c,b,a,g){this.label=new Observable(c);this.value=new Observable(b);this.isDefault=new Observable(g||!1);this.causesValidation=new Observable(a)}}();c.FormButton=f})(c.forms||(c.forms={}))})(geocortex||(geocortex={}));
(function(c){(function(h){(function(f){(function(d){var b=function(){function a(a){this.message=c.forms.getElementText(a,"Message")}a.prototype.validate=function(a){throw Error("Abstract method");};return a}();d.ValidationItem=b})(f.validation||(f.validation={}))})(h.items||(h.items={}))})(c.forms||(c.forms={}))})(geocortex||(geocortex={}));
(function(c){(function(h){(function(f){var d=function(b){function a(a,d){var f=this;b.call(this,a,d);this.formItemType="CheckBoxFormItem";a?(this.text=new Observable(c.forms.getElementText(a,"Text")),this.checked=new Observable(c.forms._parseBoolean(c.forms.getElementText(a,"Checked"))),this.textLocation=new Observable(c.forms.getElementText(a,"TextLocation"))):(this.text=new Observable(""),this.checked=new Observable(!1),this.textLocation=new Observable("Right"));this.checked.bind(null,function(a){return f._notifyResultChanged()})}
__extends(a,b);a.prototype.getResult=function(){return new c.forms.items.FormItemResult(this.argumentName.get(),this.checked.get())};a.prototype._render=function(){return c.forms.renderFormItem(this)};return a}(f.AbstractFormItem);f.CheckBoxFormItem=d})(h.items||(h.items={}))})(c.forms||(c.forms={}))})(geocortex||(geocortex={}));
(function(c){(function(c){var f=function(){return function(c,b,a,g,f,k){this.instanceId=c;this.status=b;this.pendingExternalActivities=a;this.outputs=g;this.workflowData=f;this.instanceData=k}}();c.WorkflowState=f})(c.workflow||(c.workflow={}))})(geocortex||(geocortex={}));
(function(c){(function(h){var f=function(){function d(b,a,c,d){this.activityComplete=null;this._dispatcher=b;this._pendingIndex=a;this._workflow=c;this._workflowState=d}d.prototype.dispatcher=function(){return this._dispatcher};d.prototype.workflow=function(){return this._workflow};d.prototype.getDisplayName=function(){return this._workflowState?this._workflowState.pendingExternalActivities[this._pendingIndex].displayName:""};d.prototype.getInputNames=function(){var b=[];if(this._workflowState)for(var a=
this._workflowState.pendingExternalActivities[this._pendingIndex].inputs,c=0;c<a.length;c++)b.push(a[c].name);return b};d.prototype.getInputNamesByType=function(b){var a=[];if(this._workflowState)for(var c=this._workflowState.pendingExternalActivities[this._pendingIndex].inputs,d=0;d<c.length;d++)0===c[d].typeName.indexOf(b)&&a.push(c[d].name);return a};d.prototype.getOutputNames=function(){var b=[];if(this._workflowState)for(var a=this._workflowState.pendingExternalActivities[this._pendingIndex].outputs,
c=0;c<a.length;c++)b.push(a[c].name);return b};d.prototype.getOutputNamesByType=function(b){var a=[];if(this._workflowState)for(var c=this._workflowState.pendingExternalActivities[this._pendingIndex].outputs,d=0;d<c.length;d++)0===c[d].typeName.indexOf(b)&&a.push(c[d].name);return a};d.prototype.getSite=function(){return null!=this._workflow?this._workflow.site:null};d.prototype.getEsriMap=function(){return null!=this._workflow&&null!=this._workflow.site?this._workflow.site.getMap():null};d.prototype.getValue=
function(b){if(this._workflowState)for(var a=this._workflowState.pendingExternalActivities[this._pendingIndex].inputs,c=0;c<a.length;c++)if(a[c].name==b)return a[c].value;return null};d.prototype.getOutputValue=function(b){if(this._workflowState)for(var a=this._workflowState.pendingExternalActivities[this._pendingIndex].outputs,c=0;c<a.length;c++)if(a[c].name==b)return a[c].value;return null};d.prototype.getJsonValue=function(b){for(var a=this._workflowState.pendingExternalActivities[this._pendingIndex].inputs,
c=0;c<a.length;c++)if(a[c].name==b)return JSON.stringify(a[c].value);return null};d.prototype.getOutputJsonValue=function(b){if(this._workflowState)for(var a=this._workflowState.pendingExternalActivities[this._pendingIndex].outputs,c=0;c<a.length;c++)if(a[c].name==b)return(b=a[c].value)&&1===b.length&&(b=b[0]),JSON.stringify(b);return null};d.prototype.setValue=function(b,a,d){if(this._workflowState){var f=!1,k=this._workflowState.pendingExternalActivities[this._pendingIndex].outputs,l=this._getRuntimeType(a);
a&&a instanceof c.workflow.ArgumentValueWrapper&&(l=a.runtimeTypeName,a=a.value);for(var h=0;h<k.length;h++)if(k[h].name==b){f=!0;if(k=k[h])k.value=a,null!=l&&(k.runtimeTypeName=l);break}!f&&d&&(l||(l="System.Object"),k=new c.workflow.ArgumentInfo,k.isRequired=!1,k.name=b,k.value=a,k.typeName=l,k.runtimeTypeName=l,this._workflowState.pendingExternalActivities[this._pendingIndex].outputs.push(k))}};d.prototype.getActivityTypeName=function(){var b="";if(this._workflowState&&(b=this._workflowState.pendingExternalActivities[this._pendingIndex].typeName)){var a=
b.indexOf("`");0<=a&&(b=b.substring(0,a))}return b};d.prototype.getActivityExternalId=function(){return this._workflowState?this._workflowState.pendingExternalActivities[this._pendingIndex].externalId:""};d.prototype.getInputArgumentTypeName=function(b){if(this._workflowState)for(var a=this._workflowState.pendingExternalActivities[this._pendingIndex].inputs,c=0;c<a.length;c++)if(a[c].name==b)return a[c].typeName;return""};d.prototype.getInputArgumentRuntimeTypeName=function(b){for(var a=this._workflowState.pendingExternalActivities[this._pendingIndex].inputs,
c=0;c<a.length;c++)if(a[c].name==b)return a[c].runtimeTypeName;return""};d.prototype.completeActivity=function(){if(this._workflowState){var b=this._workflowState.pendingExternalActivities[this._pendingIndex];if(!b.isComplete){var a=this;"debugger"==this.getActivityExternalId()||b&&b.debug?c.workflow.DefaultActivityHandlers.showDebug(this,!1,function(){a._completeActivityInternal()}):this._completeActivityInternal()}}};d.prototype.abortActivity=function(){if(this._workflowState){var b=this._workflowState.pendingExternalActivities[this._pendingIndex];
b.isAborted=!0;this._workflowState.status="Aborted: "+b.displayName}null!=this._dispatcher&&this._dispatcher.activityAbort(this)};d.prototype._completeActivityInternal=function(){if(this._workflowState){var b=this._workflowState.pendingExternalActivities[this._pendingIndex];b.isComplete=!0;null!=this._dispatcher&&this._dispatcher.activityComplete(this);b.inputs=null;var b=this._workflowState.pendingExternalActivities[this._pendingIndex].syncToken,a=!0;if(""!=b)for(var d=this._workflowState.pendingExternalActivities,
f=0;f<d.length;f++)if(d[f].syncToken==b&&!d[f].isComplete){a=!1;break}a&&(c.workflow.WorkflowControllerProxy._executeWorkflow(this._workflow,this._dispatcher,this._workflowState,null,this),dojo.isFunction(this.activityComplete)&&this.activityComplete(this))}};d.prototype._getRuntimeType=function(b){var a="System.Object";b&&("function"==typeof b.isInstanceOf?b.isInstanceOf(esri.geometry.Extent)?a="ESRI.ArcGIS.Client.Geometry.Envelope":b.isInstanceOf(esri.geometry.Extent)?a="ESRI.ArcGIS.Client.Geometry.Envelope":
b.isInstanceOf(esri.geometry.Point)?a="ESRI.ArcGIS.Client.Geometry.MapPoint":b.isInstanceOf(esri.geometry.Multipoint)?a="ESRI.ArcGIS.Client.Geometry.MultiPoint":b.isInstanceOf(esri.geometry.Polygon)?a="ESRI.ArcGIS.Client.Geometry.Polygon":b.isInstanceOf(esri.geometry.Polyline)?a="ESRI.ArcGIS.Client.Geometry.Polyline":b.isInstanceOf(esri.geometry.Geometry)?a="ESRI.ArcGIS.Client.Geometry.Geometry":b.isInstanceOf(esri.layers.LayerDataSource)?a="ESRI.ArcGIS.Client.LayerDataSource":b.isInstanceOf(esri.layers.LayerMapSource)&&
(a="ESRI.ArcGIS.Client.LayerMapSource"):"string"==typeof b?a="System.String":"number"==typeof b?a="System.Double":"boolean"==typeof b?a="System.Boolean":"object"==typeof b&&(a="function"==typeof b.getMonth?"System.DateTime":"System.Object"));return a};return d}();h.ActivityContext=f})(c.workflow||(c.workflow={}))})(geocortex||(geocortex={}));
(function(c){(function(h){(function(f){f.startWorkflow=function(c,b,a){f._executeWorkflow(c,b,null,a,null)};f._executeWorkflow=function(d,b,a,g,f){var k={};if(null==d){a=Error("workflow cannot be null");if(null!=b){b.handleError(a,null);return}throw a;}var l=d.url+"/run";g&&(c.workflow.WorkflowControllerProxy._preProcessArguments(g),k.inargs=JSON.stringify(g));if(null!=a){g=a.pendingExternalActivities;for(var h=0;h<g.length;h++)c.workflow.WorkflowControllerProxy._preProcessArguments(g[h].outputs);
k.workflow=JSON.stringify(a)}k=c.encodeJson(dojo.mixin({f:"json"},k));null!=b&&(b.isBusy=!0);b.webRequestBegin(l,d);c.request({url:l,content:k,load:dojo.hitch(this,function(a){b.webRequestComplete(l,d);c.workflow.WorkflowControllerProxy._processWorkflowResults(a,d,b)}),error:dojo.hitch(this,function(a){if(null!=b)b.isBusy=!1,b.handleError(a,f);else throw a;}),callbackParamName:"CallBack"},{usePost:!0})};f._processWorkflowResults=function(d,b,a){null!=a&&(a.isBusy=!1);if(d)if(d.error)c.workflow.WorkflowControllerProxy._handleErrorInternal(a,
Error("Error running workflow: "+d.error.message));else if(d=new c.workflow.WorkflowState(d.instanceId,d.status,c.workflow.WorkflowControllerProxy._getExternalActivities(d.pendingExternalActivities),c.workflow.WorkflowControllerProxy._getArguments(d.outputs),d.workflowData,d.instanceData),"Completed"==d.status)null!=a&&a.workflowComplete(d.outputs,b);else if("WaitingForExternalActivities"==d.status){var g=d.pendingExternalActivities;if(null!=g)for(var f=0;f<g.length;f++){var k=new c.workflow.ActivityContext(a,
f,b,d);null!=a&&a.activityBegin(k);var l=g[f];c.workflow.WorkflowControllerProxy._preProcessArguments(l.inputs);try{"debugger"===k.getActivityExternalId()||l&&l.debug?c.workflow.DefaultActivityHandlers.showDebug(k,!0,function(){c.workflow.WorkflowControllerProxy._dispatch(k)}):c.workflow.WorkflowControllerProxy._dispatch(k)}catch(h){c.workflow.WorkflowControllerProxy._handleErrorInternal(a,h,k)}}}};f._handleErrorInternal=function(c,b,a){if(null!=c)c.handleError(b,a||null);else throw b;};f._preProcessArguments=
function(d){if(null!=d)for(var b=0;b<d.length;b++){var a=function(a){var b=a,c=a.indexOf(",");0<c&&(b=a.substring(0,c));return b},g=a(d[b].runtimeTypeName);d[b].value=c.workflow.WorkflowControllerProxy._getObjectFromJsonWithType(d[b].value,g);null==d[b].value&&(a=a(d[b].typeName),d[b].value=c.workflow.WorkflowControllerProxy._getObjectFromJsonWithType(d[b].value,a))}};f._getObjectFromJsonWithType=function(c,b){var a=c;switch(b){case "ESRI.ArcGIS.Client.Tasks.FeatureSet":null!=c&&(a=new esri.tasks.FeatureSet(c),
a.features=a.features||[]);break;case "ESRI.ArcGIS.Client.Geometry.Geometry":case "ESRI.ArcGIS.Client.Geometry.Envelope":case "ESRI.ArcGIS.Client.Geometry.MapPoint":case "ESRI.ArcGIS.Client.Geometry.MultiPoint":case "ESRI.ArcGIS.Client.Geometry.Polygon":case "ESRI.ArcGIS.Client.Geometry.Polyline":null!=c&&(a=esri.geometry.fromJson(c))&&a.spatialReference&&!c.spatialReference&&(a.spatialReference=null);break;case "ESRI.ArcGIS.Client.Geometry.SpatialReference":null!=c&&(a=new esri.SpatialReference(c));
break;case "ESRI.ArcGIS.Client.LayerMapSource":var g=c;g&&(a=new esri.layers.LayerMapSource(g));break;case "ESRI.ArcGIS.Client.LayerDataSource":(g=c)&&(a=new esri.layers.LayerDataSource(g));break;case "ESRI.ArcGIS.Client.TimeExtent":c instanceof Array&&0<c.length&&(a=new Date(c[0]),a=new esri.TimeExtent(a,1<c.length?new Date(c[1]):a));break;case "System.DateTime":c instanceof Date&&(a="/Date("+c.getTime()+")/")}return a};f._getExternalActivities=function(d){var b=[];if(null!=d)for(var a=0;a<d.length;a++){var g=
d[a],f=new c.workflow.ExternalActivityInfo;f._configureObject(g);b[a]=f}return b};f._getArguments=function(d){arguments=[];if(null!=d)for(var b=0;b<d.length;b++){var a=d[b],g=new c.workflow.ArgumentInfo;g._configureObject(a);arguments[b]=g}return arguments};f._dispatch=function(c){if(null!=c.dispatcher())c.dispatcher().dispatch(c);else throw Error("Unhandled activity: "+c.getActivityTypeName());}})(h.WorkflowControllerProxy||(h.WorkflowControllerProxy={}))})(c.workflow||(c.workflow={}))})(geocortex||
(geocortex={}));(function(c){(function(h){var f=function(){function d(b,a,c){this.display=b;this.value=a;this.typeName=c}d.prototype.getValue=function(){var b=this.value;null!=this.typeName&&(b=c.workflow.WorkflowControllerProxy._getObjectFromJsonWithType(b,this.typeName));null!=this.value&&"undefined"!=typeof this.value.__type&&delete b.__type;return b};return d}();h.DataItem=f})(c.forms||(c.forms={}))})(geocortex||(geocortex={}));
(function(c){(function(h){(function(f){f.initDataItemsFormItem=function(d,b,a){d.dataItems=new ObservableCollection;if(b&&(b=c.forms.getElement(b,"DataItems"),null!=b))for(var g=0;g<b.childNodes.length;g++){var f=b.childNodes[g],f=new c.forms.DataItem(c.forms.getElementText(f,"Display"),c.forms.getElementText(f,"Value"),c.forms.getElementText(f,"TypeName"));null!=f&&d.dataItems.addItem(f)}a&&(a=a.inputData)&&a.hasOwnProperty(d.itemID.get())&&(a=a[d.itemID.get()],d.dataItems.addItems(a))}})(h.items||
(h.items={}))})(c.forms||(c.forms={}))})(geocortex||(geocortex={}));
(function(c){(function(h){(function(f){var d=function(){function b(a,b,d){this.cascadingEvent=new c.framework.events.Event("cascadingEvent");this.isBusy=new Observable(!1);this._queryId=0;a.queryTaskRunner||(a.queryTaskRunner=this);if(a.queryTaskRunner!==this)throw Error("FormItem in the constructor must be the QueryTaskFormItem containing the QueryTaskRunner");this.formItem=a;b?(this.queryDisplayOutputField=new Observable(c.forms.getElementText(b,"QueryDisplayOutputField")),this.queryValueOutputField=
new Observable(c.forms.getElementText(b,"QueryValueOutputField")),this.queryServiceUrl=new Observable(c.forms.getElementText(b,"QueryServiceUrl")),this.queryWhereClause=new Observable(c.forms.getElementText(b,"QueryWhereClause")),this.filterByInputGeometry=new Observable(c.forms._parseBoolean(c.forms.getElementText(b,"FilterByInputGeometry"))),this.queryCascadingID=new Observable(c.forms.getElementText(b,"QueryCascadingID")),this.proxyUrl=new Observable(c.forms.getElementText(b,"ProxyUrl")),this.token=
new Observable(c.forms.getElementText(b,"Token")),c.forms.getElementText(b,"LayerSourceJson")&&(this.layerSourceJson=new Observable(c.forms.getElementText(b,"LayerSourceJson")))):(this.queryDisplayOutputField=new Observable(null),this.queryValueOutputField=new Observable(null),this.queryServiceUrl=new Observable(null),this.queryWhereClause=new Observable(null),this.filterByInputGeometry=new Observable(!1),this.queryCascadingID=new Observable(null),this.proxyUrl=new Observable(null),this.token=new Observable(null));
a.formDefinition&&a.formDefinition.map(a);b=this.queryCascadingID.get();null!=b&&""!=b&&a.formDefinition.addCascading(b,a,function(a){a?this.queryTaskRunner.performQuery(a):(this.clearDataItems(),this.triggerCascading(null))});a.isBusy||(a.isBusy=new Observable(!1));a.isBusy.sync(this.isBusy)}b.prototype.triggerCascading=function(a){this.cascadingEvent.publish(a)};b.prototype.isQueryable=function(){return null==this.queryServiceUrl.get()||""===dojo.trim(this.queryServiceUrl.get())||null==this.queryWhereClause.get()||
""===dojo.trim(this.queryWhereClause.get())||null==this.queryDisplayOutputField.get()||""===dojo.trim(this.queryDisplayOutputField.get())?!1:!0};b.prototype.performQuery=function(a,b){var d=this;if(this.isQueryable()&&(this.formItem.dataItems.clear(),null!=a)){var f=null;this.filterByInputGeometry.get()&&null!=this.formItem.formDefinition&&this.formItem.formDefinition.inputGeometry&&(f=this.formItem.formDefinition.inputGeometry);var l=this.queryServiceUrl.get();this.proxyUrl.get()&&void 0===esri.getProxyRule(l)&&
esri.addProxyRule({proxyUrl:this.proxyUrl.get(),urlPrefix:l});this.token&&this.token.get()&&(l+=(0<=dojo.indexOf(l,"?")?"&":"?")+"token="+this.token.get());var h;if(this.layerSourceJson&&this.layerSourceJson.get()){var r=c.essentials.RestHelper.getJsonObjectFromJsonString(this.layerSourceJson.get()),r={source:c.essentials.RestHelper.getLayerSourceFromJsonObject(r)};h=new esri.tasks.QueryTask(l,r)}else h=new esri.tasks.QueryTask(l);var p=new esri.tasks.Query;p.returnGeometry=!1;p.geometry=f;p.outFields=
[];p.where=this._getWhereClause(a);p.outFields.push(this.queryDisplayOutputField.get());null!=this.queryValueOutputField.get()&&""!=dojo.trim(this.queryValueOutputField.get())&&this.queryValueOutputField.get()!=this.queryDisplayOutputField.get()&&p.outFields.push(this.queryValueOutputField.get());p.outFields.every(function(a){return-1!==a.indexOf(".")})||(p.returnDistinctValues=!0);this.isBusy.set(!0);++this._queryId;(function(){var a=d._queryId;h.execute(p,function(f){var k=[];if(a==d._queryId){for(var l=
0;l<f.features.length;++l){var h=f.features[l].attributes,m=null;null!=d.queryDisplayOutputField.get()&&(m=h[d.queryDisplayOutputField.get().trim()]);h=null!=d.queryValueOutputField.get()&&""!=dojo.trim(d.queryValueOutputField.get())&&d.queryValueOutputField.get()!=d.queryDisplayOutputField.get()?h[d.queryValueOutputField.get().trim()]:m;k.push(new c.forms.DataItem(m,h,null))}k.sort(function(a,b){return a.display<b.display?-1:1});if(d.formatCallback){var p=c.essentials.EsriFieldTypes.esriFieldTypeString;
f.fields&&(f=f.fields.filter(function(a){return a.name===d.queryDisplayOutputField.get()})[0])&&(p=f.type);k.forEach(function(a){a.display=d.formatCallback(a.display,p)})}d.formItem.prepareForResults&&d.formItem.prepareForResults();f={};l=[];for(m=0;m<k.length;++m){var h=k[m],r=h.display+"-"+h.value;f.hasOwnProperty(r)||(f[r]=!0,l.push(h))}d.formItem.dataItems.addItems(l);d.isBusy.set(!1);k=null;0<d.formItem.dataItems.getLength()&&(k=d.formItem.dataItems.getAt(0));!0===b&&d.triggerCascading(null==
k?null:k.value);d.formItem.handleResultsComplete&&d.formItem.handleResultsComplete()}})})()}};b.prototype._getWhereClause=function(a){var b=this,c=this.queryWhereClause.get(),c=c.replace(/{1:([a-zA-Z0-9]+)(:[a-zA-Z0-9]+)?}/g,function(a,c,d){a=b.formItem.formDefinition.getFormItemById(c);if(!a)return"{unknown form item "+c+"}";c=a.getResult().value;return d?":SQL"===d?b._escapeForWhere(c):(a=/:[fF](\d+)/.exec(d))?parseFloat(c).toFixed(+a[1]):"{unknown format clause "+d+"}":c});return c=c.format(this._escapeForWhere(a))};
b.prototype._escapeForWhere=function(a){a&&"number"===typeof a&&(a=a.toString());return(a||"").replace(/\'/g,"''")};return b}();f.QueryTaskRunner=d})(h.items||(h.items={}))})(c.forms||(c.forms={}))})(geocortex||(geocortex={}));
(function(c){(function(h){(function(f){var d=function(b){function a(a,d){var k=this;b.call(this,a,d);this._defaultSet=!1;this.selectText=new Observable;this.selected=new Observable;this.defaultSelectedValue=new Observable;this.isBusy=new Observable(!1);this.formItemType="ComboBoxFormItem";f.initLabelContainer(this,a,d);f.initDataItemsFormItem(this,a,d);this.queryTaskRunner=new f.QueryTaskRunner(this,a,d);if(a){var l=c.forms.getElementText(a,"SelectText");l&&this.selectText.set(l);(l=c.forms.getElementText(a,
"SelectedValue"))&&this.defaultSelectedValue.set(l)}this.selected.bind(null,function(a){return k._notifyResultChanged()});this.prepareForResults();this.queryTaskRunner.isQueryable()||this._selectDefaultValue();l=this.queryTaskRunner.queryCascadingID.get();null!=l&&""!=l||this.queryTaskRunner.performQuery("")}__extends(a,b);a.prototype.clearDataItems=function(){this.dataItems.clear();this.selected.set(null);this._defaultSet=!1};a.prototype._hasRealDataItem=function(){return null!=this.selected.get()};
a.prototype.triggerCascading=function(a){null!=this.selected.get()&&a||this.queryTaskRunner.cascadingEvent.publish(null);var b=this.selected.get();null===b&&(b=a);null===b||void 0===b?this.queryTaskRunner.cascadingEvent.publish(null):this.queryTaskRunner.cascadingEvent.publish(b.value)};a.prototype.prepareForResults=function(){if(this.selectText.get()){var a=this.selectText.get(),a=new c.forms.DataItem(a,"",null);this.dataItems.insertItem(0,a)}};a.prototype.handleResultsComplete=function(){this._defaultSet||
(this._selectDefaultValue(),null!=this.selected.get()&&(this._defaultSet=!0,this.triggerCascading(this.selected.get())))};a.prototype.getResult=function(){if(null==this.selected.get())return new c.forms.items.FormItemResult(this.argumentName.get(),null);var a=this.selected.get();return a?new c.forms.items.FormItemResult(this.argumentName.get(),a.getValue()):new c.forms.items.FormItemResult(this.argumentName.get(),null)};a.prototype._addOption=function(a,b){this.dataItems.addItem(new c.forms.DataItem(a,
b))};a.prototype._selectDefaultValue=function(){var a=dojo.filter(this.dataItems.getItems(),dojo.hitch(this,function(a){return this.defaultSelectedValue.get()?a.value+""===this.defaultSelectedValue.get()+"":!1}));0<a.length?this.selected.set(a[0]):0<this.dataItems.length()&&this.selected.set(this.dataItems.getAt(0))};a.prototype._render=function(){return c.forms.renderFormItem(this)};return a}(f.AbstractFormItem);f.ComboBoxFormItem=d})(h.items||(h.items={}))})(c.forms||(c.forms={}))})(geocortex||
(geocortex={}));
(function(c){(function(h){(function(f){var d=function(b){function a(a,d){var k=this;b.call(this,a,d);this.initialTime=new Observable;this.nullable=new Observable(!1);this.timeFormat=new Observable;this.jQueryPickerTimeAsInfoMsg=new Observable(!1);this.formItemType="TimePickerFormItem";f.initLabelContainer(this,a,d);if(a){for(var l=!0,h=a.getElementsByTagNameNS?a.getElementsByTagNameNS("http://schemas.datacontract.org/2004/07/Geocortex.Forms.Client.Items.Validation","ValidationItem"):a.getElementsByTagName("ValidationItem"),
r=0;r<h.length;r++){var p=h[r].getAttributeNS("http://www.w3.org/2001/XMLSchema-instance","type");if(p&&0<=p.indexOf("RequiredValidationItem")){l=!1;break}}this.nullable.set(l);(l=c.forms.getElementText(a,"jQueryPickerTimeAsInfoMsg"))&&this.jQueryPickerTimeAsInfoMsg.set("true"===l);l=!0;h=c.forms.getElementText(a,"InitialTime");(l=null===c.forms.getElementText(a,"InitializeWithCurrentTime")?!h:"true"===c.forms.getElementText(a,"InitializeWithCurrentTime"))?this.initialTime.set(new Date):h?(c.framework.utils.DateUtils.containsTimezone(h)||
(h+=c.framework.utils.DateUtils.getTimezoneString()),this.initialTime.set(Date.fromISO(h)),this.timeFormat.set(c.forms.getElementText(a,"TimeFormat"))):this.initialTime.set(null)}else this.timeFormat.set("LongTime"),this.initialTime.set(new Date);this.time=new Observable(this.initialTime.get());this.time.bind(null,function(a){return k._notifyResultChanged()})}__extends(a,b);a.prototype.getResult=function(){var a=this.time.get();a&&(a=new Date(a.toString()),a="/Date({0})/".format(a.getTime()));return new c.forms.items.FormItemResult(this.argumentName.get(),
a)};a.prototype._render=function(){return c.forms.renderFormItem(this)};return a}(f.AbstractFormItem);f.TimePickerFormItem=d})(h.items||(h.items={}))})(c.forms||(c.forms={}))})(geocortex||(geocortex={}));
(function(c){(function(h){(function(f){var d=function(b){function a(a,d){var k=this;b.call(this,a,d);this.nullable=new Observable(!1);this.formItemType="DatePickerFormItem";f.initLabelContainer(this,a,d);var l=!0;if(a){for(var l=!0,h=a.getElementsByTagNameNS?a.getElementsByTagNameNS("http://schemas.datacontract.org/2004/07/Geocortex.Forms.Client.Items.Validation","ValidationItem"):a.getElementsByTagName("ValidationItem"),r=0;r<h.length;r++){var p=h[r].getAttributeNS("http://www.w3.org/2001/XMLSchema-instance",
"type");if(p&&0<=p.indexOf("RequiredValidationItem")){l=!1;break}}this.nullable.set(l);this.dateFormat=new Observable(c.forms.getElementText(a,"DateFormat"));this.includeTimePicker=new Observable("true"===c.forms.getElementText(a,"IncludeTimePicker"));h=null;this.includeTimePicker.get()&&(this.timePickerItem=new f.TimePickerFormItem(c.forms.getElement(a,"TimePickerItem")),h=this.timePickerItem.initialTime.get());r=c.forms.getElementText(a,"InitialDate");l=null===c.forms.getElementText(a,"InitializeWithCurrentDate")?
!r:"true"===c.forms.getElementText(a,"InitializeWithCurrentDate");r&&(c.framework.utils.DateUtils.containsTimezone(r)&&(p=Math.max(r.lastIndexOf("Z"),r.lastIndexOf("+"),r.lastIndexOf("-")),0<p&&(r=r.substring(0,p))),r+=c.framework.utils.DateUtils.getTimezoneString());p=null;if(l||r)p=new Date(r);p&&!isNaN(p.getTime())?(p.getTimezoneOffset()!=c.framework.utils.DateUtils.getTimezoneOffset()&&p.setTime(p.getTime()-6E4*(c.framework.utils.DateUtils.getTimezoneOffset()-p.getTimezoneOffset())),h&&(p.setHours(h.getHours()),
p.setMinutes(h.getMinutes()),p.setSeconds(h.getSeconds())),this.initialDate=new Observable(p)):this.initialDate=new Observable(h)}else this.dateFormat=new Observable,this.initialDate=new Observable(null),this.includeTimePicker=new Observable(!1);l?(l=new Date,this.includeTimePicker.get()||(l.setHours(0),l.setMinutes(0),l.setSeconds(0)),this.date=new Observable(l),this.initialDate.set(l)):this.date=new Observable(this.initialDate.get());this.date.bind(null,function(a){return k._notifyResultChanged()})}
__extends(a,b);a.prototype.getResult=function(){var a=this.date.get(),b=null===a?null:new Date(a.toString());if(b)if(isNaN(b.getTime()))b=this.initialDate.get();else{var d=0,f=this.attached_pickerType&&this.attached_pickerType.get?-1<this.attached_pickerType.get().toLowerCase().indexOf("native"):!0;a instanceof Date||this.includeTimePicker.get()||!f||(d=6E4*b.getTimezoneOffset());b="/Date({0})/".format(b.getTime()+d)}return new c.forms.items.FormItemResult(this.argumentName.get(),b)};a.prototype._render=
function(){return c.forms.renderFormItem(this)};return a}(f.AbstractFormItem);f.DatePickerFormItem=d})(h.items||(h.items={}))})(c.forms||(c.forms={}))})(geocortex||(geocortex={}));
(function(c){(function(h){(function(f){var d=function(b){function a(a,d){var k=this;b.call(this,a,d);this.files=new ObservableCollection;this.formItemType="FilePickerFormItem";this.isSupported=new Observable("undefined"!==typeof FileReader&&this._isFileInputSupported());a?(this.acceptFileTypes=new Observable(c.forms.getElementText(a,"AcceptFileTypes")),this.allowMultiple=new Observable(c.forms._parseBoolean(c.forms.getElementText(a,"AllowMultiple")))):(this.acceptFileTypes=new Observable(null),this.allowMultiple=
new Observable(!1));f.initLabelContainer(this,a,d);this.files.bind(null,function(a){return k._notifyResultChanged()})}__extends(a,b);a.prototype.clear=function(){this.files.clear();this.refresh()};a.prototype.getResult=function(){for(var a=[],b=0;b<this.files.getLength();++b){var d=this.files.getAt(b);d&&a.push(d)}a=new c.workflow.ArgumentValueWrapper("System.Collections.Generic.List`1[[Geocortex.Forms.Client.FileItem, Geocortex.EssentialsWpfApi]]",a);a=new f.FormItemResult(this.argumentName.get(),
a,!0);a.isList=!0;return a};a.prototype._render=function(){return c.forms.renderFormItem(this)};a.prototype._isFileInputSupported=function(){if(navigator.userAgent.match(/(Android (1.0|1.1|1.5|1.6|2.0|2.1))|(Windows Phone (OS 7|8.0))|(XBLWP)|(ZuneWP)|(w(eb)?OSBrowser)|(webOS)|(Kindle\/(1.0|2.0|2.5|3.0))/))return!1;var a=document.createElement("input");a.type="file";return!a.disabled};return a}(f.AbstractFormItem);f.FilePickerFormItem=d})(h.items||(h.items={}))})(c.forms||(c.forms={}))})(geocortex||
(geocortex={}));
(function(c){(function(h){(function(f){var d=function(b){function a(a,d){b.call(this,a,d);this.formItems=new ObservableCollection;this.formItemType="ContainerFormItem";if(a){this.orientation=new Observable(c.forms.getElementText(a,"Orientation"));this.description=new Observable(c.forms.getElementText(a,"Description"));this.maxWidth=new Observable(parseInt(c.forms.getElementText(a,"MaxWidth")));this.visibleControlID=new Observable(c.forms.getElementText(a,"VisibleControlID"));this.visibleControlValue=new Observable(c.forms.getElementText(a,
"VisibleControlValue"));var f=c.forms.getElement(a,"FormItems");if(null!=f)for(var l=0;l<f.childNodes.length;l++){var h=c.forms.items._processFormItem(f.childNodes[l],this.formDefinition);if(null!=h){this.formItems.addItem(h);var r=this;h.refresh=function(){var a=r.formItems.indexOf(this);0<=a&&(r.formItems.removeAt(a),r.formItems.insertItem(a,this))}}}}else this.orientation=new Observable("Vertical"),this.description=new Observable(""),this.maxWidth=new Observable(NaN),this.visibleControlID=new Observable(""),
this.visibleControlValue=new Observable("")}__extends(a,b);a.prototype.validate=function(){var a=[];if(this.isVisible.get()&&null!=this.formItems)for(var b=0;b<this.formItems.getLength();++b){var c=this.formItems.getAt(b);if(c.isVisible.get())for(var c=c.validate(),d=0;d<c.length;++d)a.push(c[d])}return a};a.prototype._getResults=function(){for(var b=[],c=0;c<this.formItems.getLength();++c){var d=this.formItems.getAt(c);if(d.isVisible.get())if(d instanceof a){if(d=d._getResults(),null!=d)for(var f=
0;f<d.length;++f)b.push(d[f])}else d=d.getResult(),null!=d&&b.push(d)}return b};a.prototype._destroy=function(){for(var a=this.formItems.length()-1;0<=a;a--)this.formItems.getAt(a)._destroy();this.formItems.clear()};a.prototype._render=function(){return c.forms.renderFormItem(this)};a.prototype.getFormItemById=function(a){for(var b=0,c=this.formItems.length();b<c;b++){var d=this.formItems.getAt(b);if(d.itemID.get()===a||d.getFormItemById&&(d=d.getFormItemById(a)))return d}return null};a.prototype.applyVisibility=
function(a){if(a){var b=!1,c=a.getResult();if(null!==c&&null!==c.value)if(a=this.visibleControlValue.get())if(c.isList){if(c=c.value)for(var d=0;d<c.length;d++)if(c[d].toString()===a){b=!0;break}}else b=!0===c.value||!1===c.value?c.value.toString().toUpperCase()===a.toUpperCase():c.value.toString()===a;else!0===c.value&&(b=!0);this.isVisible.set(b)}};a.prototype.getDisplayName=function(){return null};return a}(f.AbstractFormItem);f.ContainerFormItem=d})(h.items||(h.items={}))})(c.forms||(c.forms=
{}))})(geocortex||(geocortex={}));
(function(c){(function(h){(function(f){var d=function(b){function a(a,d){b.call(this,a,d);this.formItemType="GroupBoxFormItem";this.header=a?new Observable(c.forms.getElementText(a,"Header")):new Observable(null)}__extends(a,b);a.prototype._render=function(){return c.forms.renderFormItem(this)};a.prototype.getDisplayName=function(){return this.header.get()};return a}(f.ContainerFormItem);f.GroupBoxFormItem=d})(h.items||(h.items={}))})(c.forms||(c.forms={}))})(geocortex||(geocortex={}));
(function(c){(function(h){(function(f){var d=function(b){function a(a,d){var f=this;b.call(this,a,d);this.wasClicked=new Observable(!1);this.formItemType="HyperlinkFormItem";a?(this.hyperlinkText=new Observable(c.forms.getElementText(a,"HyperlinkText")),this.target=new Observable(c.forms.getElementText(a,"Target")),this.uri=new Observable(c.forms.getElementText(a,"Uri"))):(this.hyperlinkText=new Observable("Hyperlink"),this.target=new Observable("_blank"),this.uri=new Observable(""));this.wasClicked.bind(null,
function(a){return f._notifyResultChanged()})}__extends(a,b);a.prototype.getResult=function(){return new c.forms.items.FormItemResult(this.argumentName.get(),this.wasClicked.get(),this.wasClicked.get())};a.prototype._render=function(){return c.forms.renderFormItem(this)};return a}(f.AbstractFormItem);f.HyperlinkFormItem=d})(h.items||(h.items={}))})(c.forms||(c.forms={}))})(geocortex||(geocortex={}));
(function(c){(function(h){(function(f){var d=function(b){function a(a,d){b.call(this,a,d);this.formItemType="ImageFormItem";if(a){this.source=new Observable(c.forms.getElementText(a,"Source"));this.width=new Observable(c.forms.getElementText(a,"Width"));this.height=new Observable(c.forms.getElementText(a,"Height"));var f=this.width.get(),l=this.height.get();f&&l?parseInt(f)>parseInt(l)?this.height.set("auto"):this.width.set("auto"):(this.width=new Observable("auto"),this.height=new Observable("auto"))}else this.source=
new Observable(""),this.width=new Observable("auto"),this.height=new Observable("auto")}__extends(a,b);a.prototype._render=function(){return c.forms.renderFormItem(this)};return a}(f.AbstractFormItem);f.ImageFormItem=d})(h.items||(h.items={}))})(c.forms||(c.forms={}))})(geocortex||(geocortex={}));
(function(c){(function(h){(function(f){var d=function(b){function a(a,d){var k=this;b.call(this,a,d);this.selection=new ObservableCollection;this.selectedValues=new ObservableCollection;this._selectedValuesLookup=null;this.isBusy=new Observable(!1);this.formItemType="ListBoxFormItem";f.initLabelContainer(this,a,d);f.initDataItemsFormItem(this,a,d);this.size=new Observable(6);if(a){this.maxHeight=new Observable(parseInt(c.forms.getElementText(a,"MaxHeight")));this.selectionMode=new Observable(c.forms.getElementText(a,
"SelectionMode"));var l=c.forms.getElementText(a,"Size");l&&(l=parseInt(l),0<l&&this.size.set(l));if(l=c.forms.getElement(a,"SelectedValues")){this._selectedValuesLookup={};var h;for(h=0;h<l.childNodes.length;h++){var r=l.childNodes[h].textContent;this.selectedValues.addItem(r);this._selectedValuesLookup[r+""]=!0}this._setDefaults();0===this.selection.length()&&0!==this.dataItems.getItems().length&&this.selection.addItem(this.dataItems.getAt(0))}}else this.label=new c.forms.items.LabelFormItem(null,
this.formDefinition),this.maxHeight=new Observable(NaN),this.selectionMode=new Observable("Single");this.queryTaskRunner=new f.QueryTaskRunner(this,a,d);this.queryTaskRunner.queryCascadingID.get()||this.queryTaskRunner.performQuery("");this.selection.bind(null,function(a){setTimeout(function(){k._notifyResultChanged()},0)})}__extends(a,b);a.prototype.clearDataItems=function(){this.dataItems.clear()};a.prototype._setDefaults=function(){for(var a=0;a<this.dataItems.getItems().length;a++){var b=this.dataItems.getAt(a);
this._selectedValuesLookup[b.value.toString()]&&this.selection.addItem(b)}};a.prototype.handleResultsComplete=function(){this._setDefaults()};a.prototype.triggerCascading=function(a){null!=this.selection&&a||this.queryTaskRunner.cascadingEvent.publish(null);var b=null;null!=this.selection&&(b=this.selection.getAt(0));null==b&&null!=a&&(b=a);null==b?this.queryTaskRunner.cascadingEvent.publish(null):this.queryTaskRunner.cascadingEvent.publish(b.value)};a.prototype.getResult=function(){var a=null;if("single"==
this.selectionMode.get().toLowerCase())return 0<this.selection.getLength()&&(a=(a=this.selection.getAt(0))?a.getValue():null),new f.FormItemResult(this.argumentName.get(),a,!0);for(var b=[],c=0;c<this.selection.getLength();++c)(a=(a=this.selection.getAt(c))?a.getValue():null)&&b.push(a);a=new f.FormItemResult(this.argumentName.get(),b,!0);a.isList=!0;return a};a.prototype._render=function(){return c.forms.renderFormItem(this)};return a}(f.AbstractFormItem);f.ListBoxFormItem=d})(h.items||(h.items=
{}))})(c.forms||(c.forms={}))})(geocortex||(geocortex={}));
(function(c){(function(h){(function(f){var d=function(b){function a(d,f){var k=this;b.call(this,d,f);this.formItemType="RadioButtonFormItem";d?(this.text=new Observable(c.forms.getElementText(d,"Text")),this.checked=new Observable(c.forms._parseBoolean(c.forms.getElementText(d,"Checked"))),this.textLocation=new Observable(c.forms.getElementText(d,"TextLocation")),this.groupName=new Observable(c.forms.getElementText(d,"GroupName"))):(this.text=new Observable(null),this.checked=new Observable(!1),this.textLocation=
new Observable("Right"),this.groupName=new Observable(null));this.checked.bind(null,function(b){b&&a._findButtonsInGroup(k.groupName.get(),k.formDefinition.containerFormItem).forEach(function(a){a!==k&&a.checked.set(!1)});k._notifyResultChanged()})}__extends(a,b);a.prototype.getResult=function(){var a=this.__getRadioValueClosure,a=a?a():!1;return new c.forms.items.FormItemResult(this.argumentName.get(),a)};a.prototype._render=function(){return c.forms.renderFormItem(this)};a._findButtonsInGroup=function(b,
c){var d=[];c&&c.formItems.get().forEach(function(c){c instanceof a?c.groupName.get()===b&&d.push(c):c instanceof f.ContainerFormItem&&a._findButtonsInGroup(b,c).forEach(function(a){return d.push(a)})});return d};return a}(f.AbstractFormItem);f.RadioButtonFormItem=d})(h.items||(h.items={}))})(c.forms||(c.forms={}))})(geocortex||(geocortex={}));
(function(c){(function(h){(function(f){var d=function(b){function a(a,d){b.call(this,a,d);this.isBusy=new Observable(!1);this.formItemType="AutoCompleteBoxFormItem";a?(this.minimumPrefixLength=new Observable(parseInt(c.forms.getElementText(a,"MinimumPrefixLength"))),this.minimumPopulateDelay=new Observable(parseInt(c.forms.getElementText(a,"MinimumPopulateDelay")))):(this.minimumPrefixLength=new Observable(3),this.minimumPopulateDelay=new Observable(200));f.initDataItemsFormItem(this,a,d);this.queryTaskRunner=
new f.QueryTaskRunner(this,a,d)}__extends(a,b);a.prototype.clearDataItems=function(){this.dataItems.clear()};return a}(f.TextBoxFormItem);f.AutoCompleteBoxFormItem=d})(h.items||(h.items={}))})(c.forms||(c.forms={}))})(geocortex||(geocortex={}));
(function(c){(function(c){(function(c){(function(c){var b=function(){return function(a,b){this.isValid=a;this.errorMessage=b}}();c.ValidationResult=b})(c.validation||(c.validation={}))})(c.items||(c.items={}))})(c.forms||(c.forms={}))})(geocortex||(geocortex={}));(function(c){(function(c){var f=function(){return function(){this.fileDataBase64=this.fileName=null;this.fileSize=0;this.fileType=null}}();c.FileItem=f})(c.forms||(c.forms={}))})(geocortex||(geocortex={}));
(function(c){(function(h){(function(f){(function(d){var b=function(a){function b(d){a.call(this,d);this.totalFileSize=parseInt(c.forms.getElementText(d,"TotalFileSize"))}__extends(b,a);b.prototype.validate=function(a){if(a instanceof c.workflow.ArgumentValueWrapper&&a.value&&a.value instanceof Array){for(var b=0,d=0;d<a.value.length;++d){var g=a.value[d];g&&g instanceof c.forms.FileItem&&(b+=g.fileSize)}if(b>this.totalFileSize)return new c.forms.items.validation.ValidationResult(!1,this.message)}return new c.forms.items.validation.ValidationResult(!0,
null)};return b}(d.ValidationItem);d.FileSizeValidationItem=b})(f.validation||(f.validation={}))})(h.items||(h.items={}))})(c.forms||(c.forms={}))})(geocortex||(geocortex={}));
(function(c){(function(h){(function(f){(function(d){var b=function(a){function b(d){a.call(this,d);this.minimumValue=parseFloat(c.forms.getElementText(d,"MinimumValue"));this.maximumValue=parseFloat(c.forms.getElementText(d,"MaximumValue"))}__extends(b,a);b.prototype.validate=function(a){if(null===a||void 0===a||""===a)return new c.forms.items.validation.ValidationResult(!0,null);a=parseFloat(a);return null==a||isNaN(a)||a<this.minimumValue||a>this.maximumValue?new c.forms.items.validation.ValidationResult(!1,
this.message):new c.forms.items.validation.ValidationResult(!0,null)};return b}(d.ValidationItem);d.NumericRangeValidationItem=b})(f.validation||(f.validation={}))})(h.items||(h.items={}))})(c.forms||(c.forms={}))})(geocortex||(geocortex={}));
(function(c){(function(h){(function(f){(function(d){var b=function(a){function b(d){a.call(this,d);this.expression=c.forms.getElementText(d,"Expression");this.ignoreCase=c.forms._parseBoolean(c.forms.getElementText(d,"IgnoreCase"))}__extends(b,a);b.prototype.validate=function(a){if(null===a||void 0===a||""===a)return new c.forms.items.validation.ValidationResult(!0,null);var b="",d=this.expression;this.ignoreCase&&(b+="i");'^(?(")(".+?"@)|(([0-9a-zA-Z]((\\.(?!\\.))|[-!#\\$%&\'\\*\\+/=\\?\\^`\\{\\}\\|~\\w])*)(?<=[0-9a-zA-Z])@))(?(\\[)(\\[(\\d{1,3}\\.){3}\\d{1,3}\\])|(([0-9a-zA-Z][-\\w]*[0-9a-zA-Z]\\.)+[a-zA-Z]{2,6}))$'==
this.expression&&(d="^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,4}$");var g=null;try{g=RegExp(d,b)}catch(f){}return null==g||g.test(a)?new c.forms.items.validation.ValidationResult(!0,null):new c.forms.items.validation.ValidationResult(!1,this.message)};return b}(d.ValidationItem);d.RegexValidationItem=b})(f.validation||(f.validation={}))})(h.items||(h.items={}))})(c.forms||(c.forms={}))})(geocortex||(geocortex={}));
(function(c){(function(h){(function(f){(function(d){var b=function(a){function b(c){a.call(this,c)}__extends(b,a);b.prototype.validate=function(a){var b=!0,d=null;if(void 0===a||null===a||"string"===typeof a&&""===dojo.trim(a)||void 0!==a.length&&0>=a.length||a.value&&dojo.isArray(a.value)&&0===a.value.length)b=!1,d=this.message;return new c.forms.items.validation.ValidationResult(b,d)};return b}(d.ValidationItem);d.RequiredValidationItem=b})(f.validation||(f.validation={}))})(h.items||(h.items={}))})(c.forms||
(c.forms={}))})(geocortex||(geocortex={}));
(function(c){(function(c){function f(c,b){var a=c.getElementsByTagName(b);if(1<=a.length)for(var g=0;g<a.length;g++){if(a[g].parentNode===c)return a[g]}else if(0<c.childNodes.length&&(a=c.childNodes[0].prefix,""!=a&&(a=c.getElementsByTagName(a+":"+b),1<=a.length)))for(g=0;g<a.length;g++)if(a[g].parentNode===c)return a[g];return null}c.getElement=f;c.getElementText=function(c,b){var a=f(c,b);return a?dojox.xml.parser.textContent(a):null};c.getAttributeValue=function(c,b){if(null!=c)for(var a=0;a<c.attributes.length;a++)if(c.attributes[a].name==
b)return c.attributes[a].value;return null};c._parseBoolean=function(c){if(null!=c)switch(c.toLowerCase()){case "true":case "yes":case "1":return!0;case "false":case "no":case "0":case null:break;default:return Boolean(c)}return!1};c.renderFormItem=function(c){throw Error("This abstract function must be implemented by your UI system");}})(c.forms||(c.forms={}))})(geocortex||(geocortex={}));
(function(c){(function(h){(function(f){function d(b){var a="";if(null!=b&&null!=b.attributes)for(var c=0;c<b.attributes.length;c++)if(0<=String(b.attributes[c].nodeName).indexOf("type")){b=b.attributes[c].nodeValue;a=b.indexOf(":");0<=a&&a+1<b.length&&(b=b.substr(a+1));a=b;break}return a}f._processFormItem=function(b,a){var g=null;switch(d(b)){case "AutoCompleteBoxFormItem":g=new c.forms.items.AutoCompleteBoxFormItem(b,a);break;case "CheckBoxFormItem":g=new c.forms.items.CheckBoxFormItem(b,a);break;
case "ContainerFormItem":g=new c.forms.items.ContainerFormItem(b,a);break;case "ComboBoxFormItem":g=new c.forms.items.ComboBoxFormItem(b,a);break;case "DatePickerFormItem":g=new c.forms.items.DatePickerFormItem(b,a);break;case "FilePickerFormItem":g=new c.forms.items.FilePickerFormItem(b,a);break;case "GroupBoxFormItem":g=new c.forms.items.GroupBoxFormItem(b,a);break;case "HyperlinkFormItem":g=new c.forms.items.HyperlinkFormItem(b,a);break;case "ImageFormItem":g=new c.forms.items.ImageFormItem(b,
a);break;case "ListBoxFormItem":g=new c.forms.items.ListBoxFormItem(b,a);break;case "MarkdownFormItem":g=new c.forms.items.MarkdownFormItem(b,a);break;case "RadioButtonFormItem":g=new c.forms.items.RadioButtonFormItem(b,a);break;case "TextAreaFormItem":g=new c.forms.items.TextAreaFormItem(b,a);break;case "TextBoxFormItem":g=new c.forms.items.TextBoxFormItem(b,a);break;case "TimePickerFormItem":g=new c.forms.items.TimePickerFormItem(b,a)}g.dataItems&&null!=a&&null!=a.inputData&&a.inputData.hasOwnProperty(g.itemID)&&
g.dataItems.addItems(a.inputData.item(g.itemID));return g};f._processValidationItem=function(b){var a=null;switch(d(b)){case "NumericRangeValidationItem":a=new h.items.validation.NumericRangeValidationItem(b);break;case "RequiredValidationItem":a=new h.items.validation.RequiredValidationItem(b);break;case "RegexValidationItem":a=new h.items.validation.RegexValidationItem(b);break;case "FileSizeValidationItem":a=new h.items.validation.FileSizeValidationItem(b)}return a};f._getType=d})(h.items||(h.items=
{}))})(c.forms||(c.forms={}))})(geocortex||(geocortex={}));
(function(c){(function(h){var f=function(){function d(b,a,d){this._formManager=this.knownTypes=this.inputGeometry=this.containerFormItem=this.inputData=this.version=null;this._version=1.1;this._controlMap=this._cascadingMap=this._formContainer=null;this.knownTypes=[];this.inputData=a;this.version=this._version;this._controlMap={};this._cascadingMap={};a=null;b&&(a=dojox.xml.parser.parse(b));d&&(this.inputGeometry=d);if(null!=a){b=a.documentElement;d=c.forms.getElementText(b,"Version");if(parseFloat(d)>
this._version)throw Error("Form version "+d+" is incompatible with current API version "+this._version);this.title=new Observable(c.forms.getElementText(b,"Title"));this.maxWidth=new Observable(parseInt(c.forms.getElementText(b,"MaxWidth")));this.maxHeight=new Observable(parseInt(c.forms.getElementText(b,"MaxHeight")));a=c.forms.getElement(b,"KnownTypes");if(null!=a)for(d=0;d<a.childNodes.length;d++)this.knownTypes.push(a.childNodes[d].firstChild.data);this.containerFormItem=new c.forms.items.ContainerFormItem(c.forms.getElement(b,
"ContainerFormItem"),this)}else this.containerFormItem=new c.forms.items.ContainerFormItem(null,this),this.containerFormItem.itemID=new Observable("Group1"),this.title=new Observable(""),this.maxWidth=new Observable(NaN),this.maxHeight=new Observable(NaN);for(var f in this._cascadingMap)if(this._cascadingMap.hasOwnProperty(f))for(d=0;d<this._cascadingMap[f].length;++d)b=this._cascadingMap[f][d],this._controlMap[f].queryTaskRunner.cascadingEvent.subscribe(b.formItem,b.handler)}d.prototype.addCascading=
function(b,a,c){!1==this._cascadingMap.hasOwnProperty(b)&&(this._cascadingMap[b]=[]);this._cascadingMap[b].push({formItem:a,handler:c})};d.prototype.map=function(b){this._controlMap[b.itemID.get()]=b};d.prototype.render=function(b){};d.prototype.validate=function(){return this.containerFormItem.validate()};d.prototype.getResults=function(){return this.containerFormItem._getResults()};d.prototype.destroy=function(){this.containerFormItem._destroy()};d.prototype.getFormItemById=function(b){return this.containerFormItem.getFormItemById(b)};
return d}();h.FormDefinition=f})(c.forms||(c.forms={}))})(geocortex||(geocortex={}));
(function(c){(function(h){(function(f){f.getPropertyIgnoreCase=function(c,b){for(var a in c)if(c.hasOwnProperty(a)&&a.toLowerCase()===b.toLowerCase())return a;return null};f.handleReport=function(d){function b(a){var b=null;if(w&&a)for(var c=0;c<w.length;c++){var d=w[c];if(d.Key===a.displayName||"tf_"+d.Key===a.id||d.Key===a.id){b=d;break}}return b}var a=d.getValue("MapServiceId"),g=d.getValue("LayerId"),n=d.getValue("LayerName"),k=d.getValue("ReportId"),h=null,m=d.getSite();m&&a&&(g||n)&&k&&(a=f.findMapServiceById(m,
a))&&(m=null,g?m=a.findLayerById(g):n&&(m=a.findLayerByName(n)),null!=m&&(h=m.findReportById(k)));if(h){var g=new esri.tasks.Query,n=new c.essentials.ReportParameters,r=d.getValue("ShowOpenReport"),k=d.getValue("Geometry"),a=d.getValue("OutSpatialReference"),m=d.getValue("Text"),p=d.getValue("Where"),q=d.getValue("OutputFormat"),s=d.getValue("Resolution"),t=d.getValue("CustomExtent"),u=d.getValue("SpatialRelationship"),v=d.getValue("ReportExtentType"),x=d.getValue("NotificationEmailAddress"),w=d.getValue("TextFields");
v||(v=c.essentials.ReportParameters.CURRENT_EXTENT);n.extentType=v;q&&(n.outputFormat=q);if(h.textFields)for(var y in h.textFields)h.textFields.hasOwnProperty(y)&&(q=h.textFields[y],v=b(q),null!=v?n.fields.push(new c.essentials.TextField(q.id,q.displayName,v.Value,q.multiline)):n.fields.push(q));x&&(n.notificationEmailAddress=x);s&&(n.resolution=s);t&&(n.customExtent=t);g.spatialRelationship=c.essentials.RestHelper._convertSpatialRelationshipFromDotnetIndex(u);k&&(g.geometry=k);a&&(g.outSpatialReference=
a);m&&(g.text=m);p&&(g.where=p);h.run(g,n,function(a){a=a?a.href:null;r&&a&&0<a.length&&d.dispatcher().handleOpenReportUrl(a,d);d.setValue("ResultUrl",a);d.completeActivity()},function(a){d.dispatcher().handleError(Error("Error running report '"+a.message+"'"),d)})}else d.dispatcher().handleError(Error("Cannot find report '"+k+"'"),d)};f.showDebug=function(d,b,a){var g=new c.forms.FormDefinition;g.maxHeight.set(600);g.maxWidth.set(500);var f;b?(g.title.set("Debug - Input Arguments for "+d.getDisplayName()),
g.containerFormItem.description.set("Input Arguments:"),f=d.getInputNames()):(g.title.set("Debug - Output Arguments for "+d.getDisplayName()),g.containerFormItem.description.set("Output Arguments:"),f=d.getOutputNames());if(null!=f&&0<f.length)for(var k=0;k<f.length;k++){var h=f[k],m;(m=b?d.getValue(h):d.getOutputValue(h))&&"object"==typeof m&&(m=b?d.getJsonValue(h):d.getOutputJsonValue(h));var r;!m||100>String(m).length&&-1==String(m).indexOf("\n")?r=new c.forms.items.TextBoxFormItem(null,g):(r=
new c.forms.items.TextAreaFormItem(null,g),r.textboxHeight.set(100));r.label=new c.forms.items.LabelFormItem(null,g);r.text.set(m);r.textboxWidth.set(300);r.label.text.set(h);r.readOnly.set(!0);g.containerFormItem.formItems.addItem(r)}(d=d.dispatcher())&&"function"==typeof d._showDebugHandler?d._showDebugHandler(g,a):a&&a()};f.handleGetBrowserUrl=function(c){c.setValue("Url",window.location.href);c.completeActivity()};f.handleExternalDelay=function(c){var b=c.getValue("Milliseconds");if(null!=b)setTimeout(function(){c.completeActivity()},
b);else throw Error("External Delay: required Milliseconds argument was not supplied.");};f.handleGetExternalTimeInfo=function(c){c.setValue("UtcOffset",-6E4*(new Date).getTimezoneOffset());c.completeActivity()};f.handleWaitForGeoprocessorJobComplete=function(d){var b=d.getValue("GeoprocessorUrl");d.getValue("Token");d.getValue("ProxyURL");var a=d.getValue("UpdateDelay"),g=d.getValue("JobId"),f=!1;if(!b)throw Error("GeoprocessorUrl parameter is missing.");if(!g)throw Error("JobId parameter is missing.");
var k=new esri.tasks.Geoprocessor(b);0<a&&k.setUpdateDelay(a);dojo.connect(k,"onError",function(a){d.setValue("Result",c.workflow.DefaultActivityHandlers._getJobStatusCode(esri.tasks.JobInfo.STATUS_FAILED));d.completeActivity()});dojo.connect(k,"onStatusUpdate",function(b){f||(b=b.jobStatus,b==esri.tasks.JobInfo.STATUS_CANCELLED||b==esri.tasks.JobInfo.STATUS_DELETED||b==esri.tasks.JobInfo.STATUS_FAILED||b==esri.tasks.JobInfo.STATUS_SUCCEEDED||b==esri.tasks.JobInfo.STATUS_TIMED_OUT?(f=!0,d.setValue("Result",
c.workflow.DefaultActivityHandlers._getJobStatusCode(b)),d.completeActivity()):window.setTimeout(function(){k.checkJobStatus(g)},a))});k.checkJobStatus(g)};f._getJobStatusCode=function(c){switch(c){case "esriJobNew":return 0;case "esriJobSubmitted":return 1;case "esriJobWaiting":return 2;case "esriJobExecuting":return 3;case "esriJobSucceeded":return 4;case "esriJobFailed":return 5;case "esriJobTimedOut":return 6;case "esriJobCancelling":return 7;case "esriJobCancelled":return 8;case "esriJobDeleting":return 9;
case "esriJobDeleted":return 10;default:return-1}};f.handleGetLayerInfoByProperty=function(d){if(!d)throw Error("Get Map Service Info: required context was not supplied.");var b=d.getValue("PropertyName");if(null==b)throw Error("Provide a Property Name: No property name available.");var a=d.getSite();if(!a)throw Error("Set Layer Visibility: No site available.");for(var g=[],a=a.essentialsMap.mapServices,f={mapServiceUrl:"",mapServiceId:"",token:"",isVisible:!1,isDynamic:!1,propertyValue:null,id:"",
name:"",displayName:"",layerUrl:""},k=null,h=0;h<a.length;h++)for(var m=a[h].layers.concat(a[h].tables),r=0;r<m.length;r++)if(void 0!=m[r].properties[b]){f.mapServiceUrl=a[h].serviceUrl;f.mapServiceId=a[h].id;f.token=a[h].serviceToken;f.isVisible=m[r].isVisible();f.isDynamic=m[r].isDynamic;f.propertyValue=m[r].properties[b];f.id=m[r].id;f.name=m[r].name;f.displayName=m[r].displayName;f.layerUrl=a[h].mapServiceType===c.essentials.MapServiceType.FEATURE?f.mapServiceUrl:f.mapServiceUrl+"/"+(f.isDynamic?
"dynamicLayer":f.id);if(f.isDynamic){var p=a[0].serviceLayer;if(p&&p.dynamicLayerInfos)for(var q=0;q<p.dynamicLayerInfos.length;q++)if((k=p.dynamicLayerInfos[q])&&k.id.toString()===f.id){k.source&&(f.layerSourceJson=JSON.stringify(k.source.toJson()));break}}g.push(f);f={mapServiceUrl:"",mapServiceId:"",token:"",isVisible:!1,isDynamic:!1,propertyValue:null,id:"",name:"",displayName:"",layerUrl:""}}d.setValue("LayersInfo",g);d.completeActivity()}})(h.DefaultActivityHandlers||(h.DefaultActivityHandlers=
{}))})(c.workflow||(c.workflow={}))})(geocortex||(geocortex={}));
(function(c){(function(c){(function(c){c.handleAlert=function(c){c.getValue("Title");var b=c.getValue("Text");alert(b);c.completeActivity()};c.handleConfirm=function(c){var b=c.getValue("Text"),b=confirm(b);null==b&&(b=!1);c.setValue("Result",b);c.completeActivity()};c.handlePrompt=function(c){var b=c.getValue("Description"),a=c.getValue("DefaultText"),b=prompt(b,a);c.setValue("Result",b);c.completeActivity()}})(c.DefaultActivityHandlers||(c.DefaultActivityHandlers={}))})(c.workflow||(c.workflow=
{}))})(geocortex||(geocortex={}));
(function(c){(function(c){(function(c){c.handleSetLayerProperty=function(d){var b=d.getValue("MapServiceId"),a=d.getValue("LayerId"),g=d.getValue("LayerName"),h=d.getValue("PropertyName"),k=d.getValue("Value");if(!b)throw Error("Set Layer Property: required MapServiceId argument was not supplied.");if(!a&&!g)throw Error("Set Layer Property: a LayerId or a LayerName argument must be supplied.");var l=d.getSite();if(!l)throw Error("Set Layer Property: No site available.");l=c.findMapServiceById(l,b);
if(!l||!l.serviceLayer)throw Error("Set Layer Property: Unable to find map service with ID '"+b+"'");b=null;b=a?l.findLayerById(a):l.findLayerByName(g);if(!b)throw Error("Set Layer Property: Unable to find layer with Name '"+g+"' or ID '"+a+"'.");if(a=c.getPropertyIgnoreCase(b,h))b[a]=k;else if(a=c.getPropertyIgnoreCase(b.properties,h))b.properties[a]=k;else throw Error("Set Layer Property: Layer does not support the property '"+h+"'.");d.completeActivity()};c.handleGetLayerProperty=function(d){var b=
d.getValue("MapServiceId"),a=d.getValue("LayerId"),g=d.getValue("LayerName"),h=d.getValue("PropertyName");if(!b)throw Error("Get Layer Property: required MapServiceId argument was not supplied.");if(!a&&!g)throw Error("Get Layer Property: a LayerId or a LayerName argument must be supplied.");var k=d.getSite();if(!k)throw Error("Get Layer Property: No site available.");k=c.findMapServiceById(k,b);if(!k||!k.serviceLayer)throw Error("Get Layer Property: Unable to find map service with ID '"+b+"'");b=
null;b=a?k.findLayerById(a):k.findLayerByName(g);if(!b)throw Error("Get Layer Property: Unable to find layer with Name '"+g+"' or ID '"+a+"'.");if(a=c.getPropertyIgnoreCase(b,h))d.setValue("Value",b[a]);else if(a=c.getPropertyIgnoreCase(b.properties,h))d.setValue("Value",b.properties[a]);else throw Error("Get Layer Property: Layer does not support the property '"+h+"'.");d.completeActivity()};c.handleGetLayerVisibility=function(d){var b=d.getValue("MapServiceId"),a=d.getValue("LayerId"),g=d.getValue("LayerName"),
h=d.getValue("EffectiveVisibility");if(!b)throw Error("Get Layer Visibility: required MapServiceId argument was not supplied.");if(!a&&!g)throw Error("Get Layer Visibility: a LayerId or a LayerName argument must be supplied.");var k=d.getSite();if(!k)throw Error("Get Layer Visibility: No site available.");var l=c.findMapServiceById(k,b);if(!l)throw Error("Get Layer Visibility: Unable to find map service with ID '"+b+"'");k=null;a?k=l.findLayerById(a):g&&(k=l.findLayerByName(g));if(!k)throw Error("Get Layer Visibility: Unable to find layer with ID '"+
a+"' in map service with ID '"+b+"'");b=k.isVisible();if(h&&(b=!1,k.isVisible()&&l.isVisible()&&k.withinScaleRange(null)))for(h=l.getVisibleLayers(),a=0;a<h.length;a++)if(h[a]==k.id){b=!0;break}d.setValue("Visible",b);d.completeActivity()};c.handleSetLayerVisibility=function(d){var b=d.getValue("MapServiceId"),a=d.getValue("LayerId"),g=d.getValue("LayerName"),h=d.getValue("Visible");if(!b)throw Error("Set Layer Visibility: required MapServiceId argument was not supplied.");if(!a&&!g)throw Error("Set Layer Visibility: a LayerId or a LayerName argument must be supplied.");
if(null===h)throw Error("Set Layer Visibility: required Visible argument was not supplied.");var k=d.getSite();if(!k)throw Error("Set Layer Visibility: No site available.");k=c.findMapServiceById(k,b);if(!k)throw Error("Set Layer Visibility: Unable to find map service with ID '"+b+"'");var l=null;if(a){if(l=k.findLayerById(a),!l)throw Error("Set Layer Visibility: Unable to find layer with ID '"+a+"' in map service with ID '"+b+"'");}else if(g){if(l=k.findLayerByName(g),!l)throw Error("Set Layer Visibility: Unable to find layer with name '"+
g+"' in map service with ID '"+b+"'");}else throw Error("Set Layer Visibility: must define layer ID or name");l.setVisibility(h);d.completeActivity()};c.handleGetLayerDefinition=function(d){var b=d.getValue("MapServiceId"),a=d.getValue("LayerId"),g=d.getValue("LayerName");if(!b)throw Error("Get Layer Definition: required MapServiceId argument was not supplied.");if(!a&&!g)throw Error("Get Layer Definition: a LayerId or a LayerName argument must be supplied.");var h=null,k=d.getSite();if(k&&(b=c.findMapServiceById(k,
b))&&b.serviceLayer){if(!a&&g)if(a=b.findLayerByName(g))a=a.id;else throw Error("Set Layer Definition: Unable to find layer with Name '"+g+"'.");b.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer?b.serviceLayer.layerDefinitions&&(h=b.serviceLayer.layerDefinitions[parseInt(a)]):b.serviceLayer instanceof esri.layers.FeatureLayer&&(h=b.serviceLayer.getDefinitionExpression())}d.setValue("Definition",h);d.completeActivity()};c.handleSetLayerDefinition=function(d){var b=d.getValue("MapServiceId"),
a=d.getValue("LayerId"),g=d.getValue("LayerName"),h=d.getValue("Definition");if(!b)throw Error("Set Layer Definition: required MapServiceId argument was not supplied.");if(!a&&!g)throw Error("Set Layer Definition: a LayerId or a LayerName argument must be supplied.");var k=d.getSite();if(!k)throw Error("Set Layer Visibility: No site available.");k=c.findMapServiceById(k,b);if(!k||!k.serviceLayer)throw Error("Set Layer Definition: Unable to find map service with ID '"+b+"'");if(!a&&g)if(a=k.findLayerByName(g))a=
a.id;else throw Error("Set Layer Definition: Unable to find layer with Name '"+g+"'.");if(k.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer)g=k.serviceLayer,g.layerDefinitions||(g.layerDefinitions=[]),g.layerDefinitions[parseInt(a)]=h,g.setLayerDefinitions(g.layerDefinitions,!0);else if(k.serviceLayer instanceof esri.layers.FeatureLayer)k.serviceLayer.setDefinitionExpression(h);else throw Error("Set Layer Definition: Map service type does not support layer definitions.");d.completeActivity()};
c.handleGetGraphicsLayerContent=function(c){var b=c.getValue("GraphicsLayerId"),a=c.getValue("GeometryType"),g=null;null!==a&&(0===a?g="extent":1===a?g="multipoint":2===a?g="point":3===a?g="polygon":4===a&&(g="polyline"));a=c.getEsriMap();if(null!=a&&null!=a.graphicsLayerIds)for(var f=0;f<a.graphicsLayerIds.length;f++)if(b==a.graphicsLayerIds[f]){b=a.getLayer(a.graphicsLayerIds[f]);if(null!=b&&null!=b.graphics){a=new esri.tasks.FeatureSet;for(f=0;f<b.graphics.length;f++){var h=b.graphics[f];if(null!==
g){if(null===h.geometry)continue;if(g!==h.geometry.type)continue}h=new esri.Graphic(h.geometry,null,h.attributes,null);a.features.push(h)}c.setValue("Features",a)}break}c.completeActivity()};c.handleUpdateGraphicsLayer=function(d){var b=d.getValue("GraphicsLayerId"),a=!!d.getValue("RemoveAllFeatures"),g=d.getValue("FeatureSet"),h=d.getValue("RendererJson"),k=d.getEsriMap();if(null==k)throw Error("Update Graphics Layer: No map available.");var l=!1,m=c.findMapServiceByMap(k,b);if(!m)m=new esri.layers.GraphicsLayer({id:b}),
l=!0;else if(!(m instanceof esri.layers.GraphicsLayer))throw Error("Update Graphics Layer: The layer '"+b+"' is not a GraphicsLayer");try{m.suspend();a&&m.clear();if(g&&g.features)for(var r=g.features.length-1;0<=r;--r)m.add(g.features[r]);h&&(m.renderer=esri.renderer.fromJson(JSON.parse(h)));l&&k.addLayer(m)}finally{m.resume()}d.completeActivity()}})(c.DefaultActivityHandlers||(c.DefaultActivityHandlers={}))})(c.workflow||(c.workflow={}))})(geocortex||(geocortex={}));
(function(c){(function(h){(function(f){function d(a,b){return b&&a&&a.essentialsMap&&a.essentialsMap.mapServices?c.essentials.utilities.SiteResourceIdComparer.lookUp(a.essentialsMap.mapServices,b):null}function b(a,b){if(!a||!b)return null;if(null!=a.layerIds)for(var d=0;d<a.layerIds.length;d++){var f=a.getLayer(a.layerIds[d]);if(null!=f&&c.essentials.utilities.SiteResourceIdComparer.equals(f.id,b))return f}if(null!=a.graphicsLayerIds)for(d=0;d<a.graphicsLayerIds.length;d++)if(f=a.getLayer(a.graphicsLayerIds[d]),
null!=f&&c.essentials.utilities.SiteResourceIdComparer.equals(f.id,b))return f;return null}f.findMapServiceById=d;f.findMapServiceByMap=b;f.handleRemoveMapService=function(a){var c=a.getValue("MapServiceId"),d=a.getEsriMap();if(null==d)throw Error("Remove Map Service: No map available.");if(c=b(d,c))d.removeLayer(c),(d=a.getSite())&&d.essentialsMap&&d.essentialsMap.mapServices&&d.essentialsMap.removeServiceLayer(c);a.completeActivity()};f.handleSetImageServiceInfo=function(a){var c=a.getValue("ImageServiceId"),
d=a.getValue("BandIds"),f=a.getValue("MosaicRule"),h=a.getValue("RenderingRule"),m=a.getEsriMap();if(null==m)throw Error("Set Image Service Info: No map available.");require(["esri/layers/RasterFunction"],function(r){r=b(m,c);if(r instanceof esri.layers.ArcGISImageServiceLayer){d&&r.setBandIds(d,!0);if(f){var p=new esri.layers.MosaicRule(f);p.method||(p=r.defaultMosaicRule);r.setMosaicRule(p,!0)}h&&(p=new esri.layers.RasterFunction(h),p.functionName||(p=null),r.setRenderingRule(p,!0));r.refresh()}a.completeActivity()})};
f.handleSetMapServiceVisibility=function(a){var c=a.getValue("MapServiceId"),f=a.getValue("Visible");if(null==c)throw Error("Set Map Service Visibility: required MapServiceId argument was not supplied.");if(null==f)throw Error("Set Map Service Visibility: required Visible argument was not supplied.");var h=a.getEsriMap(),l=a.getSite();if(null==h)throw Error("Set Map Service Visibility: No map available.");var m=null,m=b(h,c);if(null==m)throw Error("Set Map Service Visibility: Unable to find map service with ID '"+
c+"'");m.setVisibility(f);a.completeActivity();l&&c&&(a=d(l,c),dojo.publish("MapServiceVisibilityChangedEvent",a))};f.handleGetMapServiceInfo=function(a){if(!a)throw Error("Get Map Service Info: required context was not supplied.");var c=a.getValue("MapServiceId"),f=a.getValue("LayerName");if(null==c)throw Error("Get Map Service Info: required MapServiceId argument was not supplied.");var h=null,l=null,m=null,r=null,p=!1,q=a.getEsriMap();if(null==q)throw Error("Get Map Service Info: No map available.");
var s=a.getSite(),t=null,u=null;null!=s&&null!=s.essentialsMap&&(u=d(s,c),null!=u&&(t=u.serviceLayer,h=u.serviceUrl,l=u.findServiceToken(),p=u.isVisible()));null==t&&(t=b(q,c))&&(h=t.url,"boolean"===typeof t.visible&&(p=t.visible));if(null!=f){c=!1;if(t.supportsDynamicLayers&&t.dynamicLayerInfos)for(q=t.dynamicLayerInfos,s=0;s<q.length;s++){var v=q[s];if(v.name===f||"{0}".format(v.id)===f){c=!0;m="dynamicLayer";r=v.source;break}}if(!c&&t.layerInfos)for(q=t.layerInfos,s=0;s<q.length;s++)if(v=q[s],
null!=v&&null!=v.id&&v.name==f){c=!0;m=v.id;break}!c&&u&&(f=u.findLayerOrTableByName(f))&&(m=f.id)}a.setValue("MapServiceUrl",h);a.setValue("Token",l);a.setValue("LayerId",m);a.setValue("Source",r);a.setValue("Visible",p);a.completeActivity()};f.handleSetMapServiceProperty=function(a){var c=a.getValue("MapServiceId"),d=a.getValue("PropertyName"),f=a.getValue("Value");if(!c)throw Error("{0}: required MapServiceId argument was not supplied.".format("Set Map Service Property"));if(!d)throw Error("{0}: required PropertyName argument was not supplied.".format("Set Map Service Property"));
var h=a.getEsriMap();if(!h)throw Error("{0}: no map available.".format("Set Map Service Property"));h=b(h,c);if(!h)throw Error("{0}: unable to find map service with ID '{1}'.".format("Set Map Service Property",c));if("gdbversion"===d.toLowerCase())if(h instanceof esri.layers.FeatureLayer){if(!h.isDataVersioned)throw Error("{0}: map service with ID '{1}' is not versioned.".format("Set Map Service Property",c));h.setGDBVersion(f)}else if(h instanceof esri.layers.ArcGISDynamicMapServiceLayer)h.setGDBVersion(f);
else throw Error("{0}: map service with ID '{1}' does not support GDB version.".format("Set Map Service Property",c));else if("visible"===d.toLowerCase())h.setVisibility(f);else{var d="set"+d.toLowerCase(),c=null,m;for(m in h)if(m.toLowerCase()===d){c=m;break}if(!c)throw Error("{0}: map service property '{1}' does not exist.".format("Set Map Service Property",d));h[c](f)}a.completeActivity()}})(h.DefaultActivityHandlers||(h.DefaultActivityHandlers={}))})(c.workflow||(c.workflow={}))})(geocortex||
(geocortex={}));
(function(c){(function(c){(function(c){c.handleGetCurrentPosition=function(c){if(navigator.geolocation){var b={enableHighAccuracy:c.getValue("EnableHighAccuracy"),timeout:c.getValue("Timeout")||2E4,maximumAge:c.getValue("MaximumAge")};navigator.geolocation.getCurrentPosition(function(a){c.setValue("Latitude",a.coords.latitude);c.setValue("Longitude",a.coords.longitude);c.setValue("Altitude",a.coords.altitude);c.setValue("Accuracy",a.coords.accuracy);c.setValue("AltitudeAccuracy",a.coords.altitudeAccuracy);c.setValue("Heading",
a.coords.heading);c.setValue("Speed",a.coords.speed);c.setValue("Timestamp",a.timestamp);c.completeActivity()},function(a){c.setValue("ErrorCode",a.code);c.setValue("ErrorMessage",a.message);c.completeActivity()},b)}else c.setValue("ErrorCode",2),c.setValue("ErrorMessage","Geolocation is not supported."),c.completeActivity()};c.handleGetPhoto=function(c){if(navigator.camera){var b={quality:c.getValue("Quality"),destinationType:c.getValue("DestinationType"),sourceType:c.getValue("SourceType"),allowEdit:c.getValue("AllowEdit"),
encodingType:c.getValue("EncodingType"),targetWidth:c.getValue("TargetWidth"),targetHeight:c.getValue("TargetHeight")};navigator.camera.getPicture(function(a){c.setValue("ImageData",a);c.completeActivity()},function(a){c.setValue("Message",a);c.completeActivity()},b)}else c.setValue("Message","camera is not supported."),c.completeActivity()}})(c.DefaultActivityHandlers||(c.DefaultActivityHandlers={}))})(c.workflow||(c.workflow={}))})(geocortex||(geocortex={}));
(function(c){(function(h){var f=function(){function d(b,a){this._mapService=null;this._mapService=b;if(this._mapService.mapServiceType!=c.essentials.MapServiceType.WMS&&this._mapService.mapServiceType!=c.essentials.MapServiceType.DYNAMIC)throw Error("LayerVisibilityEventManager: Only Dynamic and WMS Layer types supported.");var d=this;dojo.require("dojo.aspect");dojo.aspect.before(a,"setVisibleLayers",function(a,b){return d.beforeESRIsetVisibleLayers(a,b)});dojo.aspect.after(a,"setVisibleLayers",
function(a,b,c){d.afterESRIsetVisibleLayers(a,b,c)},!0)}d.prototype.beforeESRIsetVisibleLayers=function(b,a){var d=[],f=[];void 0===a&&(a=!1);if(b.InternallyChangedLayer)return f=b.InternallyChangedLayer,void 0!=f.mapServiceId&&void 0!=f.layerId&&void 0!=f.visibility&&d.push(f),d=[b,a,d];if(this._mapService.mapServiceType==c.essentials.MapServiceType.DYNAMIC)f=dojo.clone(b);else if(this._mapService.mapServiceType==c.essentials.MapServiceType.WMS)for(var h=0;b&&h<b.length;h++){var l=this._findWmsLayerIdFromName(b[h]);
if(l&&null!==l)f.push(l.toString());else return d=[b,a,d]}if(b&&this._mapService.mapServiceType==c.essentials.MapServiceType.DYNAMIC&&1===b.length&&"-1"==b[0]){for(f=0;f<this._mapService.layers.length;f++)l=this._mapService.layers[f].id,d.push({mapServiceId:this._mapService.id,layerId:l.toString(),visibility:!1}),this._mapService.findLayerById(l)._syncProgramaticallyChangedLayerVisibility(!1);return d=[b,a,d]}if(b&&0===b.length||this._mapService.mapServiceType==c.essentials.MapServiceType.DYNAMIC&&
1===b.length&&""===b[0])f=this._mapService.getDefaultVisibleLayers();for(var m=this._getAllCurrentlyVisibleLayers(),r=0;m&&r<m.length;r++)if(l=m[r],f&&0>f.indexOf(l.toString())&&(h=this._mapService.findLayerById(l)))d.push({mapServiceId:this._mapService.id,layerId:l.toString(),visibility:!1}),h._syncProgramaticallyChangedLayerVisibility(!1);l=this._mapService.getVisibleLayers();if(f&&0<f.length)for(m=0;m<f.length;m++)if(this._mapService.mapServiceType==c.essentials.MapServiceType.DYNAMIC&&isNaN(parseInt(f[m]))&&
(f[m]="0"),l&&0>l.indexOf(f[m].toString())&&(h=this._mapService.findLayerById(f[m])))h.subLayerIds&&0<h.subLayerIds.length&&(this._deleteItemWithId(f[m],d),this._recursivelyUpdateSublayerVisibility(h,!0,d)),d.push({mapServiceId:this._mapService.id,layerId:f[m].toString(),visibility:!0}),h._syncProgramaticallyChangedLayerVisibility(!0),h.parentLayerId&&null!==h.parentLayerId&&void 0!==h.parentLayerId&&this._recursivelyUpdateAncestorVisibility(h,f,d);return d=[b,a,d]};d.prototype.afterESRIsetVisibleLayers=
function(b,a,c){c&&0<c.length&&dojo.publish("LayerVisibilityChange",Array(c))};d.prototype._recursivelyUpdateAncestorVisibility=function(b,a,c){if(b&&b.parentLayerId&&null!==b.parentLayerId&&void 0!==b.parentLayerId){var d=this._mapService.findLayerById(b.parentLayerId);d.isVisible()||(this._deleteItemWithId(b.parentLayerId,c),d._syncProgramaticallyChangedLayerVisibility(!0),c.push({mapServiceId:this._mapService.id,layerId:b.parentLayerId.toString(),visibility:!0}));this._recursivelyUpdateAncestorVisibility(d,
a,c)}};d.prototype._recursivelyUpdateSublayerVisibility=function(b,a,c){if(b.subLayerIds&&0<b.subLayerIds.length)for(var d=0;d<b.subLayerIds.length;d++){var f=this._mapService.findLayerById(b.subLayerIds[d]),h=f.id;f._syncProgramaticallyChangedLayerVisibility(a);this._deleteItemWithId(h,c);c.push({mapServiceId:this._mapService.id,layerId:h.toString(),visibility:a});f.subLayerIds&&0<f.subLayerIds.length&&this._recursivelyUpdateSublayerVisibility(f,a,c)}};d.prototype._getAllCurrentlyVisibleLayers=function(){for(var b=
[],a=0;a<this._mapService.layers.length;a++){var c=this._mapService.layers[a];c.isVisible()&&b.push(c.id.toString())}return b};d.prototype._findWmsLayerIdFromName=function(b){for(var a=0;a<this._mapService.layers.length;a++){var c=this._mapService.layers[a];if(b==c.wmsLayerName)return c.id}return null};d.prototype._deleteItemWithId=function(b,a){for(var c=0;c<a.length;c++)a[c].layerId==b&&a.splice(c,1)};return d}();h.LayerVisibilityEventManager=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex=
{}));(function(c){c=c.essentials||(c.essentials={});c=c.MapServiceType||(c.MapServiceType={});c.DYNAMIC="Dynamic";c.TILED="Tiled";c.IMAGE="Image";c.BING="Bing";c.FEATURE="Feature";c.WMS="WMS";c.WMTS="WMTS";c.GEORSS="GeoRss";c.WEBTILED="WebTiled";c.VECTORTILE="VectorTile";c.KML="Kml";c.GRAPHICS="Graphics";c.LABEL="Label";c.STREAM="Stream";c.CSV="Csv";c.MAPIMAGE="MapImage";c.UNKNOWN="Unknown"})(geocortex||(geocortex={}));
(function(c){c=c.essentials||(c.essentials={});c=c.MapServiceFunction||(c.MapServiceFunction={});c.OPERATIONAL="Operational";c.BASE="Base"})(geocortex||(geocortex={}));(function(c){c=c.essentials||(c.essentials={});c=c.DrawingBehavior||(c.DrawingBehavior={});c.MAP_SERVICE="MapService";c.FEATURE_LAYER="FeatureLayer";c.GEORSS_LAYER="GeoRssLayer";c.KML_SERVICE="KmlService";c.GeoRSS_LAYER=c.GEORSS_LAYER})(geocortex||(geocortex={}));
(function(c){c=c.essentials||(c.essentials={});c=c.FailureAction||(c.FailureAction={});c.IGNORE="Ignore";c.WARN="Warn";c.ERROR="Error"})(geocortex||(geocortex={}));(function(c){c=c.essentials||(c.essentials={});c=c.UserLayerType||(c.UserLayerType={});c.LAYER_ADDITION="LayerAddition";c.LAYER_CATALOG="LayerCatalog";c.UPLOAD="Upload"})(geocortex||(geocortex={}));
(function(c){(function(h){var f=function(){function d(b,a,c){this.layerThemesInfo=b;this._configureLayerTheme("object"===typeof a?a:null,a,c)}d.prototype._configureLayerTheme=function(b,a,d){this.id=b?b.id:a;this.isDefaultTheme=null===this.id;this.isActive=!1;this.displayName=b?b.displayName:d;this.extensions=c._getExtensions(b?b.extensions:null);this.properties=b?b.properties:null};d.prototype.applyToMap=function(){var b=this;if(void 0==this.layerThemesInfo)throw Error("Could not apply theme '{0}' to the map because the LayerThemesInfo property is not set on this LayerTheme.".format(this.displayName));
var a=this.layerThemesInfo,d=a.map;if(void 0==d)throw Error("Failed to apply theme '{0}' to map because the Map property is not set on the LayerThemesInfo object.".format(this.displayName));this.isActive=!0;if(a.activeTheme&&a.activeTheme!==this||!a.activeTheme)a.activeTheme&&(a.previousTheme=a.activeTheme,a.previousTheme.isActive=!1),a.activeTheme=this;a.themeChangeInProgress=!0;a.layerThemeChangingEvent({currTheme:a.activeTheme,prevTheme:a.previousTheme});for(var f=function(a,b){void 0===b&&(b=
!1);a.setInActiveTheme(!0);l(a,a.configuredVisible,b)},h=function(a,c){void 0===c&&(c=!1);var d=a.getLayerThemeSettings(b.id);a.setInActiveTheme(null!=d);var f=!1;null!=d&&(f=void 0!=d.visible?d.visible:a.configuredVisible);l(a,f,c)},l=function(a,b,d){void 0===d&&(d=!1);if(a instanceof c.essentials.Layer)if(a.mapService.supportsLayerVisibility())4.02<=a.mapService.essentialsMap.site.getEssentialsVersion()&&a.type===c.essentials.LayerType.GROUP_LAYER&&(b=!0);else if(1!==a.mapService.layers.length||
!a.inActiveTheme||a.mapService.includeInLayerList)return;a.isUserCreated||a.setVisibility(b,d)},m=0;m<d.mapServices.length;m++){var r=d.mapServices[m],p=r.supportsLayerVisibility();this.isDefaultTheme?f(r):h(r);for(var q=0;q<r.layers.length;q++){var s=r.layers[q];this.isDefaultTheme?f(s,p):h(s,p)}p&&r.refresh()}d.refreshFilteredCollections();a.themeChangeInProgress=!1;a.layerThemeChangedEvent({currTheme:a.activeTheme,prevTheme:a.previousTheme})};return d}();h.LayerTheme=f})(c.essentials||(c.essentials=
{}))})(geocortex||(geocortex={}));(function(c){(function(c){var f=function(){return function(c,b){this.theme=c;this.visible=b}}();c.LayerThemeSetting=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(c){var f=function(){function c(b){this.layerThemeChangedEvent=function(a){};this.themeChangeInProgress=!1;this.layerThemeChangingEvent=function(a){};this.allowDefault=this.layerThemesConfigured=!1;this.themes=[];this.map=b}c.prototype.applyTheme=function(b){this.layerThemesConfigured&&(b=this.getTheme(b))&&b.applyToMap()};c.prototype.getTheme=function(b,a){void 0===a&&(a=!1);if(this.layerThemesConfigured)for(var c=0;c<this.themes.length;c++)if(this.themes[c].id===b||a&&this.themes[c].displayName.toLowerCase()===
b.toLowerCase())return this.themes[c];return null};return c}();c.LayerThemesInfo=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(c){var f=function(c){function b(){c.apply(this,arguments);this.mapSpatialReference=this.serviceLayer=this.updateInterval=null}__extends(b,c);b.prototype._configureObject=function(a,b){if(void 0===a)throw Error("Incorrect map service object returned from initialization");this.updateInterval=a.updateInterval;c.prototype._configureObject.call(this,a,b)};b.prototype._createServiceLayer=function(){var a=this;this.essentialsMap&&(this.mapSpatialReference=this.essentialsMap.initialExtent.spatialReference);
var b={id:this.id,outSR:this.mapSpatialReference};this.serviceLayer=new esri.layers.KMLLayer(this.serviceUrl,b);this._initiallyVisible?this.serviceLayer.show():this.serviceLayer.hide();this.serviceLayer._options=b;this.attributionDataUrl&&""!==this.attributionDataUrl?(this.serviceLayer.attributionDataUrl=this.attributionDataUrl,this.serviceLayer.hasAttributionData=!0):this.hasAttributionData&&(this.serviceLayer.attributionDataUrl=this.url+"/Attribution",this.serviceLayer.hasAttributionData=!0);var c=
this.serviceLayer.on("load",function(b){c.remove();a.serviceLayer.setOpacity(a.configuredOpacity);a._initializeKmlLayers()});this.serviceLayer.on("error",function(b){return a._layerLoadErrorHandler(b)});this.serviceLayer.setOpacity(this.configuredOpacity);this.updateInterval&&!isNaN(this.updateInterval)&&this.serviceLayer.setRefreshInterval(this.updateInterval)};b.prototype._updateStartHandler=function(){this._initializeKmlLayers()};b.prototype._initializeKmlLayers=function(){for(var a=this.serviceLayer.getLayers(),
b=0;b<a.length;b++)if(a[b]instanceof esri.layers.FeatureLayer){var c=a[b];c.layerId=+this.id;c.name=this.displayName;c.displayField="name";a[b].spatialReference=this.mapSpatialReference}};return b}(c.MapService);c.KmlService=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(c){(function(c){var d={};c.handleGetExternalValue=function(b){var a=b.getValue("Key");null!=a&&(a=d[a],void 0===a&&(a=null),b.setValue("Value",a));b.completeActivity()};c.handleSetExternalValue=function(b){var a=b.getValue("Key"),c=b.getValue("Value");null!=a&&(d[a]=c);b.completeActivity()}})(c.CacheActivityHandlers||(c.CacheActivityHandlers={}))})(c.workflow||(c.workflow={}))})(geocortex||(geocortex={}));
(function(c){(function(h){var f=function(){function d(b,a,c,d,f,h,m){this.isBusy=!1;this._drawObjectContext=null;this._registeredActivityHandlers={};this._registeredExternalIdHandlers={};this.handleOpenReportUrlFunction=this.handleUnhandledActivityErrorFunction=null;this.defaultFormContainerId="form-container-outer";this.defaultFormContentId="form-container";this._handleErrorFunction=b||null;this._activityBeginFunction=a||null;this._activityCompleteFunction=c||null;this._workflowAbortFunction=f||
null;this._workflowCompleteFunction=d||null;this._webRequestBeginFunction=h||null;this._webRequestCompleteFunction=m||null;this.registerDefaultHandlers()}d.prototype.registerDefaultHandlers=function(){this.registerActivityHandler("Geocortex.Workflow.Activities.Alert",c.workflow.DefaultActivityHandlers.handleAlert);this.registerActivityHandler("Geocortex.Workflow.Activities.CaptureGeometry",c.workflow.DefaultActivityHandlers.handleCaptureGeometry);this.registerActivityHandler("Geocortex.Workflow.Activities.Confirm",
c.workflow.DefaultActivityHandlers.handleConfirm);this.registerActivityHandler("Geocortex.Workflow.Activities.ExportMap",c.workflow.DefaultActivityHandlers.handleExportMap);this.registerActivityHandler("Geocortex.Workflow.Activities.ExternalDelay",c.workflow.DefaultActivityHandlers.handleExternalDelay);this.registerActivityHandler("Geocortex.Workflow.Activities.GetBrowserUrl",c.workflow.DefaultActivityHandlers.handleGetBrowserUrl);this.registerActivityHandler("Geocortex.Workflow.Activities.GetCurrentPosition",
c.workflow.DefaultActivityHandlers.handleGetCurrentPosition);this.registerActivityHandler("Geocortex.Workflow.Activities.GetExternalTimeInfo",c.workflow.DefaultActivityHandlers.handleGetExternalTimeInfo);this.registerActivityHandler("Geocortex.Workflow.Activities.GetExternalValue",c.workflow.CacheActivityHandlers.handleGetExternalValue);this.registerActivityHandler("Geocortex.Workflow.Activities.GetGraphicsLayerContent",c.workflow.DefaultActivityHandlers.handleGetGraphicsLayerContent);this.registerActivityHandler("Geocortex.Workflow.Activities.GetLayerDefinition",
c.workflow.DefaultActivityHandlers.handleGetLayerDefinition);this.registerActivityHandler("Geocortex.Workflow.Activities.GetLayerInfoByProperty",c.workflow.DefaultActivityHandlers.handleGetLayerInfoByProperty);this.registerActivityHandler("Geocortex.Workflow.Activities.GetLayerProperty",c.workflow.DefaultActivityHandlers.handleGetLayerProperty);this.registerActivityHandler("Geocortex.Workflow.Activities.GetLayerVisibility",c.workflow.DefaultActivityHandlers.handleGetLayerVisibility);this.registerActivityHandler("Geocortex.Workflow.Activities.GetMapExtent",
c.workflow.DefaultActivityHandlers.handleGetMapExtent);this.registerActivityHandler("Geocortex.Workflow.Activities.GetMapInfo",c.workflow.DefaultActivityHandlers.handleGetMapInfo);this.registerActivityHandler("Geocortex.Workflow.Activities.GetMapServiceInfo",c.workflow.DefaultActivityHandlers.handleGetMapServiceInfo);this.registerActivityHandler("Geocortex.Workflow.Activities.GetPhoto",c.workflow.DefaultActivityHandlers.handleGetPhoto);this.registerActivityHandler("Geocortex.Workflow.Activities.PrintMap",
c.workflow.DefaultActivityHandlers.handlePrintMap);this.registerActivityHandler("Geocortex.Workflow.Activities.Prompt",c.workflow.DefaultActivityHandlers.handlePrompt);this.registerActivityHandler("Geocortex.Workflow.Activities.RefreshMap",c.workflow.DefaultActivityHandlers.handleRefreshMap);this.registerActivityHandler("Geocortex.Workflow.Activities.RemoveMapService",c.workflow.DefaultActivityHandlers.handleRemoveMapService);this.registerActivityHandler("Geocortex.Workflow.Activities.Report",c.workflow.DefaultActivityHandlers.handleReport);
this.registerActivityHandler("Geocortex.Workflow.Activities.SetExternalValue",c.workflow.CacheActivityHandlers.handleSetExternalValue);this.registerActivityHandler("Geocortex.Workflow.Activities.SetLayerDefinition",c.workflow.DefaultActivityHandlers.handleSetLayerDefinition);this.registerActivityHandler("Geocortex.Workflow.Activities.SetLayerProperty",c.workflow.DefaultActivityHandlers.handleSetLayerProperty);this.registerActivityHandler("Geocortex.Workflow.Activities.SetLayerVisibility",c.workflow.DefaultActivityHandlers.handleSetLayerVisibility);
this.registerActivityHandler("Geocortex.Workflow.Activities.SetMapExtent",c.workflow.DefaultActivityHandlers.handleSetMapExtent);this.registerActivityHandler("Geocortex.Workflow.Activities.SetMapServiceVisibility",c.workflow.DefaultActivityHandlers.handleSetMapServiceVisibility);this.registerActivityHandler("Geocortex.Workflow.Activities.UpdateGraphicsLayer",c.workflow.DefaultActivityHandlers.handleUpdateGraphicsLayer);this.registerActivityHandler("Geocortex.Workflow.Activities.WaitForGeoprocessorJobComplete",
c.workflow.DefaultActivityHandlers.handleWaitForGeoprocessorJobComplete);this.registerActivityHandler("Geocortex.Workflow.Activities.SetImageServiceInfo",c.workflow.DefaultActivityHandlers.handleSetImageServiceInfo);this.registerActivityHandler("Geocortex.Workflow.Activities.SetMapServiceProperty",c.workflow.DefaultActivityHandlers.handleSetMapServiceProperty);this.registerExternalIdHandler("IntersectLayers",c.workflow.DefaultActivityHandlers.handleIntersectLayers);this.registerExternalIdHandler("GetPhoto",
c.workflow.DefaultActivityHandlers.handleGetPhoto)};d.prototype.canHandleActivity=function(b){b||this.handleError(Error("Null ActivityContext passed to canHandleActivity."),b);if(null!=b.getActivityExternalId()&&null!=this._registeredExternalIdHandlers[b.getActivityExternalId()])return!0;b=b.getActivityTypeName();return null!=b&&this._registeredActivityHandlers[b]?!0:!1};d.prototype.registerExternalIdHandler=function(b,a){null==b||null==a?this.handleError(Error("Null externalId or handler passed to registerExternalIdHandler."),
null):this._registeredExternalIdHandlers[b]=a};d.prototype.registerActivityHandler=function(b,a){null==b||null==a?this.handleError(Error("Null activityTypeName or handler passed to registerActivityHandler."),null):this._registeredActivityHandlers[b]=a};d.prototype.dispatch=function(b){if(null==b){var a=Error("Null ActivityContext passed to dispatch.");this.handleError(a,b)}else{var a=b.getActivityTypeName(),c=b.getActivityExternalId();this.canHandleActivity(b)?(null!=c&&null!=this._registeredExternalIdHandlers[c]&&
(c=this._registeredExternalIdHandlers[c],c(b,this)),null!=a&&this._registeredActivityHandlers[a]&&(c=this._registeredActivityHandlers[a],c(b,this))):(a=Error("Unknown activity type '"+a+"' or external ID '"+c+"' encountered."),this.handleUnhandledActivityErrorFunction(a,b))}};d.prototype.handleError=function(b,a){null!=this._handleErrorFunction&&this._handleErrorFunction(b,a)};d.prototype.handleUnhandledActivityError=function(b,a){null!=this.handleUnhandledActivityErrorFunction?this.handleUnhandledActivityErrorFunction(b,
a):this.handleError(b,a)};d.prototype.handleOpenReportUrl=function(b,a){null!=this.handleOpenReportUrlFunction?this.handleOpenReportUrlFunction(b,a):window.open(b)};d.prototype.webRequestBegin=function(b,a){null!=this._webRequestBeginFunction&&this._webRequestBeginFunction(b,a)};d.prototype.webRequestComplete=function(b,a){null!=this._webRequestCompleteFunction&&this._webRequestCompleteFunction(b,a)};d.prototype.abortMapBasedActivity=function(){if(this._drawObjectContext){if(!this._drawObjectContext.toolbar||
!this._drawObjectContext.drawEvent||!this._drawObjectContext.activityContext)return!1;this._drawObjectContext.toolbar.deactivate();dojo.disconnect(this._drawObjectContext.drawEvent);this._drawObjectContext.activityContext.abortActivity();this._drawObjectContext=null}return!0};d.prototype.setDrawObjectContext=function(b){this._drawObjectContext=b};d.prototype.activityBegin=function(b){null!=this._activityBeginFunction&&this._activityBeginFunction(b)};d.prototype.activityComplete=function(b){null!=
this._activityCompleteFunction&&this._activityCompleteFunction(b)};d.prototype.activityAbort=function(b){this.workflowAbort(b,b.workflow())};d.prototype.workflowComplete=function(b,a){null!=this._workflowCompleteFunction&&this._workflowCompleteFunction(b,a)};d.prototype.workflowAbort=function(b,a){null!=this._workflowAbortFunction&&this._workflowAbortFunction(b,a)};return d}();h.DefaultActivityDispatcher=f})(c.workflow||(c.workflow={}))})(geocortex||(geocortex={}));
(function(c){(function(h){var f=function(){function d(b,a,d,f,h,l,m,r){this._defaultActivityDispatcher=new c.workflow.DefaultActivityDispatcher;this.isBusy=this._drawObjectContext=null;this._dispatchFunction=b||null;this._handleErrorFunction=a||null;this._activityBeginFunction=d||null;this._activityCompleteFunction=f||null;this._workflowCompleteFunction=h||null;this._workflowAbortFunction=l||null;this._webRequestBeginFunction=m||null;this._webRequestCompleteFunction=r||null}d.prototype.dispatch=function(b){this._defaultActivityDispatcher.canHandleActivity(b)?
this._defaultActivityDispatcher.dispatch(b):null!=this._dispatchFunction&&this._dispatchFunction(b)};d.prototype.handleError=function(b,a){null!=this._handleErrorFunction&&this._handleErrorFunction(b,a)};d.prototype.abortMapBasedActivity=function(){if(this._drawObjectContext){if(!this._drawObjectContext.toolbar||!this._drawObjectContext.drawEvent||!this._drawObjectContext.activityContext)return!1;this._drawObjectContext.toolbar.deactivate();dojo.disconnect(this._drawObjectContext.drawEvent);this._drawObjectContext.activityContext.abortActivity();
this._drawObjectContext=null}return!0};d.prototype.setDrawObjectContext=function(b){this._drawObjectContext=b};d.prototype.activityBegin=function(b){null!=this._activityBeginFunction&&this._activityBeginFunction(b)};d.prototype.activityComplete=function(b){null!=this._activityCompleteFunction&&this._activityCompleteFunction(b)};d.prototype.activityAbort=function(b){this.workflowAbort(b,b.workflow())};d.prototype.webRequestBegin=function(b,a){null!=this._webRequestBeginFunction&&this._webRequestBeginFunction(b,
a)};d.prototype.webRequestComplete=function(b,a){null!=this._webRequestCompleteFunction&&this._webRequestCompleteFunction(b,a)};d.prototype.workflowComplete=function(b,a){null!=this._workflowCompleteFunction&&this._workflowCompleteFunction(b,a)};d.prototype.workflowAbort=function(b,a){null!=this._workflowAbortFunction&&this._workflowAbortFunction(b,a)};d.prototype.handleOpenReportUrl=function(b,a){window.open(b)};return d}();h.SimpleActivityDispatcher=f})(c.workflow||(c.workflow={}))})(geocortex||
(geocortex={}));
(function(c){(function(h){(function(f){f._pickSupported=function(c,b){if(!c||0>=c.length)return null;if(b)for(var a=b.toUpperCase(),f=0;f<c.length;f++){var h=c[f];if(h&&h.toUpperCase()===a)return c[f]}return c[0]};f.handleIntersectLayers=function(d){var b=[],a=[],f=[],h=[],k=null,l=k=null,l=l=null,m=!1,r=null,p,q;p=-1;var s=d.getValue("InputLayers");if(s&&0<s.length)for(k=0;k<s.length;k++)p=s[k].lastIndexOf("\\\\"),0<=p&&(s[k]=s[k].substring(p+2));else d.dispatcher().handleError(Error("Intersect Layers: no input layers provided."),d);
(k=d.getSite())||d.dispatcher().handleError(Error("Intersect Layers: no site available."),d);(k=k.essentialsMap)||d.dispatcher().handleError(Error("Intersect Layers: no map available."),d);(!k.mapServices||0>=k.mapServices.length)&&d.dispatcher().handleError(Error("Intersect Layers: no map service is configured for the map."),d);for(p=0;p<k.mapServices.length;p++){var l=k.mapServices[p],l=l.layers,r=[],t=s.length,u="";l.forEach(function(a){u=a.name;for(var b=0;b<t;++b)if(u===s[b]){r.push(a);break}});
for(q=0;q<r.length;q++){l=r[q];m=!1;switch(l.type){case c.essentials.LayerType.FEATURE_LAYER:a.push(l.name);m=!0;break;case c.essentials.LayerType.GROUP_LAYER:f.push(l.name);m=!0;break;case c.essentials.LayerType.RASTER_LAYER:h.push(l.name),m=!0}m&&b.push(l.name)}}d.setValue("OutputLayers",b);d.setValue("FeatureLayers",a);d.setValue("GroupLayers",f);d.setValue("RasterLayers",h);d.completeActivity()};f.handleExportMap=function(d){var b=d.getValue("TargetSpatialReference"),a=d.getValue("CustomExtent"),
f=d.getValue("Resolution"),h=d.getValue("OutputFormat"),k=d.getValue("Scale"),l=d.getValue("ImageHeight"),m=d.getValue("ImageWidth"),r=d.getValue("UseTransparentBackground"),p=null,q=null,s=p=null;(p=d.getSite())||d.dispatcher().handleError(Error("Export Map: no site available."),d);(q=p.getMap())||d.dispatcher().handleError(Error("Export Map: no map available."),d);(p=p.essentialsMap)||d.dispatcher().handleError(Error("Export Map: no map available."),d);s=new c.essentials.ReportParameters;s.outputFormat=
c.workflow.MapActivityHandlers._pickSupported(p.supportedExportFormats,h);f&&(s.resolution=new c.essentials.Resolution("",f));k&&(s.scale=new c.essentials.Scale("",k));s.imageHeight=l?l:q.height;s.imageWidth=m?m:q.width;a&&(s.customExtent=a);s.extentType=a?c.essentials.ReportParameters.CUSTOM_EXTENT:c.essentials.ReportParameters.CURRENT_EXTENT;s.useTransparentBackground=r;b&&(s.targetSpatialReference=b);q&&s.populateMapGraphicsLayers(q);p.exportMap(s,function(a){d.setValue("ResultUrl",a?a.href:null);
d.completeActivity()},function(a){d.dispatcher().handleError(Error("Error exporting map '"+a.message+"'"),d)})};f.handlePrintMap=function(d){var b=d.getValue("TargetSpatialReference"),a=d.getValue("TextFields"),f=d.getValue("CustomExtent"),h=d.getValue("NotificationEmailAddress"),k=d.getValue("Resolution"),l=d.getValue("OutputFormat"),m=d.getValue("Scale"),r=d.getValue("PrintTemplateId"),p=d.getValue("GridId"),q=null,s=null;(q=d.getSite())||d.dispatcher().handleError(Error("Print Map: no site available."),
d);(s=q.getMap())||d.dispatcher().handleError(Error("Print Map: no map available."),d);(q=q.findPrintTemplateById(r))||d.dispatcher().handleError(Error("Print Map: unable to find print template '"+r+"'."),d);q.isPrinting()&&d.dispatcher().handleError(Error("Print Map: unable to perform print operation because print template '"+r+"' is busy."),d);r=new c.essentials.ReportParameters;r.outputFormat=c.workflow.MapActivityHandlers._pickSupported(q.supportedOutputFormats,l);k&&(r.resolution=new c.essentials.Resolution("",
k));m&&(r.scale=new c.essentials.Scale("",m));h&&(r.notificationEmailAddress=h);f&&(r.customExtent=f);r.extentType=f?c.essentials.ReportParameters.CUSTOM_EXTENT:c.essentials.ReportParameters.CURRENT_EXTENT;b&&(r.targetSpatialReference=b);if(q.textFields&&0<q.textFields.length&&a)for(b=0;b<a.length;b++)if(a[b])for(f=0;f<q.textFields.length;f++)a[b].Key===q.textFields[f].displayName&&(h=new c.essentials.TextField(q.textFields[f].id,"",a[b].Value,!1),r.fields.push(h));p&&(a=dojo.filter(q.grids,function(a){return a.id==
p}),0<a.length&&(r.grid=a[0]));q.print(r,function(a){d.setValue("ResultUrl",a?a.href:null);d.completeActivity()},function(a){d.dispatcher().handleError(Error("Error printing map '"+a.message+"'"),d)})}})(h.MapActivityHandlers||(h.MapActivityHandlers={}))})(c.workflow||(c.workflow={}))})(geocortex||(geocortex={}));
(function(c){(function(h){(function(f){f.handleIntersectLayers=function(d){c.workflow.MapActivityHandlers.handleIntersectLayers(d)};f.handleExportMap=function(d){c.workflow.MapActivityHandlers.handleExportMap(d)};f.handlePrintMap=function(d){c.workflow.MapActivityHandlers.handlePrintMap(d)};f.handleRefreshMap=function(d){var b=d.getValue("MapServiceId");if(null!=d.getEsriMap()){var a=function(a){a=a.serviceLayer;if("function"==typeof a.refresh)if("boolean"==typeof a.disableClientCaching){var b=a.disableClientCaching;
a.disableClientCaching=!0;a.refresh();a.disableClientCaching=b}else a.refresh()},f=d.workflow().site.essentialsMap.mapServices;b?(b=c.essentials.utilities.SiteResourceIdComparer.lookUp(f,b))&&a(b):dojo.forEach(f,function(b){a(b)})}else throw Error("Refresh Map: no map available.");d.completeActivity()};f.handleGetMapExtent=function(c){var b=c.getEsriMap();if(null==b)throw Error("Get Map Extent: No map available.");c.setValue("Extent",b.extent);c.completeActivity()};f.handleGetMapInfo=function(c){var b=
c.getEsriMap();if(null==b)throw Error("Get Map Info: No map available.");c.setValue("Extent",b.extent);c.setValue("Scale",esri.geometry.getScale(b));c.setValue("SpatialReference",b.spatialReference);c.setValue("Height",b.height);c.setValue("Width",b.width);var a=[];null!=b.layerIds&&(a=a.concat(b.layerIds));null!=b.graphicsLayerIds&&(a=a.concat(b.graphicsLayerIds));c.setValue("MapServiceIds",a);c.completeActivity()};f.handleSetMapExtent=function(c){var b=c.getValue("Extent");if(null!=b){var a=c.getEsriMap();
if(null!=a){b.spatialReference&&(b.spatialReference.wkid||b.spatialReference.wkt)||(b.spatialReference=a.spatialReference);var f=c.getSite();f&&f.essentialsMap?f.essentialsMap.extentManager.setExtentWithPriority(b,10):a.setExtent(b)}else throw Error("Set Map Extent: No map available.");}else throw Error("Set Map Extent: required Extent argument was not supplied.");c.completeActivity()};f.handleCaptureGeometry=function(c){function b(a,b,h){h.deactivate();dojo.disconnect(b);f.setDrawObjectContext(null);
c.setValue("Result",a);c.completeActivity()}function a(a){var c;switch(a){case 0:c=esri.toolbars.Draw.EXTENT;break;case 1:c=esri.toolbars.Draw.FREEHAND_POLYGON;break;case 2:c=esri.toolbars.Draw.FREEHAND_POLYLINE;break;case 3:c=esri.toolbars.Draw.LINE;break;case 4:c=esri.toolbars.Draw.POINT;break;case 5:c=esri.toolbars.Draw.MULTI_POINT;break;case 6:c=esri.toolbars.Draw.POLYGON;break;case 7:c=esri.toolbars.Draw.POLYLINE;break;case 8:b(k.extent,m,l);r=!1;break;default:c=esri.toolbars.Draw.EXTENT}return c}
var f=c.dispatcher();if(!f.abortMapBasedActivity())throw Error("Could not deactivate current map based activity.");var h=c.getValue("CaptureType"),k=c.getEsriMap();if(null!=k){if("function"!=typeof esri.toolbars.Draw)throw Error('dojo.require("esri.toolbars.draw") must be added to your client code to use CaptureGeometry activity.');var l=new esri.toolbars.Draw(k),m=dojo.connect(l,"onDrawEnd",dojo.hitch(m,function(a){b(a,m,l)})),r=!0,h=a(h);r&&l.activate(h)}else throw Error("Capture Geometry: No map available.");
f.setDrawObjectContext({activityContext:c,toolbar:l,drawEvent:m})}})(h.DefaultActivityHandlers||(h.DefaultActivityHandlers={}))})(c.workflow||(c.workflow={}))})(geocortex||(geocortex={}));
(function(c){(function(h){(function(f){f.parseObject=function(d){if(d)try{if(3===d.nodeType||4===d.nodeType){var b=String.prototype.trim?d.nodeValue.trim():dojo.string.trim(d.nodeValue);return 0===b.length?null:b}if(1===d.nodeType){var a={},f=0;dojo.forEach(d.attributes,function(b){a[b.nodeName]=b.nodeValue});dojo.forEach(d.childNodes,function(b){var d=c.essentials.xmlUtils.parseObject(b);d&&(f++,a[b.nodeName]?(!1===dojo.isArray(a[b.nodeName])&&(a[b.nodeName]=[a[b.nodeName]]),a[b.nodeName].push(d)):
a[b.nodeName]=d)});return 1===f&&a["#text"]?a["#text"]:1===f&&a["#cdata-section"]?a["#cdata-section"]:a}}catch(h){throw Error("Unable to parse XML object: "+h.toString());}return null};f.getAllNodes=function(c){var b=new dojo.NodeList;if(dojo.isIE){c=c.childNodes;for(var a=0;a<c.length;a++)b.push(c[a])}else b=dojo.query("*",c);return b};f.getNodes=function(c,b,a){var f=new dojo.NodeList;dojo.isIE?(c=a.getElementsByTagName(c),dojo.forEach(c,function(a,c,d){a=a.getElementsByTagName(b);dojo.forEach(a,
function(a,b,c){f.push(a)})})):f=dojo.query(c+" > "+b,a);return f};f.getValue=function(c,b){if(c){var a=c;dojo.isString(c)&&(a=c.split(" > "),a=this.getNodes(a[0],a[1],b)[0]);return a.firstChild&&a.firstChild.nodeValue?a.firstChild.nodeValue:"Node not valid"}return"No Value"};f.getAttribute=function(c,b){if(c){if(dojo.isIE){for(var a=0;a<c.attributes.length;a++)if(c.attributes[a].nodeName==b)return c.attributes[a].nodeValue;return null}return c.getAttribute(b)}return"No Value"}})(h.xmlUtils||(h.xmlUtils=
{}))})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));(function(c){(function(h){var f=function(){return function(d,b){this.error=b;if(this.resultObject=d)this.rawJson=c.encodeJson(d)}}();h.RestEndpointResult=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(h){var f=function(){function d(){this._activeEndpointRequest=!1;this._onRequestError=this._onRequestComplete=null}d.prototype.getCustomRestEndpoint=function(b,a,d,f,h){this._activeEndpointRequest?this._onEndpointRequestError(Error("An operation is already in progress.")):(this._activeEndpointRequest=!0,this._onRequestComplete=d,this._onRequestError=f,c.request({url:b,content:a,load:dojo.hitch(this,this._onEndpointRequestComplete),error:dojo.hitch(this,this._onEndpointRequestError),
callbackParamName:"CallBack"},h))};d.prototype._onEndpointRequestComplete=function(b){this._activeEndpointRequest=!1;try{b||(b={error:Error("Expected results")}),b.error&&this._onRequestError&&this._onRequestError(b.error)}finally{this._onRequestComplete&&this._onRequestComplete(new c.essentials.RestEndpointResult(b,b.error))}};d.prototype._onEndpointRequestError=function(b){this._activeEndpointRequest=!1;try{this._onRequestError&&this._onRequestError(b)}finally{this._onRequestComplete&&this._onRequestComplete(new c.essentials.RestEndpointResult(null,
b))}};return d}();h.RestUtility=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
(function(c){(function(h){var f=function(d){function b(a){d.call(this,a);this._colorSet=!1;this.geometryService=this.mapSpatialReference=this.geoRssLayer=this.markerSymbol=this.pictureSymbol=this.updateInterval=this.feedImageUri=this.feedUrl=this.color=this._layerLoadCompleted=null}__extends(b,d);b.prototype._configureObject=function(a,c){if(void 0===a)throw Error("Incorrect map service object returned from initialization");b.webMercatorSref=new esri.SpatialReference({wkid:102100});b.wgs84Sref=new esri.SpatialReference({wkid:4326});
this.feedImageUri=a.feedImageUri;this.updateInterval=a.updateInterval;this.geoRssLayer=new esri.layers.GraphicsLayer({opacity:a.opacity,id:a.id,visible:a.visible});dojo.connect(this.geoRssLayer,"onError",this,this._layerLoadErrorHandler);a.color&&(this.color=a.color,this._colorSet=!0,3<this.color.length&&(this.color[3]/=255));d.prototype._configureObject.call(this,a,c);this.attributionDataUrl&&""!==this.attributionDataUrl?(this.geoRssLayer.attributionDataUrl=this.attributionDataUrl,this.geoRssLayer.hasAttributionData=
!0):this.hasAttributionData&&(this.geoRssLayer.attributionDataUrl=this.url+"/Attribution",this.geoRssLayer.hasAttributionData=!0)};b.prototype._createServiceLayer=function(){var a=null;this.essentialsMap&&(a=this.essentialsMap.site,this.mapSpatialReference=this.essentialsMap.initialExtent.spatialReference);this.feedImageUri?(this.feedImageUri=c.essentials.RestHelper.processClientSideTokens(a,this.feedImageUri),this.pictureSymbol=new esri.symbol.PictureMarkerSymbol(this.feedImageUri,25,25)):this.markerSymbol=
new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE,15,new esri.symbol.SimpleLineSymbol,new esri.Color(this.color));this.feedUrl=this.serviceUrl;this._loadFeed();if(this.updateInterval&&!isNaN(this.updateInterval)){var b=this;this._layerLoadCompleted=!1;var d=setInterval(function(){b._layerLoadCompleted&&b._loadFeed();b._layerLoadCompleted=!1},1E3*this.updateInterval);dojo.connect(window,"onunload",function(){clearInterval(d)})}this.serviceLayer=this.geoRssLayer};b.prototype._loadFeed=
function(){esri.config.defaults.io.proxyUrl&&esri.request({url:this.serviceUrl,content:{},handleAs:"xml",load:dojo.hitch(this,this._handleFeed),error:function(a){a&&a.message&&"string"==typeof a.message&&alert(a.message)}})};b.prototype._handleFeed=function(a){var b=this._getFeedRoot(a);if(b){var d=b.nodeName,f=c.essentials.xmlUtils.getAttribute(b,"xml:base"),h=[],b=null;"feed"===d?b=c.essentials.xmlUtils.getNodes("feed","entry",a):"rdf"===d?b=c.essentials.xmlUtils.getNodes("rdf","item",a):"rss"===
d&&(b=c.essentials.xmlUtils.getNodes("channel","item",a));if(b){var m=this.pictureSymbol||this.markerSymbol;b.forEach(dojo.hitch(this,function(a,b,g){var s,t,u,v=null;c.essentials.xmlUtils.getAllNodes(a).forEach(dojo.hitch(this,function(a,b,g){a.nodeName&&("title"===a.nodeName&&(s=a.firstChild.nodeValue),"feed"===d?"summary"===a.nodeName&&(u=a.firstChild.nodeValue):"description"===a.nodeName&&(u=a.firstChild.nodeValue),"link"===a.nodeName&&(t="feed"===d?(f||"")+c.essentials.xmlUtils.getAttribute(a,
"href"):(f||"")+a.firstChild.nodeValue),"georss:where"===a.nodeName&&(v=this._getGMLGRSSPoint(a)),"georss:point"===a.nodeName&&(v=this._getSimpleGRSSPoint(a)),"geo:lat"===a.nodeName&&(v=this._getW3CGRSSPoint(a)))}));v&&h.push(new esri.Graphic(v,m,{title:s,content:u,link:t},null))}));this.mapSpatialReference&&this._projectShapes(h,this.mapSpatialReference)}}};b.prototype._projectShapes=function(a,c){if(a&&c){for(var d=!1,f=b.webMercatorSref.wkid,h=b.wgs84Sref.wkid,m=0;m<a.length;m++){var r=a[m],p=
null;r.geometry&&r.geometry.spatialReference.wkid!==c.wkid&&(c.wkid===f&&r.geometry.spatialReference.wkid===h?p=esri.geometry.geographicToWebMercator(r.geometry):c.wkid===h&&r.geometry.spatialReference.wkid===f?p=esri.geometry.webMercatorToGeographic(r.geometry):(p=esri.geometry.geographicToWebMercator(r.geometry),d=!0),r.geometry=p)}if(d){var q=[],d=this.geometryServiceUrl||this._getDefaultGeometryServiceUrl(),f=this.geometryServiceUrl?null:this._getDefaultGeometryServiceToken();null!==f&&(d+=(-1<
d.indexOf("?")?"&token=":"?token=")+encodeURIComponent(f));this.geometryService=new esri.tasks.GeometryService(d);dojo.forEach(a,function(a){q.push(a.geometry)});d=new esri.tasks.ProjectParameters;d.geometries=q;d.outSR=c;this.geometryService.project(d,dojo.hitch(this,function(b){for(var c=0;c<b.length;c++)a[c].geometry=b[c];this._publishLayer(a)}),this._projectionError);return}}this._publishLayer(a)};b.prototype._publishLayer=function(a){this.geoRssLayer&&(this.geoRssLayer.clear(),dojo.forEach(a,
dojo.hitch(this,function(a){this.geoRssLayer.add(a)})),this.geoRssLayer.redraw(),dojo.publish("geoRssLayerLoaded",[{esriLayer:this.geoRssLayer}]),this._layerLoadCompleted=!0)};b.prototype._projectionError=function(a){};b.prototype._getSimpleGRSSPoint=function(a){a=a.firstChild.nodeValue.split(" ");return new esri.geometry.Point(parseFloat(a[1]),parseFloat(a[0]),b.wgs84Sref)};b.prototype._getGMLGRSSPoint=function(a){a=this._getNonTextNodeChild(a);a=this._getNonTextNodeChild(a).firstChild.nodeValue.split(" ");
return new esri.geometry.Point(parseFloat(a[1]),parseFloat(a[0]),b.wgs84Sref)};b.prototype._getNonTextNodeChild=function(a){a=a.childNodes;for(var b=0;b<a.length;b++)if(3!==a[b].nodeType)return a[b]};b.prototype._getW3CGRSSPoint=function(a){if(!a.nextSibling)return null;var c=a.nextSibling;"#text"===a.nextSibling.nodeName&&(c=a.nextSibling.nextSibling);a=a.firstChild.nodeValue;return new esri.geometry.Point(parseFloat(c.firstChild.nodeValue),parseFloat(a),b.wgs84Sref)};b.prototype._getFeedRoot=function(a){if(!a)throw Error("The GeoRSS service at "+
this.feedUrl+" returned an invalid response.");a=a.childNodes;for(var b=0;b<a.length;b++)if(a[b]&&"xml"!==a[b].nodeName.substring(0,3))return a[b];return null};b.webMercatorSref=null;b.wgs84Sref=null;return b}(h.MapService);h.GeoRssLayerService=f})(c.essentials||(c.essentials={}))})(geocortex||(geocortex={}));
