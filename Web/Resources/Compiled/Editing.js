function shim(e,t,i){if("string"==typeof e&&(i=t,t=e),"undefined"==typeof i)return void console.warn("Undefined shim for: "+t);for(var r=t.split("."),a=null,n=window,s=0,o=r.length;s<o;s++)a=r[s],s==o-1?n[a]=i:n[a]||(n[a]={}),n=n[a]}require({cache:{"Mapping/modules/Editing/BinTool":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(){}return e.decodeArrayBuffer=function(e){var t=Math.ceil(3*e.length/4),i=new ArrayBuffer(t);return this.decode(e,i),i},e.decode=function(e,t){var i=this._keyStr.indexOf(e.charAt(e.length-1)),r=this._keyStr.indexOf(e.charAt(e.length-1)),a=Math.ceil(3*e.length/4);64==i&&a--,64==r&&a--;var n,s,o,l,d,u,p,c,h=0,g=0;for(n=t?new Uint8Array(t):new Uint8Array(a),e=e.replace(/[^A-Za-z0-9\+\/\=]/g,""),h=0;h<a;h+=3)d=this._keyStr.indexOf(e.charAt(g++)),u=this._keyStr.indexOf(e.charAt(g++)),p=this._keyStr.indexOf(e.charAt(g++)),c=this._keyStr.indexOf(e.charAt(g++)),s=d<<2|u>>4,o=(15&u)<<4|p>>2,l=(3&p)<<6|c,n[h]=s,64!=p&&(n[h+1]=o),64!=c&&(n[h+2]=l);return n},e}();i._keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",t.BinTool=i})},"Mapping/modules/Editing/CoreEditCommands":function(){define(["require","exports","geocortex/essentials/MapService","geocortex/essentials/RestHelperHTTPService","geocortex/framework/utils/utils","./BinTool"],function(e,t,i,r,a,n){"use strict";var s=function(){function e(e,t){this.app=e,this.libraryId=t}return e.prototype.registerCommands=function(){this.app.commandRegistry.command("CreateFeature").register(this,this._executeCreateFeature),this.app.commandRegistry.command("UpdateFeature").register(this,this._executeUpdateFeature),this.app.commandRegistry.command("DeleteFeature").register(this,this._executeDeleteFeature),this.app.commandRegistry.command("CreateRelatedRecord").register(this,this._executeCreateRelatedRecord),this.app.commandRegistry.command("UpdateRelatedRecord").register(this,this._executeUpdateRelatedRecord),this.app.commandRegistry.command("DeleteRelatedRecord").register(this,this._executeDeleteRelatedRecord),this.app.commandRegistry.command("CreateAttachment").register(this,this._executeCreateAttachment),this.app.commandRegistry.command("DeleteAttachments").register(this,this._executeDeleteAttachments)},e.prototype._executeCreateFeature=function(e){var t=this._getMapService(e.mapService);return t?void(e.feature&&this._applyFeatureLayerEdits({mapService:t,layer:e.layer,additions:[e.feature],updates:[],deletions:[],successCallback:e.successCallback,errorCallback:e.errorCallback})):void(e.errorCallback&&e.errorCallback(new Error(this.app.getResource(this.libraryId,"language-feature-editing-error-no-mapservice"))))},e.prototype._executeUpdateFeature=function(e){var t=this._getMapService(e.mapService);return t?void this._applyFeatureLayerEdits({mapService:t,layer:e.layer,additions:[],updates:[e.feature],deletions:[],successCallback:e.successCallback,errorCallback:e.errorCallback}):void(e.errorCallback&&e.errorCallback(new Error(this.app.getResource(this.libraryId,"language-feature-editing-error-no-mapservice"))))},e.prototype._getMapService=function(e){var t;return t="string"==typeof e?this.app.site.essentialsMap.findMapServiceById(e):e},e.prototype._executeDeleteFeature=function(e){var t=this._getMapService(e.mapService);return t?void(e.feature&&this._applyFeatureLayerEdits({mapService:t,layer:e.layer,additions:[],updates:[],deletions:[e.feature],successCallback:e.successCallback,errorCallback:e.errorCallback})):void(e.errorCallback&&e.errorCallback(new Error(this.app.getResource(this.libraryId,"language-feature-editing-error-no-mapservice"))))},e.prototype._executeCreateRelatedRecord=function(e){e.feature&&this._applyFeatureLayerEdits({mapService:null,layer:e.layer,additions:[e.feature],updates:[],deletions:[],successCallback:e.successCallback,errorCallback:e.errorCallback})},e.prototype._executeUpdateRelatedRecord=function(e){e.feature&&this._applyFeatureLayerEdits({mapService:null,layer:e.layer,additions:[],updates:[e.feature],deletions:[],successCallback:e.successCallback,errorCallback:e.errorCallback})},e.prototype._executeDeleteRelatedRecord=function(e){e.feature&&this._applyFeatureLayerEdits({mapService:null,layer:e.layer,additions:[],updates:[],deletions:[e.feature],successCallback:e.successCallback,errorCallback:e.errorCallback})},e.prototype._applyFeatureLayerEdits=function(e){if(e){var t=e.mapService,r=e.layer;if(t)r=t.serviceLayer;else{if(!r)return void this.app.trace.warning("Cannot apply edits: Missing map service and/or layer in edit descriptor.");t=new i.MapService(r.url),t.serviceLayer=r}var a=e.additions||[],n=e.updates||[],s=e.deletions||[],o=e.successCallback||function(){},l=e.errorCallback||function(){},d=r.applyEdits(a,n,s);d.then(function(e,t,i){var n=null;if(t&&t.length>0)for(var s=0;s<t.length;++s){var d=t[s];if(!d.success){n=d.error;break}}if(e&&e.length>0)for(var s=0;s<e.length;++s){var u=e[s];if(!u.success){n=u.error;break}u.GID&&r.globalIdField&&(a[s].attributes[r.globalIdField]=u.GID)}if(n){var p=n||{message:"Editing operation was not successful"};return void l(p.message)}o&&o()},function(e){l(e)})}},e.prototype._executeCreateAttachment=function(e){var t=this._getFeatureUrl(e.layer,e.feature);e.featureUrl=t,this._syncAttachmentToServer(e.featureUrl,e.filename,e.contentType,e.payload,e.callback)},e.prototype._executeDeleteAttachments=function(e){var t=(this._getFeatureUrl(e.layer,e.feature),e.feature.attributes[e.layer.objectIdField]);e.layer.deleteAttachments(t,e.attachmentIds,e.callback,e.errback)},e.prototype._getFeatureUrl=function(e,t){var i,r=t.attributes[e.objectIdField],a=e.url;return i=a.indexOf("?")>-1?a.replace("?","/{0}?".format(r)):"{0}/{1}".format(a,r)},e.prototype._syncAttachmentToServer=function(e,t,i,s,o){this.app.trace.debug("--- _syncAttachmentToServer called");try{for(var l=function(e){for(var t=new ArrayBuffer(e.length),i=new Uint8Array(t),r=0,a=e.length;r<a;r++)i[r]=e.charCodeAt(r)%255;return i},d=e.lastIndexOf("/"),u=e.substring(0,d),p=this.app.map.graphicsLayerIds,c=null,h=0;h<p.length;h++){var g=p[h],m=this.app.map.getLayer(g);if(m.url){var f=m.url.match(/^(.[^?]*)/);if(f&&f[0]===u){c=m;break}}}c||(c=new esri.layers.FeatureLayer(e.replace(/\/\d$/g,""))),e.indexOf("?")>-1?e=e.replace("?","/addattachment?"):e+="/addAttachment",this.app.isOffline.get()&&this.app.command("RewriteUrlForOffline").execute(e,function(t){e=t});var y=null;if(c.credential&&c.credential.token)y=c.credential.token;else{var v=c.url.match(/token=([^\?&$]*)/);v&&(y=v[1])}if(y&&e.indexOf(y)===-1&&(e=r.RestHelperHTTPService.appendTokenToUrl(e,y)),this.app.configuration.proxyUri){var b=a.makeUrlAbsolute(this.app.configuration.proxyUri);e=b+e}this.app.trace.debug("--- Creating XHR");var E=new XMLHttpRequest;E.open("POST",e,!0),E.setRequestHeader("Content-Type","multipart/form-data; boundary=---------------------------L4717uD3G30"),E.responseType="",E.onload=o,this.app.trace.debug("--- Creating request preamble");var F="-----------------------------L4717uD3G30\r\n"+'Content-Disposition: form-data; name="attachment"; filename="{0}";\r\n'.format(t)+"Content-Type: {0}".format(i)+"\r\n\r\n";this.app.trace.debug("--- Encoding request preamble");var w=l(F);this.app.trace.debug("--- Encoding request payload");var _=n.BinTool.decode(s);this.app.trace.debug("--- Creating request suffix");var S='\r\n-----------------------------L4717uD3G30\r\nContent-Disposition: form-data; name="gdbVersion"\r\n\r\n\r\n-----------------------------L4717uD3G30\r\nContent-Disposition: form-data; name="f"\r\n\r\njson\r\n-----------------------------L4717uD3G30--\r\n';this.app.trace.debug("--- Encoding request suffix");var T=l(S);this.app.trace.debug("--- Creating payload buffer");var x=new ArrayBuffer(w.length+_.length+T.length),C=new Uint8Array(x),G=0;for(this.app.trace.debug("--- Merging output buffers"),h=0;h<w.length;h++,G++)C[G]=255&w[h];for(h=0;h<_.length;h++,G++)C[G]=255&_[h];for(h=0;h<T.length;h++,G++)C[G]=255&T[h];this.app.trace.debug("--- Sending request"),E.send(C.buffer)}catch(M){this.app.trace.error("--- ERROR: {0}".format(M.toString())),o&&o(M)}},e}();t.CoreEditCommands=s})},"Mapping/modules/Editing/DisplayResultPickerFeature":function(){define(["require","exports","geocortex/infrastructure/Feature","geocortex/framework/observables"],function(e,t,i,r){"use strict";function a(e){return e.isSelected=new r.Observable((!1)),e.cssClass=new r.Observable(""),e.isFiltered=new r.Observable((!1)),e.showIcon=!0,e.showCheckbox=!0,e}var n=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t}(i.Feature);t.DisplayResultPickerFeature=n,t.generateDisplayResultPickerFeaturefromFeature=a})},"Mapping/modules/Editing/EditingModule":function(){define(["require","exports","geocortex/framework/application/ModuleBase","./CoreEditCommands","geocortex/essentials/GeometryUtilities","geocortex/infrastructure/MapUtils","geocortex/infrastructure/GeometryUtils","./Undoable/Add","./Undoable/Update","./Undoable/Delete","./Undoable/AddAndUpdate","./Undoable/DeleteAndUpdate","geocortex/infrastructure/GraphicsLayerIds","geocortex/infrastructure/GraphicsLayerUtils"],function(e,t,i,r,a,n,s,o,l,d,u,p,c,h){"use strict";var g;!function(e){e[e.Create=0]="Create",e[e.Update=1]="Update",e[e.Delete=2]="Delete",e[e.Cut=3]="Cut",e[e.Explode=4]="Explode",e[e.Union=5]="Union"}(g=t.EditGraphicType||(t.EditGraphicType={}));var m=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._hasGeometry=!1,t._editorDeactivatedHandle=null,t._isEditingGeometry=!1,t}return __extends(t,e),t.prototype.initialize=function(t){e.prototype.initialize.call(this,t),this._registerCommands(),this._registerEvents()},t.prototype._registerCommands=function(){this.app.command("SetEditorFeatureGeometry").register(this,this._executeSetEditorFeatureGeometry,this._canExecuteSetEditorFeatureGeometry),this.app.command("StartEditingGraphicGeometry").register(this,this._executeStartEditingGeometry,this._canExecuteStartEditingGeometry),this.app.command("StopEditingGraphicGeometry").register(this,this._executeStopEditingGeometry,this._canExecuteStopEditingGeometry);var e=new r.CoreEditCommands(this.app,this.libraryId);e.registerCommands(),this.app.command("StopFeaturePlacementState").register(this,this._executeStopFeaturePlacementState,this._canExecuteStopFeaturePlacementState),this.app.command("CreateGraphicsInMemory").register(this,this._executeCreateGraphicsInMemory),this.app.command("UpdateGraphicsInMemory").register(this,this._executeUpdateGraphicsInMemory),this.app.command("DeleteGraphicsInMemory").register(this,this._executeDeleteGraphicsInMemory),this.app.command("CutGraphicsInMemory").register(this,this._executeCutGraphicsInMemory),this.app.command("ExplodeGraphicsInMemory").register(this,this._executeExplodeGraphicsInMemory),this.app.command("UnionGraphicsInMemory").register(this,this._executeUnionGraphicsInMemory)},t.prototype._registerEvents=function(){var e=this,t=null;this.app.event("StartFeaturePlacementEvent").subscribe(this,function(){t=e.app.event("ViewDeactivatedEvent").subscribe(e,function(t){"TemplatePickerView"===t.id&&e.app.event("StopFeaturePlacementEvent").publish()})}),this.app.event("StopFeaturePlacementEvent").subscribe(this,function(){e.app.event("ViewDeactivatedEvent").unsubscribe(t),e.app.command("ClearActiveTool").execute();var i=e.app.viewManager.getViewById("TemplatePickerView");i&&i.isActive&&e.app.command("DeactivateView").execute("TemplatePickerView")}),this.app.event("LayerVisualizationChangedEvent").subscribe(this,this._handleLayerVisualizationChangedEvent)},t.prototype._executeStopFeaturePlacementState=function(){this.app.event("StopFeaturePlacementEvent").publish()},t.prototype._canExecuteStopFeaturePlacementState=function(){return!0},t.prototype._canExecuteSetEditorFeatureGeometry=function(e){return!0},t.prototype._executeSetEditorFeatureGeometry=function(e){this._executeStopEditingGeometry();var t=this._feature;t&&("extent"===e.type&&(e=a.envelopeToPolygon(e)),this._geometry=e,this._hasGeometry=!!e,this._graphic.setGeometry(e),this.app.event("GeometryEditCompletedEvent").publish({originalGraphic:this._feature,editedGraphic:this._graphic,cancelled:!1}),this._destroyEditingLayer(),this.app.event("FeatureGeometryEditedEvent").publish(t))},t.prototype._canExecuteStartAddingFeatureGeometry=function(e){return!0},t.prototype._executeStartAddingFeatureGeometry=function(e){},t.prototype._canExecuteStartEditingGeometry=function(e,t){return!0},t.prototype._executeStartEditingGeometry=function(e,t){var i=this;this._isEditingGeometry=!0,this._editObject&&this._editObject.deactivate(),this._feature=e,e.symbol||t.renderer||e.setSymbol(this._getMoveSymbol(e,t)),this._graphic=new esri.Graphic(e.geometry,e.symbol,e.attributes,e.infoTemplate),this._hasGeometry=!!this._graphic.geometry;var r=t?t:this._feature.getLayer();if(this._featureLayer=r,this._createEditingLayer(),this._hideOriginalFeature(),this._graphic.symbol=this._getMoveSymbol(e,r),this._editingLayer.add(this._graphic),this._layerUpdateEndToken&&dojo.disconnect(this._layerUpdateEndToken),this._layerUpdateEndToken=dojo.connect(this._graphic._graphicsLayer,"onUpdateEnd",dojo.hitch(this,this._handleLayerUpdateEnd)),this._hasGeometry){var a=null;if(null===e)throw new Error("Can't edit geometry of null feature");if(!esri.toolbars.Edit){var n=this.app.getResource(this.libraryId,"language-feature-editing-package-required"),s=this.app.getResource(this.libraryId,"language-feature-editing-error-title");return void this.app.command("Alert").execute(n,s)}a=this._getConfiguredEditMode();var o={allowAddVertices:!0,allowDeleteVertices:!0};this._editObject=this.app.accessibilityManager.createComponent("geocortex.accessibility.edit",this.app.map,o);var l=dojo.aspect.after(this._editObject,"onGraphicFirstMove",function(e){i.app.map.disableMapNavigation()},!0),d=dojo.aspect.after(this._editObject,"onGraphicMoveStop",function(e){i.app.map.enableMapNavigation()},!0),u=function(e,t,r){l&&(l.remove(),l=null),d&&(d.remove(),d=null),null!=i._editingGeometryMapClickHandle&&(dojo.disconnect(i._editingGeometryMapClickHandle),i._editingGeometryMapClickHandle=null),i._layerUpdateEndToken&&(dojo.disconnect(i._layerUpdateEndToken),i._layerUpdateEndToken=null),i._editorDeactivatedHandle&&(i._editorDeactivatedHandle.remove(),i._editorDeactivatedHandle=null),i._editObject&&(i._editObject=null),i._destroyEditingLayer(),i._indicateGeometryEditing(!1),i.app.event("GeometryEditCompletedEvent").publish({originalGraphic:i._feature,editedGraphic:i._graphic,cancelled:r.cancelled})};this._editorDeactivatedHandle&&(this._editorDeactivatedHandle.remove(),this._editorDeactivatedHandle=null),this._editorDeactivatedHandle=dojo.aspect.after(this._editObject,"onDeactivate",u,!0),this._editingGeometryMapClickHandle=dojo.connect(this.app.map,"onClick",function(){i._executeStopEditingGeometry(!1)}),this._indicateGeometryEditing(!0),this._editObject.activate(a,this._graphic,o),this.app.event("GeometryEditInvokedEvent").publish(this._feature)}else this._currentToolName=this._getToolNameByGeometryType(r.geometryType),this.app.command("SetActiveTool").execute(this._currentToolName),this._indicateGeometryEditing(!0)},t.prototype._createEditingLayer=function(){this._editingLayer=h.getInternalGraphicsLayer(c.EDITING_LAYER_ID,this.app,h.GraphicsLayerType.Markup)},t.prototype._destroyEditingLayer=function(){h.removeInternalGraphicsLayer(c.EDITING_LAYER_ID,this.app,h.GraphicsLayerType.Markup),this._editingLayer=null},t.prototype._handleLayerVisualizationChangedEvent=function(e){var t=this;if(this._feature&&this._graphic&&this._featureLayer&&this._editingLayer&&e&&e.mapService&&e.mapService.serviceLayer&&e.mapService.serviceLayer.id===this._featureLayer.id){if(this._featureLayer.renderer)this._graphic.setSymbol(this._featureLayer.renderer.getSymbol(this._feature));else{var i=this.app.map.graphicsLayerIds.filter(function(e){return e===t._featureLayer.id+"-cluster"});if(i.length>0){var r=this.app.map.getLayer(i[0]);r&&r.featureLayerRenderer&&this._graphic.setSymbol(r.featureLayerRenderer.getSymbol(this._feature))}}this._editingLayer.redraw(),this._editObject.refresh()}},t.prototype._handleLayerUpdateEnd=function(){this._hideOriginalFeature()},t.prototype._hideOriginalFeature=function(){if(this._feature){var e=n.findFeatureInMap(this._feature,this.app.site);e&&e.hide()}},t.prototype._getMoveSymbol=function(e,t){var i=null;if(t.renderer)var i=e.symbol?e.symbol:t.renderer.getSymbol(e);else{var r=this.app.map.graphicsLayerIds.filter(function(e){return e===t.id+"-cluster"});if(r.length>0){var a=this.app.map.getLayer(r[0]);i=a.featureLayerRenderer.getSymbol(e)}}var n=!1,s=function(e){return n||(i=new e(i.toJson()),n=!0),i};if(i instanceof esri.symbol.SimpleMarkerSymbol){var o=i;o.size<10&&s(esri.symbol.SimpleMarkerSymbol).setSize(10),o.color.a<.5&&(!o.outline||o.outline.color.a<.5)&&(s(esri.symbol.SimpleMarkerSymbol).color.a=.5)}return i},t.prototype._canExecuteStopEditingGeometry=function(){return!0},t.prototype._executeStopEditingGeometry=function(e){void 0===e&&(e=!1),this._isEditingGeometry&&(this.app.command("ClearActiveTool").execute(),this._editObject&&(this._editObject._cancelled=e,this._editObject.deactivate(),this._editObject=null),null!=this._editingGeometryMapClickHandle&&(dojo.disconnect(this._editingGeometryMapClickHandle),this._editingGeometryMapClickHandle=null),this._layerUpdateEndToken&&(dojo.disconnect(this._layerUpdateEndToken),this._layerUpdateEndToken=null),this._editorDeactivatedHandle&&(this._editorDeactivatedHandle.remove(),this._editorDeactivatedHandle=null),this._indicateGeometryEditing(!1))},t.prototype._indicateGeometryEditing=function(e){var t=this;if(this._feature&&this._feature.geometry){var i="geometryEditingStatus";if(e){var r=this._feature.geometry,a=r.type,n=s.getEsriGeometryType(a,esri.toolbars.Draw.POINT),o=this.getEditingGeometryStatusMessage(this.app,this.libraryId,n),l={id:i,text:o,closeButton:{callback:function(){t._executeStopEditingGeometry(!0)}}};this.app.command("DisplayNotification").execute(l),this.app.command("ShowMap").execute()}else this.app.command("RemoveNotification").execute(i)}},t.prototype.getEditingGeometryStatusMessage=function(e,t,i){var r=Modernizr&&!!Modernizr.touch;switch(i){case esri.toolbars.Draw.POINT:return e.getResource(t,"language-feature-editing-geometry-point");case esri.toolbars.Draw.POLYLINE:case esri.toolbars.Draw.FREEHAND_POLYLINE:var a=r?e.getResource(t,"language-feature-editing-geometry-polyline-touch"):e.getResource(t,"language-feature-editing-geometry-polyline");return a;case esri.toolbars.Draw.CIRCLE:case esri.toolbars.Draw.ELLIPSE:case esri.toolbars.Draw.POLYGON:case esri.toolbars.Draw.FREEHAND_POLYGON:var a=r?e.getResource(t,"language-feature-editing-geometry-polygon-touch"):e.getResource(t,"language-feature-editing-geometry-polygon");return a;case esri.toolbars.Draw.EXTENT:return e.getResource(t,"language-feature-editing-geometry-rectangle")}return e.getResource(t,"language-feature-editing-geometry-default")},t.prototype._getToolNameByDrawType=function(e){return e||(e="Polygon"),"Editing{0}Tool".format(e)},t.prototype._getToolNameByGeometryType=function(e){var t=e.slice("esriGeometry".length);return"Editing{0}Tool".format(t)},t.prototype._getConfiguredEditMode=function(){var e=this,t=0,i=this.app.site.essentialsMap.mapServices.filter(function(t){return t.id===e._featureLayer.id});if(0==i.length)t=esri.toolbars.Edit.MOVE|esri.toolbars.Edit.EDIT_VERTICES|esri.toolbars.Edit.SCALE|esri.toolbars.Edit.ROTATE;else{var r=i[0];r.rotateEnabled&&(t|=esri.toolbars.Edit.ROTATE),r.scaleEnabled&&(t|=esri.toolbars.Edit.SCALE),r.moveEnabled&&(t|=esri.toolbars.Edit.MOVE),r.editVerticesEnabled&&(t|=esri.toolbars.Edit.EDIT_VERTICES)}return t},t.prototype._executeCreateGraphicsInMemory=function(e){var t=this;this._validateEditInMemoryArgs(e,g.Create)&&(e.graphics.map(function(i){e.graphicsLayer.add(i),t.app.event("MarkupAddedEvent").publish(i)}),e.successCallback(e.graphics,[],[]).then(function(){var i=t.app.getResource(t.libraryId,"language-feature-editing-undoable-add"),r={app:t.app,addedGraphics:e.graphics,graphicsLayer:e.graphicsLayer};t.app.undoManager.add(new o.Add(i,r))}))},t.prototype._executeUpdateGraphicsInMemory=function(e){var t=this;if(this._validateEditInMemoryArgs(e,g.Update)){if(!e.geometries||e.geometries.length!==e.graphics.length)return void e.errorCallback(new Error("Could not update graphics: the graphic count does not match the updated geometry count."));for(var i=[],r=0;r<e.graphics.length;r++)i[r]=new esri.Graphic(e.graphics[r].toJson()),e.graphics[r].setGeometry(e.geometries[r]),this.app.event("MarkupUpdatedEvent").publish(e.graphics[r]);e.successCallback([],e.graphics,[]).then(function(){var r=t.app.getResource(t.libraryId,"language-feature-editing-undoable-update"),a={app:t.app,preUpdatedGraphics:i,updatedGraphics:e.graphics,graphicsLayer:e.graphicsLayer};t.app.undoManager.add(new l.Update(r,a))})}},t.prototype._executeDeleteGraphicsInMemory=function(e){var t=this;if(this._validateEditInMemoryArgs(e,g.Delete)){for(var i=[],r=0;r<e.graphics.length;r++)e.graphicsLayer.remove(e.graphics[r])&&(i.push(e.graphics[r]),this.app.event("MarkupDeletedEvent").publish(e.graphics[r]));0===i.length&&e.errorCallback(new Error("Could not delete graphics: the provided graphics are not on the graphics layer.")),e.successCallback([],[],i).then(function(){var r=t.app.getResource(t.libraryId,"language-feature-editing-undoable-delete"),a={app:t.app,deletedGraphics:i,graphicsLayer:e.graphicsLayer};t.app.undoManager.add(new d.Delete(r,a))})}},t.prototype._executeCutGraphicsInMemory=function(e){var t=this;if(this._validateEditInMemoryArgs(e,g.Cut)){if(!e.polyline)return void e.errorCallback(new Error("Could not cut graphics: required polyline was not supplied."));var i=e.graphics.map(function(e){return e.geometry});s.cutGeometries(i,e.polyline,this.app).then(function(i){for(var r=0;r<i.length;r++)if(i[r].length<2)return void e.errorCallback(new Error("Could not cut graphics: the provided polyline does not cut a graphic."));var a=e.graphics.map(function(e){return new esri.Graphic(e.toJson())}),n=e.graphics,s=t._splitGraphics(n,i);n.map(function(e){return t.app.event("MarkupUpdatedEvent").publish(e)}),s.map(function(i){e.graphicsLayer.add(i),t.app.event("MarkupAddedEvent").publish(i)}),e.successCallback(s,n,[]).then(function(){var i=t.app.getResource(t.libraryId,"language-feature-editing-undoable-cut"),r={app:t.app,addedGraphics:s,preUpdatedGraphics:a,updatedGraphics:n,graphicsLayer:e.graphicsLayer};t.app.undoManager.add(new u.AddAndUpdate(i,r))})},function(t){e.errorCallback(t)})}},t.prototype._executeExplodeGraphicsInMemory=function(e){var t=this;if(this._validateEditInMemoryArgs(e,g.Explode)){for(var i=e.graphics,r=[],a=0;a<i.length;a++)if(r[a]=s.explodeGeometry(i[a].geometry),!r[a])return void e.errorCallback(new Error("Could not explode graphics: invalid geometry."));var n=i.map(function(e){return new esri.Graphic(e.toJson())}),o=this._splitGraphics(i,r);i.map(function(e){return t.app.event("MarkupUpdatedEvent").publish(e)}),o.map(function(i){e.graphicsLayer.add(i),t.app.event("MarkupAddedEvent").publish(i)}),e.successCallback(o,i,[]).then(function(){var r=t.app.getResource(t.libraryId,"language-feature-editing-undoable-explode"),a={app:t.app,addedGraphics:o,preUpdatedGraphics:n,updatedGraphics:i,graphicsLayer:e.graphicsLayer};t.app.undoManager.add(new u.AddAndUpdate(r,a))})}},t.prototype._executeUnionGraphicsInMemory=function(e){var t=this;if(this._validateEditInMemoryArgs(e,g.Union)){var i=e.graphics[0],r=e.graphics.map(function(e){return e.geometry});s.unionGeometries(r).then(function(r){var a=new esri.Graphic(i.toJson());i.setGeometry(r),t.app.event("MarkupUpdatedEvent").publish(i);for(var n=e.graphics.slice(1),s=0;s<n.length;s++)e.graphicsLayer.remove(n[s]),t.app.event("MarkupDeletedEvent").publish(n[s]);e.successCallback([],[i],n).then(function(){var r=t.app.getResource(t.libraryId,"language-feature-editing-undoable-union"),s={app:t.app,deletedGraphics:n,preUpdatedGraphics:[a],updatedGraphics:[i],graphicsLayer:e.graphicsLayer};t.app.undoManager.add(new p.DeleteAndUpdate(r,s))})},function(t){e.errorCallback(t)})}},t.prototype._validateEditInMemoryArgs=function(e,t){if(e.successCallback=e.successCallback||function(){return Promise.resolve()},e.errorCallback=e.errorCallback||function(){},!(e.graphicsLayer&&e.graphicsLayer instanceof esri.layers.GraphicsLayer))return e.errorCallback(new Error("Could not edit graphics: required graphics layer was not supplied.")),!1;if(!e.graphics||0===e.graphics.length)return e.errorCallback(new Error("Could not edit graphics: required graphics were not supplied.")),!1;if(t===g.Cut||t===g.Explode||t===g.Union)for(var i=0;i<e.graphics.length;i++){var r=e.graphics[i];if(r.getLayer().id!==e.graphicsLayer.id)return e.errorCallback(new Error("Could not edit graphics: graphic is not on the supplied graphics layer.")),!1;if(t===g.Union){if(r.geometry.type!==e.graphics[0].geometry.type)return e.errorCallback(new Error("Could not edit graphics: graphics are not of the same type.")),!1;if(!r.geometry.spatialReference.equals(e.graphics[0].geometry.spatialReference))return e.errorCallback(new Error("Could not edit graphics: graphics are not of the same spatial reference.")),!1}}return!0},t.prototype._splitGraphics=function(e,t){for(var i=[],r=0;r<t.length;r++){var a=e[r];a.setGeometry(t[r][0]);for(var n=1;n<t[r].length;n++)i.push(new esri.Graphic(t[r][n],a.symbol,a.attributes,a.infoTemplate))}return i},t}(i.ModuleBase);t.EditingModule=m})},"Mapping/modules/Editing/FeatureUtilities":function(){define(["require","exports","geocortex/geocortex"],function(e,t,i){"use strict";var r=function(){function e(){}return e.getRelatedFeatures=function(e,t,r){var a=new dojo.Deferred;if(!e){var n=new Error("getRelatedFeatures: mapService cannot be null.");return i.deferredReject(a,n),a}if(isNaN(t)){var n=new Error("getRelatedFeatures: relationshipId cannot be null.");return i.deferredReject(a,n),a}if(!r){var n=new Error("getRelatedFeatures: objectId cannot be null.");return i.deferredReject(a,n),a}var s=new esri.tasks.RelationshipQuery;if(s.outFields=["*"],s.relationshipId=t,s.objectIds=[r],e&&e.serviceLayer&&e.serviceLayer.queryRelatedFeatures){var o=e.serviceLayer.queryRelatedFeatures(s);o.then(function(e){var t=[];for(var r in e)if(e.hasOwnProperty(r))for(var n=0;n<e[r].features.length;n++)t.push(e[r].features[n]);i.deferredResolve(a,t)},function(e){i.deferredReject(a,e)})}else i.deferredResolve(a,[]);return a},e}();t.FeatureUtilities=r})},"Mapping/modules/Editing/RelatedLayerEntry":function(){define(["require","exports"],function(e,t){"use strict"})},"Mapping/modules/Editing/Utils":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(){}return e.findFeatureInLayer=function(e,t){if(!e||!t)return null;var i=null,r=t.objectIdField;e.attributes[r]&&(i=e.attributes[r]);var a=t.graphics;if(a.length<1)return null;var n=["timestamp"];if(t.editFieldsInfo)for(var s in t.editFieldsInfo)t.editFieldsInfo.hasOwnProperty(s)&&n.push(t.editFieldsInfo[s]);var o=function(e){return Array.contains(n,e)},l=function(e){var t=0;for(var i in e)!o(i)&&e.hasOwnProperty(i)&&++t;return t},d=a[0].attributes;if(l(d)!==l(e.attributes))return null;var u=0,p=[],c=[];for(var h in d){var g=o(h);if(!(g||d.hasOwnProperty(h)&&e.attributes.hasOwnProperty(h)))return null;g||(p.push(h),c.push(h),++u)}for(var m=0;m<u;++m)if(p[m]!==c[m])return null;for(var f=0;f<a.length;f++){a[f]}return null},e}();t.EditingUtils=i})},"Mapping/modules/Editing/CreateOrEdit/CreateOrEditView":function(){define(["require","exports","geocortex/framework/ui/ViewBase"],function(e,t,i){"use strict";var r=function(e){function t(t,i){var r=e.call(this,t,i)||this;return r.app.command("HideCreateEditView").register(r,function(){r.isActive&&r.app.viewManager.deactivateView(r)}),r}return __extends(t,e),t.prototype.handleClickCreateNewFeature=function(e,t,i){this.viewModel.initiateCreateNewFeature()},t.prototype.handleClickSelectExistingFeature=function(e,t,i){this.viewModel.selectGeometry()},t}(i.ViewBase);t.CreateOrEditView=r})},"Mapping/modules/Editing/CreateOrEdit/CreateOrEditViewModel":function(){define(["require","exports","geocortex/framework/ui/ViewModelBase","geocortex/infrastructure/FeatureSetCollection","geocortex/framework/observables","geocortex/infrastructure/FeatureSet","geocortex/infrastructure/identify/MapIdentifyTask","geocortex/infrastructure/GeometryUtils"],function(e,t,i,r,a,n,s,o){"use strict";var l=function(){function e(e,t){this.featureServiceId=e.featureServiceId,this.where="{0} = '{1}'".format(e.scanResultFieldName,t.replace("'","''")),this.template={},this.template[e.scanResultFieldName]=t}return e}();t.CreateOrEditFeatureDescriptor=l;var d=function(e){function t(t,i){var r=e.call(this,t,i)||this;return r.geolocationEnabled=new a.Observable,r.searchRadius=new a.Observable(100),r}return __extends(t,e),t.prototype.initialize=function(e){e&&e.tools&&this.app&&this.app.toolRegistry&&this.app.toolRegistry.createTools(e.tools,!0),e&&e.searchRadiusMeters&&this.searchRadius.set(e.searchRadiusMeters),this.app.command("CreateOrEditFeatureFromBarcodeScan").register(this,this._executeCreateOrEditFeatureFromBarcodeScan),this.app.command("CreateOrEditFeature").register(this,this._executeCreateOrEditFeature),this.app.command("SelectFeatureForEditing").register(this,this._findExistingFeature),this.app.event("Internal.EditorFormSetupEvent").subscribe(this,this._fillTemplateDataInForm),this.geolocationEnabled.set(navigator&&void 0!==navigator.geolocation)},t.prototype._executeCreateOrEditFeatureFromBarcodeScan=function(e){var t=this;this.app.command("LaunchBarcodeScannerWithCallback").execute(function(i){if("Success"==i.status){var r=i.content;t.app.command("CreateOrEditFeature").execute([new l(e,r)])}})},t.prototype._executeCreateOrEditFeature=function(e){var t=this;this.resultsFSC=new r.FeatureSetCollection,this.inputFeatureDescriptors=e||[],this.currentFeatureServiceDescriptor=null;for(var i=0;i<this.inputFeatureDescriptors.length;i++){var a=this.inputFeatureDescriptors[i],n=this.app.site.essentialsMap.findMapServiceById(a.featureServiceId),s=new esri.tasks.Query;s.outFields=["*"],s.where=a.where,n.queryFeatures(s,function(e,i){return function(r){t._collectSearchResults(e,i,r)}}(n,a),function(e){t.app.trace.error("Error querying for feature data: {0}".format(e.toString()))})}},t.prototype._fillTemplateDataInForm=function(e,t){if(this.currentFeatureServiceDescriptor)for(var i=e.get(),r=0;r<i.fields.length();r++){var a=i.fields.getAt(r),n=this.currentFeatureServiceDescriptor.template;for(var s in n)n.hasOwnProperty(s)&&a.name.get()===s&&a.value.set(n[s])}},t.prototype._collectSearchResults=function(e,t,i){var r=this;this.currentFeatureLayer=e.layers[0];var a=new n.FeatureSet({esriFeatureSet:i,layer:this.currentFeatureLayer});if(this.resultsFSC.featureSets.addItem(a),this.resultsFSC.featureSets.length()==this.inputFeatureDescriptors.length)if(1==this.resultsFSC.countFeatures()){this.app.trace.debug("Found one feature, start editing it.");var s=this.resultsFSC.firstFeature();this._startEditingFeature(s)}else if(this.resultsFSC.countFeatures()>1)this.app.trace.debug("Multiple features found, select one to edit."),this.app.command("ShowSelectionListOfFeaturesWithCallback").execute(a,this._startEditingFeature);else{this.app.trace.debug("Creating a new feature."),this.currentFeatureServiceDescriptor=t,this.app.command("ActivateView").execute("CreateOrEditView");var o=this.app.event("ViewDeactivatedEvent").subscribe(this,function(e){"CreateOrEditView"===e.id&&(r.currentFeatureServiceDescriptor=null,r.app.event("ViewDeactivatedEvent").unsubscribe(o))})}},t.prototype.initiateCreateNewFeature=function(){this.app.command("ShowFeatureTemplatePicker").execute(this.currentFeatureLayer)},t.prototype.selectGeometry=function(){
var e=this.app.toolRegistry.tool("SelectFeaturesForEditingTool");e&&e.setActive(!0)},t.prototype._findExistingFeature=function(e,t){var i=this,r=new s.MapIdentifyTask(this.app.map,this.app);r.layerRestriction=function(e){return e===i.currentFeatureLayer};var a=!1,l=function(e,t,r){if(t&&t.length>0){a=!0;var s=new esri.tasks.FeatureSet;s.features=t.map(function(e){return e.feature});var o=new n.FeatureSet({esriFeatureSet:s,layer:r.layers[0]});i.app.command("ShowSelectionListOfFeaturesWithCallback").execute(o,i._startEditingFeature)}},d=dojo.hitch(this,function(e){a&&this._setSelectionToolActive(!1)}),u=function(e,t,r){i.app.trace.warning("Failed to find features: {0}".format(t.message))};if("point"===e.type){var p=new esri.SpatialReference({wkid:102100}),c=this.searchRadius.get();c=t&&t>c?t:c;var h=o.createCircle(p,e,c,60);r.execute(h,l,d,u)}else r.execute(e,l,d,u)},t.prototype._startEditingFeature=function(e){this.app.command("HideCreateEditView").execute(),this.app.command("HideMultiFeatureSelectorView").execute(),this.app.command("ZoomToFeature").execute(e),this.app.command("StartEditingFeature").execute(e,!1)},t.prototype._setSelectionToolActive=function(e){var t=this.app.toolRegistry.tool("SelectFeaturesForEditingTool");t&&(void 0!=e?t.setActive(e):t.setActive(!0))},t}(i.ViewModelBase);t.CreateOrEditViewModel=d})},"Mapping/modules/Editing/Editor/EditorView":function(){define(["require","exports","geocortex/framework/ui/ViewBase","./EditorViewModel","geocortex/infrastructure/Feature"],function(e,t,i,r,a){"use strict";var n=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.attach=function(t){var i=this;e.prototype.attach.call(this,t),this.isBusy.sync(t.isBusy),this.title.syncTransform(t.headerText,function(e){return String.unescapeHtml(e)}),this.app.event("ApplicationOfflineEvent").subscribe(this,this.cancelEditing),this.app.event("ApplicationOnlineEvent").subscribe(this,this.cancelEditing),this.app.event("FeatureDeletedEvent").subscribe(this,this._onFeatureDeletedEvent),this.app.event("RelatedRecordDeletedEvent").subscribe(this,this._onRelatedRecordDeletedEvent),this.app.event("GeometryEditCompletedEvent").subscribe(this,this._onGeometryEditCompletedEvent),this.app.command("ShowFeatureAttributeEditor").register(this,function(){i._activateView()}),this.app.command("HideFeatureAttributeEditor").register(this,function(){return i.isActive&&i._deactivateView(),!1})},t.prototype.deactivated=function(){e.prototype.deactivated.call(this),this.viewModel.cancelEditing()},t.prototype.handleTypeFieldChange=function(e,t,i){this.viewModel.handleTypeFieldSelected(i)},t.prototype.handleClickEditGeometry=function(e,t,i){return this.viewModel.handleClickEditGeometry()},t.prototype.handleClickDeleteFeature=function(e,t,i){return this.viewModel.state===r.EditorState.EditingGeometry&&this.viewModel.stopEditingGeometry(),this.viewModel.confirmDelete(),!1},t.prototype.handleClickSave=function(e,t,i){var a=this;return this.viewModel.state===r.EditorState.EditingGeometry&&this.viewModel.stopEditingGeometry(),this.isBusy.set(!0),this.viewModel.save(function(){return a.saveSuccessCallback()},function(e){return a.saveErrorCallback(e)}),!1},t.prototype.saveSuccessCallback=function(){this._deactivateView()},t.prototype.saveErrorCallback=function(e){},t.prototype.cancelEditing=function(){this.viewModel.cancelEditing(),this.isActive&&this._deactivateView()},t.prototype._activateView=function(){this.app.command("ActivateView").execute(this.id)},t.prototype._deactivateView=function(e){void 0===e&&(e=!0),this.app.command("DeactivateView").execute(this.id),this.app.event("_internalEvent.EditorViewDeactivated").publish(this.viewModel.currentFeatureEsriClone)},t.prototype._onFeatureDeletedEvent=function(e){this.viewModel&&this.viewModel.currentFeatureEsri&&this.viewModel.currentFeatureEsri===e&&(this._deactivateView(!1),this.viewModel.currentFeatureEsriClone.hide())},t.prototype._onRelatedRecordDeletedEvent=function(){this._deactivateView()},t.prototype._onGeometryEditCompletedEvent=function(e){var t=null;t=e.cancelled?new a.Feature({graphic:e.editedGraphic}):new a.Feature({graphic:e.originalGraphic}),this.app.behavior("EditorFeatureSelectedBehavior").run(t)},t.prototype.handleClickCancel=function(e,t,i){return this.cancelEditing(),!1},t.prototype.handleInputFocus=function(e,t,i){i.showActualValue()},t.prototype.handleInputBlur=function(e,t,i){i.showFormattedValue()},t}(i.ViewBase);t.EditorView=n})},"Mapping/modules/Editing/Editor/EditorViewModel":function(){define(["require","exports","geocortex/framework/ui/ViewModelBase","geocortex/framework/observables","./Form/EditingFormViewModel","geocortex/infrastructure/Feature","geocortex/essentials/GeometryUtilities","geocortex/infrastructure/TaskUtils","./../FeatureUtilities","geocortex/geocortex","geocortex/infrastructure/tools/MapTool","geocortex/infrastructure/FormatUtils","geocortex/infrastructure/NumberFormat","geocortex/infrastructure/MapUtils","geocortex/framework/utils/ArrayUtils","geocortex/infrastructure/TimeZoneUtils","geocortex/infrastructure/GraphicsLayerIds","geocortex/infrastructure/GraphicsLayerUtils","geocortex/infrastructure/HighlightManager"],function(e,t,i,r,a,n,s,o,l,d,u,p,c,h,g,m,f,y,v){"use strict";var b;!function(e){e[e.Idle=0]="Idle",e[e.Paused=1]="Paused",e[e.CantEdit=2]="CantEdit",e[e.EditingAttributes=3]="EditingAttributes",e[e.EditingGeometry=4]="EditingGeometry",e[e.Saving=5]="Saving"}(b=t.EditorState||(t.EditorState={}));var E=function(e){function t(t,i){var a=e.call(this,t,i)||this;return a.state=b.Idle,a.isBusy=new r.Observable((!1)),a.title=new r.Observable(""),a.headerText=new r.Observable(""),a.form=new r.Observable,a.isEditingGeometry=new r.Observable((!1)),a.isEditingNewFeature=new r.Observable((!1)),a.isEditingLogEntry=new r.Observable((!1)),a.isEditingRelatedFeature=new r.Observable((!1)),a.isEditingRelatedFeatureNotInSite=new r.Observable((!1)),a.currentFeatureRelationships=new r.ObservableCollection,a.hasRelatedLayers=new r.Observable((!1)),a.showRelatedLayers=new r.Observable((!1)),a.canDeleteFeature=new r.Observable((!0)),a.canEditGeometry=new r.Observable((!1)),a.showEditGeometryButton=new r.Observable((!1)),a.showStopEditingGeometryButton=new r.Observable((!1)),a.geometryHasBeenEdited=new r.Observable((!1)),a.validateGeometry=!1,a.configAllowsEditGeometry=!0,a.layerUpdateEndToken=null,a.textareaThreshold=80,a.canEditOffline=!1,a.doNotAdjustTime=!1,a._registerCommands(),a._subscribeToEvents(),a.isEditingNewFeature.bind(a,a._calculateCanDeleteFeature),a.auto(a.hasRelatedLayers,a,a._hideOrShowRelateds),a.auto(a.isEditingRelatedFeatureNotInSite,a,a._hideOrShowRelateds),a}return __extends(t,e),t.prototype.initialize=function(e){var t=this;e&&(e.tools&&this.app&&this.app.toolRegistry&&this.app.toolRegistry.createTools(e.tools,!0),this.validateGeometry=!!e.validateGeometry,this.configAllowsEditGeometry=void 0!==e.editGeometry?!!e.editGeometry:this.configAllowsEditGeometry,this.textareaThreshold=void 0!==e.textareaThreshold?parseInt(e.textareaThreshold):this.textareaThreshold,this.doNotAdjustTime=void 0!==e.doNotAdjustTime?!!e.doNotAdjustTime:this.doNotAdjustTime),this.app.nativeManager.hasNativeCapability("editing").then(function(e){t.canEditOffline=e})},t.prototype._registerCommands=function(){var e=this;this.app.command("StartEditingFeature").register(this,this._executeStartEditingFeature,this._canExecuteStartEditingFeature),this.app.command("StartEditingNewFeature").register(this,this._executeStartEditingNewFeature,this._canExecuteStartEditingNewFeature),this.app.command("StartEditingEditLogEntry").register(this,this._executeStartEditingEditLogEntry,this._canExecuteStartEditingEditLogEntry),this.app.command("StartEditingNewRelatedRecord").register(this,this._executeStartEditingRelatedRecord),this.app.command("StartEditingGraphicGeometry").postExecute.subscribe(this,this._onStartEditingGraphicGeometry),this.app.event("GeometryEditCompletedEvent").subscribe(this,this._onGeometryEditCompletedEvent),this.app.command("StartAddingFeatureGeometry").register(this,this._executeStartAddingFeatureGeometry,this._canExecuteStartEditingNewFeature),this.app.command("Internal.CancelEditingIfNotIdle").register(this,function(){e.state!==b.Idle&&e.cancelEditing()}),this.app.command("StartEditingAttributesAndGeometryFeature").register(this,this._executeStartEditingAttributesAndGeometryFeature,this._canExecuteStartEditingFeature)},t.prototype._executeStartAddingFeatureGeometry=function(e,t){this.app.command("StartEditingNewFeature").execute(e,t)},t.prototype._subscribeToEvents=function(){this.app.event("GeometryEditInvokedEvent").subscribe(this,this._handleGeometryEditInvokedEvent),this.app.event("GeometryEditCompletedEvent").subscribe(this,this._handleGeometryEditCompletedEvent),this.app.event("GeolocatedEvent").subscribe(this,this._handleGeolocation),this.app.event("LayerVisualizationChangedEvent").subscribe(this,this._handleLayerVisualizationChangedEvent)},t.prototype.performValidation=function(){var e=!0,t=this.form.get();return t.clearValidationMessages(),e=this.performFormValidation()&&e,this.validateGeometry&&(e=this.performGeometryValidation()&&e),e},t.prototype.performFormValidation=function(){for(var e=!0,t=this.form.get(),i=0;i<t.fields.getLength();++i){var r=t.fields.getAt(i);try{if(r.validationFunc){var a=r.validationFunc(r.value.get(),r,t);a&&(e=!1,t.addValidationMessage(a))}}catch(n){this.app.trace.warning("Error validating field {0}: {1}".format(r.displayName,n))}}return e},t.prototype.performGeometryValidation=function(){var e=!0,t=this.form.get(),i=this.currentFeatureEsriClone;return i.geometry&&"polygon"===i.geometry.type&&s.isSelfIntersectingPolygon(i.geometry)&&(t.addValidationMessage(this.app.getResource(this.libraryId,"language-feature-editing-self-intersecting-polygon-need-fixing")),e=!1),e},t.prototype.confirmDelete=function(){var e=this;this.app.command("Confirm").execute(this.app.getResource(this.libraryId,"language-feature-editing-delete-confirmation"),this.app.getResource(this.libraryId,"language-feature-editing-module-title"),function(t){if(t){var i=!1;e._preventDeleteForRelOrigin(e.currentFeatureRelationships,function(){e.app.command("Alert").execute(e.app.getResource(e.libraryId,"language-feature-editing-delete-with-relation-forbidden"),e.app.getResource(e.libraryId,"language-feature-editing-module-title")),i=!0},function(){i||(e.stopEditingGeometry(),e.deleteCurrentFeature())})}})},t.prototype.deleteCurrentFeature=function(e,t){var i=this,r=this.currentFeatureEsri,a=r.getLayer()||this._sourceLayer,n=this._getMapServiceByLayer(a);if(!n){var s,o=this._relatedFeature,l=this._editingRelationshipOrigin,d=this._editingRelationshipDestination,u=this.currentMapService;return s={mapService:u,layer:a,feature:r,relatedFeature:o,relationshipOrigin:l,relationshipDestination:d,successCallback:function(){i._deleteFeatureSuccessCallback(r,a,e)},errorCallback:function(e){i._deleteFeatureErrorCallback(e,a,t)}},this.isBusy.set(!0),this.app.command("DeleteRelatedRecord").execute(s),void this.app.event("RelatedRecordDeletedEvent").publish()}var p={mapService:n,layer:a,feature:r,successCallback:function(){i._deleteFeatureSuccessCallback(r,a,e)},errorCallback:function(e){i._deleteFeatureErrorCallback(e,a,t)}};this.isBusy.set(!0),this.app.command("DeleteFeature").execute(p)},t.prototype._deleteFeatureErrorCallback=function(e,t,i){var r=this.app.getResource(this.libraryId,"language-feature-editing-error-feature-edits").format(e),a=this.app.getResource(this.libraryId,"language-feature-editing-error-title");this.app.command("Alert").execute(r,a),this.app.trace.error(r),this.isBusy.set(!1)},t.prototype._deleteFeatureSuccessCallback=function(e,t,i){this._handleDeletedFeature(e),this.app.event("FeatureDeletedEvent").publish(e),t&&t.remove&&t.remove(e),this.app.command("ShowMap").execute(),this.currentFeatureEsriClone.hide(),this._destroyEditingLayer(),this._sourceLayer.refresh&&this._sourceLayer.refresh(),this.app.command("ShowFeatureParentDetails").execute(),i&&i(),this.isBusy.set(!1)},t.prototype._buildFeatureRelationships=function(){this.currentFeatureRelationships.clear();for(var e=this.currentFeatureEsri,t=this._sourceLayer,i=this.currentMapService,r=0;r<t.relationships.length;++r){var a=t.relationships[r];if(i){var n=i._getRelation(a.id);if(n&&!n.visible)continue}var s=!0;if(a.role){if("esriRelRoleOrigin"!==a.role)continue}else s=!1;var o=a.name;"undefined"!=typeof n&&(o=n.displayName);var l=this.app.getResource(this.libraryId,"language-feature-editing-create-related-feature").format(o),d={id:a.id,text:l,editable:s,relatedFeature:e,relationship:a};this.currentFeatureRelationships.addItem(d)}this.hasRelatedLayers.set(this.currentFeatureRelationships.getLength()>0)},t.prototype._preventDeleteForRelOrigin=function(e,t,i){var r=this,a=this.currentFeatureEsri,n=this._sourceLayer,s=null,d=!1;if(a&&n&&e&&e.length()>0&&(s=e.length(),n))for(var u=0;u<e.length();u++){var p=function(){s--,s<=0&&i&&i()},c=function(e){var i=parseInt(e.id),s=e.relatedTableId?e.relatedTableId.get():e.relationship.relatedTableId,u=n.url||n._essentialsMetadata.serviceUrl,c=r._getMapServiceByLayer(n),h=new esri.tasks.RelationshipQuery;h.objectIds=[a.attributes[n.objectIdField]],h.outFields=["*"],h.relationshipId=i;var g=(o.getQueryTask(n,c),l.FeatureUtilities.getRelatedFeatures(r._getMapServiceByLayer(n),i,h.objectIds[0]));g.then(function(e){var i=!1;for(var a in e)if(e.hasOwnProperty(a)){i=!0;break}return i?void r._getRelatedFeatureLayer(s,u,function(i){if(!d){var r=[];for(var a in e)if(e.hasOwnProperty(a)){var n=e[a].features||e[a];if(n)if(n.length)for(var s=0;s<n.length;s++){var o=n[s];r.push(o)}else r.push(n)}r.length>0&&t&&(t(r),d=!0),p()}},function(e){p()}):void p()},function(e){p()})},h=e.getAt(u);h.relationship&&"esriRelRoleOrigin"===h.relationship.role&&0==h.relationship.composite?c(h):h.relationship.composite&&p()}(!s||s<=0)&&i&&i()},t.prototype._getMapServiceByLayer=function(e){var t=e.url,i=t.indexOf("?token=");i!=-1&&(t=t.substring(0,i));for(var r=0;r<this.app.site.essentialsMap.mapServices.length;++r){var a=this.app.site.essentialsMap.mapServices[r];if(a.serviceUrl===t)return a}return null},t.prototype._getRelatedFeatureLayer=function(e,t,i,r){var a=new dojo.Deferred,n=function(e){d.deferredResolve(a,e),"function"==typeof i&&i(e)},s=function(e){d.deferredReject(a,e),"function"==typeof r&&r(e)},o=t.match(/token=.[^&]*/g),l=t.substring(0,t.lastIndexOf("/")+1)+e;o&&(l+="?"+o);var u=new esri.layers.FeatureLayer(l,{mode:esri.layers.FeatureLayer.MODE_SELECTION,outFields:["*"]});return dojo.connect(u,"onLoad",dojo.hitch(this,n)),dojo.connect(u,"onError",dojo.hitch(this,s)),a},t.prototype._getMapServiceForRelatedRecord=function(e){for(var t=(e.relatedFeature,this.app.site.getFeatureServices()),i=0;i<t.length;i++){for(var r=t[i],a=r.serviceLayer,n=0;n<a.relationships.length;n++){var s=a.relationships[n];if(s==e.relationship)return this._sourceLayer=a,void this._calculateCanDeleteFeature()}if(a.layerId==e.relationship.relatedTableId)for(var i=0;i<a.fields.length;i++){var o=a.fields[i];o.name==e.relationship.keyField&&(this._sourceLayer=a)}}this._sourceLayer||this.app.trace.warning("Could not find a proper source layer.");var l=this._getMapServiceByLayer(this._sourceLayer);return l||this.app.trace.warning("Could not edit related feature. No map service for layer '{0}' was found.".format(this._sourceLayer.url)),l},t.prototype._getRelatedKeyFieldForRelatedRecords=function(e,t){if(!e.relationship.keyField)return void this.app.trace.error(this.app.getResource(this.libraryId,"language-feature-editing-relationships-require-arcgis-version"));for(var i=null,r=0;r<t.relationships.length;++r){var a=t.relationships[r];if(a.id===e.relationship.id){this._editingRelationshipDestination=a,i=a.keyField;break}}return i?i:void this.app.trace.error(this.app.getResource(this.libraryId,"language-feature-editing-relationships-key-field-missing"))},t.prototype._setupViewForRelatedRecordCreationAndEditing=function(e,t,i){this._editingRelationshipOrigin=e.relationship,this.canEditGeometry.set(this.configAllowsEditGeometry&&!!t.geometryType),this.showEditGeometryButton.set(this.canEditGeometry.get()),this.showStopEditingGeometryButton.set(!1),this.currentFeatureEsri=i,this.currentFeatureEsriClone=this._cloneEsriFeature(this.currentFeatureEsri),this.originalFeatureClone=null,this.form.set(new a.EditingFormViewModel(this.app,this.libraryId,i,t,{textareaThreshold:this.textareaThreshold,doNotAdjustTime:this.doNotAdjustTime,timeZoneId:e.timeZoneId,displayTimeZoneId:e.displayTimeZoneId})),this.app.event("Internal.EditorFormSetupForRelatedFeatureEvent").publish(this.form,i)},t.prototype._renderRelatedRecordEditingTable=function(e,t,i){for(var r=!1,a=0;a<this.form.get().fields.getLength();++a){var n=this.form.get().fields.getAt(a);if(n.name.get()===t){if("objectid"!==t.toLowerCase()&&"globalid"!==t.toLowerCase()){e.feature?(n.value.set(e.feature.attributes[t]),e.relationship.keyField in i.attributes&&(i.attributes[e.relationship.keyField]=e.feature.attributes[e.relationship.keyField]||e.feature.attributes[t])):e.relatedFeature&&(n.value.set(e.relatedFeature.attributes[e.relationship.keyField]),e.relationship.keyField in i.attributes&&(i.attributes[e.relationship.keyField]=e.relatedFeature.attributes[e.relationship.keyField]||e.relatedFeature.attributes[t]));continue}n.editable.set(!1)}}this.isEditingNewFeature.get()===!0&&(t in i.attributes&&(i.attributes[t]=e.relatedFeature.attributes[e.relationship.keyField]||e.relatedFeature.attributes[t],r=!0),0!==this.form.get().fields.getLength()&&0!=r||(i.attributes[t]=e.relatedFeature.attributes[e.relationship.keyField]||e.relatedFeature.attributes[t]))},t.prototype._executeStartEditingRelatedRecord=function(e,t){var i=this;this.isEditingNewFeature.set(t),this.isEditingRelatedFeature.set(!0),this._relatedFeature=e.relatedFeature;var r=null,a=this.app.map.getLayersVisibleAtScale();if(a.forEach(function(t){var i=t;i.layerId&&i.layerId==e.relationship.relatedTableId&&i.fields[e.relationship.keyField]&&(r=i)}),r){this.isEditingRelatedFeatureNotInSite.set(!1);var n=this._getMapServiceByLayer(r);this.currentMapService=n,this._refreshRelatedRecord(e,r)}else{if(this.isEditingRelatedFeatureNotInSite.set(!0),e.essentialsRelatedFeature){if(e.essentialsRelatedFeature.layer.getRelatedFeatureLayer)return void e.essentialsRelatedFeature.layer.getRelatedFeatureLayer(e.relationship.id,function(t){i._refreshRelatedRecord(e,t)},function(e){i.app.trace.error("Error in getting related feature layer: "+e)});var s=this._getMapServiceForRelatedRecord(e);return this.currentMapService=s,void this._refreshRelatedRecord(e,s.serviceLayer)}r=this.currentFeatureGeocortex.featureLayer,this.currentMapService=null,this._refreshRelatedRecord(e,r)}},t.prototype._refreshRelatedRecord=function(e,t){var i=this;e.feature?this._refreshEsriGraphic(e.feature,t).then(function(r){null!=r&&r.features&&r.features.length>0?e.feature=r.features[0]:i.app.trace.info("Error retrieving most recent version of related record. Falling back to currently loaded version."),i._displayEditorForRelatedFeatures(e,t)}).caught(function(r){i.app.trace.info("Error retrieving most recent version of related record. Falling back to currently loaded version."),i._displayEditorForRelatedFeatures(e,t)}):this._displayEditorForRelatedFeatures(e,t)},t.prototype._displayEditorForRelatedFeatures=function(e,t){e.text?this.headerText.set(e.text):this.headerText.set(this.app.getResource(this.libraryId,"language-feature-editing-new-related-feature-default")),this.state!==b.Idle&&this.cancelEditing(),this._sourceLayer=t,this._calculateCanDeleteFeature();var i={};t.fields.forEach(function(e){var t=e.name;i[t]=null});var r=null;this.isEditingNewFeature.get()?(r=this._createNewEsriFeature(null,i,null,null),r.setGeometry(null)):r=e.feature,this._setupViewForRelatedRecordCreationAndEditing(e,t,r);var a=this._getRelatedKeyFieldForRelatedRecords(e,t);if(this._renderRelatedRecordEditingTable(e,a,r),this.isEditingNewFeature.get()&&"Table"!=this._sourceLayer.type){for(var n=this.app.site.getFeatureServices(),s=void 0,o=0;o<n.length;o++)for(var l=n[o],d=0;d<l.layers.length;d++){var u=l.layers[d];if(u.id==e.relationship.relatedTableId.toString()&&u.name==e.relationship.name){s=u;break}}this.app.command("ShowFeatureTemplatePicker").execute(s,r)}else this._activateEditingView()},t.prototype.startEditingGeometry=function(){if(!this.currentFeatureEsri)throw new Error("Could not edit geometry - no feature selected.");this.app.command("StartEditingGraphicGeometry").execute(this.currentFeatureEsriClone,this._sourceLayer)},t.prototype.stopEditingGeometry=function(e){void 0===e&&(e=!1),this.app.command("StopEditingGraphicGeometry").execute(e)},t.prototype._onStartEditingGraphicGeometry=function(e,t){this.state==b.Idle||!e||e!==this.currentFeatureEsri&&e!==this.currentFeatureEsriClone||this.currentFeatureEsriClone.hide();var i=this.app.toolRegistry.getActiveTool();i instanceof u.MapTool&&"EditingPointTool"===i.name&&(this.app.event("GeometryEditPointActivatedEvent").publish(),this.app.command("OpenToolbar").execute())},t.prototype._onGeometryEditCompletedEvent=function(e){if(this.state!=b.Idle&&this.currentFeatureEsriClone&&(this.currentFeatureEsri===e.originalGraphic||this.currentFeatureEsriClone===e.originalGraphic)){e.cancelled||this.currentFeatureEsri!==e.originalGraphic||this.currentFeatureEsriClone.setGeometry(e.editedGraphic.geometry),this.app.command("HideFeatureTemplatePicker").execute(),this.app.command("HideCreateEditView").execute(),this.app.command("ShowFeatureAttributeEditor").execute(),this.currentFeatureEsriClone.show();var t=new n.Feature({graphic:this.currentFeatureEsriClone});this.app.behavior("EditorFeatureSelectedBehavior").run(t)}},t.prototype._handleGeolocation=function(e){var t=this,i=function(){t.currentFeatureEsriClone.setGeometry(e.projectedMapPoint),t.app.event("GeometryEditCompletedEvent").publish({editedGraphic:t.currentFeatureEsriClone,originalGraphic:t.currentFeatureEsri,cancelled:!1}),setTimeout(function(){return t.app.command("GeolocateStop").execute()},0),t.app.command("StopEditingGraphicGeometry").execute();var i=new n.Feature({graphic:t.currentFeatureEsriClone});t.app.behavior("EditorFeatureSelectedBehavior").run(i)},r=this.app.toolRegistry.getActiveTool(),a=this.isEditingNewFeature.get()&&"esriGeometryPoint"===this._sourceLayer.geometryType&&r&&"EditingPointTool"===r.name,s=e&&"single"===e.typeOfGeolocation&&e.location;a&&s&&(e.location.coords.accuracy<=e.accuracyThreshold?i():this.app.command("Confirm").execute(this.app.getResource(this.libraryId,"language-feature-editing-confirm-low-accuracy-geolocation").format(p.formatNumber(e.location.coords.accuracy,c.NumberFormat.DEFAULT,{fractionalDigits:0}),this.getResource("language-common-ok")||"'OK'",this.getResource("language-common-cancel")||"'Cancel'"),this.app.getResource(this.libraryId,"language-feature-editing-confirm-low-accuracy-geolocation-title"),function(e){e?i():setTimeout(function(){return t.app.command("GeolocateStop").execute()},0)}))},t.prototype._createEditingLayer=function(){return this._destroyEditingLayer(),this._editingLayer=y.getInternalGraphicsLayer(f.EDITOR_CLONE_LAYER_ID,this.app,y.GraphicsLayerType.Markup,!1),this._sourceLayer&&this._editingLayer.setRenderer(this._sourceLayer.renderer),this._editingLayer},t.prototype._destroyEditingLayer=function(){this.currentFeatureEsriClone&&(this.currentFeatureEsriClone.hide(),this._editingLayer&&this._editingLayer.remove(this.currentFeatureEsriClone)),this._editingLayer&&(this._editingLayer.clear(),y.removeInternalGraphicsLayer(f.EDITOR_CLONE_LAYER_ID,this.app,y.GraphicsLayerType.Markup),this._editingLayer=null)},t.prototype._createNewEsriFeature=function(e,t,i,r){var a=new esri.Graphic(null);return a.attributes=t||{},a.geometry=e||new esri.geometry.Point(NaN,NaN),a.symbol=i||null,a.infoTemplate=r||null,a},t.prototype._handleLayerVisualizationChangedEvent=function(e){if(e.mapService&&e.mapService.serviceLayer&&this._sourceLayer&&e.mapService.serviceLayer.id===this._sourceLayer.id&&e.mapService.serviceLayer.renderer){var t=e.mapService.serviceLayer.renderer;this.currentFeatureEsriClone&&this.currentFeatureEsriClone.setSymbol(t.getSymbol(this.currentFeatureEsri)),this._editingLayer&&this._editingLayer.setRenderer(t)}},t.prototype.save=function(e,t){var i=this;this.stopEditingGeometry();var r=this.performValidation();if(this.isBusy.set(!1),r){this.state=b.Saving,this.isBusy.set(!0);var a;a=this.currentFeatureEsri?this._cloneEsriFeature(this.currentFeatureEsri):new esri.Graphic(null);for(var n in a.attributes)a.attributes.hasOwnProperty(n)&&(n||delete a.attributes[n]);var s=this.currentFeatureEsri,o=this._sourceLayer;try{var l,d=this.form.get().getAttributeValues(),u=null;if(this.isEditingNewFeature.get()){u=d;for(l in s.attributes)s.attributes.hasOwnProperty(l)&&(u.hasOwnProperty(l)||null==s.attributes[l]||(u[l]=s.attributes[l]))}else{u={};for(l in d)d.hasOwnProperty(l)&&s.attributes[l]!==d[l]&&(u[l]=d[l]);var p=o.objectIdField,c=o.globalIdField;s.attributes.hasOwnProperty(p)&&(u[p]=s.attributes[p]),s.attributes.hasOwnProperty(c)&&(u[c]=s.attributes[c])}var h=!0;if(o.relationships)for(var g=(o.relationships,[]),m=[],f=0;f<o.relationships.length;f++){var y=o.relationships[f];if(g[f]={key:y.keyField,value:d[y.keyField]},"esriRelCardinalityOneToOne"===y.cardinality||"esriRelCardinalityOneToMany"===y.cardinality&&"esriRelRoleOrigin"===y.role){var v=null,E=new esri.tasks.Query;if(!d.hasOwnProperty(y.keyField)||null===d[y.keyField])continue;E.where=y.keyField+" = '"+d[y.keyField]+"'",v=Promise.resolve(o.queryFeatures(E,function(e){e.features&&(i.isEditingNewFeature.get()&&e.features.length>=1?h=!1:!i.isEditingNewFeature.get()&&e.features.length>1&&(h=!1))},function(e){i.app.trace.warning("Unable to query layer for cardinality check: "+e)}))}m.push(v)}Promise.all(m).then(function(e){if(h===!1){for(var t="",r="",a=0;a<g.length;a++){var n=g[a];$.each(e,function(i){var a=e[i];a.features&&a.features.length>0&&a.features[0].attributes[n.key]===n.value&&(t=n.key,r=n.value)})}return i.app.command("Alert").execute(i.app.getResource(i.libraryId,"language-feature-editing-cardinality-violation").format(r,t),i.app.getResource(i.libraryId,"language-feature-editing-error-dialogue")),i.state=b.Idle,void i.isBusy.set(!1)}}).lastly(function(){if(h!==!1){var r=new esri.Graphic(i.currentFeatureEsriClone.toJson());r.attributes=u,!i.geometryHasBeenEdited.get();var a=null;if(!i.isEditingRelatedFeatureNotInSite.get()&&(a=i._getMapServiceByLayer(o),!a))throw new Error("Could not find map service for feature layer while saving.");i.isBusy.set(!0);var n={mapService:a,layer:o,feature:r,successCallback:function(){i.isBusy.set(!1),i._handleSaveSuccess(r,o,e,t)},errorCallback:function(e){i.isBusy.set(!1),i._handleSaveError(e,t)}};try{i.app.event("Internal.EditorFormPreSaveEvent").publish(i.form,n)}catch(s){return}if(i.isEditingRelatedFeature.get()){var l=n;l.relatedFeature=i._relatedFeature,l.relationshipOrigin=i._editingRelationshipOrigin,l.relationshipDestination=i._editingRelationshipDestination,i.isEditingNewFeature.get()?(l.successCallback=function(t){i.app.event("RelatedRecordCreatedEvent").publish(r),i.isBusy.set(!1),e()},i.app.command("CreateRelatedRecord").execute(l)):(l.successCallback=function(t){i.app.event("RelatedRecordEditedEvent").publish(r),i.isBusy.set(!1),e()},i.app.command("UpdateRelatedRecord").execute(l))}else i.isEditingNewFeature.get()?(i.app.event("EditorPreCreateFeatureEvent").publish(r),i.app.command("CreateFeature").execute(n)):(i.app.event("EditorPreUpdateFeatureEvent").publish(r),i.app.command("UpdateFeature").execute(n));i.state=b.Saving}})}catch(F){this.state=b.Idle,this.isBusy.set(!1),this.app.trace.error("Error applying edits: {0}".format(F))}}},t.prototype._handleSaveError=function(e,t){this.isBusy.set(!1),this.state=b.Idle;var i=this.app.getResource(this.libraryId,"language-feature-editing-error-feature-edits").format(e),r=this.app.getResource(this.libraryId,"language-feature-editing-error-title");this.app.command("Alert").execute(i,r),this.app.trace.error(i),t&&t(e)},t.prototype._handleSaveSuccess=function(e,t,i,r){this.currentFeatureEsri;this.layerUpdateEndToken&&(dojo.disconnect(this.layerUpdateEndToken),this.layerUpdateEndToken=null);var a=h.findFeatureInMap(this.currentFeatureEsri,this.app.site,this._sourceLayer);if(a){var s=e.attributes;e.attributes=null,a.attributes={},dojo.mixin(a.attributes,this.originalFeatureClone.attributes),dojo.mixin(a.attributes,s),a.show()}if(this._destroyEditingLayer(),this.originalFeatureClone&&a){var o={originalFeature:this.originalFeatureClone,editedFeature:a};this._handleEditedFeature(o),this.app.event("FeatureEditedEvent").publish(o)}else this.originalFeatureClone&&this.isEditingNewFeature.get()&&this.app.event("FeatureCreatedEvent").publish(e);if(this.isEditingNewFeature.set(!1),this.state=b.Idle,t&&t.refresh(),this.isEditingRelatedFeatureNotInSite.get()){var l=this.findGeocortexLayerForUrl(t.url),d=new n.Feature({graphic:e,layer:l});this.headerText.set(d.plainLabel.get())}this.cancelEditing(),i&&i()},t.prototype._cloneEsriFeature=function(e){var t=new esri.Graphic(e.toJson());return t},t.prototype._handleGeometryEditInvokedEvent=function(e){this.isEditingGeometry.set(!0),this.showEditGeometryButton.set(!1),this.showStopEditingGeometryButton.set(this.canEditGeometry.get()),this.geometryHasBeenEdited.set(!0)},t.prototype._handleGeometryEditCompletedEvent=function(e){this.isEditingGeometry.set(!1),this.showEditGeometryButton.set(this.canEditGeometry.get()),this.showStopEditingGeometryButton.set(!1),this.currentFeatureEsriClone&&this.currentFeatureEsriClone===e.originalGraphic&&(this.currentFeatureEsriClone.setGeometry(e.editedGraphic.geometry),this.currentFeatureEsriClone.show(),this._swapOriginalFeatureForClone()),this.isEditingNewFeature.get()&&this.isEditingRelatedFeature.get()&&this._activateEditingView()},t.prototype._handleLayerUpdateEnd=function(){this._swapOriginalFeatureForClone()},t.prototype._handleDeletedFeature=function(e){var t=e instanceof esri.Graphic?e:e.originalFeature;return t&&t instanceof esri.Graphic?void this.app.featureSetManager.updateCollectionsOnFeatureDeletion(t):void this.app.trace.warning("EditorViewModel: Could not update feature set collections on feature deletion. Original feature not provided.")},t.prototype._handleEditedFeature=function(e){if(!e.originalFeature||!e.editedFeature)return void this.app.trace.warning("EditorViewModel: Could not update feature set collections on feature edit. Original or edited feature not provided.");var t=this.app.featureSetManager.findFeaturesByEsriFeature(e.editedFeature||e.originalFeature);e.editedFeature&&e.originalFeature&&e.editedFeature!==e.originalFeature&&t.concat(this.app.featureSetManager.findFeaturesByEsriFeature(e.originalFeature)),t=g.distinct(t),t&&t.length&&t.forEach(function(t){return t.esriFeature.set(e.editedFeature)})},t.prototype._swapOriginalFeatureForClone=function(){if(this.currentFeatureEsri){var e=h.findFeatureInMap(this.currentFeatureEsri,this.app.site,this._sourceLayer);e&&(e.hide(),!this.isEditingGeometry.get()&&this.currentFeatureEsriClone.getLayer()&&this.currentFeatureEsriClone.show())}},t.prototype._restoreOriginalFeature=function(){if(this.currentFeatureEsri){var e=null;e=this.currentFeatureGeocortex&&this.currentFeatureGeocortex.featureLayer&&"Table"==this.currentFeatureGeocortex.featureLayer.type?h.findFeatureInLayer(this.currentFeatureEsri,this._sourceLayer):h.findFeatureInMap(this.currentFeatureEsri,this.app.site,this._sourceLayer),e&&e.show()}},t.prototype.cancelEditing=function(){this.stopEditingGeometry(!0),this.geometryHasBeenEdited.set(!1),this._restoreOriginalFeature(),this._destroyEditingLayer(),this.form.get()&&this.form.get().clear(),this._sourceLayer&&this._sourceLayer.refresh(),this.isEditingGeometry.set(!1),this.isEditingLogEntry.set(!1),
this.isEditingNewFeature.set(!1),this.isEditingRelatedFeature.set(!1),this.isEditingRelatedFeatureNotInSite.set(!1),this.layerUpdateEndToken&&dojo.disconnect(this.layerUpdateEndToken),this.app.behavior("EditorRemoveFeatureSelectedBehavior").run(),this.app.event("EditorClosedEvent").publish(),this.state=b.Idle},t.prototype._canExecuteStartEditingFeature=function(e){if(!e)return!1;if(this.app.offlineManager.isOfflineMapActive.get()&&!this.canEditOffline)return!1;if(e.layer){var t=e.layer;if(t.mapService&&t.mapService.serviceLayer){if(!t.mapService.serviceLayer.isEditable)return!1;if(!t.mapService.serviceLayer.isEditable())return!1;if(this.app.offlineManager.isOfflineMapActive.get()){var i=this.app.offlineManager.syncInfo.findLayerOrTable(e.layer.mapService.serviceLayer.url);if(!i.canEdit)return!1}}var r=e.esriFeature.get();if(r)return!!r.getLayer()||(t.mapService&&t.mapService.serviceLayer&&(r._graphicsLayer=r._layer=t.mapService.serviceLayer),!!h.findFeatureInMap(r,this.app.site))}else if(e.featureLayer){if(this.app.offlineManager.isOfflineMapActive.get()){var i=this.app.offlineManager.syncInfo.findLayerOrTable(e.featureLayer.url);return i.canEdit}return e.featureLayer.isEditable()}return!1},t.prototype.handleClickEditGeometry=function(){if(this.isEditingGeometry.get()){this.stopEditingGeometry();var e=new n.Feature({graphic:this.currentFeatureEsriClone});this.app.behavior("EditorFeatureSelectedBehavior").run(e)}else this.startEditingGeometry(),this.app.behavior("EditorRemoveFeatureSelectedBehavior").run();return!1},t.prototype._executeStartEditingAttributesAndGeometryFeature=function(e,t){var i=this;void 0===t&&(t=!1),this._executeStartEditingFeature(e,t).then(function(e){i.canEditGeometry.get()&&i.handleClickEditGeometry()})},t.prototype._executeStartEditingFeature=function(e,t){var i=this;return void 0===t&&(t=!1),new Promise(function(r,a){var s=!0;i.isEditingNewFeature.set(t),i.geometryHasBeenEdited.set(!1);var o;try{if(e&&e instanceof n.Feature){var l=e;l.layer&&l.layer.mapService&&(i.currentMapService=l.layer.mapService),l.featureLayer&&"Table"==l.featureLayer.type&&(s=!1),i.currentFeatureGeocortex=e,i.headerText.set(l.plainLabel.get()),o=l.esriFeature.get()}else o=e;i.app.map&&i.app.site&&i.app.site.isInitialized?i.isEditingNewFeature.get()?(i._executeStartEditingFeatureImpl(o,t,s),r()):i._refreshEsriGraphic(o).then(function(e){null!=e&&e.features&&e.features.length>0&&e.features[0].attributes?(o.attributes={},dojo.mixin(o.attributes,e.features[0].attributes)):i.app.trace.info("Error retrieving most recent version of related record. Falling back to currently loaded version."),i._executeStartEditingFeatureImpl(o,t,s),r()}).caught(function(e){i.app.trace.info("Error retrieving most recent version of feature for editing. Falling back to currently loaded version."),i._executeStartEditingFeatureImpl(o,t,s),a(e)}):i.app.event("SiteInitializedEvent").once(i,function(){i._executeStartEditingFeatureImpl(o,t,s),r()})}catch(d){i.app.trace.error("Could not start editing: {0}".format(d)),i.cancelEditing(),a(d)}})},t.prototype._refreshEsriGraphic=function(e,t){var i=this,r=null;t||(t=e.getLayer()),r=this._getMapServiceByLayer(t);var a=e[v.HIGHLIGHT_ID_PROPERTY],n=t.objectIdField;if(!n&&r.serviceLayer instanceof esri.layers.FeatureLayer){var s=r.serviceLayer;n=s.objectIdField}var l=new esri.tasks.Query;l.objectIds=[e.attributes[n]],l.returnGeometry=!0,l.outFields=["*"];var d=o.getQueryTask(t,r);return new Promise(function(e,r){d.execute(l,function(r){r&&r.features&&r.features.length&&(r.features[0]._layer=t,i.app.highlightManager.updateHighlightId(r.features[0],a)),e(r)},r)})},t.prototype._executeStartEditingFeatureImpl=function(e,t,i){void 0===t&&(t=!1),this.state!==b.Idle&&(this.cancelEditing(),this.isEditingNewFeature.set(t));var r=null;if(!i)return void this._editAsTable(e);var n=t?e:h.findFeatureInMap(e,this.app.site);if(this.originalFeatureClone=this._cloneEsriFeature(n),r=t?this._sourceLayer:n.getLayer(),!r)return void this.app.trace.error("Error - could not find layer for feature.");if(r instanceof esri.layers.GraphicsLayer&&!(r instanceof esri.layers.FeatureLayer)){var s=r;if(s.id){var o=s.id.replace("-explodedClusterLayer",""),l=this.app.map.getLayer(o);l instanceof esri.layers.FeatureLayer&&(r=l)}s.renderer&&e.setSymbol(s.renderer.getSymbol(e))}t&&(r.objectIdField&&(e.attributes[r.objectIdField]=0),r.globalIdField&&(e.attributes[r.globalIdField]="")),this._sourceLayer=r,this._calculateCanDeleteFeature(),this.layerUpdateEndToken=dojo.connect(r,"onUpdateEnd",dojo.hitch(this,this._handleLayerUpdateEnd)),this.state=b.EditingAttributes,this.isEditingRelatedFeatureNotInSite.set(!1),this.canEditGeometry.set(this.configAllowsEditGeometry&&!!r.geometryType&&r.allowGeometryUpdates),this.showStopEditingGeometryButton.set(!1),this.showEditGeometryButton.set(this.canEditGeometry.get()),this.currentFeatureEsri=n,this.currentFeatureEsriClone=this._cloneEsriFeature(n),n.hasOwnProperty("_drawType")&&(this.currentFeatureEsriClone._drawType=n._drawType),this._createEditingLayer(),this._editingLayer.add(this.currentFeatureEsriClone);var d={textareaThreshold:this.textareaThreshold,doNotAdjustTime:this.doNotAdjustTime};if(this.currentFeatureGeocortex&&this.currentFeatureGeocortex.layer){var u=[];this.currentFeatureGeocortex.layer.fields.forEach(function(e){u.push(e.name)}),d.fieldOrder=u}if(this.form.set(new a.EditingFormViewModel(this.app,this.libraryId,e,r,d)),this.app.event("Internal.EditorFormSetupEvent").publish(this.form,n),null!=this._sourceLayer.typeIdField)for(var p=this.form.get(),c=0;c<p.fields.getLength();c++){var g=p.fields.getAt(c);if(g.name.get()===this._sourceLayer.typeIdField){this.handleTypeFieldSelected(g);break}}try{this._buildFeatureRelationships()}catch(m){this.app.trace.warning("Could not set up related records for editing.")}this.isBusy.set(!1),t||this._activateEditingView()},t.prototype._canExecuteStartEditingNewFeature=function(e){return!(this.app.offlineManager.isOfflineMapActive.get()&&!this.canEditOffline)},t.prototype._editAsTable=function(e){for(var t=this,i=this.app.site.getFeatureServices(),r=null,a=null,n=0;n<i.length;n++){var s=i[n],o=s.serviceLayer;o.relationships.forEach(function(i){var n=t.currentFeatureGeocortex.featureLayer;if(i.relatedTableId==n.layerId){a=n,r=i;var o=null,l=null,d=t.app.site&&t.app.site.essentialsMap?t.app.site.essentialsMap.findLayerFromMatchingEsriFeatureLayer(a):null;d?(o=m.getTimeZoneFromLayer(d),l=m.getDisplayTimeZoneFromMapService(d.mapService)):(o=m.getTimeZoneFromMapService(s),l=m.getDisplayTimeZoneFromMapService(s));var u={id:a.layerId,text:"Editing "+e.attributes.OBJECTID,relatedFeature:null,essentialsRelatedFeature:null,feature:e,editable:a.isEditable(),relationship:r,timeZoneId:o,displayTimeZoneId:l};return void t._executeStartEditingRelatedRecord(u,!1)}})}},t.prototype._executeStartEditingNewFeature=function(e,t,i){void 0===i&&(i=!0),this.currentFeatureEsri=e,this._sourceLayer=t,this._calculateCanDeleteFeature();var r=this.app.getResource(this.libraryId,"language-common-feature-editing");this.headerText.set(r),this._executeStartEditingFeature(e,!0),i?t.geometryType&&t.allowGeometryUpdates?this.startEditingGeometry():this._activateEditingView():(this._activateEditingView(),this.currentFeatureEsriClone.show())},t.prototype._canExecuteStartEditingEditLogEntry=function(e){return!0},t.prototype._executeStartEditingEditLogEntry=function(e){return!0},t.prototype.handleTypeFieldSelected=function(e){if(e){var t=e.value.get();if(null!=t)for(var i=0;i<e.valueOptions.getLength();i++){var r=e.valueOptions.getAt(i);if(null!=r.id&&r.id.toString()===t.toString()){this._loadCodedDomainsForType(r.domains,e.name.get());break}}}},t.prototype._loadCodedDomainsForType=function(e,t){if(e){var i=this.form.get();for(var r in e)if(r!==t&&e.hasOwnProperty(r)&&e[r].type)for(var a=0;a<i.fields.getLength();a++){var n=i.fields.getAt(a),s=!0;if(n.name.get()===r){var o=[];if("inherited"!==e[r].type)o=e[r].codedValues;else{for(var l=0;l<this._sourceLayer.fields.length;++l){var d=this._sourceLayer.fields[l];if(d.name===n.name.get()){var u=d.domain;if(u){u.codedValues?o=u.codedValues:s=!1;break}}}if(!s)continue}var p={viewModel:n,typeName:"codedDomainValue",collectionName:"codedDomainValues",valueCollection:o,nullable:n.nullable.get(),nullOption:{name:"",code:null}};this._addValueCollection(p),n.value.pulse()}}}},t.prototype._addValueCollection=function(e){function t(e){return null===e||void 0===e?"":e.toString()}if(e){var i=e.viewModel.valueOptions;i||(i=e.viewModel.valueOptions=new r.ObservableCollection([])),i.clear(),i.addItems(e.valueCollection),e.nullable&&i.insertItem(0,e.nullOption);var a=t(e.viewModel.value.get());if(!i.get().some(function(e){return t(e.code)===a})){var n=i.get().filter(function(t){return t!==e.nullOption})[0];e.viewModel.value.set(n?n.code:e.nullOption.code)}}},t.prototype._activateEditingView=function(){this.app.command("HideFeatureTemplatePicker").execute(),this.app.command("ActivateView").execute("EditorView");var e=new n.Feature({graphic:this.currentFeatureEsriClone});this.app.behavior("EditorFeatureSelectedBehavior").run(e)},t.prototype._getEditingToolMessage=function(e){var t=Modernizr&&!!Modernizr.touch;switch(e){case esri.toolbars.Draw.POINT:return this.app.getResource(this.libraryId,"language-feature-editing-geometry-point");case esri.toolbars.Draw.MULTI_POINT:return this.app.getResource(this.libraryId,"language-feature-editing-geometry-multi-point");case esri.toolbars.Draw.POLYLINE:case esri.toolbars.Draw.FREEHAND_POLYLINE:var i=t?this.app.getResource(this.libraryId,"language-feature-editing-geometry-polyline-touch"):this.app.getResource(this.libraryId,"language-feature-editing-geometry-polyline");return i;case esri.toolbars.Draw.POLYGON:case esri.toolbars.Draw.FREEHAND_POLYGON:var i=t?this.app.getResource(this.libraryId,"language-feature-editing-geometry-polygon-touch"):this.app.getResource(this.libraryId,"language-feature-editing-geometry-polygon");return i;case esri.toolbars.Draw.EXTENT:return this.app.getResource(this.libraryId,"language-feature-editing-geometry-rectangle")}return this.app.getResource(this.libraryId,"language-feature-editing-geometry-default")},t.prototype.findGeocortexLayerForUrl=function(e){for(var t=this.app.site,i=0;i<t.essentialsMap.mapServices.length;i++){var r=t.essentialsMap.mapServices[i];if(r.serviceUrl===e&&r.layers.length>0)return r.layers[0]}return null},t.prototype._findServiceLayerForUrl=function(e){for(var t=this.app.site,i=0;i<t.essentialsMap.mapServices.length;i++){var r=t.essentialsMap.mapServices[i];if(r.url===e)return r.serviceLayer}return null},t.prototype._hideOrShowRelateds=function(){this.showRelatedLayers.set(this.hasRelatedLayers.get()&&!this.isEditingRelatedFeatureNotInSite.get()&&!this.isEditingNewFeature.get())},t.prototype._calculateCanDeleteFeature=function(){this.canDeleteFeature.set(!this.isEditingNewFeature.get()&&this._sourceLayer&&/Delete/.test(this._sourceLayer.capabilities))},t}(i.ViewModelBase);t.EditorViewModel=E})},"Mapping/modules/Editing/Editor/Form/EditingFormButton":function(){define(["require","exports"],function(e,t){"use strict"})},"Mapping/modules/Editing/Editor/Form/EditingFormField":function(){define(["require","exports","geocortex/framework/observables"],function(e,t,i){"use strict";var r;!function(e){e[e.esriFieldTypeSmallInteger=0]="esriFieldTypeSmallInteger",e[e.esriFieldTypeInteger=1]="esriFieldTypeInteger",e[e.esriFieldTypeSingle=2]="esriFieldTypeSingle",e[e.esriFieldTypeDouble=3]="esriFieldTypeDouble",e[e.esriFieldTypeString=4]="esriFieldTypeString",e[e.esriFieldTypeDate=5]="esriFieldTypeDate",e[e.esriFieldTypeOID=6]="esriFieldTypeOID",e[e.esriFieldTypeGeometry=7]="esriFieldTypeGeometry",e[e.esriFieldTypeBlob=8]="esriFieldTypeBlob",e[e.esriFieldTypeRaster=9]="esriFieldTypeRaster",e[e.esriFieldTypeGUID=10]="esriFieldTypeGUID",e[e.esriFieldTypeGlobalID=11]="esriFieldTypeGlobalID",e[e.esriFieldTypeXML=12]="esriFieldTypeXML",e[e.other=13]="other"}(r=t.esriFieldTypeEnum||(t.esriFieldTypeEnum={}));var a=function(){function e(){var e=this;this.type=r.esriFieldTypeString,this._isSettingPresentableValue=!1,this._isSettingValue=!1,this.name=new i.Observable,this.displayName=new i.Observable,this.editable=new i.Observable((!0)),this.readOnly=new i.Observable((!1)),this.required=new i.Observable((!1)),this.nullable=new i.Observable((!1)),this.cssClass=new i.Observable,this.showIndicator=new i.Observable((!1)),this.value=new i.Observable(null),this.presentableValue=new i.Observable,this.formatFunc=function(e){return null===e||void 0===e?"":e.toString()},this.value.bind(this,function(t){e._isSettingValue||(e._isSettingPresentableValue=!0,e.presentableValue.set(e.formatFunc(e.value.get())),e._isSettingPresentableValue=!1)}),this.presentableValue.bind(this,function(t){e._isSettingPresentableValue||(e._isSettingValue=!0,e.value.set(t),e._isSettingValue=!1)})}return e.prototype.showFormattedValue=function(){this._isSettingPresentableValue=!0,this.presentableValue.set(this.formatFunc(this.value.get())),this._isSettingPresentableValue=!1},e.prototype.showActualValue=function(){this._isSettingPresentableValue=!0,this.presentableValue.set(this.value.get()),this._isSettingPresentableValue=!1},e}();t.EditingFormField=a})},"Mapping/modules/Editing/Editor/Form/EditingFormViewModel":function(){define(["require","exports","geocortex/framework/ui/ViewModelBase","geocortex/framework/observables","./EditingFormField","geocortex/infrastructure/gis/FieldInfo","geocortex/forms/items/DatePickerFormItem","geocortex/forms/items/TimePickerFormItem","geocortex/infrastructure/FormatUtils","geocortex/infrastructure/TimeZoneUtils","./ValidationFunctionFactory"],function(e,t,i,r,a,n,s,o,l,d,u){"use strict";var p=function(e){function t(t,i,a,n,s){var o=e.call(this,t,i)||this;o.textareaThreshold=80,o.doNotAdjustTime=!1,o.id="EditingFormViewModel",o.fields=new r.ObservableCollection,o.validationMessages=new r.ObservableCollection,o.buttons=new r.ObservableCollection,o.currentFeature=new r.Observable,o.featureIsNew=new r.Observable((!1));var l=null;return s&&(s.textareaThreshold&&(o.textareaThreshold=s.textareaThreshold),s.fieldOrder&&(l=s.fieldOrder),s.doNotAdjustTime&&(o.doNotAdjustTime=s.doNotAdjustTime),s.timeZoneId&&(o.fallbackTimeZoneId=s.timeZoneId),s.displayTimeZoneId&&(o.fallbackDisplayTimeZoneId=s.displayTimeZoneId)),a&&o.setup(a,n?n:null,l),o}return __extends(t,e),t.prototype.addValidationMessage=function(e){this.validationMessages.addItem(e)},t.prototype.clearValidationMessages=function(){this.validationMessages.clear()},t.prototype._fieldHasSubTypeDomainValues=function(e,t){for(var i=0;i<t.types.length;++i){var r=t.types[i];if(r.domains&&e.name in r.domains)return!0}return!1},t.prototype.setup=function(e,t,i){var r=this;this.clear();var p=[];if(!t)throw new Error("Attempted to edit a feature with no layer attached!");for(var c=null,h=this.app.site.getFeatureServices(),g=null,m=0;m<h.length;++m){var f=h[m];if(f.serviceLayer===t){g=f.layers[0];break}}var y=function(e){if(!g)return null;for(var t=0;t<g.fields.length;++t){var i=g.fields[t];if(i.name===e)return i}return null},v=[],b=t._outFields;if(b&&b.length>0)for(var E=0;E<b.length;++E){var F=b[E];if(0===E&&"*"===F){v=t.fields;break}for(var w=0;w<t.fields.length;++w){var _=t.fields[w];if(_.name===F){v.push(_);break}}}else v=t.fields;if(i){var S=v.slice(),T=[];i.forEach(function(e){for(var t=S.length-1;t>-1;--t){var i=S[t];i.name===e&&(T.push(i),S.splice(t,1))}}),T.concat(S),v=T}for(var x=function(e,t){for(var i=0;i<t.length;i++){var r=t[i].prototype.attributes;if(e.name&&r.hasOwnProperty(e.name))return e.nullable=null===r[e.name],!0}return!1},C=0;C<v.length;++C){var G=v[C];if(G&&G.editable){var M=y(G.name);if(!M||M.visible){var k=n.FieldInfo.fromEsriField(G,t,M);if(void 0===G.nullable||null===G.nullable)if(t&&t.templates&&t.templates.length)x(G,t.templates);else if(t&&t.types&&t.types.length)for(var I=0;I<t.types.length&&!(t.types[I].templates&&t.types[I].templates.length&&x(G,t.types[I].templates));I++);var L=G.nullable===!0,R=!1,O=L===!1&&!R,V=null;this.featureIsNew.get()&&G.name!==t.typeIdField||e.attributes&&(V=e.attributes[G.name]);var A=new a.EditingFormField;if(A.name.set(G.name),A.readOnly.set(R),A.nullable.set(L),A.required.set(O),A.showIndicator.set(A.required.get()),A.type=a.esriFieldTypeEnum[G.type],A.renderType=G.type,function(e){!e.timeZoneId&&r.fallbackTimeZoneId&&(e.timeZoneId=r.fallbackTimeZoneId),!e.displayTimeZoneId&&r.fallbackDisplayTimeZoneId&&(e.displayTimeZoneId=r.fallbackDisplayTimeZoneId),A.formatFunc=function(t){return e.formatValue(t)}}(k),A.value.set(V),A.length=G.length,A.editable.set(G.editable),M?A.displayName.set(M.displayName):A.displayName.set(null!=G.alias?G.alias:G.name),"esriFieldTypeDate"===G.type){var D=new s.DatePickerFormItem(null,null);D.timePickerItem=new o.TimePickerFormItem(null,null);var U;if(e&&e.attributes[G.name]?(U=l.parseDate(e.attributes[G.name]),U=k.displayTimeZoneId?d.correctDatesForDisplayInDisplayTimeZone(U,k.timeZoneId,k.displayTimeZoneId):d.correctDatesForDisplayInLocalTime(U,k.timeZoneId)):U=A.nullable.get()?null:new Date,D.includeTimePicker.set(!0),D.initialDate.set(U),D.date.set(U),D.isRequired.set(A.required.get()),D.nullable.set(A.nullable.get()),k.format){var N=k.format.match(/\{0:([^}]*)\}/);N&&2==N.length&&D.dateFormat.set(N[1])}!function(e){return D.date.bind(r,function(t){r.doNotAdjustTime||(t=d.correctDatesToSubmitInDatabaseTime(t,k.timeZoneId,k.displayTimeZoneId)),e.value.set(t)})}(A),A.datePickerViewModel=D}else if(G.name===t.typeIdField){var P={valueCollection:t.types,nullable:!O,nullOption:{name:"",code:null}};A.renderType="typeField",this._applyFieldConfiguration(P,A),c=V}else if(k.isCodedValueDomain()||k.hasSubtypeCodedValueDomains()){var B=G.domain;if(B)A.domain=B;else for(var H=0;H<t.types.length;++H){var j=t.types[H];if(j.domains&&G.name in j.domains){A.domain=j.domains[G.name];break}}if("codedValue"===A.domain.type){var q={valueCollection:A.domain.codedValues,nullable:!O,nullOption:{name:"",code:null}};A.renderType="codedDomainValue",this._applyFieldConfiguration(q,A)}}else A.type!==a.esriFieldTypeEnum.esriFieldTypeDouble&&A.type!==a.esriFieldTypeEnum.esriFieldTypeInteger&&A.type!==a.esriFieldTypeEnum.esriFieldTypeOID&&A.type!==a.esriFieldTypeEnum.esriFieldTypeSingle&&A.type!==a.esriFieldTypeEnum.esriFieldTypeSmallInteger||A.value.set(l.formatNumber(l.parseNumber(V),"#.####################")),A.type===a.esriFieldTypeEnum.esriFieldTypeString&&A.length>this.textareaThreshold?A.renderType="textArea":A.renderType=this._getRenderTypeForField(A);this.app.urlParameters.hasOwnProperty("noval")?A.validationFunc=function(){return null}:A.validationFunc=u.ValidationFunctionFactory.createValidationFunction(this.app,this.libraryId,A,this),p.push(A)}}}if(this.fields.addItems(p),null!==c)for(H=0;H<t.types.length;H++){var J=t.types[H];null!==J.id&&J.id.toString()===c.toString()&&this._applyCodedDomains(J.domains)}},t.prototype.getRawFieldValue=function(e){for(var t=0;t<this.fields.getLength();++t){var i=this.fields.getAt(t);if(i.name.get()===e)return i.value.get()}return null},t.prototype.getAttributeValues=function(){for(var e={},t=0;t<this.fields.getLength();++t){var i=this.fields.getAt(t),r=i.value.get(),n=null;i.type===a.esriFieldTypeEnum.esriFieldTypeDate?(r=i.value.get(),n=null===r?null:l.parseDate(r).getTime()):i.type===a.esriFieldTypeEnum.esriFieldTypeDouble||i.type===a.esriFieldTypeEnum.esriFieldTypeInteger||i.type===a.esriFieldTypeEnum.esriFieldTypeOID||i.type===a.esriFieldTypeEnum.esriFieldTypeSingle||i.type===a.esriFieldTypeEnum.esriFieldTypeSmallInteger?(n=l.parseNumber(r),isNaN(n)&&(n=null)):n=r,""===r&&i.type!==a.esriFieldTypeEnum.esriFieldTypeString&&(n=null),e[i.name.get()]=n}return e},t.prototype._getRenderTypeForField=function(e){return"text"},t.prototype._applyCodedDomains=function(e){if(e)for(var t in e)if(e.hasOwnProperty(t)&&"codedValue"===e[t].type)for(var i=0;i<this.fields.getLength();i++){var r=this.fields.getAt(i);if(r.name.get()===t){var a={valueCollection:e[t].codedValues,nullable:r.nullable.get(),nullOption:{name:"",code:null}};r.renderType="codedDomainValue",this._applyFieldConfiguration(a,r);break}}},t.prototype._applyFieldConfiguration=function(e,t){t.valueOptions?t.valueOptions.clear():t.valueOptions=new r.ObservableCollection([]),t.valueOptions.addItems(e.valueCollection),e.nullable&&t.valueOptions.insertItem(0,e.nullOption);for(var i=0;i<t.valueOptions.getLength();++i){var a=t.valueOptions.getAt(i);"undefined"==typeof a.code&&a.hasOwnProperty("id")&&(a.code=a.id)}},t.prototype.clear=function(){this.fields.clear(),this.clearValidationMessages()},t}(i.ViewModelBase);t.EditingFormViewModel=p})},"Mapping/modules/Editing/Editor/Form/EditingValidatorDelegate":function(){define(["require","exports"],function(e,t){"use strict"})},"Mapping/modules/Editing/Editor/Form/ValidationFunctionFactory":function(){define(["require","exports","./EditingFormField","geocortex/infrastructure/FormatUtils"],function(e,t,i,r){"use strict";var a=function(){function e(){}return e.createValidationFunction=function(t,r,a,n){var s=i.esriFieldTypeEnum[a.type],o=function(e){if(e.editable.get()===!1||e.nullable.get()!==!1&&e.required.get()!==!0)return null;var i=t.getResource(r,"language-feature-editing-requires-value");return i.format(e.displayName.get())};if(a.domain){var l=function(i,n,s,l){var d=t.getResource(r,"language-feature-editing-invalid-number").format(n,s,l);return i?e.isValidNumber(a,i)?i<s||i>l?d:null:d:o(a)};if("codedValue"===a.domain.type)return function(e){return!a.required.get()||null!==e&&void 0!==e?null:t.getResource(r,"language-feature-editing-requires-value").format(a.displayName.get())};if("range"===a.domain.type){var d=a.domain;return a.domain.hasOwnProperty("range")?("Function"==typeof d.replace&&(d=d.replace("[","").replace("]","").split(",")),function(e){return l(e,a.displayName.get(),d[0],d[1])}):function(e){return l(e,a.displayName.get(),d.minValue,d.maxValue)}}return function(e){return null}}switch(s){case"esriFieldTypeDate":return function(e){return e?null:o(a)};case"esriFieldTypeString":case"esriFieldTypeGUID":return function(e){return e?a.length&&e.toString().length>a.length?t.getResource(r,"language-feature-editing-value-too-long").format(a.displayName.get(),a.length):null:o(a)};case"esriFieldTypeSingle":case"esriFieldTypeDouble":return function(i){return i||0===i?e.isValidNumber(a,i)?e.isWithinNumericTypeRange(a,i)?null:t.getResource(r,"language-feature-editing-invalid-numeric-range").format(a.displayName.get()):t.getResource(r,"language-feature-editing-invalid-decimal").format(a.displayName.get()):o(a)};case"esriFieldTypeSmallInteger":case"esriFieldTypeInteger":return function(i){return i||0===i?e.isValidNumber(a,i)?e.isWithinNumericTypeRange(a,i)?null:t.getResource(r,"language-feature-editing-invalid-numeric-range").format(a.displayName.get()):t.getResource(r,"language-feature-editing-invalid-integer").format(a.displayName.get()):o(a)};default:return function(e){return null}}},e.isWithinNumericTypeRange=function(e,t){var a=r.parseNumber(t);if(isNaN(a))return!1;var n=!0;if(e.type===i.esriFieldTypeEnum.esriFieldTypeSingle){var s=3.402823*Math.pow(10,38);n=a>=-s&&a<=s}else if(e.type===i.esriFieldTypeEnum.esriFieldTypeSmallInteger){var o=-32768,l=o*-1-1;n=a>=o&&a<=l}else if(e.type===i.esriFieldTypeEnum.esriFieldTypeInteger){var d=-2147483648,u=2147483647;n=a>=d&&a<=u}return n},e.isValidNumber=function(e,t){return!isNaN(r.parseNumber(t))},e}();t.ValidationFunctionFactory=a})},"Mapping/modules/Editing/MultiFeatureSelector/MultiFeatureSelectorView":function(){define(["require","exports","geocortex/framework/ui/ViewBase","geocortex/infrastructure/FeatureDescriptionPresenterView","geocortex/infrastructure/HtmlUtils"],function(e,t,i,r,a){"use strict";var n=function(e){function t(t,i){var r=e.call(this,t,i)||this;return r.app.command("HideMultiFeatureSelectorView").register(r,function(){r.isActive&&r.app.viewManager.deactivateView(r)}),r.app.event("ViewActivatedEvent").subscribe(r,r.setDisplayResultPickerListOffset),r}return __extends(t,e),t.prototype.setDisplayResultPickerListOffset=function(e){var t=this;this.id===e.id&&a.pollUntil(function(){return 0!==$(t.root).width()},50,5e3)["finally"](function(){if(t.topContainer){var e=t.topContainer.clientHeight;t.viewModel.topOffset.set(e)}if(t.bottomContainer){var i=t.bottomContainer.clientHeight;t.viewModel.bottomOffset.set(i)}})},t.prototype.handleClickButton=function(e,t,i){this.viewModel.selectedFeatures.get().length>0?this.viewModel.submitResults():this.viewModel.showError()},t.prototype.handleClick=function(e,t,i){return this._firstEvent&&this._cancelLongPress&&(this._firstEvent=null,this._cancelLongPress()),"A"===e.target.tagName||(this.viewModel.featureClicked(i),!0)},t.prototype.handleClearTextBox=function(e,t,i){this.viewModel.clearTextBox()},t.prototype.handleSelectAll=function(e,t,i){this.viewModel.selectAll()},t.prototype.handleSelectNone=function(e,t,i){this.viewModel.selectNone()},t.prototype.resolveWidget=function(t,i){e.prototype.resolveWidget.call(this,t,i);var a;return"GetLabel"===t?(a=new r.FeatureDescriptionPresenterView(this.app,this.libraryId),a.contentField="label",a.root=dojo.create("div"),a.root.className="feature-label",a.attach(i),a):"GetDescription"===t?(a=new r.FeatureDescriptionPresenterView(this.app,this.libraryId),a.root=dojo.create("div"),a.root.className="feature-description",a.attach(i),a):"RenderComplexResultTemplate"===t&&"complex"===this.viewModel.resultTemplateComplexity?(a=this.app.viewManager.createView({markupResource:"Mapping/modules/Workflow/Templates/DisplayResultPickerComplexResultTemplateView.html",typeName:"geocortex.essentialsHtmlViewer.mapping.modules.workflow.templates.DisplayResultPickerResultTemplateView"}),a.app=this.app,a.libraryId=this.libraryId,a.parentView=this,a.attach(i),a):"RenderSimpleResultTemplate"===t&&"simple"===this.viewModel.resultTemplateComplexity?(a=this.app.viewManager.createView({markupResource:"Mapping/modules/Workflow/Templates/DisplayResultPickerSimpleResultTemplateView.html",typeName:"geocortex.essentialsHtmlViewer.mapping.modules.workflow.templates.DisplayResultPickerResultTemplateView"}),a.app=this.app,a.libraryId=this.libraryId,a.parentView=this,a.attach(i),a):void 0},t}(i.ViewBase);t.MultiFeatureSelectorView=n})},"Mapping/modules/Editing/MultiFeatureSelector/MultiFeatureSelectorViewModel":function(){define(["require","exports","geocortex/framework/ui/ViewModelBase","geocortex/framework/observables","../DisplayResultPickerFeature","geocortex/forms/FormButton"],function(e,t,i,r,a,n){"use strict";var s=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.buttons=null,t.filterSectionVisible=new r.Observable((!0)),t.showFilterTextBox=new r.Observable((!1)),t.isSingleSelectionMode=new r.Observable((!0)),t.filterText=new r.Observable(""),t.disabledLinkCssClass=new r.Observable(""),t.topOffset=new r.Observable("0px"),t.bottomOffset=new r.Observable("0px"),t.message=null,t}return __extends(t,e),t.prototype.initialize=function(e){this.app.command("ShowSelectionListOfFeaturesWithCallback").register(this,this._showSelectionListOfFeatures),this.featureSet=null,this.features=new r.ObservableCollection([]),this.selectedFeatures=new r.ObservableCollection([]),this.resultsList=new r.ObservableCollection([]),this.cssClass=new r.Observable("display-result-picker-list");var t=e.displayResultPickerTemplateComplexity;void 0===t||"complex"!=t&&"simple"!=t?this.resultTemplateComplexity="complex":this.resultTemplateComplexity=t.toLowerCase(),this.message=new r.Observable(this.app.getResource(this.libraryId,"language-feature-editing-multi-feature-selector-message")),this.requiredValueErrorMessage=new r.Observable("");var i=[];i.push(new n.FormButton("Done","Done",(!0),(!0))),this.buttons=r.Observable.makeBindableProxy(i)},t.prototype._showSelectionListOfFeatures=function(e,t){this.callback=t,this.featureSet=e,this.features.clear();for(var i=0;i<e.features.length();i++){var r=a.generateDisplayResultPickerFeaturefromFeature(e.features.getAt(i));r.showCheckbox=!1,this.features.addItem(r)}this.selectedFeatures.set([]),this.resultsList.set(this.features.get()),this.requiredValueErrorMessage.set(""),this.cssClass.set("display-result-picker-list"),this.app.command("ActivateView").execute("MultiFeatureSelectorView")},t.prototype.featureClicked=function(e){this.clearSelection(),this.addFeatureToSelection(e,!0)},t.prototype.featureChecked=function(e){this.clearSelection(),this.addFeatureToSelection(e,!0)},t.prototype.addFeatureToSelection=function(e,t){if(void 0!=e.isFiltered.get()&&!e.isFiltered.get()){e.isSelected.set(!0),e.cssClass.set("selected");for(var i=!1,r=0;r<this.selectedFeatures.getItems().length;r++)if(this.selectedFeatures.getItems()[r]===e){i=!0;break}i||this.selectedFeatures.addItem(e);this.features.indexOf(e)}},t.prototype.clearSelection=function(){if(this.selectedFeatures.length()){for(var e=0;e<this.selectedFeatures.length();e++)this.selectedFeatures.getAt(e).isSelected.set(!1),this.selectedFeatures.getAt(e).cssClass.set("");this.selectedFeatures.clear()}},t.prototype.clearTextBox=function(){this.filterText.set("")},t.prototype.selectAll=function(){this.addFeatureToSelection(this.features.getAt(0),!0);for(var e=1;e<this.features.get().length;e++)this.addFeatureToSelection(this.features.getAt(e),!1)},t.prototype.selectNone=function(){this.clearSelection()},t.prototype.submitResults=function(){this.callback&&this.callback(this.selectedFeatures.getAt(0))},t.prototype.showError=function(){this.requiredValueErrorMessage.set(this.app.getResource(this.libraryId,"language-feature-editing-multi-feature-selector-error-message")),this.cssClass.set("display-result-picker-list error")},t}(i.ViewModelBase);t.MultiFeatureSelectorViewModel=s})},"Mapping/modules/Editing/TemplatePicker/FeatureTemplateViewModel":function(){define(["require","exports","geocortex/framework/observables"],function(e,t,i){"use strict";var r=function(){function e(){this.name=new i.Observable(""),this.description=new i.Observable,this.proto={},this.drawingTool=new i.Observable,this.symbolUri=new i.Observable,this.symbolStyle=new i.Observable(""),this.swatchElement=null}return e}();t.FeatureTemplate=r})},"Mapping/modules/Editing/TemplatePicker/TemplateFeatureLayerModel":function(){define(["require","exports"],function(e,t){"use strict"})},"Mapping/modules/Editing/TemplatePicker/TemplatePickerView":function(){define(["require","exports","geocortex/framework/ui/ViewBase","geocortex/essentials/Layer"],function(e,t,i,r){"use strict";var a=function(e){function t(t,i){var r=e.call(this,t,i)||this;return r.app.command("ShowFeatureTemplatePicker").register(r,r._onShowFeatureTemplatePicker,r._canShowFeatureTemplatePicker),r.app.command("HideFeatureTemplatePicker").register(r,function(){r.isActive&&r.app.viewManager.deactivateView(r)}),r}return __extends(t,e),t.prototype._onShowFeatureTemplatePicker=function(e,t){if(this.app.command("ActivateView").execute(this.id),this.viewModel){if(this.app.command("Internal.CancelEditingIfNotIdle").execute(),!e&&!t)return void this.viewModel.loadLayerTemplates();this.viewModel.filteredLayers&&(this.viewModel.filteredLayers.length=0,this.viewModel.filteredLayers=null),this._loadTemplate(e,t)}},t.prototype._canShowFeatureTemplatePicker=function(e,t){return!(this.viewModel&&this.app.isOffline.get()&&!this.viewModel.canEditOffline)&&(!e&&!t||!!("object"==typeof e&&e instanceof r.Layer&&e.mapService&&e.mapService.serviceLayer&&e.mapService.serviceLayer.isEditable&&/Create/.test(e.mapService.serviceLayer.capabilities))&&e.mapService.serviceLayer.isEditable())},t.prototype._loadTemplate=function(e,t){e?this.viewModel.loadTemplatesForCurrentLayer(e,t):this.viewModel.loadLayerTemplates(t)},t.prototype.handleFeatureTemplateClick=function(e,t,i){var r=this;this.app.command("Internal.CancelEditingIfNotIdle").execute();var a;if(i.proto&&i.proto.toJson&&!i.relatedFeature)a=new esri.Graphic(i.proto.toJson());else if(i.relatedFeature){
if(i.proto&&i.proto.toJson){a=i.relatedFeature;for(var n in i.proto.attributes){var s=i.proto.attributes[n];null!=s&&(a.attributes[n]=s)}}}else a=new esri.Graphic(null),i.proto&&i.proto.attributes&&(a.attributes=i.proto.attributes);var o=null;if(i.drawingTool&&i.drawingTool.get())switch(i.drawingTool.get()){case"esriFeatureEditToolPoint":o="MapPoint";break;case"esriFeatureEditToolLine":o="Polyline";break;case"esriFeatureEditToolFreehand":"esriGeometryPolyline"===i.layer.geometryType?o="FreehandPolyline":"esriGeometryPolygon"===i.layer.geometryType&&(o="FreehandPolygon");break;case"esriFeatureEditToolAutoCompletePolygon":case"esriFeatureEditToolPolygon":o="Polygon";break;case"esriFeatureEditToolEllipse":o="Ellipse";break;case"esriFeatureEditToolCircle":o="Circle";break;case"esriFeatureEditToolRectangle":o="Rectangle";break;default:o="Polygon"}if(!o)switch(i.layer.geometryType){case"esriGeometryPoint":o="MapPoint";break;default:o=i.layer.geometryType.replace("esriGeometry","")}a._drawType=o,this.app.configuration.mobileMode?(this.app.command("DisableMapClick").execute(),this.app.command("ShowMap").execute(),this.app.command("CloseDataFrame").execute(),this.app.event("DataFrameClosedEvent").once(this,function(){setTimeout(function(){r.app.command("EnableMapClick").execute(),r.app.event("StartFeaturePlacementEvent").publish(),r.app.command("StartEditingNewFeature").execute(a,i.layer)},225)})):(this.app.command("ShowMap").execute(),this.app.event("StartFeaturePlacementEvent").publish(),this.app.command("StartEditingNewFeature").execute(a,i.layer))},t}(i.ViewBase);t.TemplatePickerView=a})},"Mapping/modules/Editing/TemplatePicker/TemplatePickerViewModel":function(){define(["require","exports","geocortex/framework/ui/ViewModelBase","geocortex/framework/observables","./FeatureTemplateViewModel"],function(e,t,i,r,a){"use strict";var n=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.layerIsEditable=new r.Observable((!1)),t.layerTemplates=new r.ObservableCollection,t.canEditOffline=!1,t}return __extends(t,e),t.prototype.initialize=function(e){var t=this;this.app.site&&this.app.site.serviceLayersLoaded?this.loadLayerTemplates():this.app.event("SiteServiceLayersLoadedEvent").subscribe(this,function(){return t.loadLayerTemplates()}),this.app.nativeManager.hasNativeCapability("editing").then(function(e){t.canEditOffline=e})},t.prototype._layerIsValidForEditing=function(e){if(!e)return!1;var t=!0;if(this.filteredLayers){t=!1;for(var i=0;i<this.filteredLayers.length;i++){var r=this.filteredLayers[i];if(r===e){t=!0;break}}}return t},t.prototype.loadTemplatesForCurrentLayer=function(e,t){if(e&&e.mapService){this.layerTemplates.clear();var i=this._getFeatureLayerModel(e.mapService,t);i&&this.layerTemplates.addItem(i)}},t.prototype.loadLayerTemplates=function(e){var t=this.app.site;if(t&&t.essentialsMap&&t.isInitialized){var i=t.getFeatureServices();this.layerTemplates.clear();for(var r=[],a=0;a<i.length;a++){var n=i[a],s=this._getFeatureLayerModel(n,e);s&&!s.notAvailableReason.get()&&r.push(s)}this.layerTemplates.addItems(r)}},t.prototype._getFeatureLayerModel=function(e,t){var i=e.serviceLayer;if(!this._layerIsValidForEditing(e.id))return null;var a=null;if(this.app.offlineManager.isOfflineMapActive.get()){var n=this.app.offlineManager.syncInfo.findLayerOrTable(i.url);n&&n.canEdit||(this.app.trace.warning("Layer "+i.url+" not available offline. Make sure the layer is included in your offline map if you want to edit it offline."),a=this.getResource("language-feature-editing-not-available-offline"))}i.isEditable&&i.isEditable()||(a=this.getResource("language-feature-editing-not-editable"));var s=e.displayName;e&&e.layers&&e.layers.length>0&&(s=e.layers[0].displayName);var o=new r.ObservableCollection;if(!a){var l=this._loadFeatureTemplates(e.serviceLayer,t);l&&l.length>0&&o.addItems(l)}var d={displayName:new r.Observable(s),mapServiceId:new r.Observable(e.id),layer:e.serviceLayer,templates:o,proto:null,notAvailableReason:new r.Observable(a)};return d},t.prototype.createTemplate=function(e,t,i){var r=new a.FeatureTemplate,n=null;if(!e.renderer){var s=this.app.map.graphicsLayerIds.filter(function(t){return t===e.id+"-cluster"});s.length>0&&(n=this.app.map.getLayer(s[0]))}if(t){var o=t.name;if(r.name.set(o),r.description.set(t.description),r.drawingTool.set(t.drawingTool),r.proto=t.prototype,i&&i.attributes&&(r.relatedFeature=i),e.renderer||n){var l=e.renderer||n.featureLayerRenderer;if(l instanceof esri.renderer.HeatmapRenderer){var d=this.app.site.essentialsMap.mapServices.filter(function(t){return t.serviceLayer.id===e.id})[0];d.heatMap&&d.heatMap.defaultRenderer&&(l=d.heatMap.defaultRenderer)}var u=this._getTemplateSymbol(t,l);if(u)switch(u.type){case"picturemarkersymbol":r.symbolUri.set(u.url),r.swatchElement=null;break;case"simplelinesymbol":var p=String.escapeHtml(u.color.toCss());r.swatchElement="<div class='simple-swatch line' style='color: "+p+"'></div>";break;case"simplefillsymbol":var c=String.escapeHtml(u.color.toCss());r.swatchElement="<div class='simple-swatch square' style='background-color: "+c+"'></div>";break;default:var h=String.escapeHtml(u.color.toCss());r.swatchElement="<div class='simple-swatch square' style='background-color: "+h+"'></div>"}}}return r.layer=e,r},t.prototype._consumeTemplate=function(e,t,i){return this.createTemplate(e,t,i)},t.prototype._getTemplateSymbol=function(e,t){var i=new esri.Graphic(null);return i.attributes={},e.prototype.attributes&&dojo.mixin(i.attributes,e.prototype.attributes),t.getSymbol(i)||t.defaultSymbol},t.prototype._loadFeatureTemplates=function(e,t){if(!e||!e.templates)return null;var i=[];if(e.templates.length>0)for(var r=0;r<e.templates.length;++r)i.push(this._consumeTemplate(e,e.templates[r],t));else if(e.types&&e.types.length>0)for(var r=0;r<e.types.length;++r){var a=e.types[r];if(a.templates)for(var n=0;n<a.templates.length;++n)i.push(this._consumeTemplate(e,a.templates[n],t))}return i},t}(i.ViewModelBase);t.TemplatePickerViewModel=n})},"Mapping/modules/Editing/Undoable/Add":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(e,t){if(void 0===t&&(t={}),!t.graphicsLayer)throw new Error("Add Operation: Initialization failed. Graphics layer is not provided.");if(!t.addedGraphics)throw new Error("Add Operation: Initialization failed. Added graphics are not provided.");this.state=t,this.displayName=e}return e.prototype.performRedo=function(e,t){var i=this;return Promise.resolve().then(function(){i.state.addedGraphics.map(function(e){i.state.graphicsLayer.add(e),i.state.app.event("MarkupAddedEvent").publish(e)})})},e.prototype.performUndo=function(e,t){var i=this;return Promise.resolve().then(function(){i.state.addedGraphics.map(function(e){i.state.graphicsLayer.remove(e),i.state.app.event("MarkupDeletedEvent").publish(e)})})},e}();t.Add=i})},"Mapping/modules/Editing/Undoable/AddAndUpdate":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(e,t){var i=this;if(this._preUpdatedGraphicsGeometries=[],this._preUpdatedGraphicsAttributes=[],this._postUpdatedGraphicsGeometries=[],this._postUpdatedGraphicsAttributes=[],!t.graphicsLayer)throw new Error("Add/Update Operation: Initialization failed. Graphics layer is not provided.");if(!t.addedGraphics)throw new Error("Add/Update Operation: Initialization failed. Added graphics are not provided.");if(!t.preUpdatedGraphics||!t.updatedGraphics)throw new Error("Add/Update Operation: Initialization failed. Pre/Post updated graphics are not provided.");this.state=t,this.displayName=e,t.preUpdatedGraphics.map(function(e,t){i._preUpdatedGraphicsGeometries[t]=e.geometry.toJson(),i._preUpdatedGraphicsAttributes[t]=JSON.stringify(e.attributes||{})}),t.updatedGraphics.map(function(e,t){i._postUpdatedGraphicsGeometries[t]=e.geometry.toJson(),i._postUpdatedGraphicsAttributes[t]=JSON.stringify(e.attributes||{})})}return e.prototype.performRedo=function(e,t){var i=this;return Promise.resolve().then(function(){i.state.addedGraphics.map(function(e){i.state.graphicsLayer.add(e),i.state.app.event("MarkupAddedEvent").publish(e)}),i.state.updatedGraphics.map(function(e,t){e.setGeometry(esri.geometry.fromJson(i._postUpdatedGraphicsGeometries[t])),e.setAttributes(JSON.parse(i._postUpdatedGraphicsAttributes[t])),i.state.app.event("MarkupUpdatedEvent").publish(e)})})},e.prototype.performUndo=function(e,t){var i=this;return Promise.resolve().then(function(){i.state.addedGraphics.map(function(e){i.state.graphicsLayer.remove(e),i.state.app.event("MarkupDeletedEvent").publish(e)}),i.state.updatedGraphics.map(function(e,t){e.setGeometry(esri.geometry.fromJson(i._preUpdatedGraphicsGeometries[t])),e.setAttributes(JSON.parse(i._preUpdatedGraphicsAttributes[t])),i.state.app.event("MarkupUpdatedEvent").publish(e)})})},e}();t.AddAndUpdate=i})},"Mapping/modules/Editing/Undoable/AddAndUpdateState":function(){define(["require","exports"],function(e,t){"use strict"})},"Mapping/modules/Editing/Undoable/AddState":function(){define(["require","exports"],function(e,t){"use strict"})},"Mapping/modules/Editing/Undoable/Delete":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(e,t){if(void 0===t&&(t={}),!t.graphicsLayer)throw new Error("Delete Operation: Initialization failed. Graphics layer is not provided.");if(!t.deletedGraphics)throw new Error("Delete Operation: Initialization failed. Deleted graphics are not provided.");this.state=t,this.displayName=e}return e.prototype.performRedo=function(e,t){var i=this;return Promise.resolve().then(function(){i.state.deletedGraphics.map(function(e){i.state.graphicsLayer.remove(e),i.state.app.event("MarkupDeletedEvent").publish(e)})})},e.prototype.performUndo=function(e,t){var i=this;return Promise.resolve().then(function(){i.state.deletedGraphics.map(function(e){i.state.graphicsLayer.add(e),i.state.app.event("MarkupAddedEvent").publish(e)})})},e}();t.Delete=i})},"Mapping/modules/Editing/Undoable/DeleteAndUpdate":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(e,t){var i=this;if(this._preUpdatedGraphicsGeometries=[],this._preUpdatedGraphicsAttributes=[],this._postUpdatedGraphicsGeometries=[],this._postUpdatedGraphicsAttributes=[],!t.graphicsLayer)throw new Error("Delete/Update Operation: Initialization failed. Graphics layer is not provided.");if(!t.deletedGraphics)throw new Error("Delete/Update Operation: Initialization failed. Deleted graphics are not provided.");if(!t.preUpdatedGraphics||!t.updatedGraphics)throw new Error("Delete/Update Operation: Initialization failed. Pre/Post updated graphics are not provided.");this.state=t,this.displayName=e,t.preUpdatedGraphics.map(function(e,t){i._preUpdatedGraphicsGeometries[t]=e.geometry.toJson(),i._preUpdatedGraphicsAttributes[t]=JSON.stringify(e.attributes||{})}),t.updatedGraphics.map(function(e,t){i._postUpdatedGraphicsGeometries[t]=e.geometry.toJson(),i._postUpdatedGraphicsAttributes[t]=JSON.stringify(e.attributes||{})})}return e.prototype.performRedo=function(e,t){var i=this;return Promise.resolve().then(function(){i.state.deletedGraphics.map(function(e){i.state.graphicsLayer.remove(e),i.state.app.event("MarkupDeletedEvent").publish(e)}),i.state.updatedGraphics.map(function(e,t){e.setGeometry(esri.geometry.fromJson(i._postUpdatedGraphicsGeometries[t])),e.setAttributes(JSON.parse(i._postUpdatedGraphicsAttributes[t])),i.state.app.event("MarkupUpdatedEvent").publish(e)})})},e.prototype.performUndo=function(e,t){var i=this;return Promise.resolve().then(function(){i.state.deletedGraphics.map(function(e){i.state.graphicsLayer.add(e),i.state.app.event("MarkupAddedEvent").publish(e)}),i.state.updatedGraphics.map(function(e,t){e.setGeometry(esri.geometry.fromJson(i._preUpdatedGraphicsGeometries[t])),e.setAttributes(JSON.parse(i._preUpdatedGraphicsAttributes[t])),i.state.app.event("MarkupUpdatedEvent").publish(e)})})},e}();t.DeleteAndUpdate=i})},"Mapping/modules/Editing/Undoable/DeleteAndUpdateState":function(){define(["require","exports"],function(e,t){"use strict"})},"Mapping/modules/Editing/Undoable/DeleteState":function(){define(["require","exports"],function(e,t){"use strict"})},"Mapping/modules/Editing/Undoable/Update":function(){define(["require","exports"],function(e,t){"use strict";var i=function(){function e(e,t){void 0===t&&(t={});var i=this;if(this._preUpdatedGraphicsGeometries=[],this._preUpdatedGraphicsAttributes=[],this._postUpdatedGraphicsGeometries=[],this._postUpdatedGraphicsAttributes=[],!t.graphicsLayer)throw new Error("Update Operation: Initialization failed. Graphics layer is not provided.");if(!t.preUpdatedGraphics||!t.updatedGraphics)throw new Error("Update Operation: Initialization failed. Pre/Post updated graphics are not provided.");this.state=t,this.displayName=e,t.preUpdatedGraphics.map(function(e,t){i._preUpdatedGraphicsGeometries[t]=e.geometry.toJson(),i._preUpdatedGraphicsAttributes[t]=JSON.stringify(e.attributes||{})}),t.updatedGraphics.map(function(e,t){i._postUpdatedGraphicsGeometries[t]=e.geometry.toJson(),i._postUpdatedGraphicsAttributes[t]=JSON.stringify(e.attributes||{})})}return e.prototype.performRedo=function(e,t){var i=this;return Promise.resolve().then(function(){i.state.updatedGraphics.map(function(e,t){e.setGeometry(esri.geometry.fromJson(i._postUpdatedGraphicsGeometries[t])),e.setAttributes(JSON.parse(i._postUpdatedGraphicsAttributes[t])),i.state.app.event("MarkupUpdatedEvent").publish(e)})})},e.prototype.performUndo=function(e,t){var i=this;return Promise.resolve().then(function(){i.state.updatedGraphics.map(function(e,t){e.setGeometry(esri.geometry.fromJson(i._preUpdatedGraphicsGeometries[t])),e.setAttributes(JSON.parse(i._preUpdatedGraphicsAttributes[t])),i.state.app.event("MarkupUpdatedEvent").publish(e)})})},e}();t.Update=i})},"Mapping/modules/Editing/Undoable/UpdateState":function(){define(["require","exports"],function(e,t){"use strict"})},"url:/Mapping/modules/Editing/CreateOrEdit/CreateOrEditView.html":'<div class="view-feature-create-or-edit content-container">\r\n    <p class="description-text" data-binding="{@text: @language-feature-editing-create-edit-no-features-found}"></p>\r\n\r\n    <ul class="action-btns">\r\n        <li>\r\n            <button class="button button-action-icon create-new-feature" data-binding="{@event-onclick: handleClickCreateNewFeature}"><img src="Resources/Images/Icons/Toolbar/feature-create-24.png" data-binding="{alt: @language-feature-editing-create-edit-new-feature}{title: @language-feature-editing-create-edit-new-feature}"><span data-binding="{@text: @language-feature-editing-create-edit-new-feature}"></span></button>\r\n        </li>\r\n        <li>\r\n            <button class="button button-action-icon existing-feature" data-binding="{@event-onclick: handleClickSelectExistingFeature}"><img src="Resources/Images/Icons/Toolbar/feature-location-24.png" data-binding="{alt: @language-feature-editing-create-edit-select-existing-feature}{title: @language-feature-editing-create-edit-select-existing-feature}"><span data-binding="{@text: @language-feature-editing-create-edit-select-existing-feature}"></span></button>\r\n        </li>\r\n    </ul>\r\n</div>',"url:/Mapping/modules/Editing/Editor/EditorView.html":'<div class="editor">\r\n\r\n    <!-- APPLY EDITS -->\r\n    <div class="loading-container" data-binding="{@visible: isBusy}">\r\n        <div class="loading-img"></div>\r\n        <div class="loading-msg" data-binding="{@text: @language-feature-editing-applying}"></div>\r\n    </div>\r\n\r\n    <!-- ADD/EDIT FORM -->\r\n    <div class="add-or-edit-feature" data-binding="{@hidden: isBusy}">\r\n        <div class="panel-content">\r\n\r\n           <!-- has geometry -- >\r\n           <!-- <div class="panel-notification" data-binding="{@visible: hasGeometry}">\r\n                        <span data-binding="{@text: @language-feature-editing-has-geometry}"></span>\r\n                    </div>-->\r\n\r\n            <div data-binding="{@source: form}">\r\n                <div data-binding="{@template-for: form}">\r\n                    \r\n                    <!-- "This feature has no editable fields." -->\r\n                    <div class="panel-notification" data-binding="{@hidden: fields}">\r\n                        <span data-binding="{@text: @language-feature-editing-invalid-layer}"></span>\r\n                    </div>\r\n\r\n                    <div class="panel-group" data-binding="{@visible: fields}">\r\n                        <h3 data-binding="{@text: @language-feature-editing-feature-attributes}"></h3>\r\n\r\n                        <div class="panel-group-contents">\r\n                            <div class="form label-stacked">\r\n\r\n                                <div class="form-container" data-binding="{@source: fields}{@template-selector: renderType}">\r\n\r\n                                    <!-- DATE PICKER -->\r\n                                    <div class="form-item" data-binding="{@template-select: esriFieldTypeDate}{@visible: editable}">\r\n                                        <label class="form-label">\r\n                                            <span data-binding="{@text: displayName}"></span>\r\n                                        </label>\r\n                                        <div class="form-control-date-picker" data-binding="{@widget: DatePickerFormItem}{@widget-context: datePickerViewModel}">\r\n                                        </div>\r\n                                    </div>\r\n\r\n                                    <!-- CODED DOMAIN VALUE TEMPLATE -->\r\n                                    <div class="form-item" data-binding="{@template-select: codedDomainValue}{@visible: editable}">\r\n                                        <div class="combobox">\r\n                                            <label class="form-label">\r\n                                                <span data-binding="{@text: displayName}"></span>\r\n                                                <span class="indicator" data-binding="{@visible: showIndicator}">*</span>\r\n                                            </label>\r\n                                            <div class="form-control">\r\n                                                <select data-binding="{@source: valueOptions}{@value: value}{@disabled: readOnly}">\r\n                                                    <option data-binding="{@template-for: valueOptions}{@text: name}{value: code}"></option>\r\n                                                </select>\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n\r\n                                    <!-- SUBCLASS TEMPLATE -->\r\n                                    <div class="form-item" data-binding="{@template-select: typeField}{@visible: editable}">\r\n                                        <div class="combobox">\r\n                                            <label class="form-label">\r\n                                                <span data-binding="{@text: displayName}"></span>\r\n                                                <span class="indicator" data-binding="{@visible: showIndicator}">*</span>\r\n                                            </label>\r\n                                            <div class="form-control">\r\n                                                <select data-binding="{@source: valueOptions}{@value: value}{@event-onchange: handleTypeFieldChange}{@disabled: readOnly}">\r\n                                                    <option data-binding="{@template-for: valueOptions}{@text: name}{value: code}"></option>\r\n                                                </select>\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n\r\n                                    <!-- LARGE TEXT FIELDS -->\r\n                                    <div class="form-item" data-binding="{@template-select: textArea}{@visible: editable}">\r\n                                        <div class="textbox">\r\n                                            <label class="form-label">\r\n                                                <span data-binding="{@text: displayName}"></span>\r\n                                                <span class="indicator" data-binding="{@visible: showIndicator}">*</span>\r\n                                            </label>\r\n                                            <div class="form-control">\r\n                                                <textarea type="text" data-binding="{@value: presentableValue}{@disabled: readOnly}{@event-onblur: handleInputBlur}{@event-onfocus: handleInputFocus}"></textarea>\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n\r\n                                    <!-- FIELDS -->\r\n                                    <div class="form-item" data-binding="{@template-for: fields}{@visible: editable}">\r\n                                        <div class="textbox">\r\n                                            <label class="form-label">\r\n                                                <span data-binding="{@text: displayName}"></span>\r\n                                                <span class="indicator" data-binding="{@visible: showIndicator}">*</span>\r\n                                            </label>\r\n                                            <div class="form-control">\r\n                                                <input type="text" data-binding="{@value: presentableValue}{@disabled: readOnly}{@event-onblur: handleInputBlur}{@event-onfocus: handleInputFocus}" />\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n\r\n                                </div>\r\n\r\n                                <!-- VALIDATION -->\r\n                                <ul class="form-validation" data-binding="{@source: validationMessages}{@visible: validationMessages}">\r\n                                    <li data-binding="{@template-for: validationMessages}">\r\n                                        <span data-binding="{@text: @context}"></span>\r\n                                    </li>\r\n                                </ul>\r\n\r\n\r\n                            </div>\r\n\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            <!-- BUTTONS -->\r\n            <div class="panel-group-contents form-btns">\r\n                <button class="button" data-binding="{@event-onclick: handleClickEditGeometry}{@visible: showEditGeometryButton}{@text: @language-feature-editing-edit-geometry-caption}"></button>\r\n                <button class="button" data-binding="{@event-onclick: handleClickEditGeometry}{@visible: showStopEditingGeometryButton}{@text: @language-feature-editing-stop-editing-geometry-caption}"></button>\r\n                <button class="button" data-binding="{@event-onclick: handleClickDeleteFeature}{@visible: canDeleteFeature}{@text: @language-common-delete}"></button>\r\n                <button class="button" data-binding="{@event-onclick: handleClickSave}{@text: @language-common-save}"></button>\r\n                <button class="button" data-binding="{@event-onclick: handleClickCancel}{@text: @language-common-cancel}"></button>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>',"url:/Mapping/modules/Editing/TemplatePicker/FeatureTemplate.html":'\r\n<div class="feature-template has-icon" data-binding="{@event-onclick: handleFeatureTemplateClick}">\r\n    <img class="list-menu-icon" data-binding="{@visible: symbolUri}{src: symbolUri}" alt=" "/>\r\n    <div class="list-menu-icon" data-binding="{@hidden: symbolUri}{innerHTML: swatchElement}"></div>\r\n    <button class="list-menu-details">\r\n        <strong class="list-menu-name" data-binding="{@text: name}"></strong>\r\n        <span class="list-menu-desc" data-binding="{@text: description}{@visible: description}"></span>\r\n    </button>\r\n</div>',"url:/Mapping/modules/Editing/TemplatePicker/TemplatePickerView.html":'<div class="feature-template-picker">\r\n\r\n    <!-- TEMPLATES -->\r\n    <div class="panel-group no-item" data-binding="{@hidden: layerTemplates}{@text: @language-feature-editing-no-templates}"></div>\r\n\r\n    <div class="panel-group" data-binding="{@source: layerTemplates}">\r\n        <div data-binding="{@template-for: layerTemplates}{@visible: layerIsEditable}">\r\n            <h3 data-binding="{@text: displayName}"></h3>\r\n            <div data-binding="{@hidden: notAvailableReason}">\r\n                <div class="no-results" data-binding="{@hidden: templates}">\r\n                    <span data-binding="{@text: @language-feature-editing-no-templates}"></span>\r\n                    <div class="form-button-container">\r\n                        <div class="form-button-align">\r\n                            <div class="form-item form-btns">\r\n                                <button class="button" data-binding="{@text: @language-feature-editing-add-feature-button}{@event-onclick: handleFeatureTemplateClick}"></button>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n                <ul class="list-menu" data-binding="{@visible: templates}{@source: templates}{@template-selector: foo}">\r\n                    <li class="list-menu-item" data-binding="{@template-select: @null}{@template: Mapping/modules/Editing/TemplatePicker/FeatureTemplate.html}"></li>\r\n                </ul>\r\n            </div>\r\n            <div data-binding="{@visible: notAvailableReason}">\r\n                <div class="no-results">\r\n                    <span data-binding="{@text: notAvailableReason}"></span>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>'}}),define(["Mapping/modules/Editing/BinTool","Mapping/modules/Editing/CoreEditCommands","Mapping/modules/Editing/EditingModule","Mapping/modules/Editing/FeatureUtilities","Mapping/modules/Editing/Utils","Mapping/modules/Editing/CreateOrEdit/CreateOrEditView","Mapping/modules/Editing/Editor/EditorView","Mapping/modules/Editing/Editor/EditorViewModel","Mapping/modules/Editing/TemplatePicker/FeatureTemplateViewModel","Mapping/modules/Editing/TemplatePicker/TemplatePickerView","Mapping/modules/Editing/TemplatePicker/TemplatePickerViewModel","Mapping/modules/Editing/MultiFeatureSelector/MultiFeatureSelectorView","Mapping/modules/Editing/Undoable/Add","Mapping/modules/Editing/Undoable/AddAndUpdate","Mapping/modules/Editing/Undoable/Delete","Mapping/modules/Editing/Undoable/DeleteAndUpdate","Mapping/modules/Editing/Undoable/Update","Mapping/modules/Editing/Editor/Form/EditingFormField","Mapping/modules/Editing/Editor/Form/EditingFormViewModel","Mapping/modules/Editing/Editor/Form/ValidationFunctionFactory"],function(e,t,i,r,a,n,s,o,l,d,u,p,c,h,g,m,f,y,v,b){shim(e,"geocortex.essentialsHtmlViewer.mapping.modules.editing.BinTool",e.BinTool),shim(t,"geocortex.essentialsHtmlViewer.mapping.modules.editing.CoreEditCommands",t.CoreEditCommands),shim(i,"geocortex.essentialsHtmlViewer.mapping.modules.editing.EditGraphicType",i.EditGraphicType),shim(i,"geocortex.essentialsHtmlViewer.mapping.modules.editing.EditingModule",i.EditingModule),shim(r,"geocortex.essentialsHtmlViewer.mapping.modules.editing.FeatureUtilities",r.FeatureUtilities),shim(a,"geocortex.essentialsHtmlViewer.mapping.modules.editing.EditingUtils",a.EditingUtils),shim(n,"geocortex.essentialsHtmlViewer.mapping.modules.editing.CreateOrEditView",n.CreateOrEditView),shim(s,"geocortex.essentialsHtmlViewer.mapping.modules.editing.EditorView",s.EditorView),shim(o,"geocortex.essentialsHtmlViewer.mapping.modules.editing.EditorState",o.EditorState),shim(o,"geocortex.essentialsHtmlViewer.mapping.modules.editing.EditorViewModel",o.EditorViewModel),shim(l,"geocortex.essentialsHtmlViewer.mapping.modules.editing.FeatureTemplate",l.FeatureTemplate),shim(d,"geocortex.essentialsHtmlViewer.mapping.modules.editing.TemplatePickerView",d.TemplatePickerView),shim(u,"geocortex.essentialsHtmlViewer.mapping.modules.editing.TemplatePickerViewModel",u.TemplatePickerViewModel),shim(p,"geocortex.essentialsHtmlViewer.mapping.modules.editing.MultiFeatureSelectorView",p.MultiFeatureSelectorView),shim(c,"geocortex.essentialsHtmlViewer.mapping.modules.editing.undoable.Add",c.Add),shim(h,"geocortex.essentialsHtmlViewer.mapping.modules.editing.undoable.AddAndUpdate",h.AddAndUpdate),shim(g,"geocortex.essentialsHtmlViewer.mapping.modules.editing.undoable.Delete",g.Delete),shim(m,"geocortex.essentialsHtmlViewer.mapping.modules.editing.undoable.DeleteAndUpdate",m.DeleteAndUpdate),shim(f,"geocortex.essentialsHtmlViewer.mapping.modules.editing.undoable.Update",f.Update),shim(y,"geocortex.essentialsHtmlViewer.mapping.modules.editing.esriFieldTypeEnum",y.esriFieldTypeEnum),shim(y,"geocortex.essentialsHtmlViewer.mapping.modules.editing.EditingFormField",y.EditingFormField),shim(v,"geocortex.essentialsHtmlViewer.mapping.modules.editing.EditingFormViewModel",v.EditingFormViewModel),shim(b,"geocortex.essentialsHtmlViewer.mapping.modules.editing.ValidationFunctionFactory",b.ValidationFunctionFactory)});