!function(){function e(e,t,n){if("string"==typeof e&&(n=t,t=e),void 0!==n)for(var i=t.split("."),o=null,a=window,r=0,s=i.length;r<s;r++)o=i[r],r==s-1?a[o]=n:a[o]||(a[o]={}),a=a[o];else console.warn("Undefined shim for: "+t)}var t="<div class='pane'>    <iframe frameborder='0' class='map-frame' data-binding='{@var: frameElement}{data-frame-id: frameId}{@visible: uri}{src: uri}{title: @language-integration-accessibility-frame-title}'></iframe></div>",n="<div class='view-container-view integration' data-binding='{@var: containerElement}'>    \x3c!-- BEGIN: Header --\x3e    <button class='bottom-panel-resize resize-handle' tabindex='-1' data-binding='{@visible: resizeY}{@event-mousedown: handleHeaderMouseDown}{@event-touchstart: handleHeaderTouchStart}{title: @language-integration-smart-panel-resize}'>        <span class='icon-drag'></span>    </button>    <div class='banner-noselect' data-binding='{@var: headerElement}{@event-mousedown: handleHeaderMouseDown}{@event-touchstart: handleHeaderTouchStart}                                                {@class-resize-horizontal-hint: resizeX}{@class-resize-vertical-hint: resizeY}'>        <div class='panel-header' data-binding='{@visible: headerIsVisible}'>            <button class=' panel-header-button right close-16' href='javascript:void(0)' data-binding='{@visible: showXButton}{@event-onclick: handleClickClose}{aria-label: @language-common-close}'>            </button>            <button class='panel-header-button right' data-binding='{@visible: showingMaximizeButton}{@class-minimize-16: panelMaximized}{@noclass-maximize-16: panelMaximized}{@event-onclick: handleMaximizeToggleClick}{@event-touchstart: handleMaximizeToggleClick}{title: @language-integration-smart-panel-maximize-restore}'></button>            <img data-binding='{@visible: selectorIconUri}{src: selectorIconUri}{alt: @language-integration-selector-icon}' />            <div data-binding='{@widget: Selector}{@widget-replace: true}'></div>        </div>        <div class='resize-header' data-binding='{@hidden: headerIsVisible}'></div>    </div>    <div class='panel-scroll-container' data-binding='{data-region-name: regionName}{data-region-adapter: regionType}{@var: scrollRegionElement}{@event-onscroll: handleScrollChange}'></div>    <div class='integration-overlay' data-binding='{@visible: overlayIsVisible}'></div></div>";require({cache:{"Mapping/modules/Integration/ExternalComponent":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"Mapping/modules/Integration/ExternalComponentPaneView":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();define(["require","exports","geocortex/infrastructure/ui/components/MultiPane/PaneView","geocortex/framework/utils/utils"],function(t,n,i,o){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var a=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return e(n,t),n.prototype.attach=function(e){var n=this;t.prototype.attach.call(this,e);var i="iframe[data-frame-id='{0}']".format(e.frameId);o.addEventListener(this.frameElement,"load",function(){n.app.command("ListenToExternalComponentFrame").execute({elementSelector:i,name:n.viewModel.currentPaneItem.get().id,viewpointIndicatorUri:n.viewModel.currentPaneItem.get().viewpointIndicatorUri})})},n}(i.PaneView);n.ExternalComponentPaneView=a})},"Mapping/modules/Integration/ExternalComponentPaneViewModel":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();define(["require","exports","geocortex/infrastructure/ui/components/MultiPane/PaneViewModel","geocortex/framework/observables","geocortex/framework/utils/utils"],function(t,n,i,o,a){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=function(t){function n(){var e=null!==t&&t.apply(this,arguments)||this;return e.uri=new o.Observable(""),e}return e(n,t),n.prototype.initialize=function(e){t.prototype.initialize.call(this,e),this.frameId="frame-"+a.alphaNumericToken(),e&&e.hasOwnProperty("uri")&&this.uri.set(e.uri)},n}(i.PaneViewModel);n.ExternalComponentPaneViewModel=r})},"Mapping/modules/Integration/ExternalComponentPaneViewModelConfig":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"Mapping/modules/Integration/ExternalComponentView":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();define(["require","exports","geocortex/infrastructure/ui/components/MultiPane/MultiPaneView","geocortex/framework-ui/Selector/SelectorViewModel","./ExternalComponentPaneViewModel","geocortex/framework/utils/utils"],function(t,n,i,o,a,r){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var s=function(t){function n(e,n){var i=t.call(this,e,n)||this;return i._notificationViewId="externalComponentStatusMessageView",i._windowUnloadInterval=500,i._windowLoadInterval=250,i._isIE9=!1,i._notificationDisplayed=!1,i.app.site&&i.app.site.isInitialized?i._siteInitialized():i.app.event("SiteInitializedEvent").once(i,i._siteInitialized),i._isIE9=$(document.documentElement).hasClass("dj_ie9"),i}return e(n,t),n.prototype.attach=function(e){t.prototype.attach.call(this,e),this._registerCommands()},n.prototype.deactivated=function(){t.prototype.deactivated.call(this),this._notificationDisplayed=!1,this.app.command("RemoveNotification").execute(this._notificationViewId)},n.prototype.resolveWidget=function(e,n,i){var a=this;return"Selector"===e?(this._selectorView=this.app.viewManager.createView({typeName:"geocortex.framework.ui.Selector.SelectorView",markupResource:"Framework.UI/geocortex/framework/ui/Selector/SelectorView.html",isVisible:!0,libraryId:"Framework.UI"}),this.selector=new o.SelectorViewModel(this.app,this.libraryId,!!this.app.configuration.mobileMode,!!this.app.configuration.mobileMode),this.selector.setCollection(this.viewModel.paneItems,"displayName",null),this.selector.selectorText.set(this.viewModel.selectorText.get()||this.app.getResource(this.libraryId,"language-integration-selector-text")),this.selector.noItemsText.set(this.app.getResource(this.libraryId,"language-integration-no-items")),this.selector.onSelectItem=function(e){return a.handleSelectPane(e.item)},this.selector.onUnselectItem=function(e){return a.handleUnSelectPane(e.item)},this._selectorView.attach(this.selector),this._selectorView):t.prototype.resolveWidget.call(this,e,n,null)},n.prototype.handleUnSelectPane=function(e){this.destroyPaneItemById(e.id)},n.prototype.handleClickClose=function(){this.clearDockedPaneItems(),this.deactivateContainer()},n.prototype.addPaneItem=function(e){if(!e||!this.canAddPaneItem(e))return null;this.viewModel.displayedPaneItems.addItem(e),this.app.command("ActivateView").execute(this.id);var t=new a.ExternalComponentPaneViewModel(this.app,this.libraryId);t.currentPaneItem.set(e),t.initialize({uri:e.uri});var n=this.app.viewManager.createView({typeName:"geocortex.essentialsHtmlViewer.mapping.modules.integration.ExternalComponentPaneView",markupResource:"Mapping/modules/Integration/ExternalComponentPaneView.html",libraryId:this.libraryId||"Mapping",regionName:this.viewModel.regionName.get(),isVisible:!0});return this._panes.push(n),n.attach(t),this.selector.selectItem(e),this.handleApplicationResizedEvent(),n},n.prototype.destroyPaneItemById=function(e,t){void 0===t&&(t=!1);var n=this.viewModel.findUndockedPaneItemById(e);n?this.destroyUndockedPaneItem(n):t||(n=this.viewModel.findDisplayedPaneItemById(e),this.destroyPaneItem(n))},n.prototype.destroyPaneItem=function(e){var n=t.prototype.destroyPaneItem.call(this,e);return this.viewModel.haveDockedPanes()||this.app.command("DeactivateView").execute(this.id),n},n.prototype.destroyUndockedPaneItem=function(e){e&&this.viewModel.isUndockedPaneItem(e)&&(e.window&&(e.window.close(),e.window=null),this.viewModel.undockedPaneItems.removeItem(e),this.viewModel.displayedPaneItems.removeItem(e),this.selector.unselectItem(e))},n.prototype.clearDockedPaneItems=function(){for(var e=this.viewModel.displayedPaneItems.getLength();e--;){var t=this.viewModel.displayedPaneItems.getAt(e);this.viewModel.isDockedPaneItem(t)&&this.destroyPaneItem(t)}},n.prototype.dockPaneItemById=function(e){var t=this,n=this.viewModel.findPaneItemById(e);this.viewModel.isUndockedPaneItem(n)&&this.destroyUndockedPaneItem(n),setTimeout(function(){t.addPaneItem(n)},this._windowUnloadInterval)},n.prototype.undockPaneItemById=function(e){var t=this;if("Tablet"==this.app.shellName||this._isIE9)return this.app.trace.warning("Undocking an external component is not supported."),void this.dockPaneItemById(e);var n=this.viewModel.findPaneItemById(e);if(n)if(!n.window||n.window.opener===n.window||n.window.closed){var i=n.id.replace(/\W/g,""),o=window.open(n.uri,i);this.app.command("ListenToExternalComponentFrame").execute({elementSelector:null,name:n.id,contentWindow:o,viewpointIndicatorUri:n.viewpointIndicatorUri}),setTimeout(function(){r.addEventListener(o,"unload",function(){t.destroyPaneItemById(n.id,!0)})},this._windowLoadInterval),this.viewModel.isDockedPaneItem(n)&&this.destroyPaneItem(n),this.viewModel.haveDockedPanes()||this.app.command("DeactivateView").execute(this.id),n.window=o,this.viewModel.undockedPaneItems.addItem(n),this.viewModel.displayedPaneItems.addItem(n),this.selector.selectItem(n)}else n.window.focus()},n.prototype.handleApplicationResizedEvent=function(){t.prototype.handleApplicationResizedEvent.call(this);var e=this.scrollRegionElement,n=$(".view .pane .map-frame",e);0!==n.length&&setTimeout(function(){$(n).height(e.clientHeight)})},n.prototype._registerCommands=function(){var e=this;this.app.command("ShowExternalComponentView").register(this,this._executeShowExternalComponentView,this._canExecuteExternalComponentView),this.app.command("DisplayDockedExternalComponentById").register(this,this.dockPaneItemById),this.app.command("DisplayUndockedExternalComponentById").register(this,this.undockPaneItemById),this.app.command("RemoveExternalComponentById").register(this,this.destroyPaneItemById),this.app.event("ActiveToolChangedEvent").subscribe(this,function(t){e._currentTool=t.tool,e._currentTool||e._notificationDisplayed||!e.isActive||e._showNotificationMessage()})},n.prototype._siteInitialized=function(){var e=this;this.app.command("ShowExternalComponentView").raiseCanExecuteChanged(),r.addEventListener(window,"unload",function(){e.viewModel.undockedPaneItems.getItems().forEach(function(e){e.window.close()})})},n.prototype._executeShowExternalComponentView=function(){this._executeShowMultiPaneView(),this._currentTool||this._showNotificationMessage()},n.prototype._showNotificationMessage=function(){var e=this.viewModel.statusText.get();if(e){var t={id:this._notificationViewId,text:e,closeButton:{}};this._notificationDisplayed=!0,this.app.command("DisplayNotification").execute(t)}},n.prototype._canExecuteExternalComponentView=function(){return this.viewModel&&this.viewModel.paneItems.getLength()>0},n}(i.MultiPaneView);n.ExternalComponentView=s})},"Mapping/modules/Integration/ExternalComponentViewModel":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();define(["require","exports","geocortex/infrastructure/ui/components/MultiPane/MultiPaneViewModel","geocortex/framework/observables","geocortex/framework/utils/ArrayUtils"],function(t,n,i,o,a){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=function(t){function n(){var e=null!==t&&t.apply(this,arguments)||this;return e.undockedPaneItems=new o.ObservableCollection,e.overlayIsVisible=new o.Observable(!1),e.statusText=new o.Observable(""),e}return e(n,t),n.prototype.initialize=function(e){t.prototype.initialize.call(this,e),e&&(e.hasOwnProperty("externalComponents")&&this.paneItems.addItems(e.externalComponents),e.hasOwnProperty("defaultComponents")&&this.setDefaultComponents(e.defaultComponents),e.hasOwnProperty("statusText")&&this.statusText.set(e.statusText)),this._registerCommandsAndEvents()},n.prototype.setDefaultComponents=function(e){if(0!=this.paneItems.length()){for(var t=0;t<e.length;t++){var n=a.firstOrDefault(this.paneItems.getItems(),function(n){return n.id===e[t]});this.defaultPaneItems.addItem(n)}0==this.defaultPaneItems.getLength()&&this.defaultPaneItems.addItem(this.paneItems.getAt(0))}},n.prototype.findUndockedPaneItemById=function(e){return a.firstOrDefault(this.undockedPaneItems.getItems(),function(t){return t.id&&t.id===e})},n.prototype.isUndockedPaneItem=function(e){return a.contains(this.undockedPaneItems.getItems(),e)},n.prototype.isDockedPaneItem=function(e){return a.contains(this.displayedPaneItems.getItems(),e)&&!a.contains(this.undockedPaneItems.getItems(),e)},n.prototype.haveDockedPanes=function(){return this.displayedPaneItems.length()>this.undockedPaneItems.length()},n.prototype._registerCommandsAndEvents=function(){var e=this;this.app.event("MapMouseDownEvent").subscribe(this,function(){return e.overlayIsVisible.set(!0)}),this.app.event("MapMouseUpEvent").subscribe(this,function(){return e.overlayIsVisible.set(!1)}),this.app.event("PanelResizeStartEvent").subscribe(this,function(){return e.overlayIsVisible.set(!0)}),this.app.event("PanelResizeEndEvent").subscribe(this,function(){return e.overlayIsVisible.set(!1)})},n}(i.MultiPaneViewModel);n.ExternalComponentViewModel=r})},"Mapping/modules/Integration/ExternalComponentViewModelConfig":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"Mapping/modules/Integration/IntegrationModule":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();define(["require","exports","geocortex/framework/application/ModuleBase","geocortex/infrastructure/GeometryUtils","geocortex/framework/utils/utils","geocortex/framework/utils/ArrayUtils","geocortex/essentials/utilities/GraphicsLayerUtilities","geocortex/infrastructure/GraphicsLayerUtils","geocortex/infrastructure/GraphicsLayerIds","geocortex/infrastructure/BrowserUtils"],function(t,n,i,o,a,r,s,p,c,d){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var m=function(t){function n(){var e=null!==t&&t.apply(this,arguments)||this;return e._connectedComponents=[],e._componentStates=[],e._eventSubscriptions=[],e._commandSubscriptions=[],e._heading=0,e._pitch=0,e._previousScale=0,e._ignoreUpdates=!1,e._componentIgnoreUpdates=!1,e._ignoreUpdateInterval=250,e._isIE=!1,e}return e(n,t),n.prototype.initialize=function(e){var t=this;this._incomingMessageTransport=new geocortex.essentialsHtmlViewer.integration.PostMessageTransport(window,null,"Viewer"),this._incomingMessageTransport.allowOrigin("{0}//{1}".format(window.location.protocol,window.location.host)),this._incomingMessageTransport.onMessage=function(e){return t._handleBridgeMessage(e)},e.allowedOrigins&&e.allowedOrigins.forEach(function(e){return t._incomingMessageTransport.allowOrigin(e)}),d.isInternetExplorerOrEdge()>0&&(this._isIE=!0,this.app.doWhenMapInitialized(function(){return t._mapRoot=document.getElementById("map_root")})),s.addToGraphicsLayerIdsToExclude([p.ExcludeFromEnum.ExportApplyStateName,p.ExcludeFromEnum.ExportMapTaskName,p.ExcludeFromEnum.WebMapName],c.VIEWPOINT_INDICATOR_GRAPHICS_LAYER_ID),s.addToGraphicsLayerIdsToExclude([p.ExcludeFromEnum.ExportApplyStateName,p.ExcludeFromEnum.WebMapName],c.INTEGRATION_GRAPHICS_LAYER_ID),this._registerCommandsAndEvents()},n.prototype._registerCommandsAndEvents=function(){var e=this;this.app.command("ListenToExternalComponentFrame").register(this,this._executeListenToExternalComponentFrame),this.app.command("ToggleExternalComponentSyncById").register(this,this._executeToggleExternalComponentSyncById),this.app.command("BroadcastCurrentViewpoint").register(this,this._executeBroadcastCurrentViewpoint),this.app.command("UpdateComponentGraphic").register(this,this._executeUpdateComponentGraphic),this.app.command("RemoveComponentGraphic").register(this,this._executeRemoveComponentGraphic),this.app.command("ClearComponentGraphics").register(this,this._executeClearComponentGraphics),this.app.command("UpdateComponentIndicator").register(this,this._executeUpdateComponentCustomIndicator),this.app.command("RemoveComponentIndicator").register(this,this._executeRemoveComponentCustomIndicator),this.app.command("ClearComponentIndicators").register(this,this._executeClearComponentCustomIndicators),this.app.event("ComponentViewpointUpdatedEvent").subscribe(this,this._handleComponentViewpointUpdatedEvent),this.app.event("MapExtentChangedEvent").subscribe(this,this._handleMapExtentChangedEvent),this.app.event("ApplicationResizedEvent").subscribe(this,this._handleApplicationResizedEvent),this.app.event("ActiveToolChangedEvent").subscribe(this,function(t){return e._currentTool=t.tool})},n.prototype._handleComponentViewpointUpdatedEvent=function(e){var t=this;if(e){var n=this._getComponent(this._commandOrEventSender);if(n){this._lastUpdaterName=n.id,n.sync&&e.heading&&(this._heading=e.heading);var i;(i=e.extent?new esri.geometry.Extent(e.extent):new esri.geometry.Point(e.center)).spatialReference=i.spatialReference||n.preferredSpatialReference;var a=new esri.tasks.ProjectParameters;a.geometries=[i],a.outSR=this.app.map.spatialReference,o.project(a,function(i){var o=i[0];o instanceof esri.geometry.Extent?n.sync&&!t._ignoreUpdates?(t.app.command("ZoomToExtent").execute(o),t._updateSyncedViewpointIndicator()):n.sync||t._updateViewpointIndicator(n.name,n.viewpointIndicatorUri,o.getCenter(),e.heading):n.sync&&!t._ignoreUpdates?(e.scale&&e.scale!==t._previousScale&&(t._previousScale=e.scale,t.app.command("ZoomToScale").execute(e.scale)),t.app.command("PanToPoint").execute(o),t._updateSyncedViewpointIndicator()):n.sync||t._updateViewpointIndicator(n.name,n.viewpointIndicatorUri,o,e.heading)},function(e){t.app.trace.warning("An error occurred while attempting to project the current extent for third-party map components: "+e)},this.app)}else this.app.trace.warning("Received a viewpoint update from an unrecognized component.")}},n.prototype._executeBroadcastCurrentViewpoint=function(e){var t=this._getComponentByName(e);if(t){var n=this._currentViewpoint;this._lastUpdaterName=null,n.updaterName=this._lastUpdaterName,this._updateViewpointIndicator(t.name,t.viewpointIndicatorUri,n.extent.getCenter(),this._heading),this._broadcastViewpoint(n,t,!0)}else this.app.trace.warning("Received a broadcast request from an unrecognized component.")},n.prototype._executeListenToExternalComponentFrame=function(e){var t=$(e.elementSelector,this.app.getHostElement())[0],n=t?t.contentWindow:e.contentWindow;if(n){var i=a.alphaNumericToken(32),o=e.name,r={id:i,name:o,transport:new geocortex.essentialsHtmlViewer.integration.PostMessageTransport(null,n,o),preferredSpatialReference:new esri.SpatialReference({wkid:4326}),sync:!1,viewpointIndicatorUri:e.viewpointIndicatorUri};this._connectedComponents.push(r)}else this.app.trace.error("Could not listen to remote component. No element to listen to found for selector '{0}' and no context window provided.".format(e.elementSelector))},n.prototype._executeToggleExternalComponentSyncById=function(e){var t=this._getComponentByName(e);if(t)if(t.sync=!t.sync,t.sync){this._removeViewpointIndicator(t.name),this._updateSyncedViewpointIndicator();var n=this._currentViewpoint;n.updaterName=null,this._broadcastViewpoint(n,t)}else this._removeSyncedViewpointIndicator(),this._updateViewpointIndicator(t.name,t.viewpointIndicatorUri,this.app.map.extent.getCenter(),this._heading);else this.app.trace.warning("Received a sync update from an unrecognized component.")},n.prototype._handleHandshakeRequest=function(e){if(e.payload){var t,n;"string"==typeof e.payload?(t=e.payload,console.warn("Handshake message should pass HandshakeRequest object instead of string")):(t=e.payload.id,n=e.payload.addViewpointIndicator);var i=this._getComponentByName(t);i?(i.transport.send({messageName:geocortex.essentialsHtmlViewer.integration.protocol.HandshakeResponse,componentId:i.id}),this._handleRemoteComponentInitialized(i,n)):this.app.trace.warning("Received a handshake request from an unrecognized component.")}else this.app.trace.warning("Received a handshake request without a specified id.")},n.prototype._handleRemoteComponentDisconnect=function(e){var t=this._getComponent(e.componentId);t?(e.payload&&this._updateComponentState(e.payload),this._removeComponent(e.componentId),t.sync&&this._removeSyncedViewpointIndicator(),this._clearComponentViewpointIndicators(t),this._clearComponentGraphics(t)):this.app.trace.warning("An unknown component broadcasted a disconnect message.")},n.prototype._updateComponentState=function(e){var t=r.firstOrDefault(this._componentStates,function(t){return t.id===e.id});t&&r.removeItem(this._componentStates,t),this._componentStates.push(e)},n.prototype._removeComponent=function(e){var t=this._getComponent(e);if(!t)return!1;var n=this._connectedComponents.indexOf(t);return!(n<0)&&(this._connectedComponents.splice(n,1),!0)},n.prototype._sendToAll=function(e,t){var n=this;this._connectedComponents.forEach(function(i){if(!t||i.id!==t)try{i.transport.send(e)}catch(t){n.app.trace.warning("Could not send message '{0}' to component '{1}' (ID: '{2}'): {3}".format(e.messageName,i.name,i.id,t))}})},n.prototype._sendTo=function(e,t){var n=this._getComponent(e);n&&n.transport.send(t)},n.prototype._getComponent=function(e){var t=this._connectedComponents.filter(function(t){return t.id===e})[0];return t||(this.app.trace.warning("Could not find connected component with ID '{0}'.".format(e)),null)},n.prototype._getComponentByName=function(e){var t=this._connectedComponents.filter(function(t){return e.startsWith(t.name)})[0];return t||(this.app.trace.warning("Could not find connected component with name '{0}'.".format(e)),null)},n.prototype._handleBridgeMessage=function(e){var t=this;if(e.messageName!==geocortex.essentialsHtmlViewer.integration.protocol.HandshakeRequest){var n=e.componentId,i=this._getComponent(n);if(n&&i)switch(e.messageName){case geocortex.essentialsHtmlViewer.integration.protocol.RemoteDisconnect:this._handleRemoteComponentDisconnect(e);break;case geocortex.essentialsHtmlViewer.integration.protocol.RemotePublish:if(!(o=e.commandOrEventName))return void this.app.trace.warning("Message from integration bridge was missing the 'commandOrEventName' field.");try{this._commandOrEventSender=e.componentId,o.endsWith("Event")?this.app.event(o).publish(e.payload):this.app.command(o).execute(e.payload)}finally{this._commandOrEventSender=null}break;case geocortex.essentialsHtmlViewer.integration.protocol.RemoteSubscribe:if(!(o=e.commandOrEventName))return void this.app.trace.warning("Message from integration bridge was missing the 'commandOrEventName' field.");if(o.endsWith("Event")){if(this._eventSubscriptions[o])return;this._eventSubscriptions[o]=this.app.event(o).subscribe(this,function(e){t._sendToAll({messageName:geocortex.essentialsHtmlViewer.integration.protocol.RemotePublish,commandOrEventName:o,payload:e})})}else{if(this._commandSubscriptions[o])return;this._commandSubscriptions[o]=this.app.command(o).register(this,function(e){t._sendToAll({messageName:geocortex.essentialsHtmlViewer.integration.protocol.RemotePublish,commandOrEventName:o,payload:e})})}break;case geocortex.essentialsHtmlViewer.integration.protocol.RemoteUnsubscribe:var o=e.commandOrEventName;if(o.endsWith("Event")){a=this._eventSubscriptions[o];this.app.event(o).unsubscribe(a),delete this._eventSubscriptions[o]}else{var a=this._commandSubscriptions[o];this.app.command(o).unregister(a),delete this._commandSubscriptions[o]}}else this.app.trace.warning("Received a bridge message with missing or unknown component ID from sender. Discarding.")}else this._handleHandshakeRequest(e)},n.prototype._handleMapExtentChangedEvent=function(e,t){this._updateViewpoint(e)},n.prototype._handleApplicationResizedEvent=function(){var e=this;this._componentIgnoreUpdates=!0,this._ignoreUpdatesTimer=setTimeout(function(){e._componentIgnoreUpdates=!1},this._ignoreUpdateInterval)},n.prototype._updateViewpoint=function(e){var t=e.getCenter(),n={timestamp:(new Date).getTime(),extent:e,position:{x:t.x,y:t.y},scale:this.app.map.getScale(),heading:this._heading,pitch:this._pitch,updaterName:this._lastUpdaterName};this._currentViewpoint=n,this._lastUpdaterName=null,this._updateSyncedViewpointIndicator(t),this._broadcastViewpoint(n)},n.prototype._updateSyncedViewpointIndicator=function(e,t){this._connectedComponents.some(function(e){return e.sync})&&(e=e||this.app.map.extent.getCenter(),this._updateViewpointIndicator("sync",n.DEFAULT_VIEWPOINT_INDICATOR_URI,e,this._heading))},n.prototype._updateViewpointIndicator=function(e,t,n,i,o){var a=this;if(t){var s=this.app.site.getMap();if(s&&s.spatialReference){this._indicatorLayer||(this._indicatorLayer=p.getInternalGraphicsLayer(c.VIEWPOINT_INDICATOR_GRAPHICS_LAYER_ID,this.app,p.GraphicsLayerType.Pushpin),this._indicatorLayer.on("mouse-down",function(e){a._currentTool||a._onMouseDown(e)}),Modernizr.touch&&this._indicatorLayer.getNode().addEventListener("touchstart",function(e){a._onTouchStart(e)}));var d=this._getComponentGraphicId(e,o),m=t;"string"==typeof t&&(m=new esri.symbol.PictureMarkerSymbol(t,32,32));var l=r.firstOrDefault(this._indicatorLayer.graphics,function(e){return e.attributes&&e.attributes.ID===d});l?l.setSymbol(m):(l=new esri.Graphic(n,m,{ID:d},null),this._indicatorLayer.add(l)),this._updateViewpointIndicatorGraphic(l,n,i)}}},n.prototype._updateViewpointIndicatorGraphic=function(e,t,n){if(e&&t){if("number"==typeof n){var i=(n+45)%360;e.symbol.setAngle(i)}e.setGeometry(t)}},n.prototype._removeSyncedViewpointIndicator=function(){this._connectedComponents.some(function(e){return e.sync})||this._removeViewpointIndicator("sync")},n.prototype._removeViewpointIndicator=function(e,t){if(this._indicatorLayer){var n=this._getComponentGraphicId(e,t),i=r.firstOrDefault(this._indicatorLayer.graphics,function(e){return e.attributes&&e.attributes.ID===n});i&&this._indicatorLayer.remove(i)}},n.prototype._clearComponentViewpointIndicators=function(e){var t=this;this._indicatorLayer&&this._indicatorLayer.graphics.filter(function(t){return t.attributes&&t.attributes.ID.startsWith(e.name)}).forEach(function(e){return t._indicatorLayer.remove(e)})},n.prototype._executeUpdateComponentGraphic=function(e){var t=this.app.site.getMap();if(t&&t.spatialReference){this._graphicsLayer||(this._graphicsLayer=p.getInternalGraphicsLayer(c.INTEGRATION_GRAPHICS_LAYER_ID,this.app,p.GraphicsLayerType.Markup),t.addLayer(this._graphicsLayer));var n=this._getComponent(this._commandOrEventSender);if(n){var i=esri.geometry.fromJson(e.geometry),o=esri.symbol.fromJson(e.symbol);if(i)if(o){var a=this._getComponentGraphicId(n.name,e.id),s=r.firstOrDefault(this._graphicsLayer.graphics,function(e){return e.attributes&&e.attributes.ID===a});s?(s.setGeometry(i),s.setSymbol(o)):(s=new esri.Graphic(i,o,{ID:a},null),this._graphicsLayer.add(s))}else this.app.trace.warning("Couldn't create symbol from JSON");else this.app.trace.warning("Couldn't create geometry from JSON")}else this.app.trace.warning("Received a graphic update from an unrecognized component.")}},n.prototype._executeRemoveComponentGraphic=function(e){var t=this._getComponent(this._commandOrEventSender);if(t){if(this._graphicsLayer){var n=this._getComponentGraphicId(t.name,e),i=r.firstOrDefault(this._graphicsLayer.graphics,function(e){return e.attributes&&e.attributes.ID===n});i&&this._graphicsLayer.remove(i)}}else this.app.trace.warning("Received a graphic update from an unrecognized component.")},n.prototype._executeClearComponentGraphics=function(){var e=this._getComponent(this._commandOrEventSender);e?this._graphicsLayer&&this._clearComponentGraphics(e):this.app.trace.warning("Received a graphic update from an unrecognized component.")},n.prototype._clearComponentGraphics=function(e){var t=this;this._graphicsLayer&&this._graphicsLayer.graphics.filter(function(t){return t.attributes.ID.startsWith(e.name)}).forEach(function(e){return t._graphicsLayer.remove(e)})},n.prototype._executeUpdateComponentCustomIndicator=function(e){var t=this,n=this._getComponent(this._commandOrEventSender);if(n){var i=esri.geometry.fromJson(e.geometry),a=esri.symbol.fromJson(e.symbol);this._updateViewpointIndicator(n.name,a,i,null,e.id);var r=new esri.tasks.ProjectParameters;r.geometries=[i],r.outSR=n.preferredSpatialReference,o.project(r,function(i){var o=i[0];t._broadcastCustomViewpointUpdatedEvent(n,e.id,o)},function(e){t.app.trace.warning("An error occurred while attempting to project the current extent for third-party map components: "+e)},this.app)}else this.app.trace.warning("Received a graphic update from an unrecognized component.")},n.prototype._executeRemoveComponentCustomIndicator=function(e){var t=this._getComponent(this._commandOrEventSender);if(t){if(this._indicatorLayer){var n=this._getComponentGraphicId(t.name,e),i=r.firstOrDefault(this._indicatorLayer.graphics,function(e){return e.attributes&&e.attributes.ID===n});i&&this._indicatorLayer.remove(i)}}else this.app.trace.warning("Received a graphic update from an unrecognized component.")},n.prototype._executeClearComponentCustomIndicators=function(){var e=this._getComponent(this._commandOrEventSender);e?this._indicatorLayer&&this._clearComponentViewpointIndicators(e):this.app.trace.warning("Received a graphic update from an unrecognized component.")},n.prototype._onMouseDown=function(e){var t=this;if(e.preventDefault(),0===e.button){var n=e.graphic.attributes.ID;if("sync"!==n){var i=this._getComponentByName(n);if(i){this.app.map.disableMapNavigation(),this._ignoreUpdates=!0;var o=null,a=null,r=null,s=e.graphic,p=e.graphic.symbol.angle-45,c=function(e){e.preventDefault(),o.remove(),a.remove(),t._isIE?document.removeEventListener("mousemove",d):r.remove(),t._updateViewpointIndicatorComponent(i,s,e.mapPoint,p),t._ignoreUpdates=!1,t.app.map.enableMapNavigation()},d=function(e){if(e.preventDefault(),t._mapRoot){var n=t._mapRoot.getBoundingClientRect(),i=Math.ceil(n.left+document.body.scrollLeft),r=Math.ceil(n.top+document.body.scrollTop),s=e.pageX-i,p=e.pageY-r;(s<0||s>t.app.map.width||p<0||p>t.app.map.height)&&(o.remove(),a.remove(),document.removeEventListener("mousemove",d),t._ignoreUpdates=!1,t.app.map.enableMapNavigation())}};a=this.app.map.on("mouse-drag",function(e){e.preventDefault(),t._updateViewpointIndicatorComponent(i,s,e.mapPoint,p)}),o=this.app.map.on("mouse-up",c),this._isIE?document.addEventListener("mousemove",d):r=this.app.map.on("mouse-out",c)}else this.app.trace.warning("Viewpoint indicator is not associated with a remote component.")}}},n.prototype._onTouchStart=function(e){var t=this;e.preventDefault();var n=e.target.e_graphic.attributes.ID;if("sync"!==n){var i=this._getComponentByName(n);if(i){this.app.map.disableMapNavigation(),this._ignoreUpdates=!0;var o=e.target.e_graphic,a=o.symbol.angle-45,r=function(e){e.preventDefault(),t._updateViewpointIndicatorComponent(i,o,e.mapPoint,a)},s=function(e){e.preventDefault(),t.app.map.root.removeEventListener("touchmove",r),t.app.map.root.removeEventListener("touchend",s),t._updateViewpointIndicatorComponent(i,o,e.mapPoint,a),t._ignoreUpdates=!1,t.app.map.enableMapNavigation()};this.app.map.root.addEventListener("touchmove",r),this.app.map.root.addEventListener("touchend",s)}else this.app.trace.warning("Viewpoint indicator is not associated with a remote component.")}},n.prototype._updateViewpointIndicatorComponent=function(e,t,n,i){var a=this;if(void 0===i&&(i=0),e&&n){this._updateViewpointIndicatorGraphic(t,n,i);var r=new esri.tasks.ProjectParameters;r.geometries=[n],r.outSR=e.preferredSpatialReference,o.project(r,function(n){var i=n[0],o=t.attributes.ID;if(o===e.name||"sync"===o)e.transport.send({messageName:geocortex.essentialsHtmlViewer.integration.protocol.RemotePublish,commandOrEventName:"ViewpointIndicatorUpdatedEvent",payload:i});else{var r=a._getComponentGraphicIdFromGraphicId(e,o);a._broadcastCustomViewpointUpdatedEvent(e,r,i)}},function(e){a.app.trace.warning("An error occurred while attempting to project the current extent for third-party map components: "+e)},this.app)}},n.prototype._broadcastViewpoint=function(e,t,n){var i=this;void 0===n&&(n=!1);var a=t?[t]:this._connectedComponents;if(!this._componentIgnoreUpdates||n)for(var r=0;r<a.length;r++)if((t=a[r]).sync||n){var s=new esri.tasks.ProjectParameters;s.geometries=[this.app.map.extent],s.outSR=t.preferredSpatialReference,o.project(s,function(n){var o=n[0];e.extent=o,e.position=e.extent.getCenter(),i._ignoreUpdates=!0,i._ignoreUpdatesTimer=setTimeout(function(){i._ignoreUpdates=!1},i._ignoreUpdateInterval),t.transport.send({messageName:geocortex.essentialsHtmlViewer.integration.protocol.RemotePublish,commandOrEventName:"ViewerPositionUpdatedEvent",payload:e})},function(e){i.app.trace.warning("An error occurred while attempting to project the current extent for third-party map components: "+e)},this.app)}},n.prototype._broadcastCustomViewpointUpdatedEvent=function(e,t,n){e.transport.send({messageName:geocortex.essentialsHtmlViewer.integration.protocol.RemotePublish,commandOrEventName:"ComponentCustomViewpointIndicatorUpdatedEvent",payload:{id:t,geometry:n.toJson()}})},n.prototype._handleRemoteComponentInitialized=function(e,t){void 0===t&&(t=!0);var n=r.firstOrDefault(this._componentStates,function(t){return t.id===e.name});n&&(e.sync=n.sync);var i={viewpoint:null,sync:e.sync,hasPreviousState:!!n};n&&n.savedState&&(i.savedState=n.savedState),n&&!n.sync&&(i.viewpoint={extent:n.viewpoint.extent,heading:n.viewpoint.heading,pitch:n.viewpoint.pitch,position:n.viewpoint.center,scale:n.viewpoint.scale,updaterName:null}),e.transport.send({messageName:geocortex.essentialsHtmlViewer.integration.protocol.RemotePublish,commandOrEventName:"ExternalComponentInitializedEvent",payload:i}),n?n.sync?(this._broadcastViewpoint(this._currentViewpoint,e,!0),this._updateSyncedViewpointIndicator()):t&&this._updateViewpointIndicator(e.name,e.viewpointIndicatorUri,this._currentViewpoint.extent.getCenter(),n.viewpoint.heading):(this._broadcastViewpoint(this._currentViewpoint,e,!0),t&&this._updateViewpointIndicator(e.name,e.viewpointIndicatorUri,this._currentViewpoint.extent.getCenter(),0))},n.prototype._getComponentGraphicId=function(e,t){var n=e;return t&&(n+="___"+t),n},n.prototype._getComponentGraphicIdFromGraphicId=function(e,t){return t.replace(e.name+"___","")},n}(i.ModuleBase);m.DEFAULT_VIEWPOINT_INDICATOR_URI="Resources/Images/Icons/location-direction-blue-32.png",n.IntegrationModule=m})},"Mapping/modules/Integration/IntegrationModuleConfig":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"Mapping/modules/Integration/RemoteComponent":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"url:/Mapping/modules/Integration/ExternalComponentPaneView.html":t,"url:/Mapping/modules/Integration/ExternalComponentView.html":n}}),require(["geocortex/framework/resourceManager"],function(e){e.resourceManager.register("Mapping","inv","Mapping/modules/Integration/CSS/common.css","css","LyogSU5URUdSQVRJT04gU1RZTElORyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8NCi5pbnRlZ3JhdGlvbiB1bC5mdWktc2VsZWN0b3ItYm9keSBzcGFuIHsNCiAgICB2ZXJ0aWNhbC1hbGlnbjogdG9wOw0KICAgIGxpbmUtaGVpZ2h0OiAxLjZlbTsNCiAgICBmb250LXNpemU6IDAuOTVlbTsNCiAgICBkaXNwbGF5OiBpbmxpbmUtYmxvY2s7DQogICAgd2lkdGg6IDkzJTsNCn0NCg0KLkV4dGVybmFsQ29tcG9uZW50VmlldyAucGFuZWwtc2Nyb2xsLWNvbnRhaW5lciB7DQogICAgYm9yZGVyOiAwOw0KICAgIG92ZXJmbG93OiBoaWRkZW47DQp9DQoNCi5FeHRlcm5hbENvbXBvbmVudFZpZXcgLnBhbmVsLWhlYWRlciBpbWcgew0KICAgIGRpc3BsYXk6IGlubGluZS1ibG9jazsNCiAgICBtYXJnaW4tbGVmdDogMC43ZW07DQogICAgdmVydGljYWwtYWxpZ246IG1pZGRsZTsNCn0NCg0KLkV4dGVybmFsQ29tcG9uZW50VmlldyAucGFuZWwtaGVhZGVyIHsNCiAgICBib3JkZXI6IDA7DQp9DQoNCi5FeHRlcm5hbENvbXBvbmVudFZpZXcgLmZ1aS1zZWxlY3RvciB7DQogICAgdmVydGljYWwtYWxpZ246IG1pZGRsZTsNCn0NCg0KLkV4dGVybmFsQ29tcG9uZW50VmlldyAucGFuZWwtc2Nyb2xsLWNvbnRhaW5lciA+IC52aWV3IHsNCiAgICBkaXNwbGF5OiBpbmxpbmUtYmxvY2s7DQogICAgLyoqDQogICAgICogTm90ZTogSWYgeW91J3JlIGNoYW5naW5nIHRoZXNlIHByb3BlcnRpZXMsIHlvdSdyZSBjaGFuZ2luZyB0aGUgdG90YWwgc2l6ZSBvZiBleHRlcm5hbCBjb21wb25lbnQgcGFuZXMgYW5kIG11c3QNCiAgICAgKiBjaGFuZ2UgdGhlIHNpemUgcGFyYW1ldGVycyBpbiBjb2RlLiBTZWUgJ2hhbmRsZUFwcGxpY2F0aW9uUmVzaXplZEV2ZW50JyBpbiBFeHRlcm5hbENvbXBvbmVudFZpZXcuDQogICAgICovDQogICAgbWFyZ2luOiAwOw0KICAgIGJvcmRlcjogMXB4IHNvbGlkICNlZWU7DQp9DQoNCi5FeHRlcm5hbENvbXBvbmVudFZpZXcgLmZ1aS1zZWxlY3RvciB7DQogICAgcGFkZGluZzogMDsNCiAgICBtYXJnaW46IDA7DQogICAgd2lkdGg6IDE2ZW07DQogICAgZmxvYXQ6IG5vbmU7DQp9DQoNCi5FeHRlcm5hbENvbXBvbmVudFZpZXcgLnJlc2l6ZS1oZWFkZXIgew0KICAgIGJhY2tncm91bmQtY29sb3I6ICNGRkZGRkY7DQp9DQoNCi5pbnRlZ3JhdGlvbiAucGFuZSBpZnJhbWUgew0KICAgIHdpZHRoOiAxMDAlOw0KICAgIG1hcmdpbjogYXV0bzsNCiAgICBjbGVhcjogYm90aDsNCn0NCg0KLmludGVncmF0aW9uIC5wYW5lIHsNCiAgICBwYWRkaW5nOiAwOw0KICAgIG1hcmdpbjogMDsNCiAgICBvdmVyZmxvdy14OiBoaWRkZW47DQogICAgb3ZlcmZsb3cteTogaGlkZGVuOw0KICAgIGJhY2tncm91bmQ6ICNGRkZGRkY7DQp9DQoNCi5pbnRlZ3JhdGlvbi1vdmVybGF5IHsNCiAgICBwb3NpdGlvbjogYWJzb2x1dGU7DQogICAgbGVmdDogMDsNCiAgICB0b3A6IDA7DQogICAgcmlnaHQ6IDA7DQogICAgYm90dG9tOiAwOw0KICAgIG9wYWNpdHk6IDAuNTsNCn0NCg=="),e.resourceManager.register("Mapping","inv","Mapping/modules/Integration/CSS/large.css","css","LkV4dGVybmFsQ29tcG9uZW50VmlldyAucmVzaXplLWhlYWRlciB7DQogICAgaGVpZ2h0OiAwLjRlbTsNCn0="),e.resourceManager.register("Mapping","inv","Mapping/modules/Integration/CSS/medium.css","css","LkV4dGVybmFsQ29tcG9uZW50VmlldyAucmVzaXplLWhlYWRlciB7DQogICAgaGVpZ2h0OiAxLjVlbTsgICAgDQp9DQo="),e.resourceManager.register("Mapping","inv","Mapping/modules/Integration/ExternalComponentPaneView.html","html",t),e.resourceManager.register("Mapping","inv","Mapping/modules/Integration/ExternalComponentView.html","html",n)}),require({cache:{}}),define(["Mapping/modules/Integration/ExternalComponentPaneView","Mapping/modules/Integration/ExternalComponentPaneViewModel","Mapping/modules/Integration/ExternalComponentView","Mapping/modules/Integration/ExternalComponentViewModel","Mapping/modules/Integration/IntegrationModule"],function(t,n,i,o,a){e(t,"geocortex.essentialsHtmlViewer.mapping.modules.integration.ExternalComponentPaneView",t.ExternalComponentPaneView),e(n,"geocortex.essentialsHtmlViewer.mapping.modules.integration.ExternalComponentPaneViewModel",n.ExternalComponentPaneViewModel),e(i,"geocortex.essentialsHtmlViewer.mapping.modules.integration.ExternalComponentView",i.ExternalComponentView),e(o,"geocortex.essentialsHtmlViewer.mapping.modules.integration.ExternalComponentViewModel",o.ExternalComponentViewModel),e(a,"geocortex.essentialsHtmlViewer.mapping.modules.integration.IntegrationModule",a.IntegrationModule)})}();