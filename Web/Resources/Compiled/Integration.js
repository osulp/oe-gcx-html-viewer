!function(){var t="<div class='pane'>    <iframe frameborder='0' class='map-frame' data-binding='{@var: frameElement}{data-frame-id: frameId}{@visible: uri}{src: uri}{title: @language-integration-accessibility-frame-title}'></iframe></div>",n="<div class='view-container-view integration' data-binding='{@var: containerElement}'>    \x3c!-- BEGIN: Header --\x3e    <button class='bottom-panel-resize resize-handle' tabindex='-1' data-binding='{@visible: resizeY}{@event-mousedown: handleHeaderMouseDown}{@event-touchstart: handleHeaderTouchStart}{title: @language-integration-smart-panel-resize}'>        <span class='icon-drag'></span>    </button>    <div class='banner-noselect' data-binding='{@var: headerElement}{@event-mousedown: handleHeaderMouseDown}{@event-touchstart: handleHeaderTouchStart}                                                {@class-resize-horizontal-hint: resizeX}{@class-resize-vertical-hint: resizeY}'>        <div class='panel-header' data-binding='{@visible: headerIsVisible}'>            <button class=' panel-header-button right close-16' href='javascript:void(0)' data-binding='{@visible: showXButton}{@event-onclick: handleClickClose}{aria-label: @language-common-close}'>            </button>            <button class='panel-header-button right' data-binding='{@visible: showingMaximizeButton}{@class-minimize-16: panelMaximized}{@noclass-maximize-16: panelMaximized}{@event-onclick: handleMaximizeToggleClick}{@event-touchstart: handleMaximizeToggleClick}{title: @language-integration-smart-panel-maximize-restore}'></button>            <img data-binding='{@visible: selectorIconUri}{src: selectorIconUri}{alt: @language-integration-selector-icon}' />            <div data-binding='{@widget: Selector}{@widget-replace: true}'></div>        </div>        <div class='resize-header' data-binding='{@hidden: headerIsVisible}'></div>    </div>    <div class='panel-scroll-container' data-binding='{data-region-name: regionName}{data-region-adapter: regionType}{@var: scrollRegionElement}{@event-onscroll: handleScrollChange}'></div>    <div class='integration-overlay' data-binding='{@visible: overlayIsVisible}'></div></div>";function a(e,t,n){if("string"==typeof e&&(n=t,t=e),void 0!==n)for(var i=t.split("."),o=null,a=window,r=0,s=i.length;r<s;r++)o=i[r],r==s-1?a[o]=n:a[o]||(a[o]={}),a=a[o];else console.warn("Undefined shim for: "+t)}require({cache:{"Mapping/modules/Integration/ExternalComponent":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"Mapping/modules/Integration/ExternalComponentPaneView":function(){var i,s=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});define(["require","exports","geocortex/infrastructure/ui/components/MultiPane/PaneView","geocortex/framework/utils/utils"],function(e,t,n,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o,a=(o=n.PaneView,s(r,o),r.prototype.attach=function(e){var t=this;o.prototype.attach.call(this,e);var n="iframe[data-frame-id='{0}']".format(e.frameId);i.addEventListener(this.frameElement,"load",function(){t.app.command("ListenToExternalComponentFrame").execute({elementSelector:n,name:t.viewModel.currentPaneItem.get().id,viewpointIndicatorUri:t.viewModel.currentPaneItem.get().viewpointIndicatorUri})})},r);function r(){return null!==o&&o.apply(this,arguments)||this}t.ExternalComponentPaneView=a})},"Mapping/modules/Integration/ExternalComponentPaneViewModel":function(){var i,p=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});define(["require","exports","geocortex/infrastructure/ui/components/MultiPane/PaneViewModel","geocortex/framework/observables","geocortex/framework/utils/utils"],function(e,t,n,i,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a,r=(a=n.PaneViewModel,p(s,a),s.prototype.initialize=function(e){a.prototype.initialize.call(this,e),this.frameId="frame-"+o.alphaNumericToken(),e&&e.hasOwnProperty("uri")&&this.uri.set(e.uri)},s);function s(){var e=null!==a&&a.apply(this,arguments)||this;return e.uri=new i.Observable(""),e}t.ExternalComponentPaneViewModel=r})},"Mapping/modules/Integration/ExternalComponentPaneViewModelConfig":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"Mapping/modules/Integration/ExternalComponentView":function(){var i,c=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});define(["require","exports","geocortex/infrastructure/ui/components/MultiPane/MultiPaneView","geocortex/framework-ui/Selector/SelectorViewModel","./ExternalComponentPaneViewModel","geocortex/framework/utils/utils"],function(e,t,n,o,i,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r,s=(r=n.MultiPaneView,c(p,r),p.prototype.attach=function(e){r.prototype.attach.call(this,e),this._registerCommands()},p.prototype.deactivated=function(){r.prototype.deactivated.call(this),this._notificationDisplayed=!1,this.app.command("RemoveNotification").execute(this._notificationViewId)},p.prototype.resolveWidget=function(e,t,n){var i=this;return"Selector"===e?(this._selectorView=this.app.viewManager.createView({typeName:"geocortex.framework.ui.Selector.SelectorView",markupResource:"Framework.UI/geocortex/framework/ui/Selector/SelectorView.html",isVisible:!0,libraryId:"Framework.UI"}),this.selector=new o.SelectorViewModel(this.app,this.libraryId,!!this.app.configuration.mobileMode,!!this.app.configuration.mobileMode),this.selector.setCollection(this.viewModel.paneItems,"displayName",null),this.selector.selectorText.set(this.viewModel.selectorText.get()||this.app.getResource(this.libraryId,"language-integration-selector-text")),this.selector.noItemsText.set(this.app.getResource(this.libraryId,"language-integration-no-items")),this.selector.onSelectItem=function(e){return i.handleSelectPane(e.item)},this.selector.onUnselectItem=function(e){return i.handleUnSelectPane(e.item)},this._selectorView.attach(this.selector),this._selectorView):r.prototype.resolveWidget.call(this,e,t,null)},p.prototype.handleUnSelectPane=function(e){this.destroyPaneItemById(e.id)},p.prototype.handleClickClose=function(){this.clearDockedPaneItems(),this.deactivateContainer()},p.prototype.addPaneItem=function(e){if(!e||!this.canAddPaneItem(e))return null;this.viewModel.displayedPaneItems.addItem(e),this.app.command("ActivateView").execute(this.id);var t=new i.ExternalComponentPaneViewModel(this.app,this.libraryId);t.currentPaneItem.set(e),t.initialize({uri:e.uri});var n=this.app.viewManager.createView({typeName:"geocortex.essentialsHtmlViewer.mapping.modules.integration.ExternalComponentPaneView",markupResource:"Mapping/modules/Integration/ExternalComponentPaneView.html",libraryId:this.libraryId||"Mapping",regionName:this.viewModel.regionName.get(),isVisible:!0});return this._panes.push(n),n.attach(t),this.selector.selectItem(e),this.handleApplicationResizedEvent(),n},p.prototype.destroyPaneItemById=function(e,t){void 0===t&&(t=!1);var n=this.viewModel.findUndockedPaneItemById(e);n?this.destroyUndockedPaneItem(n):t||(n=this.viewModel.findDisplayedPaneItemById(e),this.destroyPaneItem(n))},p.prototype.destroyPaneItem=function(e){var t=r.prototype.destroyPaneItem.call(this,e);return this.viewModel.haveDockedPanes()||this.app.command("DeactivateView").execute(this.id),t},p.prototype.destroyUndockedPaneItem=function(e){e&&this.viewModel.isUndockedPaneItem(e)&&(e.window&&(e.window.close(),e.window=null),this.viewModel.undockedPaneItems.removeItem(e),this.viewModel.displayedPaneItems.removeItem(e),this.selector.unselectItem(e))},p.prototype.clearDockedPaneItems=function(){for(var e=this.viewModel.displayedPaneItems.getLength();e--;){var t=this.viewModel.displayedPaneItems.getAt(e);this.viewModel.isDockedPaneItem(t)&&this.destroyPaneItem(t)}},p.prototype.dockPaneItemById=function(e){var t=this,n=this.viewModel.findPaneItemById(e);this.viewModel.isUndockedPaneItem(n)&&this.destroyUndockedPaneItem(n),setTimeout(function(){t.addPaneItem(n)},this._windowUnloadInterval)},p.prototype.undockPaneItemById=function(e){var t=this;if("Tablet"===this.app.shellName||this._isIE9)return this.app.trace.warning("Undocking an external component is not supported."),void this.dockPaneItemById(e);var n=this.viewModel.findPaneItemById(e);if(n)if(!n.window||n.window.opener===n.window||n.window.closed){var i=n.id.replace(/\W/g,""),o=window.open(n.uri,i);this.app.command("ListenToExternalComponentFrame").execute({elementSelector:null,name:n.id,contentWindow:o,viewpointIndicatorUri:n.viewpointIndicatorUri}),setTimeout(function(){a.addEventListener(o,"unload",function(){t.destroyPaneItemById(n.id,!0)})},this._windowLoadInterval),this.viewModel.isDockedPaneItem(n)&&this.destroyPaneItem(n),this.viewModel.haveDockedPanes()||this.app.command("DeactivateView").execute(this.id),n.window=o,this.viewModel.undockedPaneItems.addItem(n),this.viewModel.displayedPaneItems.addItem(n),this.selector.selectItem(n)}else n.window.focus()},p.prototype.handleApplicationResizedEvent=function(){r.prototype.handleApplicationResizedEvent.call(this);var e=this.scrollRegionElement,t=$(".view .pane .map-frame",e);0!==t.length&&setTimeout(function(){$(t).height(e.clientHeight)})},p.prototype._registerCommands=function(){var t=this;this.app.command("ShowExternalComponentView").register(this,this._executeShowExternalComponentView,this._canExecuteExternalComponentView),this.app.command("DisplayDockedExternalComponentById").register(this,this.dockPaneItemById),this.app.command("DisplayUndockedExternalComponentById").register(this,this.undockPaneItemById),this.app.command("RemoveExternalComponentById").register(this,this.destroyPaneItemById),this.app.event("ActiveToolChangedEvent").subscribe(this,function(e){t._currentTool=e.tool,t._currentTool||t._notificationDisplayed||!t.isActive||t._showNotificationMessage()})},p.prototype._siteInitialized=function(){var e=this;this.app.command("ShowExternalComponentView").raiseCanExecuteChanged(),a.addEventListener(window,"unload",function(){e.viewModel.undockedPaneItems.getItems().forEach(function(e){e.window.close()})})},p.prototype._executeShowExternalComponentView=function(){this._executeShowMultiPaneView(),this._currentTool||this._showNotificationMessage()},p.prototype._showNotificationMessage=function(){var e=this.viewModel.statusText.get();if(e){var t={id:this._notificationViewId,text:e,closeButton:{}};this._notificationDisplayed=!0,this.app.command("DisplayNotification").execute(t)}},p.prototype._canExecuteExternalComponentView=function(){return this.viewModel&&0<this.viewModel.paneItems.getLength()},p);function p(e,t){var n=r.call(this,e,t)||this;return n._notificationViewId="externalComponentStatusMessageView",n._windowUnloadInterval=500,n._windowLoadInterval=250,n._isIE9=!1,n._notificationDisplayed=!1,n.app.site&&n.app.site.isInitialized?n._siteInitialized():n.app.event("SiteInitializingEvent").once(n,n._siteInitialized),n._isIE9=$(document.documentElement).hasClass("dj_ie9"),n}t.ExternalComponentView=s})},"Mapping/modules/Integration/ExternalComponentViewModel":function(){var i,p=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});define(["require","exports","geocortex/infrastructure/ui/components/MultiPane/MultiPaneViewModel","geocortex/framework/observables","geocortex/framework/utils/ArrayUtils"],function(e,t,n,i,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o,r=(o=n.MultiPaneViewModel,p(s,o),s.prototype.initialize=function(e){o.prototype.initialize.call(this,e),e&&(e.hasOwnProperty("externalComponents")&&this.paneItems.addItems(e.externalComponents),e.hasOwnProperty("defaultComponents")&&this.setDefaultComponents(e.defaultComponents),e.hasOwnProperty("statusText")&&this.statusText.set(e.statusText)),this._registerCommandsAndEvents()},s.prototype.setDefaultComponents=function(e){if(0!==this.paneItems.length()){for(var t=function(t){var e=a.firstOrDefault(n.paneItems.getItems(),function(e){return e.id===t});n.defaultPaneItems.addItem(e)},n=this,i=0,o=e;i<o.length;i++)t(o[i]);0===this.defaultPaneItems.getLength()&&this.defaultPaneItems.addItem(this.paneItems.getAt(0))}},s.prototype.findUndockedPaneItemById=function(t){return a.firstOrDefault(this.undockedPaneItems.getItems(),function(e){return e.id&&e.id===t})},s.prototype.isUndockedPaneItem=function(e){return a.contains(this.undockedPaneItems.getItems(),e)},s.prototype.isDockedPaneItem=function(e){return a.contains(this.displayedPaneItems.getItems(),e)&&!a.contains(this.undockedPaneItems.getItems(),e)},s.prototype.haveDockedPanes=function(){return this.displayedPaneItems.length()>this.undockedPaneItems.length()},s.prototype._registerCommandsAndEvents=function(){var e=this;this.app.event("MapMouseDownEvent").subscribe(this,function(){return e.overlayIsVisible.set(!0)}),this.app.event("MapMouseUpEvent").subscribe(this,function(){return e.overlayIsVisible.set(!1)}),this.app.event("PanelResizeStartEvent").subscribe(this,function(){return e.overlayIsVisible.set(!0)}),this.app.event("PanelResizeEndEvent").subscribe(this,function(){return e.overlayIsVisible.set(!1)})},s);function s(){var e=null!==o&&o.apply(this,arguments)||this;return e.undockedPaneItems=new i.ObservableCollection,e.overlayIsVisible=new i.Observable(!1),e.statusText=new i.Observable(""),e}t.ExternalComponentViewModel=r})},"Mapping/modules/Integration/ExternalComponentViewModelConfig":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"Mapping/modules/Integration/IntegrationModule":function(){var i,h=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});define(["require","exports","geocortex/framework/application/ModuleBase","geocortex/infrastructure/GeometryUtils","geocortex/framework/utils/utils","geocortex/framework/utils/ArrayUtils","geocortex/essentials/utilities/GraphicsLayerUtilities","geocortex/infrastructure/GraphicsLayerUtils","geocortex/infrastructure/GraphicsLayerIds","geocortex/infrastructure/BrowserUtils","geocortex/infrastructure/PortalUtils"],function(e,t,n,c,p,d,i,l,m,o,u){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a,r=(a=n.ModuleBase,h(s,a),s.prototype.initialize=function(e){var t=this;this._incomingMessageTransport=new geocortex.essentialsHtmlViewer.integration.PostMessageTransport(window,null,"Viewer"),this._incomingMessageTransport.allowOrigin("{0}//{1}".format(window.location.protocol,window.location.host)),this._incomingMessageTransport.onMessage=function(e){return t._handleBridgeMessage(e)},e.allowedOrigins&&e.allowedOrigins.forEach(function(e){return t._incomingMessageTransport.allowOrigin(e)}),0<o.isInternetExplorerOrEdge()&&(this._isIE=!0,this.app.doWhenMapInitialized(function(){return t._mapRoot=document.getElementById("map_root")})),i.addToGraphicsLayerIdsToExclude([l.ExcludeFromEnum.ExportApplyStateName,l.ExcludeFromEnum.ExportMapTaskName,l.ExcludeFromEnum.WebMapName],m.VIEWPOINT_INDICATOR_GRAPHICS_LAYER_ID),i.addToGraphicsLayerIdsToExclude([l.ExcludeFromEnum.ExportApplyStateName,l.ExcludeFromEnum.WebMapName],m.INTEGRATION_GRAPHICS_LAYER_ID),this._registerCommandsAndEvents()},s.prototype.onDestroy=function(){this._mouseDownHandle.remove(),this._mouseWheelHandle.remove(),this.app.command("StepZoomIn").postExecute.unsubscribe(this._stepZoomInHandle),this.app.command("StepZoomOut").postExecute.unsubscribe(this._stepZoomOutHandle)},s.prototype._registerCommandsAndEvents=function(){var t=this;this.app.command("ListenToExternalComponentFrame").register(this,this._executeListenToExternalComponentFrame),this.app.command("ToggleExternalComponentSyncById").register(this,this._executeToggleExternalComponentSyncById),this.app.command("DisableUpdateOnDragById").register(this,this._executeDisableUpdateOnDragById),this.app.command("BroadcastCurrentViewpoint").register(this,this._executeBroadcastCurrentViewpoint),this.app.command("UpdateComponentGraphic").register(this,this._executeUpdateComponentGraphic),this.app.command("RemoveComponentGraphic").register(this,this._executeRemoveComponentGraphic),this.app.command("ClearComponentGraphics").register(this,this._executeClearComponentGraphics),this.app.command("UpdateComponentIndicator").register(this,this._executeUpdateComponentCustomIndicator),this.app.command("RemoveComponentIndicator").register(this,this._executeRemoveComponentCustomIndicator),this.app.command("ClearComponentIndicators").register(this,this._executeClearComponentCustomIndicators),this.app.event("ComponentViewpointUpdatedEvent").subscribe(this,this._handleComponentViewpointUpdatedEvent),this.app.event("MapExtentChangedEvent").subscribe(this,this._handleMapExtentChangedEvent),this.app.event("ApplicationResizedEvent").subscribe(this,this._handleApplicationResizedEvent),this.app.event("ActiveToolChangedEvent").subscribe(this,function(e){return t._currentTool=e.tool})},s.prototype._handleComponentViewpointUpdatedEvent=function(n){var i=this;if(n){var o=this._getComponent(this._commandOrEventSender);if(o){var e;this._lastUpdaterName=o.id,(e=n.extent?new esri.geometry.Extent(n.extent):new esri.geometry.Point(n.center)).spatialReference=e.spatialReference||o.preferredSpatialReference;var t=new esri.tasks.ProjectParameters;t.geometries=[e],t.outSR=this.app.map.spatialReference,c.project(t,function(e){var t=e[0];t instanceof esri.geometry.Extent?o.sync&&!i._ignoreUpdates?(i.app.command("ZoomToExtent").execute(t),i._updateViewpointIndicator(o.name,o.viewpointIndicatorUri,t.getCenter(),n.heading)):o.sync||i._updateViewpointIndicator(o.name,o.viewpointIndicatorUri,t.getCenter(),n.heading):o.sync&&!i._ignoreUpdates?(n.scale&&n.scale!==i._previousScale&&(i._previousScale=n.scale,i.app.command("ZoomToScale").execute(n.scale)),i.app.command("PanToPoint").execute(t),i._updateViewpointIndicator(o.name,o.viewpointIndicatorUri,t,n.heading)):o.sync||i._updateViewpointIndicator(o.name,o.viewpointIndicatorUri,t,n.heading)},function(e){i.app.trace.warning("An error occurred while attempting to project the current extent for third-party map components: "+e)},this.app)}else this.app.trace.warning("Received a viewpoint update from an unrecognized component.")}},s.prototype._executeBroadcastCurrentViewpoint=function(e){var t=this._getComponentByName(e);if(t){var n=this._currentViewpoint;this._lastUpdaterName=null,n.updaterName=this._lastUpdaterName,this._updateViewpointIndicator(t.name,t.viewpointIndicatorUri,n.extent.getCenter(),n.heading),this._broadcastViewpoint(n,t,!0)}else this.app.trace.warning("Received a broadcast request from an unrecognized component.")},s.prototype._executeListenToExternalComponentFrame=function(e){var t=$(e.elementSelector,this.app.getHostElement())[0],n=t?t.contentWindow:e.contentWindow;if(n){var i=p.alphaNumericToken(32),o=e.name,a={id:i,name:o,transport:new geocortex.essentialsHtmlViewer.integration.PostMessageTransport(null,n,o),preferredSpatialReference:new esri.SpatialReference({wkid:4326}),sync:!1,updateOnDrag:!0,viewpointIndicatorUri:e.viewpointIndicatorUri};this._connectedComponents.push(a)}else this.app.trace.error("Could not listen to remote component. No element to listen to found for selector '{0}' and no context window provided.".format(e.elementSelector))},s.prototype._executeToggleExternalComponentSyncById=function(e){var t=this._getComponentByName(e);if(t){if(t.sync=!t.sync,t.sync){var n=this._currentViewpoint;n.updaterName=null,this._broadcastViewpoint(n,t)}this._updateViewpointIndicator(t.name,t.viewpointIndicatorUri,this.app.map.extent.getCenter())}else this.app.trace.warning("Received a sync update from an unrecognized component.")},s.prototype._executeDisableUpdateOnDragById=function(e){var t=this._getComponentByName(e);t?t.updateOnDrag=!1:this.app.trace.warning("Received a sync update from an unrecognized component.")},s.prototype._handleHandshakeRequest=function(e){if(e.payload){var t,n,i;"string"==typeof e.payload?t=e.payload:(t=e.payload.id,n=e.payload.addViewpointIndicator,i=e.payload.sharedArcGISToken);var o=this._getComponentByName(t);if(o){var a,r;if(i){var s=p.getProp(this,["app","site","principal","tokens","arcgis"]);s&&0<Object.keys(s).length&&(a=s[Object.keys(s)[0]]),r=u.getPortalBaseUrl(this.app)}o.transport.send({messageName:geocortex.essentialsHtmlViewer.integration.protocol.HandshakeResponse,componentId:o.id,token:a,portalUrl:r,indicatorUrl:o.viewpointIndicatorUri}),this._handleRemoteComponentInitialized(o,n)}else this.app.trace.warning("Received a handshake request from an unrecognized component.")}else this.app.trace.warning("Received a handshake request without a specified id.")},s.prototype._handleRemoteComponentDisconnect=function(e){var t=this._getComponent(e.componentId);t?(e.payload&&this._updateComponentState(e.payload),this._removeComponent(e.componentId),t.sync&&this._removeSyncedViewpointIndicator(),this._clearComponentViewpointIndicators(t),this._clearComponentGraphics(t)):this.app.trace.warning("An unknown component broadcasted a disconnect message.")},s.prototype._updateComponentState=function(t){var e=d.firstOrDefault(this._componentStates,function(e){return e.id===t.id});e&&d.removeItem(this._componentStates,e),this._componentStates.push(t)},s.prototype._removeComponent=function(e){var t=this._getComponent(e);if(!t)return!1;var n=this._connectedComponents.indexOf(t);return!(n<0||(this._connectedComponents.splice(n,1),0))},s.prototype._sendToAll=function(n,e){var i=this;this._connectedComponents.forEach(function(t){if(!e||t.id!==e)try{t.transport.send(n)}catch(e){i.app.trace.warning("Could not send message '{0}' to component '{1}' (ID: '{2}'): {3}".format(n.messageName,t.name,t.id,e))}})},s.prototype._sendTo=function(e,t){var n=this._getComponent(e);n&&n.transport.send(t)},s.prototype._getComponent=function(t){var e=this._connectedComponents.filter(function(e){return e.id===t})[0];return e||(this.app.trace.warning("Could not find connected component with ID '{0}'.".format(t)),null)},s.prototype._getComponentByName=function(t){var e=this._connectedComponents.filter(function(e){return t===e.name})[0];return(e=e||this._connectedComponents.filter(function(e){return t.startsWith(e.name)})[0])||(this.app.trace.warning("Could not find connected component with name '{0}'.".format(t)),null)},s.prototype._handleBridgeMessage=function(e){var t=this;if(e.messageName!==geocortex.essentialsHtmlViewer.integration.protocol.HandshakeRequest){var n,i=e.componentId,o=this._getComponent(i);if(i&&o)switch(e.messageName){case geocortex.essentialsHtmlViewer.integration.protocol.RemoteDisconnect:this._handleRemoteComponentDisconnect(e);break;case geocortex.essentialsHtmlViewer.integration.protocol.RemotePublish:if(!(n=e.commandOrEventName))return void this.app.trace.warning("Message from integration bridge was missing the 'commandOrEventName' field.");try{this._commandOrEventSender=e.componentId,n.endsWith("Event")?this.app.event(n).publish(e.payload):this.app.command(n).execute(e.payload)}finally{this._commandOrEventSender=null}break;case geocortex.essentialsHtmlViewer.integration.protocol.RemoteSubscribe:if(!(n=e.commandOrEventName))return void this.app.trace.warning("Message from integration bridge was missing the 'commandOrEventName' field.");if(n.endsWith("Event")){if(this._eventSubscriptions[n])return;this._eventSubscriptions[n]=this.app.event(n).subscribe(this,function(e){t._sendToAll({messageName:geocortex.essentialsHtmlViewer.integration.protocol.RemotePublish,commandOrEventName:n,payload:e})})}else{if(this._commandSubscriptions[n])return;this._commandSubscriptions[n]=this.app.command(n).register(this,function(e){t._sendToAll({messageName:geocortex.essentialsHtmlViewer.integration.protocol.RemotePublish,commandOrEventName:n,payload:e})})}break;case geocortex.essentialsHtmlViewer.integration.protocol.RemoteUnsubscribe:if((n=e.commandOrEventName).endsWith("Event")){var a=this._eventSubscriptions[n];this.app.event(n).unsubscribe(a),delete this._eventSubscriptions[n]}else a=this._commandSubscriptions[n],this.app.command(n).unregister(a),delete this._commandSubscriptions[n]}else this.app.trace.warning("Received a bridge message with missing or unknown component ID from sender. Discarding.")}else this._handleHandshakeRequest(e)},s.prototype._handleMapExtentChangedEvent=function(e,t){this._updateViewpoint(e)},s.prototype._handleApplicationResizedEvent=function(){var e=this;this._componentIgnoreUpdates=!0,this._ignoreUpdatesTimer=setTimeout(function(){e._componentIgnoreUpdates=!1},this._ignoreUpdateInterval)},s.prototype._updateViewpoint=function(e){var t=e.getCenter(),n={timestamp:(new Date).getTime(),extent:e,position:{x:t.x,y:t.y},scale:this.app.map.getScale(),heading:null,pitch:null,updaterName:this._lastUpdaterName};this._currentViewpoint=n,this._lastUpdaterName=null,this._updateSyncedViewpointIndicators(t),this._broadcastViewpoint(n)},s.prototype._updateSyncedViewpointIndicators=function(e,t){e=e||this.app.map.extent.getCenter();for(var n=0,i=this._connectedComponents.filter(function(e){return e.sync});n<i.length;n++){var o=i[n];this._updateViewpointIndicator(o.name,o.viewpointIndicatorUri,e,t)}},s.prototype._updateViewpointIndicator=function(e,t,n,i,o){var a=this;if(t){var r=this.app.site.getMap();if(r&&r.spatialReference){this._indicatorLayer||(this._indicatorLayer=l.getInternalGraphicsLayer(m.VIEWPOINT_INDICATOR_GRAPHICS_LAYER_ID,this.app,l.GraphicsLayerType.Pushpin),this._indicatorLayer.on("mouse-down",function(e){a._currentTool||a._onMouseDown(e)}),Modernizr.touch&&this._indicatorLayer.getNode().addEventListener("touchstart",function(e){a._onTouchStart(e)}),this._mouseDownHandle=this.app.map.on("mouse-down",function(){return a._lastUpdaterName=null}),this._mouseWheelHandle=this.app.map.on("mouse-wheel",function(){return a._lastUpdaterName=null}),this._stepZoomInHandle=this.app.command("StepZoomIn").postExecute.subscribe(this,function(){return a._lastUpdaterName=null}),this._stepZoomOutHandle=this.app.command("StepZoomOut").postExecute.subscribe(this,function(){return a._lastUpdaterName=null}));var s=this._getComponentGraphicId(e,o),p=d.firstOrDefault(this._indicatorLayer.graphics,function(e){return e.attributes&&e.attributes.ID===s});if(!p){var c=t;"string"==typeof t&&(c=new esri.symbol.PictureMarkerSymbol(t,32,32)),p=new esri.Graphic(n,c,{ID:s},null),this._indicatorLayer.add(p)}this._updateViewpointIndicatorGraphic(p,n,i)}}},s.prototype._updateViewpointIndicatorGraphic=function(e,t,n){if(e&&t){if("number"==typeof n){var i=(n+45)%360;e.symbol.setAngle(i)}e.setGeometry(t)}},s.prototype._removeSyncedViewpointIndicator=function(){this._connectedComponents.some(function(e){return e.sync})||this._removeViewpointIndicator("sync")},s.prototype._removeViewpointIndicator=function(e,t){if(this._indicatorLayer){var n=this._getComponentGraphicId(e,t),i=d.firstOrDefault(this._indicatorLayer.graphics,function(e){return e.attributes&&e.attributes.ID===n});i&&this._indicatorLayer.remove(i)}},s.prototype._clearComponentViewpointIndicators=function(t){var n=this;this._indicatorLayer&&this._indicatorLayer.graphics.filter(function(e){return e.attributes&&e.attributes.ID.startsWith(t.name)}).forEach(function(e){return n._indicatorLayer.remove(e)})},s.prototype._executeUpdateComponentGraphic=function(e){var t=this.app.site.getMap();if(t&&t.spatialReference){this._graphicsLayer||(this._graphicsLayer=l.getInternalGraphicsLayer(m.INTEGRATION_GRAPHICS_LAYER_ID,this.app,l.GraphicsLayerType.Markup),t.addLayer(this._graphicsLayer));var n=this._getComponent(this._commandOrEventSender);if(n){var i=esri.geometry.fromJson(e.geometry),o=esri.symbol.fromJson(e.symbol);if(i)if(o){var a=this._getComponentGraphicId(n.name,e.id),r=d.firstOrDefault(this._graphicsLayer.graphics,function(e){return e.attributes&&e.attributes.ID===a});r?(r.setGeometry(i),r.setSymbol(o)):(r=new esri.Graphic(i,o,{ID:a},null),this._graphicsLayer.add(r))}else this.app.trace.warning("Couldn't create symbol from JSON");else this.app.trace.warning("Couldn't create geometry from JSON")}else this.app.trace.warning("Received a graphic update from an unrecognized component.")}},s.prototype._executeRemoveComponentGraphic=function(e){var t=this._getComponent(this._commandOrEventSender);if(t){if(this._graphicsLayer){var n=this._getComponentGraphicId(t.name,e),i=d.firstOrDefault(this._graphicsLayer.graphics,function(e){return e.attributes&&e.attributes.ID===n});i&&this._graphicsLayer.remove(i)}}else this.app.trace.warning("Received a graphic update from an unrecognized component.")},s.prototype._executeClearComponentGraphics=function(){var e=this._getComponent(this._commandOrEventSender);e?this._graphicsLayer&&this._clearComponentGraphics(e):this.app.trace.warning("Received a graphic update from an unrecognized component.")},s.prototype._clearComponentGraphics=function(t){var n=this;this._graphicsLayer&&this._graphicsLayer.graphics.filter(function(e){return e.attributes.ID.startsWith(t.name)}).forEach(function(e){return n._graphicsLayer.remove(e)})},s.prototype._executeUpdateComponentCustomIndicator=function(n){var i=this,o=this._getComponent(this._commandOrEventSender);if(o){var e=esri.geometry.fromJson(n.geometry),t=esri.symbol.fromJson(n.symbol);this._updateViewpointIndicator(o.name,t,e,null,n.id);var a=new esri.tasks.ProjectParameters;a.geometries=[e],a.outSR=o.preferredSpatialReference,c.project(a,function(e){var t=e[0];i._broadcastCustomViewpointUpdatedEvent(o,n.id,t)},function(e){i.app.trace.warning("An error occurred while attempting to project the current extent for third-party map components: "+e)},this.app)}else this.app.trace.warning("Received a graphic update from an unrecognized component.")},s.prototype._executeRemoveComponentCustomIndicator=function(e){var t=this._getComponent(this._commandOrEventSender);if(t){if(this._indicatorLayer){var n=this._getComponentGraphicId(t.name,e),i=d.firstOrDefault(this._indicatorLayer.graphics,function(e){return e.attributes&&e.attributes.ID===n});i&&this._indicatorLayer.remove(i)}}else this.app.trace.warning("Received a graphic update from an unrecognized component.")},s.prototype._executeClearComponentCustomIndicators=function(){var e=this._getComponent(this._commandOrEventSender);e?this._indicatorLayer&&this._clearComponentViewpointIndicators(e):this.app.trace.warning("Received a graphic update from an unrecognized component.")},s.prototype._onMouseDown=function(e){var r=this;if(e.preventDefault(),0===e.button){var t=e.graphic.attributes.ID,n=this._getComponentByName(t);if(n){if(!n.sync){this.app.map.disableMapNavigation(),this._ignoreUpdates=!0;var s=null,p=null,i=null,o=e.graphic,a=e.graphic.symbol.angle-45,c=function(e){e.preventDefault(),s.remove(),p.remove(),r._isIE?document.removeEventListener("mousemove",d):i.remove(),r._updateViewpointIndicatorComponent(n,o,e.mapPoint,a,!0),r._ignoreUpdates=!1,r.app.map.enableMapNavigation()},d=function(e){if(e.preventDefault(),r._mapRoot){var t=r._mapRoot.getBoundingClientRect(),n=Math.ceil(t.left+document.body.scrollLeft),i=Math.ceil(t.top+document.body.scrollTop),o=e.pageX-n,a=e.pageY-i;(o<0||o>r.app.map.width||a<0||a>r.app.map.height)&&(s.remove(),p.remove(),document.removeEventListener("mousemove",d),r._ignoreUpdates=!1,r.app.map.enableMapNavigation())}};p=this.app.map.on("mouse-drag",function(e){e.preventDefault(),r._updateViewpointIndicatorComponent(n,o,e.mapPoint,a,!1)}),s=this.app.map.on("mouse-up",c),this._isIE?document.addEventListener("mousemove",d):i=this.app.map.on("mouse-out",c)}}else this.app.trace.warning("Viewpoint indicator is not associated with a remote component.")}},s.prototype._onTouchStart=function(e){var t=this;e.preventDefault();var n=e.target.e_graphic.attributes.ID;if("sync"!==n){var i=this._getComponentByName(n);if(i){this.app.map.disableMapNavigation(),this._ignoreUpdates=!0;var o=e.target.e_graphic,a=o.symbol.angle-45,r=function(e){e.preventDefault(),t._updateViewpointIndicatorComponent(i,o,e.mapPoint,a,!1)},s=function(e){e.preventDefault(),t.app.map.root.removeEventListener("touchmove",r),t.app.map.root.removeEventListener("touchend",s),t._updateViewpointIndicatorComponent(i,o,e.mapPoint,a,!0),t._ignoreUpdates=!1,t.app.map.enableMapNavigation()};this.app.map.root.addEventListener("touchmove",r),this.app.map.root.addEventListener("touchend",s)}else this.app.trace.warning("Viewpoint indicator is not associated with a remote component.")}},s.prototype._updateViewpointIndicatorComponent=function(o,a,e,t,n){var r=this;if(void 0===t&&(t=0),o&&e&&(this._updateViewpointIndicatorGraphic(a,e,t),n||o.updateOnDrag)){var i=new esri.tasks.ProjectParameters;i.geometries=[e],i.outSR=o.preferredSpatialReference,c.project(i,function(e){var t=e[0],n=a.attributes.ID;if(n===o.name)o.transport.send({messageName:geocortex.essentialsHtmlViewer.integration.protocol.RemotePublish,commandOrEventName:"ViewpointIndicatorUpdatedEvent",payload:t});else{var i=r._getComponentGraphicIdFromGraphicId(o,n);r._broadcastCustomViewpointUpdatedEvent(o,i,t)}},function(e){r.app.trace.warning("An error occurred while attempting to project the current extent for third-party map components: "+e)},this.app)}},s.prototype._broadcastViewpoint=function(i,e,t){var o=this;void 0===t&&(t=!1);var n=e?[e]:this._connectedComponents;if(!this._componentIgnoreUpdates||t)for(var a=function(n){if(!n.sync&&!t)return"continue";var e=new esri.tasks.ProjectParameters;e.geometries=[r.app.map.extent],e.outSR=n.preferredSpatialReference,c.project(e,function(e){var t=e[0];i.extent=t,i.position=i.extent.getCenter(),o._ignoreUpdates=!0,o._ignoreUpdatesTimer=setTimeout(function(){o._ignoreUpdates=!1},o._ignoreUpdateInterval),n.transport.send({messageName:geocortex.essentialsHtmlViewer.integration.protocol.RemotePublish,commandOrEventName:"ViewerPositionUpdatedEvent",payload:i})},function(e){o.app.trace.warning("An error occurred while attempting to project the current extent for third-party map components: "+e)},r.app)},r=this,s=0,p=n;s<p.length;s++)a(p[s])},s.prototype._broadcastCustomViewpointUpdatedEvent=function(e,t,n){e.transport.send({messageName:geocortex.essentialsHtmlViewer.integration.protocol.RemotePublish,commandOrEventName:"ComponentCustomViewpointIndicatorUpdatedEvent",payload:{id:t,geometry:n.toJson()}})},s.prototype._handleRemoteComponentInitialized=function(t,e){var n=this;void 0===e&&(e=!0);var i=d.firstOrDefault(this._componentStates,function(e){return e.id===t.name});i&&(t.sync=i.sync);var o={viewpoint:null,sync:t.sync,hasPreviousState:!!i};if(i&&i.savedState&&(o.savedState=i.savedState),i&&i.viewpoint&&!i.sync&&(o.viewpoint={extent:i.viewpoint.extent,heading:i.viewpoint.heading,pitch:i.viewpoint.pitch,position:i.viewpoint.center,scale:i.viewpoint.scale,updaterName:null}),t.transport.send({messageName:geocortex.essentialsHtmlViewer.integration.protocol.RemotePublish,commandOrEventName:"ExternalComponentInitializedEvent",payload:o}),i&&(i.viewpoint||i.sync)){var a=i.viewpoint&&i.viewpoint.heading||0;i.sync?(this._broadcastViewpoint(this._currentViewpoint,t,!0),this._updateViewpointIndicator(t.name,t.viewpointIndicatorUri,this._currentViewpoint.extent.getCenter(),a)):e&&this._updateViewpointIndicator(t.name,t.viewpointIndicatorUri,this._currentViewpoint.extent.getCenter(),a)}else setTimeout(function(){n._broadcastViewpoint(n._currentViewpoint,t,!0),e&&n._updateViewpointIndicator(t.name,t.viewpointIndicatorUri,n._currentViewpoint.extent.getCenter(),0)},500)},s.prototype._getComponentGraphicId=function(e,t){var n=e;return t&&(n+="___"+t),n},s.prototype._getComponentGraphicIdFromGraphicId=function(e,t){return t.replace(e.name+"___","")},s.DEFAULT_VIEWPOINT_INDICATOR_URI="Resources/Images/Icons/location-direction-blue-32.png",s);function s(){var e=null!==a&&a.apply(this,arguments)||this;return e._connectedComponents=[],e._componentStates=[],e._eventSubscriptions=[],e._commandSubscriptions=[],e._previousScale=0,e._ignoreUpdates=!1,e._componentIgnoreUpdates=!1,e._ignoreUpdateInterval=250,e._isIE=!1,e}t.IntegrationModule=r})},"Mapping/modules/Integration/IntegrationModuleConfig":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"Mapping/modules/Integration/RemoteComponent":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"url:/Mapping/modules/Integration/ExternalComponentPaneView.html":t,"url:/Mapping/modules/Integration/ExternalComponentView.html":n}}),require(["geocortex/framework/resourceManager"],function(e){e.resourceManager.register("Mapping","inv","Mapping/modules/Integration/CSS/common.css","css","LyogSU5URUdSQVRJT04gU1RZTElORyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8NCi5pbnRlZ3JhdGlvbiB1bC5mdWktc2VsZWN0b3ItYm9keSBzcGFuIHsNCiAgICB2ZXJ0aWNhbC1hbGlnbjogdG9wOw0KICAgIGxpbmUtaGVpZ2h0OiAxLjZlbTsNCiAgICBmb250LXNpemU6IDAuOTVlbTsNCiAgICBkaXNwbGF5OiBpbmxpbmUtYmxvY2s7DQogICAgd2lkdGg6IDkzJTsNCn0NCg0KLkV4dGVybmFsQ29tcG9uZW50VmlldyAucGFuZWwtc2Nyb2xsLWNvbnRhaW5lciB7DQogICAgYm9yZGVyOiAwOw0KICAgIG92ZXJmbG93OiBoaWRkZW47DQp9DQoNCi5FeHRlcm5hbENvbXBvbmVudFZpZXcgLnBhbmVsLWhlYWRlciBpbWcgew0KICAgIGRpc3BsYXk6IGlubGluZS1ibG9jazsNCiAgICBtYXJnaW4tbGVmdDogMC43ZW07DQogICAgdmVydGljYWwtYWxpZ246IG1pZGRsZTsNCn0NCg0KLkV4dGVybmFsQ29tcG9uZW50VmlldyAucGFuZWwtaGVhZGVyIHsNCiAgICBib3JkZXI6IDA7DQp9DQoNCi5FeHRlcm5hbENvbXBvbmVudFZpZXcgLmZ1aS1zZWxlY3RvciB7DQogICAgdmVydGljYWwtYWxpZ246IG1pZGRsZTsNCn0NCg0KLkV4dGVybmFsQ29tcG9uZW50VmlldyAucGFuZWwtc2Nyb2xsLWNvbnRhaW5lciA+IC52aWV3IHsNCiAgICBkaXNwbGF5OiBpbmxpbmUtYmxvY2s7DQogICAgLyoqDQogICAgICogTm90ZTogSWYgeW91J3JlIGNoYW5naW5nIHRoZXNlIHByb3BlcnRpZXMsIHlvdSdyZSBjaGFuZ2luZyB0aGUgdG90YWwgc2l6ZSBvZiBleHRlcm5hbCBjb21wb25lbnQgcGFuZXMgYW5kIG11c3QNCiAgICAgKiBjaGFuZ2UgdGhlIHNpemUgcGFyYW1ldGVycyBpbiBjb2RlLiBTZWUgJ2hhbmRsZUFwcGxpY2F0aW9uUmVzaXplZEV2ZW50JyBpbiBFeHRlcm5hbENvbXBvbmVudFZpZXcuDQogICAgICovDQogICAgbWFyZ2luOiAwOw0KICAgIGJvcmRlcjogMXB4IHNvbGlkICNlZWU7DQp9DQoNCi5FeHRlcm5hbENvbXBvbmVudFZpZXcgLmZ1aS1zZWxlY3RvciB7DQogICAgcGFkZGluZzogMDsNCiAgICBtYXJnaW46IDA7DQogICAgd2lkdGg6IDE2ZW07DQogICAgZmxvYXQ6IG5vbmU7DQp9DQoNCi5FeHRlcm5hbENvbXBvbmVudFZpZXcgLnJlc2l6ZS1oZWFkZXIgew0KICAgIGJhY2tncm91bmQtY29sb3I6ICNGRkZGRkY7DQp9DQoNCi5pbnRlZ3JhdGlvbiAucGFuZSBpZnJhbWUgew0KICAgIHdpZHRoOiAxMDAlOw0KICAgIG1hcmdpbjogYXV0bzsNCiAgICBjbGVhcjogYm90aDsNCn0NCg0KLmludGVncmF0aW9uIC5wYW5lIHsNCiAgICBwYWRkaW5nOiAwOw0KICAgIG1hcmdpbjogMDsNCiAgICBvdmVyZmxvdy14OiBoaWRkZW47DQogICAgb3ZlcmZsb3cteTogaGlkZGVuOw0KICAgIGJhY2tncm91bmQ6ICNGRkZGRkY7DQp9DQoNCi5pbnRlZ3JhdGlvbi1vdmVybGF5IHsNCiAgICBwb3NpdGlvbjogYWJzb2x1dGU7DQogICAgbGVmdDogMDsNCiAgICB0b3A6IDA7DQogICAgcmlnaHQ6IDA7DQogICAgYm90dG9tOiAwOw0KICAgIG9wYWNpdHk6IDAuNTsNCn0NCg=="),e.resourceManager.register("Mapping","inv","Mapping/modules/Integration/CSS/large.css","css","LkV4dGVybmFsQ29tcG9uZW50VmlldyAucmVzaXplLWhlYWRlciB7DQogICAgaGVpZ2h0OiAwLjRlbTsNCn0="),e.resourceManager.register("Mapping","inv","Mapping/modules/Integration/CSS/medium.css","css","LkV4dGVybmFsQ29tcG9uZW50VmlldyAucmVzaXplLWhlYWRlciB7DQogICAgaGVpZ2h0OiAxLjVlbTsgICAgDQp9DQo="),e.resourceManager.register("Mapping","inv","Mapping/modules/Integration/ExternalComponentPaneView.html","html",t),e.resourceManager.register("Mapping","inv","Mapping/modules/Integration/ExternalComponentView.html","html",n)}),require({cache:{}}),define(["Mapping/modules/Integration/ExternalComponentPaneView","Mapping/modules/Integration/ExternalComponentPaneViewModel","Mapping/modules/Integration/ExternalComponentView","Mapping/modules/Integration/ExternalComponentViewModel","Mapping/modules/Integration/IntegrationModule"],function(e,t,n,i,o){a(e,"geocortex.essentialsHtmlViewer.mapping.modules.integration.ExternalComponentPaneView",e.ExternalComponentPaneView),a(t,"geocortex.essentialsHtmlViewer.mapping.modules.integration.ExternalComponentPaneViewModel",t.ExternalComponentPaneViewModel),a(n,"geocortex.essentialsHtmlViewer.mapping.modules.integration.ExternalComponentView",n.ExternalComponentView),a(i,"geocortex.essentialsHtmlViewer.mapping.modules.integration.ExternalComponentViewModel",i.ExternalComponentViewModel),a(o,"geocortex.essentialsHtmlViewer.mapping.modules.integration.IntegrationModule",o.IntegrationModule)})}();