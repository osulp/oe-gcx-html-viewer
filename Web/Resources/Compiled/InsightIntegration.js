require({cache:{"Mapping/modules/InsightIntegration/InsightIntegrationModule":function(){var n,p=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)});define(["require","exports","geocortex/framework/application/ModuleBase","geocortex/essentials/utilities/UrlUtilities","geocortex/infrastructure/tools/MapTool","geocortex/essentials/MapServiceConstants","geocortex/infrastructure/search/SearchManager","geocortex/framework/utils/utils"],function(e,t,i,d,n,l,s,u){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a,o=(a=i.ModuleBase,p(r,a),r.prototype.initialize=function(e){var t=this;if(this._loggingEnabled=!(e&&!u.isNullOrUndefined(e.enabled))||e.enabled,!1!==this._loggingEnabled&&!this.app.isOffline.get()){this._dataRelayIntervalInSeconds=e&&e.dataRelayIntervalInSeconds?e.dataRelayIntervalInSeconds:30,this._dataRelayUri=e&&e.dataRelayUri?e.dataRelayUri:"http://localhost/Geocortex/Analytics/ClientRelay",this._requiresProxy(this._dataRelayUri)&&(this._dataRelayUri=this.app.configuration.proxyUri+this._dataRelayUri);var i=this.app.configModel.viewerId,n=this.app.configModel.moduleConfigs.filter(function(e){return"Site"===e.moduleName});if(0!==n.length){var a=n[0].configuration.siteUri;a=this.app.performTokenReplacement(a),a=this.app.makeAbsolute(a),a=d.UrlUtilities.simplify(a);var o=/.*\/sites\/([^\/]+)/i.exec(a);if(null!=o){var r=o[1];this._eventRelay=new geocortex.analytics.EventRelay(i,r,a,this._dataRelayUri),this._listenForUnhandledExceptions(),this.app.waitUntilSiteInitializing().then(function(){t._handleSiteInitializedCompleted(t.app.site)}),this.app.waitUntilMapLoaded().then(function(){t._onMapInitialized()});var s=this.app.event("AuthenticationSucceededEvent").once(this,function(e){return t._logAuthenticationEvent(e,!0)}),l=this.app.event("AuthenticationFailedEvent").once(this,function(e){return t._logAuthenticationEvent(e,!1)});this.app.waitUntilApplicationReady().then(function(){if(!t._authenticationEventHandled){t.app.event("AuthenticationSucceededEvent").unsubscribe(s),t.app.event("AuthenticationFailedEvent").unsubscribe(l);var e={username:t.app.site.principal.label,token:t.app.site.principal.tokens.site,result:t.app.site.principal.isAuthenticated};t._logAuthenticationEvent(e,e.result)}}),this.app.event("ActiveToolChangedEvent").subscribe(this,this._handleActiveToolChanged),this.app.event("DatalinkResolutionStartedEvent").subscribe(this,this._handleDatalinkResolutionStarted),this.app.event("DatalinkResolutionCompletedEvent").subscribe(this,this._handleDatalinkResolutionCompleted),this.app.event("EsriWebRequestStartedEvent").subscribe(this,this._handleWebRequestStarted),this.app.event("EsriWebRequestCompletedEvent").subscribe(this,this._handleWebRequestCompleted),this.app.event("LayerVisibilityChangedEvent").subscribe(this,this._handleLayerVisibilityChanged),this.app.event("MenuItemInvokedEvent").subscribe(this,this._handleMenuItemInvoked),this.app.event("PrintTemplateStartedEvent").subscribe(this,this._handlePrintTemplateStarted),this.app.event("ReportTemplateStartedEvent").subscribe(this,this._handleReportTemplateStarted),this.app.event("ReportStartedEvent").subscribe(this,this._handleReportStarted),this.app.event("SearchProgressEvent").subscribe(this,this._handleSearchProgressChanged),this.app.event("SiteLayerLoadingEvent").subscribe(this,this._handleSiteLayerLoading),this.app.event("SiteLayerLoadedEvent").subscribe(this,this._handleSiteLayerLoaded),this.app.event("ToolbarButtonClickedEvent").subscribe(this,this._handleToolbarButtonClicked),this.app.event("TraceEvent").subscribe(this,this._handleTrace),this.app.event("WorkflowWebRequestStartedEvent").subscribe(this,this._handleWorkflowWebRequestStarted),this.app.event("WorkflowWebRequestCompletedEvent").subscribe(this,this._handleWorkflowWebRequestCompleted);for(var p=0,h=this._workflowCommands;p<h.length;p++){var c=h[p];this.app.command(c).postExecute.subscribe(this,this._handleWorkflowInitiated.bind(this,c))}}else this._loggingEnabled=!1}else this._loggingEnabled=!1}},r.prototype._onMapInitialized=function(){this._eventRelay.setupMap(this.app.map)},r.prototype._logEvent=function(e,t){if(!1!==this._loggingEnabled)if(null!=this._eventRelay)this._eventRelay.logEvent(e,t);else{var i={eventName:e,eventData:t};this._pendingEvents.push(i)}},r.prototype._listenForUnhandledExceptions=function(){var t=this,e=window;void 0!==window.addEventListener&&-1===navigator.appVersion.indexOf("MSIE 9.")?window.addEventListener("error",function(e){return t._onUnhandledException(e)}):void 0!==e.attachEvent&&e.attachEvent("onerror",function(e){return t._onUnhandledException(e)}),"undefined"!=typeof Promise&&Promise.onPossiblyUnhandledRejection(function(e){return t._onUnhandledException(e)})},r.prototype._logAuthenticationEvent=function(e,t){var i=this,n=this.app.site.principal.identities[0].claims.filter(function(e){return e.type===i.SECURITY_ISSUER_NAME}),a={username:e.username,success:t};0<n.length&&(a.authority=n[0].value),this._logEvent("Authentication",a),this._authenticationEventHandled=!0},r.prototype._handleActiveToolChanged=function(e){if(e.tool){var t={name:e.tool.name,location:this.TOOL_EVENT_SOURCE_TOOLBAR};if(e.tool instanceof n.MapTool){var i=e.tool;t.command=i.command,t.drawMode=i.drawMode}this._logEvent("Tool",t)}},r.prototype._handleDatalinkResolutionStarted=function(e,t){this._datalinkResolutionTimes[e]=(new Date).getTime()},r.prototype._handleDatalinkResolutionCompleted=function(t,e){var i=(new Date).getTime(),n=this._datalinkResolutionTimes[t];if((this._datalinkResolutionTimes[t]=null)!=n){var a=0;e.features.get().forEach(function(e){a+=e.dataLinkingResults.get().filter(function(e){return e.dataLink.get().id===t}).length});var o={datalinkID:t,featureResults:a,time:i-n};this._logEvent("Datalink",o)}},r.prototype._handleLayerVisibilityChanged=function(e){if(!1!==this.app.map.loaded)for(var t=0,i=e;t<i.length;t++){var n=i[t],a=void 0,o=void 0;switch(n.mapService.mapServiceType){case l.MapServiceType.DYNAMIC:case l.MapServiceType.FEATURE:var r=this._serviceRegex.exec(n.mapService.serviceUrl);a=(o=r[1]+"/"+r[2])+"/"+n.layer.id;break;case l.MapServiceType.WMS:o=n.mapService.mapUrl,a=n.mapService.mapUrl+"layers="+n.layer.name;break;default:continue}var s={layerURL:a,mapServiceURL:o,layerId:n.layer.id,serviceTag:n.mapService.serviceTag,visible:n.visibility};this._logEvent("VisibleLayer",s)}},r.prototype._handleMenuItemInvoked=function(e){if(e.menuItem&&e.menuItem.menuItem&&e.menuItem.menuViewModel){var t=e.menuItem.menuItem;if(e.menuItem.menuViewModel.menuId.toUpperCase()===this.I_WANT_TO_MENU_ID)if(t.batchItems&&0<t.batchItems.length)for(var i=0,n=t.batchItems;i<n.length;i++){var a=n[i];if(!(-1<this._workflowCommands.indexOf(t.command.name))){var o={name:t.text,location:this.TOOL_EVENT_SOURCE_IWTM,command:a.command.name,commandParameter:a.commandParameter};this._logEvent("Tool",o)}}else t.command&&-1===this._workflowCommands.indexOf(t.command.name)&&(o={name:t.text,location:this.TOOL_EVENT_SOURCE_IWTM,command:t.command.name,commandParameter:t.commandParameter},this._logEvent("Tool",o))}},r.prototype._handleWorkflowInitiated=function(e,t){var i,n={name:i="RunWorkflowById"===e?t:t.workflowId,location:null,command:"RunWorkflowById",commandParameter:i};this._logEvent("Tool",n)},r.prototype._handlePrintTemplateStarted=function(e){var t,i=this,n=(new Date).getTime(),a=null;t=this.app.event("PrintTemplateCompletedEvent").once(this,function(e){null!=a&&i.app.event("PrintTemplateErrorEvent").unsubscribe(a);var t={templateID:e.id,time:(new Date).getTime()-n};i._logEvent("Print",t)}),a=this.app.event("PrintTemplateErrorEvent").once(this,function(e){null!=t&&i.app.event("PrintTemplateCompletedEvent").unsubscribe(t)})},r.prototype._handleReportTemplateStarted=function(e,t,i){var r=this,s=(new Date).getTime();this.app.event("ReportTemplateCompletedEvent").once(this,function(e,t,i){var n=r._getMapServiceFromMapServiceId(t);if(null!=n){var a=n.layers.filter(function(e){return e.name===i});if(0!==a.length){var o={templateID:r._createInsightReportId(n.serviceUrl,a[0].id,e),time:(new Date).getTime()-s};r._logEvent("Report",o)}}})},r.prototype._handleReportStarted=function(i,e,n){var a=this,o=(new Date).getTime(),r=this._getMapServiceFromMapServiceId(e);if(null!=r&&null!=n){var t,s=null;t=this.app.event("ReportResultEvent").once(this,function(e){null!=s&&a.app.event("ReportErrorEvent").unsubscribe(s);var t={templateID:a._createInsightReportId(r.serviceUrl,n,i),time:(new Date).getTime()-o};a._logEvent("Report",t)}),s=this.app.event("ReportErrorEvent").once(this,function(e){null!=t&&a.app.event("ReportResultEvent").unsubscribe(t)})}},r.prototype._createInsightReportId=function(e,t,i){return e+"|"+t+"|"+i},r.prototype._getMapServiceFromMapServiceId=function(t){if(null!=t){var e=this.app.site.essentialsMap.mapServices.filter(function(e){return e.id===t});if(0!==e.length)return e[0]}},r.prototype._handleSearchProgressChanged=function(e){if(null!=e.searchType&&""!==e.searchType&&("ArcGIS"===e.searchType||"InstantSearch"===e.searchType||"InstantSearchHints"===e.searchType||"ArcGISGeocode"===e.searchType))if(e.status===s.Status.SEARCHING)null==this._searchTimes[e.searchType]&&(this._searchTimes[e.searchType]=(new Date).getTime());else if(e.status===s.Status.IDLE){var t=(new Date).getTime(),i=this._searchTimes[e.searchType];if(!u.isNullOrUndefined(i)){var n=0;if(null!=e.results)for(var a=0;a<e.results.featureSets.getLength();a++)n+=e.results.featureSets.getAt(a).features.getLength();if("ArcGISGeocode"===e.searchType){var o={mapServiceURL:e.endpointUrl,searchText:e.query,geocodeType:"Forward",resultCount:n,time:t-i};this._logEvent("Geocode",o)}else{var r={searchText:e.query,searchType:e.searchType,resultCount:n,time:t-i};this._logEvent("Search",r)}}this._searchTimes[e.searchType]=null}},r.prototype._handleSiteInitializedCompleted=function(e){this._siteInitializationStartTime=this.app.viewerStartTime,this._eventRelay.isInit()||this._eventRelay.init(this.VIEWER_TYPE_FOR_ANALYTICS,this.app.version);var t=this.app.site.siteInitializationTime,i=this._siteInitializationStartTime;if(null!=i){var n={time:t-i};this._logEvent("SiteInitialization",n)}},r.prototype._handleSiteLayerLoading=function(e){this._layerLoadTimes[e.url]=(new Date).getTime()},r.prototype._handleSiteLayerLoaded=function(e){var t=(new Date).getTime(),i=this._layerLoadTimes[e.url];if((this._layerLoadTimes[e.url]=null)!=i){var n="",a="";if(this._featureServiceRegex.test(e.url)){var o=this._featureServiceRegex.exec(e.url);a=o[1]+"/"+o[2],n=e.url}else a=e.url;var r={layerURL:n,mapServiceURL:a,time:t-i};this._logEvent("ServiceLayerInitialization",r)}},r.prototype._handleToolbarButtonClicked=function(e){if(!(-1<this._workflowCommands.indexOf(e.commandName))){var t={name:e.id,location:this.TOOL_EVENT_SOURCE_TOOLBAR,command:e.commandName,commandParameter:e.commandParameter};this._logEvent("Tool",t)}},r.prototype._handleTrace=function(e){if("debug"!==e.level&&"trace"!==e.level&&"info"!==e.level){var t={message:e.message,level:e.level,stackTrace:e.stack};this._logEvent("Log",t)}},r.prototype._handleWebRequestStarted=function(e){this._geometryRegex.test(e)&&(this._webRequestTimes[e]=(new Date).getTime())},r.prototype._handleWebRequestCompleted=function(e){if(this._geometryRegex.test(e)){var t=(new Date).getTime(),i=this._webRequestTimes[e];if(null!=i){var n=this._geometryRegex.exec(e),a={mapServiceURL:n[1]+"/GeometryServer",geometryCommand:n[2],time:t-i};this._logEvent("GeometryRequest",a)}this._webRequestTimes[e]=null}},r.prototype._handleWorkflowWebRequestStarted=function(e,t){this._workflowTimes[t.id]=(new Date).getTime()},r.prototype._handleWorkflowWebRequestCompleted=function(e,t){var i=(new Date).getTime(),n=this._workflowTimes[t.id];if((this._workflowTimes[t.id]=null)!=n){var a={workflowID:t.id,workflowURL:e,time:i-n};this._logEvent("WorkflowRequest",a)}},r.prototype._onUnhandledException=function(e){if(null!=e){var t;if(this._eventRelay.isInit()||this._eventRelay.init(this.VIEWER_TYPE_FOR_ANALYTICS,this.app.version),u.isNullOrUndefined(e.error)||u.isNullOrUndefined(e.error.message))if(u.isNullOrUndefined(e.error)||"string"!=typeof e.error)null!=e.message&&(t={message:(i=e).message,stackTrace:i.stack},console.log("A rejected promise was possibly unhandled, the following exception was captured."),console.warn(i));else{var i;t={message:(i=e).error}}else t={message:(i=e.error).message,stackTrace:i.stack};null!=t&&this._logEvent("UnhandledException",t)}},r.prototype._requiresProxy=function(e){var t=new dojo._Url(e),i=window.location;return!!(t.scheme||t.host||t.port)&&i.protocol+"//"+i.hostname+(i.port?":"+i.port:"")!=t.scheme+"://"+t.host+(t.port?":"+t.port:"")},r);function r(e,t){var i=a.call(this,e,t)||this;return i.VIEWER_TYPE_FOR_ANALYTICS="Geocortex Viewer for HTML5",i.SECURITY_ISSUER_NAME="http://www.geocortex.net/security/claims/issuer-name",i.I_WANT_TO_MENU_ID="IWANTTO",i.TOOL_EVENT_SOURCE_IWTM="IWantToMenu",i.TOOL_EVENT_SOURCE_TOOLBAR="Toolbar",i._eventRelay=null,i._pendingEvents=[],i._datalinkResolutionTimes={},i._layerLoadTimes={},i._searchTimes={},i._webRequestTimes={},i._workflowTimes={},i._serviceRegex=new RegExp("(.*)/(MapServer|FeatureServer)/?(d*)?"),i._featureServiceRegex=new RegExp("(.*)/(MapServer|FeatureServer)/(d*)"),i._geometryRegex=new RegExp("^(.*)/GeometryServer/(\\w+)$"),i._authenticationEventHandled=!1,i._workflowCommands=["RunWorkflowById","RunWorkflowWithArguments","RunWorkflowWithGeometry"],i}t.InsightIntegrationModule=o})}}}),require({cache:{}}),define(["Mapping/modules/InsightIntegration/InsightIntegrationModule"],function(e){!function(e,t,i){if("string"==typeof e&&(i=t,t=e),void 0!==i)for(var n=t.split("."),a=null,o=window,r=0,s=n.length;r<s;r++)a=n[r],r==s-1?o[a]=i:o[a]||(o[a]={}),o=o[a];else console.warn("Undefined shim for: "+t)}(e,"geocortex.essentialsHtmlViewer.mapping.modules.insightIntegration.InsightIntegrationModule",e.InsightIntegrationModule)});