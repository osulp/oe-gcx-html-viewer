!function(){function e(e,t,n){if("string"==typeof e&&(n=t,t=e),void 0!==n)for(var o=t.split("."),a=null,r=window,i=0,s=o.length;i<s;i++)a=o[i],i==s-1?r[a]=n:r[a]||(r[a]={}),r=r[a];else console.warn("Undefined shim for: "+t)}var t="<video autoplay data-binding='{@var: videoElement}{@event-keydown: handleKeyDown}'></video><canvas data-binding='{@var: canvasElement}' style='display: block;' id='qr-canvas'></canvas><ul class='camera-controls'>    <li>        <button class='button' data-binding='{@text: @language-common-cancel}{@event-onclick: handleBackClick}'></button>    </li>    <li>        <button class='button' data-binding='{@text: @language-barcode-scanner-switch}{@visible: showSourceSwitcher}{@event-onclick: handleSwitchSource}'></button>    </li></ul>";require({cache:{"Mapping/modules/BarcodeScanner/BarcodeScannerModule":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();define(["require","exports","geocortex/framework/application/ModuleBase"],function(t,n,o){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var a=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return e(n,t),n.prototype.initialize=function(e){this._config=e,this.app.command("LaunchBarcodeScannerWithCallback").register(this,this._executeLaunchBarcodeScanner),this.app.event("NativeMessageEvent").subscribe(this,this._handleNativeMessageEvent),this.app.event("_HtmlBarcodeScannerResult").subscribe(this,this._handleHtmlBarcodeScanner)},n.prototype._executeLaunchBarcodeScanner=function(e){var t=this;this.lastCallback=e,this.app.nativeManager.hasNativeCapability("barcodeScanner").then(function(e){var n=t.app.nativeManager.isNative();e&&!1!==t._config.allowNativeScanner&&n?t.app.nativeManager.message("LaunchBarcodeScanner",{}):!1!==t._config.allowHtmlScanner&&Modernizr.getusermedia&&Modernizr.webworkers?t.app.command("ActivateView").execute(t._config.htmlScannerView):(t.app.trace.warning("Could not launch a QR scanner."),alert(t.getResource("language-barcode-scanner-unavailable")))})},n.prototype._handleNativeMessageEvent=function(e){"BarcodeScanResult"===e.type&&this.lastCallback&&(this.lastCallback(e.parameters),this.lastCallback=null)},n.prototype._handleHtmlBarcodeScanner=function(e){this.lastCallback&&(this.lastCallback({status:"Success",content:e.value}),this.lastCallback=null)},n}(o.ModuleBase);n.BarcodeScannerModule=a})},"Mapping/modules/BarcodeScanner/BarcodeScannerModuleConfig":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"Mapping/modules/BarcodeScanner/BarcodeScannerView":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();define(["require","exports","geocortex/framework/ui/ViewBase"],function(t,n,o){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var a=function(t){function n(){var e=null!==t&&t.apply(this,arguments)||this;return e._outstandingWorkCount=0,e._attachedVideoEventListeners=!1,e}return e(n,t),n.prototype.activated=function(){t.prototype.activated.call(this),this._getUserMedia=navigator.getUserMedia||navigator.mozGetUserMedia||navigator.webkitGetUserMedia||navigator.msGetUserMedia,this._getUserMedia?Worker?(this._startJsqrcodeWorker(),this._startJobWorker(),this._startVideo()):this.app.trace.error(this.id+" shown but web workers aren't available.  Barcode and QR code scanning won't work."):this.app.trace.error(this.id+" shown but getUserMedia isn't available.  Barcode and QR code scanning won't work.")},n.prototype.deactivated=function(){t.prototype.deactivated.call(this),this._stopVideo()},n.prototype._startJsqrcodeWorker=function(){var e=this;this._jsqrcodeWorker||(this.configuration.jsqrcodeSource?(this._jsqrcodeWorker=new Worker(this.configuration.jsqrcodeSource),this._jsqrcodeWorker.onmessage=function(t){e._outstandingWorkCount--,t.data.success&&(e.app.command("DeactivateView").execute(e.id),e.app.event("_HtmlBarcodeScannerResult").publish({format:"QR",value:t.data.result}))},this._jsqrcodeWorker.onerror=function(t){e.app.trace.error("Error scanning barcode. "+t.message)}):this.app.trace.error(this.id+" shown but jsqrcodeSource is not configured.  QR code scanning won't work."))},n.prototype._startJobWorker=function(){var e=this;this._jobWorker||(this.configuration.jobDecoderWorkerSource?(this._jobWorker=new Worker(this.configuration.jobDecoderWorkerSource),this._jobWorker.onmessage=function(t){"boolean"==typeof t.data.success&&e._outstandingWorkCount--,!0===t.data.success&&t.data.result.length>0&&(e.app.command("DeactivateView").execute(e.id),e.app.event("_HtmlBarcodeScannerResult").publish({format:t.data.result[0].Format,value:t.data.result[0].Value}))},this._jobWorker.onerror=function(t){e.app.trace.error("Error scanning barcode. "+t.message)}):this.app.trace.error(this.id+" shown but jobDecoderWorkerSource is not configured.  Barcode scanning won't work."))},n.prototype._startVideo=function(){var e=this;this._attachedVideoEventListeners||(this._attachVideoEventListeners(),this._attachedVideoEventListeners=!0),this._lastSourceInfo?this._startVideoWithSourceInfo(this._lastSourceInfo):MediaStreamTrack&&MediaStreamTrack.getSources?MediaStreamTrack.getSources(function(t){if(0!==(t=t.filter(function(e){return"video"===e.kind})).length)if(1!==t.length){var n=t.filter(function(e){return"environment"===e.facing});n.length>0?e._startVideoWithSourceInfo(n[0]):(e._sourceInfos=t,e.viewModel.showSourceSwitcher.set(!0),e._startVideoWithSourceInfo(t[0]))}else e._startVideoWithSourceInfo(t[0]);else e._startVideoWithConstraints({video:!0,audio:!1})}):this._startVideoWithConstraints({video:!0,audio:!1})},n.prototype._attachVideoEventListeners=function(){var e,t=this,n=0,o=function(){e||(e=setInterval(function(){t._outstandingWorkCount>0?++n%5==0&&t.app.trace.warning(t.id+" skipped processing "+n+" frames in a row."):(t._outstandingWorkCount<0&&(t.app.trace.error(t.id+" outstanding work count is negative. Work dispatching and results have gone out of sync."),t._outstandingWorkCount=0),n=0,t._scan())},t.configuration.scanInterval||750))},a=function(){e&&(clearInterval(e),e=null)};this.videoElement.addEventListener("play",o),this.videoElement.addEventListener("playing",o),this.videoElement.addEventListener("abort",a),this.videoElement.addEventListener("ended",a),this.videoElement.addEventListener("pause",a),this.videoElement.addEventListener("waiting",a)},n.prototype._startVideoWithSourceInfo=function(e){this._lastSourceInfo=e,this._startVideoWithConstraints({video:{optional:[{sourceId:e.id}]},audio:!1})},n.prototype._startVideoWithConstraints=function(e){var t=this;this._stopVideo(),this._getUserMedia.call(navigator,e,function(e){t._mediaStream=e;var n=window.URL||window.webkitURL;t.videoElement.src=n?n.createObjectURL(e):e,t.videoElement.play(),t.videoElement.focus()},function(e){t.app.trace.error("Error getting user media. "+e.message)})},n.prototype._stopVideo=function(){this.videoElement.pause(),this.videoElement.src="",this._mediaStream&&((this._mediaStream.getTracks()||[]).forEach(function(e){return e.stop()}),this._mediaStream=null)},n.prototype._scan=function(){if(!this.videoElement.paused&&!this.videoElement.ended){this._canvasContext||(this._canvasContext=this.canvasElement.getContext("2d")),this._canvasContext.drawImage(this.videoElement,0,0);var e=this.canvasElement.clientWidth,t=this.canvasElement.clientHeight;this.canvasElement.width===e&&this.canvasElement.height===t||(this.canvasElement.width=e,this.canvasElement.height=t);var n=this._canvasContext.getImageData(0,0,e,t);n&&(this._jsqrcodeWorker&&(this._jsqrcodeWorker.postMessage({imageData:n,width:e,height:t}),this._outstandingWorkCount++),this._jobWorker&&(this._jobWorker.postMessage({scan:n.data,scanWidth:e,scanHeight:t}),this._outstandingWorkCount++))}},n.prototype.handleKeyDown=function(e,t,n){(e.which?e.which:e.keyCode)===dojo.keys.ESCAPE&&this.app.command("DeactivateView").execute(this.id)},n.prototype.handleBackClick=function(e,t,n){this.app.command("DeactivateView").execute(this.id)},n.prototype.handleSwitchSource=function(e,t,n){if(this._sourceInfos){var o=this._sourceInfos.indexOf(this._lastSourceInfo),a=o+1<this._sourceInfos.length?o+1:0;this._startVideoWithSourceInfo(this._sourceInfos[a])}else this.app.trace.error(this.id+" handleSwitchSource called but source switching is not available.")},n}(o.ViewBase);n.BarcodeScannerView=a})},"Mapping/modules/BarcodeScanner/BarcodeScannerViewConfig":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"Mapping/modules/BarcodeScanner/BarcodeScannerViewModel":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();define(["require","exports","geocortex/framework/ui/ViewModelBase","geocortex/framework/observables"],function(t,n,o,a){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=function(t){function n(){var e=null!==t&&t.apply(this,arguments)||this;return e.showSourceSwitcher=new a.Observable(!1),e}return e(n,t),n}(o.ViewModelBase);n.BarcodeScannerViewModel=r})},"url:/Mapping/modules/BarcodeScanner/BarcodeScannerView.html":t}}),require(["geocortex/framework/resourceManager"],function(e){e.resourceManager.register("Mapping","inv","Mapping/modules/BarcodeScanner/CSS/common.css","css","LkJhcmNvZGVTY2FubmVyVmlldywNCi5CYXJjb2RlU2Nhbm5lclZpZXcgdmlkZW8sDQouc3BsYXNoLWJsdXJyZWQsDQouQmFyY29kZVNjYW5uZXJWaWV3IGNhbnZhcyB7DQogICAgd2lkdGg6IDEwMCU7DQogICAgaGVpZ2h0OiAxMDAlOw0KICAgIG1hcmdpbjogMDsNCn0NCg0KLkJhcmNvZGVTY2FubmVyVmlldyB7DQogICAgcG9zaXRpb246IHJlbGF0aXZlOw0KfQ0KDQouQmFyY29kZVNjYW5uZXJWaWV3IHZpZGVvIHsNCiAgICBvYmplY3QtZml0OiBjb3ZlcjsNCn0NCg0KLkJhcmNvZGVTY2FubmVyVmlldyAuY2FtZXJhLWNvbnRyb2xzLA0KLkJhcmNvZGVTY2FubmVyVmlldyAuY2FtZXJhLWNvbnRyb2xzIGxpIHsNCiAgICBwYWRkaW5nOiAwOw0KICAgIG1hcmdpbjogMDsNCiAgICBsaXN0LXN0eWxlOiBub25lOw0KICAgIC13ZWJraXQtYm94LXNpemluZzogYm9yZGVyLWJveDsNCiAgICAtbW96LWJveC1zaXppbmc6IGJvcmRlci1ib3g7DQogICAgYm94LXNpemluZzogYm9yZGVyLWJveDsNCn0NCi5CYXJjb2RlU2Nhbm5lclZpZXcgLmNhbWVyYS1jb250cm9scyB7DQogICAgZGlzcGxheTogYmxvY2s7DQogICAgcG9zaXRpb246IGFic29sdXRlOw0KICAgIHdpZHRoOiAxMDAlOw0KICAgIGhlaWdodDogNGVtOw0KICAgIGxlZnQ6IDA7DQogICAgYm90dG9tOiAwOw0KICAgIHpvb206IDE7DQoJZmlsdGVyOiBhbHBoYShvcGFjaXR5PTg1KTsNCglvcGFjaXR5OiAwLjg1Ow0KfQ0KLkJhcmNvZGVTY2FubmVyVmlldyAuY2FtZXJhLWNvbnRyb2xzIGxpIHsNCiAgICBkaXNwbGF5OiBpbmxpbmUtYmxvY2s7DQogICAgd2lkdGg6IDUwJTsNCiAgICBwYWRkaW5nOiAwLjVlbTsNCn0NCi5CYXJjb2RlU2Nhbm5lclZpZXcgLmNhbWVyYS1jb250cm9scyBsaTpmaXJzdC1jaGlsZCB7DQogICAgdGV4dC1hbGlnbjogcmlnaHQ7DQp9DQouQmFyY29kZVNjYW5uZXJWaWV3IC5jYW1lcmEtY29udHJvbHMgbGk6bGFzdC1jaGlsZCB7DQogICAgbWFyZ2luLWxlZnQ6IC00cHg7DQp9DQouQmFyY29kZVNjYW5uZXJWaWV3IC5jYW1lcmEtY29udHJvbHMgLmJ1dHRvbiB7DQogICAgZGlzcGxheTogaW5saW5lLWJsb2NrOw0KICAgIHdpZHRoOiAxMDAlOw0KICAgIGhlaWdodDogM2VtOw0KICAgIG1heC13aWR0aDogMTBlbTsNCiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7DQogICAgYm9yZGVyOiAxcHggc29saWQ7DQp9"),e.resourceManager.register("Mapping","inv","Mapping/modules/BarcodeScanner/BarcodeScannerView.html","html",t)}),require({cache:{}}),define(["Mapping/modules/BarcodeScanner/BarcodeScannerModule","Mapping/modules/BarcodeScanner/BarcodeScannerView","Mapping/modules/BarcodeScanner/BarcodeScannerViewModel"],function(t,n,o){e(t,"geocortex.essentialsHtmlViewer.mapping.modules.barcodescanner.BarcodeScannerModule",t.BarcodeScannerModule),e(n,"geocortex.essentialsHtmlViewer.mapping.modules.barcodescanner.BarcodeScannerView",n.BarcodeScannerView),e(o,"geocortex.essentialsHtmlViewer.mapping.modules.barcodescanner.BarcodeScannerViewModel",o.BarcodeScannerViewModel)})}();