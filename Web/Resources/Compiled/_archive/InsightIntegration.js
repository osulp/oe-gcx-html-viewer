!function(){function e(e,t,i){if("string"==typeof e&&(i=t,t=e),void 0!==i)for(var n=t.split("."),a=null,r=window,o=0,s=n.length;o<s;o++)a=n[o],o==s-1?r[a]=i:r[a]||(r[a]={}),r=r[a];else console.warn("Undefined shim for: "+t)}require({cache:{"Mapping/modules/InsightIntegration/InsightIntegrationModule":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();define(["require","exports","geocortex/framework/application/ModuleBase","geocortex/essentials/utilities/UrlUtilities","geocortex/infrastructure/tools/MapTool","geocortex/essentials/MapServiceConstants","geocortex/infrastructure/search/SearchManager","geocortex/framework/utils/utils"],function(t,i,n,a,r,o,s,l){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var p=function(t){function i(e,i){var n=t.call(this,e,i)||this;return n.VIEWER_TYPE_FOR_ANALYTICS="Geocortex Viewer for HTML5",n.SECURITY_ISSUER_NAME="http://www.geocortex.net/security/claims/issuer-name",n.I_WANT_TO_MENU_ID="IWANTTO",n.TOOL_EVENT_SOURCE_IWTM="IWantToMenu",n.TOOL_EVENT_SOURCE_TOOLBAR="Toolbar",n._eventRelay=null,n._pendingEvents=[],n._datalinkResolutionTimes={},n._layerLoadTimes={},n._searchTimes={},n._webRequestTimes={},n._workflowTimes={},n._serviceRegex=new RegExp("(.*)/(MapServer|FeatureServer)/?(d*)?"),n._featureServiceRegex=new RegExp("(.*)/(MapServer|FeatureServer)/(d*)"),n._geometryRegex=new RegExp("^(.*)/GeometryServer/(\\w+)$"),n}return e(i,t),i.prototype.initialize=function(e){var t=this;if(this._loggingEnabled=!(e&&!l.isNullOrUndefined(e.enabled))||e.enabled,!1!==this._loggingEnabled&&!this.app.isOffline.get()){this._dataRelayIntervalInSeconds=e&&e.dataRelayIntervalInSeconds?e.dataRelayIntervalInSeconds:30,this._dataRelayUri=e&&e.dataRelayUri?e.dataRelayUri:"http://localhost/Geocortex/Analytics/ClientRelay",this._requiresProxy(this._dataRelayUri)&&(this._dataRelayUri=this.app.configuration.proxyUri+this._dataRelayUri);var i=this.app.configModel.viewerId,n=this.app.configModel.moduleConfigs.filter(function(e){return"Site"===e.moduleName});if(0!==n.length){var r=n[0].configuration.siteUri;r=this.app.performTokenReplacement(r),r=this.app.makeAbsolute(r),r=a.UrlUtilities.simplify(r);var o=/.*\/sites\/([^\/]+)/i.exec(r);if(null!=o){var s=o[1];this._eventRelay=new geocortex.analytics.EventRelay(i,s,r,this._dataRelayUri),this._listenForUnhandledExceptions(),this.app.waitUntilSiteInitialized().then(function(){t._handleSiteInitializedCompleted(t.app.site)}),this.app.waitUntilMapLoaded().then(function(){t._onMapInitialized()}),this.app.event("AuthenticationSucceededEvent").once(this,function(e){return t._logAuthenticationEvent(e,!0)}),this.app.event("AuthenticationFailedEvent").once(this,function(e){return t._logAuthenticationEvent(e,!1)}),this.app.event("ActiveToolChangedEvent").subscribe(this,this._handleActiveToolChanged),this.app.event("DatalinkResolutionStartedEvent").subscribe(this,this._handleDatalinkResolutionStarted),this.app.event("DatalinkResolutionCompletedEvent").subscribe(this,this._handleDatalinkResolutionCompleted),this.app.event("EsriWebRequestStartedEvent").subscribe(this,this._handleWebRequestStarted),this.app.event("EsriWebRequestCompletedEvent").subscribe(this,this._handleWebRequestCompleted),this.app.event("LayerVisibilityChangedEvent").subscribe(this,this._handleLayerVisibilityChanged),this.app.event("MenuItemInvokedEvent").subscribe(this,this._handleMenuItemInvoked),this.app.event("PrintTemplateStartedEvent").subscribe(this,this._handlePrintTemplateStarted),this.app.event("ReportTemplateStartedEvent").subscribe(this,this._handleReportTemplateStarted),this.app.event("ReportStartedEvent").subscribe(this,this._handleReportStarted),this.app.event("SearchProgressEvent").subscribe(this,this._handleSearchProgressChanged),this.app.event("SiteLayerLoadingEvent").subscribe(this,this._handleSiteLayerLoading),this.app.event("SiteLayerLoadedEvent").subscribe(this,this._handleSiteLayerLoaded),this.app.event("ToolbarButtonClickedEvent").subscribe(this,this._handleToolbarButtonClicked),this.app.event("TraceEvent").subscribe(this,this._handleTrace),this.app.event("WorkflowWebRequestStartedEvent").subscribe(this,this._handleWorkflowWebRequestStarted),this.app.event("WorkflowWebRequestCompletedEvent").subscribe(this,this._handleWorkflowWebRequestCompleted)}else this._loggingEnabled=!1}else this._loggingEnabled=!1}},i.prototype._onMapInitialized=function(){this._eventRelay.setupMap(this.app.map)},i.prototype._logEvent=function(e,t){if(!1!==this._loggingEnabled)if(null!=this._eventRelay)this._eventRelay.logEvent(e,t);else{var i={eventName:e,eventData:t};this._pendingEvents.push(i)}},i.prototype._listenForUnhandledExceptions=function(){var e=this,t=window;void 0!==window.addEventListener&&-1===navigator.appVersion.indexOf("MSIE 9.")?window.addEventListener("error",function(t){return e._onUnhandledException(t)}):void 0!==t.attachEvent&&t.attachEvent("onerror",function(t){return e._onUnhandledException(t)}),"undefined"!=typeof Promise&&Promise.onPossiblyUnhandledRejection(function(t){return e._onUnhandledException(t)})},i.prototype._logAuthenticationEvent=function(e,t){var i=this,n=this.app.site.principal.identities[0].claims.filter(function(e){return e.type===i.SECURITY_ISSUER_NAME}),a={username:e.username,success:t};n.length>0&&(a.authority=n[0].value),this._logEvent("Authentication",a)},i.prototype._handleActiveToolChanged=function(e){if(e.tool){var t={name:e.tool.name,location:this.TOOL_EVENT_SOURCE_TOOLBAR};if(e.tool instanceof r.MapTool){var i=e.tool;t.command=i.command,t.drawMode=i.drawMode}this._logEvent("Tool",t)}},i.prototype._handleDatalinkResolutionStarted=function(e,t){this._datalinkResolutionTimes[e]=(new Date).getTime()},i.prototype._handleDatalinkResolutionCompleted=function(e,t){var i=(new Date).getTime(),n=this._datalinkResolutionTimes[e];if(this._datalinkResolutionTimes[e]=null,null!=n){var a=0;t.features.get().forEach(function(t){a+=t.dataLinkingResults.get().filter(function(t){return t.dataLink.get().id===e}).length});var r={datalinkID:e,featureResults:a,time:i-n};this._logEvent("Datalink",r)}},i.prototype._handleLayerVisibilityChanged=function(e){if(!1!==this.app.map.loaded)for(var t=0,i=e;t<i.length;t++){var n=i[t],a=void 0,r=void 0;switch(n.mapService.mapServiceType){case o.MapServiceType.DYNAMIC:case o.MapServiceType.FEATURE:var s=this._serviceRegex.exec(n.mapService.serviceUrl);a=(r=s[1]+"/"+s[2])+"/"+n.layer.id;break;case o.MapServiceType.WMS:r=n.mapService.mapUrl,a=n.mapService.mapUrl+"layers="+n.layer.name;break;default:continue}var l={layerURL:a,mapServiceURL:r,layerId:n.layer.id,serviceTag:n.mapService.serviceTag,visible:n.visibility};this._logEvent("VisibleLayer",l)}},i.prototype._handleMenuItemInvoked=function(e){if(e.menuItem&&e.menuItem.menuItem&&e.menuItem.menuViewModel){var t=e.menuItem.menuItem;if(e.menuItem.menuViewModel.menuId.toUpperCase()===this.I_WANT_TO_MENU_ID)if(t.batchItems&&t.batchItems.length>0)for(var i=0,n=t.batchItems;i<n.length;i++){var a=n[i],r={name:t.text,location:this.TOOL_EVENT_SOURCE_IWTM,command:a.command.name,commandParameter:a.commandParameter};this._logEvent("Tool",r)}else if(t.command){r={name:t.text,location:this.TOOL_EVENT_SOURCE_IWTM,command:t.command.name,commandParameter:t.commandParameter};this._logEvent("Tool",r)}}},i.prototype._handlePrintTemplateStarted=function(e){var t=this,i=(new Date).getTime(),n=null,a=null;a=this.app.event("PrintTemplateCompletedEvent").once(this,function(e){null!=n&&t.app.event("PrintTemplateErrorEvent").unsubscribe(n);var a={templateID:e.id,time:(new Date).getTime()-i};t._logEvent("Print",a)}),n=this.app.event("PrintTemplateErrorEvent").once(this,function(e){null!=a&&t.app.event("PrintTemplateCompletedEvent").unsubscribe(a)})},i.prototype._handleReportTemplateStarted=function(e,t,i){var n=this,a=(new Date).getTime();this.app.event("ReportTemplateCompletedEvent").once(this,function(e,t,i){var r=n._getMapServiceFromMapServiceId(t);if(null!=r){var o=r.layers.filter(function(e){return e.name===i});if(0!==o.length){var s={templateID:n._createInsightReportId(r.serviceUrl,o[0].id,e),time:(new Date).getTime()-a};n._logEvent("Report",s)}}})},i.prototype._handleReportStarted=function(e,t,i){var n=this,a=(new Date).getTime(),r=this._getMapServiceFromMapServiceId(t);if(null!=r&&null!=i){var o=null,s=null;s=this.app.event("ReportResultEvent").once(this,function(t){null!=o&&n.app.event("ReportErrorEvent").unsubscribe(o);var s={templateID:n._createInsightReportId(r.serviceUrl,i,e),time:(new Date).getTime()-a};n._logEvent("Report",s)}),o=this.app.event("ReportErrorEvent").once(this,function(e){null!=s&&n.app.event("ReportResultEvent").unsubscribe(s)})}},i.prototype._createInsightReportId=function(e,t,i){return e+"|"+t+"|"+i},i.prototype._getMapServiceFromMapServiceId=function(e){if(null!=e){var t=this.app.site.essentialsMap.mapServices.filter(function(t){return t.id===e});if(0!==t.length)return t[0]}},i.prototype._handleSearchProgressChanged=function(e){if(null!=e.searchType&&""!==e.searchType&&("ArcGIS"===e.searchType||"InstantSearch"===e.searchType||"InstantSearchHints"===e.searchType||"ArcGISGeocode"===e.searchType))if(e.status===s.Status.SEARCHING)null==this._searchTimes[e.searchType]&&(this._searchTimes[e.searchType]=(new Date).getTime());else if(e.status===s.Status.IDLE){var t=(new Date).getTime(),i=this._searchTimes[e.searchType];if(!l.isNullOrUndefined(i)){var n=0;if(null!=e.results)for(var a=0;a<e.results.featureSets.getLength();a++)n+=e.results.featureSets.getAt(a).features.getLength();if("ArcGISGeocode"===e.searchType){var r={mapServiceURL:e.endpointUrl,searchText:e.query,geocodeType:"Forward",resultCount:n,time:t-i};this._logEvent("Geocode",r)}else{var o={searchText:e.query,searchType:e.searchType,resultCount:n,time:t-i};this._logEvent("Search",o)}}this._searchTimes[e.searchType]=null}},i.prototype._handleSiteInitializedCompleted=function(e){this._siteInitializationStartTime=this.app.viewerStartTime,this._eventRelay.isInit()||this._eventRelay.init(this.VIEWER_TYPE_FOR_ANALYTICS,this.app.version);var t=this.app.site.siteInitializationTime,i=this._siteInitializationStartTime;if(null!=i){var n={time:t-i};this._logEvent("SiteInitialization",n)}},i.prototype._handleSiteLayerLoading=function(e){this._layerLoadTimes[e.url]=(new Date).getTime()},i.prototype._handleSiteLayerLoaded=function(e){var t=(new Date).getTime(),i=this._layerLoadTimes[e.url];if(this._layerLoadTimes[e.url]=null,null!=i){var n="",a="";if(this._featureServiceRegex.test(e.url)){var r=this._featureServiceRegex.exec(e.url);a=r[1]+"/"+r[2],n=e.url}else a=e.url;var o={layerURL:n,mapServiceURL:a,time:t-i};this._logEvent("ServiceLayerInitialization",o)}},i.prototype._handleToolbarButtonClicked=function(e){var t={name:e.id,location:this.TOOL_EVENT_SOURCE_TOOLBAR,command:e.commandName,commandParameter:e.commandParameter};this._logEvent("Tool",t)},i.prototype._handleTrace=function(e){if("debug"!==e.level&&"trace"!==e.level&&"info"!==e.level){var t={message:e.message,level:e.level,stackTrace:e.stack};this._logEvent("Log",t)}},i.prototype._handleWebRequestStarted=function(e){this._geometryRegex.test(e)&&(this._webRequestTimes[e]=(new Date).getTime())},i.prototype._handleWebRequestCompleted=function(e){if(this._geometryRegex.test(e)){var t=(new Date).getTime(),i=this._webRequestTimes[e];if(null!=i){var n=this._geometryRegex.exec(e),a={mapServiceURL:n[1]+"/GeometryServer",geometryCommand:n[2],time:t-i};this._logEvent("GeometryRequest",a)}this._webRequestTimes[e]=null}},i.prototype._handleWorkflowWebRequestStarted=function(e,t){this._workflowTimes[t.id]=(new Date).getTime()},i.prototype._handleWorkflowWebRequestCompleted=function(e,t){var i=(new Date).getTime(),n=this._workflowTimes[t.id];if(this._workflowTimes[t.id]=null,null!=n){var a={workflowID:t.id,workflowURL:e,time:i-n};this._logEvent("WorkflowRequest",a)}},i.prototype._onUnhandledException=function(e){if(null!=e){this._eventRelay.isInit()||this._eventRelay.init(this.VIEWER_TYPE_FOR_ANALYTICS,this.app.version);var t;if(l.isNullOrUndefined(e.error)||l.isNullOrUndefined(e.error.message))if(l.isNullOrUndefined(e.error)||"string"!=typeof e.error){if(null!=e.message){var i=e;t={message:i.message,stackTrace:i.stack},console.log("A rejected promise was possibly unhandled, the following exception was captured."),console.warn(i)}}else t={message:(i=e).error};else t={message:(i=e.error).message,stackTrace:i.stack};null!=t&&this._logEvent("UnhandledException",t)}},i.prototype._requiresProxy=function(e){var t=new dojo._Url(e),i=window.location;return!!(t.scheme||t.host||t.port)&&i.protocol+"//"+i.hostname+(i.port?":"+i.port:"")!=t.scheme+"://"+t.host+(t.port?":"+t.port:"")},i}(n.ModuleBase);i.InsightIntegrationModule=p})}}}),require({cache:{}}),define(["Mapping/modules/InsightIntegration/InsightIntegrationModule"],function(t){e(t,"geocortex.essentialsHtmlViewer.mapping.modules.insightIntegration.InsightIntegrationModule",t.InsightIntegrationModule)})}();