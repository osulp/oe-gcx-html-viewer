!function(){function e(e,t,i){if("string"==typeof e&&(i=t,t=e),void 0!==i)for(var a=t.split("."),n=null,r=window,o=0,s=a.length;o<s;o++)n=a[o],o==s-1?r[n]=i:r[n]||(r[n]={}),r=r[n];else console.warn("Undefined shim for: "+t)}var t="<div class='accessibility' tabindex='-1'>    <button type='button' class='accessibility-button' data-binding='{@visible: included}{@event-onclick: handleOnClick}{title: @language-accessibility-map-accessibility-icon}' tabindex='0'></button></div>",i="<div class='module notification alert'>    <div class='desc' data-binding='{@widget: GetHTMLContent}{@widget-context: content}'></div>    <div class='form-btns'>        <button class='button' data-binding='{@var: okButtonElement}{@event-onclick: handleClickOk}{@text: @language-common-ok}'        />    </div></div>",a="\x3c!-- The aria-label and span may appear redundant, but they're both needed for how different browsers/readers work. --\x3e<div class='screen-reader-notifications' data-binding='{@var: screenReaderNotificationsElement}' aria-live='polite'>    <span data-binding='{@text: ariaLabelText}' aria-live='polite'></span></div>";require({cache:{"Mapping/modules/Accessibility/AccessibilityButtonView":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function a(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(a.prototype=i.prototype,new a)}}();define(["require","exports","geocortex/framework/ui/ViewBase"],function(t,i,a){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=function(t){function i(){return null!==t&&t.apply(this,arguments)||this}return e(i,t),i.prototype.handleOnClick=function(e,t,i){return this.app.command("ShowAccessibilityView").execute(),!1},i}(a.ViewBase);i.AccessibilityButtonView=n})},"Mapping/modules/Accessibility/AccessibilityIconView":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function a(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(a.prototype=i.prototype,new a)}}();define(["require","exports","geocortex/framework/ui/ViewBase","geocortex/infrastructure/FeatureDescriptionPresenterView"],function(t,i,a,n){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var r=function(t){function i(){var e=null!==t&&t.apply(this,arguments)||this;return e.userInitiatedDA=!1,e}return e(i,t),i.prototype.attach=function(e){if(e){if(t.prototype.attach.call(this,e),null!==this.viewModel.content.get())this._activateAccessibilityView();else var i=this.app.eventRegistry.event("AccessibilityIconContentInitializedEvent").subscribe(this,function(){this._activateAccessibilityView(),this.app.eventRegistry.event("AccessibilityIconContentInitializedEvent").unsubscribe(i)});if(this.okButtonElement)try{this.okButtonElement.focus()}catch(e){}this.viewContainerViewClosedEventToken||(this.viewContainerViewClosedEventToken=this.app.event("ViewContainerViewClosedEvent").subscribe(this,function(e){e&&e.viewId==this.id&&this._deactivateForUser()}))}},i.prototype._canExecuteActivateAccessibilityView=function(){return this.viewModel.included.get()},i.prototype._executeActivateAccessibilityView=function(){this.app.commandRegistry.command("ActivateView").execute(this.id)},i.prototype._activateAccessibilityView=function(){this.viewModel.included.get()&&this.title.set(this.viewModel.title.get()),this.app.commandRegistry.command("ShowAccessibilityView").register(this,this._executeActivateAccessibilityView,this._canExecuteActivateAccessibilityView)},i.prototype.resolveWidget=function(e,i){if(t.prototype.resolveWidget.call(this,e,i),"GetHTMLContent"===e){var a=new n.FeatureDescriptionPresenterView(this.app,this.libraryId);return a.root=document.createElement("div"),a.root.className="content",a.root.innerHTML=a.insertLinkAndImageBindings(i),a.attach(null),a}},i.prototype.handleClickOk=function(e,t,i){return this._deactivateForUser(),!1},i.prototype._deactivateForUser=function(){this.userInitiatedDA=!0,this.app.viewManager.deactivateView(this),this.viewModel.callback&&this.userInitiatedDA&&this.viewModel.callback()},i}(a.ViewBase);i.AccessibilityIconView=r})},"Mapping/modules/Accessibility/AccessibilityIconViewModel":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function a(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(a.prototype=i.prototype,new a)}}();define(["require","exports","geocortex/framework/ui/ViewModelBase","geocortex/framework/observables"],function(t,i,a,n){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var r=function(t){function i(){var e=null!==t&&t.apply(this,arguments)||this;return e.included=new n.Observable(!0),e.content=new n.Observable(null),e.title=new n.Observable(null),e}return e(i,t),i.prototype.initialize=function(e){e&&(e.hasOwnProperty("included")&&this.included.set(e.included),e.hasOwnProperty("title")&&this.title.set(e.title),e.hasOwnProperty("content")&&(this.content.set(decodeURIComponent(e.content)),this.app.eventRegistry.event("AccessibilityIconContentInitializedEvent").publish()))},i}(a.ViewModelBase);i.AccessibilityIconViewModel=r})},"Mapping/modules/Accessibility/AccessibilityModule":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function a(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(a.prototype=i.prototype,new a)}}();define(["require","exports","geocortex/framework/application/ModuleBase","geocortex/framework/observables","geocortex/framework-ui/ViewContainer/ViewContainerView","geocortex/infrastructure/FocusUtils","geocortex/infrastructure/ui/components/SmartPanel/SmartPanelView"],function(t,i,a,n,r,o,s){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var c=window.HTMLElement||window.Element,p=function(t){function i(){var e=null!==t&&t.apply(this,arguments)||this;return e.includeProviders=new n.Observable(!0),e._keydownHandle=null,e._keyupHandle=null,e._panning=!1,e._viewsIgnoreAutoFocus=["LoadingStatus","StatusIndicatorView","StatusMessageView","ProviderView","geometryEditingStatus","MapView","DataFrameButtonView","SearchHintsView"],e._modalContainerView=null,e._viewFocusHandle=null,e._viewToFocus=null,e}return e(i,t),i.prototype.initialize=function(e){var a=this;if(t.prototype.initialize.call(this,e),e.keyboardFocusIndicatorEnabled){var n=e.keyboardFocusIndicatorColor||i.DEFAULT_KEYBOARD_FOCUS_INDICATOR_COLOR,r=document.createElement("style");r.textContent="\n                    .keyboard-focus-active :focus,\n                    .keyboard-focus-active #map_root:focus:after,\n                    .keyboard-focus-active .gcx-toggle .input-checkbox:focus + .input-label:before {\n                        outline-color: "+n+" !important;\n                    }\n                ",document.head.appendChild(r),$(document).on("mousedown",function(e){$(document.documentElement).hasClass("keyboard-focus-active")&&(a.app.trace.debug("Keyboard focus deactivated."),$(document.documentElement).removeClass("keyboard-focus-active"))}),$(document).on("keydown",function(e){9===e.keyCode&&!1===$(document.documentElement).hasClass("keyboard-focus-active")&&(a.app.trace.debug("Keyboard focus active."),$(document.documentElement).addClass("keyboard-focus-active"))}),$(document).on("mousedown",function(e){$(document.documentElement).hasClass("keyboard-focus-active")&&e.target!==document.activeElement&&e.target.parentElement!==document.activeElement&&(a.app.trace.debug("Keyboard focus deactivated."),$(document.documentElement).removeClass("keyboard-focus-active"))})}if(this.app.waitUntilMapLoaded().then(function(){a.enableMapFocusedText()}),this.app.waitUntilApplicationReady().then(function(){e.expandedMapKeyboardAccessibility&&a.enableKeyboardNavigation(),e.automaticElementFocusing&&a.enableAutomaticElementFocusing(),$(document).on("focus","input, .ui-slider-handle",function(e){a.app.map.disableKeyboardNavigation(),$(e.target).one("blur",function(){return a.app.map.enableKeyboardNavigation()})})}),e.hasOwnProperty("includeProviders")&&this.includeProviders.set(e.includeProviders),e.providers&&this.includeProviders.get())for(var o=0,s=e.providers;o<s.length;o++){var c=s[o];if(!1===c.isEnabled)return;var p=dojo.getObject(c.type);p&&new p(this.app,c.libraryId||this.libraryId).initialize(c)}},i.prototype.enableMapFocusedText=function(){$(this.app.map.root).attr("aria-label",this.app.getResource(this.libraryId,"language-accessibility-map-focused")),$(this.app.map.root).attr("role","main"),$(this.app.map.root).children(".esriMapContainer, .esriControlsBR").attr("aria-hidden","true")},i.prototype.enableAutomaticElementFocusing=function(){var e=this;this.app.command("FocusOnFirstInputInView").register(this,function(t){o.focusOnFirstInput(t,e.app.map)}),this.app.event("ViewActivatedEvent").subscribe(this,function(t){if(!e._modalContainerView){var i=e.app.viewManager.getRegionForViewId(t.id);i&&"ModalWindowPlaceholderRegion"===i.name&&(e._modalContainerView=t)}}),this.app.waitUntilApplicationReady().then(function(){e.app.event("ViewActivatedEvent").subscribe(e,function(t){if(!(t instanceof r.ViewContainerView||t instanceof s.SmartPanelView)){for(var i=0,a=e._viewsIgnoreAutoFocus;i<a.length;i++){var n=a[i];if(-1!==t.id.search(n))return}e._viewToFocus=t,null===e._viewFocusHandle&&(e._viewFocusHandle=setTimeout(function(){e._viewToFocus&&(e.app.trace.debug("View focused: "+t.id),e.app.command("FocusOnFirstInputInView").execute(t)),e._viewFocusHandle=null},300))}})});var t=function(t){return e._interceptTabsWhileModalActive(t)};this.app.event("RegionActivatedEvent").subscribe(this,function(e){"ModalWindowRegion"===e.name&&$(document).on("keydown",t)}),this.app.event("RegionDeactivatedEvent").subscribe(this,function(e){"ModalWindowRegion"===e.name&&$(document).off("keydown",t)})},i.prototype._resetModalFocus=function(e){if(e&&e.root)try{var t=$(e.root).find(":visible:input, a:visible, button:visible").not(".bound-disabled, .disabled, [tabindex=-1]");if(t&&t.length>0)return void o.focus(t[0])}catch(e){this.app.trace.debug("Could not focus: "+e)}},i.prototype._interceptTabsWhileModalActive=function(e){var t=e.keyCode||e.which;if(9===t||9===t&&e.shiftKey){var i=document.activeElement,a=$(this._modalContainerView.root).find(":focusable");a&&i===a[0]&&9===t&&e.shiftKey?e.preventDefault():i===a[a.length]&&9===t&&e.preventDefault(),0===$(i).parents(".ModalViewContainerView").length&&(this._resetModalFocus(this._modalContainerView),e.preventDefault())}},i.prototype.enableKeyboardNavigation=function(){var e=this;this.disableKeyboardNavigation(),this.app.map&&this.app.map.loaded?(this._keydownHandle=dojo.on(document,"keydown",function(t){return e._onKeyDownHandler(t)}),this._keyupHandle=dojo.on(document,"keyup",function(t){return e._onKeyUpHandler(t)})):this.app.event("MapLoadedEvent").once(this,function(t){e._keydownHandle=dojo.on(document,"keydown",function(t){return e._onKeyDownHandler(t)}),e._keyupHandle=dojo.on(document,"keyup",function(t){return e._onKeyUpHandler(t)})})},i.prototype.disableKeyboardNavigation=function(){this._keydownHandle&&this._keydownHandle.remove(),this._keyupHandle&&this._keyupHandle.remove(),this._keydownHandle=null,this._keyupHandle=null,this._panning=!1},i.prototype._onKeyDownHandler=function(e){if(document.activeElement===this.app.map.root||!document.activeElement||!document.activeElement.classList||document.activeElement.classList.contains("ovwHighlight")){var t=e.target||e.srcElement,i=null;if(t instanceof c&&(i=t.className),t===this.app.map.root||"ovwHighlight"===i){var a=this.app.map;a.navigationManager._keyHandle&&(this._panning=!0,a.navigationManager._keyHandle.advice(e))}}},i.prototype._onKeyUpHandler=function(e){var t=e.target||e.srcElement,i=null;if(t instanceof c&&(i=t.className),t===this.app.map.root||"ovwHighlight"===i){var a=this.app.map;a.navigationManager._keyEndHandle&&this._panning&&(this._panning=!1,a.navigationManager._keyEndHandle.advice(e))}},i}(a.ModuleBase);p.DEFAULT_KEYBOARD_FOCUS_INDICATOR_COLOR="#550055",i.AccessibilityModule=p})},"Mapping/modules/Accessibility/AccessibilityViewModel":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function a(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(a.prototype=i.prototype,new a)}}();define(["require","exports","geocortex/framework/ui/ViewModelBase","geocortex/framework/observables"],function(t,i,a,n){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var r=function(t){function i(){var e=null!==t&&t.apply(this,arguments)||this;return e.ariaLabelText=new n.Observable(""),e.screenNarrationEnabled=!0,e._numNarrateDeactivations=0,e}return e(i,t),i.prototype.initialize=function(e){var i=this;t.prototype.initialize.call(this,e),this.app.command("EnableScreenReaderNarrate").register(this,function(){i._numNarrateDeactivations=i._numNarrateDeactivations>0?--i._numNarrateDeactivations:0,0===i._numNarrateDeactivations&&(i.screenNarrationEnabled=!0,i.app.event("_screenReaderNarrationEnabled").publish())}),this.app.command("DisableScreenReaderNarrate").register(this,function(){i._numNarrateDeactivations++,i.screenNarrationEnabled=!1}),this.app.command("ScreenReaderNarrate").register(this,function(e){if(i.screenNarrationEnabled){setTimeout(function(){i.screenNarrationEnabled&&(i.app.trace.debug("ScreenReader Narration Enabled. Now Narrating: {0}".format(e)),i.ariaLabelText.set(e))},0)}else i.app.trace.debug("ScreenReader Narration Disabled by {0} components. Not narrating '{1}'".format(i._numNarrateDeactivations,e))})},i}(a.ViewModelBase);i.AccessibilityViewModel=r})},"Mapping/modules/Accessibility/AccessibilityProviders/MapTextProvider":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function a(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(a.prototype=i.prototype,new a)}}();define(["require","exports","geocortex/infrastructure/accessibility/AccessibilityProviderBase","geocortex/infrastructure/GeometryUtils","geocortex/infrastructure/FormatUtils","geocortex/infrastructure/DateFormat","geocortex/infrastructure/NumberFormat","geocortex/essentials/MapServiceConstants","geocortex/infrastructure/TaskUtils","geocortex/infrastructure/gis/LayerInfo"],function(t,i,a,n,r,o,s,c,p,l){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var u=function(t){function i(){var e=null!==t&&t.apply(this,arguments)||this;return e.fullDescription="",e.changedDescription="",e.decimalPrecision=4,e.readAttributionInformation=!1,e._viewDelay=0,e._timeoutId=null,e._eventDelay=250,e._mapReadDelay=1250,e._previousExtent=null,e._previousScale=null,e._previousTimeExtentMin=null,e._previousTimeExtentMax=null,e._queryTaskCollection=[],e._identifyTaskCollection=[],e._completedQueries=!1,e._completedIdentifies=!1,e._hasReadFullDescription=!1,e._screenReaderNarrationEnabled=!1,e}return e(i,t),i.prototype.initialize=function(e){var i=this;t.prototype.initialize.call(this,e),e.decimalPrecision>=0&&e.decimalPrecision<10?this.decimalPrecision=e.decimalPrecision:this.app.trace.warning("MapTextProvider: decimalPrecision entered in config is out of range (0-9). Using default value of "+this.decimalPrecision+"."),this.readAttributionInformation=e.readAttributionInformation,this.app.event("MapExtentChangedEvent").subscribe(this,this._delayMapDescriptionChanged),this.app.event("MapTimeExtentChangedEvent").subscribe(this,function(){return i.app.map&&i._delayMapDescriptionChanged(i.app.map.extent)}),this.app.event("MapPanStartedEvent").subscribe(this,function(e,t){clearTimeout(i._timeoutId),i._timeoutId=null}),this.app.waitUntilMapLoaded().then(function(){i._handleMapLoadedEvent(i.app.map)}),this.app.event("_screenReaderNarrationEnabled").once(this,function(){return i._screenReaderNarrationEnabled=!0})},i.prototype._handleMapLoadedEvent=function(e){var t=this;$(this.app.map.root).focus(function(e){clearTimeout(t._timeoutId),t._timeoutId=setTimeout(function(){t._handleMapDescriptionChanged(t.app.map.extent)},t._mapReadDelay)}),this.readAttributionInformation&&$(this.app.map.attribution.listNode).on("DOMSubtreeModified",function(e){t._delayMapDescriptionChanged(t.app.map.extent)})},i.prototype._delayMapDescriptionChanged=function(e){var t=this;this._previousExtent&&e.xmin===this._previousExtent.xmin&&e.xmax===this._previousExtent.xmax&&e.ymin===this._previousExtent.ymin&&e.ymax===this._previousExtent.ymax||(clearTimeout(this._timeoutId),this._timeoutId=setTimeout(function(){t._timeoutId=null,t._handleMapDescriptionChanged(e)},this._eventDelay))},i.prototype._handleMapDescriptionChanged=function(e){var t=this;if(this._screenReaderNarrationEnabled){var i="",a=function(a){0===a.length&&(a=t.app.getResource(t.libraryId,"language-accessibility-map-none"));var n=t._getTimeExtentDescription();t.fullDescription="",t.fullDescription=i,t.fullDescription+=" "+t._getScaleDescription(),n&&(t.fullDescription+=" "+n),t.fullDescription+=" "+t.app.getResource(t.libraryId,"language-accessibility-map-visible-features").format(a),t.changedDescription="";var r=!1;if(null!==t._previousExtent&&e.getCenter().x===t._previousExtent.getCenter().x&&e.getCenter().y===t._previousExtent.getCenter().y||(t.changedDescription+=i,r=!0),t._previousScale!==t.app.map.getScale()&&(t.changedDescription+=" "+t._getScaleDescription()),n&&t.app.map.timeExtent&&t.app.map.timeExtent.startTime&&t.app.map.timeExtent.endTime&&(t._previousTimeExtentMin===t.app.map.timeExtent.startTime.getTime()&&t._previousTimeExtentMax===t.app.map.timeExtent.endTime.getTime()||(t.changedDescription+=" "+n)),r&&(t.changedDescription+=" "+t.app.getResource(t.libraryId,"language-accessibility-map-visible-features").format(a)),t.readAttributionInformation){var o=t._getAttributionInformation();t.fullDescription+=" "+o,t.changedDescription+=" "+o}var s=function(e,i){setTimeout(function(){t.app.command("ScreenReaderNarrate").execute(t.app.getResource(t.libraryId,i).format(e))},t._viewDelay)};!t._hasReadFullDescription&&t.fullDescription?(t._hasReadFullDescription=!0,s(t.fullDescription,"language-accessibility-map-initialized-information")):t.changedDescription&&s(t.changedDescription,"language-accessibility-map-changed-information"),$(t.app.map.root).attr("aria-label",t.app.getResource(t.libraryId,"language-accessibility-map-focused")),t._previousExtent=e,t._previousScale=t.app.map.getScale(),t._previousTimeExtentMin=t.app.map.timeExtent&&t.app.map.timeExtent.startTime?t.app.map.timeExtent.startTime.getTime():null,t._previousTimeExtentMax=t.app.map.timeExtent&&t.app.map.timeExtent.endTime?t.app.map.timeExtent.endTime.getTime():null};this._getCentreCoordinatesDescription(e,function(n){i=n,t._setVisibleFeaturesDescription(e,a)})}},i.prototype._getCentreCoordinatesDescription=function(e,t){var i=this,a="",r="",o=new esri.SpatialReference(102100);n.projectGeometry(e,o,function(e){if(e instanceof esri.geometry.Extent){var n=e;a=i._getFormattedLatitudeString(n),r=i._getFormattedLongitudeString(n)}t(i.app.getResource(i.libraryId,"language-accessibility-map-coordinates-introduction").format(a,r))},function(e){i.app.trace.info("Error encountered attempting to project geometry: "+e),t(i.app.getResource(i.libraryId,"language-accessibility-map-coordinates-error"))},this.app)},i.prototype._getFormattedLatitudeString=function(e){var t=r.formatNumber(Math.abs(e.getCenter().getLatitude()),s.NumberFormat.NUMBER,{fractionalDigits:this.decimalPrecision});return e.getCenter().getLatitude()>0?this.app.getResource(this.libraryId,"language-accessibility-map-coordinates-north").format(t):this.app.getResource(this.libraryId,"language-accessibility-map-coordinates-south").format(t)},i.prototype._getFormattedLongitudeString=function(e){var t=r.formatNumber(Math.abs(e.getCenter().getLongitude()),s.NumberFormat.NUMBER,{fractionalDigits:this.decimalPrecision});return e.getCenter().getLongitude()<0?this.app.getResource(this.libraryId,"language-accessibility-map-coordinates-west").format(t):this.app.getResource(this.libraryId,"language-accessibility-map-coordinates-east").format(t)},i.prototype._getScaleDescription=function(){var e=r.formatNumber(this.app.map.getScale(),s.NumberFormat.NUMBER,{fractionalDigits:this.decimalPrecision});return this.app.getResource(this.libraryId,"language-accessibility-map-scale").format(e)},i.prototype._getTimeExtentDescription=function(){var e,t;return this.app.map&&this.app.map.timeExtent&&this.app.map.timeExtent.startTime&&this.app.map.timeExtent.endTime&&(e=r.formatDate(this.app.map.timeExtent.startTime,o.DateFormat.DATE_TIME_LONG),t=r.formatDate(this.app.map.timeExtent.endTime,o.DateFormat.DATE_TIME_LONG),e&&t)?this.app.getResource(this.libraryId,"language-accessibility-map-time-extent").format(e,t):""},i.prototype._setVisibleFeaturesDescription=function(e,t){for(var i="",a=[],n=[],r=this,o=0,s=this._getVisibleLayers(e);o<s.length;o++)!function(t){if(t.mapService.mapServiceFunction===c.MapServiceFunction.BASE)return"continue";if(t.mapService.serviceLayer instanceof esri.layers.GraphicsLayer){var o=t.mapService.serviceLayer;return(l=r._countGraphicsInExtent(e,o))>0&&(i+=" "+r.app.getResource(r.libraryId,"language-accessibility-map-visible-feature-information").format(l,t.name)),"continue"}if(t.mapService.serviceLayer instanceof esri.layers.KMLLayer){for(var s=t.mapService.serviceLayer.getLayers(),p=t.mapService.displayName,l=0,u=0,d=s;u<d.length;u++){var m=d[u];m.graphics&&m.visible&&m.isVisibleAtScale(r.app.map.getScale())&&(l+=r._countGraphicsInExtent(e,m))}return l>0&&(i+=" "+r.app.getResource(r.libraryId,"language-accessibility-map-visible-feature-information").format(l,p)),"continue"}var h=t.mapService.serviceLayer;if(h.capabilities&&h.capabilities.toLowerCase().indexOf("query")<0&&h.capabilities.toLowerCase().indexOf("identify")<0)return"continue";if(!t.mapService.serviceLayer.loadError&&t.queryable&&t.supportsQuery)0===n.filter(function(e){return e.mapService.serviceUrl+"/"+e.id==t.mapService.serviceUrl+"/"+t.id}).length&&n.push(t);else if(t.identifiable&&t.supportsIdentify&&t.mapService.mapServiceType!==c.MapServiceType.WMS){var f=a.filter(function(e){return e.mapService.serviceUrl===t.mapService.serviceUrl});f.length>0&&0===f[0].layers.filter(function(e){return e.toString()===t.id}).length?f[0].layers.push(parseInt(t.id,10)):0!==f.length||t.mapService.serviceLayer.loadError||a.push({mapService:t.mapService,layers:[parseInt(t.id,10)]})}else r.app.trace.debug(t.name+" layer does not support identify or query. Not supported for screenreader.")}(s[o]);0===a.length?this._completedIdentifies=!0:this._completedIdentifies=!1,0===n.length?this._completedQueries=!0:this._completedQueries=!1,0===a.length&&0===n.length?t(i):(a.length>0&&this._performIdentify(t,i,e,a),n.length>0&&this._performQueries(t,i,e,n))},i.prototype._countGraphicsInExtent=function(e,t){for(var i=0,a=0,n=t.graphics;a<n.length;a++){var r=n[a];e.intersects(r.geometry)&&r.visible&&i++}return i},i.prototype._performIdentify=function(e,t,i,a){var n=this,r={};this._identifyTaskCollection=[],this._lastIdentifyMap&&this._lastIdentifyMap.cancel();for(var o=0,s=a;o<s.length;o++){var c=s[o],l=new esri.tasks.IdentifyParameters;l.mapExtent=i,l.geometry=i,l.layerIds=c.layers,l.layerOption=esri.tasks.IdentifyParameters.LAYER_OPTION_VISIBLE,l.returnGeometry=!1,l.tolerance=0,l.height=$(this.app.map.root).height(),l.width=$(this.app.map.root).width();var u=p.getIdentifyTask(c.mapService);this._identifyTaskCollection.push({identifyTask:u,identifyParameters:l})}this._lastIdentifyMap=Promise.map(this._identifyTaskCollection,function(e){return new Promise(function(t,i){n._lastIdentifyMap.isCancelled()||e.identifyTask.execute(e.identifyParameters,t,i)}).then(function(e){var t=e;if(!n._lastIdentifyMap.isCancelled())for(var i=0;i<t.length;i++){var a=e[i];void 0!==r[a.layerName]?r[a.layerName]+=1:r[a.layerName]=1}}).catch(function(e){n.app.trace.info("Error performing identify on server for feature count in MapTextProvider: "+e)})},{concurrency:1}).then(function(){for(var i in r)r.hasOwnProperty(i)&&r[i]>0&&(t+=" "+n.app.getResource(n.libraryId,"language-accessibility-map-visible-feature-information").format(r[i],i));!n._lastIdentifyMap.isCancelled()&&n._completedQueries&&e(t)}).catch(function(e){n.app.trace.info("Error retrieving MapTextProvider info: "+e)}).lastly(function(){n._completedIdentifies=!0})},i.prototype._performQueries=function(e,t,i,a){var n=this,r=new esri.tasks.Query;r.geometry=esri.geometry.Polygon.fromExtent(i),r.returnGeometry=!1,r.where="1=1",this._queryTaskCollection=[],null!=this._lastQueryMap&&this._lastQueryMap.cancel();for(var o=0,s=a;o<s.length;o++){var c=s[o],l=c.mapService.serviceLayer.url,u=(c.id,c.name),d=(l.split("?"),p.getQueryTask(c));this._queryTaskCollection.push({queryTask:d,layerName:u})}this._lastQueryMap=Promise.map(this._queryTaskCollection,function(e){if(!n._lastQueryMap.isCancelled())return new Promise(function(t,i){e.queryTask.executeForCount(r,t,i)}).then(function(i){i>0&&(t+=" "+n.app.getResource(n.libraryId,"language-accessibility-map-visible-feature-information").format(i,e.layerName))}).catch(function(e){n.app.trace.info("Error querying server for feature count in MapTextProvider: "+e)})},{concurrency:1}).then(function(){!n._lastQueryMap.isCancelled()&&n._completedIdentifies&&e(t)}).catch(function(e){n.app.trace.info("Error retrieving MapTextProvider info: "+e)}).lastly(function(){n._completedQueries=!0})},i.prototype._getVisibleLayers=function(e){for(var t=[],i=0,a=this.app.site.essentialsMap.allLayers();i<a.length;i++){var n=a[i],r=l.LayerInfo.fromGcxLayer(n);r.getMaxScale()>this.app.map.getScale()||r.getMinScale()<this.app.map.getScale()||r.isVisible()&&r.subLayerIds&&0===r.subLayerIds.length&&t.push(n)}return t},i.prototype._getAttributionInformation=function(){for(var e="",t=$(this.app.map.attribution.listNode).children(),i=0;i<t.length;i++){var a=t[i];"none"!==$(a).css("display")&&(e+=a.textContent+" ")}return e},i}(a.AccessibilityProviderBase);i.MapTextProvider=u})},"Mapping/modules/Accessibility/AccessibilityProviders/ViewActivatorProvider":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function a(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(a.prototype=i.prototype,new a)}}();define(["require","exports","geocortex/infrastructure/accessibility/AccessibilityProviderBase"],function(t,i,a){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=function(t){function i(){var e=null!==t&&t.apply(this,arguments)||this;return e._notifications={},e._subviewNotifications={},e._message="",e._isDataFrameOpen=!1,e._openViews=[],e._closedViews=[],e._dataFrameOpenViews=[],e._dataFrameClosedViews=[],e._currentDataFrameViewId="LayerListView",e._activeContainerViews=["LayerDataContainerView"],e.startTime=(new Date).getTime(),e.timeDelay=250,e.newEventTime=null,e._narrateViewActivation=!1,e}return e(i,t),i.prototype.initialize=function(e){var i=this;t.prototype.initialize.call(this,e),e.notifications&&(this._notifications=e.notifications),e.subviewNotifications&&(this._subviewNotifications=e.subviewNotifications),this._resetViewArrays(),this.app.event("ViewActivatedEvent").subscribe(this,this._handleViewActivated),this.app.event("ViewDeactivatedEvent").subscribe(this,this._handleViewDeactivated),this.app.event("DataFrameOpenedEvent").subscribe(this,this._handleDataFrameOpened),this.app.event("DataFrameClosedEvent").subscribe(this,this._handleDataFrameClosed),this.app.event("FlyoutActivated").subscribe(this,this._compactToolbarFlyoutActivated),this.app.event("FlyoutDeactivated").subscribe(this,this._compactToolbarFlyoutDeactivated),this.app.waitUntilApplicationReady().then(function(){i._narrateViewActivation=!0})},i.prototype._handleViewActivated=function(e){var t=this.app.getResource(this.libraryId,"language-accessibility-map-open");this.app.trace.view("View activated: "+e.id),null!=this._notifications[e.id]?(this._openViews.indexOf(e.id)>-1||this._openViews.push(e.id),this._handleView(e)):"DataRegion"==e.regionName&&this._isDataFrameOpen?(this._activeContainerViews.indexOf(e.id)>-1||(this._activeContainerViews.push(e.id),this.app.trace.view("Active container views: {0}".format(this._activeContainerViews.length.toString()))),this._handleDataRegionView(e,t)):this.app.trace.view("No corresponding notification message for "+e.id)},i.prototype._handleViewDeactivated=function(e){this.app.getResource(this.libraryId,"language-accessibility-map-closed");if(this.app.trace.view("View deactivated: "+e.id),this._activeContainerViews.indexOf(e.id)>-1){var t=this._activeContainerViews.indexOf(e.id);this._activeContainerViews.splice(t,1),this.app.trace.view("Active container views: {0}".format(this._activeContainerViews.length.toString())),0==this._activeContainerViews.length&&(this._currentDataFrameViewId="PlaceholderView")}else null!=this._notifications[e.id]?(this._closedViews.indexOf(e.id)>-1||this._closedViews.push(e.id),this._handleView(e)):null!=this._subviewNotifications[e.id]&&this._isDataFrameOpen?(this._dataFrameClosedViews.indexOf(e.id)>-1||this._dataFrameClosedViews.push(e.id),this._handleView(e)):this.app.trace.view("No corresponding notification message for "+e.id)},i.prototype._handleView=function(e){var t=this;this.newEventTime=(new Date).getTime(),setTimeout(function(){(new Date).getTime()-t.newEventTime>t.timeDelay&&t._arraysNotEmpty()&&(t._composeMessage(),t.app.trace.view("Message: {0}".format(t._message)),t.app.command("ScreenReaderNarrate").execute(t._message),t._message="",t._resetViewArrays())},this.timeDelay)},i.prototype._arraysNotEmpty=function(){return this._openViews.length>0||this._closedViews.length>0||this._dataFrameOpenViews.length>0||this._dataFrameClosedViews.length>0},i.prototype._handleDataRegionView=function(e,t){var i="";if(e.id==this.app.getResource(this.libraryId,"language-accessibility-map-workflowlist-view"))i=e.id;else{if(!e.viewModel||!e.viewModel.currentView)return;i=e.viewModel.currentView.id}if(null!=this._subviewNotifications[i]){if(i==this._currentDataFrameViewId)return void this.app.trace.view("Active view = Current data frame view.");t==this.app.getResource(this.libraryId,"language-accessibility-map-open")?(this._dataFrameOpenViews.indexOf(e.id)>-1||this._dataFrameOpenViews.push(i),null==this._currentDataFrameViewId||this._dataFrameClosedViews.indexOf(this._currentDataFrameViewId)>-1||this._dataFrameClosedViews.push(this._currentDataFrameViewId),this._currentDataFrameViewId=i):this._dataFrameClosedViews.indexOf(this._currentDataFrameViewId)>-1||this._dataFrameClosedViews.push(i),this._handleView(e)}else this._handleView(e)},i.prototype._composeMessage=function(){this._isDataFrameOpen||(this._dataFrameOpenViews=[]),this._addOpenViews(),this._addDataFrameOpenViews(),this._addClosedViews(),this._addDataFrameClosedViews()},i.prototype._addOpenViews=function(){for(var e=this.app.getResource(this.libraryId,"language-accessibility-map-open"),t=0;t<this._openViews.length;t++)this._message+=this._notifications[this._openViews[t]].format(e)},i.prototype._addClosedViews=function(){for(var e=this.app.getResource(this.libraryId,"language-accessibility-map-closed"),t=0;t<this._closedViews.length;t++)this._message+=this._notifications[this._closedViews[t]].format(e)},i.prototype._addDataFrameOpenViews=function(){for(var e=this.app.getResource(this.libraryId,"language-accessibility-map-open"),t=0;t<this._dataFrameOpenViews.length;t++)this._message+=this._subviewNotifications[this._dataFrameOpenViews[t]].format(e)},i.prototype._addDataFrameClosedViews=function(){for(var e=this.app.getResource(this.libraryId,"language-accessibility-map-closed"),t=0;t<this._dataFrameClosedViews.length;t++)this._message+=this._subviewNotifications[this._dataFrameClosedViews[t]].format(e)},i.prototype._resetViewArrays=function(){this._openViews=[],this._closedViews=[],this._dataFrameOpenViews=[],this._dataFrameClosedViews=[]},i.prototype._handleDataFrameOpened=function(){if(this._narrateViewActivation){var e=this.app.getResource(this.libraryId,"language-accessibility-map-data-frame-open"),t=this.app.getResource(this.libraryId,"language-accessibility-map-open");e+=this._subviewNotifications[this._currentDataFrameViewId].format(t),this._isDataFrameOpen=!0,this.app.trace.view(e),this.app.command("ScreenReaderNarrate").execute(e)}},i.prototype._handleDataFrameClosed=function(){var e=this.app.getResource(this.libraryId,"language-accessibility-map-data-frame-closed");this._isDataFrameOpen=!1,this.app.trace.view(e),this.app.command("ScreenReaderNarrate").execute(e)},i.prototype._compactToolbarFlyoutActivated=function(e){e.id===this.app.getResource(this.libraryId,"language-accessibility-map-compact-toolbar-view")&&(this.app.trace.view("View activated: "+e.id),this._openViews.push(e.id),this._handleView(e))},i.prototype._compactToolbarFlyoutDeactivated=function(e){e.id===this.app.getResource(this.libraryId,"language-accessibility-map-compact-toolbar-view")&&(this.app.trace.view("View deactivated: "+e.id),this._closedViews.push(e.id),this._handleView(e))},i}(a.AccessibilityProviderBase);i.ViewActivatorProvider=n})},"url:/Mapping/modules/Accessibility/AccessibilityButtonView.html":t,"url:/Mapping/modules/Accessibility/AccessibilityIconView.html":i,"url:/Mapping/modules/Accessibility/AccessibilityView.html":a}}),require(["geocortex/framework/resourceManager"],function(e){e.resourceManager.register("Mapping","inv","Mapping/modules/Accessibility/CSS/common.css","css","LnZpZXcuQWNjZXNzaWJpbGl0eVZpZXcgew0KICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsNCiAgICB6LWluZGV4OiAtMTsNCn0NCi5rZXlib2FyZC1mb2N1cy1hY3RpdmUgOmZvY3VzLA0KLmtleWJvYXJkLWZvY3VzLWFjdGl2ZSAjbWFwX3Jvb3Q6Zm9jdXM6YWZ0ZXIsDQoua2V5Ym9hcmQtZm9jdXMtYWN0aXZlIC5nY3gtdG9nZ2xlIC5pbnB1dC1jaGVja2JveDpmb2N1cyArIC5pbnB1dC1sYWJlbDpiZWZvcmUgew0KICAgIG91dGxpbmU6IDJweCBzb2xpZDsNCiAgICBvdXRsaW5lLW9mZnNldDogLTJweDsNCn0NCi5rZXlib2FyZC1mb2N1cy1hY3RpdmUgLmdjeC10b2dnbGUgLmlucHV0LWNoZWNrYm94OmZvY3VzICsgLmlucHV0LWxhYmVsOmFmdGVyIHsNCiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB0cmFuc3BhcmVudDsNCiAgICBib3JkZXI6IDNweCBzb2xpZCAjRkZGRkZGOw0KfQ0KLmtleWJvYXJkLWZvY3VzLWFjdGl2ZSAjbWFwX3Jvb3Q6Zm9jdXM6YWZ0ZXIgew0KICAgIGNvbnRlbnQ6Jyc7DQogICAgbGVmdDogMDsNCiAgICByaWdodDogMDsNCiAgICB0b3A6IDA7DQogICAgYm90dG9tOiAwOw0KICAgIGRpc3BsYXk6IGJsb2NrOw0KICAgIHotaW5kZXg6IDEwOw0KICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsNCiAgICBwb2ludGVyLWV2ZW50czogbm9uZTsNCn0NCi8qIENoYXJ0aW5nIG92ZXJyaWRlcyB0byBhbGxvdyBmb3IgZm9jdXMgc3RhdGUgKi8NCi5jaGFydCB7DQogICAgb3V0bGluZS1vZmZzZXQ6IDAhaW1wb3J0YW50Ow0KICAgIHdpZHRoOiA5OSU7DQp9DQoNCi5BY2Nlc3NpYmlsaXR5QnV0dG9uVmlldyB7DQogICAgZmxvYXQ6IHJpZ2h0Ow0KICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsNCn0NCg0KLmFjY2Vzc2liaWxpdHktYnV0dG9uIHsNCiAgICB3aWR0aDogMi41ZW07DQogICAgaGVpZ2h0OiAyLjVlbTsNCiAgICBwYWRkaW5nOiAwLjI1ZW0gMC41ZW07DQogICAgYmFja2dyb3VuZDogdXJsKFJlc291cmNlcy9JbWFnZXMvSWNvbnMvYWNjZXNzaWJpbGl0eS0zMi5wbmcpIGNlbnRlciBjZW50ZXIgbm8tcmVwZWF0Ow0KICAgIGJhY2tncm91bmQtc2l6ZTogMi41ZW0gMi41ZW07DQogICAgLXdlYmtpdC1ib3gtc2l6aW5nOiBjb250ZW50LWJveDsNCiAgICAtbW96LWJveC1zaXppbmc6IGNvbnRlbnQtYm94Ow0KICAgIGJveC1zaXppbmc6IGNvbnRlbnQtYm94Ow0KfQ0KDQovKiBFTkQ6IFVzZXIgLS0tLS0tLS0tLS0tLS0tICov"),e.resourceManager.register("Mapping","inv","Mapping/modules/Accessibility/AccessibilityButtonView.html","html",t),e.resourceManager.register("Mapping","inv","Mapping/modules/Accessibility/AccessibilityIconView.html","html",i),e.resourceManager.register("Mapping","inv","Mapping/modules/Accessibility/AccessibilityView.html","html",a)}),require({cache:{}}),define(["Mapping/modules/Accessibility/AccessibilityButtonView","Mapping/modules/Accessibility/AccessibilityIconView","Mapping/modules/Accessibility/AccessibilityIconViewModel","Mapping/modules/Accessibility/AccessibilityModule","Mapping/modules/Accessibility/AccessibilityViewModel","Mapping/modules/Accessibility/AccessibilityProviders/MapTextProvider","Mapping/modules/Accessibility/AccessibilityProviders/ViewActivatorProvider"],function(t,i,a,n,r,o,s){e(t,"geocortex.essentialsHtmlViewer.mapping.modules.accessibility.AccessibilityButtonView",t.AccessibilityButtonView),e(i,"geocortex.essentialsHtmlViewer.mapping.modules.accessibility.AccessibilityIconView",i.AccessibilityIconView),e(a,"geocortex.essentialsHtmlViewer.mapping.modules.accessibility.AccessibilityIconViewModel",a.AccessibilityIconViewModel),e(n,"geocortex.essentialsHtmlViewer.mapping.modules.accessibility.AccessibilityModule",n.AccessibilityModule),e(r,"geocortex.essentialsHtmlViewer.mapping.modules.accessibility.AccessibilityViewModel",r.AccessibilityViewModel),e(o,"geocortex.essentialsHtmlViewer.mapping.modules.accessibility.MapTextProvider",o.MapTextProvider),e(s,"geocortex.essentialsHtmlViewer.mapping.modules.accessibility.ViewActivatorProvider",s.ViewActivatorProvider)})}();