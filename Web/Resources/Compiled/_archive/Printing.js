!function(){function e(e,t,i){if("string"==typeof e&&(i=t,t=e),void 0!==i)for(var n=t.split("."),a=null,r=window,s=0,o=n.length;s<o;s++)a=n[s],s==o-1?r[a]=i:r[a]||(r[a]={}),r=r[a];else console.warn("Undefined shim for: "+t)}var t="<div class='printing'>    <div class='print-status' data-binding='{@visible: isPrinting}'>        <p data-binding='{@text: @language-is-printing}{@var: isPrintingText}'>...</p>    </div>    <div class='print-create' data-binding='{@hidden: printComplete}'>        <div class='print-status' data-binding='{@hidden: selectedTemplate}'>            <p data-binding='{@text: @language-no-print-template}'></p>        </div>        <div data-binding='{@hidden: isPrinting}{@visible: selectedTemplate}'>            <div data-binding='{@visible:previewIsEnabled}'>                <div class='form-btns' data-binding='{@visible:mobileMode}'>                    <button class='button print-center-button' data-binding='{@event-click: handleReCenterClick}{@text: @language-print-preview-center}'></button>                    <button class='button toggle-preview-button' data-binding='{@hidden: previewIsVisible}{@event-click: handleTogglePreviewClick}{@text: @language-print-show-preview-center}'></button>                    <button class='button toggle-preview-button' data-binding='{@visible: previewIsVisible}{@event-click: handleTogglePreviewClick}{@text: @language-print-hide-preview-center}'></button>                </div>            </div>            <label for='selectTemplate' data-binding='{@text: @language-select-layout}'></label>            <select id='selectTemplate' data-binding='{@source: printTemplates}{@value: selectedTemplate}{@event-onchange: handleTemplateSelectionChanged}'>                <option data-binding='{@template-for: printTemplates}{@text: displayName}{@attach: @context}'></option>            </select>            <label for='outputFormat' data-binding='{@text: @language-output-format}{@visible: outputFormats}'></label>            <select id='outputFormat' data-binding='{@source: outputFormats}{@value: selectedFormat}{@visible: outputFormats}'>                <option data-binding='{@template-for: outputFormats}{@text: @context}{@attach: @context}'></option>            </select>            <label for='resolution' data-binding='{@text: @language-resolution}{@visible: resolutions}'></label>            <select id='resolution' data-binding='{@source: resolutions}{@value: selectedResolution}{@visible: resolutions}'>                <option data-binding='{@template-for: resolutions}{@text: displayName}{@attach: @context}'></option>            </select>            <label for='grids' data-binding='{@text: @language-grid}{@visible: grids}'></label>            <select id='grids' data-binding='{@source: grids}{@value: selectedGrid}{@visible: grids}'>                <option data-binding='{@template-for: grids}{@text: displayName}{@attach: @context}'></option>            </select>            <label for='mapscale' data-binding='{@text: @language-map-scale}{@visible: scales}'></label>            <select id='mapscale' data-binding='{@source: scales}{@value: selectedScale}{@visible: scales}{@event-onchange: handleScaleSelectionChanged}'>                <option data-binding='{@template-for: scales}{@text: displayName}{@attach: @context}'></option>            </select>            <div data-binding='{@source: textFields}'>                <div data-binding='{@template-for: textFields}'>                    <label data-binding='{@hidden: multiline}'>                        <span data-binding='{@text: displayName}'></span>                        <input type='text' data-binding='{@value: value}{@hidden: multiline}' />                    </label>                    <label data-binding='{@visible: multiline}'>                        <span data-binding='{@text: displayName}'></span>                        <textarea cols='20' rows='4' data-binding='{@value: value}{@visible: multiline}'></textarea>                    </label>                </div>            </div>            <label for='printingEmailAddress' data-binding='{@text: @language-printing-email-address}{@visible: supportsEmailNotification}'></label>            <input id='printingEmailAddress' type='text' data-binding='{@value: emailAddress}{@visible: supportsEmailNotification}' />            <div class='form-btns'>                <div data-binding='{@visible:previewIsEnabled}'>                    <label class='print-preview-toggler' data-binding='{@hidden:mobileMode}'>                        <input type='checkbox' data-binding='{@value: printPreviewIsLocked}{disabled: printPreviewLockTogglerIsDisabled}' />                        <span data-binding='{@text: @language-print-preview-lock}'></span>                    </label>                </div>                <button class='button print-button' data-binding='{@event-click: handlePrintClick}{@text: @language-print}'></button>                <button class='button print-cancel-button' data-binding='{@event-click: handleCancelClick}{@text: @language-common-cancel}'></button>            </div>        </div>    </div>    <div class='print-complete' data-binding='{@visible: printComplete}'>        <div data-binding='{@hidden: supportsEmailNotification}'>            <p data-binding='{@text: @language-print-complete-description}'></p>            <div class='form-btns'>                <a class='button print-button' data-binding='{@event-click: handleOpenFileClick}{@text: @language-open-file}' target='_blank' href=''></a>            </div>        </div>        <div data-binding='{@visible: supportsEmailNotification}'>            <p data-binding='{@text: @language-printing-print-request-start-description}'></p>            <div data-binding='{@visible: validEmailAddressSupplied}'>                <p data-binding='{@text: @language-printing-print-request-description}'></p>            </div>            <div data-binding='{@hidden: validEmailAddressSupplied}'>                <p data-binding='{@text: @language-printing-print-request-status-description}'></p>                <div class='form-btns'>                    <a class='button print-button' data-binding='{@event-click: handleOpenFileClick}{@text: @language-printing-print-job-status}' target='_blank' href=''></a>                </div>            </div>        </div>    </div></div>",i="<div class='printing-peephole-container'>    <div class='printing-peephole' data-binding='{@var:peephole}'>        <img class='printing-peephole-img' data-binding='{alt: @language-printing-center-cross}' src='Resources/Images/center-cross-32.png' />    </div></div>";require({cache:{"Mapping/modules/Printing/Printing5Client":function(){var e=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))(function(a,r){function s(e){try{l(n.next(e))}catch(e){r(e)}}function o(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){e.done?a(e.value):new i(function(t){t(e.value)}).then(s,o)}l((n=n.apply(e,t||[])).next())})},t=this&&this.__generator||function(e,t){function i(e){return function(t){return n([e,t])}}function n(i){if(a)throw new TypeError("Generator is already executing.");for(;l;)try{if(a=1,r&&(s=r[2&i[0]?"return":i[0]?"throw":"next"])&&!(s=s.call(r,i[1])).done)return s;switch(r=0,s&&(i=[0,s.value]),i[0]){case 0:case 1:s=i;break;case 4:return l.label++,{value:i[1],done:!1};case 5:l.label++,r=i[1],i=[0];continue;case 7:i=l.ops.pop(),l.trys.pop();continue;default:if(s=l.trys,!(s=s.length>0&&s[s.length-1])&&(6===i[0]||2===i[0])){l=0;continue}if(3===i[0]&&(!s||i[1]>s[0]&&i[1]<s[3])){l.label=i[1];break}if(6===i[0]&&l.label<s[1]){l.label=s[1],s=i;break}if(s&&l.label<s[2]){l.label=s[2],l.ops.push(i);break}s[2]&&l.ops.pop(),l.trys.pop();continue}i=t.call(e,l)}catch(e){i=[6,e],r=0}finally{a=s=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}var a,r,s,o,l={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return o={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o};define(["require","exports","geocortex/infrastructure/GeometryUtils"],function(i,n,a){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=function(){function n(){}return n.runPrint=function(n,a,r,s){return e(this,void 0,void 0,function(){var e,o,l,p;return t(this,function(t){switch(t.label){case 0:return(e=n&&n.reportUrl?n.reportUrl:void 0)||Promise.reject(new Error("A report URL is required.")),r||Promise.reject("Report parameters are required"),o=a.site.getTokenFromPrincipal(e,esri.IdentityManagerBase),[4,this._marshalReportParameters(n,r,a,s)];case 1:return l=t.sent(),p=function(t,n){i(["Resources/Scripts/@geocortex/printing-api/index"],function(i){i.PrintManager.runPrint(e,l,o).then(function(e){t(e)}).catch(function(e){n(e)}).error(function(e){n(e)})})},[2,new Promise(p)]}})})},n.getMetadata=function(n,a,r){return e(this,void 0,void 0,function(){var e,s,o,l=this;return t(this,function(t){return n||Promise.resolve([]),e=n.reportUrl,String.isNullOrEmpty(e)&&Promise.resolve([]),s=a.site.getTokenFromPrincipal(e,esri.IdentityManagerBase),o=function(t,o){i(["Resources/Scripts/@geocortex/printing-api/index"],function(i){i.PrintManager.describeTemplate(e,s).then(function(e){l._setMainMapDimensions(n,e);var i=l._marshalTemplateParameters(e);l._addDefaultGrids(n,a,r),t(i)}).catch(function(e){o(e)}).error(function(e){o(e)})})},[2,new Promise(o)]})})},n._marshalTemplateParameters=function(e){var t=[];if(!e||!e.parameters)return t;for(var i=0,n=e.parameters;i<n.length;i++){var a=n[i],r={name:a.name,purpose:a.purpose,visible:a.visible,containsMultipleValues:a.containsMultipleValues,containsSingleValue:a.containsSingleValue,description:a.description,value:a.value,values:a.values,valueType:a.valueType};t.push(r)}return t},n._marshalReportParameters=function(i,n,a,r){return e(this,void 0,void 0,function(){var e,s,o,l,p,d;return t(this,function(t){switch(t.label){case 0:return e=i.templateParameters,s=n.resolution?n.resolution.dpi:96,o=this._marshalTextFieldParameters(e,n.fields),[4,this._marshalMainMapParameters(e,n,r,a)];case 1:return l=t.sent(),p=o.concat(l),d={dpi:s,parameters:p},[2,d]}})})},n._marshalTextFieldParameters=function(e,t){var i=e.filter(function(e){return"Text"===e.purpose}),n=[];if(!t)return n;for(var a=0,r=t;a<r.length;a++)for(var s=r[a],o=0,l=i;o<l.length;o++){var p=l[o];if(s.id===p.name){var d={name:s.id,containsMultipleValues:!1,containsSingleValue:!0,value:s.value};n.push(d)}}return n},n._marshalMainMapParameters=function(e,t,i,n){var r=[];if(i&&i.operationalLayers||Promise.resolve(r),e&&0!==e.filter(function(e){return"_MainMap_itemid"===e.name}).length||Promise.resolve(r),e.filter(function(e){return"_MainMap_scale"===e.name}).length>0){var s={name:"_MainMap_scale",containsSingleValue:!0,value:parseFloat(t.scale.scale)||0};r.push(s)}if(e.filter(function(e){return"_MainMap_gridspatialreference"===e.name}).length>0){var o=void 0;if(t.grid){var l=t.grid.id;if("latLng"===l)o="4326";else if("measured"===l){var p=i.mapOptions.spatialReference;o=p.wkid?""+p.wkid:p.wkt}else o=void 0}else o=void 0;var d={name:"_MainMap_gridspatialreference",containsSingleValue:!0,value:o};r.push(d)}var c={operationalLayers:i.operationalLayers,spatialReference:i.mapOptions.spatialReference},h=t.customExtent;if(!h||isNaN(h.xmin)||isNaN(h.xmax)||isNaN(h.ymin)||isNaN(h.ymax)){var u=i.mapOptions.extent;h=new esri.geometry.Extent({xmin:u.xmin,xmax:u.xmax,ymin:u.ymin,ymax:u.ymax,spatialReference:u.spatialReference})}var g=new esri.SpatialReference(4326);return new Promise(function(e,t){a.projectGeometry(h,g,function(t){var i={$type:"Parameters.WebMap",name:"_MainMap_itemid",item:{type:"Web Map",extent:[[t.xmin,t.ymin],[t.xmax,t.ymax]]},itemData:c};r.push(i),e(r)},function(e){t(e)},n)})},n._addDefaultGrids=function(e,t,i){e&&(e.grids&&0!==e.grids.length||(e.grids=[{id:"measured",displayName:t.getResource(i,"language-printing-measure-units")},{id:"latLng",displayName:t.getResource(i,"language-printing-latitude-longitude")}]))},n._setMainMapDimensions=function(e,t){if(t&&t.controls)for(var i=0,n=t.controls;i<n.length;i++){var a=n[i];"Map"===a.controlType&&"MainMap.MapView"===a.purpose&&(e.mainMapHeight=this._convertMmToInches(a.height),e.mainMapWidth=e.mainMapWidth=this._convertMmToInches(a.width))}},n._convertMmToInches=function(e){return e/25.4},n}();n.Printing5Client=r})},"Mapping/modules/Printing/PrintingModule":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();define(["require","exports","geocortex/framework/application/ModuleBase"],function(t,i,n){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var a=function(t){function i(){return null!==t&&t.apply(this,arguments)||this}return e(i,t),i}(n.ModuleBase);i.PrintingModule=a})},"Mapping/modules/Printing/PrintingView":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();define(["require","exports","geocortex/framework/ui/ViewBase","geocortex/infrastructure/DistanceConverter","geocortex/essentials/DistanceUnit","geocortex/infrastructure/MapUtils"],function(t,i,n,a,r,s){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var o=function(t){function i(){return null!==t&&t.apply(this,arguments)||this}return e(i,t),i.prototype.attach=function(e){var i=this;t.prototype.attach.call(this,e),this.viewModel.printPreviewIsLocked.bind(this,this.lockModeHasChanged),this.app.command("PrintMap").register(this,function(){i.viewModel.printComplete.set(!1),i.app.viewManager.activateView(i),i.app.configuration.mobileMode||i.initializePrintPreview()},function(){return i.app.site&&i.app.site.hasPrintTemplates&&i.viewModel.templatesAreInitialized.get()});var n=this.app.site;n&&n.isInitialized?this.siteInitializedEvent():this.app.event("SiteInitializedEvent").once(this,this.siteInitializedEvent)},i.prototype.siteInitializedEvent=function(){var e=this;this.viewModel.previewIsEnabled.set(a.canConvert(this.app.site.essentialsMap.units.type.replace("_",""),r.DistanceUnitType.INCHES)),this.viewModel.previewIsEnabled.get()&&(this.app.event("PrintTemplateStartedEvent").subscribe(this,this.hidePrintPreview),this.app.event("PrintTemplateCompletedEvent").subscribe(this,this.printTemplateCompletedEvent),this.app.configuration.mobileMode&&this.app.event("DataFrameOpenedEvent").subscribe(this,function(t){e.bottomPanelPercHeight=t;var i=document.body.clientHeight,n=i-i*t;e.adaptMapScale(n)})),this.viewModel.siteInitialized()},i.prototype.initializePrintPreview=function(){this.viewModel.previewIsEnabled.get()&&(this.viewModel.previewIsVisible.get()?this.addGraphicPrintPreview():(this.viewModel.setScales(this.viewModel.selectedTemplate.get()),this.viewModel.printPreviewIsLocked.set(!0),this.viewModel.graphic||this.addGraphicPrintPreview()))},i.prototype.activated=function(){this.viewIsActivated=!0,this.viewModel.printPreviewLockTogglerIsDisabled.set(!1)},i.prototype.deactivated=function(){this.viewIsActivated=!1,this.viewModel.previewIsEnabled.get()&&this.resetPrintPreview(),this.app.configuration.mobileMode||this.app.command("DeactivateView").execute("UnlockedPrintPreviewView")},i.prototype.printTemplateCompletedEvent=function(){this.viewModel.printPreviewIsLocked.get()&&this.addGraphicPrintPreview({scale:this.viewModel.printPreviewScale,extent:this.viewModel.printPreviewExtent})},i.prototype.handleTemplateSelectionChanged=function(e,t,i){this.viewModel.updatePrintTemplate(),this.viewModel.previewIsVisible.get()&&this.viewModel.previewIsEnabled.get()&&this.viewModel.printPreviewIsLocked.get()&&this.addGraphicPrintPreview(),this.app.event("PrintPreviewLayoutChangedEvent").publish()},i.prototype.handleScaleSelectionChanged=function(e,t,i){var n=this;return setTimeout(function(){n.viewModel.previewIsVisible.get()&&n.viewModel.previewIsEnabled.get()&&n.viewModel.printPreviewIsLocked.get()&&n.addGraphicPrintPreview();var e=parseFloat(n.viewModel.selectedScale.get().scale);e?(n.app.command("ZoomToScale").execute(e),n.viewModel.printPreviewLockTogglerIsDisabled.get()&&n.viewModel.printPreviewLockTogglerIsDisabled.set(!1)):(n.viewModel.printPreviewLockTogglerIsDisabled.set(!0),n.viewModel.printPreviewIsLocked.get()&&n.viewModel.printPreviewIsLocked.set(!1)),n.app.event("PrintPreviewScaleChangedEvent").publish()}),!0},i.prototype.handlePrintClick=function(e,t,i){var n=this;this.viewModel.performPrint(),setTimeout(function(){var e=$(n.isPrintingText).parent();$(n.isPrintingText).detach().appendTo(e)},1e3)},i.prototype.handleOpenFileClick=function(e,t,i){return t.href=this.viewModel.url.get(),this.viewModel.printComplete.set(!1),!0},i.prototype.lockModeHasChanged=function(e){this.viewModel.printPreviewIsLocked.get()?this.addGraphicPrintPreview({extent:this.viewModel.printPreviewExtent}):this.hidePrintPreview()},i.prototype.handleReCenterClick=function(e,t,i){this.viewModel.previewIsEnabled.get()&&this.addGraphicPrintPreview({adaptMapScale:this.app.configuration.mobileMode})},i.prototype.handleCancelClick=function(){this.app.viewManager.deactivateView(this)},i.prototype.handleTogglePreviewClick=function(){this.viewModel.previewIsVisible.get()?this.hidePrintPreview():this.viewModel.graphic?this.showPrintPreview():this.addGraphicPrintPreview({adaptMapScale:this.app.configuration.mobileMode})},i.prototype.resetPrintPreview=function(){this.hidePrintPreview(),this.viewModel.graphic=null,this.imageGraphic=null,this.viewModel.printPreviewExtent=null,this.viewModel.printPreviewScale=null},i.prototype.showPrintPreview=function(){this.viewModel.previewIsVisible.set(!0),this.viewModel.graphic&&this.app.map.graphics.add(this.viewModel.graphic),this.imageGraphic&&this.app.map.graphics.add(this.imageGraphic)},i.prototype.hidePrintPreview=function(){this.viewModel.previewIsVisible.set(!1),this.viewModel.graphic&&this.app.map.graphics.remove(this.viewModel.graphic),this.imageGraphic&&this.app.map.graphics.remove(this.imageGraphic)},i.prototype.addGraphicPrintPreview=function(e){e||(e={}),this.resetPrintPreview();var t=e.extent?e.extent.getCenter():this.app.map.extent.getCenter(),i=e.scale?e.scale:parseFloat(this.viewModel.selectedScale.get().scale);i||(this.viewModel.printPreviewScale=null);var n=this.viewModel.calculateWidthAndHeightFromSelectedPrintTemplate(i);if(this.viewModel.graphic=this.viewModel.getGraphicFromPrintTemplate(t,n.width,n.height),this.app.map.graphics.add(this.viewModel.graphic),this.imageGraphic=new esri.Graphic,this.imageGraphic.setSymbol(this.viewModel.imageSymbol),this.imageGraphic.setGeometry(t),this.app.map.graphics.add(this.imageGraphic),this.imageGraphic.show(),this.viewModel.previewIsVisible.set(!0),this.viewModel.printPreviewExtent=this.viewModel.graphic.geometry.getExtent(),this.viewModel.printPreviewScale=i,this.app.configuration.mobileMode&&this.bottomPanelPercHeight)var a=document.body.clientHeight,r=a-a*this.bottomPanelPercHeight;else this.app.configuration.mobileMode||(r=this.app.map.height);e.adaptMapScale&&r&&this.adaptMapScale(r)},i.prototype.adaptMapScale=function(e){var t=this.app.map.getScale();if(s.getClosestScale(this.app.map,s.ScaleChangeMode.GreaterThan,t+1)!==t+1&&this.viewModel.graphic&&this.viewModel.previewIsVisible.get()){var i,n=this.viewModel.getGraphicPositionFromExtent(this.viewModel.printPreviewExtent),a=n.width>n.height?n.height:n.width,r=1,o=a/r;if(a>e){for(;e<o;)o/=r=(i=s.getClosestScale(this.app.map,s.ScaleChangeMode.GreaterThan,t+1))/t,t=i;this.app.command("ZoomToScale").execute(i)}}},i}(n.ViewBase);i.PrintingView=o})},"Mapping/modules/Printing/PrintingViewModel":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();define(["require","exports","geocortex/framework/ui/ViewModelBase","geocortex/framework/observables","geocortex/essentials/TextField","geocortex/essentials/ReportParameters","geocortex/essentials/exportMap/ExportMapParameters","geocortex/essentials/exportMap/ExportMapTask","geocortex/infrastructure/DistanceConverter","geocortex/essentials/DistanceUnit","geocortex/essentials/Report","./Printing5Client"],function(t,i,n,a,r,s,o,l,p,d,c,h){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var u=function(t){function i(e,i){var n=t.call(this,e,i)||this;return n.printTemplates=new a.ObservableCollection,n.outputFormats=new a.ObservableCollection,n.resolutions=new a.ObservableCollection,n.scales=new a.ObservableCollection,n.grids=new a.ObservableCollection,n.textFields=new a.ObservableCollection,n.textFied=new a.Observable(null),n.selectedTemplate=new a.Observable(null),n.selectedScale=new a.Observable(null),n.selectedResolution=new a.Observable(null),n.selectedFormat=new a.Observable(null),n.selectedGrid=new a.Observable(null),n.supportsEmailNotification=new a.Observable(!1),n.validEmailAddressSupplied=new a.Observable(!1),n.emailAddress=new a.Observable(null),n.isPrinting=new a.Observable(!1),n.printComplete=new a.Observable(!1),n.isMapLoaded=new a.Observable(!1),n.url=new a.Observable(null),n.previewIsVisible=new a.Observable(!1),n.printPreviewIsLocked=new a.Observable(!0),n.previewIsEnabled=new a.Observable(!1),n.printPreviewLockTogglerIsDisabled=new a.Observable(!1),n.templatesAreInitialized=new a.Observable(!1),n.mobileMode=new a.Observable(n.app.configuration.mobileMode),n}return e(i,t),i.prototype.initialize=function(e){var t=e.previewBackgroundColor||[207,76,64,.3],i=e.previewBorderColor||[128,128,128],n=e.previewBorderThickness||2;this.printPreviewSymbol=new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new esri.Color(i),n),new esri.Color(t));var a=e.previewCenterImageUrl||"Resources/Images/center-cross-32.png";this.imageSymbol=new esri.symbol.PictureMarkerSymbol(a,32,32)},i.prototype.siteInitialized=function(){var e=this,t=[];if(this.app.site&&this.app.site.hasPrintTemplates){this.printTemplates.addItems(this.app.site.printTemplates);for(var i=this,n=this.printTemplates.getLength()-1;n>=0;n--)!function(n){var a=i.printTemplates.getAt(n);if(a.reportUrl){var r=i.initializeTemplate(a);r.then(function(t){t||e.printTemplates.removeItem(a)}),t.push(r)}}(n)}Promise.all(t).then(function(){for(var t=e.printTemplates.getLength()-1;t>=0;t--){var i=e.printTemplates.getAt(t);!1!==i.visible?!0===i.isDefault&&e.selectedTemplate.set(i):e.printTemplates.removeItem(i)}null===e.selectedTemplate.get()&&e.selectedTemplate.set(e.printTemplates.getAt(0)),e.updatePrintTemplate(),e.isMapLoaded.set(!0),e.templatesAreInitialized.set(e.printTemplates.get().length>0),e.app.command("PrintMap").raiseCanExecuteChanged()})},i.prototype.performPrint=function(){var e=this;this.isPrinting.set(!0);var t=this.selectedTemplate.get();this.app.command("ScreenReaderNarrate").execute(this.app.getResource(this.libraryId,"language-is-printing"));var i=new s.ReportParameters;if(i.outputFormat=this.selectedFormat.get(),i.resolution=this.selectedResolution.get(),i.grid=this.selectedGrid.get(),i.fields=t.textFields,i.customExtent=this.printPreviewExtent,i.scale=this.selectedScale.get(),i.scale.scale){var n=parseFloat(i.scale.scale);i.scale.scale=n.toFixed(6)}""===i.scale.scale?i.extentType=s.ReportParameters.CURRENT_EXTENT:i.extentType=s.ReportParameters.CUSTOM_EXTENT,this.supportsEmailNotification.get()&&(String.isNullOrEmpty(this.emailAddress.get())?this.validEmailAddressSupplied.set(!1):(i.notificationEmailAddress=this.emailAddress.get(),this.validEmailAddressSupplied.set(!0))),this.app.event("PrintTemplateStartedEvent").publish(t);var a=new o.ExportMapParameters;a.reportParameters=i;var r=new l.ExportMapTask(t);t.type===c.ReportType.MAP_URL_REPORT?(""===i.scale.scale&&(i.scale.scale="0"),r.generateWebMapJson(a).then(function(n){h.Printing5Client.runPrint(t,e.app,i,n).then(function(t){e._printSuccess({href:t})},function(t){return e._printError(t)})})):r.generateMapImageUrl(a).then(function(t){return e._printSuccess(t)},function(t){return e._printError(t)})},i.prototype._printError=function(e){this.app.command("Alert").execute("Print error: "+e.message),this.app.command("ScreenReaderNarrate").execute("Print error: "+e.message),this.app.event("PrintTemplateErrorEvent").publish({name:"PrintTemplateError",message:e.message}),this.isPrinting.set(!1)},i.prototype._printSuccess=function(e){this.isPrinting.set(!1),this.url.set(e.href),this.printComplete.set(!0),this.app.command("ScreenReaderNarrate").execute(this.app.getResource(this.libraryId,"language-print-complete-description")),this.app.command("LogOptimizerEvent").execute("PrintMap",this.selectedTemplate.get().displayName),this.app.event("PrintTemplateCompletedEvent").publish(this.selectedTemplate.get())},i.prototype.updatePrintTemplate=function(){var e=this.selectedTemplate.get();e&&(this.setOutputFormats(e),this.setResolutions(e),this.setGrids(e),this.setScales(e),this.setTextFields(e),this.setEmailNotification(e))},i.prototype.setOutputFormats=function(e){this.outputFormats.clear(),e.supportedOutputFormats&&(this.outputFormats.addItems(e.supportedOutputFormats),e.defaultOutputFormat?this.selectedFormat.set(e.defaultOutputFormat):this.selectedFormat.set(this.outputFormats.getAt(0)))},i.prototype.setResolutions=function(e){this.resolutions.clear(),e.supportedResolutions&&(this.resolutions.addItems(e.supportedResolutions),e.defaultResolution?this.selectedResolution.set(e.defaultResolution):this.selectedResolution.set(this.resolutions.getAt(0)))},i.prototype.setGrids=function(e){if(this.grids.clear(),e.grids&&e.grids.length){var t=this.app.getResource(this.libraryId,"language-printing-none");this.grids.addItem({id:null,displayName:t}),this.grids.addItems(e.grids),e.defaultGrid?this.selectedGrid.set(e.defaultGrid):this.selectedGrid.set(this.grids.getAt(0))}},i.prototype.setScales=function(e){this.scales.clear();var t=this.app.getResource(this.libraryId,"language-printing-current-scale"),i=esri.geometry.getScale(this.app.map),n={displayName:t+" - 1: "+Math.round(i),scale:i.toString()};this.scales.addItem({displayName:t+" - 1: "+Math.round(i),scale:i.toString()});var a={displayName:this.app.getResource(this.libraryId,"language-printing-current-extent"),scale:""};this.scales.addItem(a),e.supportedMapScales&&e.supportedMapScales.length&&this.scales.addItems(e.supportedMapScales),this.selectedScale.set(this.scales.getAt(0)),e.defaultMapScale?this.selectedScale.set(e.defaultMapScale):e.defaultMapScaleName&&("Current Extent"===e.defaultMapScaleName?this.selectedScale.set(a):"Current Scale"===e.defaultMapScaleName&&this.selectedScale.set(n))},i.prototype.setTextFields=function(e){if(this.textFields.clear(),e.textFields&&e.textFields.length>0){for(var t=[],i=0;i<e.textFields.length;i++){var n=e.textFields[i],r={};for(var s in n)if(n.hasOwnProperty(s)){var o=this._setupObservablePrimitive(o,s,n);r[s]=o}t.push(new a.Observable(r))}this.textFields.addItems(t)}},i.prototype.adjustCustomExtent=function(e,t,i){var n,a=e.getWidth(),r=e.getHeight(),s=a/r,o=t/i;if(o!==s){var l=void 0,p=void 0;s>o?(p=a,l=a/o):(l=r,p=r*o);var d=e.getCenter(),c=p/2,h=l/2,u=d.x-c,g=d.y-h,m=d.x+c,v=d.y+h;n=new esri.geometry.Extent(u,g,m,v,e.spatialReference)}else n=e;return n},i.prototype.getGraphicFromPrintTemplate=function(e,t,i){var n=new esri.geometry.Polygon(this.app.map.spatialReference),a=new Array;return a.push(new esri.geometry.Point(e.x-t/2,e.y-i/2)),a.push(new esri.geometry.Point(e.x-t/2,e.y+i/2)),a.push(new esri.geometry.Point(e.x+t/2,e.y+i/2)),a.push(new esri.geometry.Point(e.x+t/2,e.y-i/2)),a.push(new esri.geometry.Point(e.x-t/2,e.y-i/2)),n.addRing(a),new esri.Graphic(n,this.printPreviewSymbol)},i.prototype.getGraphicPositionFromExtent=function(e){var t=this.app.map.toScreen(new esri.geometry.Point(e.xmin,e.ymax,this.app.map.spatialReference)),i=this.app.map.toScreen(new esri.geometry.Point(e.xmax,e.ymin,this.app.map.spatialReference));return{top:t.y,left:t.x,width:i.x-t.x,height:i.y-t.y}},i.prototype.calculateWidthAndHeightFromSelectedPrintTemplate=function(e){var t,i;if(e)t=p.convert(this.app.site.essentialsMap.units.type.replace("_",""),this.selectedTemplate.get().mainMapWidth*e,d.DistanceUnitType.INCHES),i=p.convert(this.app.site.essentialsMap.units.type.replace("_",""),this.selectedTemplate.get().mainMapHeight*e,d.DistanceUnitType.INCHES);else{var n=this.adjustCustomExtent(this.app.map.extent,this.selectedTemplate.get().mainMapWidth,this.selectedTemplate.get().mainMapHeight);t=n.getWidth(),i=n.getHeight()}return{width:t,height:i}},i.prototype.calculateExtentFromPrintTemplate=function(e,t){t=t||parseFloat(this.selectedScale.get().scale);var i=this.calculateWidthAndHeightFromSelectedPrintTemplate(t),n=new esri.geometry.Point(e.x-i.width/2,e.y+i.height/2),a=new esri.geometry.Point(e.x+i.width/2,e.y-i.height/2);return new esri.geometry.Extent(n.x,a.y,a.x,n.y,this.app.map.spatialReference)},i.prototype.initializeTemplate=function(e){var t=this;return h.Printing5Client.getMetadata(e,this.app,this.libraryId).then(function(i){return e.templateParameters=i,e.textFields=t._populateTextFields(i),!0}).catch(function(i){return t.app.trace.warning(t.app.getResource(t.libraryId,"language-printing-metadata-error").format(e.id,e.reportUrl,i.message)),!1})},i.prototype._setupObservablePrimitive=function(e,t,i){return(e=new a.Observable(i[t])).set=function(n){i[t]=n,e.value=n,e.bindingEvent.publish(n)},e.get=function(){return i[t]},e},i.prototype.setEmailNotification=function(e){this.supportsEmailNotification.set(e.supportsEmailNotification)},i.prototype._populateTextFields=function(e){var t=[];if(!e||0===e.length)return t;for(var i=0,n=e;i<n.length;i++){var a=n[i];if(a.containsSingleValue&&"string"===a.valueType&&"Text"===a.purpose){var r=this._createTextField(a);t.push(r)}}return t},i.prototype._createTextField=function(e){if("string"!==e.valueType)throw new Error("Invalid argument. Expected a string, received type "+e.valueType);var t=e.description,i=e.name,n="";if(e.containsSingleValue&&e.value)n=e.value;else if(e.containsMultipleValues&&e.values){var a=e.values,s=a[Object.keys(a)[0]];n=s||n}return new r.TextField(i,t,n,!1)},i}(n.ViewModelBase);i.PrintingViewModel=u})},"Mapping/modules/Printing/UnlockedPrintPreviewView":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();define(["require","exports","geocortex/framework/ui/ViewBase"],function(t,i,n){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var a=function(t){function i(e,i){return t.call(this,e,i)||this}return e(i,t),i.prototype.attach=function(e){var i=this;t.prototype.attach.call(this,e),this.peephole.style.borderWidth=this.viewModel.printPreviewSymbol.outline.width+"px",this.peephole.style.borderColor=this.viewModel.printPreviewSymbol.outline.color.toCss(!0),this.peephole.style.backgroundColor=this.viewModel.printPreviewSymbol.color.toCss(!0),this.viewModel.printPreviewIsLocked.bind(this,function(e){return i.setPeepholeVisibility(e)})},i.prototype.activated=function(){this.mapZoomStartedToken||(this.mapZoomStartedToken=this.app.event("MapZoomStartedEvent").subscribe(this,this.mapZoomStartedEvent)),this.mapZoomEndedToken||(this.mapZoomEndedToken=this.app.event("MapZoomEndedEvent").subscribe(this,this.handleMapZoomEvent)),this.mapExtentChangedToken||(this.mapExtentChangedToken=this.app.event("MapExtentChangedEvent").subscribe(this,this.setExtentFromPeepholePosition)),this.selectedScaleToken||(this.selectedScaleToken=this.app.event("PrintPreviewScaleChangedEvent").subscribe(this,this.printMapScaleHasChanged)),this.selectedTemplateToken||(this.selectedTemplateToken=this.app.event("PrintPreviewLayoutChangedEvent").subscribe(this,this.handleTemplateSelectionChanged)),this.calculatePeepholeDimensionsFromExtent(this.viewModel.printPreviewExtent)},i.prototype.deactivated=function(){this.mapZoomStartedToken&&(this.app.event("MapZoomStartedEvent").unsubscribe(this.mapZoomStartedToken),this.mapZoomStartedToken=null),this.mapZoomEndedToken&&(this.app.event("MapZoomEndedEvent").unsubscribe(this.mapZoomEndedToken),this.mapZoomEndedToken=null),this.mapExtentChangedToken&&(this.app.event("MapExtentChangedEvent").unsubscribe(this.mapExtentChangedToken),this.mapExtentChangedToken=null),this.selectedScaleToken&&(this.app.event("PrintPreviewScaleChangedEvent").unsubscribe(this.selectedScaleToken),this.selectedScaleToken=null),this.selectedTemplateToken&&(this.app.event("PrintPreviewLayoutChangedEvent").unsubscribe(this.selectedTemplateToken),this.selectedTemplateToken=null)},i.prototype.setPeepholeVisibility=function(e){e?this.app.command("DeactivateView").execute(this.id):this.app.command("ActivateView").execute(this.id)},i.prototype.handleTemplateSelectionChanged=function(){var e=this.viewModel.calculateExtentFromPrintTemplate(this.app.map.extent.getCenter());this.calculatePeepholeDimensionsFromExtent(e)},i.prototype.printMapScaleHasChanged=function(){var e,t=this,i=parseFloat(this.viewModel.selectedScale.get().scale);return i&&i.toFixed(2)!==this.app.map.getScale().toFixed(2)?this.app.event("MapZoomEndedEvent").once(this,function(){e=t.viewModel.calculateExtentFromPrintTemplate(t.app.map.extent.getCenter(),i),t.calculatePeepholeDimensionsFromExtent(e),t.viewModel.printPreviewExtent=e}):i&&i.toFixed(2)===this.app.map.getScale().toFixed(2)?(e=this.viewModel.calculateExtentFromPrintTemplate(this.app.map.extent.getCenter(),i),this.calculatePeepholeDimensionsFromExtent(e),this.viewModel.printPreviewExtent=e):(e=this.app.map.extent,this.calculatePeepholeDimensionsFromExtent(e),this.viewModel.printPreviewExtent=e),!0},i.prototype.mapZoomStartedEvent=function(){this.peephole.style.opacity="0"},i.prototype.handleMapZoomEvent=function(){var e=parseFloat(this.viewModel.selectedScale.get().scale);if(this.app.map.extent.contains(this.viewModel.printPreviewExtent)&&e){var t=this.viewModel.printPreviewExtent,i=this.viewModel.getGraphicPositionFromExtent(t);this.peephole.style.top=i.top+"px",this.peephole.style.left=i.left+"px",this.peephole.style.width=i.width+"px",this.peephole.style.height=i.height+"px"}else e?this.calculatePeepholeDimensionsFromExtent(this.viewModel.printPreviewExtent):this.calculatePeepholeDimensionsFromExtent(this.app.map.extent);this.peephole.style.opacity="1"},i.prototype.calculatePeepholeDimensionsFromExtent=function(e){var t=this.viewModel.getGraphicPositionFromExtent(e);if(this.app.map.extent.contains(this.viewModel.printPreviewExtent))this.peephole.style.top=t.top+"px",this.peephole.style.left=t.left+"px",this.peephole.style.width=t.width+"px",this.peephole.style.height=t.height+"px";else{var i=this.app.map.toScreen(this.app.map.extent.getCenter()),n=t.width,a=t.height,r=i.y-a/2,s=i.x-n/2;this.peephole.style.top=r+"px",this.peephole.style.left=s+"px",this.peephole.style.width=n+"px",this.peephole.style.height=a+"px",this.setExtentFromPeepholePosition()}},i.prototype.setExtentFromPeepholePosition=function(){var e=parseInt(this.peephole.style.top),t=parseInt(this.peephole.style.left),i=parseInt(this.peephole.style.width),n=parseInt(this.peephole.style.height),a=this.app.map.toMap({x:t,y:e}),r=this.app.map.toMap({x:t+i,y:e+n}),s=new esri.geometry.Extent(a.x,r.y,r.x,a.y,this.app.map.spatialReference);this.viewModel.printPreviewExtent=s},i}(n.ViewBase);i.UnlockedPrintPreviewView=a})},"url:/Mapping/modules/Printing/PrintingView.html":t,"url:/Mapping/modules/Printing/UnlockedPrintPreviewView.html":i}}),require(["geocortex/framework/resourceManager"],function(e){e.resourceManager.register("Mapping","inv","Mapping/modules/Printing/CSS/common.css","css","LnByaW50aW5nIHsNCiAgICBwYWRkaW5nOiAxZW07DQogICAgb3ZlcmZsb3c6IGhpZGRlbjsNCn0NCg0KICAgIC5wcmludGluZyBsYWJlbCB7DQogICAgICAgIGNvbG9yOiAjNjY3NTgwOw0KICAgICAgICBmb250LXNpemU6IDEuMmVtOw0KICAgICAgICBkaXNwbGF5OiBibG9jazsNCiAgICAgICAgbWFyZ2luOiAuNzVlbSAwIDAuMjVlbSAwOw0KICAgIH0NCg0KICAgIC5wcmludGluZyBpbnB1dCwNCiAgICAucHJpbnRpbmcgc2VsZWN0LA0KICAgIC5wcmludGluZyB0ZXh0YXJlYSB7DQogICAgICAgIHdpZHRoOiAxMDAlOw0KICAgIH0NCg0KDQouc2hlbGwtbGFyZ2UgLnByaW50aW5nLXBlZXBob2xlLWNvbnRhaW5lciB7DQogICAgcG9zaXRpb246IGFic29sdXRlOw0KICAgIGhlaWdodDogMTAwJTsNCiAgICB3aWR0aDogMTAwJTsNCiAgICBvdmVyZmxvdzogaGlkZGVuOw0KICAgIHBvaW50ZXItZXZlbnRzOiBub25lOw0KfQ0KDQogICAgLnNoZWxsLWxhcmdlIC5wcmludGluZy1wZWVwaG9sZS1jb250YWluZXIgLnByaW50aW5nLXBlZXBob2xlLA0KICAgIC5zaGVsbC1sYXJnZSAucHJpbnRpbmctcGVlcGhvbGUtY29udGFpbmVyIC5wcmludGluZy1wZWVwaG9sZS1pbWcgew0KICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7DQogICAgfQ0KDQogICAgLnNoZWxsLWxhcmdlIC5wcmludGluZy1wZWVwaG9sZS1jb250YWluZXIgLnByaW50aW5nLXBlZXBob2xlIHsNCiAgICAgICAgYm9yZGVyLXN0eWxlOiBkYXNoZWQ7DQogICAgICAgIC1tb3otYm94LXNpemluZzogYm9yZGVyLWJveDsNCiAgICAgICAgLXdlYmtpdC1ib3gtc2l6aW5nOiBib3JkZXItYm94Ow0KICAgICAgICBib3gtc2l6aW5nOiBib3JkZXItYm94Ow0KICAgIH0NCg0KICAgIC5zaGVsbC1sYXJnZSAucHJpbnRpbmctcGVlcGhvbGUtY29udGFpbmVyIC5wcmludGluZy1wZWVwaG9sZS1pbWcgew0KICAgICAgICB0b3A6IDUwJTsNCiAgICAgICAgbGVmdDogNTAlOw0KICAgICAgICAtbW96LXRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOw0KICAgICAgICAtbXMtdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7DQogICAgICAgIC1vLXRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOw0KICAgICAgICAtd2Via2l0LXRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOw0KICAgICAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsNCiAgICB9DQoNCi5wcmludC1wcmV2aWV3LXRvZ2dsZXIgew0KICAgIHRleHQtYWxpZ246IGxlZnQ7DQp9DQoNCiAgICAucHJpbnQtcHJldmlldy10b2dnbGVyIGlucHV0IHsNCiAgICAgICAgd2lkdGg6IGF1dG87DQogICAgICAgIHZlcnRpY2FsLWFsaWduOiBtaWRkbGU7DQogICAgfQ0K"),e.resourceManager.register("Mapping","inv","Mapping/modules/Printing/PrintingView.html","html",t),e.resourceManager.register("Mapping","inv","Mapping/modules/Printing/UnlockedPrintPreviewView.html","html",i)}),require({cache:{}}),define(["Mapping/modules/Printing/PrintingModule","Mapping/modules/Printing/PrintingView","Mapping/modules/Printing/PrintingViewModel","Mapping/modules/Printing/UnlockedPrintPreviewView"],function(t,i,n,a){e(t,"geocortex.essentialsHtmlViewer.mapping.modules.printing.PrintingModule",t.PrintingModule),e(i,"geocortex.essentialsHtmlViewer.mapping.modules.printing.PrintingView",i.PrintingView),e(n,"geocortex.essentialsHtmlViewer.mapping.modules.printing.PrintingViewModel",n.PrintingViewModel),e(a,"geocortex.essentialsHtmlViewer.mapping.modules.printing.UnlockedPrintPreviewView",a.UnlockedPrintPreviewView)})}();