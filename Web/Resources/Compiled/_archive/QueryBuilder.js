!function(){function e(e,t,r){if("string"==typeof e&&(r=t,t=e),void 0!==r)for(var i=t.split("."),a=null,n=window,s=0,o=i.length;s<o;s++)a=i[s],s==o-1?n[a]=r:n[a]||(n[a]={}),n=n[a];else console.warn("Undefined shim for: "+t)}var t="<input type='text' title='autocomplete' data-binding='{aria-label: @language-querybuilder-autocomplete-view}{@value: value}{@var: autoCompleteInput}{@event-focus: autoComplete_focus}{@event-blur: autoComplete_blur}' />",r="<div class='list-queries-view'>    <div class='panel-group panel-scroll-container no-item box-container' data-binding='{@hidden: queries}'>        <p data-binding='{@hidden: isFilterBuilder}{@text: @language-querybuilder-savedqueries-browse-no-items}'></p>        <p class='description' data-binding='{@hidden: isFilterBuilder}{@text: @language-querybuilder-savedqueries-browse-no-items-desc}'></p>        <p data-binding='{@visible: isFilterBuilder}{@text: @language-querybuilder-savedfilters-browse-no-items}'></p>        <p class='description' data-binding='{@visible: isFilterBuilder}{@text: @language-querybuilder-savedfilters-browse-no-items-desc}'></p>    </div>    <div class='results-list' data-binding='{@visible: queries}'>        <ul class='gcx-list-menu' data-binding='{@source: resultsPage}'>            <li class='gcx-list-item has-action-1 query-items' data-binding='{@template-for: resultsPage}'>                <button class='gcx-list-button' data-binding='{@disabled: disabled}{@event-click: handleQueryClick}'>                    <strong class='gcx-list-label' data-binding='{@text: displayName}'></strong>                    <span class='gcx-list-desc' data-binding='{@visible: adminDefined}{@text: @language-saved-admin-defined}'></span>                    <div class='gcx-list-desc'>                        <span data-binding='{@text: @language-querybuilder-layer-label}'></span>                        <span data-binding='{@source: layer}'>                            <span data-binding='{@template-for: layer}{@text: displayName}'></span>                        </span>                    </div>                    <div class='gcx-list-desc'>                        <span data-binding='{@text: @language-querybuilder-extent-label}'></span>                        <span data-binding='{@text: selectedSpatialFilterName}'></span>                    </div>                </button>                <button class='gcx-action-button icon chevron-right-24' data-binding='{title: @language-querybuilder-actions-tooltip}{@event-click: handleQueryActions}'></button>            </li>        </ul>    </div>    \x3c!-- BEGIN: Paging Controls --\x3e    <div class='paging-control has-pages' data-binding='{@visible: queries}{@widget: PagingControlsWidget}{@widget-context: @context}{@widget-required: false}'></div>    \x3c!-- END: Paging Controls --\x3e</div>",i="<div class='no-item' data-binding='{@hidden: visibleMenuItems}{@text: @language-menu-no-items}'></div><ul class='list-menu has-icon' data-binding='{@visible: visibleMenuItems}{@source: visibleMenuItems}'>    <li class='list-menu-item' data-binding='{@template-for: visibleMenuItems}'>        <button class='list-menu-button' data-binding='{@enabled: canExecute}{@event-onmouseover: getDescription}{@event-onclick: handleMenuItemClick}'>            <img class='list-menu-icon' data-binding='{src: iconUri}{@visible: iconUri}' alt=' ' />            <span class='list-menu-details'>                <strong class='list-menu-name' data-binding='{@text: text}'></strong>                <span class='list-menu-desc' data-binding='{@visible: description}{@text: description}'></span>            </span>        </button>    </li></ul>",a="<div class='save-selection-view'>    <label>        <span data-binding='{@text: @language-common-save-as}'></span>        <input type='text' data-binding='{@value: name}{title: @language-querybuilder-name-title}{@event-oninput: handleInputChanged}' />    </label>    <div class='form-validation' data-binding='{@visible: inputErrorMessage}'>        <span class='field-validation-error' data-binding='{@text: inputErrorMessage}'></span>    </div>    <div class='form-btns'>        <button class='button save-button' data-binding='{@event-click: handleSaveClick}{@text: @language-common-save}{@disabled: inputErrorMessage}'></button>        <button class='button cancel-button' data-binding='{@event-click: handleCancelClick}{@text: @language-common-cancel}'></button>    </div></div>",n="<div class='query-actions-widget' data-binding='{@disabled: isFilterBuilder}{@widget: QueryActionsWidget}{@widget-context: displayedQuery}{@widget-required: false}'    data-menu-template='Mapping/infrastructure/menus/MenuView.html'></div><div class='simple-query-builder'>    <div data-binding='{@hidden: noAvailableLayers}'>        <div class='query-builder-form gcx-sticky-content has-footer' data-binding='{@event-keydown: form_keydown}{@var: htmlForm}{@event-submit: form_submit}'>            <div class='form-item' data-binding='{@hidden: nestingLevelTooDeep}'>                <label>                    <span data-binding='{@text: @language-querybuilder-data-source}'></span>                    <select data-binding='{@value: selectedLayerUniqueId}'>                        <optgroup data-binding='{@visible: areQueryableLayers}{@source: layers}{label: @language-querybuilder-query-layers}'>                            <option data-binding='{@template-for: layers}{@text: displayName}{value: uniqueId}' />                        </optgroup>                        <optgroup data-binding='{@visible: areQueryableTables}{@source: tables}{label: @language-querybuilder-query-tables}'>                            <option data-binding='{@template-for: tables}{@text: displayName}{value: uniqueId}' />                        </optgroup>                    </select>                </label>            </div>            <div class='form-item' data-binding='{@hidden: selectedLayerIsTable}'>                <label>                    <span data-binding='{@text: @language-querybuilder-spatial-filter}'></span>                    <select data-binding='{@source: spatialFilters}{@value: selectedSpatialFilter}{@event-onchange: onFilterSelected}'>                        <option data-binding='{@template-for: spatialFilters}{@text: name}{value: val}' />                    </select>                </label>            </div>            <div data-binding='{@visible: filterAlreadyApplied}'>                <div data-binding='{@text: @language-querybuilder-filter-already-applied}'></div>            </div>            <div class='info-message' data-binding='{@visible: nestingLevelTooDeep}'>                <span data-binding='{@text: @language-querybuilder-nesting-level-too-deep}'></span>            </div>            <div class='query-conditions-area' data-binding='{@visible: notDisabled}'>                <div class='find-results' data-binding='{@text: infoText}'></div>                <div data-binding='{@source: displayedQuery}{@template: Mapping/modules/QueryBuilder/Templates/QueryBuilderRoot.html}'></div>            </div>            \x3c!-- For debugging --\x3e            <div class='clear' data-binding='{@visible: isDebug}'>                <h4>Debug</h4>                <hr />                <div data-binding='{@source: displayedQuery}'>                    <textarea data-binding='{@template-for: displayedQuery}{@value: _debugWhereClause}{@visible: isDebug}{aria-label: @language-querybuilder-debug-displayed-query-label}' style='width: 100%;'></textarea>\x3c!-- For debugging --\x3e                </div>            </div>        </div>        <div class='form-btns gcx-sticky-footer'>            <button class='jimu-btn button' data-binding='{@event-onclick: clearResultsButton_click}{@visible: isQueryAndAwab}{@text: @language-querybuilder-clear}'></button>            <button class='jimu-btn button' data-binding='{@event-onclick: clearFilterButton_click}{@visible: isFilterBuilder}{@text: @language-querybuilder-clear}'></button>            <button type='submit' class='jimu-btn button' data-binding='{@event-onclick: actionButton_click}{@visible: isQueryBuilder}{@text: @language-querybuilder-search}'></button>            <button type='submit' class='jimu-btn button' data-binding='{@event-onclick: actionButton_click}{@visible: isFilterBuilder}{@text: @language-querybuilder-filter}{@disabled: disabled}{@class-disabled: disabled}'></button>            <button class='jimu-btn button' data-binding='{@event-onclick: cancelButton_click}{@visible: isQueryBuilder}{@text: @language-querybuilder-cancel}'></button>            <button class='jimu-btn button' data-binding='{@event-onclick: cancelButton_click}{@visible: isFilterBuilder}{@text: @language-querybuilder-cancel}'></button>        </div>    </div>    <div data-binding='{@visible: noAvailableLayers}{@text: noAvailableLayersText}'></div>    <div class='autocomplete-container'></div></div>",s="<div class='query-item'>    <div class='query-item-inputs'>        <label class='query-row-input'>            <span class='hidden-label' data-binding='{@text: @language-querybuilder-select-filter-label}'></span>            <select data-binding='{@source: fields}{@value: selectedFieldName}{title: @language-querybuilder-select-filter}'>                <option data-binding='{@template-for: fields}{@text: alias}{value: name}' />            </select>        </label>        <label class='query-row-input'>            <span class='hidden-label' data-binding='{@text: @language-querybuilder-select-operator-label}'></span>            <select data-binding='{@source: operators}{@value: selectedOperator}{title: @language-querybuilder-select-operator}'>                <option data-binding='{@template-for: operators}{@text: name}{value: value}' />            </select>        </label>        <label class='query-row-input'>            <span class='hidden-label'>TestLabel</span>            <span class='auto-complete' data-binding='{@widget: AutoComplete}{@widget-context: @context}{@visible: showTextInput}'></span>            <span class='date-picker' data-binding='{@widget: DatePicker}{@widget-context: @context}{@visible: showDateTimeInput}'></span>            <select class='coded-value-picker value-selector' data-binding='{@visible: showCodedValueDomainInput}{@source: codedValues}{@value: codedDomainValue}{aria-label: @language-querybuilder-coded-value}'>                <option data-binding='{@template-for: codedValues}{@text: name}{value: val}' />            </select>            <input class='value-selector' disabled='disabled' type='text' data-binding='{@visible: showDisabledInput}{@class-disabled: showDisabledInput}{aria-label: @language-querybuilder-select-value}' />        </label>    </div>    <button class='query-row-delete' data-binding='{@event-onclick: removeQueryClause_click}{@class-disabled: deleteDisabled}{title: @language-common-delete}'></button></div><div class='conjunction' data-binding='{@hidden: isLast}'>    <div class='conjunction-text and' data-binding='{@text: @language-querybuilder-and}{@visible: isAnd}'></div>    <div class='conjunction-text or' data-binding='{@text: @language-querybuilder-or}{@visible: isOr}'></div></div>",o="<div class='query-subgroup'>    <div class='logical-operators' data-binding='{@var: radioButtons}'>        <label class='logical-operator-toggle'>            <input type='radio' value='and' data-binding='{name: radioButtonGroup}{@event-onchange: handleRadioClick}'/>            <span class='label' data-binding='{@text: @language-querybuilder-logical-toggle-and}'></span>        </label>        <label class='logical-operator-toggle'>            <input type='radio' value='or' data-binding='{name: radioButtonGroup}{@event-onchange: handleRadioClick}'/>            <span class='label' data-binding='{@text: @language-querybuilder-logical-toggle-or}'></span>        </label>    </div>    <ul class='query-group' data-binding='{@source: queryItems}{@template-selector: type}'>        <li data-binding='{@template-select: queryItem}{@template: Mapping/modules/QueryBuilder/Templates/QueryBuilderItem.html}'></li>        <li data-binding='{@template-select: queryGroup}{@template: Mapping/modules/QueryBuilder/Templates/QueryBuilderItemGroup.html}'></li>    </ul>    <ul class='add-buttons'>        <li>            <button class='text-button' data-binding='{@event-onclick: addQueryClause_click}{@text: @language-querybuilder-add-condition}'></button>        </li>        <li>            <button class='text-button' data-binding='{@hidden: hasParent}{@event-onclick: addNestedQuery_click}{@text: @language-querybuilder-add-subgroup}'></button>        </li>    </ul></div><div class='conjunction' data-binding='{@hidden: isLast}'>    <div class='conjunction-text and' data-binding='{@text: @language-querybuilder-and}{@visible: isAnd}'></div>    <div class='conjunction-text or' data-binding='{@text: @language-querybuilder-or}{@visible: isOr}'></div></div>",l="<div class='logical-operators main-level-toggle' role='radiogroup' data-binding='{aria-label: @language-querybuilder-radio-group-label}@var: radioButtons}'>     <label class='logical-operator-toggle'>        <input type='radio' value='and' data-binding='{name: radioButtonGroup}{@event-onchange: handleRadioClick}' />        <span class='label' data-binding='{@text: @language-querybuilder-logical-toggle-and}'></span>    </label>    <label class='logical-operator-toggle'>        <input type='radio' value='or' data-binding='{name: radioButtonGroup}{@event-onchange: handleRadioClick}' />        <span class='label' data-binding='{@text: @language-querybuilder-logical-toggle-or}'></span>    </label></div><ul class='query-group main-level-group' data-binding='{@source: queryItems}{@template-selector: type}'>    <li class='query-item' data-binding='{@template-select: queryItem}{@template: Mapping/modules/QueryBuilder/Templates/QueryBuilderItem.html}'></li>    <li data-binding='{@template-select: queryGroup}{@template: Mapping/modules/QueryBuilder/Templates/QueryBuilderItemGroup.html}'></li></ul><ul class='add-buttons main-level-add'>    <li>        <button class='text-button' data-binding='{@event-onclick: addQueryClause_click}{@text: @language-querybuilder-add-condition}'></button>    </li>    <li>        <button class='text-button' data-binding='{@hidden: hasParent}{@event-onclick: addNestedQuery_click}{@text: @language-querybuilder-add-subgroup}'></button>    </li></ul>";require({cache:{"Mapping/modules/QueryBuilder/AutoCompleteView":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();define(["require","exports","geocortex/framework/ui/ViewBase"],function(t,r,i){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var a=function(t){function r(e,r){return t.call(this,e,r)||this}return e(r,t),r.prototype.activated=function(){t.prototype.activated.call(this)},r.prototype.attach=function(e){var r=this,i=this;t.prototype.attach.call(this,e),$(this.autoCompleteInput).autocomplete({minLength:0,source:function(e,t){r.getSuggestions(e,t)},appendTo:e.appendTo,position:{my:"right top",at:"right bottom",using:function(e){var t=$(this);t.css("top",e.top),t.css("right",t.offsetParent().innerWidth()-(e.left+t.outerWidth())),t.css("left","auto")}}}).on("autocompleteselect",function(e,t){return i.viewModel.value.set(t.item.value),!0}),$(this.autoCompleteInput).data("autocomplete")._resizeMenu=function(){var e=this.menu.element;this.options&&this.options.appendTo?(e.css("max-width",$(this.options.appendTo).width()),e.css("min-width",this.element.outerWidth()-6)):e.outerWidth(this.element.outerWidth())}},r.prototype.getSuggestions=function(e,t){this.viewModel.queryClause.getSuggestions().then(t,function(e){t(e)})},r.prototype.dispose=function(){$(this.autoCompleteInput).remove()},r.prototype.autoComplete_focus=function(e,t,r){$(t).val()||$(t).autocomplete("search","")},r.prototype.autoComplete_blur=function(e,t,r){$(t).autocomplete("widget").hide()},r}(i.ViewBase);r.AutoCompleteView=a})},"Mapping/modules/QueryBuilder/AutoCompleteViewModel":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();define(["require","exports","geocortex/framework/ui/ViewModelBase","geocortex/framework/observables"],function(t,r,i,a){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=function(t){function r(){var e=null!==t&&t.apply(this,arguments)||this;return e.value=new a.Observable,e}return e(r,t),r}(i.ViewModelBase);r.AutoCompleteViewModel=n})},"Mapping/modules/QueryBuilder/Formatters":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();define(["require","exports","./QueryOperator","geocortex/infrastructure/FormatUtils","geocortex/infrastructure/NumberFormat"],function(t,r,i,a,n){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var s=function(){function e(t){e.settings=t}return e.getFormatter=function(e){return e.dataProvider.search(/^Db2$/i)>=0?new l(this.settings):e.dataProvider.search(/^FileGdb$/i)>=0?new u(this.settings):e.dataProvider.search(/^Informix$/i)>=0?new d(this.settings):e.dataProvider.search(/^MsAccess$/i)>=0?new p(this.settings):e.dataProvider.search(/^Oracle$/i)>=0?new c(this.settings):e.dataProvider.search(/^PostgreSql/i)>=0?new y(this.settings):e.dataProvider.search(/^Shapefile/i)>=0?new g(this.settings):e.dataProvider.search(/^SqlServer/i)>=0?new h(this.settings):"WMS"==e.serviceLayerInfo.serviceType||"WFS"==e.serviceLayerInfo.serviceType?new m(this.settings):new o(this.settings)},e}();s.settings={},r.QueryFormatterFactory=s;var o=function(){function e(e){this._settings=e||{}}return e.prototype.wildcard=function(){return this._settings.wildcard||"%"},e.prototype.dateQueryFormat=function(){return this._settings.dateQueryFormat||"DATE '{0:yyyy-MM-dd}'"},e.prototype.textComparisonQueryFormat=function(){return this._settings.textComparisonQueryFormat||"LOWER({0}) LIKE LOWER({1})"},e.prototype.numberToTextComparisonQueryFormat=function(){return this._settings.numberToTextComparisonQueryFormat||"CAST({0} AS VARCHAR(50)) LIKE '{1}'"},e.prototype.doesNotContainQueryFormat=function(){return this._settings.doesNotContainQueryFormat||"LOWER({0}) NOT LIKE LOWER({1})"},e.prototype.supportsTimeOfDay=function(){return void 0!=this._settings.queryProviderSupportsTimeOfDay&&this._settings.queryProviderSupportsTimeOfDay},e.prototype.format=function(e,t,r,a){var n=[i.QueryOperator.Equals,i.QueryOperator.NotEquals,i.QueryOperator.LessThan,i.QueryOperator.LessThanEquals,i.QueryOperator.GreaterThan,i.QueryOperator.GreaterThanEquals],s=[i.QueryOperator.Contains,i.QueryOperator.DoesNotContain,i.QueryOperator.StartsWith,i.QueryOperator.EndsWith],o=[i.QueryOperator.IsNull,i.QueryOperator.IsNotNull];return dojo.indexOf(n,t)>=0?this.formatComparison(e,t,r):dojo.indexOf(s,t)>=0?a&&t!==i.QueryOperator.Equals&&t!==i.QueryOperator.NotEquals?this.formatCodedDomainPatternMatch(e,t,r,a):this.formatPatternMatch(e,t,r):dojo.indexOf(o,t)>=0?this.formatNull(e,t):void 0},e.prototype.formatComparison=function(e,t,r){var i=this.formatField(e),a=this.formatComparisonOperator(t),n=this.formatValue(e,r);return"{0} {1} {2}".format(i,a,n)},e.prototype.formatPatternMatch=function(e,t,r){return t==i.QueryOperator.DoesNotContain?this.doesNotContainQueryFormat().format(this.formatField(e),this.formatValue(e,this.formatPattern(t,r))):e.isNumeric()?this.numberToTextComparisonQueryFormat().format(this.formatField(e),this.formatPattern(t,this.formatValue(e,r))):this.textComparisonQueryFormat().format(this.formatField(e),this.formatValue(e,this.formatPattern(t,r)))},e.prototype.formatCodedDomainPatternMatch=function(e,t,r,a){var n="";return t===i.QueryOperator.Contains?n=a.filter(function(e){return e.name.toString().toLowerCase().indexOf(r.toLowerCase())>-1}).map(function(e){return"'"+e.val+"'"}).join(","):t===i.QueryOperator.DoesNotContain?n=a.filter(function(e){return-1===e.name.toString().toLowerCase().indexOf(r.toLowerCase())}).map(function(e){return"'"+e.val+"'"}).join(","):t===i.QueryOperator.StartsWith?n=a.filter(function(e){return e.name.toString().toLowerCase().startsWith(r.toLowerCase())}).map(function(e){return"'"+e.val+"'"}).join(","):t===i.QueryOperator.EndsWith&&(n=a.filter(function(e){return e.name.toString().toLowerCase().endsWith(r.toLowerCase())}).map(function(e){return"'"+e.val+"'"}).join(",")),n.length>0?"{0} IN ({1})".format(this.formatField(e),n):"1 = 2"},e.prototype.formatPattern=function(e,t){var r;switch(e){case i.QueryOperator.Contains:case i.QueryOperator.DoesNotContain:r="{0}{1}{0}";break;case i.QueryOperator.StartsWith:r="{1}{0}";break;case i.QueryOperator.EndsWith:r="{0}{1}";break;default:throw new Error("Invalid pattern matching operator.")}return r.format(this.wildcard(),t)},e.prototype.formatNull=function(e,t){if(t==i.QueryOperator.IsNull)return"{0} IS NULL".format(this.formatField(e));if(t==i.QueryOperator.IsNotNull)return"{0} IS NOT NULL".format(this.formatField(e));throw new Error("Invalid operator.")},e.prototype.formatField=function(e){return e.name},e.prototype.formatComparisonOperator=function(e){switch(e){case i.QueryOperator.Equals:return"=";case i.QueryOperator.NotEquals:return"<>";case i.QueryOperator.LessThan:return"<";case i.QueryOperator.LessThanEquals:return"<=";case i.QueryOperator.GreaterThan:return">";case i.QueryOperator.GreaterThanEquals:return">=";default:throw new Error("Invalid binary comparison operator.")}},e.prototype.formatValue=function(e,t){return e.isNumeric()?this.formatNumericValue(t):e.isDate()?this.formatDateValue(t):this.formatTextValue(t)},e.prototype.formatNumericValue=function(e){var t=e||"",r=a.parseNumber(e);return r&&(t=a.formatNumber(r,n.NumberFormat.ROUND_TRIP)),t},e.prototype.formatDateValue=function(e){var t=e||"",r=a.parseDate(t);return r&&(t=this.dateQueryFormat().replace(/\{0:([^}]+)\}/,function(e,t){return a.formatDate(r,t)})),t.trim()},e.prototype.formatTextValue=function(e){var t=e||"";return t=t.replace("'","''"),"'{0}'".format(t.trim())},e}();r.QueryFormatter=o;var l=function(t){function r(e){return t.call(this,e)||this}return e(r,t),r.prototype.supportsTimeOfDay=function(){return!0},r.prototype.dateQueryFormat=function(){return"TO_DATE('{0:yyyy-MM-dd HH:mm:ss}','YYYY-MM-DD HH24:MI:SS')"},r}(o);r.Db2QueryFormatter=l;var u=function(t){function r(e){return t.call(this,e)||this}return e(r,t),r.prototype.supportsTimeOfDay=function(){return!0},r.prototype.dateQueryFormat=function(){return"DATE '{0:yyyy-MM-dd HH:mm:ss}'"},r}(o);r.FileGdbQueryFormatter=u;var d=function(t){function r(e){return t.call(this,e)||this}return e(r,t),r.prototype.supportsTimeOfDay=function(){return!0},r.prototype.dateQueryFormat=function(){return"'{0:yyyy-MM-dd HH:mm:ss}'"},r}(o);r.InformixQueryFormatter=d;var p=function(t){function r(e){return t.call(this,e)||this}return e(r,t),r.prototype.supportsTimeOfDay=function(){return!0},r.prototype.dateQueryFormat=function(){return"#{0:MM-dd-yyyy HH:mm:ss}#"},r.prototype.wildcard=function(){return"*"},r}(o);r.MsAccessQueryFormatter=p;var c=function(t){function r(e){return t.call(this,e)||this}return e(r,t),r.prototype.supportsTimeOfDay=function(){return!0},r.prototype.dateQueryFormat=function(){return"TO_DATE('{0:yyyy-MM-dd HH:mm:ss}','YYYY-MM-DD HH24:MI:SS')"},r}(o);r.OracleQueryFormatter=c;var y=function(t){function r(e){return t.call(this,e)||this}return e(r,t),r.prototype.supportsTimeOfDay=function(){return!0},r.prototype.dateQueryFormat=function(){return"TIMESTAMP '{0:yyyy-MM-dd HH:mm:ss}'"},r}(o);r.PostgreSqlQueryFormatter=y;var g=function(t){function r(e){return t.call(this,e)||this}return e(r,t),r.prototype.supportsTimeOfDay=function(){return!1},r.prototype.dateQueryFormat=function(){return"DATE '{0:yyyy-MM-dd}'"},r}(o);r.ShapefileQueryFormatter=g;var h=function(t){function r(e){return t.call(this,e)||this}return e(r,t),r.prototype.supportsTimeOfDay=function(){return!0},r.prototype.dateQueryFormat=function(){return"'{0:yyyy-MM-dd HH:mm:ss}'"},r}(o);r.SqlServerQueryFormatter=h;var m=function(t){function r(e){return t.call(this,e)||this}return e(r,t),r.prototype.textComparisonQueryFormat=function(){return"{0} LIKE {1}"},r.prototype.doesNotContainQueryFormat=function(){return"{0} NOT LIKE {1}"},r}(o);r.GeocortexOwsQueryFormatter=m})},"Mapping/modules/QueryBuilder/NameValuePair":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"Mapping/modules/QueryBuilder/Query":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();define(["require","exports","geocortex/framework/observables","./QueryBase","./QueryClause","geocortex/framework/utils/utils","geocortex/infrastructure/gis/AppInfo","geocortex/infrastructure/TaskUtils","geocortex/framework/utils/ArrayUtils","geocortex/essentials/Field","./QueryOperator","./QueryBuilderModule","./QueryErrorHandling","geocortex/infrastructure/PromiseUtils"],function(t,r,i,a,n,s,o,l,u,d,p,c,y,g){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.idPrefix="qu_";var h=function(t){function a(e,r,a){var n=t.call(this,e,r)||this;return n.isModified=new i.Observable(!1),n.displayName=new i.Observable(null),n.queryClauses=new i.ObservableCollection,n.layerIsTable=new i.Observable(!1),n.layer=new i.Observable(null),n.layerId=new i.Observable(null),n.selectedLogicalOperator=new i.Observable(null),n.logicalOperators=new i.ObservableCollection,n._debugWhereClause=new i.Observable(null),n.radioButtons=null,n.radioButtonGroup=new i.Observable(null),n.queryItems=new i.ObservableCollection,n.children=new i.ObservableCollection,n.hasParent=new i.Observable(!1),n.parentLogicalOperator=new i.Observable(null),n.defaultLogicalOperator=new i.Observable(p.Conjunctions.and),n.numSuggestions=10,n.geometry=new i.Observable(null),n.selectedSpatialFilter=new i.Observable,n.selectedSpatialFilterName=new i.Observable,n.adminDefined=!1,n.counter=0,n._isRestoringStatePromise=null,n._fields=new Array,n.type="queryGroup",n.layerIsTable.set(a.layerIsTable),n.layer.set(a.hasOwnProperty("layer")?a.layer:null),n.layerId.set(a.hasOwnProperty("layer")&&a.layer?a.layer.uniqueId:null),n.selectedLogicalOperator.set(a.hasOwnProperty("logicalOperator")&&a.logicalOperator?a.logicalOperator:n.defaultLogicalOperator.get()),n.selectedLogicalOperator.bind(n,function(e){n.isModified.set(!0),n.app.event("_logicalOperatorChanged").publish(n.id,e)}),n.layerId.syncTransform(n.layer,function(e){return e&&e.uniqueId?e.uniqueId:null}),n.displayName.set(a.hasOwnProperty("displayName")?a.displayName:null),n.id.set(a.hasOwnProperty("id")?a.id:n._generateId()),n.selectedSpatialFilter.set(a.hasOwnProperty("spatialFilter")?a.spatialFilter:0),n.logicalOperators=new i.ObservableCollection([{name:n.app.getResource(n.libraryId,"language-querybuilder-and-operator"),val:"and"},{name:n.app.getResource(n.libraryId,"language-querybuilder-or-operator"),val:"or"}]),n.id.bind(n,function(e){var t="radioButtonGroup"+e;n.radioButtonGroup.set(t)}),n.id.pulse(),n.parentLogicalOperator.bind(n,function(){n.isAnd.set(n.parentLogicalOperator.get()===p.Conjunctions.and),n.isOr.set(n.parentLogicalOperator.get()===p.Conjunctions.or)}),n.queryItems.bind(n,function(e){switch(e.type){case"remove":var t=n.queryItems.length();e.rangeEnd===t-1&&t>1&&n.queryItems.getAt(t-2).isLast.set(!0);break;case"insert":case"append":n.queryItems.length()>0&&n.queryItems.getAt(n.queryItems.length()-1).isLast.set(!0),n.queryItems.length()>1&&n.queryItems.getAt(n.queryItems.length()-2).isLast.set(!1)}}),n._queryErrorHandler=function(e){n.app.trace.error(e.message)},n}return e(a,t),a.prototype.execute=function(e,t,r){var i=this;this._previousExecuteQuery&&this._previousExecuteQuery.cancel();var a;a=this.layer.get().gcxLayer?l.getQueryTask(this.layer.get().gcxLayer):l.getQueryTask(this.layer.get().serviceLayerInfo.serviceLayer,this.layer.get().serviceLayerInfo);var n=new esri.tasks.Query;n.where=this.buildWhereClause(r),n.returnGeometry=!0,n.outFields=["*"],n.geometry=this.geometry.get(),n.outSpatialReference=e,this.app.trace.debug("Executing query with where clause: "+n.where),this.app.trace.debug("Query restricted by the following geometry: "+n.geometry);var s=a.execute(n);return this._previousExecuteQuery=s,s.then(function(){i._previousExecuteQuery=null,t.publish({layer:i.layer.get(),query:n})},function(e){t.publish({layer:i.layer.get(),query:n,error:e});var r=e;r.layer=i.layer.get(),r.query=n,r.operation="query",i._queryErrorHandler&&i._queryErrorHandler(r)}),s},a.prototype.toString=function(){var e=this._toStringRecursive();return JSON.stringify(e,null,"\t")},a.prototype._toStringRecursive=function(){var e={id:this.id.get(),layer:this.layer.get()?this.layer.get().displayName:"null",clauses:this.queryClauses.get().map(function(e){return e.exportState()}),children:this.children.get().map(function(e){return e._toStringRecursive()}),order:this.queryItems.get().map(function(e){return e.id.get()}),conjunction:this.selectedLogicalOperator.get(),where:this.buildWhereClause(),adminDefined:this.adminDefined};return this.displayName.get()&&(e.displayName=this.displayName.get()),this.selectedSpatialFilter.get()&&(e.selectedSpatialFilter=this.selectedSpatialFilter.get()),this.selectedSpatialFilter.get()&&(e.selectedSpatialFilterName=this.selectedSpatialFilterName.get()),e},a.prototype.exportState=function(){if(this.layer.get()){var e={id:this.id.get(),layer:this.app.project.convert.fromGcxLayer(this.layer.get().gcxLayer),clauses:this.queryClauses.get().map(function(e){return e.exportState()}),children:this.children.get().map(function(e){return e.exportState()}),order:this.queryItems.get().map(function(e){return e.id.get()}),conjunction:this.selectedLogicalOperator.get(),where:this.buildWhereClause(),adminDefined:this.adminDefined};return this.displayName.get()&&(e.displayName=this.displayName.get()),this.selectedSpatialFilter.get()&&(e.selectedSpatialFilter=this.selectedSpatialFilter.get()),this.selectedSpatialFilterName.get()&&(e.selectedSpatialFilterName=this.selectedSpatialFilterName.get()),e}},a.prototype.applyState=function(e,t){var r=this;if(e)return(!this._isRestoringStatePromise||this._isRestoringStatePromise&&this._isRestoringStatePromise.isFulfilled())&&(this._isRestoringStatePromise=Promise.resolve()),t&&t!==c.latestProjectSerialVersion&&this._convertLegacyState(e,t),this.clearQuery(),this.id.set(e.id),this.adminDefined=e.adminDefined,this.selectedLogicalOperator.set(e.conjunction),this.displayName.set(e.hasOwnProperty("displayName")?e.displayName:null),this.selectedSpatialFilter.set(e.hasOwnProperty("selectedSpatialFilter")?e.selectedSpatialFilter:c.SpatialFilterOptions.None),this.selectedSpatialFilterName.set(e.hasOwnProperty("selectedSpatialFilterName")?e.selectedSpatialFilterName:""),this._attemptLayerRestore(e.layer),this._isRestoringStatePromise=this._isRestoringStatePromise.then(function(){return r.refreshFields()}).then(function(){return r._attemptClauseRestore(e.clauses,t)}).then(function(){return r._attemptChildRestore(e.children,t)}).then(function(){for(var t=e.order.length-1;t>=0;t--)for(var i=0;i<r.queryItems.get().length;i++){var a=r.queryItems.getAt(i);if(e.order[t]===a.id.get()){r.queryItems.removeAt(i),r.queryItems.insertItem(0,a),r.queryItems.length()>0&&r.queryItems.getAt(0).isLast.set(!1),r.queryItems.getAt(0).selectedLogicalOperator&&r.queryItems.getAt(0).selectedLogicalOperator.pulse();break}}r.queryItems.length()>0&&r.queryItems.getAt(r.queryItems.length()-1).isLast.set(!0)}).then(function(){return r.isModified.set(!1),r}).catch(function(t){throw t.code===y.ERRCODES.LAYERMISSINGERROR&&((t=t).queryState=e,t.query=r),!!r._queryErrorHandler&&r._queryErrorHandler(t),r.isModified.set(!1),t}),this._isRestoringStatePromise},a.prototype._attemptLayerRestore=function(e){var t=o.AppInfo.fromGeocortexApp(this.app);if(t&&t.mapInfo){var r=t.mapInfo.getLayerInfos().filter(function(e){return e.queryable&&e.displayName&&e.url}),i=u.firstOrDefault(r,function(t){return t.url.indexOf(e.layerUrl)>-1&&t.id===e.id.toString()});if(!i){var a=t.mapInfo.getTableInfos().filter(function(e){return e.queryable&&e.displayName&&e.url});if(!(i=u.firstOrDefault(a,function(t){return t.url.indexOf(e.layerUrl)&&t.id===e.id.toString()})))return;this.layerIsTable.set(!0)}this.layer.set(i)}},a.prototype._attemptClauseRestore=function(e,t){var r=this,i=e.map(function(e){var i=new n.QueryClause(r.app,r.libraryId,r);try{i.applyState(e,r._fields,t)}catch(e){return!!r._queryErrorHandler&&r._queryErrorHandler(e),null}return i});return i=i.filter(function(e){return!!e}),this.addQueryClauses(i)},a.prototype._attemptChildRestore=function(e,t){var r=this,i=e.map(function(){return new a(r.app,r.libraryId,{layer:r.layer.get(),layerIsTable:!1,logicalOperator:"AND"})}),n=this.addChildren(i);return g.PromiseUtils.mapSkipRejected(e,function(e,i){return n[i].applyState(e,t).catch(function(e){throw r.removeChildren([n[i]]),e})},{concurrency:1/0},!0)},a.prototype._convertLegacyState=function(e,t){switch(t){case 1:!e.hasOwnProperty("id")&&(e.id=r.idPrefix+s.alphaNumericToken()),!e.hasOwnProperty("children")&&(e.children=new Array),!e.hasOwnProperty("order")&&(e.order=new Array),!e.hasOwnProperty("conjunction")&&(e.conjunction=this.defaultLogicalOperator.get()),!e.hasOwnProperty("adminDefined")&&(e.adminDefined=!1),!e.hasOwnProperty("displayName")&&(e.displayName=""),!e.hasOwnProperty("selectedSpatialFilter")&&(e.selectedSpatialFilter=c.SpatialFilterOptions.None);break;default:this.app.trace.warning("Cannot convert this version of legacy queryState. Loading this legacy query may fail.")}},a.getStateFilter=function(e){return{id:!0,layer:e.project.filter.layer,clauses:{item:n.QueryClause.getStateFilter()},children:!0,order:!0,conjunction:!0,where:!0,adminDefined:!0,displayName:!0,selectedSpatialFilter:!0,selectedSpatialFilterName:!0}},a.prototype.setErrorHandler=function(e,t,r){this._queryErrorHandler=function(i){return r.apply(e,[t,i])}},a.prototype.removeErrorHandler=function(){this._queryErrorHandler=null},a.appendExpression=function(e,t,r){var i=e;return t&&t.length>0&&(i=e&&e.length>0?"("+e+") "+r+" ("+t+")":t),i},a.prototype.getSuggestions=function(e){var t=this;if(0===this.numSuggestions){var r=new dojo.Deferred;return r.resolve(new Array),r}if(e.codedValues.getLength()>0){var i=new dojo.Deferred,n=e.getAllPossibleCodedValues();return i.resolve(n.map(function(e){return e.name})),i}var s=new dojo.Deferred;s.id=this.counter++;var o=a.appendExpression(e.format(p.QueryOperator.StartsWith),this.layer.get().getDefinitionExpression(),p.Conjunctions.and)||"1 = 1",u=l.getQueryTask(this.layer.get().gcxLayer),d=new esri.tasks.Query;this.geometry.get()||-1!==e.selectedField.name.indexOf(".")||(d.returnDistinctValues=!0),d.where=o,d.returnGeometry=!1,d.outFields=[e.selectedField.name],this.geometry.get()&&(d.geometry=this.geometry.get());var c=u.execute(d);return c.id=this.counter++,c.then(function(r){for(var i={},n=new Array,o=0,l=r.features;o<l.length;o++){var u=l[o].attributes[e.selectedField.name]+"";if(a._isNullOrWhiteSpace(u)||i.hasOwnProperty(u)||(i[u]=u,n.push(u)),n.length===t.numSuggestions)break}n.sort(),n=n.map(function(t){return e.selectedField.formatValue(t)}),s.resolve(n)},function(r){t.app.trace.error("Could not retrieve suggestions for "+e.selectedField.name,r);var i=r;return i.layer=t.layer.get(),i.query=d,i.operation="get suggestions",t._queryErrorHandler&&t._queryErrorHandler(i),s.errback(r)}),s},a._isNullOrWhiteSpace=function(e){return!e||0==e.length||e.search(/^\s+$/g)>=0},a.prototype.addChildren=function(e){var t=this;return e.map(function(e,r,i){e.layer.sync(t.layer),e.layerIsTable.sync(t.layerIsTable),e.defaultLogicalOperator.sync(t.defaultLogicalOperator),e.hasParent.set(!0),e.parentQuery=t,e.parentLogicalOperator.sync(t.selectedLogicalOperator),e.numSuggestions=t.numSuggestions,e._queryErrorHandler=t._queryErrorHandler,e.isModified.bind(t,function(e){e&&t.isModified.set(!0)}),t.children.addItem(e),t.queryItems.addItem(e)}),this.isModified.set(!0),e},a.prototype.removeChildren=function(e){for(var t=this,r=[],i=this.children.get(),a=0;a<i.length;a++)for(var n=0;n<e.length;n++)i[a].id.get()===e[n].id.get()&&r.push(i[a]);r.forEach(function(e){t.children.removeItem(e),t.queryItems.removeItem(e)}),this.isModified.set(!0)},a.prototype.addQueryClauses=function(e){var t=this;return Promise.resolve().then(function(){for(var r=0;r<e.length;r++){try{if(0==t._fields.length&&t.layer&&t.layer.get()&&t.layer.get().name&&t.layer.get().fields&&t.layer.get().fields.length>0)return void t.app.trace.warning("Layer "+t.layer.get().name+" does not have any fields");e[r].setFields(t._fields)}catch(e){!!t._queryErrorHandler&&t._queryErrorHandler(e)}e[r].updateCodedDomainValues(),t.queryClauses.addItem(e[r]),t.queryItems.addItem(e[r])}return t.isModified.set(!0),1!==t.queryClauses.length()||t.hasParent.get()?t.queryClauses.length()>0&&t.queryClauses.getAt(0).deleteDisabled.set(!1):t.queryClauses.getAt(0).deleteDisabled.set(!0),e},function(r){if(r.code===y.ERRCODES.LAYERFIELDERROR){var i=r;return i.code=y.ERRCODES.ADDQUERYCLAUSEERROR,i.clauses=e,!!t._queryErrorHandler&&t._queryErrorHandler(r),[]}throw r})},a.prototype.removeQueryClause=function(e){e.dispose(),this.queryClauses.removeItem(e),this.queryItems.removeItem(e),this.isModified.set(!0),1!==this.queryClauses.length()||this.hasParent.get()?this.queryClauses.length()>0&&this.queryClauses.getAt(0).deleteDisabled.set(!1):this.queryClauses.getAt(0).deleteDisabled.set(!0)},a.prototype._disposeAllClauses=function(){this.queryClauses.get().forEach(function(e){return e.dispose()}),this.queryClauses.clear(),this.queryItems.clear(),this.children.get().forEach(function(e){e._disposeAllClauses()}),this.removeChildren(this.children.get())},a.prototype.buildWhereClause=function(e){var e=e||!1,t="";return t=this._buildInnerWhereClause(),e&&(t=a.appendExpression(t,this.layer.get().getDefinitionExpression(),p.Conjunctions.and)),this._debugWhereClause.set(t),t},a.prototype._buildInnerWhereClause=function(){for(var e=this,t="",r=0;r<this.queryClauses.length();r++){var i=this.queryClauses.getAt(r).format();i&&(t.length>0&&(t+=" "+this.selectedLogicalOperator.get()+" "),t+=i)}return this.children.get().forEach(function(r){var i=r._buildInnerWhereClause();i&&(t?t+=" "+e.selectedLogicalOperator.get()+" "+i+" ":t=i)}),t||this.hasParent.get()||(t="1 = 1"),t&&(t="("+t+")"),t},a.prototype.pulseCodedDomainValues=function(){for(var e=0;e<this.queryClauses.length();e++)this.queryClauses.getAt(e).codedDomainValue.pulse();this.children.get().forEach(function(e){e.pulseCodedDomainValues()})},a.prototype.updateCodedDomainValues=function(){for(var e=0;e<this.queryClauses.length();e++)this.queryClauses.getAt(e).updateCodedDomainValues();this.children.get().forEach(function(e){e.updateCodedDomainValues()})},a.prototype.refreshFields=function(){var e=this;return this.layer.get()?new Promise(function(t,r){e.layer.get().getFields().then(t,r)}).then(function(t){e._fields=t.filter(function(e){return dojo.indexOf(a._excludedFieldTypes,e.type)<0&&e.isVisible}),e._fields=e._fields.sort(function(e,t){var r=(e.alias||"").toLocaleLowerCase(),i=(t.alias||"").toLocaleLowerCase();return r==i?0:r<i?-1:1})},function(t){var r=t;throw r.code=y.ERRCODES.LAYERFIELDERROR,r.queryClause=null,r.missingFieldName=null,r.allFields=e._fields,!!e._queryErrorHandler&&e._queryErrorHandler(r),t}):Promise.resolve()},a.prototype.getNewInstance=function(e){var t=this,r=new a(this.app,this.libraryId,{logicalOperator:"AND",layer:this.layer.get(),layerIsTable:!1});return this.exportState()?r.applyState(this.exportState(),c.latestProjectSerialVersion).then(function(r){return r._queryErrorHandler=t._queryErrorHandler,e&&r.refreshId(),r},function(e){return t.app.trace.error("Could not get new instance of query"),t._queryErrorHandler&&t._queryErrorHandler(e),Promise.reject(e)}):Promise.resolve(r)},a.prototype._generateId=function(){return r.idPrefix+s.alphaNumericToken()},a.prototype.clearQuery=function(){this._disposeAllClauses(),this.layer.set(null),this._fields=[],this.selectedLogicalOperator.set(this.defaultLogicalOperator.get()),this.layerIsTable.set(!1),this.displayName.set(null),this.isModified.set(!1)},a.prototype.refreshId=function(){this.id.set(this._generateId())},a}(a.QueryBase);h._excludedFieldTypes=[d.EsriFieldTypes.esriFieldTypeBlob,d.EsriFieldTypes.esriFieldTypeGeometry,d.EsriFieldTypes.esriFieldTypeGlobalID,d.EsriFieldTypes.esriFieldTypeGUID],r.Query=h})},"Mapping/modules/QueryBuilder/QueryBase":function(){define(["require","exports","geocortex/framework/observables"],function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){return function(e,t){this.id=new r.Observable(null),this.isLast=new r.Observable(!1),this.isAnd=new r.Observable(null),this.isOr=new r.Observable(null),this.app=e,this.libraryId=t}}();t.QueryBase=i})},"Mapping/modules/QueryBuilder/QueryBuilderModule":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();define(["require","exports","geocortex/framework/application/ModuleBase","./QueryCollection","./Query","./QueryClause","./QueryErrorHandling","geocortex/infrastructure/commandArgs/AddStatusArgs","geocortex/infrastructure/gis/AppInfo","./QueryOperator","geocortex/framework/utils/utils","geocortex/infrastructure/PromiseUtils"],function(t,r,i,a,n,s,o,l,u,d,p,c){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var y;!function(e){e[e.None=0]="None",e[e.CurrentExtent=1]="CurrentExtent",e[e.Drawings=2]="Drawings"}(y=r.SpatialFilterOptions||(r.SpatialFilterOptions={})),r.latestProjectSerialVersion=2;var g=function(t){function i(e,r){var i=t.call(this,e,r)||this;return i.defaultLogicalOperator=d.Conjunctions.and,i._queryStatusView=null,i._filterStatusView=null,i}return e(i,t),i.prototype.initialize=function(e){if((e=e||{}).hasOwnProperty("queryStatusRegion")&&(this._queryStatusRegion=e.queryStatusRegion),e.hasOwnProperty("filterStatusRegion")&&(this._filterStatusRegion=e.filterStatusRegion),e.hasOwnProperty("defaultLogicalOperator")&&null!=e.defaultLogicalOperator&&"string"==typeof e.defaultLogicalOperator){var t=e.defaultLogicalOperator.toLowerCase();void 0===d.Conjunctions[t]||null===d.Conjunctions[t]?this.app.trace.warning('Invalid default conjunction "'+t+'" given. Using '+d.Conjunctions.and+" as the default"):this.defaultLogicalOperator=d.Conjunctions[t]}return this._registerCommands(),this._initializeCollections()},i.prototype._initializeCollections=function(){var e=this;return this._queryStore=new a.QueryCollection(this.app,this.libraryId,{persistent:!1,sourceName:"SavedQueries"}),this._queryStore.isFilterCollection=!1,this._filterStore=new a.QueryCollection(this.app,this.libraryId,{persistent:!1,sourceName:"SavedFilters"}),this._filterStore.isFilterCollection=!0,Promise.all([this._queryStore.initialize(),this._filterStore.initialize()]).then(function(){return e._queryStore.setCollectionChangedEvent(e.app.event("SavedQueriesChangedEvent")),e._filterStore.setCollectionChangedEvent(e.app.event("SavedFiltersChangedEvent")),e.app.event("SavedQueriesChangedEvent").subscribe(e,function(){e.app.trace.debug("Query Collection changed"),e.app.trace.debug("The list of queries follows: "),e._queryStore.getAllQueries().forEach(function(t,r){var i=function(e){e.layer=null,e.children.forEach(i)},a=t.exportState();a&&i(a),e.app.trace.debug("Query: "+r+" \n"+JSON.stringify(a,null,2))})}),e.app.event("SavedFiltersChangedEvent").subscribe(e,function(){e.app.trace.debug("Filter Collection changed"),e.app.trace.debug("The list of filters follows: "),e._filterStore.getAllQueries().forEach(function(t,r){var i=function(e){e.layer=null,e.children.forEach(i)},a=t.exportState();a&&i(a),e.app.trace.debug("Filter: "+r+" \n"+JSON.stringify(a,null,2))})}),e._retrieveSiteQueries()}).then(function(t){return c.PromiseUtils.mapSkipRejected(t,function(t){return t.adminDefined=!0,c.PromiseUtils.allSkipRejected([t.getNewInstance().then(function(t){return t.setErrorHandler(e,!1,o.handleQueryErrors),e._queryStore.addQuery(t)}),Promise.resolve().then(function(){t.setErrorHandler(e,!0,o.handleQueryErrors),e._filterStore.addQuery(t)})],!0)},{concurrency:1/0},!0)})},i.prototype._registerCommands=function(){var e=this;this.app.command("AddQueryStatus").register(this,function(t,r){return e.addStatus(!1,t,r)}),this.app.command("AddFilterStatus").register(this,function(t,r){return e.addStatus(!0,t,r)}),this.app.command("RemoveQueryStatus").register(this,function(){return e.removeStatus(!1)}),this.app.command("RemoveFilterStatus").register(this,function(){return e.removeStatus(!0)}),this.app.command("_getAllSavedQueries").register(this,function(t){return e._getAllQueries(!1,t)}),this.app.command("_getAllSavedFilters").register(this,function(t){return e._getAllQueries(!0,t)}),this.app.command("_getSavedQueryById").register(this,function(t,r,i){return e._getQueryById(!1,t,r,i)}),this.app.command("_getSavedFilterById").register(this,function(t,r,i){return e._getQueryById(!0,t,r,i)}),this.app.command("_getSavedQueryByName").register(this,function(t,r,i){return e._getQueryByName(!1,t,r,i)}),this.app.command("_getSavedFilterByName").register(this,function(t,r,i){return e._getQueryByName(!0,t,r,i)}),this.app.command("RemoveSavedQuery").register(this,function(t,r){return e._removeQuery(!1,t,r)}),this.app.command("RemoveSavedFilter").register(this,function(t,r){return e._removeQuery(!0,t,r)}),this.app.command("RemoveSavedQueryById").register(this,function(t){return e._removeQueryById(!1,t)}),this.app.command("RemoveSavedFilterById").register(this,function(t){return e._removeQueryById(!0,t)}),this.app.command("_updateSavedQueryById").register(this,function(t,r,i,a){return e._updateQueryById(!1,t,r,i,a)}),this.app.command("_updateSavedFilterById").register(this,function(t,r,i,a){return e._updateQueryById(!0,t,r,i,a)}),this.app.command("ClearSavedQueries").register(this,function(){return e._clearQueries(!1)}),this.app.command("ClearSavedFilters").register(this,function(){return e._clearQueries(!0)}),this.app.command("_addSavedQuery").register(this,function(t,r,i){return e._addQuery(!1,t,r,i)}),this.app.command("_addSavedFilter").register(this,function(t,r,i){return e._addQuery(!0,t,r,i)})},i.prototype._retrieveSiteQueries=function(){var e=this;return this.app.waitUntilSiteServiceLayersLoaded().then(function(){var t=u.AppInfo.fromGeocortexApp(e.app).mapInfo.getLayerInfos().filter(function(e){return e.queryable&&!!e.displayName&&!!e.url});return c.PromiseUtils.mapSkipRejected(t,function(t){return e._retrieveQueriesForLayer(t)},{concurrency:1/0},!0)}).then(function(e){return 0!==e.length?e.reduce(function(e,t){return e.concat(t)}):[]}).catch(function(t){return e.app.trace.error("An unknown error occured while retrieving queries defined for the site.\n\n                                    No queries were loaded.\n\n                                    Please contact your administrator to fix this issue."),console.error(t),[]})},i.prototype._retrieveQueriesForLayer=function(e){var t=this,i=e.gcxLayer.queries||[];return c.PromiseUtils.mapSkipRejected(i,function(i){if(!t._isValidQueryGroupObject(i.query))throw new Error("Could not parse the following query. Reason: Invalid query object\n\n                                        "+JSON.stringify(i.query,null,2));var a=t._configureQueryStateRecursive(i.query,e,i.id,i.displayName);return new n.Query(t.app,t.libraryId,{layer:e,layerIsTable:!1,logicalOperator:"and"}).applyState(a,r.latestProjectSerialVersion)},{concurrency:1/0},!0)},i.prototype._configureQueryStateRecursive=function(e,t,r,i){var a=this,o={id:r,layer:this.app.project.convert.fromGcxLayer(t.gcxLayer),clauses:[],children:[],order:[],conjunction:e.conjunction,where:"",adminDefined:!1,displayName:i,selectedSpatialFilter:y.None,selectedSpatialFilterName:this.getResource("language-querybuilder-spatial-filter-all")},l=[],u=[];if(e.items.forEach(function(e){if(a._isValidClauseObject(e)){void 0===e.value&&(e.value=null);var t={id:s.idPrefix+p.alphaNumericToken(),field:e.field,operator:d.QueryOperator[e.operator].toString(),value:e.value};u.push(t)}else a._isValidQueryGroupObject(e)?l.push(e):a.app.trace.error("Could not parse the following query item. It is not an instance of a clause or sub-query\n\n                                        "+JSON.stringify(e,null,2))}),0==u.length)throw new Error("Query must have at least one valid query clause");return o.clauses=u,o.children=l.map(function(e){var r=n.idPrefix+p.alphaNumericToken();return a._configureQueryStateRecursive(e,t,r,i)}),o},i.prototype._isValidClauseObject=function(e){return void 0!==e.field&&null!==e.field&&"string"==typeof e.field&&(void 0!==e.operator&&null!==e.operator&&"string"==typeof e.operator&&void 0!==d.QueryOperator[e.operator]&&("string"==typeof e.value||null===e.value||void 0===e.value))},i.prototype._isValidQueryGroupObject=function(e){return void 0!==e.conjunction&&null!==e.conjunction&&"string"==typeof e.conjunction&&(e.conjunction=e.conjunction.toLowerCase(),void 0!==d.Conjunctions[e.conjunction]&&null!==d.Conjunctions[e.conjunction]||(e.conjunction=null),e.items instanceof Array)},i.prototype._getAllQueries=function(e,t){try{var r=(e?this._filterStore:this._queryStore).getAllQueries();t(r)}catch(r){var i=r;i.code=o.ERRCODES.RETRIEVECOLLECTIONERROR,o.handleQueryErrors.call(this,e,i),t([])}},i.prototype._getQueryById=function(e,t,r,i){try{var a=(e?this._filterStore:this._queryStore).getQueryById(t);if(null==a){var n=new Error("Query with id "+t+" not found");return n.code=o.ERRCODES.NOTFOUND,n.id=t,i(n)}return r(a)}catch(e){return i(e)}},i.prototype._getQueryByName=function(e,t,r,i){try{var a=(e?this._filterStore:this._queryStore).getQueryByName(t);if(null===a){var n=new Error("Query with name "+t+" not found");return n.code=o.ERRCODES.NOTFOUND,n.name=t,!!i&&i(n)}return r(a)}catch(e){return!!i&&i(e)}},i.prototype._removeQuery=function(e,t,r){var i=this,a=e?this.getResource("language-querybuilder-delete-prompt-filter"):this.getResource("language-querybuilder-delete-prompt-query"),n=e?this.getResource("language-querybuilder-delete-prompt-title-filter").format(t.displayName.get()):this.getResource("language-querybuilder-delete-prompt-title-query").format(t.displayName.get());r&&!0===r.removeLayerFlag?this._removeQueryById(e,t.id.get()):this.app.command("Confirm").execute(a,n,function(r){r&&i._removeQueryById(e,t.id.get())})},i.prototype._removeQueryById=function(e,t){var r=this;(e?this._filterStore:this._queryStore).removeQueryById(t).then(function(i){if(null===i){var a=new Error("Query with id "+t+" not found");throw a.code=o.ERRCODES.NOTFOUND,a.id=t,a}r.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(r.app.getResource(r.libraryId,"language-querybuilder-notification-removed").format(e?"filter":"query",i.displayName.get()))}).catch(function(t){o.handleQueryErrors.call(r,e,t),r.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(r.app.getResource(r.libraryId,"language-querybuilder-error-removing").format(e?"filter":"query",{error:!0}))})},i.prototype._updateQueryById=function(e,t,r,i,a){var n=this;try{(e?this._filterStore:this._queryStore).updateQueryById(t,r).then(function(t){return n.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(n.app.getResource(n.libraryId,"language-querybuilder-notification-updated").format(e?"filter":"query",t.displayName.get())),!!i&&i(t)},function(e){throw e})}catch(e){return!!a&&a(e)}},i.prototype._addQuery=function(e,t,r,i){var a=this;try{(e?this._filterStore:this._queryStore).addQuery(t).then(function(t){return a.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(a.app.getResource(a.libraryId,"language-querybuilder-notification-saved").format(e?"filter":"query",t.displayName.get())),!!r&&r(t)},function(e){return!!i&&i(e)})}catch(e){return!!i&&i(e)}},i.prototype._clearQueries=function(e){var t=this;(e?this._filterStore:this._queryStore).clear().then(function(){t.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(t.app.getResource(t.libraryId,"language-querybuilder-notification-clear").format(e?"filter":"query"))},function(r){t.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(t.app.getResource(t.libraryId,"language-querybuilder-error-clearing").format(e?"filter":"query",{error:!0}))})},i.prototype.addStatus=function(e,t,r){var i=new l.AddStatusArgs(t);i.timeoutMS=0,i.regionName=e?this._filterStatusRegion:this._queryStatusRegion,i.id=e?"FilterStatusMessageView":"QueryStatusMessageView",e?this.app.command("RemoveFilterStatus").execute():this.app.command("RemoveQueryStatus").execute(),this.app.command("AddStatus").execute(i)},i.prototype.removeStatus=function(e){this.app.command("RemoveStatus").execute(e?"FilterStatusMessageView":"QueryStatusMessageView")},i.prototype.getStateFilter=function(){return{queries:{item:n.Query.getStateFilter(this.app)},filters:{item:n.Query.getStateFilter(this.app)},savedQueries:{item:n.Query.getStateFilter(this.app)},savedFilters:{item:n.Query.getStateFilter(this.app)}}},i.prototype.exportState=function(){var e=this,t={queries:[],savedQueries:[],filters:[],savedFilters:[],serialVersion:2};t.savedQueries=this._queryStore.getAllQueries().map(function(e){return e.exportState()}),t.savedQueries=t.savedQueries.filter(function(e){return!e.adminDefined}),t.savedFilters=this._filterStore.getAllQueries().map(function(e){return e.exportState()}),t.savedFilters=t.savedFilters.filter(function(e){return!e.adminDefined});var r=["_ExportQueryBuilderState","_ExportFilterBuilderState"].map(function(r){return new Promise(function(i,a){return e.app.command(r).execute(t,i,function(r){return e.app.trace.error("Could not export query or filter builder state"),i(t)})})});return Promise.all(r).then(function(){return t})},i.prototype.applyState=function(e){var t=this;e.serialVersion!==r.latestProjectSerialVersion&&this.convertLegacyState(e);var i={state:e,completePromises:[]};return this.app.waitUntilAllLibrariesLoaded().then(function(){var e=t._queryStore.getAllQueries().filter(function(e){return!e.adminDefined}),r=t._filterStore.getAllQueries().filter(function(e){return!e.adminDefined}),i=e.map(function(e){return t._queryStore.removeQueryById(e.id.get())}),a=r.map(function(e){return t._filterStore.removeQueryById(e.id.get())});return Promise.all(i.concat(a))}).then(function(){t._queryStore.disableCollectionChangedEvent(),t._filterStore.disableCollectionChangedEvent();var r=t._restoreCollection(t._queryStore,e.savedQueries),i=t._restoreCollection(t._filterStore,e.savedFilters);return Promise.all([r,i])}).then(function(){return t.app.command("_ApplyQueryBuilderState").execute(i),t.app.command("_ApplyFilterBuilderState").execute(i),Promise.all(i.completePromises)}).then(function(){t._queryStore.enableCollectionChangedEvent(),t._filterStore.enableCollectionChangedEvent(),t._queryStore.bindingEvent.publish(),t._filterStore.bindingEvent.publish()}).return()},i.prototype._restoreCollection=function(e,t){var i=this;return c.PromiseUtils.mapSkipRejected(t,function(t){var a=new n.Query(i.app,i.libraryId,{layer:null,layerIsTable:!1,logicalOperator:"AND"});a.setErrorHandler(i,!1,o.handleQueryErrors);var s;return a.applyState(t,r.latestProjectSerialVersion).then(function(t){return s=t,e.addQuery(t)}).catch(function(t){if(t.code===o.ERRCODES.DUPLICATE)return s.displayName.set(s.displayName.get()+" "+i.app.getResource(i.libraryId,"language-querybuilder-duplicate-name-resolution-postfix")),i.app.command(e.isFilterCollection?"RemoveFilterStatus":"RemoveQueryStatus").execute(),e.addQuery(s);throw t})},{concurrency:1/0},!0)},i.prototype.convertLegacyState=function(e){switch(e.serialVersion){case 1:e.savedQueries=[],e.savedFilters=[];break;default:this.app.trace.warning("Could not convert legacy state of query builder module. Legacy version unknown")}},i}(i.ModuleBase);r.QueryBuilderModule=g})},"Mapping/modules/QueryBuilder/QueryBuilderState":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"Mapping/modules/QueryBuilder/QueryClause":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();define(["require","exports","geocortex/forms/items/DatePickerFormItem","./AutoCompleteViewModel","geocortex/framework/observables","./QueryOperatorDescription","./QueryOperator","geocortex/infrastructure/FormatUtils","geocortex/infrastructure/DateFormat","geocortex/essentials/Field","geocortex/essentials/utilities/TimeZoneUtils","./QueryBase","./Query","./QueryErrorHandling","./Formatters","geocortex/framework/utils/utils","./QueryBuilderModule"],function(t,r,i,a,n,s,o,l,u,d,p,c,y,g,h,m,f){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.idPrefix="qc_";var v=function(t){function c(e,p,y){var g=t.call(this,e,p)||this;return g._settingCodedDomainValue=!1,g.fields=new n.ObservableCollection,g.fieldValue=new n.Observable,g.codedDomainValue=new n.Observable,g.operators=new n.ObservableCollection,g.selectedFieldName=new n.Observable,g.selectedOperator=new n.Observable,g.deleteDisabled=new n.Observable(!1),g.codedValues=new n.ObservableCollection,g.presentableFieldName=new n.Observable,g.presentableOperator=new n.Observable,g.presentableFieldValue=new n.Observable,g.presentableFieldValueIsEmptyText=new n.Observable,g.logicalOperator=new n.Observable,g.showTextInput=new n.Observable,g.showDateTimeInput=new n.Observable,g.showCodedValueDomainInput=new n.Observable,g.showDisabledInput=new n.Observable,g.id.set(r.idPrefix+m.alphaNumericToken()),g.type="queryItem",g.autoCompleteViewModel=new a.AutoCompleteViewModel(e,p),g.autoCompleteViewModel.queryClause=g,g.datePickerFormItem=new i.DatePickerFormItem(null),g.datePickerFormItem.nullable.set(!1),g.layer=y.layer.get(),g.parentQuery=y,g.templateType="single-item",g.selectedOperator.set(o.QueryOperator.Equals.toString()),g._selectedFieldNameBindingToken=g.selectedFieldName.bind(g,g._fieldChanged),g._selectedOperatorBindingToken=g.selectedOperator.bind(g,g._operatorChanged),g._codedDomainValueBindingToken=g.codedDomainValue.bind(g,function(e){!g._settingCodedDomainValue&&g.selectedField.isTypeField&&g.parentQuery.updateCodedDomainValues()}),g.fieldValue.bind(g,function(){g.parentQuery.isModified.set(!0)}),g.presentableFieldName.syncTransform(g.selectedFieldName,function(e){var t=g.fields.get().filter(function(e){return e.name==g.selectedFieldName.get()})[0];return t?t.alias:""}),g.presentableFieldValue.syncTransform(g.fieldValue,function(e){if(e){g.presentableFieldValueIsEmptyText.set(!1);var t=l.parseDate(e,u.DateFormat.ROUND_TRIP);if(g.selectedField&&g.selectedField.type===d.EsriFieldTypes.esriFieldTypeDate&&t&&!isNaN(t.getTime()))return h.QueryFormatterFactory.getFormatter(g.parentQuery.layer.get()).supportsTimeOfDay()?l.formatDate(t,u.DateFormat.DATE_TIME_SHORT):l.formatDate(t,u.DateFormat.DATE_SHORT);if(c._isCodedValueDomain(g.selectedField))for(var r=0;r<g.codedValues.length();r++)if(g.codedValues.getAt(r).val===g.codedDomainValue.get())return g.codedValues.getAt(r).name;return g.selectedField.isNumeric()?g.selectedField.formatValue(e):"'{0}'".format(e)}return g.presentableFieldValueIsEmptyText.set(!0),g.app.getResource(g.libraryId,"language-querybuilder-any-value")}),g.presentableOperator.syncTransform(g.selectedOperator,function(e){return s.QueryOperatorDescription.FromQueryOperator(parseInt(e)).name}),g.logicalOperator.bind(g,function(){g.isAnd.set(g.logicalOperator.get()===o.Conjunctions.and),g.isOr.set(g.logicalOperator.get()===o.Conjunctions.or)}),g.logicalOperator.sync(g.parentQuery.selectedLogicalOperator),g.parentQuery.selectedLogicalOperator.bind(g,function(){g.updateCodedDomainValues()}),g}return e(c,t),c.prototype.format=function(e){var t=h.QueryFormatterFactory.getFormatter(this.layer);e=e||parseInt(this.selectedOperator.get(),10);var r=this.fieldValue.get();if(!r&&e!==o.QueryOperator.IsNull&&e!==o.QueryOperator.IsNotNull)return"";var i="",a=l.parseDate(r,u.DateFormat.ROUND_TRIP);if(this.selectedField&&this.selectedField.type===d.EsriFieldTypes.esriFieldTypeDate&&a&&!isNaN(a.getTime())){var n=this.layer&&this.layer.gcxLayer?p.getTimeZoneFromLayer(this.layer.gcxLayer):null,s=this.layer&&this.layer.gcxLayer?p.getDisplayTimeZoneFromMapService(this.layer.gcxLayer.mapService):null;if(e===o.QueryOperator.Equals||e===o.QueryOperator.NotEquals){var c=new Date(a.getFullYear(),a.getMonth(),a.getDate(),0,0,0),g=new Date(a.getFullYear(),a.getMonth(),a.getDate()+1,0,0,0);c=p.correctDatesToQueryInDatabaseTime(c,n,s),g=p.correctDatesToQueryInDatabaseTime(g,n,s);var m=l.formatDate(c,u.DateFormat.ROUND_TRIP),f=l.formatDate(g,u.DateFormat.ROUND_TRIP);i=e===o.QueryOperator.Equals?y.Query.appendExpression(t.format(this.selectedField,o.QueryOperator.GreaterThanEquals,m),t.format(this.selectedField,o.QueryOperator.LessThan,f),o.Conjunctions.and):y.Query.appendExpression(t.format(this.selectedField,o.QueryOperator.LessThan,m),t.format(this.selectedField,o.QueryOperator.GreaterThanEquals,f),o.Conjunctions.or)}else a=p.correctDatesToQueryInDatabaseTime(a,n,s),r=l.formatDate(a,u.DateFormat.ROUND_TRIP),i=t.format(this.selectedField,e,r)}else i=this.selectedField.isCodedValueDomain()&&e!==o.QueryOperator.Equals&&e!==o.QueryOperator.NotEquals?t.format(this.selectedField,e,r,this.getAllPossibleCodedValues()):t.format(this.selectedField,e,r);return i},c.prototype.exportState=function(){return{id:this.id.get(),field:this.selectedFieldName.get(),operator:this.selectedOperator.get(),value:this.fieldValue.get()}},c.prototype.applyState=function(e,t,r){r&&r!==f.latestProjectSerialVersion&&this.convertLegacyState(e,r),this.id.set(e.id);try{this.setFields(t)}catch(t){throw t.missingFieldName=e.field,t}this.selectedFieldName.set(e.field),this.updateCodedDomainValues(),this.selectedOperator.set(e.operator),c._isCodedValueDomain(this.selectedField)?(this.codedDomainValue.set(e.value),this.autoCompleteViewModel.value.set(e.value)):this.selectedField&&this.selectedField.isDate()?this.datePickerFormItem.date.set(l.parseDate(e.value)):this.autoCompleteViewModel.value.set(e.value)},c.prototype.convertLegacyState=function(e,t){switch(t){case 1:e.id=r.idPrefix+m.alphaNumericToken();break;default:this.app.trace.warning("Legacy queryClause serialVersion not recognized. Creating the queryClause may fail.")}},c.getStateFilter=function(){return{id:!0,field:!0,operator:!0,value:!0}},c.prototype.getSuggestions=function(){return this.parentQuery.getSuggestions(this)},c.prototype._fieldChanged=function(){var e=this,t=this.fields.get().filter(function(t){return t.name==e.selectedFieldName.get()})[0];if(t){this.selectedField=t,this.parentQuery.isModified.set(!0),this._codedDomainSelectionBinding&&this.codedDomainValue.unbind(this._codedDomainSelectionBinding),this._autocompleteSelectionBinding&&this.autoCompleteViewModel.value.unbind(this._autocompleteSelectionBinding),this.operators.clear(),c._isCodedValueDomain(t)?(this.operators.addItem(s.QueryOperatorDescription.Equals),this.operators.addItem(s.QueryOperatorDescription.NotEquals),this.operators.addItem(s.QueryOperatorDescription.Contains),this.operators.addItem(s.QueryOperatorDescription.DoesNotContain),this.operators.addItem(s.QueryOperatorDescription.StartsWith),this.operators.addItem(s.QueryOperatorDescription.EndsWith)):t.isNumeric()||t.isDate()?(this.operators.addItem(s.QueryOperatorDescription.Equals),this.operators.addItem(s.QueryOperatorDescription.NotEquals),this.operators.addItem(s.QueryOperatorDescription.LessThan),this.operators.addItem(s.QueryOperatorDescription.LessThanEquals),this.operators.addItem(s.QueryOperatorDescription.GreaterThan),this.operators.addItem(s.QueryOperatorDescription.GreaterThanEquals)):t.isText()&&(this.operators.addItem(s.QueryOperatorDescription.Contains),this.operators.addItem(s.QueryOperatorDescription.DoesNotContain),this.operators.addItem(s.QueryOperatorDescription.StartsWith),this.operators.addItem(s.QueryOperatorDescription.EndsWith),this.operators.addItem(s.QueryOperatorDescription.Equals),this.operators.addItem(s.QueryOperatorDescription.NotEquals)),t.nullable&&(this.operators.addItem(s.QueryOperatorDescription.IsNull),this.operators.addItem(s.QueryOperatorDescription.IsNotNull)),this.selectedOperator.set(this.operators.getAt(0).value.toString());var r=parseInt(this.selectedOperator.get());this._updateInputVisibility(t,r),this.parentQuery.updateCodedDomainValues(),c._isCodedValueDomain(this.selectedField)?(this._codedDomainSelectionBinding=this.codedDomainValue.bind(this,function(t){e.showCodedValueDomainInput.get()&&e.fieldValue.set(t)}),this._autocompleteSelectionBinding=this.autoCompleteViewModel.value.bind(this,function(t){e.showCodedValueDomainInput.get()||e.fieldValue.set(t)}),this.fieldValue.set(this.codedDomainValue.get())):this.selectedField.isDate()?this.fieldValue.syncTransform(this.datePickerFormItem.date,function(t){return l.formatDate(e.datePickerFormItem.date.get(),u.DateFormat.ROUND_TRIP)}):this.fieldValue.sync(this.autoCompleteViewModel.value)}},c.prototype.setFields=function(e){this.fields.set(e),this.parentQuery.isModified.set(!0);var t=new Error("Could not find selected field from given fields.");t.queryClause=this,t.code=g.ERRCODES.LAYERFIELDERROR,this.fields.length()>0&&!this.selectedFieldName.get()?this.selectedFieldName.set(this.fields.getAt(0).name):0==this.fields.length()?(t.missingFieldName=this.selectedFieldName.get(),t.allFields=[],this.selectedFieldName.set(null)):this.selectedFieldName.get()&&-1===this.fields.get().map(function(e){return e.name}).indexOf(this.selectedFieldName.get())&&(t.missingFieldName=this.selectedFieldName.get(),t.allFields=e,this.selectedFieldName.set(this.fields.getAt(0).name))},c.prototype.updateCodedDomainValues=function(){var e=this;if(this.codedValues.clear(),this.selectedField){if(this.selectedField.isCodedValueDomain())for(n=0;n<this.selectedField.getCodedValueDomain().codedValues.length;n++){var t=this.selectedField.getCodedValueDomain().codedValues[n];this.codedValues.addItem({name:t.name,val:t.code.toString()})}if(this.selectedField.hasSubtypeCodedValueDomains()){for(var r=this.selectedField.getSubtypeCodedValueDomains(),i=0,a=null,n=0;n<this.parentQuery.queryClauses.length();n++){var s=this.parentQuery.queryClauses.getAt(n);s!==this&&s.selectedField&&s.selectedField.isTypeField&&(a=s,i++)}if(1===i&&this.parentQuery.selectedLogicalOperator.get()===o.Conjunctions.and){var l=a.codedDomainValue.get();if(a.selectedOperator.get()===o.QueryOperator.Equals.toString())(d=r[l])&&d.codedValues.length>0&&d.codedValues.forEach(function(t){e.codedValues.addItem({name:t.name,val:t.code.toString()})});else for(var u in r)u!==l&&r.hasOwnProperty(u)&&(d=r[u]).codedValues.forEach(function(t){e.codedValues.addItem({name:t.name,val:t.code.toString()})})}else for(var u in r)if(r.hasOwnProperty(u)){var d=r[u];d.codedValues.forEach(function(t){e.codedValues.addItem({name:t.name,val:t.code.toString()})})}}if(this.parentQuery.isModified.set(!0),this.codedValues.length()>0){this._settingCodedDomainValue=!0;for(var p=!1,n=0;n<this.codedValues.getLength();n++)this.codedValues.getAt(n).val===this.codedDomainValue.get()&&(p=!0,this.codedDomainValue.pulse());p||this.codedDomainValue.set(this.codedValues.getAt(0).val),this._settingCodedDomainValue=!1}}},c.prototype.getAllPossibleCodedValues=function(){var e=[];e.push.apply(e,this.selectedField.getCodedValueDomain().codedValues);for(var t=this.selectedField.getSubtypeCodedValueDomains(),r=0,i=Object.keys(t);r<i.length;r++){var a=t[i[r]];e.push.apply(e,a.codedValues.filter(function(t){return-1===e.indexOf(t)}))}return e.map(function(e){return{name:e.name,val:e.code}})},c.prototype._updateInputVisibility=function(e,t){this.showTextInput.set(!1),this.showDateTimeInput.set(!1),this.showCodedValueDomainInput.set(!1),this.showDisabledInput.set(!1),t===o.QueryOperator.IsNotNull||t===o.QueryOperator.IsNull?this.showDisabledInput.set(!0):e.isDate()?this.showDateTimeInput.set(!0):!c._isCodedValueDomain(e)||t!==o.QueryOperator.Equals&&t!==o.QueryOperator.NotEquals?this.showTextInput.set(!0):this.showCodedValueDomainInput.set(!0)},c.prototype._operatorChanged=function(){if(this.selectedField){var e=this.selectedField;e.isTypeField&&this.parentQuery.updateCodedDomainValues();var t=parseInt(this.selectedOperator.get(),10);this._updateInputVisibility(e,t),this.parentQuery.isModified.set(!0)}},c._isCodedValueDomain=function(e){return!!e&&(e.isCodedValueDomain()||e.hasSubtypeCodedValueDomains())},c.prototype.dispose=function(){this._codedDomainSelectionBinding&&this.codedDomainValue.unbind(this._codedDomainSelectionBinding),this._autocompleteSelectionBinding&&this.autoCompleteViewModel.value.unbind(this._autocompleteSelectionBinding),this.selectedFieldName.unbind(this._selectedFieldNameBindingToken),this.selectedOperator.unbind(this._selectedOperatorBindingToken),this.codedDomainValue.unbind(this._codedDomainValueBindingToken),this.fieldValue.removeSync(),this.presentableFieldName.removeSync(),this.presentableFieldValue.removeSync(),this.presentableOperator.removeSync(),this.autoCompleteView&&this.autoCompleteView.dispose()},c}(c.QueryBase);r.QueryClause=v})},"Mapping/modules/QueryBuilder/QueryCollection":function(){define(["require","exports","geocortex/framework/observables","./Query","geocortex/framework/utils/utils","geocortex/framework/events/Event","./QueryErrorHandling","./QueryBuilderModule","geocortex/infrastructure/PromiseUtils"],function(e,t,r,i,a,n,s,o,l){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Sources={Project:"project",AdministratorDefined:"adminDef",CurrentSession:"curSession"};!function(e){e[e.CREATE=0]="CREATE",e[e.UPDATE=1]="UPDATE",e[e.DELETE=2]="DELETE"}(t.Operations||(t.Operations={}));var u=function(){function e(e,t,i){if(this.queryStorageKey="QC",this.isFilterCollection=!1,this.id="QC-"+a.alphaNumericToken(),this.app=e,this.libraryId=t,i.persistent){var s=new Error;s.message="Persistent queries not supported",this.app.trace.error("Persistent queries not supported",s)}else this.store=null;this.sourceName=i.sourceName?i.sourceName:null,this.queryStorageKey+="-"+(this.sourceName?this.sourceName:"unknown"),this._queries=new r.ObservableCollection,this.bindingEvent=new n.Event("placeholderForQueryCollectionChanged",e)}return e.prototype.initialize=function(){return this._initializeData()},e.prototype._initializeData=function(){var e=this;return Promise.all([this._retrieveLocalQueries()]).then(function(t){var r=[];return t.forEach(function(e){r.push.apply(r,e)}),l.PromiseUtils.mapSkipRejected(r,function(t){e.getQueryByName(t.displayName.get());if(null!==t)t.displayName.set(t.displayName.get().concat("_duplicate"));return e.addQuery(t)},{concurrency:1/0},!0)})},e.prototype._retrieveLocalQueries=function(){var e=this;return this.store?this.app.store.get(this.queryStorageKey).then(function(t){var r=[];if(t)try{r=JSON.parse(t)}catch(t){e.app.trace.error("Unable to parse user queries",t)}return l.PromiseUtils.mapSkipRejected(r,function(t){var r=new i.Query(e.app,e.libraryId,{layer:null,layerIsTable:!1,logicalOperator:"AND"});return r.setErrorHandler(e,e.isFilterCollection,s.handleQueryErrors),r.applyState(t,o.latestProjectSerialVersion)},{concurrency:1/0},!0)},function(t){return e.app.trace.error("Could not retrieve user queries from storage"),new Array}):Promise.resolve(new Array)},e.prototype._save=function(e){var t=this;if(this.store){var r=JSON.stringify(this._queries.get().map(function(e){return e.exportState()}));return new Promise(function(e,i){t.store.set(t.queryStorageKey,r,function(e,r){t._bindingEventDisabled||t.bindingEvent.publish()},function(e){t.app.trace.error("Could not save QueryCollection",e),i(e)})})}return this._bindingEventDisabled||(void 0!==e?this.bindingEvent.publish(e):this.bindingEvent.publish()),Promise.resolve()},e.prototype.setCollectionChangedEvent=function(e){this.bindingEvent=e},e.prototype.disableCollectionChangedEvent=function(){this._bindingEventDisabled=!0},e.prototype.enableCollectionChangedEvent=function(){this._bindingEventDisabled=!1},e.prototype.getAllQueries=function(){return this._queries.get()},e.prototype.getQueryById=function(e){var t=this._queries.get().filter(function(t){return t.id.get()===e});return t.length>=1?(t.length>1&&this.app.trace.warning("multiple queries with the same id "+e+" found. Returning the first result"),t[0]):null},e.prototype.getQueryByName=function(e){var t=this._queries.get().filter(function(t){return t.displayName.get()===e});return t.length>=1?(t.length>1&&this.app.trace.warning("multiple queries with the same name "+e+" found. Returning the first result"),t[0]):null},e.prototype.removeQueryById=function(e){var t=this._queries.get().filter(function(t){return t.id.get()===e});return t.length>=1?(t.length>1&&this.app.trace.warning("multiple queries with the same id "+e+" found. Removing the first result"),this._queries.removeItem(t[0]),this._save().then(function(){return t[0]})):null},e.prototype.updateQueryById=function(e,t){if(t){var r=this.getQueryById(e);if(r){var i=this._queries.indexOf(r);return this._queries.removeItem(r),t.id.set(e),this._queries.insertItem(i,t),this._save().then(function(){return t})}}},e.prototype.addQuery=function(e){if(e)return this._queries.get().filter(function(t){return!(!e.displayName.get()||!t.displayName.get())&&t.displayName.get()===e.displayName.get()}).length>=1?void this.app.trace.error("Cannot add duplicate query "+e.displayName.get()+" to collection."):(this._queries.addItem(e),this._save(0).then(function(){return e}))},e.prototype.getQueriesByLayer=function(e){return this._queries.get().filter(function(t){return!!t.layer.get()&&t.layer.get().uniqueId===e.uniqueId})},e.prototype.removeQueriesByLayer=function(e){var t=this,r=this.getQueriesByLayer(e);return r.forEach(function(e){return t._queries.removeItem(e)}),this._save().then(function(){return r})},e.prototype.clear=function(){return this._queries.clear(),this._save()},e.prototype.length=function(){return this._queries.length()},e}();t.QueryCollection=u})},"Mapping/modules/QueryBuilder/QueryErrorHandling":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r;!function(e){e[e.NOTFOUND=0]="NOTFOUND",e[e.DUPLICATE=1]="DUPLICATE",e[e.LAYERMISSINGERROR=2]="LAYERMISSINGERROR",e[e.LAYERFIELDERROR=3]="LAYERFIELDERROR",e[e.SAVINGERROR=4]="SAVINGERROR",e[e.EXECUTIONFAILURE=5]="EXECUTIONFAILURE",e[e.ADDQUERYCLAUSEERROR=6]="ADDQUERYCLAUSEERROR",e[e.NONAMEGIVENERROR=7]="NONAMEGIVENERROR",e[e.RETRIEVECOLLECTIONERROR=8]="RETRIEVECOLLECTIONERROR",e[e.UPDATEQUERYERROR=9]="UPDATEQUERYERROR"}(r=t.ERRCODES||(t.ERRCODES={})),t.handleQueryErrors=function(e,t){var i=t;if(void 0!==i.displayStatus&&null!==i.displayStatus&&typeof i.displayStatus==typeof!0||(i.displayStatus=!0),!i.handled){switch(i.handled=!0,i.code){case r.LAYERMISSINGERROR:var a=t;this.app.trace.error("Could not load "+(e?"filter":"query")+" because layer "+a.layerName+" is missing. The list of layers follows in debug mode if it has been retrieved.",t);var n="";a.allLayers&&a.allLayers.forEach(function(e){n+=e.name+" \n"}),this.app.trace.debug(n),i.displayStatus&&this.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(this.app.getResource(this.libraryId,"language-querybuilder-error-data-source-missing").format(e?"filter":"query",a.queryState.displayName,a.layerName),{error:!0});break;case r.LAYERFIELDERROR:var s,o=t;o.missingFieldName?(this.app.trace.error("Could not restore queryClause with id "+o.queryClause.id.get()+": The field "+o.missingFieldName+" is missing.\n                    The full list of fields follows the queryClause has follows: \n"+o.allFields.map(function(e){return e.name}),t),s=this.app.getResource(this.libraryId,"language-querybuilder-error-field-missing").format(e?"filter":"query",o.missingFieldName)):(this.app.trace.error("Could not restore a queryClause for an unknown reason.",t),s=this.app.getResource(this.libraryId,"language-querybuilder-error-restore-clause-unknown")),i.displayStatus&&this.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(s,{error:!0});case r.NOTFOUND:var l=i;this.app.trace.error("Could not find "+(e?"filter":"query")+" with id "+l.id+" and name "+l.queryName);var u=this.app.getResource(this.libraryId,"language-querybuilder-error-not-found").format(e?"filter":"query");l.queryName&&(u+=" with name "+l.queryName),i.displayStatus&&this.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(u,{error:!0});break;case r.DUPLICATE:var d=i;this.app.trace.error("Could not add "+(e?"filter":"query")+" with duplicate name "+d.queryName),i.displayStatus&&this.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(this.app.getResource(this.libraryId,"language-querybuilder-error-saving-duplicate").format(e?"filter":"query",d.queryName),{error:!0});break;case r.SAVINGERROR:var p=i;this.app.trace.error("Error saving "+(e?"filter":"query")+" with name "+p.queryName),i.displayStatus&&this.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(this.app.getResource(this.libraryId,"language-querybuilder-error-saving").format(e?"filter":"query",p.queryName),{error:!0});break;case r.ADDQUERYCLAUSEERROR:var c=i;this.app.trace.error("Error adding "+c.clauses.length+" "+(e?"filter":"query")+" clauses\n                Following is the clause information in debug logging mode"),this.app.trace.debug(c.clauses.map(function(e){return e.exportState().toString()})),i.displayStatus&&this.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(this.app.getResource(this.libraryId,"language-querybuilder-error-add-query-clause").format(e?"filter":"query",c.clauses.length),{error:!0});break;case r.NONAMEGIVENERROR:this.app.trace.error("A name must be provided to rename a query"),i.displayStatus&&this.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(this.app.getResource(this.libraryId,"language-querybuilder-error-no-name").format(e?"filter":"query"),{error:!0});break;case r.RETRIEVECOLLECTIONERROR:this.app.trace.error("Could not retrieve queries for list of saved "+(e?"filters":"queries")),i.displayStatus&&this.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(this.app.getResource(this.libraryId,"language-querybuilder-error-retrieve-queries").format(e?"filter":"query"),{error:!0});break;case r.UPDATEQUERYERROR:var y;y=i.adminDefined?this.app.getResource(this.libraryId,"language-querybuilder-error-update-query-admin"):this.app.getResource(this.libraryId,"language-querybuilder-error-update-query-unknown"),this.app.trace.error("Could not update saved "+(e?"filter":"query")),i.displayStatus&&this.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(y.format(e?"filter":"query"),{error:!0});break;default:this.app.trace.error((e?"Filter":"Query")+" Builder: An unknown error occured.",t),i.displayStatus&&this.app.command(e?"AddFilterStatus":"AddQueryStatus").execute(this.app.getResource(this.libraryId,"language-querybuilder-savedqueries-error-message").format(e?"filter":"query"),{error:!0})}this.app.debugMode&&console.error(t.stack)}}})},"Mapping/modules/QueryBuilder/QueryOperator":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});!function(e){e[e.Equals=0]="Equals",e[e.NotEquals=1]="NotEquals",e[e.GreaterThan=2]="GreaterThan",e[e.GreaterThanEquals=3]="GreaterThanEquals",e[e.LessThan=4]="LessThan",e[e.LessThanEquals=5]="LessThanEquals",e[e.Contains=6]="Contains",e[e.DoesNotContain=7]="DoesNotContain",e[e.StartsWith=8]="StartsWith",e[e.EndsWith=9]="EndsWith",e[e.IsNull=10]="IsNull",e[e.IsNotNull=11]="IsNotNull"}(t.QueryOperator||(t.QueryOperator={})),t.Conjunctions={and:"and",or:"or"}})},"Mapping/modules/QueryBuilder/QueryOperatorDescription":function(){define(["require","exports","./QueryOperator"],function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){this.value=e,this.name=t}return e.FromQueryOperator=function(t){for(var r in e)if(e[r].value==t)return e[r];return null},e.initializeStaticValues=function(t,i){this.Equals=new e(r.QueryOperator.Equals,t.getResource(i,"language-querybuilder-operator-equals")),this.NotEquals=new e(r.QueryOperator.NotEquals,t.getResource(i,"language-querybuilder-operator-not-equals")),this.GreaterThan=new e(r.QueryOperator.GreaterThan,t.getResource(i,"language-querybuilder-operator-greater-than")),this.GreaterThanEquals=new e(r.QueryOperator.GreaterThanEquals,t.getResource(i,"language-querybuilder-operator-greater-than-equal-to")),this.LessThan=new e(r.QueryOperator.LessThan,t.getResource(i,"language-querybuilder-operator-less-than")),this.LessThanEquals=new e(r.QueryOperator.LessThanEquals,t.getResource(i,"language-querybuilder-operator-less-than-equal-to")),this.Contains=new e(r.QueryOperator.Contains,t.getResource(i,"language-querybuilder-operator-contains")),this.DoesNotContain=new e(r.QueryOperator.DoesNotContain,t.getResource(i,"language-querybuilder-operator-does-not-contain")),this.StartsWith=new e(r.QueryOperator.StartsWith,t.getResource(i,"language-querybuilder-operator-starts-with")),this.EndsWith=new e(r.QueryOperator.EndsWith,t.getResource(i,"language-querybuilder-operator-ends-with")),this.IsNull=new e(r.QueryOperator.IsNull,t.getResource(i,"language-querybuilder-operator-null")),this.IsNotNull=new e(r.QueryOperator.IsNotNull,t.getResource(i,"language-querybuilder-operator-not-null"))},e}();t.QueryOperatorDescription=i})},"Mapping/modules/QueryBuilder/SimpleQueryBuilderView":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();define(["require","exports","geocortex/framework/ui/ViewBase","geocortex/framework-ui/ViewContainer/ViewContainerView","geocortex/forms/items/TimePickerFormItem","./AutoCompleteView","geocortex/framework/resourceManager","./Formatters","geocortex/framework/observables"],function(t,r,i,a,n,s,o,l,u){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var d=function(t){function r(e,r){var i=t.call(this,e,r)||this;return i._isFilterBuilder=new u.Observable(!1),i._initialized=!1,i._activatingView=!1,i._observableTokenDictionary={},i._processedInitialDefaultFilter=!1,i}return e(r,t),r.prototype.attach=function(e){var r=this;this._isFilterBuilder.set("filter"===this.configuration.mode),t.prototype.attach.call(this,e),this._isFilterBuilder.sync(e.isFilterBuilder),this.viewModel.initializeFromViewConfig(this.configuration),this.attachQuery(),this.app.event("_deattachingQuery").subscribe(this,function(){r.deattachQuery()}),this.app.event("_newQueryAttached").subscribe(this,function(){r.attachQuery()}),this.app.event("_logicalOperatorChanged").subscribe(this,this.handleLogicalOperatorChanged),this._observableTokenDictionary.displayedQueryIsSaved=this.viewModel.displayedQueryIsSaved.bind(this,function(e){var t=r._getQueryTitle(r.viewModel.displayedQuery.get().displayName.get(),r.viewModel.displayedQueryIsSaved.get());t=r._getModifiedStatusTitle(t,r.viewModel.displayedQuery.get().isModified.get(),r.viewModel.displayedQueryIsSaved.get()),r.title.set(t)}),this._initialized||(dojo.connect(this.viewModel,"event_queryClausesRemoving",this,this.viewModel_queryClausesRemoving),this.bindAutoCompleteEvents(),this._initialized=!0),this._registerCommandsAndEvents()},r.prototype.activated=function(){this._processedInitialDefaultFilter||(this.viewModel.checkForExistingFilter(),this._processedInitialDefaultFilter=!0),this.viewModel.refreshQueryGeometry()},r.prototype.deattachQuery=function(){this.viewModel.displayedQuery.get()&&(this._observableTokenDictionary.isModifed&&this.viewModel.displayedQuery.get().isModified.unbind(this._observableTokenDictionary.isModifed),this._observableTokenDictionary.displayName&&this.viewModel.displayedQuery.get().displayName.unbind(this._observableTokenDictionary.displayName))},r.prototype.attachQuery=function(){var e=this;this.viewModel.displayedQuery.get()&&(this._observableTokenDictionary.isModified=this.viewModel.displayedQuery.get().isModified.bind(this,function(t){e.title.set(e._getModifiedStatusTitle(e.title.get(),t,e.viewModel.displayedQueryIsSaved.get()))}),this._observableTokenDictionary.displayName=this.viewModel.displayedQuery.get().displayName.bind(this,function(t){var r=e._getQueryTitle(t,e.viewModel.displayedQueryIsSaved.get());r=e._getModifiedStatusTitle(r,e.viewModel.displayedQuery.get().isModified.get(),e.viewModel.displayedQueryIsSaved.get()),e.title.set(r)}))},r.prototype.deactivated=function(){this._isFilterBuilder.get()?this.app.command("RemoveFilterStatus").execute():this.app.command("RemoveQueryStatus").execute(),this.viewModel.extentChangeHandle&&this.viewModel.extentChangeHandle.remove()},r.prototype._getQueryTitle=function(e,t){var r;if(e&&e.length>0)if(t){var i=": "+e;r=this.app.getResource(this.libraryId,this.viewModel.isFilterBuilder.get()?"language-querybuilder-simple-filter-title-saved":"language-querybuilder-simple-title-saved").concat(i)}else r=this.app.getResource(this.libraryId,this.viewModel.isFilterBuilder.get()?"language-querybuilder-simple-filter-title":"language-querybuilder-simple-title");else r=this.app.getResource(this.libraryId,this.viewModel.isFilterBuilder.get()?"language-querybuilder-simple-filter-title":"language-querybuilder-simple-title");return r},r.prototype._getModifiedStatusTitle=function(e,t,r){if(t&&r){if(!e.endsWith(" *"))return e.concat(" *")}else if(e.endsWith(" *"))return e.slice(0,-1*" *".length);return e},r.prototype._registerCommandsAndEvents=function(){var e=this;this.app.command(this.viewModel.isFilterBuilder.get()?"DisplayFilter":"DisplayQuery").register(this,this._executeDisplayQuery);var t,r=this.app.viewManager.getRegionForViewId(this.id);if(r){var i=r.ownerView;i instanceof a.ViewContainerView&&(t=i)}t?this.app.event("ViewContainerDeactivatedEvent").subscribe(this,function(r){r.id===t.id&&e.app.command(e.viewModel.isFilterBuilder.get()?"RemoveFilterStatus":"RemoveQueryStatus").execute()}):this.app.trace.warning((this.viewModel.isFilterBuilder.get()?"Filter":"Query")+" Builder could\n                                    not find enclosing container for view: "+this.id+".\n\n                                    Status messages will NOT be dismissed when this ViewContainer is deactivated."),this.app.event("ViewActivatedEvent").subscribe(this,function(t){if(!e._activatingView){if(e._activatingView=!0,t.id===(e._isFilterBuilder.get()?"SimpleFilterBuilderContainerView":"SimpleQueryBuilderContainerView")){var r=t.childRegions.filter(function(t){return t.name===(e._isFilterBuilder.get()?"SimpleFilterBuilderContainerRegion":"SimpleQueryBuilderContainerRegion")});1===r.length?0===r[0].activeViews.length&&e.app.viewManager.activateView(e):e.app.trace.error("Could not find region containing views for the \n                                                "+(e._isFilterBuilder.get()?"filter":"query")+" builder. No view may be \n                                                hosted in the panel. Please reopen the "+(e._isFilterBuilder.get()?"filter":"query")+" \n                                                tool.")}e._activatingView=!1}})},r.prototype._executeDisplayQuery=function(e,t){var r=this;this.viewModel.queryExists(e.id.get()).then(function(t){return r.viewModel.displayedQueryIsSaved.set(t),r.viewModel.applyDisplayedQueryState(e.exportState())}).then(function(e){r.viewModel.selectedLayerUniqueId.set(r.viewModel.displayedQuery.get().layerId.get()),r.viewModel.displayedQuery.get().isModified.set(!1),r.app.viewManager.activateView(r),!!t&&t()}).catch(function(t){r.app.trace.error("Could not display the given query with id "+e.id.get()+" and name "+e.displayName.get()+" as it could not be loaded")})},r.prototype.form_keydown=function(e){if((new Date).getTime()-(this._lastAutoCompleteTime?this._lastAutoCompleteTime.getTime():0)>50&&13==e.keyCode){var t=$(e.target);if(t.prop("tagName").search(/^input$/i)>=0&&t.prop("type").search(/^text$/i)>=0)return this.performAction(),!1}return!0},r.prototype.form_submit=function(){return!1},r.prototype.bindAutoCompleteEvents=function(){var e=this;$(this.htmlForm).on("autocompleteselect","input.ui-autocomplete-input",function(t){e._lastAutoCompleteTime=new Date})},r.prototype.handleRadioClick=function(e,t,r){"or"===t.value?r.selectedLogicalOperator.set("or"):r.selectedLogicalOperator.set("and")},r.prototype.handleLogicalOperatorChanged=function(e,t){"or"===t?$("[name=radioButtonGroup"+e.get()+"][value=or]").prop("checked",!0):$("[name=radioButtonGroup"+e.get()+"][value=and]").prop("checked",!0)},r.prototype.addQueryClause_click=function(e,t,r){this.viewModel.addQueryClause(r).then(function(){$(".query-clause-row").last().find("input, select").first().focus()})},r.prototype.addNestedQuery_click=function(e,t,r){this.viewModel.addNestedQuery(r)},r.prototype.removeQueryClause_click=function(e,t,r){null===r.parentQuery.parentQuery||void 0===r.parentQuery.parentQuery?r.parentQuery.queryClauses.length()>1&&this.viewModel.removeQueryClause(r):r.parentQuery.queryClauses.length()>1?this.viewModel.removeQueryClause(r):this.viewModel.removeNestedQuery(r.parentQuery)},r.prototype.actionButton_click=function(){this.performAction()},r.prototype.clearFilterButton_click=function(){this.viewModel.disabled.set(!1);var e=this.viewModel.displayedQuery.get().layer.get();e.setDefinitionExpression(this.viewModel.defaultLayerFilters[e.uniqueId])},r.prototype.clearResultsButton_click=function(){this.event_clearResultsButtonClicked()},r.prototype.cancelButton_click=function(){this.app.viewManager.deactivateView(this)},r.prototype.externalfilterButton_click=function(){this.viewModel.displayedQuery.get().layer.get().setDefinitionExpression("1 = 2")},r.prototype.event_clearResultsButtonClicked=function(){},r.prototype.onFilterSelected=function(){this.viewModel.refreshQueryGeometry()},r.prototype.performAction=function(){this.viewModel.isQueryBuilder.get()?this.viewModel.executeQuery(this.viewModel.displayedQuery.get()):(this.viewModel.executeFilter(this.viewModel.displayedQuery.get()),this.app.event("FilterBuilderLayerDefinitionAppliedEvent").publish({gcxlayer:this.viewModel.displayedQuery.get().layer.get().gcxLayer}))},r.prototype.resolveWidget=function(e,r,i){if(t.prototype.resolveWidget.call(this,e,r),!e)return null;switch(e){case"QueryActionsWidget":return this.app.menuRegistry.createMenuWidget(this,r,i,this.libraryId,this._isFilterBuilder.get()?"FilterBuilderActions":"QueryBuilderActions");case"DatePicker":var a=l.QueryFormatterFactory.getFormatter(this.viewModel.displayedQuery.get().layer.get());r.datePickerFormItem.includeTimePicker.set(a.supportsTimeOfDay());var u=new n.TimePickerFormItem(null);r.datePickerFormItem.timePickerItem=u;var d=this.app.viewManager.createView({markupResource:"Mapping/infrastructure/ui/components/Forms/DatePickerFormItemView.html",libraryId:"Mapping.Infrastructure",typeName:"geocortex.essentialsHtmlViewer.mapping.infrastructure.ui.components.Forms.DatePickerFormItemView",isVisible:!0});return d.attach(r.datePickerFormItem),r.datePickerView=d,d;case"AutoComplete":var p=new s.AutoCompleteView(this.app),c=document.createElement("span");return dojo.html.set(c,o.resourceManager.fetch("Mapping/modules/QueryBuilder/AutoCompleteView.html",this.libraryId)),p.root=c,r.autoCompleteViewModel.appendTo="."+this.id+" .autocomplete-container",p.attach(r.autoCompleteViewModel),r.autoCompleteView=p,p;default:return null}},r.prototype.viewModel_queryClausesRemoving=function(e){for(t=0;t<e.length;t++)e[t].datePickerView&&$(e[t].datePickerView.root).find("input, button, select").off();for(var t=0;t<e.length;t++)e[t].autoCompleteView&&$(e[t].autoCompleteView.root).find("input").off()},r}(i.ViewBase);r.SimpleQueryBuilderView=d})},"Mapping/modules/QueryBuilder/SimpleQueryBuilderViewModel":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();define(["require","exports","geocortex/infrastructure/FeatureSetCollection","geocortex/infrastructure/FeatureSet","geocortex/framework/ui/ViewModelBase","geocortex/framework-ui/FilterableCollection","geocortex/framework/observables","./QueryClause","./QueryOperator","./Formatters","geocortex/infrastructure/gis/AppInfo","./QueryOperatorDescription","./Query","geocortex/infrastructure/ArrayUtils","geocortex/infrastructure/TaskUtils","geocortex/infrastructure/gis/ServiceLayerInfo","geocortex/infrastructure/GeometryUtils","./QueryCollection","./QueryErrorHandling","./QueryBuilderModule","geocortex/infrastructure/PromiseUtils"],function(t,r,i,a,n,s,o,l,u,d,p,c,y,g,h,m,f,v,b,Q,w){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var S=function(t){function r(e,r){var i=t.call(this,e,r)||this;return i.layers=new s.FilterableCollection,i.tables=new s.FilterableCollection,i.selectedLayerUniqueId=new o.Observable,i.infoText=new o.Observable,i.spatialFilters=new o.ObservableCollection,i.selectedSpatialFilter=new o.Observable(Q.SpatialFilterOptions.None),i.selectedSpatialFilterName=new o.Observable,i.defaultLogicalOperator=new o.Observable(u.Conjunctions.and),i.displayedQuery=new o.Observable,i.defaultLayerFilters={},i.isAwab=new o.Observable(!1),i.isGvh=new o.Observable(!1),i.isQueryAndAwab=new o.Observable(!1),i.isDebug=new o.Observable(!1),i.isQueryBuilder=new o.Observable(!0),i.isFilterBuilder=new o.Observable(!1),i.areQueryableTables=new o.Observable(!1),i.areQueryableLayers=new o.Observable(!1),i.showLayerError=new o.Observable(!1),i.disabled=new o.Observable(!1),i.nestingLevelTooDeep=new o.Observable(!1),i.selectedLayerIsTable=new o.Observable(!1),i.filterAlreadyApplied=new o.Observable(!1),i.notDisabled=new o.Observable(!0),i.noAvailableLayers=new o.Observable(!1),i.noAvailableLayersText=new o.Observable(""),i.displayedQueryIsSaved=new o.Observable(!1),i.config={},i._allLayers=new o.ObservableCollection,i._allTables=new o.ObservableCollection,i._isRestoringQueryStatePromise=Promise.resolve(null),i._isRestoringStatePromise=Promise.resolve(null),i._initializingPromise=null,i._subTokenDictionary={},i._gcxTokenDictionary={},i._mapTokenDictionary={},i._observableTokenDictionary={},i._currentSpatialFilter=new o.Observable(null),i._graphicsLayerSubscriptions=new Array,i.isGvh.syncTransform(i.isAwab,function(e){return!e}),i.notDisabled.syncTransform(i.disabled,function(e){return!e}),i.volatileQueries=new v.QueryCollection(e,r,{persistent:!1}),i.volatileQueries.isFilterCollection=i.isFilterBuilder.get(),i}return e(r,t),r.prototype.attachQuery=function(e){var t,r=this;this.displayedQuery.get()&&(this._observableTokenDictionary.hasOwnProperty("spatialFilter")&&this.selectedSpatialFilter.unbind(this._observableTokenDictionary.spatialFilter),this._observableTokenDictionary.hasOwnProperty("layerId")&&this.selectedLayerUniqueId.unbind(this._observableTokenDictionary.layerId),this._observableTokenDictionary.hasOwnProperty("saveQueryCanExecute")&&this.displayedQuery.get().isModified.unbind(this._observableTokenDictionary.saveQueryCanExecute),this.displayedQuery.get().selectedSpatialFilter.removeSync(),this.displayedQuery.get().selectedSpatialFilterName.removeSync(),this.displayedQuery.get().defaultLogicalOperator.removeSync(),this.displayedQuery.get().removeErrorHandler(),t=this.displayedQuery.get().numSuggestions),this.app.event("_deattachingQuery").publish(),this.displayedQuery.set(e),this.displayedQuery.get().selectedLogicalOperator.pulse(),this.displayedQuery.get().setErrorHandler(this,this.isFilterBuilder.get(),b.handleQueryErrors),this._observableTokenDictionary.spatialFilter=this.selectedSpatialFilter.bind(this,function(e){r.displayedQuery.get().isModified.set(!0),"string"==typeof e&&(e=parseInt(e,10));for(var t=0;t<r.spatialFilters.length();t++)r.spatialFilters.getAt(t).val===e&&r.selectedSpatialFilterName.set(r.spatialFilters.getAt(t).name)}),this._observableTokenDictionary.saveQueryCanExecute=this.displayedQuery.get().isModified.bind(this,function(){r.app.command(r.isFilterBuilder.get()?"ShowSaveFilterDialog":"ShowSaveQueryDialog").raiseCanExecuteChanged()}),this._observableTokenDictionary.layerId=this.selectedLayerUniqueId.bind(this,function(){r.layerIdChanged().then(function(){null!==r.displayedQuery.get().layer.get()&&r.displayedQuery.get().buildWhereClause()})}),this.displayedQuery.get().selectedSpatialFilter.sync(this.selectedSpatialFilter),this.displayedQuery.get().selectedSpatialFilterName.sync(this.selectedSpatialFilterName),this.displayedQuery.get().defaultLogicalOperator.sync(this.defaultLogicalOperator),this.displayedQuery.get().numSuggestions=t,this.app.event("_newQueryAttached").publish()},r.prototype.initialize=function(e){var t=this;e&&(this.config=e),this.app.waitUntilApplicationReady().then(function(){t._initializingPromise||(t._initializingPromise=t.app.waitUntilSiteServiceLayersLoaded().then(function(){var e=p.AppInfo.fromGeocortexApp(t.app);t.initializeQueryBuilder(e),t.registerCommandsAndEvents()}))})},r.prototype.initializeFromViewConfig=function(e){e&&(this.config=e);var t=new y.Query(this.app,this.libraryId,{layer:null,layerIsTable:!1,logicalOperator:null});this.attachQuery(t),this.queryFormatterFactory=new d.QueryFormatterFactory(this.config),this.isDebug.set(!!this.app.debugMode),this.isAwab.set(this.app.isArcGisWebApp),c.QueryOperatorDescription.initializeStaticValues(this.app,this.libraryId);var r="filter"!==this.config.mode;if(this.isQueryBuilder.set(r),this.isFilterBuilder.set(!r),this.isQueryAndAwab.set(this.isAwab.get()&&r),this.displayedQuery.get().setErrorHandler(this,this.isFilterBuilder.get(),b.handleQueryErrors),r?this.noAvailableLayersText.set(this.app.getResource(this.libraryId,"language-querybuilder-no-valid-query-layers")):this.noAvailableLayersText.set(this.app.getResource(this.libraryId,"language-querybuilder-no-valid-filter-layers")),e.hasOwnProperty("defaultLogicalOperator")&&null!=e.defaultLogicalOperator&&"string"==typeof e.defaultLogicalOperator){var i=e.defaultLogicalOperator.toLowerCase();void 0===u.Conjunctions[i]||null===u.Conjunctions[i]?(this.displayedQuery.get().selectedLogicalOperator.set(this.defaultLogicalOperator.get()),this.app.trace.warning('Invalid default conjunction "'+i+'" given. Using '+this.defaultLogicalOperator.get()+" as the default")):(this.defaultLogicalOperator.set(u.Conjunctions[i]),this.displayedQuery.get().selectedLogicalOperator.set(u.Conjunctions[i]))}e.hasOwnProperty("numberOfSuggestions")&&null!=e.numberOfSuggestions&&("number"!=typeof(i=e.numberOfSuggestions)||i<0?(this.displayedQuery.get().numSuggestions=10,this.app.trace.warning('Invalid number of suggestions "'+i+'" given. Using '+this.displayedQuery.get().numSuggestions+" as the default")):this.displayedQuery.get().numSuggestions=i)},r.prototype.initializeQueryBuilder=function(e){this._appInfo=e,this._allLayers.clear();var t=e.mapInfo.getLayerInfos().filter(function(e){return e.queryable&&!!e.displayName&&!!e.url});t=g.ArrayUtils.sortBy(t,function(e){return e.displayName}),this._allLayers.set(t);var r=e.mapInfo.getTableInfos().filter(function(e){return e.queryable&&!!e.displayName&&!!e.url});this._allTables.set(r),this._checkUseableLayers(),this.layers.setSource(this._allLayers),this.tables.setSource(this._allTables),this.layers.setFilter(function(e){return e&&(!e.gcxLayer||e.gcxLayer.inActiveTheme)}),this.layers.length()>0&&this.layers.getAt(0)?this.selectedLayerUniqueId.set(this.layers.getAt(0).uniqueId):this.tables.length()>0&&this.tables.getAt(0)?this.selectedLayerUniqueId.set(this.tables.getAt(0).uniqueId):0===this.layers.length()&&0===this.tables.length()&&this.noAvailableLayers.set(!0),this._handleNewServiceLayers(e.mapInfo.serviceLayers),this.refreshSpatialFilterOptions(),this.displayedQuery.get().isModified.set(!1)},r.prototype.registerCommandsAndEvents=function(){var e=this;this.isQueryBuilder.get()&&this.app.command("RunQuery").register(this,this.executeQuery),this.isQueryBuilder.get()&&this.app.command("RunFilter").register(this,this._executeRunFilter),this.app.command(this.isFilterBuilder.get()?"ShowSaveFilterDialog":"ShowSaveQueryDialog"),this.app.command(this.isFilterBuilder.get()?"ShowSaveFilterDialog":"ShowSaveQueryDialog").canExecute=function(){return!(!e.displayedQueryIsSaved.get()||e.displayedQuery.get().adminDefined)&&e.displayedQuery.get().isModified.get()},this.app.command(this.isFilterBuilder.get()?"ShowSaveFilterDialog":"ShowSaveQueryDialog").raiseCanExecuteChanged(),this.app.command(this.isFilterBuilder.get()?"_ExportFilterBuilderState":"_ExportQueryBuilderState").register(this,function(t,r,i){e.exportState(t),r(t)}),this.app.command(this.isFilterBuilder.get()?"_ApplyFilterBuilderState":"_ApplyQueryBuilderState").register(this,function(t){t.completePromises.push(e.applyState(t.state))}),this.app.event(this.isFilterBuilder.get()?"SavedFiltersChangedEvent":"SavedQueriesChangedEvent").subscribe(this,function(t){if(void 0===t||0!==t){var r=e._isRestoringStatePromise.then(function(){return e.getCopyOfSavedQuery(e.displayedQuery.get().id.get())}).then(function(t){t?e.applyDisplayedQueryState(t.exportState()).then(function(){e.displayedQueryIsSaved.set(!0)}):e.displayedQueryIsSaved.set(!1)}),i=w.PromiseUtils.mapSkipRejected(e.volatileQueries.getAllQueries(),function(t){return e.getCopyOfSavedQuery(t.id.get()).then(function(r){return r?e.volatileQueries.updateQueryById(t.id.get(),r):void 0}).catch(function(e){throw e.displayStatus=!1,e})},{concurrency:1/0},!0);return w.PromiseUtils.allSkipRejected([r,i],!0)}}),this._appInfo.mapInfo.markupLayer.bind(this,this.markupLayerChanged),this.markupLayerChanged(this._appInfo.mapInfo.markupLayer.get());this._mapTokenDictionary["layer-add"]||(this._mapTokenDictionary["layer-add"]=this._appInfo.map.on("layer-add",function(t){e.layerAdded(t)}));this._mapTokenDictionary["layer-remove"]||(this._mapTokenDictionary["layer-remove"]=this._appInfo.map.on("layer-remove",function(t){e.layerRemoved(t)}));this._gcxTokenDictionary.MapServiceLayersChangedEvent||(this._gcxTokenDictionary.MapServiceLayersChangedEvent=this.app.event("MapServiceLayersChangedEvent").subscribe(this,function(t){t&&t.serviceLayer&&(e.layerRemoved({layer:t.serviceLayer}),e.layerAdded({layer:t.serviceLayer}))}));this._gcxTokenDictionary.LayerThemeChangedEvent||(this._gcxTokenDictionary.LayerThemeChangedEvent=this.app.event("LayerThemeChangedEvent").subscribe(this,function(t){e.layers.refresh();var r=0===e.layers.length();e.noAvailableLayers.set(r),e.layers.indexOf(e.displayedQuery.get().layer.get())<0?e.selectedLayerUniqueId.set(e.layers.length()?e.layers.getAt(0).uniqueId:null):e.selectedLayerUniqueId.pulse()}))},r.prototype.getCopyOfSavedQuery=function(e){var t=this;return new Promise(function(r,i){t.app.command(t.isFilterBuilder.get()?"_getSavedFilterById":"_getSavedQueryById").execute(e,function(e){e.getNewInstance().then(function(e){return r(e)})},function(e){return r(null)})})},r.prototype.queryExists=function(e){var t=this;return new Promise(function(r,i){t.app.command(t.isFilterBuilder.get()?"_getSavedFilterById":"_getSavedQueryById").execute(e,function(e){return r(!0)},function(e){return r(!1)})})},r.prototype.executeQuery=function(e){var t=this,r=e.isModified.get();this.refreshQueryGeometry(e).then(function(i){e.isModified.set(r);var n=t.getFsc(t.app.featureSetManager);n.clear(),t.app.featureSetManager.openCollection(n.id);var s,o=e.execute(t.app.map.spatialReference,t.app.event("QueryCompletedEvent"),!0),l=e.layer.get().gcxLayer;new Promise(o.then).then(function(e){s=new esri.tasks.FeatureSet(e)}).then(function(e){return l.getFeatureLayer()}).then(function(r){var i=new a.FeatureSet({esriFeatureSet:s,layer:l,featureLayer:r,app:t.app});i.displayName.set(t.app.getResource(t.libraryId,"language-querybuilder-feature-set-display-name").format(e.layer.get().displayName)),n.featureSets.addItem(i),i.resolveDataLinks(function(e){t.app.event("FeatureChangedEvent").publish(e)}),t.app.featureSetManager.closeCollection(n.id),t.app.command("AddResultsStatus").execute(t.app.getResource(t.libraryId,"language-querybuilder-notification-run-query").format(e.displayName.get()||"Query",e.layer.get().displayName))}).catch(function(e){t.app.trace.error(e),t.app.featureSetManager.closeCollection(n.id)})})},r.prototype._executeRunFilter=function(e){this.executeFilter(e,!0)},r.prototype.executeFilter=function(e,t){var r=this;void 0===t&&(t=!1);var i=e.isModified.get();this.getGeometryFilter(e.selectedSpatialFilter.get()).then(function(a){e.isModified.set(i),null!==a.get()?r.buildSpatiallyFilteredWhereClause(e,a.get()).then(function(t){r.app.trace.debug("Executing filter with query.buildWhereClause() clause: "+e.buildWhereClause()),r.app.trace.debug("Filter restricted by the following spatial filter: "+t),e.layer.get().setDefinitionExpression(r._getCompleteWhereClause(e.layer.get(),t))}):(e.layer.get().setDefinitionExpression(r._getCompleteWhereClause(e.layer.get(),e.buildWhereClause())),r.app.command("ShowMap").execute());var n=function(){return r.app.command("AddFilterStatus").execute(r.app.getResource(r.libraryId,"language-querybuilder-notification-run-filter").format(e.displayName.get()||"Filter",e.layer.get().displayName))};t?r.app.command("DisplayFilter").execute(e,function(){n()}):n()})},r.prototype.addNestedQuery=function(e){var t=this,r=new y.Query(this.app,this.libraryId,{layer:e.layer.get(),layerIsTable:e.layerIsTable.get(),logicalOperator:this.defaultLogicalOperator.get()}),i=[];return i.push(new l.QueryClause(this.app,this.libraryId,r),new l.QueryClause(this.app,this.libraryId,r)),r.refreshFields().then(function(){return r.addQueryClauses(i)}).then(function(){return Promise.resolve(e.addChildren([r])[0])}).then(function(e){return e.selectedLogicalOperator.pulse(),Promise.resolve(e)}).catch(function(r){return t.displayedQuery.get().id.get()===e.id.get()&&t.displayedQueryIsSaved.get()?r.displayStatus=!0:r.displayStatus=!1,Promise.reject(r)})},r.prototype.removeNestedQuery=function(e){this._removeNestedQueryRecursive(e,this.displayedQuery.get())},r.prototype._getCompleteWhereClause=function(e,t){return this.defaultLayerFilters[e.uniqueId]?y.Query.appendExpression(this.defaultLayerFilters[e.uniqueId],t,u.Conjunctions.and):t},r.prototype._removeNestedQueryRecursive=function(e,t){if(t.children.contains(e)){var r=[];return r.push(e),t.removeChildren(r),!0}for(var i=0;i<t.children.length();i++)if(this._removeNestedQueryRecursive(e,t.children.getAt(i)))return!0;return!1},r.prototype.getFsc=function(e){if(this._fsc)return e.getCollectionById(this._fsc.id)||e.addCollection(this._fsc),this._fsc;var t=new i.FeatureSetCollection;return e.addCollection(t),t.displayName.set(this.app.getResource(this.libraryId,"language-querybuilder-feature-set-collection-display-name")),t.sourceName="QueryBuilder",this._fsc=t,t},r.prototype.refreshSpatialFilterOptions=function(){if(this.displayedQuery.get().isModified.set(!1),0===this.spatialFilters.length()&&(this.spatialFilters.addItem({name:this.getResource("language-querybuilder-spatial-filter-all"),val:Q.SpatialFilterOptions.None}),this.spatialFilters.addItem({name:this.getResource("language-querybuilder-spatial-filter-current-extent"),val:Q.SpatialFilterOptions.CurrentExtent}),this.selectedSpatialFilter.set(Q.SpatialFilterOptions.None)),void 0==this.config.allowDrawingsAsSpatialFilter&&(this.config.allowDrawingsAsSpatialFilter=!0),this.config.allowDrawingsAsSpatialFilter){var e=this._appInfo.mapInfo.markupLayer.get();e&&e.graphics.length>0&&2===this.spatialFilters.length()?this.spatialFilters.addItem({name:this.getResource("language-querybuilder-spatial-filter-polygons"),val:Q.SpatialFilterOptions.Drawings}):e&&0!==e.graphics.length||3!==this.spatialFilters.length()||(this.spatialFilters.removeAt(2),this.selectedSpatialFilter.get()===Q.SpatialFilterOptions.Drawings&&this.selectedSpatialFilter.set(Q.SpatialFilterOptions.None))}this._updateSpatialFilterOption(this.selectedSpatialFilter.get())},r.prototype._updateSpatialFilterOption=function(e){"string"==typeof e&&(e=parseInt(e,10));for(var t=0;t<this.spatialFilters.length();t++)this.spatialFilters.getAt(t).val===e&&(this.selectedSpatialFilter.set(e),this.selectedSpatialFilterName.set(this.spatialFilters.getAt(t).name));return this.selectedSpatialFilter.pulse(),this.app.trace.debug("Could not verify spatial filter option for query with name "+this.displayedQuery.get().displayName.get()+". Option "+e+" not available")},r.prototype.exportState=function(e){var t=this,r=[];if(this.displayedQuery.get().layer.get()){var i=void 0;if(this.displayedQuery.get().adminDefined){var a=this.displayedQuery.get().id.get();this.displayedQuery.get().refreshId(),i=this.displayedQuery.get().exportState(),this.displayedQuery.get().id.set(a),i.adminDefined=!1}else i=this.displayedQuery.get().exportState();r.push(i)}this.volatileQueries.getAllQueries().forEach(function(e){if(e.id.get()!==t.displayedQuery.get().id.get()){var i=void 0;if(e.adminDefined){var a=e.id.get();e.refreshId(),i=e.exportState(),e.id.set(a),i.adminDefined=!1}else i=e.exportState();r.push(i)}}),this.isFilterBuilder.get()?e.filters=r.filter(function(e){return t._layerExistsInMap(e)}):e.queries=r.filter(function(e){return t._layerExistsInMap(e)})},r.prototype._layerExistsInMap=function(e){if(e.layer&&e.layer.serviceLayer&&e.layer.serviceLayer.id){var t=e.layer.serviceLayer.id;if(this.app.site.essentialsMap.getMap().getLayer(t))return!0}return!1},r.prototype.applyState=function(e){var t=this;return(!this._isRestoringStatePromise||this._isRestoringStatePromise&&this._isRestoringStatePromise.isFulfilled())&&(this._isRestoringStatePromise=Promise.resolve(null)),this._isRestoringStatePromise=this._isRestoringStatePromise.then(function(){return t.volatileQueries.clear()}).then(function(){var r=t.isFilterBuilder.get()?e.filters:e.queries;if(r&&r.length)return t._restoreQueryStates(r,e.serialVersion)}).then(function(e){return t._loadQueriesIntoModel(e)}).then(function(){return Promise.resolve()}).catch(function(e){return Promise.reject(e)}),this._isRestoringStatePromise},r.prototype._restoreQueryStates=function(e,t){var r=this;return w.PromiseUtils.mapSkipRejected(e,function(e){var i=new y.Query(r.app,r.libraryId,{layer:null,layerIsTable:!1,logicalOperator:u.Conjunctions.and});return i.setErrorHandler(r,r.isFilterBuilder.get(),b.handleQueryErrors),i.applyState(e,t).timeout(1e3)},{concurrency:1/0},!0)},r.prototype._loadQueriesIntoModel=function(e){var t=this;return w.PromiseUtils.mapSkipRejected(e,function(r){if(e.length>0&&r===e[0]&&r&&r.layerId){t.selectedLayerUniqueId.set(r.layerId.get()),t.infoText.set(t.getResource("language-querybuilder-find-in-layer").format(r.layer.get().displayName));t.isFilterBuilder,r.displayName.get(),r.layer.get().displayName;return t.applyDisplayedQueryState(r.exportState())}return t.volatileQueries.addQuery(r)},{concurrency:1/0},!0)},r.prototype.applyDisplayedQueryState=function(e,t){var r=this;(!this._isRestoringQueryStatePromise||this._isRestoringQueryStatePromise&&this._isRestoringQueryStatePromise.isFulfilled())&&(this._isRestoringQueryStatePromise=Promise.resolve(null));var i=new y.Query(this.app,this.libraryId,{layer:null,layerIsTable:!1,logicalOperator:null});return this._isRestoringQueryStatePromise=this._isRestoringQueryStatePromise.then(function(){return r.attachQuery(i)}).then(function(){return r.displayedQuery.get().applyState(e,t)}).then(function(t){if(r.disabled.set(!1),r.nestingLevelTooDeep.set(!1),r.displayedQuery.get().children.length()>0)for(var i=0;i<r.displayedQuery.get().children.length();i++)r.displayedQuery.get().children.getAt(i).children.length()>0&&(r.disabled.set(!0),r.nestingLevelTooDeep.set(!0));return r._updateSpatialFilterOption(e.selectedSpatialFilter),r.displayedQuery.get().isModified.set(!1),r.layerIdChanged(),t}),this._isRestoringQueryStatePromise},r.prototype._checkUseableLayers=function(){for(var e=0;e<this._allLayers.getLength();e++){var t=this._allLayers.getAt(e);if(t&&t.gcxLayer&&h.canQueryLayer(t.gcxLayer)&&t.gcxLayer.fields.length>0&&null!=t.gcxLayer.mapService&&null!==t.gcxLayer.mapService.serviceLayer){if(!this.isFilterBuilder.get()||this._isValidFilterLayer(t.gcxLayer.mapService))continue}else if(t&&t.queryable&&t.serviceLayerInfo&&t.serviceLayerInfo.serviceLayer&&t.serviceLayerInfo.serviceLayer.url&&(!this.isFilterBuilder.get()||this._isValidFilterLayer(t.serviceLayerInfo)))continue;this._allLayers.removeAt(e),e--}var r=0===this._allLayers.getLength(),i=0===this._allTables.getLength();this.areQueryableLayers.set(!r),this.areQueryableTables.set(!i&&this.isQueryBuilder.get());var a=this.isFilterBuilder.get()&&r||this.isQueryBuilder.get()&&r&&i;this.noAvailableLayers.set(a)},r.prototype._isValidFilterLayer=function(e){if(e.serviceLayer instanceof esri.layers.FeatureLayer&&e.serviceLayer.url)return!0;if(e.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer){var t=e.serviceLayer;if(null===t.capabilities||-1!==t.capabilities.indexOf("Query"))return!0}return!1},r.prototype._handleNewServiceLayers=function(e){for(var t=this,r=0;r<e.length;r++){var i=e[r];this._removeSub(i.serviceLayer.id);var a=dojo.connect(i.serviceLayer,"setLayerDefinitions",function(e){t._layerDefinitionsSet.call(t,this,e)});a&&(t._subTokenDictionary[i.serviceLayer.id]=a)}},r.prototype._removeSub=function(e){if(this._subTokenDictionary.hasOwnProperty(e)){var t=this._subTokenDictionary[e];t&&t.remove(),delete this._subTokenDictionary[e]}},r.prototype._layerDefinitionsSet=function(e,t){for(var r=0;r<t.length;++r){var i=t[r];this.displayedQuery.get().layer.get()&&this.displayedQuery.get().layer.get().serviceLayerInfo.serviceLayer===e&&this.displayedQuery.get().layerId.get()===i+""&&this.displayedQuery.get().buildWhereClause()!==t[i]&&(this.filterAlreadyApplied.set(!0),this.disabled.set(!0))}},r.prototype.markupLayerChanged=function(e){for(var t=this,r=0;r<this._graphicsLayerSubscriptions.length;r++)this._graphicsLayerSubscriptions[r].remove();e&&(this._graphicsLayerSubscriptions.push(e.on("graphic-add",function(){t.refreshSpatialFilterOptions()})),this._graphicsLayerSubscriptions.push(e.on("graphic-remove",function(){t.refreshSpatialFilterOptions()})))},r.prototype.layerIdChanged=function(){var e=this;return null===this.selectedLayerUniqueId.get()||void 0===this.selectedLayerUniqueId.get()?Promise.resolve():this.displayedQuery.get().layerId.get()&&this.selectedLayerUniqueId.get()===this.displayedQuery.get().layerId.get()?Promise.resolve():this.app.project.isLoading&&this._isRestoringStatePromise.isFulfilled()?Promise.resolve():this._isRestoringStatePromise&&!this._isRestoringStatePromise.isFulfilled()?Promise.resolve():(this._isUpdatingLayerId||(this._isUpdatingLayerId=Promise.resolve()),this.app.command("ScreenReaderNarrate").execute(this.app.getResource(this.libraryId,"language-querybuilder-WCAG-data-source-changed")),this._isUpdatingLayerId=this._isUpdatingLayerId.then(function(){return e._saveCurrentQuery()}).then(function(){e.disabled.set(!1);var t=e._findLayerOrTable(e.selectedLayerUniqueId.get());if(e.infoText.set(""),e.selectedSpatialFilter.set(Q.SpatialFilterOptions.None),e.displayedQuery.get().refreshId(),t)return e.displayedQuery.get().layer.set(t),e._loadLayerQuery(t)}).then(function(){return e.queryExists(e.displayedQuery.get().id.get())}).then(function(t){e.displayedQueryIsSaved.set(t),e.displayedQuery.get().isModified.set(!1),e.infoText.set(e.getResource("language-querybuilder-find-in-layer").format(e.displayedQuery.get().layer.get().displayName)),e.checkForExistingFilter()}).catch(function(t){var r=t;r.handled||(r||(r=new Error),r.message+="\nPoint of Failure: Could not change LayerId",b.handleQueryErrors.call(e,e.isFilterBuilder.get(),r)),e._isUpdatingLayerId=Promise.resolve()}),this._isUpdatingLayerId)},r.prototype.checkForExistingFilter=function(){this.isFilterBuilder.get()&&this.displayedQuery.get()&&this.displayedQuery.get().layer.get()&&this.displayedQuery.get().layer.get().getDefinitionExpression()&&(this._isEquivalentExpression(this._getCompleteWhereClause(this.displayedQuery.get().layer.get(),this.displayedQuery.get().buildWhereClause()),this.displayedQuery.get().layer.get().getDefinitionExpression())||(this.defaultLayerFilters[this.displayedQuery.get().layer.get().uniqueId]=this.displayedQuery.get().layer.get().getDefinitionExpression()))},r.prototype._saveCurrentQuery=function(){var e=this;return this._isSavingVolatileQuery||(this._isSavingVolatileQuery=Promise.resolve()),this._isSavingVolatileQuery=this._isSavingVolatileQuery.then(function(){return!e.displayedQuery.get().layer.get()||e._isRestoringStatePromise&&!e._isRestoringStatePromise.isFulfilled()?void 0:e.volatileQueries.removeQueriesByLayer(e.displayedQuery.get().layer.get()).then(function(){return e.displayedQuery.get().getNewInstance()}).then(function(t){return e.volatileQueries.addQuery(t)})}).catch(function(t){e.app.trace.error("Error in saving volatile query state"),e.app.trace.error(t)}),this._isSavingVolatileQuery},r.prototype._loadLayerQuery=function(e){var t=this,r=this.volatileQueries.getQueriesByLayer(e);return r.length>0?(1!==r.length&&this.app.trace.warning("Multiple queries are saved for the layer with name "+e.displayName+". Loading the first..."),this.applyDisplayedQueryState(r[0].exportState()).then(function(r){return t.volatileQueries.removeQueriesByLayer(e)}).catch(function(r){return t.buildBlankQuery(e)})):this.buildBlankQuery(e)},r.prototype._findLayerOrTable=function(e){this.selectedLayerIsTable.set(!1);for(var t=0;t<this.layers.length();t++)if(this.layers.getAt(t).uniqueId===e)return this.layers.getAt(t);if(-1!==this._getTableIndex(e)){var r=this._getTableIndex(e);return this.displayedQuery.get().layerIsTable.set(!0),this.selectedLayerIsTable.set(!0),this.tables.getAt(r)}},r.prototype._isEquivalentExpression=function(e,t){var r=!e||"1 = 1"===e,i=!t||"1 = 1"===t;return!(!r||!i)||e===t},r.prototype._getTableIndex=function(e){for(var t=0;t<this.tables.length();t++)if(this.tables.getAt(t).uniqueId===e)return t;return-1},r.prototype.layerAdded=function(e){if(!(e&&e.layer instanceof esri.layers.GraphicsLayer)||e.layer instanceof esri.layers.FeatureLayer){var t=null,r=[];this.app.isArcGisWebApp||(this._appInfo=p.AppInfo.fromGeocortexApp(this.app),(t=this._appInfo.mapInfo.findMapServiceById(e.layer.id))&&(r=t.layers.filter(function(e){return!(!e.gcxLayer||!e.gcxLayer.queryable)}))),t||(r=(t=m.ServiceLayerInfo.fromEsriLayer(e.layer)).layers),r.length>0&&(r=g.ArrayUtils.sortBy(r,function(e){return e.displayName}));for(var i=this._allLayers.length()-1,a=r.length-1;i>=0&&a>=0;){var n=this._allLayers.getAt(i).displayName;r[a].displayName>=n?(this._allLayers.insertItem(i+1,r[a]),a--):i--}for(;a>=0;)this._allLayers.insertItem(0,r[a]),a--;this._handleNewServiceLayers([t]),this._checkUseableLayers(),this.layers.refresh(),this.selectedLayerUniqueId.set(this.layers.length()?this.layers.getAt(0).uniqueId:null),this.selectedLayerUniqueId.pulse()}},r.prototype.layerRemoved=function(e){var t=this;this._allLayers.removeWhere(function(t){return t.serviceLayerInfo.serviceLayer===e.layer}),this._removeSub(e.layer.id),this.displayedQuery.get().layer.get()&&this.displayedQuery.get().layer.get().serviceLayerInfo&&this.displayedQuery.get().layer.get().serviceLayerInfo&&this.displayedQuery.get().layer.get().serviceLayerInfo&&e.layer&&this.displayedQuery.get().layer.get().serviceLayerInfo.serviceLayer===e.layer&&(this.layers.length()>0?this.buildBlankQuery(this.layers.getAt(0)):this.tables.length()>0?this.buildBlankQuery(this.tables.getAt(0)):this.buildBlankQuery(null)),this.displayedQuery.get().layer.get()&&this.infoText.set(this.getResource("language-querybuilder-find-in-layer").format(this.displayedQuery.get().layer.get().displayName)),new Promise(function(e,r){return t.app.command(t.isFilterBuilder.get()?"_getAllSavedFilters":"_getAllSavedQueries").execute(e)}).then(function(r){return w.PromiseUtils.mapSkipRejected(r,function(r){r.layer.get().serviceLayerInfo.serviceLayer===e.layer&&t.app.command(t.isFilterBuilder.get()?"RemoveSavedFilter":"RemoveSavedQuery").execute(r,{removeLayerFlag:!0})})}),this._checkUseableLayers()},r.prototype.addQueryClause=function(e){var t=new l.QueryClause(this.app,this.libraryId,e);return e.addQueryClauses([t])},r.prototype.removeQueryClause=function(e){e.parentQuery.removeQueryClause(e),e.selectedField&&e.selectedField.isTypeField&&(e.parentQuery.updateCodedDomainValues(),e.parentQuery.pulseCodedDomainValues())},r.prototype.clearAllQueries=function(){var e=this;return this.volatileQueries.clear(),this.disabled.set(!1),this.nestingLevelTooDeep.set(!1),this.displayedQuery.get().refreshId(),this.buildBlankQuery(this.displayedQuery.get().layer.get()).then(function(){return e.layerIdChanged()}).then(function(){e.displayedQueryIsSaved.set(!1),e.displayedQuery.get().isModified.set(!1),e.app.command(e.isFilterBuilder.get()?"RemoveFilterStatus":"RemoveQueryStatus").execute()})},r.prototype.buildBlankQuery=function(e){var t=this,r=this.defaultLogicalOperator.get()||null,i=new y.Query(this.app,this.libraryId,{layer:e,layerIsTable:!1,logicalOperator:r});return this.attachQuery(i),this.displayedQuery.get().refreshFields().then(function(){if(e){var r=new l.QueryClause(t.app,t.libraryId,t.displayedQuery.get());t.displayedQuery.get().addQueryClauses([r])}}).then(function(){return t.displayedQuery.get()})},r.prototype.buildSpatiallyFilteredWhereClause=function(e,t){var r=this,i=new dojo.Deferred,a=new esri.tasks.Query,n=e.buildWhereClause(),s=e.layer.get(),o=s.gcxLayer?s.gcxLayer:s.serviceLayerInfo.serviceLayer,l=h.getQueryTask(o);return a.geometry=t,a.where=n,l.executeForIds(a).then(function(e){e=e||[];for(var t=null,a=0;a<s.fields.length;a++){var o=s.fields[a];if("esriFieldTypeOID"===o.type){t=o.name;break}}if(null!==t){var l=void 0;0!==e.length?(l="{0} IN ({1})".format(t,e.toString()),i.resolve(l)):(l="1 = 0",i.resolve(l))}else r.app.trace.error("Could not find objectId property on currently displayed layer "+s.name+" to filter results with. Results not filtered"),i.resolve(n)},function(e){r.app.trace.error("an error occured while executing a query on "+s.name+". The query clause used was "+n,e),i.resolve(n)}),i},r.prototype.getGeometryFilter=function(e){var t=this;return this.extentChangeHandle&&this.extentChangeHandle.remove(),e=parseInt(e.toString(),10),this._updateSpatialFilterOption(e),this.displayedQuery.get().isModified.set(!1),new Promise(function(r,i){if(e===Q.SpatialFilterOptions.None)t._currentSpatialFilter.set(null),r(t._currentSpatialFilter);else if(e===Q.SpatialFilterOptions.CurrentExtent)t.extentChangeHandle=t._appInfo.map.on("extent-change",function(e){t._currentSpatialFilter.set(t._appInfo.map.extent)}),t._currentSpatialFilter.set(t._appInfo.map.extent),r(t._currentSpatialFilter);else if(e===Q.SpatialFilterOptions.Drawings){var a=new Array;if(t.isAwab.get())for(o=0;o<t._appInfo.mapInfo.getGraphicsLayers().length;o++){var n=t._appInfo.mapInfo.getGraphicsLayers()[o];n.id.indexOf("graphicsLayer")>-1&&a.push(n)}else a.push(t._appInfo.mapInfo.markupLayer.get());for(var s=[],o=0;o<a.length;o++)for(var l=a[o],u=0;u<l.graphics.length;u++){var d=l.graphics[u];if("polygon"===d.geometry.type)s.push(d.geometry);else if("extent"===d.geometry.type){var p=f.extentToPolygon(d.geometry);s.push(p)}}0===s.length?(t._currentSpatialFilter.set(null),r(t._currentSpatialFilter)):t._appInfo.getGeometryService().union(s).then(function(e){t._currentSpatialFilter.set(e),r(t._currentSpatialFilter)},function(e){t._currentSpatialFilter.set(null),r(t._currentSpatialFilter)})}else t.app.trace.warning("Selected spatial Filter not recognized"),t._currentSpatialFilter.set(null),r(t._currentSpatialFilter)})},r.prototype.refreshQueryGeometry=function(e){return void 0===e&&(e=this.displayedQuery.get()),e?this.getGeometryFilter(e.selectedSpatialFilter.get()).then(function(t){return e.geometry=t,e.isModified.set(!0),t}):Promise.resolve(null)},r.prototype.getViewerApp=function(){return this.app},r.prototype.onDestroy=function(){t.prototype.onDestroy.call(this),this._gcxTokenDictionary.LayerThemeChangedEvent&&this.app.event("LayerThemeChangedEvent").unsubscribe(this._gcxTokenDictionary.LayerThemeChangedEvent)},r}(n.ViewModelBase);r.SimpleQueryBuilderViewModel=S})},"Mapping/modules/QueryBuilder/SavedQueries/ListQueriesView":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();define(["require","exports","geocortex/framework/ui/ViewBase","geocortex/infrastructure/ui/components/PagingControls/PagingControlsViewModel"],function(t,r,i,a){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=function(t){function r(){return null!==t&&t.apply(this,arguments)||this}return e(r,t),r.prototype.attach=function(e){t.prototype.attach.call(this,e),this._registerCommands()},r.prototype.deactivated=function(){this.viewModel.isFilterBuilder.get()?this.app.command("RemoveFilterStatus").execute():this.app.command("RemoveQueryStatus").execute(),this.viewModel.presentableResults.currPageNumber.set(1)},r.prototype.resolveWidget=function(e,r,i){if("PagingControlsWidget"===e){var n=this.app.viewManager.createView({typeName:"geocortex.essentialsHtmlViewer.mapping.infrastructure.ui.components.PagingControls.PagingControlsView",markupResource:"Mapping/infrastructure/ui/components/PagingControls/PagingControlsView.html",libraryId:"Mapping.Infrastructure",isVisible:!0});if(n){var s=new a.PagingControlsViewModel(this.app,r);n.attach(s)}return n}return t.prototype.resolveWidget.call(this,e,r,i)},r.prototype._registerCommands=function(){this.app.command(this.viewModel.isFilterBuilder.get()?"ListFilters":"ListQueries").register(this,this.show)},r.prototype.show=function(e){var t=this;this.viewModel&&this.viewModel.refreshData().then(function(){t.app.viewManager.activateView(t)},function(e){t.app.command(t.viewModel.isFilterBuilder.get()?"AddFilterStatus":"AddQueryStatus").execute(t.app.getResource(t.libraryId,"language-querybuilder-error-retrieve-queries").format(t.viewModel.isFilterBuilder.get()?"filter":"query"),{error:!0})})},r.prototype.handleQueryActions=function(e,t,r){this.app.command(this.viewModel.isFilterBuilder.get()?"ShowFilterActions":"ShowQueryActions").execute(r)},r.prototype.handleQueryClick=function(e,t,r){this.app.command(this.viewModel.isFilterBuilder.get()?"RunFilter":"RunQuery").execute(r)},r}(i.ViewBase);r.ListQueriesView=n})},"Mapping/modules/QueryBuilder/SavedQueries/ListQueriesViewModel":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();define(["require","exports","geocortex/framework/ui/ViewModelBase","geocortex/framework/observables","geocortex/framework-ui/PresentableCollection"],function(t,r,i,a,n){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var s=function(t){function r(e,r){var i=t.call(this,e,r)||this;return i.isFilterBuilder=new a.Observable(!1),i.isPaged=!0,i.pageSize=10,i.queries=new a.ObservableCollection,i.presentableResults=new n.PresentableCollection(i.queries),i.resultsPage=i.presentableResults.items,i}return e(r,t),r.prototype.initialize=function(e){t.prototype.initialize.call(this,e),(e=e||{}).hasOwnProperty("isPaged")&&(this.isPaged=e.isPaged),e.hasOwnProperty("pageSize")&&(this.pageSize=e.pageSize),e.hasOwnProperty("mode")&&("filter"===e.mode?this.isFilterBuilder.set(!0):"query"===e.mode?this.isFilterBuilder.set(!1):this.app.trace.warning('Invalid configuration option for ListQueriesView "mode": '+e.mode+" given.")),this.presentableResults.isPaginated.set(this.isPaged),this.presentableResults.pageSize.set(this.pageSize),this.refreshData(),this._registerListeners()},r.prototype._registerListeners=function(){var e=this;this.app.event(this.isFilterBuilder.get()?"SavedFiltersChangedEvent":"SavedQueriesChangedEvent").subscribe(this,function(){e.refreshData()}),this.app.event("LayerThemeChangedEvent").subscribe(this,function(){e.refreshData()})},r.prototype.refreshData=function(){var e=this;return this._retrieveData().then(function(t){e.queries.clear();var r=t.filter(function(e){return e.layer.get()&&e.layer.get().gcxLayer.inActiveTheme});if(e.isFilterBuilder.get()){var i=r.filter(function(t){return t.layer&&t.layer.get().gcxLayer?e._isValidFilterLayer(t.layer.get().gcxLayer.mapService):!!t.layer&&e._isValidFilterLayer(t.layer.get().serviceLayerInfo)});e.queries.addItems(i)}else e.queries.addItems(r)})},r.prototype._retrieveData=function(){var e=this;return new Promise(function(t,r){return e.app.command(e.isFilterBuilder.get()?"_getAllSavedFilters":"_getAllSavedQueries").execute(t)})},r.prototype._isValidFilterLayer=function(e){if(e.serviceLayer instanceof esri.layers.FeatureLayer&&e.serviceLayer.url)return!0;if(e.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer){var t=e.serviceLayer;if(null===t.capabilities||-1!==t.capabilities.indexOf("Query"))return!0}return!1},r}(i.ViewModelBase);r.ListQueriesViewModel=s})},"Mapping/modules/QueryBuilder/SavedQueries/QueryActionsView":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();define(["require","exports","geocortex/infrastructure/menus/MenuView"],function(t,r,i){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var a={OPEN:"OPENQUERY",RENAME:"RENAMEQUERY",RUN:"RUNQUERY",DELETE:"DELETEQUERY"},n={OPEN:"OPENFILTER",RENAME:"RENAMEFILTER",RUN:"RUNFILTER",DELETE:"DELETEFILTER"},s=function(t){function r(e,r){return t.call(this,e,r)||this}return e(r,t),r.prototype.attach=function(e){t.prototype.attach.call(this,e),this.viewModel=e,this._registerCommandsAndEvents()},r.prototype.handleMenuItemClick=function(e,r,i){i.menuItem.id!==a.RENAME&&i.menuItem.id!==n.RENAME&&this.app.command("DeactivateView").execute(this.id),t.prototype.handleMenuItemClick.call(this,e,r,i)},r.prototype._registerCommandsAndEvents=function(){this.app.command(this.viewModel.isFilterBuilder.get()?"ShowFilterActions":"ShowQueryActions").register(this,this._executeShowQueryActions)},r.prototype._executeShowQueryActions=function(e){e&&(this.title.sync(e.displayName),this.viewModel.menuContext.set(e),this.app.command(this.viewModel.isFilterBuilder.get()?"RenameSavedFilter":"RenameSavedQuery").canExecute=function(){return!e.adminDefined},this.app.command(this.viewModel.isFilterBuilder.get()?"RenameSavedFilter":"RenameSavedQuery").raiseCanExecuteChanged(),this.app.command(this.viewModel.isFilterBuilder.get()?"RemoveSavedFilter":"RemoveSavedQuery").canExecute=function(){return!e.adminDefined},this.app.command(this.viewModel.isFilterBuilder.get()?"RemoveSavedFilter":"RemoveSavedQuery").raiseCanExecuteChanged(),this.app.command("ActivateView").execute(this.id))},r}(i.MenuView);r.QueryActionsView=s})},"Mapping/modules/QueryBuilder/SavedQueries/QueryActionsViewModel":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();define(["require","exports","geocortex/infrastructure/menus/MenuViewModel","geocortex/framework/observables"],function(t,r,i,a){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=function(t){function r(e,r){var i=t.call(this,e,r)||this;return i.isFilterBuilder=new a.Observable(!1),i.app=e,i.libraryId=r,i}return e(r,t),r.prototype.initialize=function(e){t.prototype.initialize.call(this,e),e.hasOwnProperty("mode")&&("filter"===e.mode?this.isFilterBuilder.set(!0):"query"===e.mode?this.isFilterBuilder.set(!1):this.app.trace.warning('Invalid configuration option for QueryActionsView "mode": '+e.mode+" given."))},r}(i.MenuViewModel);r.QueryActionsViewModel=n})},"Mapping/modules/QueryBuilder/SavedQueries/SaveQueryView":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();define(["require","exports","geocortex/framework/ui/ViewBase","geocortex/framework/utils/TimeDelayedOperation"],function(t,r,i,a){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=function(t){function r(e,r){var i=t.call(this,e,r)||this;return i._keyDownTimer=null,i._validationDelayMS=300,i}return e(r,t),r.prototype.attach=function(e){var r=this;t.prototype.attach.call(this,e),this.title.set(this.app.getResource(this.libraryId,this.viewModel.isFilterBuilder.get()?"language-querybuilder-save-filter-dialog-title":"language-querybuilder-save-query-dialog-title")),this._keyDownTimer=new a.TimeDelayedAction(this._validationDelayMS,function(){return r.viewModel.validateInput()},this),this._registerCommands()},r.prototype.activated=function(){t.prototype.activated.call(this)},r.prototype.deactivated=function(){t.prototype.deactivated.call(this),this.viewModel.reset()},r.prototype._registerCommands=function(){this.app.command(this.viewModel.isFilterBuilder.get()?"ShowSaveAsFilterDialog":"ShowSaveAsQueryDialog").register(this,this.show),this.app.command(this.viewModel.isFilterBuilder.get()?"ShowSaveFilterDialog":"ShowSaveQueryDialog").register(this,this.save)},r.prototype.handleKeyDown=function(e,t,r){return(e.which?e.which:e.keyCode)===dojo.keys.ENTER&&(this.saveAs(),e.preventDefault()),!0},r.prototype.handleInputChanged=function(e,t,r){this.viewModel.handleInputChanged(),this._keyDownTimer.reset()},r.prototype.handleCancelClick=function(e,t,r){this.app.viewManager.deactivateView(this)},r.prototype.handleSaveClick=function(e,t,r){this.saveAs()},r.prototype.saveAs=function(){var e=this,t=this.viewModel.name.get();this.viewModel.validateInput()&&this.viewModel.saveQuery(t,!0).then(function(r){r&&(e.viewModel.showConfirmationMessage(t),e.app.viewManager.deactivateView(e),e.app.command(e.viewModel.isFilterBuilder.get()?"DisplayFilter":"DisplayQuery").execute(e.viewModel.query))})},r.prototype.save=function(e){var t=this;this.viewModel.query=e;this.viewModel.saveQuery(e.displayName.get(),!1).then(function(r){r&&t.viewModel.showConfirmationMessage(e.displayName.get())})},r.prototype.show=function(e){this.viewModel.query=e,this.viewModel.name.set(e.displayName.get()||""),this.app.viewManager.activateView(this)},r}(i.ViewBase);r.SaveQueryView=n})},"Mapping/modules/QueryBuilder/SavedQueries/SaveQueryViewModel":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();define(["require","exports","geocortex/framework/ui/ViewModelBase","geocortex/framework/observables","geocortex/framework/utils/utils","./../QueryErrorHandling"],function(t,r,i,a,n,s){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var o=function(t){function r(){var e=null!==t&&t.apply(this,arguments)||this;return e.name=new a.Observable(""),e.inputErrorMessage=new a.Observable,e.query=null,e.isFilterBuilder=new a.Observable(!1),e._existingQuery=!1,e}return e(r,t),r.prototype.initialize=function(e){t.prototype.initialize.call(this,e),e.hasOwnProperty("mode")&&("filter"===e.mode?this.isFilterBuilder.set(!0):"query"===e.mode?this.isFilterBuilder.set(!1):this.app.trace.warning('Invalid configuration option for ListQueriesView "mode": '+e.mode+" given.")),this.app.command(this.isFilterBuilder.get()?"RenameSavedFilter":"RenameSavedQuery").register(this,this._executeRenameQuery)},r.prototype.saveQuery=function(e,t){var r=this;this._assertNameNotNull(e),e=e.trim();var i=this.queryExists(e);this._existingQuery=!!i;var a=Promise.resolve(!0);if(this._existingQuery){if(i.adminDefined){var n=new Error("Cannot overwrite administrator defined query");return n.adminDefined=!0,n.code=s.ERRCODES.UPDATEQUERYERROR,s.handleQueryErrors.call(this,this.isFilterBuilder.get(),n),Promise.resolve(!1)}t&&(a=this.confirmOverwrite(e))}return a.then(function(t){return r._existingQuery&&t?r.overwriteQuery(e):r._existingQuery?Promise.resolve(!1):r.createQuery(e)})},r.prototype.overwriteQuery=function(e){var t=this,r=function(e){var r=e;return r.adminDefined=!1,r.code=s.ERRCODES.UPDATEQUERYERROR,s.handleQueryErrors.call(t,t.isFilterBuilder.get(),r),!1};if(e===this.query.displayName.get()){var i=function(e){return new Promise(function(i,a){t.app.command(t.isFilterBuilder.get()?"_updateSavedFilterById":"_updateSavedQueryById").execute(e.id.get(),e,function(e){t.query=e,i(!0)},function(e){r(e),a(!1)})})};return this.query.getNewInstance().then(function(e){return i(e)},s.handleQueryErrors.bind(this))}return Promise.all([this.query.getNewInstance(!0),new Promise(function(r,i){return t.app.command(t.isFilterBuilder.get()?"_getSavedFilterByName":"_getSavedQueryByName").execute(e,r,i)})]).then(function(i){var a=i[0],n=i[1];return a.displayName.set(e),a.adminDefined=!1,new Promise(function(e,i){t.app.command(t.isFilterBuilder.get()?"_updateSavedFilterById":"_updateSavedQueryById").execute(n.id.get(),a,function(r){return t.query=r,e(!0)},function(e){return r(e),i(!1)})})}).catch(function(e){return s.handleQueryErrors.call(t,t.isFilterBuilder.get(),e),!1})},r.prototype.queryExists=function(e){var t;return this.app.command(this.isFilterBuilder.get()?"_getSavedFilterByName":"_getSavedQueryByName").execute(e,function(e){t=e},function(){t=null}),t},r.prototype.createQuery=function(e){var t=this;return new Promise(function(r,i){t.query.getNewInstance(!0).then(function(a){a.displayName.set(e),a.adminDefined=!1,t.app.command(t.isFilterBuilder.get()?"_addSavedFilter":"_addSavedQuery").execute(a,function(e){t.query=e,r(!0)},function(e){s.handleQueryErrors.call(t,t.isFilterBuilder.get(),e),i(e)})})})},r.prototype.confirmOverwrite=function(e){var t,r,i=this;return this.isFilterBuilder.get()?(t=this.app.getResource(this.libraryId,"language-querybuilder-savedfilters-overwrite-prompt").format(e),r=this.app.getResource(this.libraryId,"language-querybuilder-savedfilters-overwrite-prompt-title").format(e)):(t=this.app.getResource(this.libraryId,"language-querybuilder-savedqueries-overwrite-prompt").format(e),r=this.app.getResource(this.libraryId,"language-querybuilder-savedqueries-overwrite-prompt-title").format(e)),new Promise(function(e,a){return i.app.command("Confirm").execute(t,r,e)})},r.prototype.showConfirmationMessage=function(e){var t;t=this.isFilterBuilder.get()?this._existingQuery?"language-querybuilder-savedfilters-update-confirmation":"language-querybuilder-savedfilters-create-confirmation":this._existingQuery?"language-querybuilder-savedqueries-update-confirmation":"language-querybuilder-savedqueries-create-confirmation";var r=this.getResource(t).format(e);this.app.command(this.isFilterBuilder.get()?"AddFilterStatus":"AddQueryStatus").execute(r)},r.prototype._executeRenameQuery=function(e){var t,r=this;this.promptForQueryName(e).then(function(i){if(!n.isNullOrUndefined(i)){if(0===i.length){var a=new Error;return a.code=s.ERRCODES.NONAMEGIVENERROR,void s.handleQueryErrors.call(r,r.isFilterBuilder.get(),a)}if(t=i,r.queryExists(i)){var o=new Error;return o.code=s.ERRCODES.DUPLICATE,o.queryName=t,void s.handleQueryErrors.call(r,r.isFilterBuilder.get(),o)}return e.displayName.set(t),void r.app.command(r.isFilterBuilder.get()?"_updateSavedFilterById":"_updateSavedQueryById").execute(e.id.get(),e)}}).catch(function(e){r.app.trace.error(e.message,e)})},r.prototype.promptForQueryName=function(e){var t=this,r=this.getResource("language-querybuilder-rename-prompt-title"),i=this.getResource(this.isFilterBuilder.get()?"language-querybuilder-rename-filter-prompt":"language-querybuilder-rename-query-prompt"),a=e.displayName.get();return new Promise(function(e,n){return t.app.command("Prompt").execute(r,i,a,e)})},r.prototype._assertNameNotNull=function(e){if(n.isNullOrUndefined(e))throw new Error("The query name must be set.")},r.prototype.validateInput=function(){var e=this.name.get()?this.name.get().trim():"";if(String.isNullOrEmpty(e))return this.app.trace.error(this.getResource(this.isFilterBuilder.get()?"language-querybuilder-filter-error-name-required":"language-querybuilder-query-error-name-required")),!1;var t=this.queryExists(e);if(this._existingQuery=!!t,this._existingQuery){if(t.adminDefined){r="Cannot overwrite administrator defined query";return this.inputErrorMessage.set(r),this.app.trace.error(r),!1}var r=this.getResource(this.isFilterBuilder.get()?"language-querybuilder-filter-error-name-exists":"language-querybuilder-query-error-name-exists").format(e);return this.inputErrorMessage.set(r),this.app.trace.error(r),!1}return!0},r.prototype.handleInputChanged=function(){this.inputErrorMessage.get()&&this.name.get()&&!String.isNullOrEmpty(this.name.get().trim())&&this.inputErrorMessage.set("")},r.prototype.reset=function(){this.name.set(""),this.inputErrorMessage.set("")},r}(i.ViewModelBase);r.SaveQueryViewModel=o})},"url:/Mapping/modules/QueryBuilder/AutoCompleteView.html":t,"url:/Mapping/modules/QueryBuilder/SavedQueries/ListQueriesView.html":r,"url:/Mapping/modules/QueryBuilder/SavedQueries/QueryActionsView.html":i,"url:/Mapping/modules/QueryBuilder/SavedQueries/SaveQueryView.html":a,"url:/Mapping/modules/QueryBuilder/SimpleQueryBuilderView.html":n,"url:/Mapping/modules/QueryBuilder/Templates/QueryBuilderItem.html":s,"url:/Mapping/modules/QueryBuilder/Templates/QueryBuilderItemGroup.html":o,"url:/Mapping/modules/QueryBuilder/Templates/QueryBuilderRoot.html":l}}),require(["geocortex/framework/resourceManager"],function(e){e.resourceManager.register("Mapping","inv","Mapping/modules/QueryBuilder/CSS/common.css","css","LnF1ZXJ5LWdyb3VwLA0KLnF1ZXJ5LWdyb3VwIGxpLA0KLmFkZC1idXR0b25zIHsNCiAgICBwYWRkaW5nOiAwOw0KICAgIG1hcmdpbjogMDsNCiAgICBsaXN0LXN0eWxlOiBub25lOw0KfQ0KDQouc2ltcGxlLXF1ZXJ5LWJ1aWxkZXIgaHIgew0KICAgIG1hcmdpbjogMWVtIDAgMC41ZW07DQp9DQoNCi5zaW1wbGUtcXVlcnktYnVpbGRlciBzZWxlY3QsDQouc2ltcGxlLXF1ZXJ5LWJ1aWxkZXIgaW5wdXQgew0KICAgIGhlaWdodDogMmVtOw0KICAgIG1pbi13aWR0aDogMDsNCiAgICBwYWRkaW5nOiAwOw0KICAgIGZvbnQtd2VpZ2h0OiBub3JtYWw7DQp9DQoNCiAgICAuc2ltcGxlLXF1ZXJ5LWJ1aWxkZXIgaW5wdXQgew0KICAgICAgICBwYWRkaW5nOiAwIDAuM2VtOw0KICAgIH0NCg0KLmxvZ2ljYWwtb3BlcmF0b3JzIHsNCiAgICBtYXJnaW4tYm90dG9tOiAxZW07DQp9DQoNCi5sb2dpY2FsLW9wZXJhdG9yLXRvZ2dsZSB7DQogICAgZGlzcGxheTogYmxvY2s7DQp9DQoNCi50b3VjaCAubG9naWNhbC1vcGVyYXRvci10b2dnbGUgew0KICAgIG1hcmdpbi1ib3R0b206IDAuNWVtOw0KfQ0KDQoubG9naWNhbC1vcGVyYXRvci10b2dnbGUgLmxhYmVsIHsNCiAgICBmb250LXN0eWxlOiBpdGFsaWM7DQogICAgZm9udC1zaXplOiAwLjllbTsNCiAgICBtYXJnaW4tbGVmdDogMC4yNWVtOw0KfQ0KDQoubG9naWNhbC1vcGVyYXRvcnMgaW5wdXQgew0KICAgIGhlaWdodDogaW5pdGlhbDsNCiAgICB2ZXJ0aWNhbC1hbGlnbjogbWlkZGxlOw0KfQ0KDQouc2ltcGxlLXF1ZXJ5LWJ1aWxkZXIgLmhpZGRlbi1sYWJlbCB7DQogICAgaGVpZ2h0OiAwOw0KICAgIGRpc3BsYXk6IGJsb2NrOw0KICAgIHRleHQtaW5kZW50OiAtOTk5OWVtOw0KfQ0KDQoucXVlcnktcm93LWlucHV0IHsNCiAgICBkaXNwbGF5OiBpbmxpbmUtYmxvY2s7DQogICAgdmVydGljYWwtYWxpZ246IG1pZGRsZTsNCiAgICBtaW4td2lkdGg6IDA7DQogICAgd2lkdGg6IGNhbGMoMzMuMzMlIC0gNHB4KTsgLyotNHB4IHRvIGFjY291bnQgZm9yIGlubGluZS1ibG9jayBzcGFjaW5nKi8NCn0NCg0KLnF1ZXJ5LXJvdy1pbnB1dCAuZGF0ZS1waWNrZXIgLmZvcm0tbGFiZWwgew0KICAgIHBhZGRpbmc6IDA7DQp9DQoNCi5xdWVyeS1yb3ctZGVsZXRlIHsNCiAgICBiYWNrZ3JvdW5kLWltYWdlOiB1cmwoIlJlc291cmNlcy9JbWFnZXMvSWNvbnMvZGVsZXRlLTE2LnBuZyIpOw0KICAgIGJhY2tncm91bmQtcmVwZWF0OiBuby1yZXBlYXQ7DQogICAgYmFja2dyb3VuZC1wb3NpdGlvbjogY2VudGVyIGNlbnRlcjsNCiAgICB3aWR0aDogMS44NzVlbTsNCiAgICBoZWlnaHQ6IDEuODc1ZW07DQogICAgdmVydGljYWwtYWxpZ246IG1pZGRsZTsNCiAgICBwb3NpdGlvbjogYWJzb2x1dGU7DQogICAgdG9wOiAwOw0KICAgIHJpZ2h0OiAwOw0KfQ0KDQouY29uanVuY3Rpb24gew0KICAgIGRpc3BsYXk6IGJsb2NrOw0KICAgIHBhZGRpbmc6IDAuNWVtOw0KICAgIHRleHQtYWxpZ246Y2VudGVyOw0KICAgIG1hcmdpbi1ib3R0b206IC0xZW07DQogICAgei1pbmRleDogMTsNCiAgICBwb3NpdGlvbjogcmVsYXRpdmU7DQp9DQoNCi5jb25qdW5jdGlvbi10ZXh0IHsNCiAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOw0KICAgIGRpc3BsYXk6IGlubGluZS1ibG9jazsNCiAgICBwYWRkaW5nOiAwLjI1ZW0gMC43NWVtOw0KICAgIGZvbnQtc2l6ZTogMC44NWVtOw0KICAgIGJvcmRlcjogMXB4IHNvbGlkICNDQ0NDQ0M7DQogICAgYmFja2dyb3VuZDogI0RFRjJGRjsNCiAgICBjdXJzb3I6IGRlZmF1bHQ7DQogICAgdXNlci1zZWxlY3Q6IG5vbmU7DQogICAgdHJhbnNpdGlvbjogYm9yZGVyLXJhZGl1cyAwLjJzIGVhc2UtaW47DQp9DQoNCi5jb25qdW5jdGlvbi10ZXh0LmFuZCB7DQogICAgYm9yZGVyLXJhZGl1czogMC4xMjVyZW07DQp9DQoNCi5jb25qdW5jdGlvbi10ZXh0Lm9yIHsNCiAgICBib3JkZXItcmFkaXVzOiAycmVtOw0KfQ0KDQouc2ltcGxlLXF1ZXJ5LWJ1aWxkZXIgLnRleHQtYnV0dG9uIHsNCiAgICBjb2xvcjogIzFBNzJDNDsNCiAgICB0ZXh0LWRlY29yYXRpb246IHVuZGVybGluZTsNCn0NCg0KLnNpbXBsZS1xdWVyeS1idWlsZGVyIC5hZGQtYnV0dG9ucyB7DQogICAgbGlzdC1zdHlsZTogbm9uZTsNCiAgICBtYXJnaW4tdG9wOiAxZW07DQp9DQoNCi5zaW1wbGUtcXVlcnktYnVpbGRlciAuYWRkLWJ1dHRvbnMgbGkgew0KICAgIGRpc3BsYXk6IGlubGluZS1ibG9jazsNCiAgICB2ZXJ0aWNhbC1hbGlnbjogYm90dG9tOw0KICAgIG1hcmdpbi1yaWdodDogMC41ZW07DQp9DQoNCi5xdWVyeS1zdWJncm91cCB7DQogICAgYmFja2dyb3VuZDogI0VFRUVFRTsNCiAgICB3aWR0aDogY2FsYygxMDAlICsgMWVtKTsNCiAgICBwb3NpdGlvbjogcmVsYXRpdmU7DQogICAgcGFkZGluZzogMWVtIDAuNWVtOw0KICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7DQogICAgbGVmdDogLTAuNWVtOw0KICAgIGJveC1zaGFkb3c6IGluc2V0IDAuMTI1ZW0gMC4xMjVlbSAwLjVlbSAwICNDQ0NDQ0M7DQogICAgYm9yZGVyLXJhZGl1czogMC4xMjVyZW07DQogICAgYm9yZGVyOiAxcHggc29saWQgI0Q5RDlEOTsNCn0NCg0KLnF1ZXJ5LWJ1aWxkZXItZm9ybSB7DQogICAgcGFkZGluZzogMCAxZW0gMCAxZW07DQp9DQoNCi5xdWVyeS1pdGVtIHsNCiAgICBwb3NpdGlvbjogcmVsYXRpdmU7DQp9DQoNCi5xdWVyeS1pdGVtLWlucHV0cyB7DQogICAgZGlzcGxheTogYmxvY2s7DQogICAgcGFkZGluZy1yaWdodDogMi4xODhlbTsNCiAgICBtYXJnaW4tdG9wOiAxZW07DQp9DQoNCi5zaW1wbGUtcXVlcnktYnVpbGRlciAuZm9ybS1pdGVtIHsNCiAgICBtYXJnaW4tdG9wOiAwLjVlbTsNCiAgICBwYWRkaW5nOiAwOw0KfQ0KDQoubWFpbi1sZXZlbC1hZGQgew0KICAgIG1hcmdpbi10b3A6IDFlbTsNCn0NCg0KLnF1ZXJ5LXN1Ymdyb3VwICsgLmNvbmp1bmN0aW9uIHsNCiAgICBtYXJnaW4tdG9wOiAtMWVtOw0KfQ0KDQoucXVlcnktY29uZGl0aW9ucy1hcmVhIHsNCiAgICBtYXJnaW4tdG9wOiAwLjVlbTsNCn0NCg0KLmZpbmQtcmVzdWx0cyB7DQogICAgbWFyZ2luLWJvdHRvbTogMC41ZW07DQp9DQoNCi5saXN0LXF1ZXJpZXMtdmlldyAuZ2N4LWxpc3QtZGVzYyB7DQogICAgZm9udC1zdHlsZTogaXRhbGljOw0KICAgIGZvbnQtc2l6ZTogMC45ZW07DQp9DQoNCi5saXN0LXF1ZXJpZXMtdmlldyAucmVzdWx0cy1saXN0IHsNCiAgICBib3R0b206IDUuMjVlbTsNCn0NCg0KLmxpc3QtcXVlcmllcy12aWV3IC5oYXMtcGFnZXMgew0KICAgIGhlaWdodDogNS4yNWVtOw0KfQ0KDQouc2ltcGxlLXF1ZXJ5LWJ1aWxkZXIgLmluZm8tbWVzc2FnZSB7DQogICAgbWFyZ2luLXRvcDogMWVtOw0KfQ=="),e.resourceManager.register("Mapping","inv","Mapping/modules/QueryBuilder/CSS/small.css","css","LnNpbXBsZS1xdWVyeS1idWlsZGVyIC51aS1hdXRvY29tcGxldGUgew0KICAgIG1heC13aWR0aDogMjU1cHghaW1wb3J0YW50Ow0KfQ=="),e.resourceManager.register("Mapping","inv","Mapping/modules/QueryBuilder/AutoCompleteView.html","html",t),e.resourceManager.register("Mapping","inv","Mapping/modules/QueryBuilder/SavedQueries/ListQueriesView.html","html",r),e.resourceManager.register("Mapping","inv","Mapping/modules/QueryBuilder/SavedQueries/QueryActionsView.html","html",i),e.resourceManager.register("Mapping","inv","Mapping/modules/QueryBuilder/SavedQueries/SaveQueryView.html","html",a),e.resourceManager.register("Mapping","inv","Mapping/modules/QueryBuilder/SimpleQueryBuilderView.html","html",n),e.resourceManager.register("Mapping","inv","Mapping/modules/QueryBuilder/Templates/QueryBuilderItem.html","html",s),e.resourceManager.register("Mapping","inv","Mapping/modules/QueryBuilder/Templates/QueryBuilderItemGroup.html","html",o),e.resourceManager.register("Mapping","inv","Mapping/modules/QueryBuilder/Templates/QueryBuilderRoot.html","html",l)}),require({cache:{}}),define(["Mapping/modules/QueryBuilder/AutoCompleteView","Mapping/modules/QueryBuilder/AutoCompleteViewModel","Mapping/modules/QueryBuilder/Formatters","Mapping/modules/QueryBuilder/Query","Mapping/modules/QueryBuilder/QueryBuilderModule","Mapping/modules/QueryBuilder/QueryClause","Mapping/modules/QueryBuilder/QueryOperator","Mapping/modules/QueryBuilder/QueryOperatorDescription","Mapping/modules/QueryBuilder/SimpleQueryBuilderView","Mapping/modules/QueryBuilder/SimpleQueryBuilderViewModel"],function(t,r,i,a,n,s,o,l,u,d){e(t,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.AutoCompleteView",t.AutoCompleteView),e(r,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.AutoCompleteViewModel",r.AutoCompleteViewModel),e(i,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.QueryFormatterFactory",i.QueryFormatterFactory),e(i,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.QueryFormatter",i.QueryFormatter),e(i,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.Db2QueryFormatter",i.Db2QueryFormatter),e(i,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.FileGdbQueryFormatter",i.FileGdbQueryFormatter),e(i,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.InformixQueryFormatter",i.InformixQueryFormatter),e(i,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.MsAccessQueryFormatter",i.MsAccessQueryFormatter),e(i,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.OracleQueryFormatter",i.OracleQueryFormatter),e(i,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.PostgreSqlQueryFormatter",i.PostgreSqlQueryFormatter),e(i,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.ShapefileQueryFormatter",i.ShapefileQueryFormatter),e(i,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.SqlServerQueryFormatter",i.SqlServerQueryFormatter),e(i,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.GeocortexOwsQueryFormatter",i.GeocortexOwsQueryFormatter),e(a,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.Query",a.Query),e(n,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.QueryBuilderModule",n.QueryBuilderModule),e(s,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.QueryClause",s.QueryClause),e(o,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.QueryOperator",o.QueryOperator),e(l,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.QueryOperatorDescription",l.QueryOperatorDescription),e(u,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.SimpleQueryBuilderView",u.SimpleQueryBuilderView),e(d,"geocortex.essentialsHtmlViewer.mapping.modules.queryBuilder.SimpleQueryBuilderViewModel",d.SimpleQueryBuilderViewModel)})}();