!function(){function e(e,t,a){if("string"==typeof e&&(a=t,t=e),void 0!==a)for(var i=t.split("."),n=null,o=window,r=0,s=i.length;r<s;r++)n=i[r],r==s-1?o[n]=a:o[n]||(o[n]={}),o=o[n];else console.warn("Undefined shim for: "+t)}var t="<div class='attach-photo'>    <div class='panel-content' data-binding='{@hidden: browserFileAPISupported}'>        <p class='heading'><span data-binding='{@text: @language-native-image-select-heading}'></span></p>        <p><button class='btn' href='javascript:void(0)' data-binding='{@event-onclick: handleTakeNativePhotoCamera}{@text: @language-native-photo-from-camera}'></button></p>        <p><button class='btn' href='javascript:void(0)' data-binding='{@event-onclick: handleTakeNativePhotoGallery}{@text: @language-native-photo-from-gallery}'></button></p>    </div>    <div class='panel-content' data-binding='{@visible: browserFileAPISupported}'>        <p class='heading'><span data-binding='{@text: @language-native-file-select-heading}'></span></p>        <form data-binding='{@var: uploadFormElement}'>            <input type='file' class='inp' data-binding='{@event-onchange: handleSelectedFileInput}' />        </form>        <p class='loading'><span data-binding='{@visible: isUploading}{@text: @language-native-file-uploading}'></span></p>    </div></div>",a="<div style='padding: 0px 10px 10px 10px;'>    <div style='margin-top: 10px;'>        <label>Name: </label><input type='text' data-binding='{@var: nameInput}' value='Jeff' />    </div>    <div style='margin-top: 10px;'>        <button class='native-test-button' data-binding='{@event-onclick: sayHello_Click}'>Say Hello</button>    </div>    <div style='margin-top: 10px;'>        <label>Iterations: </label><input type='text' data-binding='{@var: iterationsInput}' value='10' />        <label>Duration (ms): </label><input type='text' data-binding='{@var: iterationDurationInput}' value='500' />    </div>    <div style='margin-top: 10px;'>        <button class='native-test-button' data-binding='{@event-onclick: workerJob_Click}'>Start Iterations</button>        <button class='native-test-button' data-binding='{@event-onclick: workerJobCancel_Click}'>Cancel</button>    </div>    <div style='margin-top: 10px;'>        <label>URL: </label><input type='text' data-binding='{@var: downloadInput}' value='http://jsiemens-pc2.latitudegeo.com/tpks/ImageryTPK.tpk' />    </div>    <div style='margin-top: 10px;'>        <button class='native-test-button' data-binding='{@event-onclick: download_Click}'>Download</button>        <button class='native-test-button' data-binding='{@event-onclick: downloadCancel_Click}'>Cancel</button>    </div>    <div style='margin-top: 10px;'>        <textarea data-binding='{@var: output}' rows='8' style='height: 400px;'></textarea>    </div></div>";require({cache:{"Mapping/modules/Native/AttachFileView":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var a in t)t.hasOwnProperty(a)&&(e[a]=t[a])};return function(t,a){function i(){this.constructor=t}e(t,a),t.prototype=null===a?Object.create(a):(i.prototype=a.prototype,new i)}}();define(["require","exports","geocortex/framework/ui/ViewBase"],function(t,a,i){"use strict";Object.defineProperty(a,"__esModule",{value:!0});var n=function(t){function a(){return null!==t&&t.apply(this,arguments)||this}return e(a,t),a.prototype.handleTakeNativePhotoCamera=function(e,t,a){this.viewModel._handlePhotoFromNativeApp(!0)},a.prototype.handleTakeNativePhotoGallery=function(e,t,a){this.viewModel._handlePhotoFromNativeApp(!1)},a.prototype.handleSelectedFileInput=function(e,t,a){var i=e.currentTarget.files[0];this.viewModel._handleFileFromBrowser(i)},a.prototype.clearFileInputField=function(){this.uploadFormElement.reset()},a}(i.ViewBase);a.AttachFileView=n})},"Mapping/modules/Native/AttachFileViewModel":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var a in t)t.hasOwnProperty(a)&&(e[a]=t[a])};return function(t,a){function i(){this.constructor=t}e(t,a),t.prototype=null===a?Object.create(a):(i.prototype=a.prototype,new i)}}();define(["require","exports","geocortex/framework/ui/ViewModelBase","geocortex/framework/observables","geocortex/infrastructure/MapUtils"],function(t,a,i,n,o){"use strict";Object.defineProperty(a,"__esModule",{value:!0});var r=function(t){function a(e,a){var i=t.call(this,e,a)||this;return i.feature=new n.Observable(null),i.esriFeature=new n.Observable(null),i.esriFeatureLayer=new n.Observable(null),i.isUploading=new n.Observable(!1),i._attachFileViewId=null,i._canEditOffline=!1,i.browserFileAPISupported=new n.Observable(i._fileApiSupported()),i.app.command("AttachFileToFeature").register(i,i._executeAttachFile,i._canExecuteAttachFile),i}return e(a,t),a.prototype.initialize=function(e){var a=this;t.prototype.initialize.call(this,e),this._attachFileViewId=e.attachFileViewId,this.app.nativeManager.hasNativeCapability("editing").then(function(e){a._canEditOffline=e})},a.prototype._fileApiSupported=function(){return this._isFileInputSupported()&&window.File&&window.FileReader},a.prototype._handleFileFromBrowser=function(e){var t=this;this.isUploading.set(!0);var a=new FileReader;a.onload=function(a){var i={data:decodeURIComponent(a.target.result.substring(a.target.result.indexOf("base64,")+7)),fileName:e.name,fileType:e.type};t._handleReceiveFileData(i,function(e){t._handleCallback.call(t,e)})},a.readAsDataURL(e)},a.prototype._handlePhotoFromNativeApp=function(e){var t=this;if(navigator.camera){var a=void 0!==window.Camera&&window.Camera.DestinationType?window.Camera.DestinationType.DATA_URL:1,i=e?window.Camera.PictureSourceType.CAMERA:window.Camera.PictureSourceType.PHOTOLIBRARY;navigator.camera.getPicture(function(e){setTimeout(function(){var a={data:e};t._handleReceiveFileData(a,function(e){t._handleCallback.call(t,e)})},0)},function(e){},{quality:60,sourceType:i,destinationType:a,correctOrientation:!0})}else this._reportStatus("language-native-no-photo-no-camera-detected")},a.prototype._handleReceiveFileData=function(e,t){this.feature.get()&&this.feature.get().esriFeature.get()&&this.feature.get().esriFeature.get().getLayer()&&this.feature.get().esriFeature.get().getLayer()instanceof esri.layers.FeatureLayer&&this.feature.get().esriFeature.get().getLayer().isEditable()&&this.feature.get().esriFeature.get().getLayer().hasAttachments||this._resolveFeature(this.feature.get());var a=this.esriFeature.get(),i=this.esriFeatureLayer.get();if(this.esriFeature.get()&&this.esriFeatureLayer.get()){var n=null;if(i&&i.url?n=i.url:i._essentialsMetadata&&(n=i._essentialsMetadata.serviceUrl),n){var o={feature:a,layer:i,featureUrl:n,filename:this._formatAttachmentName(e.fileName),contentType:e.fileType||"image/jpeg",payload:e.data,callback:t};this.app.command("CreateAttachment").execute(o)}else this._reportStatus("language-native-feature-no-layer-url")}else this._reportStatus("language-native-feature-no-layer")},a.prototype._formatAttachmentName=function(e){var t=new Date,a=e?e.substr(0,e.lastIndexOf(".")):"image",i=e?e.substr(e.lastIndexOf(".")+1):"jpg";return"{0}-{1}.{2}.{3}-{4}-{5}-{6}.{7}".format(a,t.getHours(),t.getMinutes(),t.getSeconds(),t.getDate(),t.getMonth()+1,t.getFullYear(),i)},a.prototype._handleCallback=function(e){var t={};try{t=JSON.parse(e.currentTarget.response).error}catch(a){e.currentTarget&&e.currentTarget.statusText?t.message=e.currentTarget.statusText:t.message=this.app.getResource(this.libraryId,"language-native-internal-server-error")}t&&t.message?this._reportStatus("language-native-file-upload-failed",t.message):(this._reportStatus("language-native-file-upload-success"),this.app.event("FeatureAttachmentAddedEvent").publish(this.feature.get()))},a.prototype._executeAttachFile=function(e){this._resolveFeature(e),this.app.command("HideFeatureTemplatePicker").execute(),this.esriFeature.get()&&this.esriFeatureLayer.get()?this.app.command("ActivateView").execute(this._attachFileViewId):this._reportStatus("language-native-feature-no-layer")},a.prototype._canExecuteAttachFile=function(e){if(e&&(this._resolveFeature(e,!1),this.esriFeature.get()&&this.esriFeatureLayer.get())){var t=this.esriFeatureLayer.get(),a=this.app.site.essentialsMap.mapServices.filter(function(e){return e.serviceLayer===t})[0];if(a&&a.canAddAttachments){if(this.app.isOffline.get()){if(!this._canEditOffline)return!1;if(parseFloat(a.serverVersion)>=10.4)return!0;if(!this.app.offlineManager.syncInfo.findLayerOrTable(a.serviceLayer.url).canAddAttachments)return!1}if(this.browserFileAPISupported.get())return!0}}return!1},a.prototype._resolveFeature=function(e,t){void 0===t&&(t=!0);var a=null;if(e.esriFeature){var i=e.esriFeature.get();i.getLayer()||e.layer&&e.layer.mapService&&e.layer.mapService.serviceLayer&&(i._graphicsLayer=e.layer.mapService.serviceLayer),a=e.layer||e.featureLayer&&"Table"!=e.featureLayer.type?o.findFeatureInMap(i,this.app.site):e.esriFeature.get()}if(!a)return this.feature.set(null),this.esriFeature.set(null),void this.esriFeatureLayer.set(null);t&&e.esriFeature.set(a),this.feature.set(e),this.esriFeature.set(a);var n=a.getLayer();n&&n.id&&-1!==n.id.indexOf("-explodedClusterLayer")&&(n=this.app.map.getLayer(n.id.replace("-explodedClusterLayer",""))),n&&n.isEditable&&n.isEditable()?this.esriFeatureLayer.set(n):this.esriFeatureLayer.set(null)},a.prototype._reportStatus=function(e,t){var a=this;this.isUploading.set(!1);var i=this.app.getResource(this.libraryId,e);i=t?i+t:i,this.app.command("Alert").execute(i,null,function(){var e=a.app.viewManager.getViewById(a._attachFileViewId);e&&e.isActive&&(e.clearFileInputField(),a.app.command("DeactivateView").execute(a._attachFileViewId))})},a.prototype._isFileInputSupported=function(){if(navigator.userAgent.match(/(Android (1.0|1.1|1.5|1.6|2.0|2.1))|(Windows Phone (OS 7|8.0))|(XBLWP)|(ZuneWP)|(w(eb)?OSBrowser)|(webOS)|(Kindle\/(1.0|2.0|2.5|3.0))/))return!1;var e=document.createElement("input");return e.type="file",!e.disabled},a}(i.ViewModelBase);a.AttachFileViewModel=r})},"Mapping/modules/Native/NativeGeolocationClient":function(){define(["require","exports","geocortex/infrastructure/Dictionary","geocortex/infrastructure/CancellationTokenSource"],function(e,t,a,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e){this.app=e,this._watchId=-1,this._cancellationTokenLookup=new a.Dictionary}return e.prototype.implementGeolocation=function(){(this.app.nativeManager.isWindowsNative()||this.app.nativeManager.isIosNative())&&(navigator.geolocation.getCurrentPosition=this.getCurrentPosition.bind(this),navigator.geolocation.watchPosition=this.watchPosition.bind(this),navigator.geolocation.clearWatch=this.clearWatch.bind(this))},e.prototype.getCurrentPosition=function(e,t,a){var i;a.timeout>0&&a.timeout<Number.POSITIVE_INFINITY&&(i=setTimeout(function(){t&&t({code:3,message:"timeout",PERMISSION_DENIED:1,POSITION_UNAVAILABLE:2,TIMEOUT:3})},Math.min(a.timeout,2147483647))),this.app.nativeManager.message("GetCurrentPosition",{options:a}).then(function(t){clearTimeout(i),e&&e(t)}).catch(function(e){clearTimeout(i),t&&t(e)})},e.prototype.watchPosition=function(e,t,a){var n=new i.CancellationTokenSource;this._watchId++,this._cancellationTokenLookup.set(this._watchId+"",n);var o;return a.timeout>0&&a.timeout<Number.POSITIVE_INFINITY&&(o=setTimeout(function(){n.cancel(),t&&t({code:3,message:"timeout",PERMISSION_DENIED:1,POSITION_UNAVAILABLE:2,TIMEOUT:3})},Math.min(a.timeout,2147483647))),this.app.nativeManager.message("WatchPosition",a,n.token(),function(t){clearTimeout(o),e&&e(t.details)}).catch(function(e){clearTimeout(o),t&&t(e)}),this._watchId},e.prototype.clearWatch=function(e){var t=this._cancellationTokenLookup.get(e+"");t&&t.cancel()},e}();t.NativeGeolocationClient=n})},"Mapping/modules/Native/NativeMessageTesterView":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var a in t)t.hasOwnProperty(a)&&(e[a]=t[a])};return function(t,a){function i(){this.constructor=t}e(t,a),t.prototype=null===a?Object.create(a):(i.prototype=a.prototype,new i)}}();define(["require","exports","geocortex/framework/ui/ViewBase","geocortex/infrastructure/CancellationTokenSource"],function(t,a,i,n){"use strict";Object.defineProperty(a,"__esModule",{value:!0});var o=function(t){function a(e,a){return t.call(this,e,a)||this}return e(a,t),a.prototype.sayHello_Click=function(){var e=this;this.output.textContent="Sending message...\n",this.app.nativeManager.message("MessageTest_Hello",{name:this.nameInput.value}).then(function(t){e.output.textContent+="Promise resolved: "+t.hello+"\n"}).catch(function(t){e.output.textContent+="Error: "+t.message+"\n"})},a.prototype.workerJob_Click=function(){var e=this;this._workerJobCancellation=new n.CancellationTokenSource,this.output.textContent="Sending message...\n",this.app.nativeManager.message("MessageTest_Worker",{iterations:this.iterationsInput.value,durationPerIteration:this.iterationDurationInput.value},this._workerJobCancellation.token(),function(t){e.output.textContent+=t.status+": "+t.details.message+"\n"}).then(function(t){e.output.textContent+="Promise resolved."}).catch(function(t){"OperationCanceled"==t.name?e.output.textContent+="Canceled.\n":e.output.textContent+="Error: "+t.message+"\n"})},a.prototype.workerJobCancel_Click=function(){this._workerJobCancellation&&this._workerJobCancellation.cancel()},a.prototype.download_Click=function(){var e=this;this._downloadCancellation=new n.CancellationTokenSource,this.output.textContent="Sending message...\n",this.app.nativeManager.message("DownloadResource",{url:this.downloadInput.value},this._downloadCancellation.token(),function(t){e.output.textContent+=t.status+": "+t.details.status+". "+t.details.message+". Bytes downloaded: "+t.details.bytesDownloaded+"\n"}).then(function(t){e.output.textContent+="Promise resolved."}).error(function(t){e.output.textContent+="Error: "+t.message+"\n"})},a.prototype.downloadCancel_Click=function(){this._downloadCancellation&&this._downloadCancellation.cancel()},a}(i.ViewBase);a.NativeMessageTesterView=o})},"Mapping/modules/Native/NativeModule":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var a in t)t.hasOwnProperty(a)&&(e[a]=t[a])};return function(t,a){function i(){this.constructor=t}e(t,a),t.prototype=null===a?Object.create(a):(i.prototype=a.prototype,new i)}}();define(["require","exports","geocortex/framework/application/ModuleBase","geocortex/infrastructure/commandArgs/AddStatusArgs","./NativeGeolocationClient"],function(t,a,i,n,o){"use strict";Object.defineProperty(a,"__esModule",{value:!0});var r=function(t){function a(){var e=null!==t&&t.apply(this,arguments)||this;return e.nativeInitialized=!1,e}return e(a,t),a.prototype.initialize=function(e){var t=this;this.app.nativeManager.subscribe("NativeMessageEvent",function(e){var a=t._parseNativeMessage(e);t.handleNativeEvent(a)}),this.app.command("NativeHasCapability").register(this,function(e,a){t.app.nativeManager.hasNativeCapability(e).then(function(e){a.apply(t,[e])})}),this.app.event("NativeMessageEvent").subscribe(this,this._onNativeMessageEvent),dojo.subscribe("SiteSignInRequired",function(e){t.app.nativeManager.isNative()?t.app.nativeManager.message("InformGmafOfSignInRequirement",{errorCode:e.error,url:t.app.site.url}).finally(e.callback):e.callback()}),new o.NativeGeolocationClient(this.app).implementGeolocation(),this.app.nativeManager.isNative()&&dojo.xhrPost({url:"http://127.0.0.1:8181/message/NativeModuleLoaded",method:"POST",postData:"{}"})},a.prototype._parseNativeMessage=function(e){return"NativeMessageEvent"!==e.type?e:e.parameters},a.prototype._onNativeMessageEvent=function(e){var t;if(this.app.trace.debug("Received native event message: "+JSON.stringify(e)),"native ready"===e.type)this.app.localServerAddress=e.parameters.localServerAddress,this.app.localServerNamespace=e.parameters.localServerNamespace,this.app.localServerToken=e.parameters.localServerToken,this.app.trace.info("Native initialization complete.  Geocortex Mobile Application Framework version: {0}  Local Server Address: {1}  Locale: {2}".format(e.parameters.version,e.parameters.localServerAddress,e.parameters.locale)),this.app.isNative.set(!0),this.nativeInitialized=!0,this.app.nativeManager.signalNativeInitialized();else if("download"===e.type){var a=e.parameters;(t=new n.AddStatusArgs(null)).timeoutMS=1e4,t.id="native-download-status","Downloading"===a.state?(t.text=this.getResource("language-native-download-downloading").format(a.fileName,a.progress),this.app.command("AddStatus").execute(t)):"Completed"===a.state?(t.text=this.getResource("language-native-download-complete").format(a.fileName),this.app.command("AddStatus").execute(t)):"Failed"===a.state&&(t.text=this.getResource("language-native-download-failed").format(a.fileName),this.app.command("AddStatus").execute(t)),this.app.command("ActivateView").execute(t.id)}else"low memory"===e.type?((t=new n.AddStatusArgs(this.getResource("language-native-low-memory"))).timeoutMS=3e4,t.id="native-low-memory-status",this.app.command("AddStatus").execute(t),this.app.command("ActivateView").execute(t.id)):"license information"===e.type&&this.app.trace.info("ArcGIS License Level: {0}. Expiry: {1}".format(e.parameters.level,e.parameters.expiry))},a.prototype.handleNativeEvent=function(e){this.app.event("NativeMessageEvent").publish(e)},a}(i.ModuleBase);a.NativeIntegrationModule=r})},"url:/Mapping/modules/Native/AttachFileView.html":t,"url:/Mapping/modules/Native/NativeMessageTesterView.html":a}}),require(["geocortex/framework/resourceManager"],function(e){e.resourceManager.register("Mapping","inv","Mapping/modules/Native/CSS/common.css","css","DQoucGFuZWwtY29udGVudCB7DQogICAgdGV4dC1hbGlnbjogY2VudGVyOw0KfQ0KDQouYnRuIHsNCiAgICB3aWR0aDogMjAwcHg7DQogICAgbWFyZ2luLXRvcDogMzJweDsNCn0NCg0KLmlucCB7DQogICAgd2lkdGg6IDIwMHB4Ow0KICAgIG1hcmdpbi10b3A6IDMycHg7DQp9DQoNCi5sb2FkaW5nIHsNCiAgICBtYXJnaW4tdG9wOiAyMHB4Ow0KICAgIHRleHQtYWxpZ246IGNlbnRlcjsNCiAgICBjb2xvcjogI0ZGMDAwMDsNCn0NCg0KLmhlYWRpbmcgew0KICAgIG1hcmdpbi10b3A6IDMycHg7DQogICAgZm9udC1zaXplOiAxLjFlbTsNCiAgICBmb250LXdlaWdodDogNjAwOw0KfQ0KDQoubmF0aXZlLXRlc3QtYnV0dG9uIHsNCiAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjRkY1MjUyOw0KICAgIGNvbG9yOiB3aGl0ZTsNCiAgICBwYWRkaW5nOiA1cHg7DQogICAgZm9udC1zaXplOiAxMnB0Ow0KICAgIGJvcmRlci1yYWRpdXM6IDVweDsNCiAgICBtYXJnaW4tcmlnaHQ6IDVweDsNCn0="),e.resourceManager.register("Mapping","inv","Mapping/modules/Native/AttachFileView.html","html",t),e.resourceManager.register("Mapping","inv","Mapping/modules/Native/NativeMessageTesterView.html","html",a)}),require({cache:{}}),define(["Mapping/modules/Native/AttachFileView","Mapping/modules/Native/AttachFileViewModel","Mapping/modules/Native/NativeMessageTesterView","Mapping/modules/Native/NativeModule"],function(t,a,i,n){e(t,"geocortex.essentialsHtmlViewer.mapping.modules.nativeIntegration.AttachFileView",t.AttachFileView),e(a,"geocortex.essentialsHtmlViewer.mapping.modules.nativeIntegration.AttachFileViewModel",a.AttachFileViewModel),e(i,"geocortex.essentialsHtmlViewer.mapping.modules.nativeIntegration.NativeMessageTesterView",i.NativeMessageTesterView),e(n,"geocortex.essentialsHtmlViewer.mapping.modules.nativeIntegration.NativeIntegrationModule",n.NativeIntegrationModule)})}();