function shim(e,t,r){if("string"==typeof e&&(r=t,t=e),"undefined"==typeof r)return void console.warn("Undefined shim for: "+t);for(var a=t.split("."),n=null,i=window,s=0,o=a.length;s<o;s++)n=a[s],s==o-1?i[n]=r:i[n]||(i[n]={}),i=i[n]}require({cache:{"Mapping/modules/Measurement/HighlightedMeasurementLabel":function(){define(["require","exports","geocortex/infrastructure/highlightedLabel/HighlightedLabelGraphic"],function(e,t,r){"use strict";var a=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._addedGraphicsToMapLayer=[],t}return __extends(t,e),t.prototype.addToMapGraphicLayer=function(e){var t=this;void 0===e&&(e=!1),e&&(this._addedGraphicsToMapLayer=[]),this._addedGraphicsToMapLayer.push(this.app.map.graphics.add(this.highlightGraphic)),this.highlightIdTagGraphic&&this._addedGraphicsToMapLayer.push(this.app.map.graphics.add(this.highlightIdTagGraphic)),this.textGraphics.forEach(function(e){t._addedGraphicsToMapLayer.push(t.app.map.graphics.add(e))}),this.show()},t.prototype.getMapGraphics=function(){return this._addedGraphicsToMapLayer},t.prototype.addToMeasurementLayer=function(t){void 0===t&&(t=!0),e.prototype.addToLayer.call(this,t)},t.prototype.hide=function(){return e.prototype.hide.call(this),this._addedGraphicsToMapLayer.forEach(function(e){e.hide()}),this},t.prototype.show=function(){return e.prototype.show.call(this),this._addedGraphicsToMapLayer.forEach(function(e){e.show()}),this},t.prototype.assignMeasurementId=function(t){e.prototype.assignGraphicIdentifierKey.call(this,"measurementId",t)},t}(r.HighlightedLabelGraphic);t.HighlightedMeasurementLabel=a})},"Mapping/modules/Measurement/MeasurementMarkupManager":function(){define(["require","exports","./Descriptors/GeometryDescriptor","geocortex/framework/observables","geocortex/infrastructure/coordinates/AngleFormat","geocortex/infrastructure/coordinates/AngleDirectionSystem","./MeasurementModule","./Descriptors/LineSegmentDescriptor","geocortex/infrastructure/FormatUtils","geocortex/infrastructure/NumberFormat","./Descriptors/DescriptorBase","geocortex/infrastructure/FeatureSetCollection","geocortex/infrastructure/GraphicsLayerUtils","./MeasurementUtils","geocortex/infrastructure/tools/DrawMode"],function(e,t,r,a,n,i,s,o,u,m,l,p,c,h,g){"use strict";var d=function(){function e(e,t,r){var s=this;this.GCX_UNIT_YARDS=12345,this.GCX_UNIT_SQ_NAUTICAL_MILES="gcXSqNauticalMileConstant",this.geometryIdCounter=1,this.descriptorContainer=[],this.markupLayerId=null,this.measurementLayerId=null,this.unit={feet:null,yard:null,meter:null,kilometer:null,mile:null,nauticalMile:null,sqFeet:null,sqYard:null,sqMeter:null,sqKilometer:null,sqMile:null,sqNauticalMile:null,acre:null,hectare:null},this.measurementResultTypes=[],this.coordinateFractionalDigits=4,this.measurementFractionalDigits=2,this.degreeFormat=n.DD,this.angleDirectionSystem=i.POLAR,this.addedMapGraphics=[],this._zoomEndToken=null,this._predictiveMeasurementToken=null,this._delayedExecuteToken=null,this._mapOutToken=null,this._measurementInProgressToken=null,this._predictiveMeasurementsGraphic=null,this._measurementModule=null,this._predictiveMeasurementCount=null,this._lengthUnit=null,this._areaUnit=null,this._lengthUnitString=null,this._areaUnitString=null,this._currentLineSegmentInProcess=null,this._currentGeometryInProcess=null,this._measurementLayersCreated=null,this._toolActive=!1,this._predictiveMeasurementTextColor=null,this._predictiveMeasurementHighlightColor=null,this._predictiveMeasurementOutlineColor=null,this._predictiveMeasurementOutlineWidth=null,this._predictiveMeasurementHighlightRadius=null,this._predictiveMeasurementTextSize=null,this._featureWhichIsBeingDeleted=null,this.app=t,this.libraryId=r,this._measurementModule=e,this._predictiveMeasurementCount=0,this._measurementLayersCreated=!1,this.measurementInProgress=new a.Observable((!1)),this.descriptorContainerEmpty=new a.Observable((!0)),this._getUnitLanguageResources(),this._subscribeEvents(),this.descriptorContainerEmpty.bind(this,function(e){e&&s._zoomEndToken?(s._zoomEndToken.remove(),s._zoomEndToken=null,s.app.command("ClearMarkup").raiseCanExecuteChanged()):e||s._zoomEndToken||(s._zoomEndToken=s.app.map.on("zoom-end",dojo.hitch(s,s.refreshLabels)))})}return e.prototype._subscribeEvents=function(){this.app.event("MarkupEditingStartedEvent").subscribe(this,this._processMarkupEditingStarted),this.app.event("MarkupEditingStoppedEvent").subscribe(this,this._processMarkupEditingStopped),this.app.event("MarkupDeletedEvent").subscribe(this,this._processMarkupDeleted),this.app.event("MarkupClearedEvent").subscribe(this,this.destroyAllDescriptors),this.app.event("_deleteClickableFeatureStarted").subscribe(this,this._handleDeleteClickableFeatureStarted),this.app.event("GraphicRemovedEvent").subscribe(this,this._handleGraphicRemoved)},e.prototype.formatMeasurement=function(e,t){return void 0===t&&(t=2),null==e||"number"!=typeof e?"":u.formatNumber(e,m.NumberFormat.NUMBER,{fractionalDigits:t})},e.prototype.measurementCompleted=function(){var e=this;this.addedMapGraphics.forEach(function(t){t.getMapGraphics().forEach(function(t){e.app.map.graphics.remove(t)})}),this.addedMapGraphics.forEach(function(e){e.addToMeasurementLayer(e.isVisible())})},e.prototype.createDescriptor=function(e,t){var a=null;switch(e){case l.DescriptorType.LINE_SEGMENT:a=new o.LineSegmentDescriptor(t,this.app),this._currentLineSegmentInProcess=a;break;case l.DescriptorType.POLYLINE:case l.DescriptorType.POLYGON:a=new r.GeometryDescriptor(this.geometryIdCounter.toString(),e,t,this.app),this.descriptorContainer.push(a),this.geometryIdCounter++,this._currentGeometryInProcess=a;break;default:this._reportStatus("MeasurementMarkupManager: Invalid Descriptor type","error",!1)}return this.descriptorContainerEmpty.set(!1),a},e.prototype.destroyDescriptor=function(e,t,r){var a=this;void 0===t&&(t=!1),void 0===r&&(r=!0);for(var n=0;n<this.descriptorContainer.length;n++)if(t||this.descriptorContainer[n].id===e){var i=this.descriptorContainer[n];i.setInactive();for(var s=0;s<i._lineSegments.length;s++){var o=i._lineSegments[s];this._removeGraphicFromLayer(o.graphic),this._removeHighlightedLabelFromLayer(o.highlightedLabelGraphic)}if((t||!t&&r)&&this._removeGraphicFromLayer(i.graphic),i.highlightedLabelGraphic&&(this._removeGraphicFromLayer(i.highlightedLabelGraphic.highlightGraphic),i.highlightedLabelGraphic.textGraphics.forEach(function(e){a._removeGraphicFromLayer(e)}),this._removeHighlightedLabelFromLayer(i.highlightedLabelGraphic)),i.measurementData){var u=this.app.featureSetManager.getCollectionById("Measurement");u&&u.featureSets.removeItem(i.measurementData)}if(this._currentGeometryInProcess&&this._currentGeometryInProcess.id===i.id&&(this._currentGeometryInProcess=null),this.app.event("MeasurementMarkupDeleted").publish({graphic:i.graphic,measurementDescriptor:i}),!t){this.descriptorContainer.splice(n,1);break}n===this.descriptorContainer.length-1&&(this.descriptorContainer=[])}0===this.descriptorContainer.length&&this.descriptorContainerEmpty.set(!0)},e.prototype.getGeometryDescriptorById=function(e){for(var t=0;t<this.descriptorContainer.length;t++)if(this.descriptorContainer[t].id===e)return this.descriptorContainer[t];return null},e.prototype.getGeometryDescriptorByGeometry=function(e){for(var t=e,r=0;r<this.descriptorContainer.length;r++)if(t.declaredClass===this.descriptorContainer[r].geometry.declaredClass){var a=this.descriptorContainer[r].geometry;if(t===a)return this.descriptorContainer[r];var n=t.paths?t.paths.length:t.rings?t.rings.length:0;if(n===(a.paths?a.paths.length:a.rings.length))for(var i=0;i<n;i++){var s=t.paths?t.paths[i].length:t.rings[i].length;if(s===(a.paths?a.paths[i].length:a.rings[i].length))for(var o=0;o<s;o++){var u=t.getPoint(i,o),m=a.getPoint(i,o);if(u.x!==m.x||u.y!==m.y)break;if(o===s-1)return this.descriptorContainer[r]}break}}return null},e.prototype.getMeasurementResultsCollection=function(){var e=this.app.featureSetManager.getCollectionById("Measurement");return e||(e=new p.FeatureSetCollection,e.id="Measurement",e.sourceName="Measurement",e.displayName.set(this.getResource("language-measurement-results-collection-name")),this.app.featureSetManager.addCollection(e)),e},e.prototype.destroyAllDescriptors=function(){this.destroyDescriptor("",!0)},e.prototype.refreshLabels=function(){for(var e=0;e<this.descriptorContainer.length;e++)this.descriptorContainer[e].refreshLabelVisibilities()},e.prototype.activatePredictiveMeasurements=function(){var e=this;if(this._measurementModule._enablePrediction){var t=!0,r={x:0,y:0};this._predictiveMeasurementToken=this.app.map.on("mouse-move",function(a){if(r.x!==a.mapPoint.x||r.y!==a.mapPoint.y){r.x=a.mapPoint.x,r.y=a.mapPoint.y;var n=function(){e._predictiveMeasurementCount++,e._executePredictiveMeasurements(a.mapPoint,e._predictiveMeasurementCount)};switch(t){case!1:e._predictiveMeasurementsGraphic&&e._predictiveMeasurementsGraphic.isVisible()&&e._predictiveMeasurementsGraphic.hide(),e._delayedExecuteToken&&(clearTimeout(e._delayedExecuteToken),e._delayedExecuteToken=null),t=!0;case!0:e._delayedExecuteToken=setTimeout(n,1e3),t=!1}}})}},e.prototype.deactivatePredictiveMeasurements=function(){this._measurementModule._enablePrediction&&(this._delayedExecuteToken&&(clearTimeout(this._delayedExecuteToken),this._delayedExecuteToken=null),this._predictiveMeasurementToken&&(this._predictiveMeasurementToken.remove(),this._predictiveMeasurementToken=null),this._predictiveMeasurementCount=0,this._predictiveMeasurementsGraphic&&this._predictiveMeasurementsGraphic.hide())},e.prototype.getResource=function(e){return this.app.getResource(this.libraryId,e)},e.prototype._setLayerIds=function(e,t){this.markupLayerId=e?e:this.markupLayerId,this.measurementLayerId=t?t:this.measurementLayerId},e.prototype._setMapTipPresentation=function(e,t,r,a,n,i){this._predictiveMeasurementTextColor=e,this._predictiveMeasurementHighlightColor=t,this._predictiveMeasurementOutlineColor=r,this._predictiveMeasurementOutlineWidth=a,this._predictiveMeasurementHighlightRadius=n,this._predictiveMeasurementTextSize=i},e.prototype._executePredictiveMeasurements=function(e,t){var r=this;if(this._currentGeometryInProcess&&this._currentLineSegmentInProcess&&this._currentLineSegmentInProcess.mapPointStart){if(!this._measurementLayersCreated){var a=c.getInternalGraphicsLayer(this.markupLayerId,this.app,c.GraphicsLayerType.Markup),n=c.getInternalGraphicsLayer(this.measurementLayerId,this.app,c.GraphicsLayerType.Label);a&&n&&(this._measurementLayersCreated=!0)}var i=0,o=0===this._currentGeometryInProcess._lineSegments.length?this._currentLineSegmentInProcess.mapPointStart:this._currentGeometryInProcess._lineSegments[this._currentGeometryInProcess._lineSegments.length-1].mapPointEnd,u="";if(e.x!==o.x||e.y!==o.y)switch(this._currentGeometryInProcess.type){case l.DescriptorType.POLYLINE:var m=new esri.geometry.Polyline(o.spatialReference);m.addPath([o,e]),this._measurementModule._processLineSegment(m,function(a){i=r._currentGeometryInProcess.length?a.length+r._currentGeometryInProcess.length:a.length;var n=s.measurementMarkupManager.formatMeasurement(a.length,r.measurementFractionalDigits),o=s.measurementMarkupManager.formatMeasurement(i,r.measurementFractionalDigits);u=r.getResource("language-measurement-polyline-predictive-markup-label").format(n,r._lengthUnitString,o,r._lengthUnitString),t===r._predictiveMeasurementCount&&(r._predictiveMeasurementsGraphic=h.addHighlightedLabelToMap(u,e,null,r.measurementLayerId,r.app,!0,0,0,"Arial",r._predictiveMeasurementTextSize,r._predictiveMeasurementTextColor,r._predictiveMeasurementHighlightColor,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,r._predictiveMeasurementOutlineColor,r._predictiveMeasurementOutlineWidth),r._predictiveMeasurementHighlightRadius,0,!0))});break;case l.DescriptorType.POLYGON:for(var p=new esri.geometry.Polygon(o.spatialReference),g=[],d=0;d<this._currentGeometryInProcess._lineSegments.length;d++)g.push(this._currentGeometryInProcess._lineSegments[d].mapPointStart),g.push(this._currentGeometryInProcess._lineSegments[d].mapPointEnd);0===g.length&&g.push(o,e),g.push(e),g.push(g[0]),p.addRing(g),this._measurementModule._processPolygon(p,function(a){var n=new esri.geometry.Polyline(o.spatialReference);n.addPath([o,e]),r._measurementModule._processLineSegment(n,function(n){var i=0===a.perimeter?2*n.length:a.perimeter,o=s.measurementMarkupManager.formatMeasurement(n.length,r.measurementFractionalDigits),m=s.measurementMarkupManager.formatMeasurement(a.area,r.measurementFractionalDigits),l=s.measurementMarkupManager.formatMeasurement(i,r.measurementFractionalDigits);u=r.getResource("language-measurement-polygon-predictive-markup-label").format(o,r._lengthUnitString,m,r._areaUnitString,l,r._lengthUnitString),t===r._predictiveMeasurementCount&&(r._predictiveMeasurementsGraphic=h.addHighlightedLabelToMap(u,e,null,r.measurementLayerId,r.app,!0,0,0,"Arial",r._predictiveMeasurementTextSize,r._predictiveMeasurementTextColor,r._predictiveMeasurementHighlightColor,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,r._predictiveMeasurementOutlineColor,r._predictiveMeasurementOutlineWidth),r._predictiveMeasurementHighlightRadius,0,!0))})})}}},e.prototype._createMeasurementMarkupFromGeometry=function(e){if(e&&(e instanceof esri.geometry.Polyline||e instanceof esri.geometry.Polygon)){this.app.command("_clearMeasurementMarkup").execute("temporary",!0);var t=this.getGeometryDescriptorByGeometry(e),r=!0;if(!t){var a=null;t=this.createDescriptor(e instanceof esri.geometry.Polyline?l.DescriptorType.POLYLINE:l.DescriptorType.POLYGON,e.spatialReference),a=e instanceof esri.geometry.Polyline?new esri.geometry.Polyline(e.toJson()):new esri.geometry.Polygon(e.toJson()),t.setGeometry(a),r=!1,this.app.command("_addGeometryMarkup").execute(t)}this._recreateMeasurementMarkup(t.graphic,r,!1)}else this._reportStatus("CreateMeasurementMarkup: Invalid geometry type. Measurement information can only be generated for Polyline or Polygon geometry types.","error",!1)},e.prototype._handleDeleteClickableFeatureStarted=function(e){e&&e.esriFeature&&e.esriFeature.get()&&(this._featureWhichIsBeingDeleted=e.esriFeature.get())},e.prototype._handleGraphicRemoved=function(e){e&&e.graphic&&this._featureWhichIsBeingDeleted===e.graphic&&(this._featureWhichIsBeingDeleted=null)},e.prototype._recreateMeasurementMarkup=function(e,t,r){var n=this;if(void 0===t&&(t=!0),void 0===r&&(r=!0),!this._featureWhichIsBeingDeleted||this._featureWhichIsBeingDeleted!==e){var i=function(e){n.app.command(h).execute(e,function(){n.measurementInProgress.set(!1),e.refreshMeasurementData(),n._reportStatus("Successfully computed measurement information for specified geometry/graphic.","info",!1)},o)},o=function(e){n.measurementInProgress.set(!1),s.measurementMarkupManager._reportStatus("Error recreating measurement markup: {0}","error",!1,[e])};if(e&&e.geometry&&void 0!=e.measurementId){var u=e.measurementId,m=e.geometry,p=0,c=0;new a.Observable(0);if(m.paths?p=m.paths.length:m.rings&&(p=m.rings.length),e&&m instanceof esri.geometry.Polyline||m instanceof esri.geometry.Polygon){var h=m instanceof esri.geometry.Polyline?"MeasureDistance":"MeasureArea",d=m instanceof esri.geometry.Polyline?l.DescriptorType.POLYLINE:l.DescriptorType.POLYGON,M=this.getGeometryDescriptorById(u);if(!M||M&&t){var y=null;M&&(y=M.originalZoomLevel,this.destroyDescriptor(u,!1,r)),M=this.createDescriptor(d,m.spatialReference),M.originalZoomLevel=null===y?M.originalZoomLevel:y,M.drawMode="polyline"===m.type?g.DrawMode.POLYLINE:g.DrawMode.POLYGON,e.measurementId=M.id}M.setGeometry(m),M.graphic=e;for(var _=[],f=[],S=0;S<p;S++)for(var k=m instanceof esri.geometry.Polyline?m.paths[S].length:m.rings[S].length,v=1;v<k;v++){var b=m.getPoint(S,v-1),E=m.getPoint(S,v);if(b&&E){var L=this.createDescriptor(l.DescriptorType.LINE_SEGMENT,m.spatialReference);L.id=M.id,L.setStartPt(b),L.setEndPt(E),L.mapPointStart.x===L.mapPointEnd.x&&L.mapPointStart.y===L.mapPointEnd.y||(_.push(L),f.push(L.geometry),c++)}}this.measurementInProgress.set(!0),this._measurementModule._processLineSegment(f,function(e){for(var t=e.serverResponse.lengths.length,r=e.serverResponse.lengths,a=0;a<t;a++)_[a].setMeasurementUnit(n._lengthUnit),_[a].length=r[a],n.app.command("_addLineSegmentMeasurementMarkup").execute(_[a],function(e){e.isActive=M.isActive,M.addSegment(e),a===t-1&&i(M)},o)},o)}else this._reportStatus("Could not recreate measurement markup. Incompatible geometry. Only Polyline and Polygon geometry are supported.","warning",!1)}}},e.prototype._hideMeasurementMarkup=function(e,t){if(void 0===t&&(t=!1),1==this.measurementInProgress.get()){var r=e,a=t;return void(this._measurementInProgressToken=this.measurementInProgress.bind(this,function(){this._hideMeasurementMarkup(r,a)}))}this._measurementInProgressToken&&(this.measurementInProgress.unbind(this._measurementInProgressToken),this._measurementInProgressToken=null);for(var n=0;n<this.descriptorContainer.length;n++)if(this.descriptorContainer[n].id===e.measurementId){for(var i=0;i<this.descriptorContainer[n]._lineSegments.length;i++){var s=this.descriptorContainer[n]._lineSegments[i];s.graphic&&s.graphic.hide(),s.highlightedLabelGraphic&&s.highlightedLabelGraphic.hide()}var o=this.descriptorContainer[n];t&&o.graphic&&o.graphic.hide(),o.highlightedLabelGraphic&&o.highlightedLabelGraphic.hide();break}},e.prototype._updateMeasurementUnits=function(e,t){for(var r=0;r<this.descriptorContainer.length;r++)this.descriptorContainer[r].setMeasurementUnit(e,t);this._lengthUnit=e,this._areaUnit=t,this._lengthUnitString=h.getUnitString(e),this._areaUnitString=h.getUnitString(t)},e.prototype._removeGraphicFromLayer=function(e){if(e){var t=e.getLayer();t&&t.remove(e)}},e.prototype._removeHighlightedLabelFromLayer=function(e){var t=this;e.textGraphics.forEach(function(e){t._removeGraphicFromLayer(e)}),this._removeGraphicFromLayer(e.highlightGraphic);var r=this.addedMapGraphics.indexOf(e);r!==-1&&this.addedMapGraphics.splice(r,1)},e.prototype._canExecuteMarkupIntegration=function(e){return!(!e||void 0==e.measurementId)},e.prototype._processMarkupEditingStarted=function(e){if(this._canExecuteMarkupIntegration(e)){var t=this.getGeometryDescriptorById(e.measurementId);t&&(this._hideMeasurementMarkup(e),t.editingInProgress=!0)}},e.prototype._processMarkupEditingStopped=function(e){if(this._canExecuteMarkupIntegration(e)){var t=this.getGeometryDescriptorById(e.measurementId);t&&(this._recreateMeasurementMarkup(e,!0,!1),t.editingInProgress=!1)}},e.prototype._processMarkupDeleted=function(e){this._canExecuteMarkupIntegration(e)&&this.destroyDescriptor(e.measurementId)},e.prototype._getUnitLanguageResources=function(){for(var e in this.unit)this.unit.hasOwnProperty(e)&&(this.unit[e]={shortName:this.getResource("language-measurement-unit-"+e.toLowerCase()+"-short"),longName:this.getResource("language-measurement-unit-"+e.toLowerCase()),config:e})},e.prototype._reportStatus=function(e,t,r,a){var n=this;void 0===r&&(r=!1),void 0===a&&(a=null);var i="language-measurement-"===e.substring(0,21)?this.getResource(e):e;a&&(i=i.format.apply(i,a));var s=function(){r&&n.app.command("ClearActiveTool").execute()};switch(t.toLowerCase()){case"alert":return void this.app.command("Alert").execute(i,this.getResource("language-measurement-alert-title"),function(){s()});case"info":this.app.trace.info(i);break;case"warning":this.app.trace.warning(i);break;case"error":this.app.trace.error(i)}s()},e}();t.MeasurementMarkupManager=d})},"Mapping/modules/Measurement/MeasurementModule":function(){define(["require","exports","./MeasurementMarkupManager","geocortex/framework/application/ModuleBase","geocortex/infrastructure/validation/NumberValidator","./MeasurementUtils","./Descriptors/GeometryDescriptor","geocortex/infrastructure/Feature","geocortex/infrastructure/GeometryUtils","./Descriptors/LineSegmentDescriptor","./Descriptors/DescriptorBase","geocortex/essentials/GeometryUtilities"],function(e,t,r,a,n,i,s,o,u,m,l,p){"use strict";var c=function(e){function a(a,i){var s=e.call(this,a,i)||this;return s._measurementWkid=-1,s._measurementSpatialReference=null,s._currentSpatialReference=null,s._numberValidator=new n.NumberValidator,t.measurementMarkupManager=new r.MeasurementMarkupManager(s,a,i),s.app.toolRegistry.registerToolTypeForCommand("MeasureArea","geocortex.essentialsHtmlViewer.mapping.modules.measurement.MeasurementTool"),s.app.toolRegistry.registerToolTypeForCommand("MeasureDistance","geocortex.essentialsHtmlViewer.mapping.modules.measurement.MeasurementTool"),s}return __extends(a,e),a.prototype.initialize=function(e){this._registerCommands(),this._measurementWkid=e&&e.measurementProjectionWkid&&""!=e.measurementProjectionWkid?parseInt(e.measurementProjectionWkid,10):-1;var r=this._measurementWkid===-1?"geodesic":"planar";this._calculationType=e&&e.calculationType&&("planar"===e.calculationType||"geodesic"===e.calculationType||"preserveShape"===e.calculationType)?e.calculationType:r,this._enablePrediction=!e||void 0==e.enablePrediction||e.enablePrediction,this._measurementLengthUnits=i.getGeometryServiceUnitConstant(e.measurementLengthUnits||"feet"),this._measurementAreaUnits=i.getGeometryServiceUnitConstant(e.measurementAreaUnits||"squarefeet"),this._segmentWarningThreshold=void 0!=e.numSegmentsWarningThreshold?parseInt(e.numSegmentsWarningThreshold,10):1e3,e&&e.tools&&this.app&&this.app.toolRegistry&&this.app.toolRegistry.createTools(e.tools,!0),t.measurementMarkupManager._updateMeasurementUnits(this._measurementLengthUnits,this._measurementAreaUnits),e&&e.measurementResultTypes&&(t.measurementMarkupManager.measurementResultTypes=e.measurementResultTypes),e&&e.coordinateFractionalDigits&&(t.measurementMarkupManager.coordinateFractionalDigits=e.coordinateFractionalDigits),e&&e.measurementFractionalDigits&&(t.measurementMarkupManager.measurementFractionalDigits=e.measurementFractionalDigits),e&&e.degreeFormat&&(t.measurementMarkupManager.degreeFormat=e.degreeFormat.toLowerCase()),e&&e.angleDirectionSystem&&(t.measurementMarkupManager.angleDirectionSystem=e.angleDirectionSystem.toLowerCase()),this._measurementWkid!==-1&&(this._measurementSpatialReference=new esri.SpatialReference(this._measurementWkid)),this.app.map&&this.app.map.loaded?this._onMapLoaded():this.app.event("MapLoadedEvent").subscribe(this,this._onMapLoaded)},a.prototype.getStateFilter=function(){return{lengthUnit:!0,areaUnit:!0,measurements:{item:this._getMeasurementShapeFilter()}}},a.prototype.exportState=function(){return Promise["try"](function(){return{lengthUnit:t.measurementMarkupManager._lengthUnit,areaUnit:t.measurementMarkupManager._areaUnit,measurements:t.measurementMarkupManager.descriptorContainer.map(function(e){return e.exportState()})}})},a.prototype.applyState=function(e){var r=this;return Promise["try"](function(){t.measurementMarkupManager._lengthUnit=e.lengthUnit,t.measurementMarkupManager._lengthUnitString=i.getUnitString(e.lengthUnit),t.measurementMarkupManager._areaUnit=e.areaUnit,t.measurementMarkupManager._areaUnitString=i.getUnitString(e.areaUnit),r._measurementLengthUnits=e.lengthUnit,r._measurementAreaUnits=e.areaUnit,r.app.command("_applyMeasurementUnits").execute(e.lengthUnit,e.areaUnit)}).then(function(){return r.app.waitUntilMapLoaded()}).then(function(){return Promise.map(e.measurements,function(e){var t=r.app.project.convert.toEsriSpatialReference(e.spatialReference),a=new s.GeometryDescriptor(e.id,e.type,t,r.app);return a.applyState(e),a})}).then(function(e){t.measurementMarkupManager.descriptorContainer=e,t.measurementMarkupManager.descriptorContainerEmpty.set(0===e.length)})["return"]()},a.prototype._getHighlightedLabelFilter=function(){return{highlightGraphic:this.app.project.filter.graphic,highlightSymbol:this.app.project.filter.simpleMarkerSymbol,textGraphics:{item:this.app.project.filter.graphic},textSymbols:{item:this.app.project.filter.textSymbol},layerId:!0,mapPoint:this.app.project.filter.point,text:!0,labelXoffset:this._numberValidator,labelYoffset:this._numberValidator,fontFamily:!0,fontSize:!0,cornerRadius:this._numberValidator,angle:this._numberValidator,anchor:!0,textColor:this.app.project.filter.color,highlightColor:this.app.project.filter.color,highlightOutlineSymbol:this.app.project.filter.simpleLineSymbol}},a.prototype._getDescriptorFilter=function(){return{id:!0,geometry:this.app.project.filter.geometry,length:this._numberValidator,type:this._numberValidator,spatialReference:this.app.project.filter.spatialReference,graphic:this.app.project.filter.graphic,feature:this.app.project.filter.feature,label:this._getHighlightedLabelFilter()}},a.prototype._getMeasurementSegmentFilter=function(){return $.extend({},this._getDescriptorFilter(),{startPoint:this.app.project.filter.point,endPoint:this.app.project.filter.point})},a.prototype._getMeasurementShapeFilter=function(){return $.extend({},this._getDescriptorFilter(),{segments:{item:this._getMeasurementSegmentFilter()},area:this._numberValidator,simplifiedGeometry:this.app.project.filter.geometry,originalZoomLevel:this._numberValidator,drawMode:!0,measurementData:this.app.project.filter.featureSet})},a.prototype._onMapLoaded=function(){this._currentSpatialReference=this.app.map.spatialReference,this._measurementSpatialReference||(this._measurementSpatialReference=this._currentSpatialReference)},a.prototype._registerCommands=function(){this.app.command("MeasureDistance").register(this,this._executeMeasurementCommand,this._canExecuteMeasureDistance),this.app.command("MeasureArea").register(this,this._executeMeasurementCommand,this._canExecuteMeasureArea),this.app.command("SetMeasurementUnits").register(this,this._setMeasurementUnits),this.app.event("GeometryChangedEvent").subscribe(this,this.handleGraphicEdited)},a.prototype.handleGraphicEdited=function(e){var t=e.graphic;t&&t.hasOwnProperty("measurementId")&&("polygon"===t.geometry.type?this._reCalculatePolygonDimensions(t):"polyline"===t.geometry.type&&this._reCalculatePolylineDimensions(t))},a.prototype._canExecuteMeasureArea=function(e){if(e instanceof o.Feature&&e.featureSet&&e.featureSet.isMeasurement)return!1;var t=this._retrieveGeometry(e),r=u.getGeometryService(this.app),a=e instanceof m.LineSegmentDescriptor;return!!t&&!!(t&&r&&(a||t instanceof esri.geometry.Polygon))},a.prototype._canExecuteMeasureDistance=function(e){if(e instanceof o.Feature&&e.featureSet&&e.featureSet.isMeasurement)return!1;var t=this._retrieveGeometry(e),r=u.getGeometryService(this.app),a=e instanceof m.LineSegmentDescriptor;return!!t&&!!(t&&r&&(a||t instanceof esri.geometry.Polyline))},a.prototype._executeMeasurementCommand=function(e,r,a){var n=this,i=function(e){for(var t=0,r=e.hasOwnProperty("rings")?e.rings:e.paths,a=0;a<r.length;a++)t+=r[a].length-1;return t},s=function(e){n.app.command("ClearDefaultHighlights").execute(),t.measurementMarkupManager._createMeasurementMarkupFromGeometry(e)};if(e instanceof l.DescriptorBase)this._executeMeasurement(e,r,a);else{var o=this._retrieveGeometry(e);if(o){var u=i(o);u>this._segmentWarningThreshold?this.app.command("Confirm").execute(this.app.getResource(this.libraryId,"language-measurement-high-line-segments-warning").format(u),null,function(e){e&&s(o)}):s(o)}}},a.prototype._retrieveGeometry=function(e){var t=null;if(e)if(e instanceof l.DescriptorBase||e instanceof esri.Graphic)t=e.geometry;else if(e instanceof esri.geometry.Geometry)t=e;else if(e instanceof o.Feature&&e.esriFeature){var r=e.esriFeature.get();r&&(t=r.geometry)}return t},a.prototype._executeMeasurement=function(e,r,a){var n=this;switch(t.measurementMarkupManager.measurementInProgress.get()||t.measurementMarkupManager.measurementInProgress.set(!0),e.type){case l.DescriptorType.LINE_SEGMENT:this._processLineSegment(e,function(e){var i=t.measurementMarkupManager.getGeometryDescriptorById(e.id);e.isActive=!!i&&i.isActive,n.app.command("_addLineSegmentMeasurementMarkup").execute(e,r,function(e){n._tryErrorCallback(a,e)})},function(e){n._tryErrorCallback(a,e)});break;case l.DescriptorType.POLYLINE:this.app.command("_addCompletedGeometryMeasurementMarkup").execute(e,r,function(e){n._tryErrorCallback(a,e)});break;case l.DescriptorType.POLYGON:this._processPolygon(e,function(e){n.app.command("_addCompletedGeometryMeasurementMarkup").execute(e,r,a)},function(e){n._tryErrorCallback(a,e)});break;default:this._tryErrorCallback(a,new Error("Invalid Descriptor Type"))}},a.prototype._processLineSegment=function(e,t,r){var a=this,n=e instanceof m.LineSegmentDescriptor?e.geometry:e;n=n instanceof Array?n:[n],this._tryProject(n,this._measurementSpatialReference,function(n){a._measurePolylineLengths(n,a._measurementLengthUnits,function(r){var n={length:r.lengths[0],serverResponse:r};e instanceof m.LineSegmentDescriptor?(e.setMeasurementUnit(a._measurementLengthUnits),e.length=n.length,t(e)):t(n)},function(e){a._tryErrorCallback(r,e)})},function(e){a._projectionError(e),a._tryErrorCallback(r,e)})},a.prototype._reCalculatePolylineDimensions=function(e){var t=this,r=e,a=function(e){t.app.trace.info("Successfully computed measurement information for specified geometry/ graphic."),r.attributes&&(r.attributes.Length=e,t._raiseGraphicAttributesChangedEvent(r))},n=function(e){var a="Error calculating measurement markup: {0}";t.app.trace.error(a.format.apply(a,[e])),r.attributes&&(r.attributes.Length=t.getResource("language-measurement-value-not-available"),t._raiseGraphicAttributesChangedEvent(r))},i=(u.getGeometryService(this.app),[e.geometry]);this._tryProject(i,this._measurementSpatialReference,function(e){t._measurePolylineLengths(e,t._measurementLengthUnits,function(e){var t={length:e.lengths[0],serverResponse:e};a(t.length)},function(e){t._tryErrorCallback(n,e)})},function(e){t._projectionError(e),t._tryErrorCallback(n,e)})},a.prototype._reCalculatePolygonDimensions=function(e){var t=this,r=e,a=function(e,a){t.app.trace.info("Successfully computed measurement information for specified geometry/ graphic."),r.attributes&&(r.attributes.Area=e,r.attributes.Length=a,t._raiseGraphicAttributesChangedEvent(r))},n=function(e){var a="Error calculating measurement markup: {0}";t.app.trace.error(a.format.apply(a,[e])),r.attributes&&(r.attributes.Area=t.getResource("language-measurement-value-not-available"),r.attributes.Length=t.getResource("language-measurement-value-not-available"),t._raiseGraphicAttributesChangedEvent(r))},i=u.getGeometryService(this.app),s=[e.geometry];i.simplify(s,function(e){t._tryProject(e,t._measurementSpatialReference,function(e){t._measurePolygonAreaAndPerimeter(e,t._measurementLengthUnits,t._measurementAreaUnits,function(e){var t={area:e.areas[0],perimeter:e.lengths[0],serverResponse:e};a(t.area,t.perimeter)},function(e){t._tryErrorCallback(n,e)})},function(e){t._projectionError(e),t._tryErrorCallback(n,e)})},function(e){t._tryErrorCallback(n,e)})},a.prototype._raiseGraphicAttributesChangedEvent=function(e){var t={graphic:e};this.app.event("GraphicAttributesChangedEvent").publish(t)},a.prototype._processPolygon=function(e,t,r){var a=this,n=function(r,n){e.area=r,e.simplifiedGeometry=n,e.unit||e.setMeasurementUnit(a._measurementLengthUnits,a._measurementAreaUnits),t(e)};if(e instanceof s.GeometryDescriptor&&2===e._lineSegments.length)return void n(0,null);var i=e instanceof s.GeometryDescriptor?e.geometry:e;i=i instanceof Array?i:[i];var o=u.getGeometryService(this.app);o.simplify(i,function(i){a._tryProject(i,a._measurementSpatialReference,function(o){a._measurePolygonAreaAndPerimeter(o,a._measurementLengthUnits,a._measurementAreaUnits,function(r){var a={area:r.areas[0],perimeter:r.lengths[0],serverResponse:r};e instanceof s.GeometryDescriptor?n(a.area,i[0]):t(a)},function(e){a._tryErrorCallback(r,e)})},function(e){a._projectionError(e),a._tryErrorCallback(r,e)})},function(e){a._tryErrorCallback(r,e)})},a.prototype._tryProject=function(e,t,r,a){var n=this;if(p.spatialRefsAreEqual(this._currentSpatialReference,t,!1))r(e);else{
var i=new esri.tasks.ProjectParameters;i.geometries=e,i.outSR=t,this._calculationType="planar",u.project(i,r,function(e){n._tryErrorCallback(a,e)},this.app)}},a.prototype._measurePolylineLengths=function(e,r,a,n){var s=this,o=!1;r===t.measurementMarkupManager.GCX_UNIT_YARDS&&(r=esri.tasks.GeometryService.UNIT_FOOT,o=!0);var m=new esri.tasks.LengthsParameters;m.calculationType=this._calculationType,"preserveShape"!=this._calculationType&&(m.geodesic="planar"!=this._calculationType),m.lengthUnit=r,m.polylines=e;var l=u.getGeometryService(this.app);l.lengths(m,function(e){if(o)for(var r=0;r<e.lengths.length;r++)e.lengths[r]=i.convertLength(e.lengths[r],esri.tasks.GeometryService.UNIT_FOOT,t.measurementMarkupManager.GCX_UNIT_YARDS);a(e)},function(e){s._tryErrorCallback(n,e)})},a.prototype._measurePolygonAreaAndPerimeter=function(e,r,a,n,s){var o=this,m=!1;r===t.measurementMarkupManager.GCX_UNIT_YARDS&&(r=esri.tasks.GeometryService.UNIT_FOOT,m=!0);var l=!1;a===t.measurementMarkupManager.GCX_UNIT_SQ_NAUTICAL_MILES&&(a=esri.tasks.GeometryService.UNIT_SQUARE_MILES,l=!0);var p=new esri.tasks.AreasAndLengthsParameters;p.lengthUnit=r,p.areaUnit=a,p.calculationType=this._calculationType,p.polygons=e;var c=u.getGeometryService(this.app);c.areasAndLengths(p,function(e){if(m)for(var r=0;r<e.lengths.length;r++)e.lengths[r]=i.convertLength(e.lengths[r],esri.tasks.GeometryService.UNIT_FOOT,t.measurementMarkupManager.GCX_UNIT_YARDS);if(l)for(var a=0;a<e.areas.length;a++)e.areas[a]=i.convertArea(e.areas[a],esri.tasks.GeometryService.UNIT_SQUARE_MILES,t.measurementMarkupManager.GCX_UNIT_SQ_NAUTICAL_MILES);n(e)},function(e){o._tryErrorCallback(s,e)})},a.prototype._setMeasurementUnits=function(e,r){this._measurementLengthUnits=i.getGeometryServiceUnitConstant(e),this._measurementAreaUnits=i.getGeometryServiceUnitConstant(r),t.measurementMarkupManager._updateMeasurementUnits(this._measurementLengthUnits,this._measurementAreaUnits)},a.prototype._projectionError=function(e){t.measurementMarkupManager._reportStatus("language-measurement-projection-error","alert",!0,[this._measurementWkid,e])},a.prototype._tryErrorCallback=function(e,t){e&&e(t)},a}(a.ModuleBase);t.MeasurementModule=c})},"Mapping/modules/Measurement/MeasurementOperation":function(){define(["require","exports","geocortex/framework/observables","./MeasurementModule","./Descriptors/DescriptorBase"],function(e,t,r,a,n){"use strict";var i=function(){function e(e){this.pointIndex=0,this._currentGeometry=null,this._currentLineSegment=null,this._prevSegEndPt=null,this._tool=null,this._tool=e,this._lineSegmentCommandCallbackCompleted=new r.Observable(0),this._drawEndInvoked=!1,this._totalSegmentCount=0}return e.prototype.setStartPt=function(e){var t=this,r=function(e){t._currentGeometry="POLYLINE"===t._tool.drawMode?a.measurementMarkupManager.createDescriptor(n.DescriptorType.POLYLINE,e.mapPoint.spatialReference):a.measurementMarkupManager.createDescriptor(n.DescriptorType.POLYGON,e.mapPoint.spatialReference),t._currentLineSegment=a.measurementMarkupManager.createDescriptor(n.DescriptorType.LINE_SEGMENT,e.mapPoint.spatialReference),t._currentLineSegment.id=t._currentGeometry.id;var r=e.snappingPoint?e.snappingPoint:e.mapPoint;t._currentLineSegment.setStartPt(r),a.measurementMarkupManager.activatePredictiveMeasurements(),t.pointIndex=1};t._tool.app.command("_clearMeasurementMarkup").execute("temporary",!0),r(e)},e.prototype.setEndPt=function(e){var t=this;if(this._currentLineSegment.mapPointStart.x!==e.mapPoint.x||this._currentLineSegment.mapPointStart.y!==e.mapPoint.y){if(this._prevSegEndPt){if(this._prevSegEndPt.x===e.mapPoint.x&&this._prevSegEndPt.y===e.mapPoint.y)return;this._currentLineSegment=a.measurementMarkupManager.createDescriptor(n.DescriptorType.LINE_SEGMENT,this._prevSegEndPt.spatialReference),this._currentLineSegment.id=this._currentGeometry.id,this._currentLineSegment.setStartPt(this._prevSegEndPt),this._prevSegEndPt=null}var r=e.snappingPoint?e.snappingPoint:e.mapPoint;this._currentLineSegment.setEndPt(r),this._prevSegEndPt=this._currentLineSegment.mapPointEnd,this._totalSegmentCount++,this._tool.executeToolCommand(this._currentLineSegment,function(e){t._currentGeometry.addSegment(e),t._lineSegmentCommandCallbackCompleted.set(t._lineSegmentCommandCallbackCompleted.get()+1)})}},e.prototype.plotPoint=function(e){0===this.pointIndex?this.setStartPt(e):this.setEndPt(e)},e.prototype.executeDrawEnd=function(e){var t=this;if(a.measurementMarkupManager.deactivatePredictiveMeasurements(),0===this._totalSegmentCount)return a.measurementMarkupManager._reportStatus("No geometry drawn. Cannot compute measurements","info",!1),void a.measurementMarkupManager.destroyDescriptor(this._currentGeometry.id);var r=function(){a.measurementMarkupManager.measurementInProgress.get()&&a.measurementMarkupManager.measurementInProgress.set(!1)},n=function(){t._tool.isSticky||t._tool.setActive(!1)},i=function(e){t._tool.onDrawCompleted(e,t._currentGeometry,function(e){r(),n(),e.refreshMeasurementData()},function(e){r(),n(),t._tool._onDrawCompletedError(e)})};if(this._drawEndInvoked=!0,this._currentGeometry.setGeometry(e),this._tool.app.command("_addGeometryMarkup").execute(t._currentGeometry),this._lineSegmentCommandCallbackCompleted.get()===this._totalSegmentCount)i(e);else var s=this._lineSegmentCommandCallbackCompleted.bind(this,function(r){r===t._totalSegmentCount&&(t._lineSegmentCommandCallbackCompleted.unbind(s),i(e))})},e}();t.MeasurementOperation=i})},"Mapping/modules/Measurement/MeasurementState":function(){define(["require","exports"],function(e,t){"use strict"})},"Mapping/modules/Measurement/MeasurementTool":function(){define(["require","exports","geocortex/infrastructure/tools/MapTool","./MeasurementModule","geocortex/infrastructure/tools/DrawMode","./MeasurementOperation","geocortex/infrastructure/accessibility/Draw","./Descriptors/DescriptorBase"],function(e,t,r,a,n,i,s,o){"use strict";var u=function(e){function t(t,r){var n=e.call(this,t,r)||this;return n.clickHandlerToken=null,n.drawEndHandlerToken=null,n.keyDownHandlerToken=null,n.mapMouseHoverToken=null,n._toolSuspended=!1,n.app.command("_suspendMeasurementToolIfActive").register(n,function(){a.measurementMarkupManager._toolActive?n._drawIsActive&&n._drawObject&&(n._toolSuspended=!0,n._drawObject.deactivate()):n.app.command("ClearActiveTool").execute()}),n.app.command("_resumeMeasurementToolIfSuspended").register(n,function(){n._toolSuspended&&n._drawObject&&(n._toolSuspended=!1,n._drawObject.activate(esri.toolbars.Draw[n.drawMode]))}),n}return __extends(t,e),t.prototype.onActivated=function(){var t=this;if(this.drawMode!==n.DrawMode.POLYLINE&&this.drawMode!==n.DrawMode.POLYGON)return e.prototype.onActivated.call(this);if(!this._drawObject){this._drawObject=this.app.accessibilityManager.createComponent("geocortex.accessibility.draw",this.app.map,{enableEditing:!1}),this._drawObject.setFillSymbol(new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new esri.Color([0,0,0,.8]),2),new esri.Color([0,0,0,.25]))),this._drawObject.setLineSymbol(new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new esri.Color([0,0,0,.8]),2)),this._drawObject.setRespectDrawingVertexOrder(!0);var r=null,o=function(e){r&&!r._drawEndInvoked||(r=new i.MeasurementOperation(t)),r.plotPoint(e)},u=function(e){r.executeDrawEnd(e),r=null},m=function(e){27!==e.which&&27!==e.keyCode||(t.isSticky?(t.onDeactivated(),t.onActivated()):t.setActive(!1))};this.clickHandlerToken&&this.drawEndHandlerToken||(this.clickHandlerToken=this.app.event("GraphicVertexAddedEvent").subscribe(this,function(e){e&&e.sender===t._drawObject&&o(e)}),this.drawEndHandlerToken=dojo.aspect.after(this._drawObject,"onDrawEnd",u,!0)),this.keyDownHandlerToken||(this.keyDownHandlerToken=this.app.map.on("key-down",m)),this._drawObject instanceof s.Draw&&!this._inputMethodChangeHandle&&(this._inputMethodChangeHandle=dojo.aspect.after(this._drawObject,"onInputMethodChange",dojo.hitch(this,"onInputMethodChange"),!0))}return this._drawIsActive&&(this._drawObject.deactivate(),this._drawIsActive=!1),this.app.map.graphics?(this.mapMouseHoverToken=this.app.event("MapMouseHoverEvent").subscribe(this,this.onMapMouseHover),this._drawObject.activate(esri.toolbars.Draw[this.drawMode]),this._drawIsActive=!0,a.measurementMarkupManager._toolActive=!0,!0):(setTimeout(function(){a.measurementMarkupManager._reportStatus("language-measurement-null-graphics-error","alert",!0)},0),!1)},t.prototype.onDeactivated=function(){e.prototype.onDeactivated.call(this),this.clickHandlerToken&&(this.app.event("GraphicVertexAddedEvent").unsubscribe(this.clickHandlerToken),this.clickHandlerToken=null),this.drawEndHandlerToken&&(this.drawEndHandlerToken.remove(),this.drawEndHandlerToken=null),this.keyDownHandlerToken&&(this.keyDownHandlerToken.remove(),this.keyDownHandlerToken=null),this._inputMethodChangeHandle&&(this._inputMethodChangeHandle.remove(),this._inputMethodChangeHandle=null),this.mapMouseHoverToken&&(this.app.event("MapMouseHoverEvent").unsubscribe(this.mapMouseHoverToken),this.mapMouseHoverToken=null),a.measurementMarkupManager.deactivatePredictiveMeasurements(),a.measurementMarkupManager.measurementInProgress.get()&&a.measurementMarkupManager.measurementInProgress.set(!1),this.isSticky?this.app.command("_clearMeasurementMarkup").execute("temporary",!0):a.measurementMarkupManager._currentGeometryInProcess&&!a.measurementMarkupManager._currentGeometryInProcess.graphic&&a.measurementMarkupManager.destroyDescriptor(a.measurementMarkupManager._currentGeometryInProcess.id),this._drawObject&&delete this._drawObject,a.measurementMarkupManager._toolActive=!1},t.prototype.executeToolCommand=function(e,t,r){if(this.command){var n=this.app.command(this.command);n.canExecute(e)?n.execute(e,function(e){t&&t(e)},function(e){a.measurementMarkupManager._reportStatus("Execute Tool Command Error - Measurement Tools: {0}","error",!1,[e]),r&&r(e)}):a.measurementMarkupManager._reportStatus("Could not invoke command '{0}' for tool '{1}'.","error",!0,[this.name,this.command])}},t.prototype._onDrawCompletedError=function(e){a.measurementMarkupManager._reportStatus("Measurement Tool - Error on Draw Complete: {0}","error",!0,[e])},t.prototype.onDrawCompleted=function(e,t,r,n){var i=this,s="Measurement Tools: onDrawCompleted - Descriptor type mismatch",u=function(e){r&&r(e)},m=function(e,t){n&&n(t?new Error(t):e)};if(e instanceof esri.geometry.Polygon)if(t.type===o.DescriptorType.POLYGON){var l=t._lineSegments,p=l[l.length-1].mapPointEnd,c=l[0].mapPointStart;if(p.x!==c.x||p.y!==c.y){var h=a.measurementMarkupManager.createDescriptor(o.DescriptorType.LINE_SEGMENT,e.spatialReference);h.id=t.id,h.setStartPt(p),h.setEndPt(c),this.executeToolCommand(h,function(e){t.addSegment(e),i.executeToolCommand(t,u,m)},m)}else this.executeToolCommand(t,u,m)}else m(null,s);else e instanceof esri.geometry.Polyline?t.type===o.DescriptorType.POLYLINE?this.executeToolCommand(t,u,m):m(null,s):m(null,"Only Polygon and Polyline geometries supported")},t}(r.MapTool);t.MeasurementTool=u})},"Mapping/modules/Measurement/MeasurementUtils":function(){define(["require","exports","./HighlightedMeasurementLabel","./MeasurementModule","geocortex/essentials/DistanceUnit","geocortex/infrastructure/GraphicsLayerUtils","geocortex/infrastructure/SymbolUtils","geocortex/infrastructure/highlightedLabel/HighlightedLabelGraphic"],function(e,t,r,a,n,i,s,o){"use strict";function u(e,t){void 0===t&&(t=!1);var r="";if(!e)return r;switch(e){case esri.Units.FEET:case esri.tasks.GeometryService.UNIT_FOOT:case a.measurementMarkupManager.unit.feet.shortName:case a.measurementMarkupManager.unit.feet.longName:case a.measurementMarkupManager.unit.feet.config:r=t?a.measurementMarkupManager.unit.feet.longName:a.measurementMarkupManager.unit.feet.shortName;break;case esri.Units.YARDS:case a.measurementMarkupManager.GCX_UNIT_YARDS:case a.measurementMarkupManager.unit.yard.shortName:case a.measurementMarkupManager.unit.yard.longName:case a.measurementMarkupManager.unit.yard.config:r=t?a.measurementMarkupManager.unit.yard.longName:a.measurementMarkupManager.unit.yard.shortName;break;case esri.Units.METERS:case esri.tasks.GeometryService.UNIT_METER:case a.measurementMarkupManager.unit.meter.shortName:case a.measurementMarkupManager.unit.meter.longName:case a.measurementMarkupManager.unit.meter.config:r=t?a.measurementMarkupManager.unit.meter.longName:a.measurementMarkupManager.unit.meter.shortName;break;case esri.Units.KILOMETERS:case esri.tasks.GeometryService.UNIT_KILOMETER:case a.measurementMarkupManager.unit.kilometer.shortName:case a.measurementMarkupManager.unit.kilometer.longName:case a.measurementMarkupManager.unit.kilometer.config:r=t?a.measurementMarkupManager.unit.kilometer.longName:a.measurementMarkupManager.unit.kilometer.shortName;break;case esri.Units.MILES:case esri.tasks.GeometryService.UNIT_STATUTE_MILE:case a.measurementMarkupManager.unit.mile.shortName:case a.measurementMarkupManager.unit.mile.longName:case a.measurementMarkupManager.unit.mile.config:r=t?a.measurementMarkupManager.unit.mile.longName:a.measurementMarkupManager.unit.mile.shortName;break;case esri.Units.NAUTICAL_MILES:case esri.tasks.GeometryService.UNIT_NAUTICAL_MILE:case a.measurementMarkupManager.unit.nauticalMile.shortName:case a.measurementMarkupManager.unit.nauticalMile.longName:case a.measurementMarkupManager.unit.nauticalMile.config:r=t?a.measurementMarkupManager.unit.nauticalMile.longName:a.measurementMarkupManager.unit.nauticalMile.shortName;break;case esri.tasks.GeometryService.UNIT_SQUARE_FEET:case esri.Units.SQUARE_FEET:case a.measurementMarkupManager.unit.sqFeet.shortName:case a.measurementMarkupManager.unit.sqFeet.longName:case a.measurementMarkupManager.unit.sqFeet.config:r=t?a.measurementMarkupManager.unit.sqFeet.longName:a.measurementMarkupManager.unit.sqFeet.shortName;break;case esri.tasks.GeometryService.UNIT_SQUARE_METERS:case esri.Units.SQUARE_METERS:case a.measurementMarkupManager.unit.sqMeter.shortName:case a.measurementMarkupManager.unit.sqMeter.longName:case a.measurementMarkupManager.unit.sqMeter.config:r=t?a.measurementMarkupManager.unit.sqMeter.longName:a.measurementMarkupManager.unit.sqMeter.shortName;break;case esri.tasks.GeometryService.UNIT_SQUARE_KILOMETERS:case esri.Units.SQUARE_KILOMETERS:case a.measurementMarkupManager.unit.sqKilometer.shortName:case a.measurementMarkupManager.unit.sqKilometer.longName:case a.measurementMarkupManager.unit.sqKilometer.config:r=t?a.measurementMarkupManager.unit.sqKilometer.longName:a.measurementMarkupManager.unit.sqKilometer.shortName;break;case esri.tasks.GeometryService.UNIT_SQUARE_MILES:case esri.Units.SQUARE_MILES:case a.measurementMarkupManager.unit.sqMile.shortName:case a.measurementMarkupManager.unit.sqMile.longName:case a.measurementMarkupManager.unit.sqMile.config:r=t?a.measurementMarkupManager.unit.sqMile.longName:a.measurementMarkupManager.unit.sqMile.shortName;break;case esri.tasks.GeometryService.UNIT_SQUARE_YARDS:case esri.Units.SQUARE_YARDS:case a.measurementMarkupManager.unit.sqYard.shortName:case a.measurementMarkupManager.unit.sqYard.longName:case a.measurementMarkupManager.unit.sqYard.config:r=t?a.measurementMarkupManager.unit.sqYard.longName:a.measurementMarkupManager.unit.sqYard.shortName;break;case a.measurementMarkupManager.GCX_UNIT_SQ_NAUTICAL_MILES:case a.measurementMarkupManager.unit.sqNauticalMile.shortName:case a.measurementMarkupManager.unit.sqNauticalMile.longName:case a.measurementMarkupManager.unit.sqNauticalMile.config:r=t?a.measurementMarkupManager.unit.sqNauticalMile.longName:a.measurementMarkupManager.unit.sqNauticalMile.shortName;break;case esri.tasks.GeometryService.UNIT_ACRES:case esri.Units.ACRES:case a.measurementMarkupManager.unit.acre.shortName:case a.measurementMarkupManager.unit.acre.longName:case a.measurementMarkupManager.unit.acre.config:r=t?a.measurementMarkupManager.unit.acre.longName:a.measurementMarkupManager.unit.acre.shortName;break;case esri.tasks.GeometryService.UNIT_HECTARES:case esri.Units.HECTARES:case a.measurementMarkupManager.unit.hectare.shortName:case a.measurementMarkupManager.unit.hectare.longName:case a.measurementMarkupManager.unit.hectare.config:r=t?a.measurementMarkupManager.unit.hectare.longName:a.measurementMarkupManager.unit.hectare.shortName}return r}function m(e,t){if(!e)return null;var r=null;switch(e){case esri.Units.ACRES:case a.measurementMarkupManager.unit.acre.longName:case a.measurementMarkupManager.unit.acre.shortName:case a.measurementMarkupManager.unit.acre.config:case esri.tasks.GeometryService.UNIT_ACRES.toString():r=esri.tasks.GeometryService.UNIT_ACRES;break;case esri.Units.ARES:case esri.tasks.GeometryService.UNIT_ARES.toString():r=esri.tasks.GeometryService.UNIT_ARES;break;case a.measurementMarkupManager.unit.feet.longName:case a.measurementMarkupManager.unit.feet.shortName:case a.measurementMarkupManager.unit.feet.config:case n.DistanceUnitType.FEET:case esri.tasks.GeometryService.UNIT_FOOT.toString():case esri.Units.FEET:r=esri.tasks.GeometryService.UNIT_FOOT;break;case esri.Units.HECTARES:case a.measurementMarkupManager.unit.hectare.longName:case a.measurementMarkupManager.unit.hectare.shortName:case a.measurementMarkupManager.unit.hectare.config:case esri.tasks.GeometryService.UNIT_HECTARES.toString():r=esri.tasks.GeometryService.UNIT_HECTARES;break;case a.measurementMarkupManager.unit.kilometer.longName:case a.measurementMarkupManager.unit.kilometer.shortName:case a.measurementMarkupManager.unit.kilometer.config:case n.DistanceUnitType.KILOMETERS:case esri.tasks.GeometryService.UNIT_KILOMETER.toString():case esri.Units.KILOMETERS:r=esri.tasks.GeometryService.UNIT_KILOMETER;break;case a.measurementMarkupManager.unit.meter.longName:case a.measurementMarkupManager.unit.meter.shortName:case a.measurementMarkupManager.unit.meter.config:case n.DistanceUnitType.METERS:case esri.tasks.GeometryService.UNIT_METER.toString():case esri.Units.METERS:r=esri.tasks.GeometryService.UNIT_METER;break;case a.measurementMarkupManager.unit.mile.longName:case a.measurementMarkupManager.unit.mile.shortName:case a.measurementMarkupManager.unit.mile.config:case n.DistanceUnitType.MILES:case esri.tasks.GeometryService.UNIT_STATUTE_MILE.toString():case esri.Units.MILES:r=esri.tasks.GeometryService.UNIT_STATUTE_MILE;break;case a.measurementMarkupManager.unit.nauticalMile.longName:case a.measurementMarkupManager.unit.nauticalMile.shortName:case a.measurementMarkupManager.unit.nauticalMile.config:case n.DistanceUnitType.NAUTICAL_MILES:case esri.tasks.GeometryService.UNIT_NAUTICAL_MILE.toString():case esri.Units.NAUTICAL_MILES:r=esri.tasks.GeometryService.UNIT_NAUTICAL_MILE;break;case a.measurementMarkupManager.unit.yard.longName:case a.measurementMarkupManager.unit.yard.shortName:case a.measurementMarkupManager.unit.yard.config:case n.DistanceUnitType.YARDS:case esri.Units.YARDS:r=a.measurementMarkupManager.GCX_UNIT_YARDS;break;case esri.Units.SQUARE_CENTIMETERS:case esri.tasks.GeometryService.UNIT_SQUARE_CENTIMETERS.toString():r=esri.tasks.GeometryService.UNIT_SQUARE_CENTIMETERS;break;case esri.Units.SQUARE_DECIMETERS:case esri.tasks.GeometryService.UNIT_SQUARE_DECIMETERS.toString():r=esri.tasks.GeometryService.UNIT_SQUARE_DECIMETERS;break;case a.measurementMarkupManager.unit.sqFeet.longName:case a.measurementMarkupManager.unit.sqFeet.shortName:case a.measurementMarkupManager.unit.sqFeet.config:case esri.tasks.GeometryService.UNIT_SQUARE_FEET.toString():case esri.Units.SQUARE_FEET:r=esri.tasks.GeometryService.UNIT_SQUARE_FEET;break;case esri.Units.SQUARE_INCHES:case esri.tasks.GeometryService.UNIT_SQUARE_INCHES.toString():r=esri.tasks.GeometryService.UNIT_SQUARE_INCHES;break;case a.measurementMarkupManager.unit.sqKilometer.longName:case a.measurementMarkupManager.unit.sqKilometer.shortName:case a.measurementMarkupManager.unit.sqKilometer.config:case esri.tasks.GeometryService.UNIT_SQUARE_KILOMETERS.toString():case esri.Units.SQUARE_KILOMETERS:r=esri.tasks.GeometryService.UNIT_SQUARE_KILOMETERS;break;case a.measurementMarkupManager.unit.sqMeter.longName:case a.measurementMarkupManager.unit.sqMeter.shortName:case a.measurementMarkupManager.unit.sqMeter.config:case esri.tasks.GeometryService.UNIT_SQUARE_METERS.toString():case esri.Units.SQUARE_METERS:r=esri.tasks.GeometryService.UNIT_SQUARE_METERS;break;case a.measurementMarkupManager.unit.sqMile.longName:case a.measurementMarkupManager.unit.sqMile.shortName:case a.measurementMarkupManager.unit.sqMile.config:case esri.tasks.GeometryService.UNIT_SQUARE_MILES.toString():case esri.Units.SQUARE_MILES:r=esri.tasks.GeometryService.UNIT_SQUARE_MILES;break;case a.measurementMarkupManager.unit.sqNauticalMile.longName:case a.measurementMarkupManager.unit.sqNauticalMile.shortName:case a.measurementMarkupManager.unit.sqNauticalMile.config:r=a.measurementMarkupManager.GCX_UNIT_SQ_NAUTICAL_MILES;break;case esri.Units.SQUARE_MILLIMETERS:case esri.tasks.GeometryService.UNIT_SQUARE_MILLIMETERS.toString():r=esri.tasks.GeometryService.UNIT_SQUARE_MILLIMETERS;break;case a.measurementMarkupManager.unit.sqYard.longName:case a.measurementMarkupManager.unit.sqYard.shortName:case a.measurementMarkupManager.unit.sqYard.config:case esri.tasks.GeometryService.UNIT_SQUARE_YARDS.toString():case esri.Units.SQUARE_YARDS:r=esri.tasks.GeometryService.UNIT_SQUARE_YARDS;break;default:r=t||e}return r}function l(e,t,r){return i.addGraphicToLayer(e,t,r)}function p(e,t,r){return i.getInternalGraphicsLayer(e,r,i.GraphicsLayerType.Label)}function c(e,t,r,a){for(var n=!0,i=null,s=_(e),o=function(e){if(n){var s=document.getElementById(a+"_layer");i=document.createElementNS("http://www.w3.org/2000/svg","text"),i.setAttributeNS(null,"font-size",r),i.setAttributeNS(null,"font-family",t),i.setAttributeNS(null,"visibility","hidden"),i.textContent=e,s.appendChild(i),n=!1}else i.textContent=e;var o=i.getBBox();return b=null===b?o.height:b,E[e]=i.getComputedTextLength(),E[e]},u=M(e),m=0,l=0;u&&l<u.length;l++){for(var p=e.length,c=0,h=0;h<p;h++){var g=u[l].charAt(h);g=" "===g?".":g,c+=E.hasOwnProperty(g)?E[g]:o(g)}c>m&&(m=c)}return{width:Math.ceil(m),height:Math.ceil(b*s)}}function h(e){if(!e||!e.mapPointStart||!e.mapPointEnd)return null;var t=a.measurementMarkupManager.app.map.toScreen(e.mapPointStart),r=a.measurementMarkupManager.app.map.toScreen(e.mapPointEnd),n=Math.abs(r.x-t.x),i=Math.abs(r.y-t.y);return Math.sqrt(n*n+i*i)}function g(e,t,r,a){var n=new esri.Graphic;new dojo.Color(t);n.geometry=e,n.symbol=s.defaultMarkerSymbol(),n.symbol.setColor(new esri.Color(t)),this.addGraphicToLayer(n,r,a)}function d(e,t,n,i,s,u,m,l,p,c,h,g,d,M,y,f){void 0===u&&(u=!1),void 0===m&&(m=0),void 0===l&&(l=0),void 0===p&&(p="Arial"),void 0===c&&(c="12px"),void 0===h&&(h=new esri.Color("white")),void 0===g&&(g=new esri.Color("black")),void 0===d&&(d=null),void 0===M&&(M=0),void 0===y&&(y=0),void 0===f&&(f=!1);var S={};S.layerId=i,S.mapPoint=t,S.text=e,S.labelXoffset=m,S.labelYoffset=l,S.fontFamily=p,S.fontSize=c,S.cornerRadius=M,S.angle=y,S.anchor=o.HighlightedLabelAnchor.MIDDLE,S.textColor=h,S.highlightColor=g,S.highlightOutlineSymbol=d;var k,b=!1;_(e);return v?(v.textGraphics&&v.textGraphics.length>0&&v.textGraphics[0].getLayer()&&v.highlightGraphic.getLayer()&&(b=!0),v.isVisible()&&v.hide()):u&&(S.anchor=o.HighlightedLabelAnchor.BOTTOM_LEFT,v=new r.HighlightedMeasurementLabel(S,s)),u?(k=v,k.update(t,e)):k=new r.HighlightedMeasurementLabel(S,s),!u&&n&&k.assignMeasurementId(n),(!u||u&&!b)&&(k.addToMapGraphicLayer(),u||a.measurementMarkupManager.addedMapGraphics.push(k)),f?k.show():k.hide(),k}function M(e){return e.split(L)}function y(e,t,r){return"M0,0h"+(e-r)+"a"+r+","+r+" 0 0 1 "+r+","+r+"v"+(t-2*r)+"a"+r+","+r+" 0 0 1 "+-r+","+r+"h"+(r-e)+"a"+r+","+r+" 0 0 1 "+-r+","+-r+"v"+(2*r-t)+"a"+r+","+r+" 0 0 1 "+r+","+-r+"z"}function _(e){return(L.test(e)?e.match(L).length:0)+1}function f(e,t,r,a){void 0===r&&(r="Arial"),void 0===a&&(a="12px");var n=this.getLabelSize(e,r,a),i=.5*n.height,s=n.width+i,o=n.height+i;if(t){t.setStyle("STYLE_PATH");var u="M0,0h"+s+"v"+o+"h-"+s+"z";t.setPath(u)}return t}function S(e,t,r){var n=0;switch(t){case esri.tasks.GeometryService.UNIT_METER:n=3.280839895013*e;break;case esri.tasks.GeometryService.UNIT_KILOMETER:n=3280.839895013123*e;break;case esri.tasks.GeometryService.UNIT_STATUTE_MILE:n=5280*e;break;case esri.tasks.GeometryService.UNIT_NAUTICAL_MILE:n=6076.12*e;break;case a.measurementMarkupManager.GCX_UNIT_YARDS:n=3*e;break;default:n=e}switch(r){case esri.tasks.GeometryService.UNIT_METER:return n/3.280839895013;case esri.tasks.GeometryService.UNIT_KILOMETER:return n/3280.839895013123;case esri.tasks.GeometryService.UNIT_STATUTE_MILE:return n/5280;case esri.tasks.GeometryService.UNIT_NAUTICAL_MILE:return n/6076.12;case a.measurementMarkupManager.GCX_UNIT_YARDS:return n/3;default:return n}}function k(e,t,r){var n=0;switch(t){case esri.tasks.GeometryService.UNIT_SQUARE_METERS:n=10.76391041670891*e;break;case esri.tasks.GeometryService.UNIT_SQUARE_KILOMETERS:n=10763910.41670972*e;break;case esri.tasks.GeometryService.UNIT_SQUARE_MILES:n=27878400*e;break;case esri.tasks.GeometryService.UNIT_SQUARE_YARDS:n=9*e;break;case esri.tasks.GeometryService.UNIT_ACRES:n=43560*e;break;case esri.tasks.GeometryService.UNIT_HECTARES:n=107639*e;break;case a.measurementMarkupManager.GCX_UNIT_SQ_NAUTICAL_MILES:n=36919234.2544*e;break;default:n=e}switch(r){case esri.tasks.GeometryService.UNIT_SQUARE_METERS:return n/10.76391041670891;case esri.tasks.GeometryService.UNIT_SQUARE_KILOMETERS:return n/10763910.41670972;case esri.tasks.GeometryService.UNIT_SQUARE_MILES:return n/27878400;case a.measurementMarkupManager.GCX_UNIT_SQ_NAUTICAL_MILES:return n/36919234.2544;case esri.tasks.GeometryService.UNIT_SQUARE_YARDS:return n/9;case esri.tasks.GeometryService.UNIT_ACRES:return n/43560;case esri.tasks.GeometryService.UNIT_HECTARES:return n/107639;default:return n}}var v=null,b=null,E={},L=/\r\n|\r|\n/g;t.getUnitString=u,t.getGeometryServiceUnitConstant=m,t.addGraphicToLayer=l,t.getGraphicsLayer=p,t.getLabelSize=c,t.getRenderedLineSegmentLength=h,t.plotPointOnMap=g,t.addHighlightedLabelToMap=d,t.getTextLines=M,t.svgRoundedRectanglePath=y,t.refreshHighlightSymbolSize=f,t.convertLength=S,t.convertArea=k})},"Mapping/modules/Measurement/MeasurementView":function(){define(["require","exports","geocortex/framework/ui/ViewBase"],function(e,t,r){"use strict";var a=function(e){function t(t,r){var a=e.call(this,t,r)||this;return a.measurementSwitcherView=null,a}return __extends(t,e),t.prototype.attach=function(t){e.prototype.attach.call(this,t),this.measurementSwitcherView=this.app.viewManager.getViewById("MeasurementUnitSwitcherView")},t.prototype.activateUnitSwitcherView=function(){this.measurementSwitcherView&&!this.measurementSwitcherView.isActive&&this.app.command("ActivateView").execute("MeasurementUnitSwitcherView")},t.prototype.deactivateUnitSwitcherView=function(){this.measurementSwitcherView&&this.measurementSwitcherView.isActive&&this.app.command("DeactivateView").execute("MeasurementUnitSwitcherView")},t.prototype.handleClickClose=function(){this.deactivateUnitSwitcherView(),this.app.command("ClearActiveTool").execute()},t.prototype.handleShowLengthSwitcher=function(){this.viewModel.measurementInProgress.get()||(this.viewModel.lengthSwitcherSelected.set(!0),this.activateUnitSwitcherView())},t.prototype.handleShowAreaSwitcher=function(){this.viewModel.measurementInProgress.get()||(this.viewModel.lengthSwitcherSelected.set(!1),this.activateUnitSwitcherView())},t.prototype.handleSetLengthUnits=function(e,t,r){this.viewModel.selectedLengthUnits.set(r),this.deactivateUnitSwitcherView()},t.prototype.handleSetAreaUnits=function(e,t,r){this.viewModel.selectedAreaUnits.set(r),this.deactivateUnitSwitcherView()},t}(r.ViewBase);t.MeasurementView=a})},"Mapping/modules/Measurement/MeasurementViewModel":function(){define(["require","exports","geocortex/framework/ui/ViewModelBase","geocortex/framework/observables","./MeasurementModule","./MeasurementUtils","./Descriptors/DescriptorBase","geocortex/infrastructure/GraphicUtils","geocortex/infrastructure/GraphicsLayerUtils","geocortex/infrastructure/coordinates/CoordinateUtils","geocortex/infrastructure/SymbolUtils","geocortex/infrastructure/GraphicsLayerIds"],function(e,t,r,a,n,i,s,o,u,m,l,p){"use strict";var c=function(e){function t(t,r){var a=e.call(this,t,r)||this;return a.measurementGraphicId=0,a._lineColor=null,a._fillColor=null,a._textColor=null,a._highlightColor=null,a._outlineColor=null,a._outlineWidth=null,a._totalMeasurementTextColor=null,a._totalMeasurementHighlightColor=null,a._totalMeasurementOutlineColor=null,a._totalMeasurementOutlineWidth=null,a._lineDescriptionFormat=null,a._highlightRadius=null,a._textSize=null,a._textOffset=null,a._count=-1,a._markupLayer=null,a._measurementLayer=null,a._currentMarkupSegmentGraphics=[],a._temporaryMarkupSegmentGraphics=[],a._isRestoringState=!1,a._labelSizeAdjustmentFactor=1.25,a._defaultTextOffset=0,a._defaultOutlineWidth=0,a._defaultHighlightRadius=5,a._flipLabelThreshold=1e3,a}return __extends(t,e),t.prototype.initialize=function(e){var t=this;e=e||{},this._lineColor=e.lineColor?new esri.Color(e.lineColor):null,this._fillColor=e.fillColor?new esri.Color(e.fillColor):null,this._textColor=e.textColor?new esri.Color(e.textColor):null,this._highlightColor=e.highlightColor?new esri.Color(e.highlightColor):null,this._outlineColor=e.outlineColor?new esri.Color(e.outlineColor):null,this._outlineWidth=void 0!=e.outlineWidth?parseFloat(e.outlineWidth):this._defaultOutlineWidth,this._totalMeasurementTextColor=e.totalMeasurementTextColor?new esri.Color(e.totalMeasurementTextColor):null,this._totalMeasurementHighlightColor=e.totalMeasurementHighlightColor?new esri.Color(e.totalMeasurementHighlightColor):null,this._totalMeasurementOutlineColor=e.totalMeasurementOutlineColor?new esri.Color(e.totalMeasurementOutlineColor):null,this._totalMeasurementOutlineWidth=void 0!=e.totalMeasurementOutlineWidth?parseFloat(e.totalMeasurementOutlineWidth):this._defaultOutlineWidth,this._lineDescriptionFormat=e.lineDescriptionFormat?e.lineDescriptionFormat:"{0}",this._highlightRadius=void 0!=e.highlightRadius?parseInt(e.highlightRadius):this._defaultHighlightRadius,this._textSize=e.textSize?e.textSize:"12px",this._textOffset=void 0!=e.textOffset?parseInt(e.textOffset):this._defaultTextOffset,this._textAboveMarkup=void 0!=e.textAboveMarkup&&e.textBelowMarkup,this._flipLabelThreshold=void 0!=e.disablePolygonLabelFlipThreshold?parseInt(e.disablePolygonLabelFlipThreshold):1e3,this.addMarkupToMap=new a.Observable(e.addMarkupToMapByDefault||!1),n.measurementMarkupManager._setLayerIds(p.MARKUP_LAYER_ID,p.MEASUREMENT_LAYER_ID),n.measurementMarkupManager._setMapTipPresentation(this._totalMeasurementTextColor,this._totalMeasurementHighlightColor,this._totalMeasurementOutlineColor,this._totalMeasurementOutlineWidth,this._highlightRadius,this._textSize),this._textFont=new esri.symbol.Font,this._textFont.setSize(this._textSize),this._textFont.setFamily("Arial"),this.lengthUnits=new a.ObservableCollection([n.measurementMarkupManager.unit.feet.longName,n.measurementMarkupManager.unit.yard.longName,n.measurementMarkupManager.unit.meter.longName,n.measurementMarkupManager.unit.kilometer.longName,n.measurementMarkupManager.unit.mile.longName,n.measurementMarkupManager.unit.nauticalMile.longName]),this.areaUnits=new a.ObservableCollection([n.measurementMarkupManager.unit.sqFeet.longName,n.measurementMarkupManager.unit.sqYard.longName,n.measurementMarkupManager.unit.sqMeter.longName,n.measurementMarkupManager.unit.sqKilometer.longName,n.measurementMarkupManager.unit.sqMile.longName,n.measurementMarkupManager.unit.sqNauticalMile.longName,n.measurementMarkupManager.unit.acre.longName,n.measurementMarkupManager.unit.hectare.longName]),this.selectedAreaUnits=new a.Observable(i.getUnitString(n.measurementMarkupManager._areaUnitString,!0)),
this.selectedAreaUnitShort=new a.Observable(i.getUnitString(n.measurementMarkupManager._areaUnitString)),this.selectedLengthUnits=new a.Observable(i.getUnitString(n.measurementMarkupManager._lengthUnitString,!0)),this.selectedLengthUnitShort=new a.Observable(i.getUnitString(n.measurementMarkupManager._lengthUnitString)),this.measurementInProgress=new a.Observable((!1)),this.descriptorContainerEmpty=new a.Observable((!0)),this.lengthSwitcherSelected=new a.Observable((!0)),this.eraseActive=new a.Observable((!1)),this.measurementInProgress.sync(n.measurementMarkupManager.measurementInProgress),this.descriptorContainerEmpty.sync(n.measurementMarkupManager.descriptorContainerEmpty),this.selectedAreaUnits.bind(this,function(e){t._isRestoringState||t.app.command("SetMeasurementUnits").execute(t.selectedLengthUnits.get(),e),t.selectedAreaUnitShort.set(i.getUnitString(n.measurementMarkupManager._areaUnitString))}),this.selectedLengthUnits.bind(this,function(e){t._isRestoringState||t.app.command("SetMeasurementUnits").execute(e,t.selectedAreaUnits.get()),t.selectedLengthUnitShort.set(i.getUnitString(n.measurementMarkupManager._lengthUnitString))}),this.addMarkupToMap.bind(this,function(e){e?(t._currentMarkupSegmentGraphics=t._temporaryMarkupSegmentGraphics.slice(0),t._temporaryMarkupSegmentGraphics=[]):(t._temporaryMarkupSegmentGraphics=t._currentMarkupSegmentGraphics.slice(0),t._currentMarkupSegmentGraphics=[])}),this._registerCommands()},t.prototype._registerCommands=function(){var e=this;this.app.command("DeleteMeasurement").register(this,this._executeDeleteMeasurementCommand,this._canExecuteDeleteMeasurementCommand),this.app.command("_addLineSegmentMeasurementMarkup").register(this,this._executeAddLineSegmentMeasurementMarkup,this._canExecuteAddMarkup),this.app.command("_addCompletedGeometryMeasurementMarkup").register(this,this._executeAddCompletedGeometryMeasurementMarkup,this._canExecuteAddMarkup),this.app.command("_addGeometryMarkup").register(this,this._executeAddGeometryMarkup,this._canExecuteAddMarkup),this.app.command("_clearMeasurementMarkup").register(this,this._executeClearMeasurementMarkup),this.app.command("_applyMeasurementUnits").register(this,function(t,r){e._isRestoringState=!0,e.selectedLengthUnits.set(i.getUnitString(t,!0)),e.selectedAreaUnits.set(i.getUnitString(r,!0)),e._isRestoringState=!1})},t.prototype._canExecuteAddMarkup=function(e){return this._markupLayer&&this._measurementLayer||(this._markupLayer=u.getInternalGraphicsLayer(p.MARKUP_LAYER_ID,this.app,u.GraphicsLayerType.Markup),this._measurementLayer=u.getInternalGraphicsLayer(p.MEASUREMENT_LAYER_ID,this.app,u.GraphicsLayerType.Label),this._markupLayer&&this._measurementLayer&&(n.measurementMarkupManager._measurementLayersCreated=!0)),!!(e&&e.geometry&&this._markupLayer&&this._measurementLayer)},t.prototype._canExecuteDeleteMeasurementCommand=function(e){return!!e},t.prototype._executeAddGeometryMarkup=function(e){e.type===s.DescriptorType.POLYGON?(this._fillColor&&(e.graphicSymbol.setColor(this._fillColor),e.graphicSymbol.color.a=.4),this._lineColor&&e.graphicSymbol.outline.setColor(this._lineColor)):this._lineColor&&e.graphicSymbol.setColor(this._lineColor);var t=e.addToMap(p.MARKUP_LAYER_ID);this.app.command("EditMarkup").raiseCanExecuteChanged(),this.app.command("DeleteMarkup").raiseCanExecuteChanged(),this.app.command("ClearMarkup").raiseCanExecuteChanged(),this.app.command("ExportMarkupLayer").raiseCanExecuteChanged(),e.type===s.DescriptorType.LINE_SEGMENT?this._temporaryMarkupSegmentGraphics.push(t):this.addMarkupToMap.get()?this._currentMarkupSegmentGraphics.push(t):this._temporaryMarkupSegmentGraphics.push(t)},t.prototype._executeAddLineSegmentMeasurementMarkup=function(e,t,r){if(!e||!e.geometry)return void this._tryErrorCallback(r,new Error("LineSegment or geometry not defined"));if(e.isActive&&(this.addMarkupToMap.get()||n.measurementMarkupManager._currentGeometryInProcess&&n.measurementMarkupManager._currentGeometryInProcess.id===e.id)){var a=n.measurementMarkupManager.formatMeasurement(e.length,n.measurementMarkupManager.measurementFractionalDigits)+" "+e.unitStr,s=m.formatAngle(e.getAngle(),n.measurementMarkupManager.degreeFormat,this.app,n.measurementMarkupManager.coordinateFractionalDigits),o=this._lineDescriptionFormat.format(a,s,e.getQuadrantBearing());this._setLineSegmentSymbols(e);var u=e.getAngleDegree(),l=e.getLabelLocation();e.highlightedLabelGraphic=i.addHighlightedLabelToMap(o,l,null,p.MEASUREMENT_LAYER_ID,this.app,!1,this._textOffset,this._textOffset,this._textFont.family,this._textSize,this._textColor,this._highlightColor,this._outlineWidth>0?new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,this._outlineColor,this._outlineWidth):null,this._highlightRadius,u),e.showLabel=e.highlightedLabelGraphic.getWidth()*this._labelSizeAdjustmentFactor<i.getRenderedLineSegmentLength(e),e.showLabel&&!e.highlightedLabelGraphic.isVisible()&&e.highlightedLabelGraphic.show(),t&&t(e)}},t.prototype._executeAddCompletedGeometryMeasurementMarkup=function(e,t,r){var a=null;if(e&&e.isActive&&(this.addMarkupToMap.get()||n.measurementMarkupManager._currentGeometryInProcess&&n.measurementMarkupManager._currentGeometryInProcess.id===e.id)){switch(e.type){case s.DescriptorType.POLYGON:var o=(e.geometry,e._lineSegments.length,e.geometry),u=o.getExtent();a=u?u.getCenter():null,!o.contains(a)&&e.simplifiedGeometry&&(a=e.simplifiedGeometry.getCentroid()||a),e.labelStr=n.measurementMarkupManager.getResource("language-measurement-polygon-final-markup-label").format(n.measurementMarkupManager.formatMeasurement(e.area,n.measurementMarkupManager.measurementFractionalDigits),e.areaUnitStr,n.measurementMarkupManager.formatMeasurement(e.length,n.measurementMarkupManager.measurementFractionalDigits),e.unitStr),this.app.command("LogOptimizerEvent").execute("MeasureAreaTool","MeasureArea");break;case s.DescriptorType.POLYLINE:e.labelStr=n.measurementMarkupManager.getResource("language-measurement-polyline-final-markup-label").format(n.measurementMarkupManager.formatMeasurement(e.length,n.measurementMarkupManager.measurementFractionalDigits),e.unitStr),a=e._lineSegments[e._lineSegments.length-1].mapPointEnd,this.app.command("LogOptimizerEvent").execute("MeasureDistanceTool","MeasureDistance");break;default:this._tryErrorCallback(r,new Error("Invalid Geometry Descriptor"))}e.highlightedLabelGraphic=i.addHighlightedLabelToMap(e.labelStr,a,e.id,p.MEASUREMENT_LAYER_ID,this.app,!1,this._textOffset,this._textOffset,"Arial",this._textSize,this._totalMeasurementTextColor,this._totalMeasurementHighlightColor,this._totalMeasurementOutlineWidth>0?new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,this._totalMeasurementOutlineColor,this._totalMeasurementOutlineWidth):null,this._highlightRadius,0,!0),n.measurementMarkupManager.measurementCompleted(),e.setInactive(),this.app.event("MeasurementMarkupAdded").publish({graphic:e.graphic,measurementDescriptor:e}),t&&t(e)}},t.prototype._executeDeleteMeasurementCommand=function(e){var t=this,r=[p.MARKUP_LAYER_ID,p.MEASUREMENT_LAYER_ID],a="language-measurement-erase-multiple-prompt",i="language-measurement-erase-multiple-prompt-title",s=function(e){if(e&&e.length)for(var r=0;r<e.length;r++)e[r].hasOwnProperty("measurementId")&&n.measurementMarkupManager.destroyDescriptor(e[r].measurementId);var a=t.app.toolRegistry.getActiveTool();n.measurementMarkupManager.descriptorContainerEmpty.get()&&a&&"DeleteMeasurementTool"===a.name&&t.app.command("ClearActiveTool").execute()};o.deleteMarkup(e,r,this.app,s,!0,a,i,this.libraryId),this.app.command("LogOptimizerEvent").execute("DeleteMeasurementTool","DeleteMeasurement")},t.prototype._executeClearMeasurementMarkup=function(e,t){var r=this;if("all"===e){var a=this.app.getResource(this.libraryId,"language-measurement-clear-all-prompt"),n=this.app.getResource(this.libraryId,"language-measurement-clear-all-prompt-title");this.app.command("StopEditingMarkup").execute(),this.app.command("Confirm").execute(a,n,function(a){a&&r._clearMarkup(e,t)})}else this._clearMarkup(e,t)},t.prototype._clearMarkup=function(e,t){switch(void 0===e&&(e="all"),void 0===t&&(t=!1),e){case"all":n.measurementMarkupManager.destroyAllDescriptors(),this.app.command("LogOptimizerEvent").execute("ClearMeasurementTool","ClearAllMeasurements");break;case"temporary":for(var r=0;r<this._temporaryMarkupSegmentGraphics.length;r++){var a=this._temporaryMarkupSegmentGraphics[r];a&&a.measurementId&&n.measurementMarkupManager.destroyDescriptor(a.measurementId)}break;case"current":for(var r=0;r<this._currentMarkupSegmentGraphics.length;r++){var a=this._currentMarkupSegmentGraphics[r];a&&a.measurementId&&n.measurementMarkupManager.destroyDescriptor(a.measurementId)}}n.measurementMarkupManager._currentGeometryInProcess&&!n.measurementMarkupManager._currentGeometryInProcess.graphic&&n.measurementMarkupManager.destroyDescriptor(n.measurementMarkupManager._currentGeometryInProcess.id),("temporary"===e||"all"===e||t)&&(this._temporaryMarkupSegmentGraphics=[]),("current"===e||"all"===e||t)&&(this._currentMarkupSegmentGraphics=[])},t.prototype._setLineSegmentSymbols=function(e){e.graphicSymbol||(e.graphicSymbol=l.defaultLineSymbol(),this._lineColor&&e.graphicSymbol.setColor(this._lineColor))},t.prototype._tryErrorCallback=function(e,t){e&&e(t)},t}(r.ViewModelBase);t.MeasurementViewModel=c})},"Mapping/modules/Measurement/Descriptors/DescriptorBase":function(){define(["require","exports","./../HighlightedMeasurementLabel","geocortex/infrastructure/GraphicsLayerUtils","geocortex/infrastructure/highlightedLabel/HighlightedLabelGraphic"],function(e,t,r,a,n){"use strict";var i;!function(e){e[e.LINE_SEGMENT=0]="LINE_SEGMENT",e[e.POLYLINE=1]="POLYLINE",e[e.POLYGON=2]="POLYGON"}(i=t.DescriptorType||(t.DescriptorType={}));var s=function(){function e(e,t,r){this.id="",this.geometry=null,this.type=null,this.length=null,this.lengthUnit=null,this.unitStr=null,this.labelStr=null,this.spatialReference=null,this.graphic=null,this.graphicSymbol=null,this.isActive=!0,this.feature=null,this.highlightedLabelGraphic=null,this.app=r,this.type=e,this.spatialReference=t}return e.prototype.addSegment=function(e){},e.prototype.setMeasurementUnit=function(e,t){},e.prototype.setGeometry=function(e){},e.prototype.addToMap=function(e,t){var r=null;return this.isActive&&(t||this.graphic||(this.graphic=new esri.Graphic,this.graphic.geometry=this.geometry,this.graphic.symbol=this.graphicSymbol),r=t?t:this.graphic,r.measurementId=this.id,r=a.addGraphicToLayer(r,e,this.app)?r:null),r},e.prototype.updateFeature=function(){if(this.feature||(this.feature=new esri.Graphic,this.feature.geometry=this._polygonToPolyLine(this.geometry),this.feature.symbol=this.graphicSymbol),this.feature.setAttributes(this._createAttributes()),this.graphic){this.graphic.setAttributes(this._createAttributes());var e={graphic:this.graphic};this.app.eventRegistry.event("GraphicAttributesChangedEvent").publish(e)}},e.prototype.exportState=function(){return{id:this.id,geometry:this.app.project.convert.fromEsriGeometry(this.geometry),length:this.length,type:this.type,spatialReference:this.app.project.convert.fromEsriSpatialReference(this.spatialReference),graphic:this.app.project.convert.fromEsriGraphic(this.graphic),feature:this.app.project.convert.fromEsriGraphic(this.feature),label:this.highlightedLabelGraphic?this.highlightedLabelGraphic.exportState(this.app):null}},e.prototype.applyState=function(e,t,a){var i=this,s=this.app.project.convert,o={graphic:s.toEsriGraphic(e.graphic),feature:s.toEsriGraphic(e.feature),label:n.HighlightedLabelGraphic.fromExportedState(e.label,this.app,r.HighlightedMeasurementLabel.prototype)};return Promise.props(o).then(function(r){i.id=e.id,i.geometry=s.toEsriGeometry(e.geometry),i.length=e.length,i.type=e.type,i.spatialReference=s.toEsriSpatialReference(e.spatialReference),i.graphic=r.graphic,i.feature=r.feature,i.lengthUnit=t,i.unitStr=a,i.highlightedLabelGraphic=r.label})},e.prototype._createAttributes=function(){throw new Error("DescriptorBase._createAttributes is abstract and must be overridden in derived classes.")},e.prototype._polygonToPolyLine=function(e){if(!e||"polygon"!==e.type)return e;var t=new esri.geometry.Polyline(e.rings);return t.setSpatialReference(e.spatialReference),t},e}();t.DescriptorBase=s})},"Mapping/modules/Measurement/Descriptors/GeometryDescriptor":function(){define(["require","exports","./DescriptorBase","./LineSegmentDescriptor","geocortex/infrastructure/FeatureSet","geocortex/infrastructure/SymbolUtils","geocortex/infrastructure/tools/MapTool","./../MeasurementModule","./../MeasurementUtils","geocortex/essentials/GeometryUtilities","geocortex/infrastructure/tools/DrawMode","geocortex/infrastructure/coordinates/CoordinateUtils","geocortex/essentials/Field"],function(e,t,r,a,n,i,s,o,u,m,l,p,c){"use strict";var h=function(e){function t(t,a,n,o){var u=e.call(this,a,n,o)||this;u._lineSegments=[],u.showHighlightedLabel=!0,u.editingInProgress=!1,u.originalZoomLevel=0,u.id=t,u.length=0,u.originalZoomLevel=o.map.getZoom(),a===r.DescriptorType.POLYGON?(u.graphicSymbol=i.defaultFillSymbol(),u.area=0,u.areaUnit=null,u.areaUnitStr=null,u.simplifiedGeometry=null):u.graphicSymbol=i.defaultLineSymbol();var m=u.app.toolRegistry.getActiveTool();return m&&m instanceof s.MapTool&&(u.drawMode=m.drawMode),u}return __extends(t,e),t.prototype.addSegment=function(e){e.id=this.id,e.isActive=this.isActive,null==this.lengthUnit&&null!=e.lengthUnit&&(e.unitStr?(this.lengthUnit=e.lengthUnit,this.unitStr=e.unitStr):(this.setMeasurementUnit(e.lengthUnit),e.unitStr=this.unitStr)),null!=this.lengthUnit&&null!=e.lengthUnit&&this.lengthUnit!=e.lengthUnit&&o.measurementMarkupManager._reportStatus("GeometryDescriptor: Added line segment unit differs from geometry.","error",!0),e.length?this.length=this.length?this.length+e.length:e.length:o.measurementMarkupManager._reportStatus("GeometryDescriptor: Line Segment added without computing length or length 0. Total geometry length not updated.","warning",!1),e.graphicSymbol&&!this.graphicSymbol&&this.type===r.DescriptorType.POLYLINE&&(this.graphicSymbol=new esri.symbol.SimpleLineSymbol(e.graphicSymbol.toJson())),this._lineSegments.push(e)},t.prototype.setMeasurementUnit=function(e,t){var a=!1;if((null!=this.areaUnit&&this.areaUnit!=t||null==this.areaUnit&&t&&this.type===r.DescriptorType.POLYGON)&&(this.area&&null!=this.areaUnit&&(this.area=u.convertArea(this.area,this.areaUnit,t)),this.areaUnit=t,this.areaUnitStr=u.getUnitString(this.areaUnit),a=!0),null!=this.lengthUnit&&this.lengthUnit!=e||null==this.lengthUnit&&null!=e){this.length=0;for(var n=0;n<this._lineSegments.length;n++)this._lineSegments[n].setMeasurementUnit(e),this.length+=this._lineSegments[n].length;this.unitStr=u.getUnitString(e),this.lengthUnit=e,a=!0}if(a&&(this.labelStr=this.type===r.DescriptorType.POLYLINE?o.measurementMarkupManager.getResource("language-measurement-polyline-final-markup-label").format(o.measurementMarkupManager.formatMeasurement(this.length,o.measurementMarkupManager.measurementFractionalDigits),this.unitStr):o.measurementMarkupManager.getResource("language-measurement-polygon-final-markup-label").format(o.measurementMarkupManager.formatMeasurement(this.area,o.measurementMarkupManager.measurementFractionalDigits),this.areaUnitStr,o.measurementMarkupManager.formatMeasurement(this.length,o.measurementMarkupManager.measurementFractionalDigits),this.unitStr),this.highlightedLabelGraphic&&this.highlightedLabelGraphic.refresh(this.labelStr),this.measurementData)){this.updateFeature(),null!=this.measurementData.features.getAt(0)&&this.measurementData.features.getAt(0).loadAttributes(!1);for(var i=1;i<this.measurementData.features.length();i++)this._lineSegments[i-1].updateFeature(),this._lineSegments[i-1].feature.attributes.Segment=i.toString(),this.measurementData.features.getAt(i).loadAttributes(!1);this._formatMeasurementData();for(var i=0;i<this.measurementData.features.length();i++)this.app.event("FeatureChangedEvent").publish(this.measurementData.features.getAt(i))}},t.prototype.setGeometry=function(e){return m.spatialRefsAreEqual(e.spatialReference,this.spatialReference,!1)?void(this.geometry=e):void o.measurementMarkupManager._reportStatus("GeometryDescriptor: setGeometry error: Invalid Spatial Reference","error",!0)},t.prototype.refreshLabelVisibilities=function(){if(!this.editingInProgress){this.showHighlightedLabel=!1;for(var e=this.app.map.getZoom()>=this.originalZoomLevel,t=0;t<this._lineSegments.length;t++)this._lineSegments[t].refreshLabelVisibility(),this.showHighlightedLabel=this.showHighlightedLabel||e||this._lineSegments[t].showLabel;this.showHighlightedLabel?this.highlightedLabelGraphic&&this.highlightedLabelGraphic.highlightGraphic&&this.highlightedLabelGraphic.textGraphics&&this.highlightedLabelGraphic.textGraphics.length>0&&(this.highlightedLabelGraphic.moveToTop(),this.highlightedLabelGraphic.show()):this.highlightedLabelGraphic&&this.highlightedLabelGraphic.highlightGraphic&&this.highlightedLabelGraphic.textGraphics&&this.highlightedLabelGraphic.textGraphics.length>0&&this.highlightedLabelGraphic.hide()}},t.prototype.refreshMeasurementData=function(){var e=this.drawMode||l.DrawMode.POLYGON,t=new esri.tasks.FeatureSet;this.updateFeature(),t.features.push(this.feature);var r=[l.DrawMode.CIRCLE,l.DrawMode.ELLIPSE,l.DrawMode.FREEHAND_POLYGON,l.DrawMode.FREEHAND_POLYLINE];if(r.indexOf(this.drawMode)<0)for(var a=0;a<this._lineSegments.length;a++)this._lineSegments[a].updateFeature(),this._lineSegments[a].feature.attributes.Segment=(a+1).toString(),t.features.push(this._lineSegments[a].feature);if(this.measurementData?(this.measurementData.esriFeatureSet=t,this.measurementData.loadFeatures()):(this.measurementData=new n.FeatureSet({esriFeatureSet:t}),this.measurementData.displayName.set(this._getDisplayName()),this.measurementData.isSelectedInCollection.set(!0),this.measurementData.isMeasurement=!0,this._setAttributeMetadata(this.measurementData.attributes)),this._formatMeasurementData(),o.measurementMarkupManager.measurementResultTypes.indexOf(e)>=0){var i=o.measurementMarkupManager.getMeasurementResultsCollection();i.featureSets.addItem(this.measurementData),this.app.featureSetManager.openCollection(i.id),this.app.featureSetManager.closeCollection(i.id)}},t.prototype.setInactive=function(){this.isActive=!1;for(var e=0;e<this._lineSegments.length;e++)this._lineSegments[e].isActive=!1},t.prototype.exportState=function(){var t=e.prototype.exportState.call(this);return t.area=this.area,t.simplifiedGeometry=this.app.project.convert.fromEsriGeometry(this.simplifiedGeometry),t.drawMode=this.drawMode,t.measurementData=this.app.project.convert.fromGcxFeatureSet(this.measurementData),t.originalZoomLevel=this.originalZoomLevel,t.segments=this._lineSegments.map(function(e){return e.exportState()}),t},t.prototype.applyState=function(t){var r=this,n={measurementData:this.app.project.convert.toGcxFeatureSet(t.measurementData),segments:Promise.map(t.segments,function(e){var t=new a.LineSegmentDescriptor(r.spatialReference,r.app);return t.applyState(e)["return"](t)})};return e.prototype.applyState.call(this,t,o.measurementMarkupManager._lengthUnit,o.measurementMarkupManager._lengthUnitString).then(function(){return Promise.props(n)}).then(function(e){r.area=t.area,r.simplifiedGeometry=r.app.project.convert.toEsriGeometry(t.simplifiedGeometry),r.drawMode=t.drawMode,r.measurementData=e.measurementData,r.originalZoomLevel=r.originalZoomLevel,r._lineSegments=e.segments,r.areaUnit=o.measurementMarkupManager._areaUnit,r.areaUnitStr=o.measurementMarkupManager._areaUnitString,r.refreshLabelVisibilities()})},t.prototype._createAttributes=function(){var e={};return e.Segment=o.measurementMarkupManager.getResource("language-measurement-results-total"),e.X=this._lineSegments[0].mapPointStart.x,e.Y=this._lineSegments[0].mapPointStart.y,e.Length=this.length,e.Units=this.unitStr,e.Area=this.area,e["Area Units"]=this.areaUnitStr,e.Angle=0,e.Bearing="",e},t.prototype._formatMeasurementData=function(){for(var e=0;e<this.measurementData.features.length();e++){var t=this.measurementData.features.getAt(e);0==e?(t.labelFormat.set(o.measurementMarkupManager.getResource("language-measurement-results-feature-label-total").format(this.measurementData.displayName.get())),t.descriptionFormat.set(o.measurementMarkupManager.getResource("language-measurement-results-feature-description-"+this.geometry.type))):(t.labelFormat.set(o.measurementMarkupManager.getResource("language-measurement-results-feature-label-segment").format(this.measurementData.displayName.get(),e)),t.descriptionFormat.set(o.measurementMarkupManager.getResource("language-measurement-results-feature-description-segment")));for(var r=0;r<t.attributes.length();r++){var a=t.attributes.getAt(r),n=a.name.get(),i=a.value.get();0!=e||"X"!=n&&"Y"!=n&&"Angle"!=n?(e>0||"polyline"===this.geometry.type)&&"Area"===n?a.presentableValue.set(""):"X"===n||"Y"==n?a.presentableValue.set(o.measurementMarkupManager.formatMeasurement(i,o.measurementMarkupManager.coordinateFractionalDigits)):"Length"===n||"Area"===n?a.presentableValue.set(o.measurementMarkupManager.formatMeasurement(i,o.measurementMarkupManager.measurementFractionalDigits)):"Angle"===n&&a.presentableValue.set(p.formatAngle(i,o.measurementMarkupManager.degreeFormat,this.app,o.measurementMarkupManager.coordinateFractionalDigits)):a.presentableValue.set("")}this._setAttributeMetadata(t.attributes)}},t.prototype._setAttributeMetadata=function(e){for(var t=0;t<e.length();t++){var r=e.getAt(t),a=r.name.get();switch(a){case"Segment":r.displayName.set(o.measurementMarkupManager.getResource("language-measurement-results-field-segment")),r.type.set(c.EssentialsFieldTypes.essentialsFieldTypeString);break;case"X":r.displayName.set(o.measurementMarkupManager.getResource("language-measurement-results-field-x")),r.type.set(c.EssentialsFieldTypes.essentialsFieldTypeDouble);break;case"Y":r.displayName.set(o.measurementMarkupManager.getResource("language-measurement-results-field-y")),r.type.set(c.EssentialsFieldTypes.essentialsFieldTypeDouble);break;case"Length":r.displayName.set(o.measurementMarkupManager.getResource("language-common-measurement-results-field-length")),r.type.set(c.EssentialsFieldTypes.essentialsFieldTypeDouble);break;case"Units":r.displayName.set(o.measurementMarkupManager.getResource("language-common-measurement-results-field-units")),r.type.set(c.EssentialsFieldTypes.essentialsFieldTypeString);break;case"Area":r.displayName.set(o.measurementMarkupManager.getResource("language-common-measurement-results-field-area")),r.type.set(c.EssentialsFieldTypes.essentialsFieldTypeDouble);break;case"Area Units":r.displayName.set(o.measurementMarkupManager.getResource("language-common-measurement-results-field-area-units")),r.type.set(c.EssentialsFieldTypes.essentialsFieldTypeString);break;case"Angle":r.displayName.set(o.measurementMarkupManager.getResource("language-measurement-results-field-angle")),r.type.set(c.EssentialsFieldTypes.essentialsFieldTypeDouble);break;case"Bearing":r.displayName.set(o.measurementMarkupManager.getResource("language-measurement-results-field-bearing")),r.type.set(c.EssentialsFieldTypes.essentialsFieldTypeString)}}},t.prototype._getDisplayName=function(){for(var e=1,t=this.drawMode||l.DrawMode.POLYGON,r=0;r<o.measurementMarkupManager.descriptorContainer.length;r++)(o.measurementMarkupManager.descriptorContainer[r].drawMode||l.DrawMode.POLYGON)===t&&o.measurementMarkupManager.descriptorContainer[r].id!==this.id&&e++;var a=o.measurementMarkupManager.getResource("language-measurement-drawmode-"+t.toLowerCase().replace("_","-"));return o.measurementMarkupManager.getResource("language-measurement-results-feature-set-name").format(a,e)},t}(r.DescriptorBase);t.GeometryDescriptor=h})},"Mapping/modules/Measurement/Descriptors/LineSegmentDescriptor":function(){define(["require","exports","./DescriptorBase","./../MeasurementModule","./../MeasurementUtils","geocortex/infrastructure/coordinates/AngleDirectionSystem","geocortex/infrastructure/coordinates/CoordinateUtils"],function(e,t,r,a,n,i,s){"use strict";var o=function(e){function t(t,a){var n=e.call(this,r.DescriptorType.LINE_SEGMENT,t,a)||this;return n.mapPointStart=null,n.mapPointEnd=null,n.showLabel=!1,n.geometry=new esri.geometry.Polyline(t),n.length=0,n}return __extends(t,e),t.prototype.setStartPt=function(e){e?(this.mapPointStart=new esri.geometry.Point(e.toJson()),0===this.geometry.paths.length?this.geometry.addPath([this.mapPointStart]):this.geometry.insertPoint(0,0,this.mapPointStart)):a.measurementMarkupManager._reportStatus("LineSegmentDescriptor: setStartPt - Start point not specified","error",!1)},t.prototype.setEndPt=function(e){e?(this.mapPointEnd=new esri.geometry.Point(e.toJson()),1===this.geometry.paths.length?this.geometry.insertPoint(0,1,this.mapPointEnd):a.measurementMarkupManager._reportStatus("LineSegmentDescroptor: setEndPt - Please set startPt of segment before setting endPt","error",!1)):a.measurementMarkupManager._reportStatus("LineSegmentDescriptor: setEndPt - End point not specified","error",!1)},t.prototype.setMeasurementUnit=function(e,t){(null!=this.lengthUnit&&this.lengthUnit!=e||null==this.lengthUnit&&null!=e)&&(this.length&&null!=this.lengthUnit&&(this.length=n.convertLength(this.length,this.lengthUnit,e)),this.lengthUnit=e,this.unitStr=t?t:n.getUnitString(this.lengthUnit),this.highlightedLabelGraphic&&this.highlightedLabelGraphic.refresh(a.measurementMarkupManager.formatMeasurement(this.length,a.measurementMarkupManager.measurementFractionalDigits)+" "+this.unitStr))},t.prototype.refreshLabelVisibility=function(){if(this.highlightedLabelGraphic){var e=n.getRenderedLineSegmentLength(this);this.showLabel=this.highlightedLabelGraphic.getWidth()<e,this.showLabel?this.highlightedLabelGraphic.show():this.highlightedLabelGraphic.hide()}},t.prototype.exportState=function(){var t=e.prototype.exportState.call(this);return t.startPoint=this.app.project.convert.fromEsriGeometry(this.mapPointStart),t.endPoint=this.app.project.convert.fromEsriGeometry(this.mapPointEnd),t},t.prototype.applyState=function(t){var r=this;return e.prototype.applyState.call(this,t,a.measurementMarkupManager._lengthUnit,a.measurementMarkupManager._lengthUnitString).then(function(){r.mapPointStart=r.app.project.convert.toEsriGeometry(t.startPoint),r.mapPointEnd=r.app.project.convert.toEsriGeometry(t.endPoint)})},t.prototype._createAttributes=function(){var e={};return e.Segment=this.id,e.X=this.mapPointStart.x,e.Y=this.mapPointStart.y,e.Length=this.length,e.Units=this.unitStr,e.Area=0,e["Area Units"]="",e.Angle=this.getAngle(),e.Bearing=this.getQuadrantBearing(),e},t.prototype.getAngle=function(){return a.measurementMarkupManager.angleDirectionSystem===i.NORTH_AZIMUTH?this.getNorthAzimuth():a.measurementMarkupManager.angleDirectionSystem===i.SOUTH_AZIMUTH?this.getSouthAzimuth():this.getPolarAngle()},t.prototype.getAngleDegree=function(){var e=0;if(this.mapPointStart&&this.mapPointEnd){var t=Math.atan2(this.mapPointStart.y-this.mapPointEnd.y,this.mapPointEnd.x-this.mapPointStart.x)*(180/Math.PI);t=t<0?360+t:t,e=t>=0&&t<=180?t>90?180+t:t:t<270?t-180:t}return e},t.prototype.getPolarAngle=function(){var e=this.mapPointEnd.x-this.mapPointStart.x,t=this.mapPointEnd.y-this.mapPointStart.y,r=180*Math.atan2(t,e)/Math.PI;return(r+360)%360},t.prototype.getNorthAzimuth=function(){return(360-this.getPolarAngle()+90)%360},t.prototype.getSouthAzimuth=function(){return(360-this.getPolarAngle()+90+180)%360},t.prototype.getLabelLocation=function(){if(this.mapPointStart&&this.mapPointEnd)return new esri.geometry.Point((this.mapPointStart.x+this.mapPointEnd.x)/2,(this.mapPointStart.y+this.mapPointEnd.y)/2,this.spatialReference)},t.prototype.getQuadrantBearing=function(){return s.formatBearing(this.getNorthAzimuth(),a.measurementMarkupManager.degreeFormat,this.app,a.measurementMarkupManager.coordinateFractionalDigits)},t}(r.DescriptorBase);t.LineSegmentDescriptor=o})},"url:/Mapping/modules/Measurement/MeasurementUnitSwitcherView.html":'<div class="measurement-unit-switcher">\r\n    <ul class="list-menu has-icon" data-binding="{@source: lengthUnits}{@value: selectedLengthUnits}{@visible: lengthSwitcherSelected}">\r\n        <li class="list-menu-item" data-binding="{@template-for: lengthUnits}{@event-onclick: handleSetLengthUnits}">\r\n            <span class="list-menu-details" data-binding="{@text: @context}"></span>\r\n        </li>\r\n    </ul>\r\n    <ul class="list-menu has-icon" data-binding="{@source: areaUnits}{@value: selectedAreaUnits}{@hidden: lengthSwitcherSelected}">\r\n        <li class="list-menu-item" data-binding="{@template-for: areaUnits}{@event-onclick: handleSetAreaUnits}">\r\n            <span class="list-menu-details" data-binding="{@text: @context}"></span>\r\n        </li>\r\n    </ul>\r\n</div>\r\n',"url:/Mapping/modules/Measurement/MeasurementView.html":'<ul class="transient-measurement">\r\n    <li class="toolbar-item select-double">\r\n        <select data-binding="{@source: lengthUnits}{@value: selectedLengthUnits}{disabled: measurementInProgress}{title: @language-measurement-length-select}">\r\n            <option data-binding="{@template-for: lengthUnits}{value: @context}{@text: @context}" />\r\n        </select>\r\n        <select data-binding="{@source: areaUnits}{@value: selectedAreaUnits}{disabled: measurementInProgress}{title: @language-measurement-area-select}">\r\n            <option data-binding="{@template-for: areaUnits}{value: @context}{@text: @context}" />\r\n        </select>\r\n    </li>\r\n</ul>',"url:/Mapping/modules/Measurement/Widgets/MeasurementTransientView.html":'<div class="toolbar-tool-mode">\r\n    <div class="tbtm-done" data-binding="{@event-onclick: handleClickClose}">\r\n        <span data-binding="{@text: @language-menu-done}"></span>\r\n    </div>\r\n    <div class="tbtm-list">\r\n        <ul class="five">\r\n            <li class="tbtm-checkbox">\r\n                <input type="checkbox" id="tbtm-add-drawing" data-binding="{@value: addMarkupToMap}{disabled: measurementInProgress}" />\r\n                <p for="tbtm-add-drawing" data-binding="{@text: @language-measurement-add-as-drawing}"><!-- "Add as Drawing" --></p>\r\n            </li>\r\n            <li>\r\n                <button class="tbtm-select" data-binding="{@event-onclick: handleShowLengthSwitcher}">\r\n                    <h1 class="tbtm-units"><span data-binding="{@text: selectedLengthUnitShort}"></span><span class="icon icon-select"></span></h1>\r\n                    <p data-binding="{@text: @language-measurement-length-label}"></p>\r\n                </button>\r\n            </li>\r\n            <li>\r\n                <button class="tbtm-select" data-binding="{@event-onclick: handleShowAreaSwitcher}">\r\n                    <h1 class="tbtm-units"><span data-binding="{@text: selectedAreaUnitShort}"></span><span class="icon icon-select"></span></h1>\r\n                    <p data-binding="{@text: @language-measurement-area-label}"></p>\r\n                </button>\r\n            </li>\r\n            <li>\r\n                <button class="tbtm-btn" data-binding="{@disabled: descriptorContainerEmpty}{@class-highlight: eraseActive}{@event-onclick: handleEraseMeasurement}">\r\n                    <span class="icon icon-erase-24"></span>\r\n                    <p data-binding="{@text: @language-toolbar-erase}"></p>\r\n                </button>\r\n            </li>\r\n            <li>\r\n                <button class="tbtm-btn" data-binding="{@disabled: descriptorContainerEmpty}{@event-onclick: handleClearAll}">\r\n                    <span class="icon icon-clear-24"></span>\r\n                    <p data-binding="{@text: @language-toolbar-clear-all}"></p>\r\n                </button>\r\n            </li>\r\n        </ul>\r\n    </div>\r\n</div>\r\n'}}),define(["Mapping/modules/Measurement/HighlightedMeasurementLabel","Mapping/modules/Measurement/MeasurementMarkupManager","Mapping/modules/Measurement/MeasurementModule","Mapping/modules/Measurement/MeasurementOperation","Mapping/modules/Measurement/MeasurementTool","Mapping/modules/Measurement/MeasurementUtils","Mapping/modules/Measurement/MeasurementView","Mapping/modules/Measurement/MeasurementViewModel","Mapping/modules/Measurement/Descriptors/DescriptorBase","Mapping/modules/Measurement/Descriptors/GeometryDescriptor","Mapping/modules/Measurement/Descriptors/LineSegmentDescriptor"],function(e,t,r,a,n,i,s,o,u,m,l){
shim(e,"geocortex.essentialsHtmlViewer.mapping.modules.measurement.HighlightedMeasurementLabel",e.HighlightedMeasurementLabel),shim(t,"geocortex.essentialsHtmlViewer.mapping.modules.measurement.MeasurementMarkupManager",t.MeasurementMarkupManager),shim(r,"geocortex.essentialsHtmlViewer.mapping.modules.measurement.MeasurementModule",r.MeasurementModule),shim(a,"geocortex.essentialsHtmlViewer.mapping.modules.measurement.MeasurementOperation",a.MeasurementOperation),shim(n,"geocortex.essentialsHtmlViewer.mapping.modules.measurement.MeasurementTool",n.MeasurementTool),shim(i,"geocortex.essentialsHtmlViewer.mapping.modules.measurement.MeasurementUtils.getUnitString",i.getUnitString),shim(i,"geocortex.essentialsHtmlViewer.mapping.modules.measurement.MeasurementUtils.getGeometryServiceUnitConstant",i.getGeometryServiceUnitConstant),shim(i,"geocortex.essentialsHtmlViewer.mapping.modules.measurement.MeasurementUtils.addGraphicToLayer",i.addGraphicToLayer),shim(i,"geocortex.essentialsHtmlViewer.mapping.modules.measurement.MeasurementUtils.getGraphicsLayer",i.getGraphicsLayer),shim(i,"geocortex.essentialsHtmlViewer.mapping.modules.measurement.MeasurementUtils.getLabelSize",i.getLabelSize),shim(i,"geocortex.essentialsHtmlViewer.mapping.modules.measurement.MeasurementUtils.getRenderedLineSegmentLength",i.getRenderedLineSegmentLength),shim(i,"geocortex.essentialsHtmlViewer.mapping.modules.measurement.MeasurementUtils.plotPointOnMap",i.plotPointOnMap),shim(i,"geocortex.essentialsHtmlViewer.mapping.modules.measurement.MeasurementUtils.addHighlightedLabelToMap",i.addHighlightedLabelToMap),shim(i,"geocortex.essentialsHtmlViewer.mapping.modules.measurement.MeasurementUtils.getTextLines",i.getTextLines),shim(i,"geocortex.essentialsHtmlViewer.mapping.modules.measurement.MeasurementUtils.svgRoundedRectanglePath",i.svgRoundedRectanglePath),shim(i,"geocortex.essentialsHtmlViewer.mapping.modules.measurement.MeasurementUtils.refreshHighlightSymbolSize",i.refreshHighlightSymbolSize),shim(i,"geocortex.essentialsHtmlViewer.mapping.modules.measurement.MeasurementUtils.convertLength",i.convertLength),shim(i,"geocortex.essentialsHtmlViewer.mapping.modules.measurement.MeasurementUtils.convertArea",i.convertArea),shim(s,"geocortex.essentialsHtmlViewer.mapping.modules.measurement.MeasurementView",s.MeasurementView),shim(o,"geocortex.essentialsHtmlViewer.mapping.modules.measurement.MeasurementViewModel",o.MeasurementViewModel),shim(u,"geocortex.essentialsHtmlViewer.mapping.modules.measurement.DescriptorType",u.DescriptorType),shim(u,"geocortex.essentialsHtmlViewer.mapping.modules.measurement.DescriptorBase",u.DescriptorBase),shim(m,"geocortex.essentialsHtmlViewer.mapping.modules.measurement.GeometryDescriptor",m.GeometryDescriptor),shim(l,"geocortex.essentialsHtmlViewer.mapping.modules.measurement.LineSegmentDescriptor",l.LineSegmentDescriptor)});