!function(){function e(e,t,i){if("string"==typeof e&&(i=t,t=e),void 0!==i)for(var o=t.split("."),n=null,a=window,r=0,s=o.length;r<s;r++)n=o[r],r==s-1?a[n]=i:a[n]||(a[n]={}),a=a[n];else console.warn("Undefined shim for: "+t)}var t="<div class='refine-results'>    <div class='widget refine-options' data-binding='{@widget: CombineResultsOptionsWidget}{@widget-context: featureSetCollection}{@hidden: combineModeChosen}' data-menu-id='CombineResultsActions' data-menu-hoist-disabled='true'></div>    <div data-binding='{@visible: combineModeChosen}'>        <div class='panel-group no-item box-container' data-binding='{@hidden: selections}'>            <p data-binding='{@text: @language-saved-results-browse-no-items}'></p>            <p class='description' data-binding='{@text: @language-saved-results-browse-no-items-desc}'></p>        </div>        <div class='panel-group' data-binding='{@visible: selections}'>            <div class='list-refine-results-header' tabindex='0'>                <span data-binding='{@text: @language-saved-results-combine-list-explanation}'></span>            </div>            <ul class='list-menu' data-binding='{@source: resultsPage}'>                <li class='list-menu-item' data-binding='{@template-for: resultsPage}'>                    <label class='list-menu-label' data-binding='{@text: displayName}{for: id}'></label>                    <input class='list-menu-action' type='checkbox' data-binding='{id: id}{@value: isSelected}' />                </li>            </ul>            <div class='form-btns'>                <button class='button ok-button' data-binding='{@event-click: handleOkClick}{@text: @language-common-ok}'></button>                <button class='button cancel-button' data-binding='{@event-click: handleCancelClick}{@text: @language-common-cancel}'></button>            </div>        </div>        \x3c!-- BEGIN: Paging Controls --\x3e        <div data-binding='{@visible: selections}{@widget: PagingControlsWidget}{@widget-context: @context}{@widget-required: false}'></div>        \x3c!-- END: Paging Controls --\x3e    </div></div>",i="<div class='list-selections-view'>    <div class='panel-group no-item box-container' data-binding='{@hidden: selections}'>        <p data-binding='{@text: @language-saved-results-browse-no-items}'></p>        <p class='description' data-binding='{@text: @language-saved-results-browse-no-items-desc}'></p>    </div>    <div class='panel-group' data-binding='{@visible: selections}'>        <ul class='list-menu' data-binding='{@source: resultsPage}'>            <li class='list-menu-item' data-binding='{@template-for: resultsPage}'>                <button class='selection-contents' data-binding='{@disabled: disabled}{title: restoreTooltip}{@event-onclick: handleRestoreSelectionClick}'>                    <span class='list-menu-name' data-binding='{@text: displayName}'></span>                    <span class='list-menu-desc' data-binding='{@visible:disabled}{@text: @language-saved-results-item-already-open}'></span>                </button>                <button class='action-button edit-24 right' data-binding='{@event-onclick: handleRenameClick}{title: renameTooltip}{@enabled: canModify}'></button>                <button class='action-button trashcan-24 right' data-binding='{@event-onclick: handleDeleteClick}{title: deleteTooltip}{@enabled: canModify}'></button>            </li>        </ul>    </div>    \x3c!-- BEGIN: Paging Controls --\x3e    <div data-binding='{@visible: selections}{@widget: PagingControlsWidget}{@widget-context: @context}{@widget-required: false}'></div>    \x3c!-- END: Paging Controls --\x3e</div>",o="<div class='save-selection-view'>    <label for='selectionName' data-binding='{@text: @language-common-save-as}'></label>    <input type='text' id='selectionName' data-binding='{@value: name}{@event-keydown: handleKeyDown}' />    <div class='form-btns'>        <button class='button save-button' data-binding='{@event-click: handleSaveClick}{@text: @language-common-save}{@enabled: name}'></button>        <button class='button cancel-button' data-binding='{@event-click: handleCancelClick}{@text: @language-common-cancel}'></button>    </div></div>";require({cache:{"Mapping/modules/Selection/CombineResultsView":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function o(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(o.prototype=i.prototype,new o)}}();define(["require","exports","geocortex/framework/ui/ViewBase","geocortex/infrastructure/ui/components/PagingControls/PagingControlsViewModel","geocortex/infrastructure/FeatureSet","geocortex/infrastructure/FeatureSetCollection","geocortex/infrastructure/selection/CombineMode","geocortex/framework/utils/ArrayUtils"],function(t,i,o,n,a,r,s,l){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var c=function(t){function i(){return null!==t&&t.apply(this,arguments)||this}return e(i,t),i.prototype.attach=function(e){t.prototype.attach.call(this,e),this._registerCommands()},i.prototype.deactivated=function(){this.viewModel.reset()},i.prototype._registerCommands=function(){this.app.command("ShowSearchOptions").register(this,this.show,this._canCombineResults),this.app.command("CombineResultsInteractive").register(this,this._executeCombineResultsInteractive)},i.prototype.resolveWidget=function(e,i,o){if("CombineResultsOptionsWidget"===e)return this.app.menuRegistry.createMenuWidget(this,i,o);if("PagingControlsWidget"===e){var a=this.app.viewManager.createView({typeName:"geocortex.essentialsHtmlViewer.mapping.infrastructure.ui.components.PagingControls.PagingControlsView",markupResource:"Mapping/infrastructure/ui/components/PagingControls/PagingControlsView.html",libraryId:"Mapping.Infrastructure",isVisible:!0});if(a){var r=new n.PagingControlsViewModel(this.app,i);a.attach(r)}return a}return t.prototype.resolveWidget.call(this,e,i,o)},i.prototype.show=function(e){if(this.viewModel){var t;if("string"==typeof e)t=this.app.featureSetManager.getCollectionById(e);else if(e instanceof a.FeatureSet){var i=new r.FeatureSetCollection;i.featureSets.addItem(e),t=i}else t=e;t?(this.viewModel.featureSetCollection.set(t),this.app.viewManager.activateView(this)):this.app.trace.warning("Cannot save feature set collection: No feature set collection with matching ID found.")}},i.prototype.handleOkClick=function(){var e=this,t=this.viewModel.featureSetCollection.get().displayName.get();0===t.length&&this.viewModel.featureSetCollection.get().featureSets&&(t=this.viewModel.featureSetCollection.get().featureSets.getAt(0).displayName.get());var i={nameOfCurrentResults:t,currentResults:this.viewModel.featureSetCollection.get(),collectionNames:this.viewModel.getSelectedItems().map(function(e){return e.name}),combineResponse:void 0};Promise.resolve(i).then(function(t){return e.app.viewManager.deactivateView(e),t}).then(function(t){return e._combineResults(t)}).then(function(t){return e._displayNotification(t)}).catch(function(t){return e._processError(t)})},i.prototype.handleCancelClick=function(){this.app.viewManager.deactivateView(this)},i.prototype._executeCombineResultsInteractive=function(e){var t=this;if(this.viewModel){var i,o=s.CombineMode.REPLACE;Promise.try(function(){var n=e?e.mode:null,a=e?e.currentResults:null;i="string"==typeof a?t.app.featureSetManager.getCollectionById(a):a,t.viewModel.combineModeChosen.set(!0),t.viewModel.combineMode=n||o,i&&t.viewModel.featureSetCollection.get()&&i.id!==t.viewModel.featureSetCollection.get().id&&t.viewModel.featureSetCollection.set(i)}).then(function(){return t.viewModel.populateFromMetadata()}).catch(function(e){return t._processError(e)})}},i.prototype._combineResults=function(e){var t=this;return new Promise(function(i,o){var n={combineMode:t.viewModel.combineMode,featureSetCollectionIds:t.viewModel.getSelectedItems().map(function(e){return e.featureSetCollectionId}),currentResults:e.currentResults,successCallback:function(t){e.combineResponse=t,i(e)},errorCallback:o};t.app.command("CombineResults").execute(n)})},i.prototype._displayNotification=function(e){var t,i=e.combineResponse,o=e.collectionNames.map(function(e){return"'"+e+"'"}).join(", "),n=e.nameOfCurrentResults;switch(i.combineMode){case s.CombineMode.UNION:t=this.getResource("language-common-results-union-confirmation");break;case s.CombineMode.INTERSECT:t=this.getResource("language-common-results-intersect-confirmation");break;case s.CombineMode.SUBTRACT:t=this.getResource("language-common-results-subtract-confirmation")}return t&&(t=t.format(n,o),this.app.command("AddResultsStatus").execute(t)),e},i.prototype._processError=function(e){var t=e&&"UiError"===e.name?e.message:this.getResource("language-saved-results-error-message");return this.app.command("AddResultsStatus").execute(t),this.app.trace.error(e.message,e),e},i.prototype._canCombineResults=function(e){return"string"!=typeof e?e instanceof r.FeatureSetCollection?0!==e.featureSets.getLength()&&!!l.firstOrDefault(e.featureSets.getItems(),function(e){return e.features.getLength()>0}):e.features.getLength()>0:!!(e=this.app.featureSetManager.getCollectionById(e))&&void 0},i}(o.ViewBase);i.CombineResultsView=c})},"Mapping/modules/Selection/CombineResultsViewModel":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function o(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(o.prototype=i.prototype,new o)}}();define(["require","exports","geocortex/framework/ui/ViewModelBase","geocortex/framework/observables","./SelectableSelectionItem","geocortex/framework-ui/PresentableCollection","geocortex/infrastructure/selection/CombineMode"],function(t,i,o,n,a,r,s){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var l=function(t){function i(e,i){var o=t.call(this,e,i)||this;return o.featureSetCollection=new n.Observable,o.combineModeChosen=new n.Observable(!1),o.isPaged=!0,o.pageSize=10,o.combineMode=s.CombineMode.REPLACE,o.selections=new n.ObservableCollection,o.presentableResults=new r.PresentableCollection(o.selections),o.resultsPage=o.presentableResults.items,o.presentableResults.items.useThrottling=!0,o}return e(i,t),i.prototype.initialize=function(e){t.prototype.initialize.call(this,e),(e=e||{}).hasOwnProperty("isPaged")&&(this.isPaged=e.isPaged),e.hasOwnProperty("pageSize")&&(this.pageSize=e.pageSize),this.presentableResults.isPaginated.set(this.isPaged),this.presentableResults.pageSize.set(this.pageSize)},i.prototype.reset=function(){this.combineModeChosen.set(!1)},i.prototype.getSelectedItems=function(){return(this.selections?this.selections.getItems():[]).filter(function(e){return e&&e.isSelected.get()})},i.prototype.populateFromMetadata=function(){var e=this;return this._fetchMetadata().then(function(e){return e.map(function(e){return new a.SelectableSelectionItem(e)})}).then(function(t){return e._excludeCurrentResultsFromList(t)}).then(function(t){return e._populatePresentableCollection(t)}).then(function(){return e.presentableResults.currPageNumber.set(1)})},i.prototype._fetchMetadata=function(){var e=this;return new Promise(function(t,i){e.app.command("FindAllSelectionMetadata").execute({successCallback:t,errorCallback:i})})},i.prototype._excludeCurrentResultsFromList=function(e){var t=this.featureSetCollection.get();return e&&t&&"Selection"===t.sourceName?e.filter(function(e){return e.name!==t.getExtendedPropertyByName("SelectionName")}):e},i.prototype._populatePresentableCollection=function(e){return this.selections.set(e),e},i}(o.ViewModelBase);i.CombineResultsViewModel=l})},"Mapping/modules/Selection/ListSelectionsView":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function o(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(o.prototype=i.prototype,new o)}}();define(["require","exports","geocortex/framework/ui/ViewBase","geocortex/infrastructure/ui/components/PagingControls/PagingControlsViewModel","./SelectionItem","geocortex/framework/utils/ArrayUtils"],function(t,i,o,n,a,r){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var s=function(t){function i(){return null!==t&&t.apply(this,arguments)||this}return e(i,t),i.prototype.attach=function(e){t.prototype.attach.call(this,e),this._registerCommands()},i.prototype.resolveWidget=function(e,i,o){if("PagingControlsWidget"===e){var a=this.app.viewManager.createView({typeName:"geocortex.essentialsHtmlViewer.mapping.infrastructure.ui.components.PagingControls.PagingControlsView",markupResource:"Mapping/infrastructure/ui/components/PagingControls/PagingControlsView.html",libraryId:"Mapping.Infrastructure",isVisible:!0});if(a){var r=new n.PagingControlsViewModel(this.app,i);a.attach(r)}return a}return t.prototype.resolveWidget.call(this,e,i,o)},i.prototype._registerCommands=function(){this.app.command("ListSelections").register(this,this.show)},i.prototype.show=function(){var e=this;this.viewModel&&this.viewModel.findAllMetadata().then(function(t){return e._processMetadata(t)}).then(function(t){return e._disableCurrentlyOpenedCollection(t)}).then(function(t){e.viewModel.selections.set(t),e.viewModel.selections.pulse(),0===e.viewModel.selections.getLength()&&e.app.command("ScreenReaderNarrate").execute(e.getResource("language-saved-results-browse-no-items")),e.app.viewManager.activateView(e)})},i.prototype.handleRestoreSelectionClick=function(e,t,i){var o=i?i.name:null;if(!o)throw new Error("Cannot restore named selection into the results view: selection name is required.");this.app.viewManager.deactivateView(this),this.app.command("RestoreSelection").execute({name:o})},i.prototype.handleRenameClick=function(e,t,i){var o=this;this.promptForSelectionName(i).then(function(e){return o._processName(e,i)}).then(function(e){return o.viewModel.renameSelection(i,e)}).catch(function(e){return o._processError(e)})},i.prototype.handleDeleteClick=function(e,t,i){var o=this;this.confirmDelete(i).then(function(e){e&&o.viewModel.deleteSelection(i)})},i.prototype.confirmDelete=function(e){var t=this,i=this.getResource("language-saved-results-delete-prompt").format(e.name),o=this.getResource("language-saved-results-delete-prompt-title").format(e.name);return new Promise(function(e,n){return t.app.command("Confirm").execute(i,o,e)})},i.prototype.promptForSelectionName=function(e){var t=this,i=this.getResource("language-saved-results-rename-prompt-title"),o=this.getResource("language-saved-results-rename-prompt"),n=e.name;return new Promise(function(e,a){return t.app.command("Prompt").execute(i,o,n,e)})},i.prototype._processMetadata=function(e){var t=this;return e.map(function(e){var i=new a.SelectionItem(e);return t.viewModel.setTooltips(i)})},i.prototype._disableCurrentlyOpenedCollection=function(e){var t=this;return this.app.command("_isResultsViewActive").execute(function(i){if(i){var o=t.viewModel.featureSetCollection.get(),n=o&&"Selection"===o.sourceName?o.displayName.get():null,a=e&&n?r.firstOrDefault(e,function(e){return e.name===n}):null;a&&a.disabled.set(!0)}}),e},i.prototype._processName=function(e,t){var i=this.viewModel.selections.get();if(!e)throw(o=new Error(this.getResource("language-saved-results-no-name-error").format(t.name))).name="UiError",o;if(e===t.name)return t.name;if(i.some(function(t){return t.name===e})){var o=new Error(this.getResource("language-saved-results-rename-prompt-error").format(e));throw o.name="UiError",o}return e},i.prototype._processError=function(e){var t=e&&"UiError"===e.name?e.message:this.getResource("language-saved-results-error-message");return this.app.command("AddResultsStatus").execute(t),this.app.trace.error(t,e),e},i}(o.ViewBase);i.ListSelectionsView=s})},"Mapping/modules/Selection/ListSelectionsViewModel":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function o(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(o.prototype=i.prototype,new o)}}();define(["require","exports","geocortex/framework/ui/ViewModelBase","geocortex/framework/observables","geocortex/framework-ui/PresentableCollection"],function(t,i,o,n,a){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var r=function(t){function i(e,i){var o=t.call(this,e,i)||this;return o.featureSetCollection=new n.Observable,o.isPaged=!0,o.pageSize=10,o.selections=new n.ObservableCollection,o.presentableResults=new a.PresentableCollection(o.selections),o.resultsPage=o.presentableResults.items,o.presentableResults.items.useThrottling=!0,o}return e(i,t),i.prototype.initialize=function(e){var i=this;t.prototype.initialize.call(this,e),(e=e||{}).hasOwnProperty("isPaged")&&(this.isPaged=e.isPaged),e.hasOwnProperty("pageSize")&&(this.pageSize=e.pageSize),this.presentableResults.isPaginated.set(this.isPaged),this.presentableResults.pageSize.set(this.pageSize),this.app.command("ShowResultsList").register(this,this._trackDisplayedResults),this.app.command("ShowResultsTable").register(this,this._trackDisplayedResults,function(){return!i.app.configuration.mobileMode})},i.prototype.findAllMetadata=function(){var e=this;return new Promise(function(t,i){e.app.command("FindAllSelectionMetadata").execute({successCallback:t,errorCallback:i})})},i.prototype.deleteSelection=function(e){var t=this;return new Promise(function(i,o){var n={name:e.name,successCallback:function(){t.selections.removeItem(e),i()},errorCallback:o};t.app.command("DeleteSelection").execute(n)})},i.prototype.renameSelection=function(e,t){var i=this;return new Promise(function(o,n){var a={name:e.name,newName:t,successCallback:function(){e.name=t,i.setTooltips(e),i.resultsPage.pulse(),o()},errorCallback:n};i.app.command("RenameSelection").execute(a)})},i.prototype.setTooltips=function(e){var t=this.getResource("language-saved-results-item-restore-description").format(e.name),i=this.getResource("language-saved-results-item-rename-description").format(e.name),o=this.getResource("language-saved-results-item-delete-description").format(e.name);return e.restoreTooltip=t,e.renameTooltip=i,e.deleteTooltip=o,e},i.prototype._trackDisplayedResults=function(e){var t="string"==typeof e?this.app.featureSetManager.getCollectionById(e):e;t&&t!==this.featureSetCollection.get()&&this.featureSetCollection.set(t)},i}(o.ViewModelBase);i.ListSelectionsViewModel=r})},"Mapping/modules/Selection/SaveSelectionView":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function o(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(o.prototype=i.prototype,new o)}}();define(["require","exports","geocortex/framework/ui/ViewBase","geocortex/infrastructure/Dictionary","geocortex/infrastructure/FeatureSet","geocortex/infrastructure/FeatureSetCollection"],function(t,i,o,n,a,r){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var s=function(t){function i(){var e=null!==t&&t.apply(this,arguments)||this;return e._metadataCache=new n.Dictionary,e}return e(i,t),i.prototype.attach=function(e){t.prototype.attach.call(this,e),this._registerCommands()},i.prototype._registerCommands=function(){this.app.command("ShowSaveSelectionDialog").register(this,this.show,this._canShow),this.app.event("SelectionCreatedEvent").subscribe(this,this._handleSelectionCreated),this.app.event("SelectionChangedEvent").subscribe(this,this._handleSelectionChanged),this.app.event("SelectionRemovedEvent").subscribe(this,this._handleSelectionRemoved)},i.prototype.handleKeyDown=function(e,t,i){return(e.which?e.which:e.keyCode)===dojo.keys.ENTER&&(this.save(),e.preventDefault()),!0},i.prototype.handleCancelClick=function(){this.app.viewManager.deactivateView(this)},i.prototype.handleSaveClick=function(){this.save()},i.prototype.save=function(){var e=this,t=this.viewModel.name.get();this.viewModel.saveSelection(t).then(function(t){return e._processResults(t)}).catch(function(t){return e._processError(t)})},i.prototype.show=function(e,t){var i;if("string"==typeof e)i=this.app.featureSetManager.getCollectionById(e);else if(e instanceof a.FeatureSet){var o=new r.FeatureSetCollection;o.featureSets.addItem(e),i=o}else i=e;if(i){var n=t;n||(n="Selection"===i.sourceName&&i.displayName.get()!==this.viewModel._starredSelectionName?i.getExtendedPropertyByName("SelectionName"):""),this.viewModel.featureSetCollection.set(i),this.viewModel.name.set(n),this.app.viewManager.activateView(this)}else this.app.trace.warning("Cannot save feature set collection: No feature set collection with matching ID found.")},i.prototype._canShow=function(e,t){var i;if("string"==typeof e)i=this.app.featureSetManager.getCollectionById(e);else if(e instanceof a.FeatureSet){var o=new r.FeatureSetCollection;o.featureSets.addItem(e),i=o}else i=e;return!(!i||0===i.featureSets.length())&&("Selection"!==i.sourceName||i.displayName.get()===this.viewModel._starredSelectionName||i.isModified.get())},i.prototype._processResults=function(e){return e&&(this.viewModel.showConfirmationMessage(),this.app.viewManager.deactivateView(this)),e},i.prototype._processError=function(e){var t=e&&"UiError"===e.name?e.message:this.getResource("language-saved-results-error-message");return this.app.command("AddResultsStatus").execute(t),this.app.trace.error(t,e),e},i.prototype._handleSelectionCreated=function(e){var t=e?e.name:null,i=e&&e.featureSetCollection?e.featureSetCollection.id:null;this._computeCanExecute(t,i)},i.prototype._handleSelectionChanged=function(e){var t=e?e.name:null,i=e&&e.featureSetCollection?e.featureSetCollection.id:null;this._computeCanExecute(t,i)},i.prototype._handleSelectionRemoved=function(e){var t=e?e.name:null,i=e&&e.featureSetCollection?e.featureSetCollection.id:null;this._computeCanExecute(t,i)},i.prototype._computeCanExecute=function(e,t){var i=this;t&&this.viewModel.findMetadata(e,t).then(function(e){return e?i._metadataCache.set(t,e):i._metadataCache.remove(t)}).catch(function(e){return i._metadataCache.remove(t)}).lastly(function(){return i.app.command("ShowSaveSelectionDialog").raiseCanExecuteChanged()})},i}(o.ViewBase);i.SaveSelectionView=s})},"Mapping/modules/Selection/SaveSelectionViewModel":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function o(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(o.prototype=i.prototype,new o)}}();define(["require","exports","geocortex/framework/ui/ViewModelBase","geocortex/framework/observables","geocortex/framework/utils/utils"],function(t,i,o,n,a){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var r=function(t){function i(e,i){var o=t.call(this,e,i)||this;return o.name=new n.Observable,o.featureSetCollection=new n.Observable,o._existingSelection=!1,o._starredSelectionName=e.getResource("Mapping.Infrastructure","language-selection-starred-selection-name"),o}return e(i,t),i.prototype.saveSelection=function(e){var t=this;return Promise.try(function(){return t._assertNameNotNull(e),t.selectionExists(e).then(function(i){if(t._existingSelection=i,t._existingSelection){if(e!==t._starredSelectionName)return t.confirmOverwrite(e);var o=t.app.getResource(t.libraryId,"language-saved-results-cannot-overwrite").format(e);return t.app.command("Alert").execute(o),Promise.resolve(!1)}return Promise.resolve(!0)}).then(function(i){return t._existingSelection&&i?t.updateSelection(e).thenReturn(!0):t._existingSelection?Promise.resolve(!1):t.createSelection(e).thenReturn(!0)})})},i.prototype.findMetadata=function(e,t){var i=this;return new Promise(function(o,n){var a={successCallback:o,errorCallback:n};if(!e&&!t)throw new Error("The selection name or feature set collection ID must be set.");e&&(a.name=e),t&&(a.featureSetCollectionId=t),i.app.command("FindMetadataForSelection").execute(a)})},i.prototype.selectionExists=function(e){var t=this;return Promise.try(function(){return t._assertNameNotNull(e),t.findMetadata(e).then(function(e){return!a.isNullOrUndefined(e)})})},i.prototype.createSelection=function(e){var t=this;return new Promise(function(i,o){t._assertNameNotNull(e),t.app.command("CreateSelection").execute({name:e,featureSetCollection:t.featureSetCollection.get(),successCallback:i,errorCallback:o})})},i.prototype.updateSelection=function(e){var t=this;return new Promise(function(i,o){t._assertNameNotNull(e),t.app.command("UpdateSelection").execute({name:e,featureSetCollection:t.featureSetCollection.get(),successCallback:i,errorCallback:o})})},i.prototype.confirmOverwrite=function(e){var t=this,i=this.app.getResource(this.libraryId,"language-saved-results-overwrite-prompt").format(e),o=this.app.getResource(this.libraryId,"language-saved-results-overwrite-prompt-title").format(e);return new Promise(function(e,n){return t.app.command("Confirm").execute(i,o,e)})},i.prototype.showConfirmationMessage=function(){var e=this.name.get(),t=this.featureSetCollection.get().countFeatures(),i=this._existingSelection?"language-saved-results-update-confirmation":"language-saved-results-create-confirmation",o=this.getResource(i).format(e,t);this.app.command("AddResultsStatus").execute(o)},i.prototype._assertNameNotNull=function(e){if(a.isNullOrUndefined(e))throw new Error("The selection name must be set.")},i}(o.ViewModelBase);i.SaveSelectionViewModel=r})},"Mapping/modules/Selection/SelectableSelectionItem":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function o(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(o.prototype=i.prototype,new o)}}();define(["require","exports","./SelectionItem","geocortex/framework/observables"],function(t,i,o,n){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var a=function(t){function i(e){var i=t.call(this,e)||this;return i.isSelected=new n.Observable(!1),i}return e(i,t),i}(o.SelectionItem);i.SelectableSelectionItem=a})},"Mapping/modules/Selection/SelectionItem":function(){define(["require","exports","geocortex/framework/observables","geocortex/infrastructure/FormatUtils","geocortex/framework-ui/LazyObservable","geocortex/infrastructure/selection/StarredSelection"],function(e,t,i,o,n,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e){var t=this;this.disabled=new i.Observable(!1),this.canModify=new i.Observable(!0),this.id=e.id,this.featureSetCollectionId=e.featureSetCollectionId,this.name=e.name||"",this.count=e.count||0,this.modified=e.modified||!1,this.timeCreated=e.timeCreated,this.timeModified=e.timeModified,this.timeExpiration=e.timeExpiration,this.dateCreated=o.parseUtcDate(this.timeCreated),this.dateModified=o.parseUtcDate(this.timeModified),this.dateExpiration=o.parseUtcDate(this.timeExpiration),this.displayName=new n.LazyObservable(null,function(){return t.formatDisplayName()}),e.name===a.fsc.displayName.get()&&this.canModify.set(!1)}return e.prototype.formatDisplayName=function(){var e=this.name||"",t=this.count||0;return e?"{0} ({1})".format(e,t):""},e.prototype.toMetaData=function(){return{id:this.id,featureSetCollectionId:this.featureSetCollectionId,name:this.name,count:this.count,modified:this.modified,timeCreated:this.timeCreated,timeModified:this.timeModified,timeExpiration:this.timeExpiration}},e}();t.SelectionItem=r})},"Mapping/modules/Selection/SelectionModule":function(){var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function o(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(o.prototype=i.prototype,new o)}}();define(["require","exports","geocortex/framework/application/ModuleBase","geocortex/infrastructure/selection/SelectionMetadataStore","geocortex/framework/observables","geocortex/infrastructure/FeatureSetCollection","geocortex/infrastructure/validation/NumberValidator","geocortex/infrastructure/commandArgs/AddStatusArgs","geocortex/infrastructure/eventArgs/FeatureSetManagerEventArgs","geocortex/infrastructure/FeatureSet","geocortex/framework/utils/ArrayUtils","geocortex/infrastructure/selection/CombineMode","geocortex/infrastructure/results/ResultsUtils","geocortex/infrastructure/selection/StarredSelection","../Shells/Small/PanelPosition","geocortex/framework/utils/utils"],function(t,i,o,n,a,r,s,l,c,u,d,p,m,h,g,f){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var S=function(t){function i(e,i){var o=t.call(this,e,i)||this;return o._fscSourceName="Selection",o._extPropName="SelectionName",o._resultsListStatusRegion="DataFrameResultsStatusRegion",o._resultsTableStatusRegion="ResultsStatusRegion",o._statusView=null,o._featureSetCollection=new a.Observable,o._adhocFeatureSetCollection=new r.FeatureSetCollection,o._persistStarHighlights=!1,o._metadataStore=new n.SelectionMetadataStore(e),o}return e(i,t),i.prototype.initialize=function(e){var i=this;t.prototype.initialize.call(this,e),(e=e||{}).hasOwnProperty("resultsListStatusRegion")&&(this._resultsListStatusRegion=e.resultsListStatusRegion),e.hasOwnProperty("resultsTableStatusRegion")&&(this._resultsTableStatusRegion=e.resultsTableStatusRegion),this.app.menuRegistry.loadMenus(e),this._statusRegionName=this._resultsListStatusRegion,this._adhocFeatureSetCollection.displayName.set(this.app.getResource("Mapping.Infrastructure","language-selection-default-results-name")),this._adhocFeatureSetCollection.sourceName="Selection",this._adhocFeatureSetCollection.id=m.DEFAULT_COLLECTION_ID,this.app.featureSetManager.addCollection(this._adhocFeatureSetCollection),this._featureSetCollection.set(this._adhocFeatureSetCollection),this.app.waitUntilApplicationReady().then(function(){var e=d.firstOrDefault(i.app.configModel.widgetConfigs,function(e){return"SelectionStar"===e.id});e&&(i._persistStarHighlights=!f.isNullOrUndefined(e.configuration.persistHighlights)&&e.configuration.persistHighlights)}),this._registerCommands(),this._subscribeEvents()},i.prototype.getStateFilter=function(){var e=new s.NumberValidator;return{results:this.app.project.filter.featureSetCollection,selections:{item:{id:!0,name:!0,featureSetCollectionId:!0,count:e,modified:!0,timeCreated:e,timeModified:e,timeExpiration:e}}}},i.prototype.exportState=function(){var e=this;return Promise.try(function(){return{results:e.app.project.convert.fromGcxFeatureSetCollection(e._featureSetCollection.get()),selections:e._metadataStore.findAll()}})},i.prototype.applyState=function(e){var t=this;return Promise.try(function(){return t._metadataStore.clear(),t.app.project.convert.toGcxFeatureSetCollection(e.results).then(function(i){t._featureSetCollection.set(i),(e.selections||[]).forEach(function(e){t._metadataStore.add(e)}),t._notifyCanExecuteChanged()})})},i.prototype._registerCommands=function(){var e=this;this.app.command("FindAllSelectionMetadata").register(this,this._executeFindAllSelectionMetadata),this.app.command("FindMetadataForSelection").register(this,this._executeFindMetadataForSelection),this.app.command("FindSelection").register(this,this._executeFindSelection,this._canFindSelection),this.app.command("CreateSelection").register(this,this._executeCreateSelection,this._canCreateSelection),this.app.command("UpdateSelection").register(this,this._executeUpdateSelection,this._canUpdateSelection),this.app.command("RestoreSelection").register(this,this._executeRestoreSelection,this._canRestoreSelection),this.app.command("DeleteSelection").register(this,this._executeDeleteSelection,this._canDeleteSelection),this.app.command("RenameSelection").register(this,this._executeRenameSelection,this._canRenameSelection),this.app.command("AddFeatureToStarredSelection").register(this,this._executeAddToStarredSelection,this._canAddToStarredSelection),this.app.command("RemoveFeatureFromStarredSelection").register(this,this._executeRemoveFromStarredSelection,this._canRemoveFromStarredSelection),this.app.command("AddFeatureSetToStarredSelection").register(this,this._executeAddFeatureSetToStarred,this._canAddFeatureSetToStarred),this.app.command("RemoveFeatureSetFromStarredSelection").register(this,this._executeSubtractFeatureSetFromStarred,this._canSubtractFeatureSetFromStarred),this.app.command("ClearStarredSelection").register(this,this._executeClearStarredSelection,function(){return h.fsc.countFeatures()>0}),this.app.command("ShowStarredSelection").register(this,this._executeShowStarredSelection,function(){return h.fsc.countFeatures()>0}),this.app.command("ShowSelection").register(this,this._executeShowSelection,this._canShowSelection),this.app.command("AddFeatureToResults").register(this,this._executeAddFeatureToResults,this._canAddFeatureToResults),this.app.command("RemoveFeatureFromResults").register(this,this._executeRemoveFeatureFromResults,this._canRemoveFeatureFromResults),this.app.command("AddFeatureToResultsAtIndex").register(this,this._executeAddFeatureToResultsAtIndex,this._canExecuteAddFeatureToResultsAtIndex),this.app.command("_AddFeatureToResultsWhenOriginalFeatureExists").register(this,this._executeAddFeatureToResultsWhenOriginalFeatureExists,this._canAddFeatureToResults),this.app.command("CombineResults").register(this,this._executeCombineResults,this._canCombineResults),this.app.command("ResultsReplace").register(this,this._executeReplaceResults,this._canReplaceResults),this.app.command("ResultsUnion").register(this,this._executeUnionResults,this._canUnionResults),this.app.command("ResultsSubtract").register(this,this._executeSubtractResults,this._canSubtractResults),this.app.command("ResultsIntersect").register(this,this._executeIntersectResults,this._canIntersectResults),this.app.command("AddResultsStatus").register(this,this.addStatus),this.app.command("RemoveResultsStatus").register(this,this.removeStatus),this.app.command("ShowResultsList").register(this,function(t){e._showResultsViewImpl(e._resultsListStatusRegion,t)}),this.app.command("ShowResultsTable").register(this,function(t){e._showResultsViewImpl(e._resultsTableStatusRegion,t)},function(){return!e.app.configuration.mobileMode})},i.prototype._subscribeEvents=function(){this.app.event("ResultsViewCollapsedEvent").subscribe(this,this._handleResultsViewCollapsed),this.app.event("FSMCollectionRemovedEvent").subscribe(this,this._handleFsmCollectionRemovedEvent),this.app.event("FSMCollectionChangedEvent").subscribe(this,this._handleFsmCollectionChangedEvent),this.app.event("FeatureDeletedEvent").subscribe(this,this._updateMetadataForSavedSelections),this.app.event("GraphicRemovedEvent").subscribe(this,this._updateMetadataForSavedSelections),this.app.command("_updateMetadataForSavedSelections").register(this,this._updateMetadataForSavedSelections)},i.prototype.addStatus=function(e){var t,i=this;"string"==typeof e?(t=new l.AddStatusArgs(e)).timeoutMS=0:t=e,t.regionName=t.regionName||this._statusRegionName,t.id=t.id||"ResultsStatusMessageView",this.app.command("RemoveResultsStatus").execute(),this.app.configuration.mobileMode&&"ResultsStatusMessageView"===t.id?this.app.command("_getCurrentBottomPanelPosition").execute(function(e){e!==g.PanelPosition.Maximized&&e!==g.PanelPosition.Partial||i.app.command("AddStatus").execute(t)}):this.app.command("AddStatus").execute(t)},i.prototype.removeStatus=function(){this.app.command("RemoveStatus").execute("ResultsStatusMessageView")},i.prototype._showResultsViewImpl=function(e,t){this._setStatusRegion(e);var i=null;"string"==typeof t?i=this.app.featureSetManager.getCollectionById(t):t instanceof r.FeatureSetCollection&&(i=t),i&&i!==this._featureSetCollection.get()&&this._featureSetCollection.set(i),this._notifyCanExecuteChanged()},i.prototype._handleFsmCollectionChangedEvent=function(e){this._featureSetCollection.get()&&e&&e.featureSetCollectionId&&e.featureSetCollectionId===this._featureSetCollection.get().id&&this._featureSetCollection.get().sourceName===this._fscSourceName&&(this._featureSetCollection.get().isModified.set(!0),this.app.command("ShowSaveSelectionDialog").raiseCanExecuteChanged())},i.prototype._handleFsmCollectionRemovedEvent=function(e){this._featureSetCollection.get()&&e&&e.featureSetCollectionId&&e.featureSetCollectionId===this._featureSetCollection.get().id&&(this._featureSetCollection.set(null),this.app.command("ShowSaveSelectionDialog").raiseCanExecuteChanged())},i.prototype._updateMetadataForSavedSelections=function(e){var t=this,i=null;e instanceof r.FeatureSetCollection&&(i=e),(this._metadataStore.findAll()||[]).forEach(function(e){var o=t.app.featureSetManager.getCollectionById(e.featureSetCollectionId);if(!i||i&&o===i){var n=(new Date).getTime();e.count=o.countFeatures(),e.timeModified=n,t._metadataStore.updateById(e.id,e)}})},i.prototype._setStatusRegion=function(e){this._statusRegionName=e||this._resultsListStatusRegion},i.prototype._handleResultsViewCollapsed=function(e){e&&this._statusView&&this.app.command("RemoveResultsStatus").execute()},i.prototype._copyFeatureSets=function(e,t,i){if(void 0===i&&(i=!1),e&&t&&e!==t){i&&t.clear();for(var o=0;o<e.featureSets.length();o++){var n=e.featureSets.getAt(o);if(n){var a=n.clone();t.featureSets.addItem(a)}}}},i.prototype._copyExtendedProperties=function(e,t,i){void 0===i&&(i=!1),e&&t&&e!==t&&(i&&t.extendedProperties.clear(),e.extendedProperties.getItems().forEach(function(e){return t.setExtendedProperty(e.name,e.value)}))},i.prototype._copy=function(e){var t=new r.FeatureSetCollection;return t.sourceName=e.sourceName,t.displayName.set(e.displayName.get()),t.isModified.set(e.isModified.get()),t.tag=e.tag,this._copyExtendedProperties(e,t,!0),this._copyFeatureSets(e,t,!0),this.app.featureSetManager.addCollection(t),t},i.prototype._create=function(e,t){var i=new r.FeatureSetCollection;return i.sourceName=this._fscSourceName,i.tag=t.tag,i.displayName.set(e),this._copyFeatureSets(t,i,!0),this._copyExtendedProperties(t,i,!0),i.setExtendedProperty(this._extPropName,e),this.app.featureSetManager.addCollection(i),this._createMetadata(e,i),i},i.prototype._createMetadata=function(e,t){if(!t)throw new Error("Cannot create metadata for selection: A feature set collection is required.");if(!e)throw new Error("Cannot create metadata for selection: The selection name is required.");var i=(new Date).getTime(),o={id:null,name:e,featureSetCollectionId:t.id,count:t.countFeatures(),modified:!1,timeCreated:i,timeModified:i};return this._metadataStore.add(o)},i.prototype._update=function(e,t,i){t.tag=i.tag,this._copyFeatureSets(i,t,!0),this._copyExtendedProperties(i,t,!0),t.setExtendedProperty(this._extPropName,e.name),t.isModified.set(!1),i.isModified.set(!1);var o=(new Date).getTime();e.timeModified=o,e.count=t.countFeatures(),e.modified=!1,this._metadataStore.updateById(e.id,e)},i.prototype._restore=function(e){if(!e)throw new Error("Collection is required");this.app.featureSetManager.getCollectionIds().indexOf(e.id)>-1||this.app.featureSetManager.addCollection(e),this._restoreById(e.id)},i.prototype._restoreById=function(e){this.app.featureSetManager.tryCloseCollection(e),this.app.featureSetManager.openCollection(e),this.app.featureSetManager.closeCollection(e)},i.prototype._delete=function(e,t){this.app.featureSetManager.tryCloseCollection(t.id),this.app.featureSetManager.removeCollectionById(t.id),this._metadataStore.removeById(e.id)},i.prototype._rename=function(e,t,i){var o=(new Date).getTime();t.timeModified=o,t.name=e,this._metadataStore.updateById(t.id,t),i.displayName.set(e),i.setExtendedProperty(this._extPropName,e)},i.prototype._existsInCollection=function(e,t){if(!e||!e.featureSet&&!e.layer)return!1;if(!t)throw new Error("FeatureSetCollection is required");for(var i=0;i<t.featureSets.getLength();i++){var o=t.featureSets.getAt(i),n=o.layer;if(e.featureSet&&e.featureSet.id===o.id)return o.containsFeature(e);if(e.layer){var a=e.layer===n||e.layer&&n&&e.layer.id===n.id,r=e.layer===n||e.layer&&n&&e.layer.mapService===n.mapService||e.layer&&n&&e.layer.mapService&&n.mapService&&e.layer.mapService.id===n.mapService.id;if(a&&r)return o.containsFeature(e)}}return!1},i.prototype._tryAddToCollection=function(e,t,i){if(!t||!e)return!1;var o=null,n=e.featureSet?e.featureSet.id:null,a=e.layer;if(n&&(o=t.getFeatureSetById(n)),!o&&a&&(o=t.getFeatureSetByLayer(a)),!o&&!e.layer&&e.esriFeature&&e.esriFeature.get()&&e.esriFeature.get().getLayer()&&(o=t.getFeatureSetbyEsriLayer(e.esriFeature.get().getLayer())),!o){if(e.featureSet)o=e.featureSet.cloneStructure();else{var r=void 0;!e.layer&&e.esriFeature&&e.esriFeature.get()&&e.esriFeature.get().getLayer()&&e.esriFeature.get().getLayer().id&&(r=e.esriFeature.get().getLayer().id),o=new u.FeatureSet({app:this.app,layer:e.layer,esriFeatureSet:new esri.tasks.FeatureSet,id:r})}t.featureSets.addItem(o)}return o.addFeatureAt(e,!1,i),!0},i.prototype._tryRemoveFromCollection=function(e,t){if(!t||!e)return!1;var i=null,o=e.featureSet?e.featureSet.id:null,n=e.layer,a=!1;if(o&&(i=t.getFeatureSetById(o)),!i&&n&&(i=t.getFeatureSetByLayer(n)),!i&&!e.layer&&e.esriFeature&&e.esriFeature.get()&&e.esriFeature.get().getLayer()&&(i=t.getFeatureSetbyEsriLayer(e.esriFeature.get().getLayer())),i)if(1===i.features.length()&&(e.getExtendedPropertyByName("isShownInMaptip")||e.getExtendedPropertyByName("isShownInFeaturedetails"))){for(var r=0;r<t.featureSets.length();r++)if(t.featureSets.getAt(r)===i){var s=i.clone();a=i.removeFeature(e),e.featureSet=s,t.featureSets.removeItem(i)}}else a=i.removeFeature(e),0===i.features.getLength()&&(t.featureSets.removeItem(i),a=!0);return a},i.prototype._notifyCanExecuteChanged=function(){this.app.command("AddFeatureToResults").raiseCanExecuteChanged(),this.app.command("RemoveFeatureFromResults").raiseCanExecuteChanged(),this.app.command("CombineResults").raiseCanExecuteChanged(),this.app.command("ResultsReplace").raiseCanExecuteChanged(),this.app.command("ResultsUnion").raiseCanExecuteChanged(),this.app.command("ResultsSubtract").raiseCanExecuteChanged(),this.app.command("ResultsIntersect").raiseCanExecuteChanged(),this.app.command("ShowSelection").raiseCanExecuteChanged()},i.prototype._notifySelectionCanExecuteChanged=function(){var e=this;this.app.command("AddFeatureToStarredSelection").raiseCanExecuteChanged(),this.app.command("RemoveFeatureFromStarredSelection").raiseCanExecuteChanged(),this.app.command("AddFeatureSetToStarredSelection").raiseCanExecuteChanged(),this.app.command("RemoveFeatureSetFromStarredSelection").raiseCanExecuteChanged(),this.app.command("ClearStarredSelection").raiseCanExecuteChanged(),setTimeout(function(){e.app.command("ShowSelection").raiseCanExecuteChanged(),e.app.command("ShowStarredSelection").raiseCanExecuteChanged()})},i.prototype._notifyFeatureSetCollectionChanged=function(e){e||(e=this._featureSetCollection.get());var t=new c.FeatureSetManagerEventArgs({sender:this,featureSetCollection:e,featureSetCollectionId:e.id});this.app.event("FSMCollectionChangedEvent").publish(t)},i.prototype._handleAddedFeature=function(e,t){t===this._featureSetCollection.get()&&(this._notifyCanExecuteChanged(),this.app.event("_featureAddedToResults").publish(e)),t===h.fsc&&this._notifySelectionCanExecuteChanged(),this._notifyFeatureSetCollectionChanged(t);var i=this.getResource("language-common-results-added-confirmation").format(1,t.displayName.get()||this.app.getResource("Mapping.Infrastructure","language-selection-default-results-name"));this.app.command("AddResultsStatus").execute(i)},i.prototype._handleRemovedFeature=function(e,t){if(t===this._featureSetCollection.get()&&(this._notifyCanExecuteChanged(),this.app.event("_featureRemovedFromResults").publish(e)),t===h.fsc&&this._notifySelectionCanExecuteChanged(),this._notifyFeatureSetCollectionChanged(t),t!==this._featureSetCollection.get()||!this.app.configuration.mobileMode||t.firstFeature()){var i=this.getResource("language-common-results-removed-confirmation").format(1,t.displayName.get()||this.getResource("language-selection-default-selection-name"));this.app.command("AddResultsStatus").execute(i)}},i.prototype._updateFeatureSelectedStatus=function(e,t,i){if(e.selected.value=t,i||(i=e.featureSet),this.app.event("FeatureChangedEvent").publish(e),i)for(var o=0,n=this.app.featureSetManager.featureSetCollections.getItems();o<n.length;o++){var a=n[o],r=d.firstOrDefault(a.featureSets.getItems(),function(e){return e.id===i.id});if(r&&r!==i){var s=r.findFeatureById(e.id.get());s&&(s.selected.value=t,this.app.event("FeatureChangedEvent").publish(s))}}},i.prototype._executeShowSelection=function(){var e=this._metadataStore.findAll();e.length>1?this.app.command("ListSelections").execute():e[0]&&this.app.command("RestoreSelection").execute({name:e[0].name})},i.prototype._executeShowStarredSelection=function(){var e=this._copy(h.fsc);this._restore(e),this._notifyCanExecuteChanged()},i.prototype._executeClearStarredSelection=function(){for(var e=0,t=h.fsc.featureSets.getItems();e<t.length;e++)for(var i=0,o=t[e].features.getItems();i<o.length;i++){var n=o[i];n.selected.value=!1,this._updateFeatureSelectedStatus(n,!1)}this.app.highlightManager.redrawHighlights(),h.fsc.clear(),this.app.command("DeleteSelection").execute({name:h.fsc.displayName.get()}),this._notifySelectionCanExecuteChanged()},i.prototype._executeAddFeatureSetToStarred=function(e){for(var t=0,i=e.features.getItems();t<i.length;t++){var o=i[t];o.selected.get()||this._updateFeatureSelectedStatus(o,!0,e)}var n=d.firstOrDefault(h.fsc.featureSets.getItems(),function(t){return t.id===e.id});n?(n.unionInPlace(e),this._notifyFeatureSetCollectionChanged(h.fsc)):h.fsc.featureSets.addItem(e.clone()),this._persistStarHighlights&&this.app.highlightManager.highlightSelected(e.features.get()),0===this._metadataStore.find({name:h.fsc.displayName.get()}).length&&this.app.command("CreateSelection").execute({name:h.fsc.displayName.get(),featureSetCollection:h.fsc}),this._notifySelectionCanExecuteChanged()},i.prototype._executeSubtractFeatureSetFromStarred=function(e){for(var t=0,i=e.features.getItems();t<i.length;t++){var o=i[t];o.selected.get()&&this._updateFeatureSelectedStatus(o,!1,e)}var n=d.firstOrDefault(h.fsc.featureSets.getItems(),function(t){return t.id===e.id});n&&(n.subtractInPlace(e),0===n.features.getLength()&&h.fsc.featureSets.removeItem(n),this.app.highlightManager.redrawHighlights(),this._notifyFeatureSetCollectionChanged(h.fsc)),0===h.fsc.countFeatures()&&this.app.command("DeleteSelection").execute({name:h.fsc.displayName.get()}),this._notifySelectionCanExecuteChanged()},i.prototype._executeAddToStarredSelection=function(e){this._tryAddToCollection(e,h.fsc)&&(this._persistStarHighlights&&this.app.highlightManager.highlightSelected([e]),this._updateFeatureSelectedStatus(e,!0),this._handleAddedFeature(e,h.fsc),0===this._metadataStore.find({name:h.fsc.displayName.get()}).length&&this.app.command("CreateSelection").execute({name:h.fsc.displayName.get(),featureSetCollection:h.fsc}))},i.prototype._executeAddFeatureToResultsAtIndex=function(e){this._executeAddFeatureToResults(e.feature,e.featureSetIndex)},i.prototype._executeAddFeatureToResultsWhenOriginalFeatureExists=function(e){this._executeAddFeatureToResults(e.feature,e.featureSetIndex,e.originalFeature)},i.prototype._executeAddFeatureToResults=function(e,t,i){0===this._featureSetCollection.get().featureSets.getLength()&&(this._adhocFeatureSetCollection.featureSets.getLength()>0&&this._adhocFeatureSetCollection.clear(),this._featureSetCollection.set(this._adhocFeatureSetCollection));var o=this._featureSetCollection.get();if(i){var n=!1;if(o&&o.featureSets&&o.featureSets.get()&&o.featureSets.get().length>0)for(var a=0;a<o.featureSets.get().length&&!n;a++){var r=o.featureSets.getAt(a);if(r&&r.features&&r.features.get()&&r.features.get().length>0)for(var s=0;s<r.features.get().length&&!n;s++)i.structurallyEquals(r.features.getAt(s))&&(n=!0)}if(!n)return}this._tryAddToCollection(e,o,t)&&(o===h.fsc&&(e.selected.value=!0,this._updateFeatureSelectedStatus(e,!0)),this._handleAddedFeature(e,o))},i.prototype._executeRemoveFromStarredSelection=function(e){var t=e.featureSet;this._tryRemoveFromCollection(e,h.fsc)&&(this._updateFeatureSelectedStatus(e,!1,t),this._handleRemovedFeature(e,h.fsc),0===h.fsc.countFeatures()&&this.app.command("DeleteSelection").execute({name:h.fsc.displayName.get()}))},i.prototype._executeRemoveFeatureFromResults=function(e){this._tryRemoveFromCollection(e,this._featureSetCollection.get())&&(this._featureSetCollection.get()===h.fsc&&(e.selected.value=!1,this._updateFeatureSelectedStatus(e,!1)),this._handleRemovedFeature(e,this._featureSetCollection.get()))},i.prototype._executeFindAllSelectionMetadata=function(e){((e=e||{}).successCallback||this._noop)(this._metadataStore.findAll())},i.prototype._executeFindMetadataForSelection=function(e){var t=(e=e||{}).successCallback||this._noop,i=e.errorCallback||this._noop,o=e.name,n=e.featureSetCollectionId;if(o||n){var a={};o&&(a.name=o),n&&(a.featureSetCollectionIds=[n]);var r=this._metadataStore.find(a);t(d.firstOrDefault(r))}else i(new Error("Cannot fetch selection metadata: A selection name or feature set collection ID is required."))},i.prototype._executeFindSelection=function(e){var t=null,i=(e=e||{}).successCallback||this._noop,o=e.name,n=o?this._metadataStore.findByName(o):null,a=n?this.app.featureSetManager.getCollectionById(n.featureSetCollectionId):null;a&&(t=this._copy(a)),i(t)},i.prototype._executeCreateSelection=function(e){var t=(e=e||{}).successCallback||this._noop,i=e.errorCallback||this._noop,o=e.featureSetCollection,n=e.name;if(n){var a="string"==typeof o?this.app.featureSetManager.getCollectionById(o):o,r=this._copy(this._create(n,a));t(),this.app.event("SelectionCreatedEvent").publish({name:n,featureSetCollection:r}),this._notifyCanExecuteChanged()}else i(new Error("Cannot create named selection: The selection name is required."))},i.prototype._executeUpdateSelection=function(e){var t=(e=e||{}).successCallback||this._noop,i=e.errorCallback||this._noop,o=e.featureSetCollection,n=e.name;if(n){var a=this._metadataStore.findByName(n);if(a&&a.id){var r="string"==typeof o?this.app.featureSetManager.getCollectionById(o):o,s=this.app.featureSetManager.getCollectionById(a.featureSetCollectionId);if(s){this._update(a,s,r);var l=this._copy(s);t(),this.app.event("SelectionChangedEvent").publish({name:n,previousName:n,featureSetCollection:l}),this._notifyCanExecuteChanged()}else i(new Error("Cannot update named selection: feature set collection '{0}' not found.".format(a.featureSetCollectionId)))}}else i(new Error("Cannot update named selection: The selection name is required."))},i.prototype._executeRestoreSelection=function(e){var t,i=(e=e||{}).successCallback||this._noop,o=e.errorCallback||this._noop,n=e.name;if(n){var a=this._metadataStore.findByName(n);if(a)if(t=this.app.featureSetManager.getCollectionById(a.featureSetCollectionId)){var r=this._copy(t);this._restore(r),i(),this._notifyCanExecuteChanged()}else o(new Error("Cannot restore named selection: feature set collection '{0}' not found.".format(a.featureSetCollectionId)));else o(new Error("Cannot restore named selection: '{0}' not found.".format(n)))}else o(new Error("Cannot restore named selection: The selection name is required."))},i.prototype._executeDeleteSelection=function(e){var t,i=(e=e||{}).successCallback||this._noop,o=e.errorCallback||this._noop,n=e.name;if(n){var a=this._metadataStore.findByName(n);a?(t=this.app.featureSetManager.getCollectionById(a.featureSetCollectionId))?(this._delete(a,t),i(),this.app.event("SelectionRemovedEvent").publish({name:n,featureSetCollection:t}),this._notifyCanExecuteChanged()):o(new Error("Cannot delete named selection: feature set collection '{0}' not found.".format(a.featureSetCollectionId))):o(new Error("Cannot delete named selection: '{0}' not found.".format(n)))}else o(new Error("Cannot delete named selection: The selection name is required."))},i.prototype._executeRenameSelection=function(e){var t=(e=e||{}).successCallback||this._noop,i=e.errorCallback||this._noop,o=e.name,n=e.newName;if(o&&n){var a=this._metadataStore.findByName(o);if(a&&a.id){var r=this.app.featureSetManager.getCollectionById(a.featureSetCollectionId);if(r){this._rename(n,a,r);var s=this._copy(r),l=this._featureSetCollection.get();if(l&&l.sourceName===this._fscSourceName){var c=l.getExtendedPropertyByName(this._extPropName);c&&c===o&&(l.displayName.set(n),l.setExtendedProperty(this._extPropName,n))}t(),this.app.event("SelectionChangedEvent").publish({name:n,previousName:o,featureSetCollection:s}),this._notifyCanExecuteChanged()}else i(new Error("Cannot rename selection: feature set collection '{0}' not found.".format(a.featureSetCollectionId)))}else i(new Error("Cannot rename selection: '{0}' not found.".format(o)))}else i(new Error("Cannot rename selection: The selection name is required."))},i.prototype._getCombineResultsCommandArgs=function(e,t){var i="string"==typeof e?e:e.id;return i?{combineMode:t||p.CombineMode.REPLACE,currentResults:this._featureSetCollection.get(),featureSetCollectionIds:[i]}:null},i.prototype._executeReplaceResults=function(e){var t=this._getCombineResultsCommandArgs(e,p.CombineMode.REPLACE);this._executeCombineResults(t)},i.prototype._executeUnionResults=function(e){var t=this._getCombineResultsCommandArgs(e,p.CombineMode.UNION);this._executeCombineResults(t)},i.prototype._executeSubtractResults=function(e){var t=this._getCombineResultsCommandArgs(e,p.CombineMode.SUBTRACT);this._executeCombineResults(t)},i.prototype._executeIntersectResults=function(e){var t=this._getCombineResultsCommandArgs(e,p.CombineMode.INTERSECT);this._executeCombineResults(t)},i.prototype._executeCombineResults=function(e){var t=this;if(e&&e.featureSetCollectionIds&&0!==e.featureSetCollectionIds.length){var i,o=e.currentResults;if((i="string"==typeof o?this.app.featureSetManager.getCollectionById(o):o)||(i=this._featureSetCollection.get()),i){var n=e.featureSetCollectionIds.map(function(e){return t.app.featureSetManager.getCollectionById(e)}).filter(function(e){return null!=e}).map(function(e){return e.clone(!0)}),a=e.combineMode||p.CombineMode.REPLACE,r=e.successCallback,s=!1;switch(a){case p.CombineMode.REPLACE:var l=n&&n.length>0?n[0]:null;l&&(i.clear(),i.featureSets.addItems(l.featureSets.getItems()));break;case p.CombineMode.UNION:s=i.unionManyInPlace(n);break;case p.CombineMode.SUBTRACT:s=i.subtractManyInPlace(n);break;case p.CombineMode.INTERSECT:s=i.intersectManyInPlace(n)}if(this._featureSetCollection.get().featureSets!==i.featureSets){this.app.command("HideFeatureSetResultsView").execute();for(var c=this._featureSetCollection.get().featureSets.getLength(),u=0;u<c;u++)this._featureSetCollection.get().featureSets.removeAt(0);this._featureSetCollection.get().featureSets.addItems(i.featureSets.getItems())}s&&(this._notifyCanExecuteChanged(),this._notifyFeatureSetCollectionChanged()),r&&r({updatedCollection:i,combineMode:a,modified:s})}}},i.prototype._canShowSelection=function(){return this._metadataStore.findAll().length>0},i.prototype._canExecuteAddFeatureToResultsAtIndex=function(e){return"number"==typeof e.featureSetIndex&&this._canAddFeatureToResults(e.feature)},i.prototype._canAddToStarredSelection=function(e){return!this._existsInCollection(e,h.fsc)},i.prototype._canAddFeatureToResults=function(e){var t=this._featureSetCollection.get();return!(!t||!e)&&!this._existsInCollection(e,t)},i.prototype._canRemoveFromStarredSelection=function(e){return this._existsInCollection(e,h.fsc)},i.prototype._canRemoveFeatureFromResults=function(e){var t=this._featureSetCollection.get();return!(!t||!e)&&this._existsInCollection(e,t)},i.prototype._canSubtractFeatureSetFromStarred=function(e){return e.features.getItems().some(function(e){return e.selected.get()})},i.prototype._canAddFeatureSetToStarred=function(e){return e.features.getItems().some(function(e){return!e.selected.get()})},i.prototype._canFindSelection=function(e){return!0},i.prototype._canCreateSelection=function(e){return!0},i.prototype._canUpdateSelection=function(e){return!0},i.prototype._canRestoreSelection=function(e){return!0},i.prototype._canDeleteSelection=function(e){return!0},i.prototype._canRenameSelection=function(e){return!0},i.prototype._canReplaceResults=function(e){return!0},i.prototype._canUnionResults=function(e){return!0},i.prototype._canSubtractResults=function(e){return!0},i.prototype._canIntersectResults=function(e){return!0},i.prototype._canCombineResults=function(e){return!0},i.prototype._noop=function(){},i}(o.ModuleBase);i.SelectionModule=S})},"Mapping/modules/Selection/SelectionState":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"url:/Mapping/modules/Selection/CombineResultsView.html":t,"url:/Mapping/modules/Selection/ListSelectionsView.html":i,"url:/Mapping/modules/Selection/SaveSelectionView.html":o}}),require(["geocortex/framework/resourceManager"],function(e){e.resourceManager.register("Mapping","inv","Mapping/modules/Selection/CSS/common.css","css","LyogU0FWRSBTRUxFQ1RJT05TIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLw0KLnNhdmUtc2VsZWN0aW9uLXZpZXcgew0KICAgIHBhZGRpbmc6IDFlbTsNCn0NCg0KLnNhdmUtc2VsZWN0aW9uLXZpZXcgLnNhdmUtYnV0dG9uLmJvdW5kLWRpc2FibGVkOmhvdmVyIHsNCiAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjRjVGNUY1Ow0KICAgIGNvbG9yOiAjMUE3MkM0Ow0KfQ0KDQovKiBMT0FEIFNFTEVDVElPTlMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovDQoNCi5saXN0LXNlbGVjdGlvbnMtdmlldyAubm8taXRlbSBwLmRlc2NyaXB0aW9uIHsNCiAgICBmb250LXN0eWxlOiBpdGFsaWM7DQp9DQoubGlzdC1zZWxlY3Rpb25zLXZpZXcgLmxpc3QtbWVudS1pdGVtLA0KLmxpc3Qtc2VsZWN0aW9ucy12aWV3IC5saXN0LW1lbnUtaXRlbSAqIHsNCiAgICAtd2Via2l0LWJveC1zaXppbmc6IGJvcmRlci1ib3g7DQogICAgLW1vei1ib3gtc2l6aW5nOiBib3JkZXItYm94Ow0KICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7DQp9DQoubGlzdC1zZWxlY3Rpb25zLXZpZXcgLmxpc3QtbWVudS1pdGVtIHsNCiAgICBwYWRkaW5nOiAwOw0KICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsNCn0NCi5saXN0LXNlbGVjdGlvbnMtdmlldyAubGlzdC1tZW51LWl0ZW0gLmxpc3QtbWVudS1uYW1lIHsNCiAgICBkaXNwbGF5OiBibG9jazsNCn0NCi5saXN0LXNlbGVjdGlvbnMtdmlldyAubGlzdC1tZW51LWRlc2Mgew0KICAgIGZsb2F0OiBsZWZ0Ow0KfQ0KLmxpc3Qtc2VsZWN0aW9ucy12aWV3IC5saXN0LW1lbnUtaXRlbTpob3ZlciB7DQogICAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7DQp9DQoubGlzdC1zZWxlY3Rpb25zLXZpZXcgLnNlbGVjdGlvbi1jb250ZW50cyB7DQogICAgd2lkdGg6IDEwMCU7DQogICAgbWluLWhlaWdodDogM2VtOw0KICAgIHBhZGRpbmc6IDAuNWVtIDYuNWVtIDAuNWVtIDAuNWVtOw0KICAgIGRpc3BsYXk6IGJsb2NrOw0KICAgIG92ZXJmbG93OiBoaWRkZW47DQogICAgdGV4dC1vdmVyZmxvdzogZWxsaXBzaXM7DQogICAgd2hpdGUtc3BhY2U6IG5vd3JhcDsNCn0NCg0KLmxpc3Qtc2VsZWN0aW9ucy12aWV3IC5hY3Rpb24tYnV0dG9uIHsNCiAgICBwb3NpdGlvbjogYWJzb2x1dGU7DQogICAgdG9wOiAwOw0KICAgIHJpZ2h0OiAzZW07DQogICAgd2lkdGg6IDNlbTsNCiAgICBoZWlnaHQ6IDEwMCU7DQogICAgYm9yZGVyLWxlZnQ6IDFweCBzb2xpZCAjRUVFRUVFOw0KICAgIGJhY2tncm91bmQtcmVwZWF0OiBuby1yZXBlYXQ7DQogICAgYmFja2dyb3VuZC1wb3NpdGlvbjogY2VudGVyOw0KICAgIGJhY2tncm91bmQtY29sb3I6ICNGRkZGRkY7DQogICAgbWFyZ2luOiAwOw0KICAgIHBhZGRpbmc6IDA7DQp9DQoubGlzdC1zZWxlY3Rpb25zLXZpZXcgLmFjdGlvbi1idXR0b24gKyAuYWN0aW9uLWJ1dHRvbiB7DQogICAgcmlnaHQ6IDA7DQp9DQoubGlzdC1zZWxlY3Rpb25zLXZpZXcgLmxpc3QtbWVudS1pdGVtIGJ1dHRvbjpob3ZlciB7DQogICAgYmFja2dyb3VuZC1jb2xvcjogI0RFRjJGRjsgICANCn0NCg0KLyogUkVGSU5FIFJFU1VMVFMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovDQoubGlzdC1yZWZpbmUtcmVzdWx0cy1oZWFkZXIgew0KICAgIGJvcmRlci1ib3R0b206IDFweCBzb2xpZCAjRDlEOUQ5Ow0KICAgIGJhY2tncm91bmQtY29sb3I6ICNGNUY1RjU7DQogICAgd2lkdGg6IDEwMCU7DQogICAgcGFkZGluZzogLjU0ZW07DQogICAgLXdlYmtpdC1ib3gtc2l6aW5nOiBib3JkZXItYm94Ow0KICAgIC1tb3otYm94LXNpemluZzogYm9yZGVyLWJveDsNCiAgICBib3gtc2l6aW5nOiBib3JkZXItYm94Ow0KfQ0KLmxpc3QtcmVmaW5lLXJlc3VsdHMtaGVhZGVyIHNwYW4gew0KICAgIGZsb2F0OiByaWdodDsNCn0NCi5saXN0LXJlZmluZS1yZXN1bHRzLWhlYWRlcjphZnRlciB7DQogICAgY29udGVudDogIiAiOw0KICAgIGRpc3BsYXk6IGJsb2NrOw0KICAgIGhlaWdodDogMDsNCiAgICBjbGVhcjogYm90aDsNCiAgICB2aXNpYmlsaXR5OiBoaWRkZW47DQp9DQoucmVmaW5lLXJlc3VsdHMgLmxpc3QtbWVudS1pdGVtIHsNCiAgICBwb3NpdGlvbjogcmVsYXRpdmU7DQp9DQoNCg0KLnJlZmluZS1yZXN1bHRzIC5saXN0LW1lbnUtbGFiZWwgew0KICAgIGRpc3BsYXk6IGJsb2NrOw0KICAgIHdpZHRoOiAxMDAlOw0KICAgIGhlaWdodDogMTAwJTsNCiAgICBwYWRkaW5nOiAwLjU1ZW0gMi41ZW0gMC41NWVtIDFlbTsNCiAgICBjdXJzb3I6IHBvaW50ZXI7DQogICAgLXdlYmtpdC1ib3gtc2l6aW5nOiBib3JkZXItYm94Ow0KICAgIC1tb3otYm94LXNpemluZzogYm9yZGVyLWJveDsNCiAgICBib3gtc2l6aW5nOiBib3JkZXItYm94Ow0KfQ0KLnRvdWNoIC5yZWZpbmUtcmVzdWx0cyAubGlzdC1tZW51LWxhYmVsIHsNCiAgICBwYWRkaW5nOiAxZW0gMi41ZW0gMWVtIDFlbTsNCn0NCi5yZWZpbmUtcmVzdWx0cyAubGlzdC1tZW51LWFjdGlvbiB7DQogICAgcG9zaXRpb246IGFic29sdXRlOw0KICAgIHRvcDogMDsNCiAgICByaWdodDogMDsNCiAgICBtYXJnaW46IDAuNzVlbSAxZW07DQp9DQoucmVmaW5lLXJlc3VsdHMgLmZvcm0tYnRucyB7DQogICAgcGFkZGluZzogMWVtOw0KfQ=="),e.resourceManager.register("Mapping","inv","Mapping/modules/Selection/CSS/large.css","css",""),e.resourceManager.register("Mapping","inv","Mapping/modules/Selection/CSS/medium.css","css",""),e.resourceManager.register("Mapping","inv","Mapping/modules/Selection/CSS/small.css","css",""),e.resourceManager.register("Mapping","inv","Mapping/modules/Selection/CombineResultsView.html","html",t),e.resourceManager.register("Mapping","inv","Mapping/modules/Selection/ListSelectionsView.html","html",i),e.resourceManager.register("Mapping","inv","Mapping/modules/Selection/SaveSelectionView.html","html",o)}),require({cache:{}}),define(["Mapping/modules/Selection/CombineResultsView","Mapping/modules/Selection/CombineResultsViewModel","Mapping/modules/Selection/ListSelectionsView","Mapping/modules/Selection/ListSelectionsViewModel","Mapping/modules/Selection/SaveSelectionView","Mapping/modules/Selection/SaveSelectionViewModel","Mapping/modules/Selection/SelectableSelectionItem","Mapping/modules/Selection/SelectionItem","Mapping/modules/Selection/SelectionModule"],function(t,i,o,n,a,r,s,l,c){e(t,"geocortex.essentialsHtmlViewer.mapping.modules.selection.CombineResultsView",t.CombineResultsView),e(i,"geocortex.essentialsHtmlViewer.mapping.modules.selection.CombineResultsViewModel",i.CombineResultsViewModel),e(o,"geocortex.essentialsHtmlViewer.mapping.modules.selection.ListSelectionsView",o.ListSelectionsView),e(n,"geocortex.essentialsHtmlViewer.mapping.modules.selection.ListSelectionsViewModel",n.ListSelectionsViewModel),e(a,"geocortex.essentialsHtmlViewer.mapping.modules.selection.SaveSelectionView",a.SaveSelectionView),e(r,"geocortex.essentialsHtmlViewer.mapping.modules.selection.SaveSelectionViewModel",r.SaveSelectionViewModel),e(s,"geocortex.essentialsHtmlViewer.mapping.modules.selection.SelectableSelectionItem",s.SelectableSelectionItem),e(l,"geocortex.essentialsHtmlViewer.mapping.modules.selection.SelectionItem",l.SelectionItem),e(c,"geocortex.essentialsHtmlViewer.mapping.modules.selection.SelectionModule",c.SelectionModule)})}();