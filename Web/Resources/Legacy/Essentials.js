/*
	
	Copyright (c) 2016, Latitude Geographics Group Ltd.
	All rights reserved.
	       
	Redistribution is not permitted. 
	
	Use in binary form, without modification, is permitted provided that neither 
	the name of the organization nor the names of its contributors may be used 
	to endorse or promote products derived from this software without specific 
	prior written permission.
	       
	THIS SOFTWARE IS PROVIDED BY COPYRIGHT HOLDER ''AS IS'' AND ANY
	EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
	WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
	DISCLAIMED. IN NO EVENT SHALL LATITUDE GEOGRAPHICS GROUP LTD. BE LIABLE FOR ANY
	DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
	(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
	LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
	ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
	(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
	SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
*/


/* Begin Script: _JavaScriptAPI/Essentials/essentials_ts_out.js ------------------------- */ 
var __extends=this&&this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)},geocortex;!function(e){!function(t){var i=function(){function t(e){this.initializationFailure=null,this.isInitialized=!1,this.onInitializationFailed=null,this.onInitialized=null,this._initializing=!1,this.url=e,this._initializedHandler=dojo.hitch(this,this._initializedHandler),this._initializationFailedHandler=dojo.hitch(this,this._initializationFailedHandler),this._restLoadHandler=dojo.hitch(this,this._restLoadHandler),this._restErrorHandler=dojo.hitch(this,this._restErrorHandler)}return t.prototype.initialize=function(t){if(!this.isInitialized&&!this._initializing){var i=void 0!==t&&null!==t;if(i)this._restLoadHandler(!0,t);else{if(!this.url)throw new Error("Unable to initialize AsyncInitializable without a valid URL.");this._initializing=!0,e.request({url:this.url,content:{f:"json"},load:dojo.hitch(this,this._restLoadHandler,i),error:this._restErrorHandler,callbackParamName:"CallBack"})}}},t.prototype.doWhenInitialized=function(e,t){if(1===arguments.length&&(t=e,e=this),this.isInitialized)t.call(e,this);else var i=dojo.connect(this,"onInitialized",this,function(){dojo.disconnect(i),t.apply(e,arguments)})},t.prototype._configureObject=function(e,t){},t.prototype._initializationFailedHandler=function(e){this.initializationFailure=e,this.onInitializationFailed&&this.onInitializationFailed(e)},t.prototype._initializedHandler=function(e){this.isInitialized=!0,this.onInitialized&&this.onInitialized(e),this._initializing=!1},t.prototype._restErrorHandler=function(e){this._initializationFailedHandler(e),this._initializedHandler(this)},t.prototype._restLoadHandler=function(e,t){this._configureObject(t,e),this._initializedHandler(this)},t}();t.AsyncInitializable=i}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){!function(e){var t=function(){function e(e){this.originalUri=e,this.schemeHostAndPath=e.match(/[^?|^#]*/)[0];var t=e.match(/\?([^#]*)/);this.query={},t&&t.length>1&&(this.query=dojo.queryToObject(t[1])),this.fragment=dojo.queryToObject(e.indexOf("#")>=0?e.substring(e.indexOf("#")+1,e.length):"")}return e.prototype.recompose=function(){var e=this.schemeHostAndPath;return this.query&&this.anyProperties(this.query)&&(e+="?"+dojo.objectToQuery(this.query)),this.fragment&&this.anyProperties(this.fragment)&&(e+="#"+dojo.objectToQuery(this.fragment)),e},e.prototype.anyProperties=function(e){for(var t in e)return!0;return!1},e.getHost=function(e){if(!e)return null;var t=e.match(/^http[s]?:\/\/([^\/]*)/);return t.length>1?t[1]:null},e.appendToPath=function(t,i){var r=new e(t);return r.schemeHostAndPath+=i,r.recompose()},e.removeQueryParameters=function(t){for(var i=[],r=1;r<arguments.length;r++)i[r-1]=arguments[r];for(var n=new e(t),s=0,a=i;s<a.length;s++){var o=a[s];delete n.query[o]}return n.recompose()},e}();e.DecomposedUri=t}(e.utilities||(e.utilities={}))}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){!function(e){var t=function(){function e(){}return e.endsWith=function(e,t){return-1!==e.indexOf(t,e.length-t.length)},e.replaceLayerTokens=function(e,t){if(t)switch(e.toLowerCase()){case"layerid":return t.id;case"layername":return t.name;case"layerdisplayname":return t.displayName;case"layerdescription":return t.description}return""},e.replaceMapServicetokens=function(e,t){if(t)switch(e.toLowerCase()){case"mapserviceid":return t.id;case"mapservicedisplayname":return t.displayName;case"mapserviceurl":return t.url;case"mapservicetoken":return t.serviceToken}return""},e.getDateFromRestDateString=function(e){var t=/^\/Date\(-?\d+\)\/$/;if(!(e=e.trim())||!t.test(e))return null;var i=e.substring(e.indexOf("(")+1,e.indexOf(")"));return isNaN(i)?null:new Date(parseInt(i,10))},e}();e.StringUtilities=t,"function"!=typeof String.prototype.endsWith&&(String.prototype.endsWith=function(e){return t.endsWith(this,e)})}(e.utilities||(e.utilities={}))}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){var t=function(){return function(){}}();e.TokenResult=t}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){var t=function(){function t(){}return t.getTokenFromImplicitGrant=function(){var t=window.location.href;if(t.indexOf("#")>0){var i=t.substring(t.indexOf("#")+1,t.length),r=dojo.queryToObject(i);if(!r.access_token)return null;var n=new e.TokenResult;n.token=r.access_token,n.userName=r.username;var s=parseInt(r.expires_in);return s&&(n.expiresOn=new Date((new Date).getTime()+1e3*s)),n}return null},t.getErrorFromImplicitGrant=function(){var e=window.location.href;if(e.indexOf("#")>0){var t=e.substring(e.indexOf("#")+1,e.length),r=dojo.queryToObject(t);if(r.error){var n=new i;return n.code=r.error,n.description=r.error_description,n}}return null},t.applicationHasImplicitGrant=function(){return t.hasFragmentParameter("access_token")},t.applicationHasImplicitGrantError=function(){return t.hasFragmentParameter("error")},t.hasFragmentParameter=function(e){var t=window.location.href;if(t.indexOf("#")<0)return!1;var i=(t=window.location.href).substring(t.indexOf("#")+1,t.length);return!!dojo.queryToObject(i)[e]},t.redirectToLogOnPage=function(i,r){var n=new e.utilities.DecomposedUri(window.location.href);t.removeImplicitGrantParams(n);var s=i+"?client_id="+encodeURIComponent(r)+"&response_type=token&redirect_uri="+encodeURIComponent(n.recompose())+"&expiration=20160";window.location.href=s},t.removeImplicitGrantParamsAndUpdateUrlHash=function(){var i=new e.utilities.DecomposedUri(window.location.href);t.removeImplicitGrantParams(i),window.location.hash=dojo.objectToQuery(i.fragment)},t.removeImplicitGrantParams=function(e){return delete e.fragment.access_token,delete e.fragment.username,delete e.fragment.expires_in,delete e.fragment.error,delete e.fragment.error_description,e},t}();e.OAuth2Client=t;var i=function(){function e(){}return e.ACCESS_DENIED_ERROR_CODE="access_denied",e}();e.OAuth2Error=i}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){var t=function(){function t(e,t,i){this.baseUrl=e,this.domains=t,this.clientId=i}return t.prototype.initiate=function(){return this.tokenResult||(this.tokenResult=e.OAuth2Client.getTokenFromImplicitGrant()),this.tokenResult?(e.OAuth2Client.removeImplicitGrantParamsAndUpdateUrlHash(),!0):(this.error=e.OAuth2Client.getErrorFromImplicitGrant(),this.error||e.OAuth2Client.redirectToLogOnPage(this.getLogOnUrl(),this.clientId),e.OAuth2Client.removeImplicitGrantParamsAndUpdateUrlHash(),!1)},t.prototype.getLogOnUrl=function(){return this.baseUrl+"oauth2/authorize"},t.prototype.getToken=function(e){return this.tokenResult&&e&&this.appliesTo(e)?this.tokenResult.token:null},t.prototype.appliesTo=function(t){for(var i=e.utilities.DecomposedUri.getHost(t),r=0;r<this.domains.length;r++)if(e.utilities.StringUtilities.endsWith(i,this.domains[r]))return!0;return!1},t}();e.ArcGisPortalSecurityContext=t}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){var t=function(){return function(e){if(this.displayName=null,this.essentialsMap=null,this.extensions=[],this.id=null,this.iconUri=null,this.exportTilesMapServiceUri=null,this.properties={},this.services=[],!e)throw new Error("Essentials map is required for a basemap.");this.essentialsMap=e}}();e.BaseMap=t}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){var t=function(){return function(e){if(this.mapService=null,!e)throw new Error("Map service is required for a basemap service.");this.mapService=e}}();e.BaseMapService=t}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){!function(t){var i=function(){function t(t,i){if(this.isRequired=new Observable(!1),this.isValid=new Observable(!0),this.isVisible=new Observable(!0),this.argumentName=null,this.validationItems=[],this.formDefinition=i||null,this.attached_indicatorClass=new Observable(""),this.attached_showIndicator=new Observable(""),t){this.toolTip=new Observable(e.forms.getElementText(t,"ToolTip")),this.itemID=new Observable(e.forms.getElementText(t,"ItemID")),this.argumentName=new Observable(e.forms.getElementText(t,"ArgumentName"));var r=e.forms.getElementText(t,"IsVisible");r&&this.isVisible.set(e.forms._parseBoolean(r));var n=e.forms.getElement(t,"ValidationItems");if(null!=n)for(var s=0;s<n.childNodes.length;s++){var a=e.forms.items._processValidationItem(n.childNodes[s]);a instanceof e.forms.items.validation.RequiredValidationItem&&this.isRequired.set(!0),null!=a&&this.validationItems.push(a)}}else this.toolTip=new Observable(""),this.itemID=new Observable(null),this.argumentName=new Observable(null)}return t.prototype.getResult=function(){return null},t.prototype._notifyResultChanged=function(){dojo.publish("FormItemResultChangedEvent",[this])},t.prototype.refresh=function(){},t.prototype.validate=function(){var e=[];if(this.isValid.set(!0),null!=this.validationItems)for(var t=0;t<this.validationItems.length;t++){var i=this.getResult();null!=i&&(i=i.value);var r=this.validationItems[t].validate(i);r.isValid||(this.isValid.set(!1),e.push(r))}return e},t.prototype._render=function(){return document.createTextNode(this.itemID.get())},t.prototype._destroy=function(){},t}();t.AbstractFormItem=i}(t.items||(t.items={}))}(e.forms||(e.forms={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){!function(t){var i=function(t){function i(i,r){t.call(this,i,r),this.formItemType="LabelFormItem",i?(this.text=new Observable(e.forms.getElementText(i,"Text")),this.labelForItemID=new Observable(e.forms.getElementText(i,"LabelForItemID"))):(this.text=new Observable(null),this.labelForItemID=new Observable(null))}return __extends(i,t),i.prototype._render=function(){return e.forms.renderFormItem(this)},i}(t.AbstractFormItem);t.LabelFormItem=i}(t.items||(t.items={}))}(e.forms||(e.forms={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){!function(t){t.initLabelContainer=function(i,r,n){r?(i.label=new t.LabelFormItem(e.forms.getElement(r,"Label")),""==i.label.toolTip.get()&&null!=i.toolTip&&i.label.toolTip.set(i.toolTip.get())):i.label=new e.forms.items.LabelFormItem(null)}}(t.items||(t.items={}))}(e.forms||(e.forms={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){!function(e){var t=function(){return function(e,t,i){this.isList=!1,this.argumentName=e,this.value=t,this.wasSet=i||!1}}();e.FormItemResult=t}(e.items||(e.items={}))}(e.forms||(e.forms={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){!function(t){var i=function(i){function r(r,n){var s=this;if(i.call(this,r,n),this.formItemType="TextBoxFormItem",r){var a=e.forms.getElementText(r,"DefaultText");this.defaultText=new Observable(a),this.text=new Observable(a),this.inputScope=new Observable(e.forms.getElementText(r,"InputScope")),this.textboxWidth=new Observable(parseInt(e.forms.getElementText(r,"TextboxWidth"))),this.readOnly=new Observable(e.forms._parseBoolean(e.forms.getElementText(r,"ReadOnly")))}else this.defaultText=new Observable(""),this.text=new Observable(""),this.inputScope=new Observable("Default"),this.textboxWidth=new Observable(NaN),this.readOnly=new Observable(!1);t.initLabelContainer(this,r,n),this.text.bind(null,function(e){return s._notifyResultChanged()})}return __extends(r,i),r.prototype.getResult=function(){return new t.FormItemResult(this.argumentName.get(),this.text.get())},r.prototype._render=function(){return e.forms.renderFormItem(this)},r}(t.AbstractFormItem);t.TextBoxFormItem=i}(t.items||(t.items={}))}(e.forms||(e.forms={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){!function(t){var i=function(t){function i(i,r){t.call(this,i,r),this.formItemType="TextAreaFormItem",this.textboxHeight=i?new Observable(parseInt(e.forms.getElementText(i,"TextboxHeight"))):new Observable(1)}return __extends(i,t),i}(t.TextBoxFormItem);t.TextAreaFormItem=i}(t.items||(t.items={}))}(e.forms||(e.forms={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){var t=function(){return function(e,t){this.className=e,this.instance=t}}();e.Extension=t}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){var i=function(){function t(t,i,r,n){var s=this;this._timer=null,this._siteId="",this._endpointUrl="",this.userName="",this._extentConnect=null,this._numConsecutiveFailures=0,this._enabled=!0,this._sessionId="",this._previousScale=-1,this._firstExtentLogged=!1,this._map=t,i&&(this._siteId=i),this._endpointUrl=r||window.location.protocol+"//"+window.location.host+"/Geocortex/Optimizer/Rest/DataRelay/LogData.ashx?f=json",n&&(this.userName=n),this._pendingEvents=new Array,this._timer=new e.framework.utils.TimeDelayedAction(3e3,this._flushQueue,this);var a={};a.extent=this._map.extent,t.loaded?(this._logExtentChange(a),this._extentConnect=t.on("extent-change",dojo.hitch(this,"_logExtentChange"))):t.on("load",function(){s._logExtentChange(a),s._extentConnect=t.on("extent-change",dojo.hitch(s,"_logExtentChange"))}),this._sessionId=this._crc32((new Date).getTime()+""+navigator.userAgent)}return t.prototype._logExtentChange=function(e){if(this._enabled){var t;if(t={},t.data=[{name:"ArcGISExtents",columns:{}}],t.data[0].columns=[{type:"tinyint",name:"InitialExtent",key:"InitialExtent"},{type:"real",name:"XMinNew",key:"XMinNew"},{type:"real",name:"YMinNew",key:"YMinNew"},{type:"real",name:"XMaxNew",key:"XMaxNew"},{type:"real",name:"YMaxNew",key:"YMaxNew"}],t.data[0].rows=[{InitialExtent:this._firstExtentLogged?0:1,XMinNew:e.extent.xmin,YMinNew:e.extent.ymin,XMaxNew:e.extent.xmax,YMaxNew:e.extent.ymax}],this._queueData(t),this._firstExtentLogged=!0,e.lod)e.levelChange&&this._previousScale>-1&&this._logScaleChange(this._previousScale,e.lod.scale),this._previousScale=e.lod.scale;else{var i=this._map.getScale();null!==i&&(this._previousScale!=i&&this._previousScale>-1&&this._logScaleChange(this._previousScale,i),this._previousScale=i)}}},t.prototype._logScaleChange=function(e,t){if(this._enabled){var i={};i.data=[{name:"ArcGISScale",columns:[]}],i.data[0].columns=[{type:"float",name:"ScaleOld",key:"ScaleOld"},{type:"float",name:"ScaleNew",key:"ScaleNew"}],i.data[0].rows=[{ScaleOld:e,ScaleNew:t}],this._queueData(i)}},t.prototype.logToolUsage=function(e,t){if(this._enabled){var i={};i.data=[{name:"ArcGISTool",columns:[]}],i.data[0].columns=[{type:"ustr",name:"Tool",key:"Tool"},{type:"ustr",name:"ToolData",key:"ToolData"}],i.data[0].rows=[{Tool:e,ToolData:t}],this._queueData(i)}},t.prototype._queueData=function(e){e.platform="js",e.data[0].columns.push({type:"now",name:"SampleTime",key:"SampleTime"},{type:"origin",name:"UserAddress",key:"UserAddress"},{type:"ustr",name:"SiteId",key:"SiteId"},{type:"ustr",name:"UserAgent",key:"UserAgent"},{type:"ustr",name:"UserName",key:"UserName"},{type:"ustr",name:"LayerList",key:"LayerList"},{type:"int",name:"SessionId",key:"SessionId"},{type:"ustr",name:"ClientType",key:"ClientType"},{type:"host",name:"MachineName",key:"MachineName"}),dojo.mixin(e.data[0].rows[0],{SiteId:this._siteId,UserAgent:navigator.userAgent,UserName:this.userName,LayerList:this._getCurrentLayerList(),SessionId:this._sessionId,ClientType:"JavaScript"}),this._pendingEvents.push(e),this._timer.reset()},t.prototype._flushQueue=function(){for(this._timer.stop();this._pendingEvents.length>0;){var e=this._pendingEvents.shift();this._logData(e)}},t.prototype._logData=function(e){try{dojo.xhrPost({url:this._endpointUrl,postData:JSON.stringify(e),timeout:1e4,load:dojo.hitch(this,this._handleLogSuccessResponse),error:dojo.hitch(this,this._handleLogErrorResponse)})}catch(e){console.log(e.message),this._incrementFailures()}},t.prototype._handleLogSuccessResponse=function(e){this._numConsecutiveFailures=0},t.prototype._handleLogErrorResponse=function(e){console.log(e),this._incrementFailures()},t.prototype._incrementFailures=function(){this._numConsecutiveFailures++,this._numConsecutiveFailures>2&&(dojo.disconnect(this._extentConnect),this._enabled=!1)},t.prototype._getCurrentLayerList=function(){for(var e="",t=this._map.layerIds,i=0;i<t.length;i++){var r=t[i],n=this._map.getLayer(r);if(null!=n&&n.visible&&n.visibleAtMapScale){var s;if(n instanceof esri.layers.ArcGISDynamicMapServiceLayer){var a=n;for(s=0;s<a.visibleLayers.length;s++)null!=a.visibleLayers[s]&&-1!=a.visibleLayers[s]&&(e+=a.layerInfos.filter(function(e){return e.id==a.visibleLayers[s]})[0].name+"\\t")}else if(n instanceof esri.virtualearth.VETiledLayer)e+="Bing:"+n.mapStyle+"\\t";else if(n instanceof esri.layers.ArcGISImageServiceLayer)e+="Image:"+n.url+"\\t";else if(n instanceof esri.layers.ArcGISTiledMapServiceLayer){var o=n;for(s=0;s<o.layerInfos.length;s++)null!=o.layerInfos[s]&&(e+=o.layerInfos[s].name+"\\t")}}}return e.length>3&&(e=e.substring(0,e.length-2)),e},t.prototype._crc32=function(e){e=e.replace(/\r\n/g,"\n");for(var t="",i=0;i<e.length;i++){var r=e.charCodeAt(i);r<128?t+=String.fromCharCode(r):r>127&&r<2048?(t+=String.fromCharCode(r>>6|192),t+=String.fromCharCode(63&r|128)):(t+=String.fromCharCode(r>>12|224),t+=String.fromCharCode(r>>6&63|128),t+=String.fromCharCode(63&r|128))}var n,s=0;s^=-1;for(var a=0,o=(e=t).length;a<o;a++)n=255&(s^e.charCodeAt(a)),s=s>>>8^"0x"+"00000000 77073096 EE0E612C 990951BA 076DC419 706AF48F E963A535 9E6495A3 0EDB8832 79DCB8A4 E0D5E91E 97D2D988 09B64C2B 7EB17CBD E7B82D07 90BF1D91 1DB71064 6AB020F2 F3B97148 84BE41DE 1ADAD47D 6DDDE4EB F4D4B551 83D385C7 136C9856 646BA8C0 FD62F97A 8A65C9EC 14015C4F 63066CD9 FA0F3D63 8D080DF5 3B6E20C8 4C69105E D56041E4 A2677172 3C03E4D1 4B04D447 D20D85FD A50AB56B 35B5A8FA 42B2986C DBBBC9D6 ACBCF940 32D86CE3 45DF5C75 DCD60DCF ABD13D59 26D930AC 51DE003A C8D75180 BFD06116 21B4F4B5 56B3C423 CFBA9599 B8BDA50F 2802B89E 5F058808 C60CD9B2 B10BE924 2F6F7C87 58684C11 C1611DAB B6662D3D 76DC4190 01DB7106 98D220BC EFD5102A 71B18589 06B6B51F 9FBFE4A5 E8B8D433 7807C9A2 0F00F934 9609A88E E10E9818 7F6A0DBB 086D3D2D 91646C97 E6635C01 6B6B51F4 1C6C6162 856530D8 F262004E 6C0695ED 1B01A57B 8208F4C1 F50FC457 65B0D9C6 12B7E950 8BBEB8EA FCB9887C 62DD1DDF 15DA2D49 8CD37CF3 FBD44C65 4DB26158 3AB551CE A3BC0074 D4BB30E2 4ADFA541 3DD895D7 A4D1C46D D3D6F4FB 4369E96A 346ED9FC AD678846 DA60B8D0 44042D73 33031DE5 AA0A4C5F DD0D7CC9 5005713C 270241AA BE0B1010 C90C2086 5768B525 206F85B3 B966D409 CE61E49F 5EDEF90E 29D9C998 B0D09822 C7D7A8B4 59B33D17 2EB40D81 B7BD5C3B C0BA6CAD EDB88320 9ABFB3B6 03B6E20C 74B1D29A EAD54739 9DD277AF 04DB2615 73DC1683 E3630B12 94643B84 0D6D6A3E 7A6A5AA8 E40ECF0B 9309FF9D 0A00AE27 7D079EB1 F00F9344 8708A3D2 1E01F268 6906C2FE F762575D 806567CB 196C3671 6E6B06E7 FED41B76 89D32BE0 10DA7A5A 67DD4ACC F9B9DF6F 8EBEEFF9 17B7BE43 60B08ED5 D6D6A3E8 A1D1937E 38D8C2C4 4FDFF252 D1BB67F1 A6BC5767 3FB506DD 48B2364B D80D2BDA AF0A1B4C 36034AF6 41047A60 DF60EFC3 A867DF55 316E8EEF 4669BE79 CB61B38C BC66831A 256FD2A0 5268E236 CC0C7795 BB0B4703 220216B9 5505262F C5BA3BBE B2BD0B28 2BB45A92 5CB36A04 C2D7FFA7 B5D0CF31 2CD99E8B 5BDEAE1D 9B64C2B0 EC63F226 756AA39C 026D930A 9C0906A9 EB0E363F 72076785 05005713 95BF4A82 E2B87A14 7BB12BAE 0CB61B38 92D28E9B E5D5BE0D 7CDCEFB7 0BDBDF21 86D3D2D4 F1D4E242 68DDB3F8 1FDA836E 81BE16CD F6B9265B 6FB077E1 18B74777 88085AE6 FF0F6A70 66063BCA 11010B5C 8F659EFF F862AE69 616BFFD3 166CCF45 A00AE278 D70DD2EE 4E048354 3903B3C2 A7672661 D06016F7 4969474D 3E6E77DB AED16A4A D9D65ADC 40DF0B66 37D83BF0 A9BCAE53 DEBB9EC5 47B2CF7F 30B5FFE9 BDBDF21C CABAC28A 53B39330 24B4A3A6 BAD03605 CDD70693 54DE5729 23D967BF B3667A2E C4614AB8 5D681B02 2A6F2B94 B40BBE37 C30C8EA1 5A05DF1B 2D02EF8D".substr(9*n,8);return(s^=-1).toString()},t}();t.EventRelay=i}(e.optimizer||(e.optimizer={}))}(geocortex||(geocortex={}));var geocortex;!function(e){function t(e){var i,r,n=Array.isArray(e)?[]:{};if(r=typeof e,null!==e&&("number"===r||"boolean"===r||"string"===r))return e;"function"==typeof e.toJson&&(n=e.toJson());for(var s in e)if(!("declaredClass"==s||s.indexOf("_inherited")>-1||void 0!==n[s])&&(i=e[s],r=typeof i,null!==i&&void 0!==i&&"function"!==r))if(Array.isArray(i)){n[s]=[];for(var a=0,o=i.length;a<o;a++)n[s][a]=t(i[a])}else"object"===r?"function"==typeof i.toJson?n[s]=i.toJson():n[s]=t(i):n[s]=i;return n}e.config={baseUrl:"http://localhost/",io:{errorHandler:function(e,t){dojo.publish("geocortex.Error",[e])},postLength:2e3,timeout:6e4},REST_version:"3.0",authenticationDialogId:null},e.deferredResolve=function(e,t){e&&-1==e.fired&&e.resolve(t)},e.deferredReject=function(e,t){e&&-1==e.fired&&e.reject(t)},e.encodeJson=function(e){var i=t(e),r={};for(var n in i)dojo.isArray(i[n])||"object"==typeof i[n]?r[n]=JSON.stringify(i[n]):r[n]=i[n];return r},e.request=function(t,i){i||(i={}),i.gcx||(i.gcx={}),void 0===i.gcx.preventCache?t.preventCache=!0:i.gcx.preventCache?t.preventCache=!0:t.preventCache=!1,t.timeout=t.timeout||e.config.io.timeout,t.handleAs=t.handleAs||"json";var r=e.requiresProxy(t),n=e.hasProxy();if(r&&!n){var s=new Error("Cross-domain or large requests require a proxy.");dojo.isFunction(t.error)&&t.error(s);var a=new dojo.Deferred;return a.errback(s),a}return delete t.gcx,i.useProxy=r,i.hasOwnProperty("disableIdentityLookup")||(i.disableIdentityLookup=!0),new e.essentials.RestHelperHTTPService(t,i).send()},e.hasProxy=function(){var e=!1;try{e=esri._getProxyUrl()}catch(e){}return e},e.requiresProxy=function(t){var i=!1;try{if(require.has("esri-cors")){var r=e.essentials.utilities.UrlUtilities.getUrlComponents(t.url);if(esri.config.defaults.io.corsEnabledServers.indexOf(r.host)>=0)return!1}var n=t.url.length;t.content&&(n+=dojo.objectToQuery(t.content).length);var s=new dojo._Url(t.url),a=window.location,o=n>e.config.io.postLength;if(!s.scheme&&!s.host&&!s.port)return!1;if(/\bGeocortexApp\b/.test(navigator.userAgent)&&"https"===s.scheme)return!1;var l=!(a.protocol+"//"+a.hostname+(a.port?":"+a.port:"")==s.scheme+"://"+s.host+(s.port?":"+s.port:""));i=o&&l}catch(e){}return i},e.urlToQueryObject=function(e){var t=e.indexOf("?");return-1===t?null:dojo.queryToObject(e.substring(t+1))},e._getExtensions=function(t){var i=[];if(!t)return i;i.length=t.length;for(var r=0;r<t.length;r++)i[r]=new e.essentials.Extension(t[r].className,t[r].instance);return i},e._getProperties=function(e){var t={};if(!e)return t;for(var i=0;i<e.length;i++)t[e[i].name]=e[i].value;return t}}(geocortex||(geocortex={})),Date.now||(Date.now=function(){return+new Date});var geocortex;!function(e){!function(e){var t=function(){return function(){this.messageFromServer=null,this.password=null,this.pendingCalls=[],this.tokenService=null,this.tokenRootUri=null,this.targetRootUri=null,this.token=null,this.username=null}}();e.AuthenticationControlBlock=t}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){var t=function(){function e(){this._authenticationControlBlocks=[]}return e.prototype.add=function(e){null===this.find(e.tokenRootUri)&&this._authenticationControlBlocks.push(e)},e.prototype.remove=function(e){for(var t=0;t<this._authenticationControlBlocks.length;t++)if(this._authenticationControlBlocks[t]===e)return this._authenticationControlBlocks.splice(t,1),!0;return!1},e.prototype.find=function(e){for(var t=0;t<this._authenticationControlBlocks.length;t++){var i=this._authenticationControlBlocks[t],r=i.tokenRootUri,n=i.targetRootUri;if(0===e.toLowerCase().indexOf(r.toLowerCase())||0===e.toLowerCase().indexOf(n.toLowerCase()))return i}return null},e.prototype.removeAt=function(e){this._authenticationControlBlocks.splice(e,1)},e}();e.AuthenticationControlBlockStore=t}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){var i=function(){function t(e,t){this.requestObject=null,this.optionsObject=null,this._handle=null,this._error=null,this._deferred=new dojo.Deferred,void 0!==e&&(this.requestObject=e,dojo.isFunction(this.requestObject.error)&&(this._error=this.requestObject.error,this.requestObject.error=null),dojo.isFunction(this.requestObject.handle)&&(this._handle=this.requestObject.handle),this.requestObject.handle=dojo.hitch(this,this._handleProxy)),void 0!==t&&(this.optionsObject=t)}return t.getTokenForScope=function(e){var t=this._anchorScratch||(this._anchorScratch=document.createElement("a")),i=this._pathCleaner||(this._pathCleaner=/\/+/g);t.href=e;var r=t.hostname.toLowerCase(),n=("/"+t.pathname+"/").replace(i,"/").toLowerCase(),s=void 0,a=this.tokenScopes;for(var o in a){t.href=o;var l=t.hostname.toLowerCase(),c=("/"+t.pathname+"/").replace(i,"/").toLowerCase();if(r===l&&n.startsWith(c)){var u=a[o];s="string"==typeof u?u:!0===u?this.token:void 0}}return s},t.setDefaultToken=function(e,t){"string"==typeof e&&(this.token=e,this.tokenScopes[t]=!0)},t.getAuthenticationControlBlockStore=function(){return t._controlBlocks},t.prototype._handleProxy=function(e,t){!1===this._isUnauthorizedResponse(e)&&dojo.isFunction(this._handle)&&(console.log("Invoking original handle delegate"),this._handle(e,t))},t.prototype._requestCallback=function(e){this._deferred.resolve(e)},t.prototype._requestErrback=function(e){this._isUnauthorizedResponse(e)?this._handleUnauthenticated(e):(dojo.isFunction(this._error)&&this._error(e),this._deferred.reject(e))},t.prototype._isUnauthorizedResponse=function(e){return!(!e||401!==e.code)},t.prototype._handleUnauthenticated=function(t){if(console.log("Handling unauthenticated response from server"),t&&t.tokenService){if(!1===e.hasProxy())throw console.log("Cannot authenticate user - no proxy page configured"),new Error("No proxy page is configured - a proxy page is required to access secured Sites");var i=this.requestObject.url,r=t.tokenService,n=e.essentials.RestHelperHTTPService._controlBlocks.find(this.requestObject.url);if(null===n||null!==n.token&&""!==n.token){console.log("New token required for call to secured site");var s=new dojo._Url(i);r=s.scheme+"://"+s.host+(s.port&&"80"!==s.port?":"+s.port:"")+r,n||(n=new e.essentials.AuthenticationControlBlock),n.messageFromServer=t.message,null===n.token?(n.tokenService=r,n.tokenRootUri=r.substring(0,r.lastIndexOf("/")),n.targetRootUri=i.substring(0,i.lastIndexOf("/")),n.pendingCalls.push(this),e.essentials.RestHelperHTTPService._controlBlocks.add(n),this._gatherCredentials().then(dojo.hitch(this,function(e){n.username=e.username,n.password=e.password,this._requestToken(n)}))):(n.token=null,n.pendingCalls=[],n.pendingCalls.push(this),this._requestToken(n))}else{for(var a=!1,o=0;o<n.pendingCalls.length;o++)if(n.pendingCalls[o]===this){a=!0;break}!1===a&&n.pendingCalls.push(this)}}else dojo.isFunction(this._error)&&this._error(t),this._deferred.reject(t)},t.prototype._gatherCredentials=function(t){var i;if(i=void 0===t?new dojo.Deferred:t,dijit.Dialog&&dijit.form&&dijit.form.TextBox&&dijit.form.Button){var r,n=e.essentials.RestHelperHTTPService._controlBlocks.find(this.requestObject.url),s=e.config.authenticationDialogId;s?(console.log("Retrieving existing authentication dialog by id '"+s+"'"),r=dijit.byId(s)):s=e.config.authenticationDialogId="geocortex_authenticationDialog_default",r&&r instanceof dijit.Dialog||(r=new dijit.Dialog({title:"Authentication Required",id:s,content:this._createAuthDialogContent()})),$(dojo.byId(s+"_message")).text(n.messageFromServer||"");var a,o,l,c=dijit.byId(s+"_ok"),u=dijit.byId(s+"_cancel");a=dojo.connect(c,"onClick",function(){dojo.forEach([a,o,l],dojo.disconnect);var e=r.attr("value");i.resolve({username:e.username,password:e.password})}),o=dojo.connect(u,"onClick",function(){dojo.forEach([a,o,l],dojo.disconnect),r.hide(),i.cancel()}),l=dojo.connect(r,"onCancel",function(){dojo.forEach([a,o,l],dojo.disconnect),i.cancel()}),r.show()}else console.log("Dynamically retrieving authentication dialog requirements"),dojo.require("dijit.Dialog"),dojo.require("dijit.form.TextBox"),dojo.require("dijit.form.Button"),dojo.addOnLoad(dojo.hitch(this,function(){console.log("Retrieved authentication dialog requirements, now re-invoking _gatherCredentials"),this._gatherCredentials(i)}));return i},t.prototype._createAuthDialogContent=function(){var t=e.config.authenticationDialogId,i=new dijit.form.TextBox({name:"username",id:"gcx_auth_username"}),r=new dijit.form.TextBox({type:"password",name:"password",id:"gcx_auth_password"}),n=new dijit.form.Button({label:"OK",type:"submit",id:t+"_ok"}),s=new dijit.form.Button({label:"Cancel",type:"button",id:t+"_cancel"}),a=dojo.create("div");dojo.create("div",{id:t+"_message"},a);var o=dojo.create("table",null,a),l=dojo.create("tr",null,o),c=dojo.create("tr",null,o),u=dojo.create("tr",null,o);dojo.place("<td><label for='gcx_auth_username'>Username: </label></td>",l),dojo.place("<td><label for='gcx_auth_password'>Password: </label></td>",c);var h=dojo.create("td",null,l),p=dojo.create("td",null,c),d=dojo.create("td",{colspan:"2",align:"center"},u),f=dojo.create("div",{id:t+"_actionbuttoncontainer"},d);return i.placeAt(h),r.placeAt(p),n.placeAt(f),s.placeAt(f),a},t.prototype._requestToken=function(t){console.log("Requesting token for site access"),esri.request({url:t.tokenService,content:{username:t.username,password:t.password,lifespan:"20",f:"json"},timeout:e.config.io.timeout,handleAs:"json"},{usePost:!0,disableIdentityLookup:!0}).then(dojo.hitch(this,this._onTokenRequestCompleted),dojo.hitch(this,this._onTokenRequestFault))},t.prototype._onTokenRequestFault=function(t){if(console.log("Token request fault"),this._isUnauthorizedResponse(t)){console.log("Unauthorized response - will gather credentials again");var i=e.essentials.RestHelperHTTPService._controlBlocks.find(this.requestObject.url);i.messageFromServer=t.message,this._gatherCredentials().then(dojo.hitch(this,function(e){console.log("Invoked delegate for gathering credentials"),i.username=e.username,i.password=e.password,this._requestToken(i)}))}else dojo.isFunction(this._error)&&this._error(t),this._deferred.errback(t)},t.prototype._onTokenRequestCompleted=function(t){console.log("Token request completed");var i=e.essentials.RestHelperHTTPService._controlBlocks.find(this.requestObject.url);if(t&&t.token){i.token=t.token,console.log("Received token '"+t.token+"' for user '"+i.username+"'"),console.log("Publishing dojo event 'geocortex_authenticationSucceeded'"),dojo.publish("geocortex_authenticationSucceeded",[{username:i.username,token:i.token}]);for(var r=i.pendingCalls.length-1;r>=0;r--){var n=i.pendingCalls[r];i.pendingCalls.pop(),console.log("Re-issuing pending call with new token to url '"+n.requestObject.url+"'"),n.send()}}else e.essentials.RestHelperHTTPService._controlBlocks.remove(i)},t.prototype.send=function(){if(null!==this.requestObject){var i=e.essentials.RestHelperHTTPService._controlBlocks.find(this.requestObject.url);null!==i&&null!==i.token&&(this.requestObject.content||(this.requestObject.content={}),-1===this.requestObject.url.indexOf("token=")&&(this.requestObject.url=this._appendParameter(this.requestObject.url,"token",i.token)))}else-1!==this.requestObject.url.indexOf("token=")&&(this.requestObject.url=this.requestObject.url.replace("token=","oldtkn="));t.arcGisPortalToken&&(this.requestObject.content.arcGisPortalToken=t.arcGisPortalToken.token);var r=t.getTokenForScope(this.requestObject.url);return void 0!==r&&(this.requestObject.content.token=r),esri.request(this.requestObject,this.optionsObject).then(dojo.hitch(this,this._requestCallback),dojo.hitch(this,this._requestErrback)),this._deferred.promise},t.prototype._appendParameter=function(e,t,i){var r=e;return e.indexOf("?")>0?r+="&":r+="?",r+=encodeURIComponent(t)+"="+encodeURIComponent(i)},t._controlBlocks=new e.essentials.AuthenticationControlBlockStore,t.tokenScopes={},t}();t.RestHelperHTTPService=i}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){!function(e){function t(e,t,i){return null==e||null==t?i:!!(e.isWebMercator&&t.isWebMercator&&e.isWebMercator()&&t.isWebMercator())||e.wkid===t.wkid&&(e.wkid>0||e.wkt.toLowerCase()==t.wkt.toLowerCase())}function i(e){var t=e.rings[0][0],i=e.rings[0][1],r=null,n=e.rings[0].slice(2,e.rings[0].length);n.push(t);for(var s=0;s<n.length;++s){var a=n[s],o=this.crossProduct(a,t,i);if(o>0&&!0===r||o<0&&!1===r)return!1;r=o>0,t=i,i=a}return!0}function r(e,t,i){return i||(i=[0,0]),(e[0]-i[0])*(t[1]-i[1])-(e[1]-i[1])*(t[0]-i[0])}e.spatialRefsAreEqual=t,e.envelopesAreEqual=function(e,i){return null==e||null==i?null==e&&null==i:t(e.spatialReference,i.spatialReference)&&e.xmin==i.xmin&&e.ymin==i.ymin&&e.xmax==i.xmax&&e.ymax==i.ymax},e.getExtent=function(e){if(e.length)var t=new esri.geometry.Extent(Number.MAX_VALUE,Number.MAX_VALUE,Number.MIN_VALUE,Number.MIN_VALUE,e[0].spatialReference);for(var i=0;i<e.length;++i){var r=e[i].getExtent();t.xmin=Math.min(r.xmin,t.xmin),t.ymin=Math.min(r.ymin,t.ymin),t.xmax=Math.min(r.xmax,t.xmax),t.xmax=Math.min(r.ymax,t.ymax)}return t},e.envelopeToPolygon=function(e){var t=new esri.geometry.Polygon(e.spatialReference);return t.addRing([[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]),t},e.isValidGeometry=function(e){if("polygon"!=e.type)return!0;var t=e;if(0==t.rings.length||t.rings.length<3)return!0;if(i(t)){var n=t.rings[0][0],s=t.rings[0][1],a=t.rings[0].slice(2,t.rings[0].length);for(a.push(n),p=0;p<a.length;++p){var o=a[p];if(r(n,o,s)>0)return!0;n=s,s=o}return!1}for(var l=0,c=0;c<t.rings.length;++c)for(var u=t.rings[c],h=0,p=0;p<u.length;++p)h=(p+1)%u.length,l+=u[p][0]*-u[h][1],l-=-u[p][1]*u[h][0];return l>0},e.isSelfIntersectingPolygon=function(e){if(esri.geometry.polygonSelfIntersecting)return esri.geometry.polygonSelfIntersecting(e);if(e.isSelfIntersecting)return e.isSelfIntersecting(e);throw new Error("No self intersection method found")},e.isConvex=i,e.pointInEnvelope=function(e,t){if(!this.spatialRefsAreEqual(e.spatialReference,t.spatialReference,!0))throw new Error("Mismatched spatial references.");return!(e.x<t.xmin||e.x>t.xmax||e.y<t.ymin||e.y>t.ymax)},e.clipEnvelope=function(e,t){if(!this.spatialRefsAreEqual(e.spatialReference,t.spatialReference,!0))throw new Error("Mismatched spatial references.");var i=new esri.geometry.Extent(e.xmin,e.ymin,e.xmax,e.ymax,e.spatialReference),r=function(e,t,i){return e<t?t:e>i?i:e};return i.xmin=r(e.xmin,t.xmin,t.xmax),i.xmin=r(e.ymin,t.ymin,t.ymax),i.xmin=r(e.xmax,t.xmin,t.xmax),i.xmin=r(e.ymax,t.ymin,t.ymax),i},e.scaleEnvelope=function(e,t,i){return new esri.geometry.Extent(e.xmin*t,e.ymin*i,e.xmax*t,e.ymax*i,e.spatialReference)},e.scaleEnvelopeWithoutTranslation=function(e,t){if(null==e)return null;var i=e.getCenter();return new esri.geometry.Extent(i.x-e.getWidth()*(t/2),i.y-e.getHeight()*(t/2),i.x+e.getWidth()*(t/2),i.y+e.getHeight()*(t/2),e.spatialReference)},e.computeDistance=function(e,t){var i=t.x-e.x,r=t.y-e.y;return Math.sqrt(i*i+r*r)},e.translateEnvelope=function(e,t,i){return new esri.geometry.Extent(e.xmin+t,e.ymin+i,e.xmax+t,e.ymax+i,e.spatialReference)},e.length=function(e){return Math.sqrt(e.x*e.x+e.y*e.y)},e.normalize=function(e){var t=this.length(e);return new esri.geometry.Point(e.x/t,e.y/t)},e.angle=function(e,t){if(!this.spatialRefsAreEqual(e.spatialReference,t.spatialReference,!0))throw new Error("Mismatched spatial references");return Math.acos(this.dotProduct(e,t)/Math.sqrt(this.dotProduct(e,e)*this.dotProduct(t,t)))},e.crossProduct=function(e,t,i){if(!this.spatialRefsAreEqual(e.spatialReference,t.spatialReference,!0))throw new Error("Mismatched spatial references");return i||(i=new esri.geometry.Point(0,0)),(e.x-i.x)*(t.y-i.y)-(e.y-i.y)*(t.x-i.x)},e.crossProductArray=r,e.dotProduct=function(e,t){if(!this.spatialRefsAreEqual(e.spatialReference,t.spatialReference,!0))throw new Error("Mismatched spatial references");return e.x*t.x+e.y*t.y},e.polygonMidpoint=function(e){if(0==e.length)throw new Error("Expected at least one point in polygonMidPoint.");for(var t=0,i=0,r=0;r<e.length;++r){var n=e[r];t+=n.x,i+=n.y}return t/=e.length,i/=e.length,new esri.geometry.Point(t,i,e[0].spatialReference)}}(e.GeometryUtilities||(e.GeometryUtilities={}))}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){var i=function(i){function r(r){i.call(this,r),this.bingProperties=null,this.baseMapGroup=null,this.configuredOpacity=1,this.configuredVisible=!1,this.copyright=null,this.attributionDataUrl=null,this.hasAttributionData=!1,this.dataProvider=null,this.description=null,this.defaultDateFormat=null,this.defaultNumberFormat=null,this.disableClientCaching=!1,this.displayName=null,this.drawingBehavior=null,this.essentialsMap=null,this.extensions=[],this.failureAction=e.essentials.FailureAction.WARN,this.failureTimeout=null,this.failureTimeoutThresholdExceeded=!1,this.onFailureTimeoutThresholdExceeded=function(){},this.featureClustering=null,this.geometryServiceUrl=null,this.hasLayerCatalog=!1,this.iconUri=null,this.id=null,this.catalogId=null,this.originalUrl=null,this.imageFormat=null,this.initializationFailure=null,this.includeInLayerList=!0,this.isExpanded=!0,this.isServiceLayerLoaded=!1,this.isUserCreated=!1,this.layers=[],this.tables=[],this.layersFilteredView=[],this.mapServiceFunction=null,this.mapServiceType=null,this.mapUrl=null,this.maxScale=null,this.minScale=null,this.opacity=1,this.opacityFilter=1,this.operationalSpatialReference=null,this.inActiveTheme=!0,this.layerThemeSettings=[],this.layerHyperlinks=[],this.properties={},this.proxyUrl=null,this.requestEncoding=null,this.instantSearch=!1,this.serverVersion=null,this.serviceLayer=null,this.serviceToken=null,this.serviceUrl=null,this.shortDisplayName=null,this.subDomains=[],this.supportsDynamicLayers=!1,this.tileMatrixSet=null,this.tileInfo=null,this.tileRestUrl=null,this.isTimeAware=!1,this.timeInfo=null,this.timeZoneId=null,this.updateInterval=null,this.heatMap=null,this.identifiable=!1,this.includeMosaicDatasetValues=!1,this.includeCatalogItems=!1,this._needsProxy=!1,this.layerVisibilityEventManager=null,this._updateIntervalId=null,this._delayedRefreshToken=null,this._layersInfoPromise=null,this._styleUrl=null,this._restStartTimeOverrideString=null,this._restEndTimeOverrideString=null,this._featureLayerPromise=null,this._initiallyVisible=!1,this.originalUrl=r,this.url&&(this.url=t.utilities.UrlUtilities.simplify(r)),this.setInActiveTheme(!0)}return __extends(r,i),r.prototype._getLayersInfo=function(){var e=this;return this._layersInfoPromise||(this._layersInfoPromise=new Promise(function(t,i){e.doWhenInitialized(function(r){if(e.serviceUrl.endsWith("/MapServer")){var n={url:e.serviceUrl+"/Layers",content:{f:"json"},load:function(e){t(e)},error:function(e){i(e)},callbackParamName:"CallBack",preventCache:!1},s={gcx:{preventCache:!1}};null!==e.serviceToken&&(n.content.token=e.serviceToken),esri.request(n,s)}else t(null)})})),this._layersInfoPromise},r.prototype.getConfiguredVisibleLayers=function(){return this._getVisibleLayersOfType("configuredVisible")},r.prototype.getDefaultVisibleLayers=function(){return this._getVisibleLayersOfType("defaultVisibility")},r.prototype.getVisibleLayers=function(){return this._getVisibleLayersOfType("_visible")},r.prototype._getVisibleLayersOfType=function(e){for(var t=[],i=0,r=0;r<this.layers.length;r++){var n=this.layers[r];n[e]&&null===n.parentLayerId&&(null===n.subLayerIds||0===n.subLayerIds.length?t[i++]=n.id:i=this._getVisibleGroupLayersOfType(e,n,t,i))}return t},r.prototype.isVisible=function(){var e=!1;return this.serviceLayer&&"boolean"==typeof this.serviceLayer.visible&&(e=this.serviceLayer.visible),e},r.prototype.isTiled=function(){return!!this.serviceLayer&&this.serviceLayer instanceof esri.layers.TiledMapServiceLayer},r.prototype.setVisibility=function(e){if(null!==this.serviceLayer){if(!this.supportsLayerVisibility()&&this.layers.length)for(var t=0;t<this.layers.length;t++){var i=this.layers[t];i&&(i._visible=e)}e?this.serviceLayer.show():this.serviceLayer.hide()}},r.prototype.setOpacity=function(e){(null==e||isNaN(e))&&(e=1),e=Math.min(1,Math.max(0,e)),this.opacity=e,this.serviceLayer&&this.serviceLayer.setOpacity&&this.serviceLayer.setOpacity(e*this.opacityFilter)},r.prototype.setOpacityFilter=function(e){isNaN(e)&&(e=1),e=Math.min(1,Math.max(0,e)),this.opacityFilter=e,this.serviceLayer&&this.serviceLayer.setOpacity&&this.serviceLayer.setOpacity(e*this.opacity)},r.prototype.setInActiveTheme=function(e){this.inActiveTheme=e,dojo.publish("MapServiceInActiveThemeChangedEvent",this)},r.prototype.findServiceToken=function(){return this.serviceToken?this.serviceToken:this.essentialsMap&&this.essentialsMap.site&&this.essentialsMap.site.arcGisPortalSecurityContext?this.essentialsMap.site.arcGisPortalSecurityContext.getToken(this.serviceUrl):null},r.prototype._findById=function(e,t){for(var i=0;i<t.length;i++){var r=t[i];if(r.id==e)return r}return null},r.prototype._findByName=function(e,t){for(var i=0;i<t.length;i++){var r=t[i];if(r.name==e||r.displayName==e)return r}return null},r.prototype.findLayerByName=function(e){return this._findByName(e,this.layers)},r.prototype.findLayerById=function(e){return this._findById(e,this.layers)},r.prototype.findTableByName=function(e){return this._findByName(e,this.tables)},r.prototype.findTableById=function(e){return this._findById(e,this.tables)},r.prototype.findLayerOrTableByName=function(e){var t=this.findLayerByName(e);return t||(t=this.findTableByName(e)),t},r.prototype.findLayerOrTableById=function(e){var t=this.findLayerById(e);return t||(t=this.findTableById(e)),t},r.prototype.refresh=function(e,t){var i=this,r=this.serviceLayer;if(r&&"function"==typeof r.refresh){var n=function(){if(i._delayedRefreshToken=null,!0===e&&"function"==typeof r.setDisableClientCaching){var e=r.disableClientCaching;r.setDisableClientCaching(!0),r.refresh(),r.setDisableClientCaching(e)}else r.refresh()};this._delayedRefreshToken&&clearTimeout(this._delayedRefreshToken),"number"!=typeof e?n():this._delayedRefreshToken=setTimeout(n,e)}},r.prototype.refreshFilteredCollections=function(){var e=this;this.layersFilteredView.length=0,dojo.forEach(this.layers,function(t){return e._addToFilteredView(t)})},r.prototype._configureLayers=function(t,i){for(var r=0;t&&r<t.length;r++)this.layers[r]=new e.essentials.Layer(this.url+"/layers/"+t[r].id),this.layers[r].mapService=this,this.layers[r]._configureObject(t[r],i);this._createServiceLayer(),this.minScale&&this.serviceLayer.setMinScale(this.minScale),this.maxScale&&this.serviceLayer.setMaxScale(this.maxScale),this.disableClientCaching&&this.serviceLayer&&this.serviceLayer.setDisableClientCaching&&this.serviceLayer.setDisableClientCaching(!0)},r.prototype._configureTimeInfo=function(){if(!this.serviceLayer)throw new Error("_configureTimeInfo: The esri service layer must be created before attempting to populate time information.");var e=this.serviceLayer.timeInfo;e?(this.isTimeAware=!0,this.timeInfo=r.getGcxTimeInfo(e,this._restStartTimeOverrideString,this._restEndTimeOverrideString)):this.isTimeAware=!1},r.getGcxTimeInfo=function(e,i,r){var n=null,s=null;if(e&&(n=e.timeExtent&&e.timeExtent.startTime instanceof Date?e.timeExtent.startTime.valueOf():parseInt(e.timeExtent[0],10),s=e.timeExtent&&e.timeExtent.endTime instanceof Date?e.timeExtent.endTime.valueOf():parseInt(e.timeExtent[1],10)),(!n||isNaN(n))&&!i||(!s||isNaN(s))&&!r)return null;var a=i?t.utilities.StringUtilities.getDateFromRestDateString(i):new Date(n),o=r?t.utilities.StringUtilities.getDateFromRestDateString(r):new Date(s),l={};return l.timeExtent={startTime:a,endTime:o},e&&(e.startTimeField&&(l.startTimeField=e.startTimeField),e.endTimeField&&(l.endTimeField=e.endTimeField),e.trackIdField&&(l.trackIdField=e.trackIdField),e.timeReference&&(l.timeReference={},void 0!=e.timeReference.respectsDaylightSaving&&(l.timeReference.respectsDaylightSavings=e.timeReference.respectsDaylightSaving),void 0!=e.timeReference.timeZone&&(l.timeReference.timeZone=e.timeReference.timeZone)),e.exportOptions&&(l.exportOptions={},void 0!=e.exportOptions.timeDataCumulative&&(l.exportOptions.timeDataCumulative=e.exportOptions.timeDataCumulative),void 0!=e.exportOptions.timeOffset&&(l.exportOptions.timeOffset=e.exportOptions.timeOffset),void 0!=e.exportOptions.timeOffsetUnits&&(l.exportOptions.timeOffsetUnits=e.exportOptions.timeOffsetUnits),void 0!=e.exportOptions.useTime&&(l.exportOptions.useTime=e.exportOptions.useTime))),l},r.prototype._configureTables=function(t,i){for(var r=0;t&&r<t.length;r++)this.tables[r]=new e.essentials.Layer(this.url+"/tables/"+t[r].id),this.tables[r].mapService=this,this.tables[r]._configureObject(t[r],i)},r.prototype._createFrom=function(t){var i=this;if(this.id=t.id,this.serviceUrl=t.serviceUrl,this.mapServiceType=t.serviceType,this.mapServiceFunction=t.serviceFunction,this.displayName=t.displayName||t.name,this.shortDisplayName=t.shortDisplayName,this.baseMapGroup=t.baseMapGroup,this.baseMapGroupIndex=t.baseMapGroupIndex,this.baseMapGroupIsMutuallyExclusive=t.baseMapGroupIsMutuallyExclusive,this.description=t.description,this.copyright=t.copyright,this.attributionDataUrl=t.attributionDataUrl,this.hasAttributionData=t.hasAttributionData,this.configuredVisible=!!t.visible,this._initiallyVisible=this.configuredVisible,this.disableClientCaching=!!t.disableClientCaching,this.instantSearch=!!t.instantSearch,this.configuredOpacity=t.opacity,this.opacity=this.configuredOpacity,this.imageFormat=t.format,this.isExpanded=t.isExpanded,this.serverVersion=t.serverVersion,this.failureAction=t.failureAction,this.failureTimeout=t.failureTimeout,this.tileMatrixSet=t.tileMatrixSet,this.requestEncoding=t.requestEncoding,this.operationalSpatialReference=t.operationalSpatialReference,this.dataProvider=t.dataProvider,this.minScale=t.minScale,this.maxScale=t.maxScale,this.identifiable=!!t.identifiable,this.includeCatalogItems=!!t.includeCatalogItems,this.includeMosaicDatasetValues=!!t.includeMosaicDatasetValues,this.defaultDateFormat=t.defaultDateFormat,this.defaultNumberFormat=t.defaultNumberFormat,this.timeZoneId=t.timeZoneId,t.tileInfo&&(this.tileInfo=dojo.clone(t.tileInfo),this.tileInfo.spatialReference&&(this.tileInfo.spatialReference.wkid?this.tileInfo.spatialReference=new esri.SpatialReference(this.tileInfo.spatialReference.wkid):this.tileInfo.spatialReference=new esri.SpatialReference(this.tileInfo.spatialReference.wkt))),this.supportsDynamicLayers=!1,this.includeInLayerList=t.includeInLayerList,this.drawingBehavior=t.drawingBehavior||e.essentials.DrawingBehavior.FEATURE_LAYER,t.layerOptions){var r=new e.essentials.Layer;r.mapService=this,r._createFrom(t.layerOptions),this.layers.push(r)}t.hasOwnProperty("layerHyperlinks")&&t.layerHyperlinks.forEach(function(t){i.layerHyperlinks.push(new e.essentials.LayerHyperlink(t,i))}),t.featureClustering&&(this.featureClustering={enabled:t.featureClustering.enabled,userCanToggle:t.featureClustering.userCanToggle,radius:t.featureClustering.radius,maximumFeatures:t.featureClustering.clusterSize,backgroundColor:t.featureClustering.backgroundColor,labelColor:t.featureClustering.labelColor}),t.featureHeatMap&&(this.heatMap={enabled:t.featureHeatMap.enabled,userCanToggle:t.featureHeatMap.userCanToggle,respectScaleRange:t.featureHeatMap.respectScaleRange,gradient:(t.featureHeatMap.gradient||[]).slice(),offset:(t.featureHeatMap.offset||[]).slice(),intensity:t.featureHeatMap.intensity,field:t.featureHeatMap.field,defaultRenderer:t.featureHeatMap.defaultRenderer?esri.renderer.fromJson(t.featureHeatMap.defaultRenderer):null,defaultMinScale:t.featureHeatMap.defaultMinScale,defaultMaxScale:t.featureHeatMap.defaultMaxScale,includeInLegend:t.featureHeatMap.includeInLegend}),t.properties&&(this.catalogId=e._getProperties(t.properties).layerCatalogLookupId),this.isInitialized=!0},r.prototype.createFromDefinition=function(e){this._createFrom(e)},r.prototype.toJson=function(){var e={id:this.id,url:this.url,serviceUrl:this.serviceUrl,serviceType:this.mapServiceType,serviceFunction:this.mapServiceFunction,displayName:this.displayName,shortDisplayName:this.shortDisplayName,baseMapGroup:this.baseMapGroup,baseMapGroupIndex:this.baseMapGroupIndex,baseMapGroupIsMutuallyExclusive:this.baseMapGroupIsMutuallyExclusive,description:this.description,copyright:this.copyright,attributionDataUrl:this.attributionDataUrl,hasAttributionData:this.hasAttributionData,visible:this.isVisible(),disableClientCaching:this.disableClientCaching,opacity:this.opacity,instantSearch:this.instantSearch,format:this.imageFormat,isExpanded:this.isExpanded,serverVersion:this.serverVersion,failureAction:this.failureAction,failureTimeout:this.failureTimeout,tileMatrixSet:this.tileMatrixSet,requestEncoding:this.requestEncoding,operationalSpatialReference:this.operationalSpatialReference,dataProvider:this.dataProvider,minScale:this.minScale,maxScale:this.maxScale,identifiable:this.identifiable,includeCatalogItems:this.includeCatalogItems,includeMosaicDatasetValues:this.includeMosaicDatasetValues,defaultDateFormat:this.defaultDateFormat,defaultNumberFormat:this.defaultNumberFormat,tileInfo:this.tileInfo?this.tileInfo.toJson():void 0,includeInLayerList:this.includeInLayerList,drawingBehavior:this.drawingBehavior,layerOptions:this.layers.map(function(e){return e.toJson()}),catalogId:this.catalogId};return this.featureClustering&&(e.featureClustering=dojo.clone(this.featureClustering)),this.heatMap&&(e.featureHeatMap=dojo.clone(this.heatMap),e.featureHeatMap.defaultRenderer instanceof esri.renderer.Renderer&&(e.featureHeatMap.defaultRenderer=e.featureHeatMap.defaultRenderer.toJson())),e},r.prototype._configureObject=function(i,r){var n=this;if(void 0===i||void 0===i.id||void 0===i.displayName||void 0===i.serviceType||void 0===i.connectionString)throw new Error("Incorrect map service object returned from initialization");if(this.id=i.id,this.mapServiceType=i.serviceType,this.mapServiceFunction=void 0===i.serviceFunction?this.mapServiceFunction:i.serviceFunction,this.displayName=i.displayName,this.shortDisplayName=i.shortDisplayName,this.baseMapGroup=i.baseMapGroup,this.baseMapGroupIndex=i.baseMapGroupIndex,this.baseMapGroupIsMutuallyExclusive=i.baseMapGroupIsMutuallyExclusive,this.description=void 0===i.description?this.description:i.description,this.copyright=i.copyright,this.attributionDataUrl=i.attributionDataUrl,this.hasAttributionData=i.hasAttributionData,this.configuredVisible=!!i.visible,this.disableClientCaching=!!i.disableClientCaching,this.instantSearch=!!i.instantSearch,this.configuredOpacity=void 0===i.opacity||null===i.opacity?this.configuredOpacity:i.opacity,this.opacity=this.configuredOpacity,this.imageFormat=void 0===i.format?this.imageFormat:i.format,void 0!==i.updateInterval){var s=i.updateInterval;s&&s<10&&0!==s&&(s=10),this.updateInterval=s,this._resetUpdateTimer()}if(this.isExpanded=void 0===i.isExpanded?this.isExpanded:i.isExpanded,this.serverVersion=i.serverVersion,this.failureAction=i.failureAction,this.failureTimeout=i.failureTimeout,this.tileMatrixSet=i.tileMatrixSet,this.requestEncoding=i.requestEncoding,this.operationalSpatialReference=i.operationalSpatialReference,this.dataProvider=i.dataProvider,this.minScale=i.minScale,this.maxScale=i.maxScale,this.identifiable=!!i.identifiable,this.includeCatalogItems=!!i.includeCatalogItems,this.includeMosaicDatasetValues=!!i.includeMosaicDatasetValues,this.defaultDateFormat=i.defaultDateFormat,this.defaultNumberFormat=i.defaultNumberFormat,this.timeZoneId=i.timeZoneId,this._restStartTimeOverrideString=i.startTime||null,this._restEndTimeOverrideString=i.endTime||null,i.tileInfo&&(this.tileInfo=dojo.clone(i.tileInfo),this.tileInfo.spatialReference&&(this.tileInfo.spatialReference.wkid?this.tileInfo.spatialReference=new esri.SpatialReference(this.tileInfo.spatialReference.wkid):this.tileInfo.spatialReference=new esri.SpatialReference(this.tileInfo.spatialReference.wkt))),"boolean"==typeof i.includeInLayerList&&(this.includeInLayerList=i.includeInLayerList),null!=this.essentialsMap.layerThemesInfo.startupThemeId&&this.includeInLayerList?this._initiallyVisible=!1:this._initiallyVisible=void 0===i.initiallyVisible?!!i.visible:!!i.initiallyVisible,i.themeSettings&&i.themeSettings.length)for(var a=0;a<i.themeSettings.length;a++){var o=i.themeSettings[a],l=this.essentialsMap.layerThemesInfo.getTheme(o.themeID);if(l){var c=void 0==o.visible?this.configuredVisible:o.visible;this.layerThemeSettings.push(new t.LayerThemeSetting(l,c)),l.id===this.essentialsMap.layerThemesInfo.startupThemeId&&this.includeInLayerList&&(this._initiallyVisible=void 0===o.initiallyVisible?c:o.initiallyVisible)}}if(this.supportsDynamicLayers=void 0===i.supportsDynamicLayers?this.supportsDynamicLayers:i.supportsDynamicLayers,this.hasLayerCatalog=void 0===i.hasLayerCatalog?this.hasLayerCatalog:i.hasLayerCatalog,i.iconUri){var u=null;this.essentialsMap&&(u=this.essentialsMap.site),this.iconUri=e.essentials.RestHelper.processClientSideTokens(u,i.iconUri)}i.featureClustering&&(this.featureClustering={enabled:i.featureClustering.enabled,userCanToggle:i.featureClustering.userCanToggle,radius:i.featureClustering.radius,maximumFeatures:i.featureClustering.clusterSize,backgroundColor:i.featureClustering.backgroundColor,labelColor:i.featureClustering.labelColor}),i.featureHeatMap&&(this.heatMap=i.featureHeatMap),this.drawingBehavior=void 0===i.drawingBehavior?this.drawingBehavior:i.drawingBehavior,this._processConnectionString(i.connectionString,i),this._processProxyInfo(i.proxyInfo),this._configureLayers(i.layers,r),this._configureTables(i.tables,r),i.hasOwnProperty("layerHyperlinks")&&i.layerHyperlinks.forEach(function(t){n.layerHyperlinks.push(new e.essentials.LayerHyperlink(t,n))}),r&&(this.isInitialized=!0),this.properties=e._getProperties(i.properties),this.extensions=e._getExtensions(i.extensions),this.setOpacity(this.configuredOpacity)},r.prototype._updateServiceToken=function(e){if(this.serviceToken=e,this.serviceLayer&&this.serviceLayer._url){var t=this.serviceLayer._url;if(t.query){t.query.token=e;var i=dojo.objectToQuery(t.query);this.serviceLayer.url=t.path+(i?"?"+i:"")}}dojo.publish("ServiceTokenRefreshed",{serviceUrl:this.serviceUrl,token:e})},r.prototype._addDefinitionExpression=function(e,t){if(!e)throw new Error("Expecting a layer");if((t=t||this.serviceLayer)instanceof esri.layers.ArcGISDynamicMapServiceLayer){var i=e.getDefinitionExpression(null);if(i){var r=parseInt(e.id),n=t.layerDefinitions||[];if(!r)throw new Error("Failed to add definition expression for "+e.displayName);n[r]=i,t.setLayerDefinitions(n)}}},r.prototype._removeDefinitionExpression=function(e,t){if(e&&(t=t||this.serviceLayer)&&t instanceof esri.layers.ArcGISDynamicMapServiceLayer){var i=parseInt(e.id);if(i&&t.layerDefinitions){var r=t.layerDefinitions;r[i]&&(r.splice(i,1),t.setLayerDefinitions(r))}}},r.prototype._createServiceLayer=function(){var i=this;if(null==this.serviceLayer){var n=this.serviceUrl;if(null!==this.serviceToken&&(n=n+(n.indexOf("?")>-1?"&token=":"?token=")+encodeURIComponent(this.serviceToken)),"MapService"===this.drawingBehavior){var s;switch(this.mapServiceType){case e.essentials.MapServiceType.DYNAMIC:this._needsProxy&&(esri.config.defaults.io.alwaysUseProxy=!0);var a=new esri.layers.ArcGISDynamicMapServiceLayer(n,{id:this.id});this._applyAttributionUrl(a);var o=this.getVisibleLayers();0===o.length?a.setVisibleLayers&&(0===this.layers.length?a.setVisibleLayers(o,!1):a.setVisibleLayers(["-1"],!1)):a.setVisibleLayers&&a.setVisibleLayers(o,!1);for(p=0;p<this.layers.length;p++)this._addDefinitionExpression(this.layers[p],a);this.layerVisibilityEventManager=new t.LayerVisibilityEventManager(this,a),a.setImageFormat(this._getAgsDynamicImageFormat(this.imageFormat)),dojo.connect(a,"onError",this,this._layerLoadErrorHandler),dojo.connect(a,"onLoad",this,function(){this._handleServiceLayerLoaded(a),this._handleDynamicLayers(a)}),this._initiallyVisible?a.show():a.hide(),this.serviceLayer=a;break;case e.essentials.MapServiceType.TILED:var l=new esri.layers.ArcGISTiledMapServiceLayer(n,{id:this.id});this._applyAttributionUrl(l),dojo.connect(l,"onError",dojo.hitch(this,this._layerLoadErrorHandler)),dojo.connect(l,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded)),this._initiallyVisible?l.show():l.hide(),this.serviceLayer=l;break;case e.essentials.MapServiceType.IMAGE:var c=null;this._hasTileLevels()?c=new esri.layers.ArcGISTiledMapServiceLayer(n,{id:this.id}):(c=new esri.layers.ArcGISImageServiceLayer(n,{id:this.id})).setImageFormat(this._getAgsImageServiceImageFormat(this.imageFormat)),this._applyAttributionUrl(c),dojo.connect(c,"onError",this,this._layerLoadErrorHandler),dojo.connect(c,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded)),this._initiallyVisible?c.show():c.hide(),this.serviceLayer=c;break;case e.essentials.MapServiceType.BING:var u=new esri.virtualearth.VETiledLayer(this.bingProperties);dojo.connect(u,"onError",this,this._layerLoadErrorHandler),dojo.connect(u,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded)),this._initiallyVisible?u.show():u.hide(),this.serviceLayer=u;break;case e.essentials.MapServiceType.WMS:if(!dojo.isObject(esri.layers.WMSLayer))throw new Error("This Javascript application must // dojo.require the esri.layers.wms package in order to use a site with a WMS service.");this._extendWms();for(var h=!1,p=0;p<this.layers.length;p++)if(this.layers[p].wmsLayerName){h=!0;break}var d;if(h){if(s={extent:this.essentialsMap.initialExtent,layerInfos:this._constructWmsLayerInfos(),version:this.serverVersion},d=new esri.layers.WMSLayer(n,{resourceInfo:s,visibleLayers:this._getWmsVisibleLayers()}),null!=this.operationalSpatialReference){var f=parseInt(this.operationalSpatialReference.replace(/^.*:/,""));d.spatialReferences.push(f),d.preferredSpatialReference=f}dojo.connect(d,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded))}else d=new esri.layers.WMSLayer(n),dojo.connect(d,"onLoad",dojo.hitch(this,this._finishWmsLayerConfiguration));if(this._restStartTimeOverrideString&&this._restEndTimeOverrideString&&!d.timeInfo){var y=r.getGcxTimeInfo(null,this._restStartTimeOverrideString,this._restEndTimeOverrideString);if(y){var m={timeExtent:new esri.TimeExtent(y.timeExtent.startTime,y.timeExtent.endTime)};d.timeInfo=m}}d.id=this.id,this._applyAttributionUrl(d),this.layerVisibilityEventManager=new t.LayerVisibilityEventManager(this,d),d.setImageFormat(this._getEsriWmsImageFormat()),d.__gcxWmsImageFormat=this.imageFormat,dojo.connect(d,"onError",this,this._layerLoadErrorHandler),this._initiallyVisible?d.show():d.hide(),this.serviceLayer=d;try{require(["dojo/request"],function(e){e(i._prefixProxy(n),{headers:{"X-Requested-With":null},withCredentials:!0}).then(function(e){d.refresh()},function(e){d.refresh()})})}catch(e){console.log("Error in initializing WMS layer: "+e)}break;case e.essentials.MapServiceType.WMTS:if(!dojo.isObject(esri.layers.WMTSLayer))throw new Error("This JavaScript application must // dojo.require the esri.layers.wmts package in order to use a site with WMTS service.");if(0==this.layers.length)throw new Error("You must include at least one layer in your WMTS. Service "+this.displayName+" has 0 layers.");this.tileInfo&&this.tileInfo.dpi&&this.tileInfo.lods.forEach(function(e){return e.scale=e.scale/i.tileInfo.dpi*96});var g=e.essentials.GeometryUtilities.scaleEnvelopeWithoutTranslation(this.layers[0].fullExtent,1.1);null==g&&(g=e.essentials.GeometryUtilities.scaleEnvelopeWithoutTranslation(this.essentialsMap.fullExtent,1.1));var v=new esri.layers.WMTSLayerInfo({tileInfo:this.tileInfo,fullExtent:g,initialExtent:g,identifier:this.layers.length>0?this.layers[0].name:null,tileMatrixSet:this.tileMatrixSet,format:this._getEsriOgcImageFormat(),style:this.layers[0].styleName?this.layers[0].styleName:""}),w={serviceMode:"KVP",resourceInfo:s={version:this.serverVersion,layerInfos:[v],getTileUrl:this._prefixProxy(this.mapUrl)},layerInfo:v},b=new esri.layers.WMTSLayer(n,w);if(b.id=this.id,this._applyAttributionUrl(b),b._url){var S=0,x=e.hasProxy()?2:1;b._url=b._url.replace(/\?/g,function(e){return++S<=x?"?":""})}dojo.connect(b,"onError",this,this._layerLoadErrorHandler),dojo.connect(b,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded)),this._initiallyVisible?b.show():b.hide(),this.serviceLayer=b;break;case e.essentials.MapServiceType.WEBTILED:var I=n.replace(/([^$])({[^}]*})/g,function(e,t,i){return t+"$"+i}),_={copyright:this.copyright,id:this.id,subDomains:null};I.indexOf("${subDomain}")>=0&&(_.subDomains=this.subDomains);var E=new esri.layers.WebTiledLayer(I,_);E.id=this.id,this._applyAttributionUrl(E),this._initiallyVisible?E.show():E.hide(),dojo.connect(E,"onError",this,this._layerLoadErrorHandler),dojo.connect(E,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded)),this.serviceLayer=E;break;case e.essentials.MapServiceType.VECTORTILE:var T=n;if(this._styleUrl&&(T=this._styleUrl,this.essentialsMap&&this.essentialsMap.site)){var L=this.essentialsMap.site.getTokenFromPrincipal(this._styleUrl,this.mapServiceType);L&&(T=this._styleUrl+"?token="+L)}require(["esri/layers/VectorTileLayer"],function(e){var t=new e(T);t.id=i.id,t.loadError&&i._layerLoadErrorHandler(t.loadError),i._initiallyVisible?t.show():t.hide(),dojo.connect(t,"onError",i,i._layerLoadErrorHandler),dojo.connect(t,"onLoad",dojo.hitch(i,i._handleServiceLayerLoaded)),i._applyAttributionUrl(t),i.serviceLayer=t})}this.initiateServiceFailureTimer()}}},r.prototype.initiateServiceFailureTimer=function(){var e=this;this.failureTimeout&&!isNaN(this.failureTimeout)&&setTimeout(function(){e.serviceLayer&&(!e.serviceLayer||e.serviceLayer.loaded)||e.initializationFailure||(e.failureTimeoutThresholdExceeded=!0,e.onFailureTimeoutThresholdExceeded())},1e3*this.failureTimeout)},r.prototype._applyAttributionUrl=function(e){if(this.attributionDataUrl&&""!==this.attributionDataUrl)e.attributionDataUrl=this.attributionDataUrl,e.hasAttributionData=!0;else if(this.hasAttributionData){e.attributionDataUrl=this.url+"/attribution",e.hasAttributionData=!0;var i=t.RestHelperHTTPService.getTokenForScope(e.attributionDataUrl);i&&(e.attributionDataUrl+="?token="+i)}},r.prototype._prefixProxy=function(e){return this.proxyUrl?this.proxyUrl+"?"+e:e},r.prototype._constructWmsLayerInfos=function(){for(var e=[],t=0;t<this.layers.length;t++){var i=this.layers[t];if(null!=i.wmsLayerName){var r=new esri.layers.WMSLayerInfo({name:i.wmsLayerName,title:i.name});r.styleName=i.styleName,e.push(r)}}return e},r.prototype._getWmsVisibleLayers=function(){for(var e=[],t=0;t<this.layers.length;t++){var i=this.layers[t];i.isVisible()&&i.areAllAncestorsVisible()&&null!=i.wmsLayerName&&0==i.subLayerIds.length&&e.push(i.wmsLayerName)}return e},r.prototype._applyWmsLayerVisibility=function(){var e=this._getWmsVisibleLayers();this.serviceLayer.setVisibleLayers(e)},r.prototype._getEsriWmsImageFormat=function(){var e=this._getEsriOgcImageFormat();return"jpeg"==e&&(e="jpg"),e},r.prototype._getEsriOgcImageFormat=function(){return null!=this.imageFormat?this.imageFormat.replace(/^image\//,""):null},r.prototype._findWMSLayerName=function(e,t){for(var i in e){var r=e[i];if(r.title===t)return r.name;if(null!==r.subLayers&&r.subLayers.length>0){var n=this._findWMSLayerName(r.subLayers,t);if(null!==n)return n}}return null},r.prototype._finishWmsLayerConfiguration=function(e){for(var t,i=[],r=0,n=0;n<this.layers.length;n++){var s=this.layers[n];!s.configuredVisible||null!==s.subLayerIds&&0!==s.subLayerIds.length||(null!==s.parentLayerId?this.findLayerById(s.parentLayerId).configuredVisible&&(t=this._getWMSLayerNameFromTitle(s.name),s.wmsLayerName=t,null!==t&&""!==t&&(i[r]=t,r++)):(t=this._getWMSLayerNameFromTitle(s.name),s.wmsLayerName=t,null!==t&&""!==t&&(i[r]=t,r++)))}this.serviceLayer.setVisibleLayers(i),this._handleServiceLayerLoaded(e)},r.prototype._handleServiceLayerLoaded=function(e){this._configureTimeInfo(),this.isServiceLayerLoaded=!0,this.essentialsMap&&this.essentialsMap.site&&dojo.isFunction(this.essentialsMap.site.onLayerLoad)&&this.essentialsMap.site.onLayerLoad(e)},r.prototype.convertToDynamicLayers=function(){var e=this.serviceLayer;e&&e instanceof esri.layers.ArcGISDynamicMapServiceLayer&&(e.dynamicLayerInfos||e.setDynamicLayerInfos(this._createDynamicLayerInfos(e)),e.layerDrawingOptions||(e.layerDrawingOptions=[]))},r.prototype._layerLoadErrorHandler=function(e){e&&e.message&&0==e.message.indexOf("Unable to load tile")||(this.initializationFailure=e,this.essentialsMap&&this.essentialsMap.site&&dojo.isFunction(this.essentialsMap.site.onLayerLoadError)&&(this._layerLoadErrorHandler=this.essentialsMap.site.onLayerLoadError))},r.prototype.remove=function(e){if(!e)throw new Error("Expecting a layer.");var t=this.serviceLayer;if(!(e.isDynamic&&this.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer&&this.serviceLayer))throw"MapService - remove() - Unsupported Layer Type.";this.convertToDynamicLayers();var i=parseInt(e.id,10),r=this.findLayerById(e.id);null!=r&&(c=this.layers.indexOf(r))>-1&&(r.setInActiveTheme(!1),this.layers.splice(c,1),dojo.publish("CatalogLayerRemovedEvent",r));var n=this.getVisibleLayers();if(null==i)throw"Could not convert Layer ID '"+e.id+"' into an integer!";var s=[];t.dynamicLayerInfos&&(s=dojo.clone(this.serviceLayer.dynamicLayerInfos));var a=[];if(t.layerDrawingOptions&&(a=this.serviceLayer.layerDrawingOptions),e.isDynamic){for(var o=null,l=0;l<s.length;l++)if(s[l].id===i){o=s[l];break}if(o){var c=s.indexOf(o);c>-1&&(s.splice(c,1),t.setDynamicLayerInfos(s,!0))}var u=[];for(var h in a)a.hasOwnProperty(h)&&h!==e.id&&(u[h]=dojo.clone(a[h]));this._removeDefinitionExpression(e,t),t.setLayerDrawingOptions(u)}n.indexOf(e.id)>-1&&n.splice(n.indexOf(e.id),1),this._syncLayerVisibilities(n)},r.prototype.add=function(e){if(!e)throw new Error("Expecting a layer");var t=this.serviceLayer;if(!(e.isDynamic&&t instanceof esri.layers.ArcGISDynamicMapServiceLayer))throw"MapService - add() - Unsupported layer type..";this.convertToDynamicLayers();var i=this.getVisibleLayers();e.mapService=this,this.layers.push(e),dojo.publish("CatalogLayerAddedEvent",e);var r=[];t.dynamicLayerInfos&&(r=t.dynamicLayerInfos);var n=[];t.layerDrawingOptions&&(n=t.layerDrawingOptions);var s,a,o=parseInt(e.id,10);if(null==o)throw"Could not convert Layer ID '"+e.id+"' into an integer!";(s=e._createDynamicLayerInfo()).name||(s.name=e.displayName),null!=s&&r.push(s),null!=(a=e.getLayerDrawingOptions())&&(n[o]=a),n.length>0&&t.setLayerDrawingOptions(n,!0),this._addDefinitionExpression(e,t),t.setDynamicLayerInfos(r),i.push(e.id),this._syncLayerVisibilities(i)},r.prototype.getDynamicLayerInfoById=function(e){var t=null;if(this.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer){var i=parseInt(e,10);if(!isNaN(i)){var r=this.serviceLayer.dynamicLayerInfos;if(r)for(var n=0;n<r.length;n++)r[n].id===i&&(t=r[n])}}return t},r.prototype._syncLayerVisibilities=function(t){for(var i=0;i<this.layers.length;i++)t.indexOf(this.layers[i].id)>-1?this.layers[i].visibleStateForRefresh=e.essentials.RefreshVisibility.SHOW:this.layers[i].visibleStateForRefresh=e.essentials.RefreshVisibility.HIDE;0==t.length&&t.push("-1"),this.serviceLayer.setVisibleLayers(t)},r.prototype._handleDynamicLayers=function(e){var t=this;if(this.supportsDynamicLayers){var i=dojo.some(this.layers,function(e){return e.isDynamic}),r=dojo.some(this.layers,function(e){return null!=e.drawIndex}),n=dojo.some(this.layers,function(e){return e.canToggleLabels&&!e.showLabels});if(i||r||n||this.hasLayerCatalog){var s=this.essentialsMap.getMap();if(s&&(s.spatialReference&&(s.spatialReference.wkid&&!(s.spatialReference.wkid<=0)||s.spatialReference.wkt&&s.spatialReference.wkt.trim())||null!=e.spatialReference&&e.spatialReference.wkt&&e.spatialReference.wkt.trim()&&(s.spatialReference=e.spatialReference),s.extent&&(!s.extent.spatialReference||(!s.extent.spatialReference.wkid||s.extent.spatialReference.wkid<=0)&&(!s.extent.spatialReference.wkt||!s.extent.spatialReference.wkt.trim()))&&null!=e.spatialReference&&e.spatialReference.wkt&&e.spatialReference.wkt.trim())){var a=new esri.geometry.Extent(s.extent);a.spatialReference=e.spatialReference,this.essentialsMap.extentManager.setExtentWithPriority(a,2)}var o=this._createDynamicLayerInfos(e),l=[];if(e.layerDrawingOptions&&(l=dojo.mixin([],e.layerDrawingOptions)),n&&dojo.forEach(this.layers,function(e,t){if(e.canToggleLabels){var i=e.getLayerDrawingOptions();if(null==i){i=new esri.layers.LayerDrawingOptions;var r=parseInt(e.id,10);l[r]=i}i.showLabels=e.showLabels}}),dojo.forEach(this.layers,function(e,t){if(e.isDynamic){var i,r,n=parseInt(e.id,10);if(!n)throw"Could not convert Layer ID '"+e.id+"' into an integer!";(i=e._createDynamicLayerInfo()).name||(i.name=e.name),i&&o.splice(t,0,i),(r=e.getLayerDrawingOptions())&&(l[n]=r,null!=e.showLabels&&(r.showLabels=e.showLabels))}}),r){var c=dojo.clone(o),u=[];dojo.forEach(this.layers,function(e,t){null!=e&&null!=e.drawIndex&&u.push(e)}),u.sort(function(e,t){return e.drawIndex-t.drawIndex}),dojo.forEach(u,function(e,t){for(var i=null,r=null,n=0;n<c.length;n++){var s=c[n];if(s.id.toString()==e.id){i=s,r=n;break}}null!=i&&null!=r&&(c.splice(r,1),c.push(i))}),o=[],dojo.forEach(c,function(e,t){o.push(e)})}setTimeout(function(){e.visibleLayers;l.length>0&&e.setLayerDrawingOptions(l,!0),o.length>0&&e.setDynamicLayerInfos(o,!0);var i=t.getVisibleLayers();i.InternallyChangedLayer={},i.length>0?e.setVisibleLayers(i):(i.push("-1"),e.setVisibleLayers(i))},0)}}},r.prototype._createDynamicLayerInfos=function(e,t){void 0==t&&(t=!0);var i=null;if(null!=e&&(i=e.createDynamicLayerInfosFromLayerInfos(),t))for(var r=i.length-1;r>=0;r--){var n=this.findLayerById(i[r].id.toString());(null==n||n.isDynamic)&&i.splice(r,1)}return i},r.prototype._getAgsDynamicImageFormat=function(e){if(void 0===e||null===e||e.length<1)return"png8";var t=e.toLowerCase();switch(t){case"png":case"png8":case"png24":case"png32":case"jpeg":case"jpg":case"gif":case"bmp":case"svg":case"svgz":case"emf":case"ps":case"pdf":return t;default:return"png8"}},r.prototype._getAgsImageServiceImageFormat=function(e){if(void 0===e||null===e||e.length<1)return null;var t=e.toLowerCase();switch(t){case"jpgpng":case"png":case"png8":case"png24":case"png32":case"jpeg":case"jpg":case"gif":case"bmp":case"tiff":return t;default:return null}},r.prototype._getVisibleGroupLayersOfType=function(e,t,i,r){if(t[e])for(var n=0;n<t.subLayerIds.length;n++){var s=this.findLayerById(t.subLayerIds[n]);s[e]&&(null!==s.subLayerIds&&s.subLayerIds.length>0?r=this._getVisibleGroupLayersOfType(e,s,i,r):dojo.indexOf(i,s.id)<0&&(i[r]=s.id,r++))}return r},r.prototype._getWMSLayerNameFromTitle=function(e){return this.serviceLayer instanceof esri.layers.WMSLayer?this._findWMSLayerName(this.serviceLayer.layerInfos,e):null},r.prototype._getPrincipalResult=function(e){if(this.essentialsMap&&this.essentialsMap.site&&this.essentialsMap.site.principal)return e(this.essentialsMap.site.principal)},r.prototype._processConnectionString=function(t,i){var r=e.essentials.ServiceHelper.extractConnectionStringValue;if(this.mapServiceType==e.essentials.MapServiceType.BING){this.bingProperties={};var n;(n=r(t,"mapStyle"))&&n.length>0&&(this.bingProperties.mapStyle=n),(n=r(t,"culture"))&&n.length>0&&(this.bingProperties.culture=n),(n=r(t,"key"))&&n.length>0&&(this.bingProperties.bingMapsKey=n)}else{var s=r(t,"url");if(s.length>0)this.serviceUrl=s.replace(/%3d/g,"=").replace(/%3D/g,"=");else if((this.mapServiceType===e.essentials.MapServiceType.DYNAMIC||this.mapServiceType===e.essentials.MapServiceType.TILED)&&this.essentialsMap.site.getEssentialsVersion()>=3.912||(this.mapServiceType===e.essentials.MapServiceType.FEATURE||this.mapServiceType===e.essentials.MapServiceType.IMAGE||this.mapServiceType===e.essentials.MapServiceType.VECTORTILE)&&this.essentialsMap.site.getEssentialsVersion()>=4.01){if(this.essentialsMap.site.getEssentialsVersion()<4.03)this.serviceUrl=this.url+"/MapServer";else{var a=this.essentialsMap.site.getEssentialsVersion()<4.05?"/GeoREST":"/rest/services/x";if(this.mapServiceType===e.essentials.MapServiceType.FEATURE){if(!(i&&i.layers&&i.layers.length>0&&i.layers[0]))throw new Error("Unable to configure FeatureLayer connection string. No child layer is specified.");this.serviceUrl=this.url+a+"/FeatureServer/"+i.layers[0].id}else this.mapServiceType===e.essentials.MapServiceType.IMAGE?this.serviceUrl=this.url+a+"/ImageServer":this.mapServiceType===e.essentials.MapServiceType.VECTORTILE?this.serviceUrl=this.url+a+"/VectorTileServer":this.serviceUrl=this.url+a+"/MapServer"}this._getPrincipalResult(function(e){return e.isAuthenticated})&&(this.serviceToken=this._getPrincipalResult(function(e){return e.tokens.site})),"3.912"===this.essentialsMap.site.currentVersion&&(this._needsProxy=!0)}var o=r(t,"geometryServiceUrl");o.length>0&&(this.geometryServiceUrl=o),this.mapServiceType===e.essentials.MapServiceType.VECTORTILE&&(this._styleUrl=r(t,"styleUrl")),this.essentialsMap&&this.essentialsMap.site&&!this.serviceToken&&(this.serviceToken=this.essentialsMap.site.getTokenFromPrincipal(this.serviceUrl,this.mapServiceType));var l=r(t,"token"),c=this.essentialsMap&&this.essentialsMap.site?this.essentialsMap.site.arcGisPortalSecurityContext:null;if(l.length>0)this.serviceToken=l;else if(c&&c.appliesTo(this.serviceUrl)&&c.tokenResult)this.serviceToken=c.tokenResult.token;else if(null!=this.serviceUrl){var u=e.essentials.RestHelperHTTPService.getAuthenticationControlBlockStore().find(this.serviceUrl);u&&null!=u.token&&(this.serviceToken=u.token)}var h=r(t,"proxy");h.length>0&&(this.proxyUrl=h,esri.addProxyRule({urlPrefix:this.serviceUrl,proxyUrl:h}),this.serviceUrl.indexOf("services.arcgis")>-1&&esri.addProxyRule({urlPrefix:this.serviceUrl.replace("services.arcgis","server.arcgis"),proxyUrl:h}));var p=r(t,"mapUrl");p.length>0&&(this.mapUrl=p.replace(/%3d/g,"=").replace(/%3D/g,"="));var d=r(t,"tileRestUrl");d.length>0&&(this.tileRestUrl=d.replace(/%3d/g,"=").replace(/%3D/g,"="));var f=r(t,"subDomains");f&&(this.subDomains=f.split(","))}},r.prototype._isLocalProxyInfo=function(e){return!!e&&("local-reverse-proxy"==e.type&&!!e.address)},r.prototype._processProxyInfo=function(e){if(this._isLocalProxyInfo(e)){for(var t=(this.url+"/../../../../../"+e.address).split("/"),i=t.indexOf("..");i>0;i=t.indexOf(".."))t.splice(i-1,2);this.serviceUrl=t.join("/")}},r.prototype.supportsLayerVisibility=function(){switch(this.mapServiceType){case e.essentials.MapServiceType.FEATURE:case e.essentials.MapServiceType.GEORSS:case e.essentials.MapServiceType.KML:case e.essentials.MapServiceType.BING:case e.essentials.MapServiceType.TILED:case e.essentials.MapServiceType.WMTS:case e.essentials.MapServiceType.IMAGE:case e.essentials.MapServiceType.WEBTILED:return!1;case e.essentials.MapServiceType.DYNAMIC:return null!==this.serviceLayer&&!!this.serviceLayer.visibleLayers}return!0},r.prototype._setVisibility=function(t,i,r){var n={mapServiceId:this.id,layerId:t,visibility:i};void 0===r&&(r=!1);var s,a,o;switch(this.mapServiceType){case e.essentials.MapServiceType.DYNAMIC:if(null!==this.serviceLayer){if(!this.serviceLayer.visibleLayers){i?this.serviceLayer.show():this.serviceLayer.hide(),dojo.publish("LayerVisibilityChange",[new Array(n)]);break}var l=this.getVisibleLayers();l.InternallyChangedLayer=n,0===l.length&&l.push("-1"),this.serviceLayer.setVisibleLayers&&this.serviceLayer.setVisibleLayers(l,r)}break;case e.essentials.MapServiceType.WMS:if(null!==this.serviceLayer){var c=[];for(c.InternallyChangedLayer=n,s=0,a=0;a<this.layers.length;a++)if((o=this.layers[a]).isVisible()&&(null===o.subLayerIds||0===o.subLayerIds.length)&&o.areAllAncestorsVisible()){var u=o.wmsLayerName;null!==u&&""!==u&&(c[s]=u,s++)}r?(this.serviceLayer.visibleLayers=c.slice(0),dojo.publish("LayerVisibilityChange",[new Array(n)])):this.serviceLayer.setVisibleLayers(c)}break;case e.essentials.MapServiceType.FEATURE:case e.essentials.MapServiceType.GEORSS:case e.essentials.MapServiceType.KML:case e.essentials.MapServiceType.BING:case e.essentials.MapServiceType.TILED:case e.essentials.MapServiceType.WMTS:case e.essentials.MapServiceType.IMAGE:case e.essentials.MapServiceType.WEBTILED:if(null!==this.serviceLayer){if(1!==this.layers.length)throw new Error("Visibility of individual layers cannot be set for this Map Service: {0}".format(this.displayName));i?this.serviceLayer.show():this.serviceLayer.hide(),dojo.publish("LayerVisibilityChange",[new Array(n)])}break;default:throw new Error("Cannot set layer visibility. Unknown MapService type.")}},r.prototype._extendWms=function(){if(!e.essentials.MapService._wmsExtended){var t=esri.layers.WMSLayer._meta.hidden.getImageUrl,i=/.*images\/pixel.png$/;esri.layers.WMSLayer.extend({getImageUrl:function(e,r,n,s){var a=this;t.apply(this,[e,r,n,function(e){if(i.test(e))s(e);else{for(var t={},r=0;r<a.layerInfos.length;r++)t[a.layerInfos[r].name]=a.layerInfos[r].styleName;var n=[];for(r=0;r<a.visibleLayers.length;r++)n.push(t[a.visibleLayers[r]]);var o=n.join(","),l=e.substring(e.lastIndexOf("?")+1,e.length),c=dojo.queryToObject(l);c.STYLES=o,a.preferredSpatialReference&&(c[c.CRS?"CRS":"SRS"]="EPSG:"+a.preferredSpatialReference),a.__gcxWmsImageFormat&&(c.FORMAT=a.__gcxWmsImageFormat);var u=a.getMap(),h=u&&u.timeExtent?u.timeExtent.startTime:a.timeInfo&&a.timeInfo.timeExtent&&a.timeInfo.timeExtent.startTime,p=u&&u.timeExtent?u.timeExtent.endTime:a.timeInfo&&a.timeInfo.timeExtent&&a.timeInfo.timeExtent.endTime;if(h&&p){var d=new Date(h.getTime()-60*h.getTimezoneOffset()*1e3).toISOString(),f=new Date(p.getTime()-60*p.getTimezoneOffset()*1e3).toISOString();c.TIME=d+"/"+f}var y=e.substring(0,e.lastIndexOf("?")+1)+dojo.objectToQuery(c);s(y)}}])}}),e.essentials.MapService._wmsExtended=!0}},r.prototype._hasTileLevels=function(){return!!this.tileInfo&&(!!this.tileInfo.lods&&this.tileInfo.lods.length>0)},r.prototype.applyCatalogLayersChange=function(t){var i=this,r=!1,n=[];if(this.id==t.mapServiceId){for(var s=0;s<t.entries.length;s++){var a=t.entries[s],o=this.findLayerById(a.id);o||(o=new e.essentials.Layer(this.url+" / layers /"+t.entries[s].id),t.entries[s].visible=!0,o.createFromDefinition(t.entries[s]),o.isUserCreated=!0,o.includeInLayerList=!0,o.setInActiveTheme(!0)),n.push(o)}var l=this.layers.filter(function(e){return e.isUserCreated&&n.indexOf(e)<0}),c=n.filter(function(e){return i.layers.indexOf(e)<0});return l.forEach(function(e){i.remove(e),r=!0}),c.forEach(function(e){i.add(e),r=!0}),r?(dojo.publish("MapServiceLayersChangedWithResultEvent",{mapService:this,newItems:[].concat(c),oldItems:[].concat(l)}),dojo.publish("CatalogLayersChangedEvent",this),c):[]}},r.prototype.getLayerThemeSettings=function(e){for(var t=0;t<this.layerThemeSettings.length;t++){var i=this.layerThemeSettings[t];if(i.theme===e||i.theme.id===e)return i}return null},r.prototype.getFeatureLayer=function(){var e=this;if(this._featureLayerPromise)return this._featureLayerPromise;var i;if(this.serviceLayer instanceof esri.layers.FeatureLayer)i=this.serviceLayer;else{if(this.mapServiceType!==t.MapServiceType.IMAGE)return Promise.resolve(null);var r=this.serviceUrl;null!==this.serviceToken&&(r=r+(r.indexOf("?")>-1?"&token=":"?token=")+encodeURIComponent(this.serviceToken)),i=new esri.layers.FeatureLayer(r)}return i.loaded?this._featureLayerPromise=Promise.resolve(i):this._featureLayerPromise=new Promise(function(t,r){var n=i.on("load",function(){n.remove(),s.remove(),t(i)}),s=i.on("error",function(t){n.remove(),s.remove(),e._featureLayerPromise=null,r(t)})}),this._featureLayerPromise},r.prototype._resetUpdateTimer=function(){if(void 0!=this.updateInterval&&0!=this.updateInterval){void 0!=this._updateIntervalId&&window.clearInterval(this._updateIntervalId);var e=this;this._updateIntervalId=setInterval(function(){e._onUpdateIntervalTick()},1e3*this.updateInterval)}else window.clearInterval(this._updateIntervalId),this._updateIntervalId=null},r.prototype._onUpdateIntervalTick=function(){if(this.serviceLayer&&this.serviceLayer.refresh){var e=this;e.serviceLayer.setDisableClientCaching?(e.serviceLayer.setDisableClientCaching(!0),e.serviceLayer.refresh(),e.serviceLayer.setDisableClientCaching(e.disableClientCaching)):e.serviceLayer.refresh()}},r.prototype._addToFilteredView=function(e){e&&this._layerThemeLayerFilter(e)&&this.layersFilteredView.push(e)},r.prototype._layerThemeLayerFilter=function(e){return!e.mapService.essentialsMap.layerThemesInfo.layerThemesConfigured||e.inActiveTheme},r.prototype._getDefaultGeometryServiceUrl=function(){var e=this.essentialsMap?this.essentialsMap.site:null;return e&&e.geometryEndpoints&&e.geometryEndpoints.length>0?e.geometryEndpoints[0].geometryServiceUrl:null},r.prototype._getDefaultGeometryServiceToken=function(){var e=this.essentialsMap?this.essentialsMap.site:null;return e&&e.geometryEndpoints&&e.geometryEndpoints.length>0?e.geometryEndpoints[0].geometryServiceToken:null},r._wmsExtended=!1,r}(t.AsyncInitializable);t.MapService=i}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){var i=function(t){function i(e){t.call(this,e),this.color=[255,0,0],this.selectionColor=[0,255,255],this.disableClientCaching=!1,this.onDemandCacheSize=1e3,this.outFields="",this.queryMode=esri.layers.FeatureLayer.MODE_ONDEMAND,this.tileHeight=null,this.tileWidth=null,this.where=null,this.canUpdate=null,this.canAdd=null,this.canDelete=null,this.canEdit=null,this.canAddAttachments=null,this.moveEnabled=null,this.rotateEnabled=null,this.editVerticesEnabled=null,this.scaleEnabled=null,this.renderer=null,this._colorSet=!1,this._initialFeatureCollection=null,this._serviceLayer=null,this.serviceUrl=e}return __extends(i,t),i.prototype.getEmptyFeatureCollection=function(){return JSON.parse(this._initialFeatureCollection)},i.prototype.restoreFeatureLayer=function(){if(!this._serviceLayer._mode)switch(this._serviceLayer.mode){case esri.layers.FeatureLayer.MODE_SNAPSHOT:this._serviceLayer._mode=new esri.layers._SnapshotMode(this._serviceLayer);break;case esri.layers.FeatureLayer.MODE_ONDEMAND:this._serviceLayer._mode=new esri.layers._OnDemandMode(this._serviceLayer);break;case esri.layers.FeatureLayer.MODE_SELECTION:this._serviceLayer._mode=new esri.layers._SelectionMode(this._serviceLayer)}this.replaceFeatureLayer(this._serviceLayer,!0,!0,!0),this.serviceLayer.resume(),this.serviceLayer.mode===esri.layers.FeatureLayer.MODE_SNAPSHOT&&0===this.serviceLayer.graphics.length&&this.serviceLayer.refresh()},i.prototype.replaceFeatureLayer=function(e,t,i,r){var n=this.serviceLayer;if(!e)throw new Error("featureLayer cannot be null in order to replace the feature layer.");var s=this._getEsriMap();if(!s)throw new Error("Unable to get access to the Esri map object to perform the Feature Layer replace.");if(!this.serviceLayer)throw new Error("ServiceLayer not present. Can't replace the the FeatureLayer");t&&(e.visible=n.visible,e.setMaxScale(n.maxScale),e.setMinScale(n.minScale)),i&&(e.opacity=n.opacity),r&&e.setRenderer(n.renderer);var a=dojo.indexOf(s.graphicsLayerIds,n.id);this.serviceLayer=e,n.suspend(),s.removeLayer(n),s.addLayer(e,a),n.url||this._cleanUpLayer(n)},i.prototype._cleanUpLayer=function(e){if(e.clear(),e._essentialsMetadata){var t=e._essentialsMetadata.eventHandlers,i=0;for(i=0;i<t.length;i++)dojo.disconnect(t[i])}},i.prototype.queryCount=function(e,t,i){this.isServiceLayerLoaded&&this.serviceLayer&&this.serviceLayer.queryCount(e,function(e){t&&t(e)},function(e){i&&i(e)})},i.prototype.queryFeatures=function(e,t,i){if(this.isServiceLayerLoaded&&this.serviceLayer)return this.serviceLayer.queryFeatures(e,t,i);var r=new Error("Esri layer has not finished loading");if(i)return i(r),null;var n=new dojo.Deferred;return n.reject(r),n},i.prototype.queryIds=function(e,t,i){if(this.isServiceLayerLoaded&&this.serviceLayer)return this.serviceLayer.queryIds(e,t,i);if(i){var r=new Error("Esri layer has not finished loading");i(r);var n=new dojo.Deferred;return n.reject(r),n}},i.prototype.queryRelatedFeatures=function(e,t,i){if(this.isServiceLayerLoaded&&this.serviceLayer)return this.serviceLayer.queryRelatedFeatures(e,t,i);if(i){var r=new Error("Esri layer has not finished loading");i(r);var n=new dojo.Deferred;return n.reject(r),n}},i.prototype._getEsriMap=function(){var e=null;return null!==this.essentialsMap&&null!==this.essentialsMap.site&&(e=this.essentialsMap.site.getMap()),e},i.prototype._configureObject=function(e,i){if(void 0===e||void 0===e.outFields||void 0===e.queryMode||void 0===e.where)throw new Error("Incorrect map service object returned from initialization");if(this.disableClientCaching=!!e.disableClientCaching,this.onDemandCacheSize=void 0===e.onDemandCacheSize||null===e.onDemandCacheSize?this.onDemandCacheSize:e.onDemandCacheSize,e.outFields||(e.outFields="*"),this.outFields=e.outFields,this.where=e.where,void 0===e.queryMode)this.queryMode=esri.layers.FeatureLayer.MODE_ONDEMAND;else switch(e.queryMode){case"Selection":case"SelectionOnly":this.queryMode=esri.layers.FeatureLayer.MODE_SELECTION;break;case"Snapshot":this.queryMode=esri.layers.FeatureLayer.MODE_SNAPSHOT;break;default:this.queryMode=esri.layers.FeatureLayer.MODE_ONDEMAND}if(e.tileHeight&&(this.tileHeight=e.tileHeight),e.tileWidth&&(this.tileWidth=e.tileWidth),e.selectionColor&&(this.selectionColor=e.selectionColor),e.color&&(this.color=e.color,this._colorSet=!0,this.color.length>3&&(this.color[3]=this.color[3]/255)),this.editVerticesEnabled=!e.hasOwnProperty("editVerticesEnabled")||e.editVerticesEnabled,this.moveEnabled=!e.hasOwnProperty("moveEnabled")||e.moveEnabled,this.scaleEnabled=!e.hasOwnProperty("scaleEnabled")||e.scaleEnabled,this.rotateEnabled=!e.hasOwnProperty("rotateEnabled")||e.rotateEnabled,e.renderer)try{this.renderer=esri.renderer.fromJson(e.renderer)}catch(e){}t.prototype._configureObject.call(this,e,i)},i.prototype._updateServiceToken=function(e){if(t.prototype._updateServiceToken.call(this,e),this.serviceLayer){var i=this.serviceLayer._task;i&&i._url&&i._url.query&&(i._url.query.token=e)}},i.prototype._createServiceLayer=function(){t.prototype._createServiceLayer.call(this);var e=this.serviceUrl;null!==this.serviceToken&&(e=e+"?token="+encodeURIComponent(this.serviceToken));var i={};i.id=this.id,i.opacity=this.configuredOpacity,i.visible=this._computeInitServiceLayerVisibility(),this.outFields&&this.outFields.length>0&&(i.outFields=this.outFields.split(",")),null!==this.queryMode&&(i.mode=this.queryMode),null!==this.tileHeight&&null!==this.tileWidth&&this.queryMode==esri.layers.FeatureLayer.MODE_ONDEMAND&&(i.tileHeight=this.tileHeight,i.tileWidth=this.tileWidth),this.serviceLayer=new esri.layers.FeatureLayer(e,i),this.serviceLayer.setRenderer(this.renderer),this.attributionDataUrl&&""!==this.attributionDataUrl?(this.serviceLayer.attributionDataUrl=this.attributionDataUrl,this.serviceLayer.hasAttributionData=!0):this.hasAttributionData&&(this.serviceLayer.attributionDataUrl=this.url+"/Attribution",this.serviceLayer.hasAttributionData=!0),this._serviceLayer=this.serviceLayer,this.where&&this.serviceLayer.setDefinitionExpression(this.where),dojo.connect(this.serviceLayer,"onError",this,this._layerLoadErrorHandler),this.serviceLayer.loaded?this._handleLayerLoadEvent(this.serviceLayer):dojo.connect(this.serviceLayer,"onLoad",dojo.hitch(this,this._handleLayerLoadEvent)),t.prototype.initiateServiceFailureTimer.call(this)},i.prototype._computeInitServiceLayerVisibility=function(){var e=this._initiallyVisible;return e&&this.layers&&1===this.layers.length&&(e=this.layers[0].isVisible()),e},i.prototype._handleLayerLoadEvent=function(e){if(this.serviceLayer.version<10||this._colorSet){var t=null;if("esriGeometryPoint"==this.serviceLayer.geometryType){t=new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE,15,null,new esri.Color(this.selectionColor));var i=new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE,15,null,new esri.Color(this.color)),r=new esri.renderer.SimpleRenderer(i);this.serviceLayer.setRenderer(r)}else if("esriGeometryPolyline"==this.serviceLayer.geometryType){t=new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new esri.Color(this.selectionColor),1);var n=new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new esri.Color(this.color),1),s=new esri.renderer.SimpleRenderer(n);this.serviceLayer.setRenderer(s)}else if("esriGeometryPolygon"==this.serviceLayer.geometryType){t=new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new esri.Color([0,0,0]),1),new esri.Color(this.selectionColor));var a=new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new esri.Color([0,0,0]),1),new esri.Color(this.color)),o=new esri.renderer.SimpleRenderer(a);this.serviceLayer.setRenderer(o)}this.serviceLayer.setSelectionSymbol(t)}var l=this.serviceLayer.getEditCapabilities();this.canUpdate=l.canUpdate,this.canAdd=l.canCreate,this.canDelete=l.canDelete,this.canEdit=this.serviceLayer.isEditable(),this.canAddAttachments=!1,this.serviceLayer.capabilities&&(this.canAddAttachments=this.serviceLayer.version&&this.serviceLayer.version>=10.1&&this.serviceLayer.hasAttachments&&this.canEdit),this._initialFeatureCollection=JSON.stringify(this.serviceLayer.toJson()),this._handleServiceLayerLoaded(e)},i.prototype.hasOriginRelationships=function(){if(this.serviceLayer&&this.serviceLayer.version>=10.1&&this.serviceLayer.relationships&&this.serviceLayer.relationships.length>0){for(var e=0;e<this.serviceLayer.relationships.length;e++)if("esriRelRoleOrigin"===this.serviceLayer.relationships[e].role)return!0;return!1}return!1},i.prototype.getRelatedFeatureLayer=function(t,i,r){var n=new dojo.Deferred;if(this.serviceLayer.version<10.1){a=new Error("getRelatedFeatureLayer is only available for feature layer from ArcGIS 10.1 or greater.");return n&&-1==n.fired&&n.resolve(a),"function"==typeof r&&r(a),n}var s=this._getEsriRelation(t);if(!s){var a=new Error("Relation not found: "+t);return n&&n.reject(a),"function"==typeof r&&r(a),n}var o=this.serviceUrl.substring(0,this.serviceUrl.lastIndexOf("/")+1)+s.relatedTableId;this.serviceToken&&(o+=o.indexOf("?")>-1?"&token=":"?token=",o+=encodeURIComponent(this.serviceToken)),void 0===esri.getProxyRule(o)&&null!==this.proxyUrl&&esri.addProxyRule({urlPrefix:o,proxyUrl:this.proxyUrl});var l=new esri.layers.FeatureLayer(o,{mode:esri.layers.FeatureLayer.MODE_SELECTION,outFields:["*"]});return dojo.connect(l,"onLoad",dojo.hitch(this,function(t){e.deferredResolve(n,t),"function"==typeof i&&i(t)})),dojo.connect(l,"onError",dojo.hitch(this,function(e){n&&-1==n.fired&&n.resolve(e),"function"==typeof r&&r(e)})),n},i.prototype._getEsriRelation=function(e){if("string"==typeof e&&(e=parseInt(e)),this.serviceLayer.relationships)for(var t=0;t<this.serviceLayer.relationships.length;t++)if(this.serviceLayer.relationships[t].id==e)return this.serviceLayer.relationships[t];return null},i.prototype._getRelation=function(e){return this.layers&&this.layers.length>0?this.layers[0]._getRelation(e):null},i}(t.MapService);t.FeatureLayerService=i}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){var t=function(){function e(e,t,i,r){this.runtimeTypeName=null,this.name=e||null,this.typeName=t||null,this.isRequired=!!i,this.value=r||null}return e.prototype._configureObject=function(e){if(void 0===e.name||void 0===e.typeName)throw new Error("Incorrect argument info object returned from initialization");this.name=e.name,this.typeName=e.typeName,this.isRequired=e.isRequired,this.value=e.value,this.runtimeTypeName=e.runtimeTypeName},e.prototype._internalClone=function(){var t=new e(this.name,this.typeName,this.isRequired,dojo.clone(this.value));return t.runtimeTypeName=dojo.clone(this.runtimeTypeName),t},e}();e.ArgumentInfo=t}(e.workflow||(e.workflow={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){var i=function(){function t(e,t,i,r,n,s,a,o,l){this.debug=!1,this.id=e||null,this.displayName=t||null,this.typeName=i||null,this.instanceId=r||null,this.externalId=n||null,this.syncToken=s||null,this.isComplete=a||!1,this.isAborted=!1,this.inputs=o||[],this.outputs=l||[]}return t.prototype._configureObject=function(t){if(void 0===t.id||void 0===t.displayName||void 0===t.typeName||void 0===t.instanceId)throw new Error("Incorrect external activity info object returned from initialization");this.id=t.id,this.displayName=t.displayName,this.typeName=t.typeName,this.instanceId=t.instanceId,this.externalId=t.externalId,this.syncToken=t.syncToken,this.isComplete=t.isComplete,t.debug&&(this.debug=t.debug),this.inputs=[],this.outputs=[];var i;if(t.inputs)for(i=0;i<t.inputs.length;i++){r=t.inputs[i];(n=new e.workflow.ArgumentInfo)._configureObject(r),this.inputs[i]=n}if(t.outputs)for(i=0;i<t.outputs.length;i++){var r=t.outputs[i],n=new e.workflow.ArgumentInfo;n._configureObject(r),this.outputs[i]=n}},t}();t.ExternalActivityInfo=i}(e.workflow||(e.workflow={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){var i=function(t){function i(e){t.call(this,e),this.displayName=null,this.error=null,this.extensions=[],this.externalActivities={},this.id=null,this.properties={},this.site=null,this._inputs=[],this._outputs=[]}return __extends(i,t),i.prototype.getInputs=function(){return this._cloneArgumentInfoCollection(this._inputs)},i.prototype.getOutputsMetadata=function(){return this._cloneArgumentInfoCollection(this._outputs)},i.prototype._cloneArgumentInfoCollection=function(e){var t=null;if(null!==e){t=[];for(var i=0;i<e.length;i++)t.push(e[i]._internalClone())}return t},i.prototype._configureObject=function(t,i){if(void 0===t.id||void 0===t.displayName)throw new Error("Incorrect workflow object returned from initialization");var r,n;if(this.id=t.id,this.displayName=t.displayName,this.runOnStartup=!!t.runOnStartup,this.error=t.error,this._inputs=[],this._outputs=[],this.externalActivities=[],t.inputs)for(var s=0;s<t.inputs.length;s++)r=t.inputs[s],(n=new e.workflow.ArgumentInfo)._configureObject(r),this._inputs[s]=n;if(t.outputs)for(s=0;s<t.outputs.length;s++)r=t.outputs[s],(n=new e.workflow.ArgumentInfo)._configureObject(r),this._outputs[s]=n;if(t.externalActivities)for(s=0;s<t.externalActivities.length;s++){var a=t.externalActivities[s],o=new e.workflow.ExternalActivityInfo;o._configureObject(a),this.externalActivities[s]=o}this.properties=e._getProperties(t.properties),this.extensions=e._getExtensions(t.extensions)},i}(t.AsyncInitializable);t.Workflow=i}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){var i=function(i){function r(e){i.call(this,e),this.displayName=null,this.id=null,this._isLoading=!1,this._onLoadingComplete=null,this._onLoadingError=null,this._layerTypes=null,this._arcgisSharingRegularExpressions=[new RegExp("(https?://.*?/)home/item.html\\?id=(\\w*)"),new RegExp("(https?://.*?/)home/webmap/viewer.html\\?webmap=(\\w*)"),new RegExp("(https?://.*?/)explorer/\\?open=(\\w*)"),new RegExp("(https?://.*?/sharing)/content/items/(\\w*)/data"),new RegExp("(https?://.*?/sharing)/content/items/(\\w*)")],this.site=null}return __extends(r,i),r.prototype.isLoading=function(){return this._isLoading},r.prototype._getUrlPortions=function(e){for(var t={id:null,path:null},i=0;i<this._arcgisSharingRegularExpressions.length;++i){var r=this._arcgisSharingRegularExpressions[i],n=e.match(r);if(n&&n.length>0){t.id=n[2],t.path=n[1];break}}return t},r.prototype._loadWebMap=function(e,t,i){var r=this;if(e&&e.path){if(!esri.arcgis||!esri.arcgis.Portal)return;new esri.arcgis.Portal(e.path).on("ready",function(t){if(t){var n={q:"id:"+e.id};t.queryItems(n).then(function(e){if(e){var t=e.results[0];esri.request({url:t.itemDataUrl}).then(function(e){r._processItemData(e),i.resolve(!1)})}})}})}else{var n="Web map with address "+t+" cannot be loaded.",s=esri.urlToObject(t);if(s.query=s.query||{},s.query&&(s.query.webmap||s.query.id)){var a,o=s.query.webmap||s.query.id;esri.arcgis&&esri.arcgis.utils?a=esri.arcgis.utils.getItem:esri.arcgis.getItem&&(a=esri.arcgis.getItem),a&&a(o).then(function(e){e?this._processItemData(e.itemData):this._onLoadingError(new Error(n)),i.resolve(!1)})}else this._onLoadingError(new Error(n)),i.resolve(!1)}},r.prototype._initializeWebMap=function(e,t,i,r){var n=this;if(this.isLoading())r&&r(new Error("Currently loading web map."));else{this._isLoading=!0;var s=new dojo.Deferred;this._onLoadingComplete=dojo.hitch(this,i),this._onLoadingError=dojo.hitch(this,r),this._layerTypes=this.site.webMapsInfo.layerTypes;var a=this._getUrlPortions(e.url);this._loadWebMap(a,e.url,s),s.then(function(e){n._isLoading=e})}},r.prototype._processItemData=function(e){if(e){var t=e.operationalLayers;t&&this._processLayerCollection(t,"Operational");var i=e.baseMap.baseMapLayers;i&&this._processLayerCollection(i,"Base")}},r.prototype._processLayerCollection=function(e,t){var i=this;if(e){for(var r=[],n=0;n<e.length;++n){var s=e[n];if(!this._layerTypes||!(!s.type&&this._layerTypes.indexOf("Null")>=0||s.type&&this._layerTypes.indexOf(s.type)>=0)){var a=this._addLayerToMap(s);r.push(a)}}new dojo.DeferredList(r).then(function(e){if(e){for(var r=[],n=0;n<e.length;++n){var s=e[n][1];s&&(s.length>0?r=r.concat(s):r.push(s))}r.length>0&&i.site.essentialsMap.addServiceLayers(r,t)}},function(e){i._onLoadingError(new Error("There was an error loading a layer: "+e))})}},r.prototype._addLayerToMap=function(i){var r=new dojo.Deferred,n=null;this.site.getMap();switch(i.type){case"CSV":var s=new dojo._Url(window.location.href),a=new dojo._Url(i.url);s.host===a.host&&s.port===a.port&&s.scheme===a.scheme||(i.url=esri.config.defaults.io.proxyUrl+i.url),e.essentials.utilities.LayerUtilities.createFeatureLayerFromCsv(i,null).then(function(e){e&&e.setVisibility&&e.setVisibility(i.visibility),r.resolve(e)},function(e){r.reject(e)});break;case"GeoRSS":var o=new t.GeoRssLayerService(i.url);o.essentialsMap=this.site.essentialsMap;var l={displayName:i.title,serviceType:e.essentials.MapServiceType.GEORSS,connectionString:"url="+i.url,feedImageUri:i.pointSymbol?i.pointSymbol.url:null,opacity:i.opacity,id:i.id||e.framework.utils.alphaNumericToken(),visible:i.visibility};o._configureObject(l),r.resolve(o);break;case"WebTiledLayer":if(!i.wmtsInfo&&esri.layers&&esri.layers.WebTiledLayer){var c={id:i.id,subDomains:i.subDomains,copyright:i.copyright};n=new esri.layers.WebTiledLayer(i.templateUrl,c),i.title&&(n.name=i.title)}r.resolve(n);break;case"WMS":r.resolve(null);break;default:var u=null;i.url||i.featureCollection&&(u=this._addFeatureCollectionToMap(i.featureCollection)),r.resolve(u)}return r.promise},r.prototype._addFeatureCollectionToMap=function(t){var i=this.site.getMap(),r=[];return dojo.forEach(t.layers,function(t){var n=new esri.layers.FeatureLayer(t,{outSR:i.spatialReference});n.layerId=e.framework.utils.alphaNumericToken(),r.push(n)}),r},r.prototype._loadingRestComplete=function(e){this._isLoading=!1,!e&&this._onLoadingError&&this._onLoadingError(new Error("No results")),e.error&&this._onLoadingError&&this._onLoadingError(e.error),this._onLoadingComplete&&this._onLoadingComplete(e.results)},r.prototype._loadingRestError=function(e){this._isLoading=!1,this._onLoadingError&&this._onLoadingError(e)},r.prototype._configureObject=function(e,t){if(void 0===e||void 0===e.id)throw new Error("Incorrect Web Map reference object returned from initialization");this.displayName=e.displayName,this.id=e.id,t&&(this.isInitialized=!0),this._initializeWebMap(e,this.site,function(e){},function(e){throw e})},r}(t.AsyncInitializable);t.WebMapReference=i}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){var t=function(){return function(){}}();e.MapGrid=t}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){var t=function(){return function(e,t){this.name=e,this.type=t}}();e.DistanceUnit=t}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){!function(e){e.OTHER="Other",e.INCHES="Inches",e.FEET="Feet",e.US_SURVEY_FEET="USSurveyFeet",e.YARDS="Yards",e.MILES="Miles",e.NAUTICAL_MILES="NauticalMiles",e.MILLIMETERS="Millimeters",e.CENTIMETERS="Centimeters",e.DECIMETERS="Decimeters",e.METERS="Meters",e.KILOMETERS="Kilometers",e.DEGREES="Degrees",e.RADIANS="Radians",e.GRADS="Grads"}(e.DistanceUnitType||(e.DistanceUnitType={}))}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){var t;!function(e){e[e.NONE=-1]="NONE",e[e.RESIZE=0]="RESIZE",e[e.REPOSITION=1]="REPOSITION",e[e.EXTENT_CHANGE=2]="EXTENT_CHANGE"}(t||(t={}));var i=function(){function e(e,t){this._map=null,this._currentExtentChangePriority=-1,this._queuedExtentChangePriority=-1,this._queuedExtentChange=[],this._extentChangeInProgress=!1,this._fitTiledMapsToExtent=!1,this._newLayers=[],this._initialExtent=null,this.currentExtentChangeHandle=null,this._firstMapResizeExecuted=!1,this._map=e,this._fitTiledMapsToExtent=!!t,this._fitTiledMapsToExtent&&console.log("The fitTiledMapsToExtent parameter is active. When true, for maps that contain tiled map service layers, you are guaranteed to have the input extent shown completely on the map."),this._map.on("resize",dojo.hitch(this,this._onResize)),this._map.on("reposition",dojo.hitch(this,this._onReposition))}return e.prototype.setInitialExtent=function(e){var t=this;this._map&&this._map.loaded?this._setInitialExtentImpl(e):this._map.on("load",function(){return t._setInitialExtentImpl(e)})},e.prototype._setInitialExtentImpl=function(e){this._initialExtent=e;var t=esri.config.defaults.map.panDuration;esri.config.defaults.map.panDuration=0,this._map.reposition(),this._map.setExtent(e,this._fitTiledMapsToExtent),esri.config.defaults.map.panDuration=t,this._firstMapResizeExecuted=!0},e.prototype._onResize=function(e,t,i){if(!this._firstMapResizeExecuted)return this._firstMapResizeExecuted=!0,void this.firstResize();this._handleNextExtentChange()},e.prototype._onReposition=function(e,t){this._handleNextExtentChange()},e.prototype._onExtentChange=function(){this._extentChangeInProgress&&(this._currentExtentChangePriority=-1,this._extentChangeInProgress=!1,this._handleNextExtentChange())},e.prototype.registerLayer=function(e){this._hasLoaded()||this._newLayers.push(e)},e.prototype.firstResize=function(){this._initialExtent&&this._map.extent&&!this._fitTiledMapsToExtent&&!this._map.extent.expand(1.75).contains(this._initialExtent)&&console.log("The 'fitTiledMapsToExtent' parameter may need to be set to true in configuration for the initial extent to be shown completely on the map."),this._handleNextExtentChange()},e.prototype._handleNextExtentChange=function(){if(this._hasLoaded())if(null!==this._queuedExtentChange[t.RESIZE]&&void 0!==this._queuedExtentChange[t.RESIZE]){var e=this._queuedExtentChange[t.RESIZE];this._queuedExtentChange[t.RESIZE]=null,e(this._map)}else if(null!==this._queuedExtentChange[t.REPOSITION]&&void 0!==this._queuedExtentChange[t.REPOSITION]){var i=this._queuedExtentChange[t.REPOSITION];this._queuedExtentChange[t.REPOSITION]=null,i(this._map)}else if(null!==this._queuedExtentChange[t.EXTENT_CHANGE]&&void 0!==this._queuedExtentChange[t.EXTENT_CHANGE]){this._extentChangeInProgress=!0,this._currentExtentChangePriority=this._queuedExtentChangePriority,this._queuedExtentChangePriority=-1;var r=this._queuedExtentChange[t.EXTENT_CHANGE];this._queuedExtentChange[t.EXTENT_CHANGE]=null,r(this._map)}},e.prototype.changeExtentWithPriority=function(e,i){var r=this,n=void 0!==i?i:5,s=function(t){null!==r.currentExtentChangeHandle&&r.currentExtentChangeHandle.cancel(),r.currentExtentChangeHandle=e(t),r.currentExtentChangeHandle.then(dojo.hitch(r,r._onExtentChange),dojo.hitch(r,r._onExtentChange))};if(this._isExtentChangeBlocked()){if(n<this._queuedExtentChangePriority)return;this._queuedExtentChangePriority=n,this._queuedExtentChange[t.EXTENT_CHANGE]=s}else{if(n<this._currentExtentChangePriority)return;this._currentExtentChangePriority=n,this._extentChangeInProgress=!0,s(this._map)}},e.prototype.setExtentWithPriority=function(e,t){var i=this;this.changeExtentWithPriority(function(t){return t.setExtent(e,i._fitTiledMapsToExtent)},t)},e.prototype.centerAtWithPriority=function(e,t){this.changeExtentWithPriority(function(t){var i=t.extent.getCenter(),r=t.extent.getWidth()/t.width,n=t.extent.getHeight()/t.height;if(Math.abs(i.x-e.x)>=r||Math.abs(i.y-e.y)>=n)return t.centerAt(e);var s=new dojo.Deferred;return s.resolve(),s},t)},e.prototype.setScaleWithPriority=function(e,t){this.changeExtentWithPriority(function(t){if(e!==t.getScale())return t.setScale(e);var i=new dojo.Deferred;return i.resolve(),i},t)},e.prototype.blockForResize=function(e,i,r){e==this._map.width&&i==this._map.height||(this._isResizeBlocked()?this._queuedExtentChange[t.RESIZE]=function(e){e.position.update(0,0),e.resize(r)}:(this._map.position.update(0,0),this._map.resize(r)))},e.prototype.blockForReposition=function(){this._isRepositionBlocked()?this._queuedExtentChange[t.REPOSITION]=function(e){e.position.update(0,0),e.resize()}:(this._map.position.update(0,0),this._map.resize())},e.prototype._isExtentChangeBlocked=function(){return null!=this._queuedExtentChange[t.REPOSITION]||null!=this._queuedExtentChange[t.RESIZE]||!this._hasLoaded()},e.prototype._isRepositionBlocked=function(){return this._extentChangeInProgress||!this._hasLoaded()},e.prototype._isResizeBlocked=function(){return this._isRepositionBlocked()},e.prototype._hasLoaded=function(){return this._map&&this._map.loaded&&this._firstMapResizeExecuted},e}();e.ExtentManager=i}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){var i=function(i){function r(r){i.call(this,r),this.baseMaps=[],this.fullExtent=null,this.initialExtent=null,this.fitTiledMapsToExtent=!1,this.mapServices=[],this.mapServicesFilteredView=[],this.layerThemesInfo=null,this.primaryMapService=null,this.supportedExportFormats=["BMP","JPEG","PNG","TIFF","GeoTIFF","PDF"],this.exportMapImageOptions=null,this.units=null,this.serviceLayersAdded=!1,this.extentManager=null,this.spatialReference=null,this.setExtentOnLoad=!0,this._esriMap=null,this._onExportComplete=null,this._onExportError=null,this.originalUrl=r,this.url=t.utilities.UrlUtilities.simplify(r),this.layerThemesInfo=new e.essentials.LayerThemesInfo(this)}return __extends(r,i),r.prototype.getMap=function(){return this._esriMap},r.prototype.allLayers=function(){for(var e=[],t=0;t<this.mapServices.length;t++)for(var i=this.mapServices[t],r=0;r<i.layers.length;r++)e.push(i.layers[r]);return e},r.prototype.allTables=function(){for(var e=[],t=0;t<this.mapServices.length;t++)for(var i=this.mapServices[t],r=0;r<i.tables.length;r++)e.push(i.tables[r]);return e},r.prototype.allLayersAndTables=function(){var e=[];return e=this.allLayers(),e=this.allTables().reduce(function(e,t){return e.push(t),e},e)},r.prototype.filteredLayers=function(){for(var e=[],t=0;t<this.mapServices.length;t++){var i=this.mapServices[t];this._layerThemeMapServiceFilter(i)&&(e=e.concat(i.layers))}return e},r.prototype.loadServiceLayersInMap=function(e){if(!e)throw new Error("Must supply a map");this._esriMap=e,this.fitTiledMapsToExtent=!!e._fitTiledMapsToExtent,this.extentManager=new t.ExtentManager(e,this.fitTiledMapsToExtent);for(var i=0;i<this.mapServices.length;i++){var r=this.mapServices[i],n=r.serviceLayer;n&&(this.extentManager.registerLayer(n),n.loaded||r.failureTimeoutThresholdExceeded?(this._layerLoadedUpdate(e),r._handleServiceLayerLoaded(n),r._handleDynamicLayers(n)):(dojo.connect(r,"onFailureTimeoutThresholdExceeded",dojo.hitch(this,this._layerLoadedUpdate,e)),dojo.connect(n,"onLoad",dojo.hitch(this,this._layerLoadedUpdate,e)),dojo.connect(n,"onError",dojo.hitch(this,this._layerLoadedUpdate,e))))}},r.prototype.calculateScale=function(){return esri.geometry.getScale(this.site.getMap())},r.prototype._addServiceLayers=function(e){for(var t=this.mapServices.length-1;t>=0;t--)e.addLayer(this.mapServices[t].serviceLayer);this.setExtentOnLoad&&this.initialExtent&&this.extentManager.setInitialExtent(this.initialExtent),null!==this.site&&dojo.isObject(this.site)&&(this.site.serviceLayersLoaded=!0,dojo.isFunction(this.site.onServiceLayersLoaded)&&this.site.onServiceLayersLoaded(this.site))},r.prototype.addServiceLayers=function(i,r){var n=this,s=this;if(i||i.length){for(var a=[],o=function(t){var i=null,n=!1,o=e.essentials.MapServiceType.FEATURE;switch(t.opacity=t.opacity||1,t.type){case"Feature Layer":i=new e.essentials.FeatureLayerService(t.url);break;default:switch(t.declaredClass){case"esri.layers.WebTiledLayer":i=new e.essentials.MapService(t.tileServers[0]),o=e.essentials.MapServiceType.WEBTILED,n=!0}}if(i){i.serviceLayer=t,i.essentialsMap=s;var l=t.layerId||e.framework.utils.alphaNumericToken(),c={id:l,isExpanded:!0,includeInLayerList:n,serviceFunction:r,serviceType:o,layerOptions:null};c.layerOptions={id:l,name:t.name,description:t.description,displayField:t.displayField,includeInLayerList:!0,identifiable:!0,fullExtent:t.fullExtent,primaryKeyField:t.objectIdField,visible:t.visible},i._createFrom(c),a.push(i),dojo.connect(t,"onClick",function(e){dojo.publish("FeatureClickedEvent",dojo.mixin(e,{layer:i.layers[0],useFeaturePresenter:!0}))})}},l=0;l<i.length;++l){var c=i[l];if(c instanceof t.GeoRssLayerService)a.push(c);else{if(c.getFeatureLayers){var u=c,h=u.getFeatureLayers();if(h&&h.length>0){dojo.forEach(h,function(e){e.name=e.name||u.name,o(e)});continue}}o(c)}}this.mapServices=this.mapServices.concat(a),dojo.forEach(a,function(e){return n._addToFilteredView(e)}),this._addServiceLayers(this.getMap()),dojo.forEach(a,function(e){dojo.publish("MapServiceAddedEvent",e)})}},r.prototype.removeServiceLayer=function(e){if(e&&this.mapServices.length)for(var t=0;t<this.mapServices.length;t++){var i=this.mapServices[t];if(i&&i.serviceLayer&&i.serviceLayer===e){this.mapServices.splice(t,1),dojo.publish("MapServiceRemovedEvent",i);break}}},r.prototype.addMapService=function(e){var i=this.getMap(),r=this.site;e.isUserCreated=!0,e.includeInLayerList=!(e instanceof t.FeatureLayerService),e.opacity=1;for(var n=0,s=e.layers;n<s.length;n++){var a=s[n];a.isUserCreated=!0,a.includeInLayerList=!0,a.includeInLegend=!0,a.site=r,a.configuredVisible=!0,e.supportsLayerVisibility()?a.setVisibility(!0):a._visible=!0}e.essentialsMap=this,this.mapServices.push(e),i.addLayer(e.serviceLayer),dojo.publish("MapServiceAddedEvent",e),e.setVisibility(!0)},r.prototype.removeMapService=function(e){if(e){var t=this.mapServices.indexOf(e);t>=0&&(this.mapServices.splice(t,1),dojo.publish("MapServiceRemovedEvent",e)),this._esriMap&&e.serviceLayer&&this._esriMap.removeLayer(e.serviceLayer)}},r.prototype._configureMapServices=function(t,i){for(var r=0;t&&r<t.length;r++){var n=t[r],s=this.originalUrl+"/mapservices/"+n.id;if(n.drawingBehavior==e.essentials.DrawingBehavior.FEATURE_LAYER){if(!dojo.isObject(esri.layers.FeatureLayer))throw new Error("This Javascript application must // dojo.require the esri.layers.FeatureLayer package in order to use a site with feature layers");this.mapServices[r]=new e.essentials.FeatureLayerService(s)}else if(n.drawingBehavior==e.essentials.DrawingBehavior.GEORSS_LAYER){if(!dojo.isObject(esri.layers.GraphicsLayer))throw new Error("This Javascript application must // dojo.require the esri.layers.GraphicsLayer package in order to use a site with GeoRSS layers");this.mapServices[r]=new e.essentials.GeoRssLayerService(s)}else if(n.drawingBehavior==e.essentials.DrawingBehavior.KML_SERVICE){if(!dojo.isObject(esri.layers.KMLLayer))throw new Error("This Javascript application must // dojo.require the esri.layers.KMLLayer package in order to use a site with KML layers");this.mapServices[r]=new e.essentials.KmlService(s)}else this.mapServices[r]=new e.essentials.MapService(s);this.mapServices[r].essentialsMap=this,this.mapServices[r].initialize(n),dojo.publish("ServiceLayerInitializedEvent",this.mapServices[r].serviceLayer),this._addToFilteredView(this.mapServices[r])}},r.prototype._configureObject=function(t,i){if(void 0===t||void 0===t.mapServices)throw new Error("Incorrect map object returned from initialization");t.initialExtent&&(this.initialExtent=new esri.geometry.Extent(t.initialExtent)),t.fullExtent&&(this.fullExtent=new esri.geometry.Extent(t.fullExtent)),t.units&&(this.units=new e.essentials.DistanceUnit(t.units.name,t.units.type)),t.exportOptions&&(this.exportMapImageOptions=new e.essentials.ExportMapImageOptions(t.exportOptions.allowIncludeGeoreferenceData,t.exportOptions.defaultOutputFormat)),t.layerThemes&&(t.layerThemes.items&&t.layerThemes.items.length||t.layerThemes.allowDefault)&&this._configureLayerThemesInfo(t.layerThemes),this._configureMapServices(t.mapServices,i),dojo.isArray(t.baseMaps)&&this._configureBaseMaps(t.baseMaps),i&&(this.isInitialized=!0),this.primaryMapService=this.findMapServiceById(t.primaryMapServiceID)},r.prototype.findMapServiceById=function(e){for(var t=0;t<this.mapServices.length;t++)if(this.mapServices[t].id==e)return this.mapServices[t];return null},r.prototype.setFeatureLayerExclusivelyVisible=function(e){for(var t=this.site.getFeatureServices(),i=0;i<t.length;i++){var r=t[i];r.setVisibility(r.serviceLayer.id===e.id)}},r.prototype.exportMap=function(t,i,r){var n=this;this._onExportComplete=i,this._onExportError=r;var s=new e.essentials.exportMap.ExportMapTask(this),a=new e.essentials.exportMap.ExportMapParameters;a.reportParameters=t,s.generateMapImageUrl(a).then(function(e){return n._exportRestComplete(e)},function(e){return n._exportRestError(e)})},r.prototype.findLayerFromMatchingEsriFeatureLayer=function(e){if(e){for(n=0;n<this.mapServices.length;n++)if((c=this.mapServices[n]).serviceLayer instanceof esri.layers.FeatureLayer){var t=c.serviceLayer;if(t.layerId==e.layerId&&t.name==e.name&&c.layers.length>0)return c.layers[0]}for(var i=function(e,t){var i=e.serviceUrl;return e.serviceToken&&t.search(/token=.[^&]*/g)>0&&(i+="?token="+e.serviceToken),i},r=e.url.match(/.[^?]*/g)[0],n=0;n<this.mapServices.length;n++)if((u=i(c=this.mapServices[n],r))===r&&c.layers.length>0)return c.layers[0];for(var s=new RegExp("[^/]*.$"),a=Number(r.match(s)),o=new RegExp("/[^/]*.$"),l=r.replace(o,""),n=0;n<this.mapServices.length;n++){var c=this.mapServices[n],u=i(c,l);if(u===l){var h=c.findLayerOrTableById(a.toString());if(h)return h;if(c.layers.length>=a)return c.layers[a]}}return null}},r.prototype._exportRestComplete=function(e){var t=null;e?e.error&&(t=e.error):t=new Error("No results"),t&&this._onExportComplete&&this._onExportError(t),e&&this._onExportComplete&&this._onExportComplete(e)},r.prototype._exportRestError=function(e){this._onExportError&&this._onExportError(e)},r.prototype._layerLoadedUpdate=function(e){if(!this.serviceLayersAdded){for(var t=0;t<this.mapServices.length;t++){var i=this.mapServices[t],r=i.serviceLayer;if(!i.initializationFailure&&i.failureTimeoutThresholdExceeded&&(i.initializationFailure=new Error("Map Service - {0}: Failure timeout threshold exceeded.".format(i.id))),!r.loaded&&!i.initializationFailure&&!i.failureTimeoutThresholdExceeded)return}this.serviceLayersAdded=!0,this.spatialReference=this.primaryMapService.serviceLayer.spatialReference,this.spatialReference&&this.spatialReference.wkt&&this._switchSpatialReferenceGlobally(this.spatialReference),this._esriMap.spatialReference||(this._esriMap.spatialReference=this.spatialReference||this.initialExtent.spatialReference||this.fullExtent.spatialReference),!this._esriMap.extent&&this.initialExtent&&this._esriMap.setExtent(new esri.geometry.Extent(this.initialExtent.toJson())),this._addServiceLayers(e)}},r.prototype.applyCatalogLayersChange=function(e){e&&(this._applyCatalogChangesToDynamicLayers(e),this._applyCatalogChangesToWmsLayers(e))},r.prototype.applyStartupTheme=function(){this.layerThemesInfo.layerThemesConfigured&&this.layerThemesInfo.applyTheme(this.layerThemesInfo.startupThemeId||this.layerThemesInfo.themes[0].id)},r.prototype.refreshFilteredCollections=function(){var e=this;this.mapServicesFilteredView.length=0,dojo.forEach(this.mapServices,function(t){return e._addToFilteredView(t)});for(var t=0;t<this.mapServices.length;t++)this.mapServices[t].refreshFilteredCollections()},r.prototype._switchSpatialReferenceGlobally=function(e){if(this.initialExtent&&(this.initialExtent=new esri.geometry.Extent(this.initialExtent.xmin,this.initialExtent.ymin,this.initialExtent.xmax,this.initialExtent.ymax,e)),this.fullExtent&&(this.fullExtent=new esri.geometry.Extent(this.fullExtent.xmin,this.fullExtent.ymin,this.fullExtent.xmax,this.fullExtent.ymax,e)),this.site.hasNamedExtents&&this.site.namedExtents&&this.site.namedExtents.length)for(var t=0;t<this.site.namedExtents.length;t++){var i=this.site.namedExtents[t];i.extent=new esri.geometry.Extent(i.extent.xmin,i.extent.ymin,i.extent.xmax,i.extent.ymax,e)}this._esriMap.spatialReference=e},r.prototype._applyCatalogChangesToWmsLayers=function(e){},r.prototype._applyCatalogChangesToDynamicLayers=function(t){var i=t.mapServiceId,r=[],n=new e.essentials.catalog.LayerCatalogDetail;n.mapServiceId=i;for(var s=0;s<t.entries.length;s++)t.entries[s].isDynamic&&r.push(t.entries[s]);n.entries=r;var a=this.findMapServiceById(i);a&&a.applyCatalogLayersChange(n)},r.prototype._configureLayerThemesInfo=function(e){var i=this;if(!e)throw new Error("RestLayerThemesInfo object not defined. Cannot configure layer themes.");this.layerThemesInfo.layerThemesConfigured=!0,this.layerThemesInfo.allowDefault=void 0==e.allowDefault||e.allowDefault,this.layerThemesInfo.startupThemeId=e.startupThemeID,this.layerThemesInfo.allowDefault&&this.layerThemesInfo.themes.push(new t.LayerTheme(this.layerThemesInfo,null,e.defaultThemeDisplayName||"")),e.items&&e.items.length&&dojo.forEach(e.items,function(e){i.layerThemesInfo.themes.push(new t.LayerTheme(i.layerThemesInfo,e))})},r.prototype._addToFilteredView=function(e){e&&this._layerThemeMapServiceFilter(e)&&this.mapServicesFilteredView.push(e)},r.prototype._layerThemeMapServiceFilter=function(e){return!e.essentialsMap.layerThemesInfo.layerThemesConfigured||e.inActiveTheme},r.prototype._configureBaseMaps=function(i){var r=this;i.forEach(function(i){var n=new t.BaseMap(r);n.displayName=i.displayName,n.id=i.id,i.iconUri&&(n.iconUri=e.essentials.RestHelper.processClientSideTokens(r.site,i.iconUri)),i.exportTilesMapServiceUri&&(n.exportTilesMapServiceUri=e.essentials.RestHelper.processClientSideTokens(r.site,i.exportTilesMapServiceUri)),n.properties=e._getProperties(i.properties),n.extensions=e._getExtensions(i.extensions),dojo.isArray(i.mapServices)&&i.mapServices.forEach(function(e){var i=r.findMapServiceById(e.id);i&&n.services.push(new t.BaseMapService(i))}),r.baseMaps.push(n)})},r}(t.AsyncInitializable);t.Map=i}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){var t=function(){return function(e,t){this.displayName=e,this.scale=t}}();e.Scale=t}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){var t=function(){return function(e,t){void 0!==e&&(this.displayName=e),void 0!==t&&(this.dpi=t)}}();e.Resolution=t}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){var t=function(){return function(e,t,i,r){this.id=e,this.displayName=t,this.value=i,this.multiline=r}}();e.TextField=t}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){var i=function(){function t(){this.customExtent=null,this.extentType="currentExtent",this.fields=[],this.grid=null,this.imageHeight=null,this.imageWidth=null,this.notificationEmailAddress=null,this.outputFormat=null,this.featureIds=null,this.resolution=null,this.scale=null}return t.prototype.toJson=function(t,i){if(!t||!i)throw new Error("Reporting parameter creation is missing a main map.");var r,n,s={},a=this.scale&&void 0!=this.scale.scale&&!isNaN(parseFloat(this.scale.scale))?parseFloat(this.scale.scale):t.getScale();this.scale&&void 0!=this.scale.scale&&(s.scale=this.scale.scale);var o;this.extentType==e.essentials.ReportParameters.CURRENT_EXTENT&&null!==t?r=t.extent:this.extentType==e.essentials.ReportParameters.FULL_EXTENT&&null!==i?r=i.fullExtent:this.extentType==e.essentials.ReportParameters.INITIAL_EXTENT&&null!==i?r=i.initialExtent:this.extentType==e.essentials.ReportParameters.CUSTOM_EXTENT&&null!==this.customExtent&&(r=this.customExtent),r&&(r.spatialReference&&(n=r.spatialReference.toJson())&&(n.wkid&&n.wkid>0?s.bboxSR=n.wkid:n.wkt&&(s.bboxSR=n.wkt)),s.bbox=r.xmin+","+r.ymin+","+r.xmax+","+r.ymax),this.targetSpatialReference&&(n=this.targetSpatialReference.toJson())&&(n.wkid&&n.wkid>0?s.targetSR=n.wkid:n.wkt&&(s.targetSR=n.wkt)),this.notificationEmailAddress&&(s.emailAddress=this.notificationEmailAddress),this.imageHeight&&this.imageHeight>0&&(s.imageHeight=this.imageHeight),this.imageWidth&&this.imageWidth>0&&(s.imageWidth=this.imageWidth),t.timeExtent&&(s.time="",t.timeExtent.startTime?s.time+=t.timeExtent.startTime.getTime():s.time+="null",s.time+=",",t.timeExtent.endTime?s.time+=t.timeExtent.endTime.getTime():s.time+="null");var l=[];if(null!==i){var c="",u="",h="";for(o=0;o<i.mapServices.length;o++){var p,d=i.mapServices[o],f="",y=d.serviceLayer,m="";if(y)if(!0===y.visible&&(u+=(""===u?"":";")+d.id+":"+y.opacity),d.mapServiceType===e.essentials.MapServiceType.DYNAMIC){p=y.layerDefinitions;var g=0;for(var v in p)g>0&&(m+=","),m+='"'+v+'":"'+p[v].replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"',g++;if(g>0&&(h.length>1&&(h+=","),h+='"'+d.id+'":{',h+=m,h+="}"),!0===y.visible&&!0===y.isVisibleAtScale(a))if(y instanceof esri.layers.ArcGISDynamicMapServiceLayer){var w=y;w.visibleLayers&&"-1"!==w.visibleLayers.toString()&&(f=w.visibleLayers.toString())}else if(d.layers&&0!==d.layers.length){if(d.layers&&d.layers.length>0)for(b=0;b<d.layers.length;b++)(S=d.layers[b]).isVisible()&&S.areAllAncestorsVisible()&&(f+=(0===f.length?"":",")+S.id)}else f="*"}else if(!0===y.visible&&!0===y.isVisibleAtScale(a))if(d.layers&&0!==d.layers.length){if(d.layers&&d.layers.length>0)for(var b=0;b<d.layers.length;b++){var S=d.layers[b];S.isVisible()&&S.areAllAncestorsVisible()&&(f+=(0===f.length?"":",")+S.id)}}else f="*";var x=d.id;if(0===f.length?x+="(hide:*)":x+="(show:"+f+")",c+=(0===c.length?"":";")+x,d instanceof e.essentials.FeatureLayerService){var I={};I.id=d.id;var _=y.getSelectionSymbol();if(_&&_.color){var E=_.color.toRgba();I.selectionColor={r:E[0],g:E[1],b:E[2],a:E[3]}}I.mode=d.queryMode;var T=y.getDefinitionExpression();T&&(I.where=T),y.renderer&&(I.renderer=y.renderer.toJson()),I.selectedFeatures=[];var L=y.getSelectedFeatures();if(L&&L.length>0){var D=y.objectIdField;if(D)for(var C=0;C<L.length;C++){var k=L[C];if(k.attributes){var R=k.attributes[D];R&&I.selectedFeatures.push(R)}}}l.push(I)}}h.length>0&&(h="{"+h+"}",s.layerDefinitions=h),c.length>0&&(s.layers=c),u.length>0&&(s.opacity=u)}l.length>0&&(s.featureLayerOptions=l),this.outputFormat&&(s.outputFormat=this.outputFormat),this.featureIds&&(s.featureIds=this.featureIds),this.resolution&&(s.dpi=this.resolution.dpi),this.mapGraphicsLayers&&(s.graphics=this.mapGraphicsLayers.layers,s.symbols=this.mapGraphicsLayers.symbols),this.includeData&&(s.of=s.of?s.of+",includeData":"includeData"),this.includeGeoreferenceData&&(s.georef=this.includeGeoreferenceData),this.useTransparentBackground&&(s.useTransparentBackground=this.useTransparentBackground);for(var F=0;F<this.fields.length;F++){var A=this.fields[F];s[A.id]=A.value}return this.grid&&(s.grid=this.grid.id),s},t.prototype.populateMapGraphicsLayers=function(e){this.mapGraphicsLayers={layers:[],symbols:[]},this._extractGraphicInformation(e.graphics,this.mapGraphicsLayers.layers,this.mapGraphicsLayers.symbols);for(var t=0;t<e.graphicsLayerIds.length;t++){var i=e.getLayer(e.graphicsLayerIds[t]);!i.visible||i instanceof esri.layers.FeatureLayer&&i.url||this._extractGraphicInformation(i,this.mapGraphicsLayers.layers,this.mapGraphicsLayers.symbols)}},t.prototype._extractGraphicInformation=function(t,i,r){for(var n=0;n<t.graphics.length;n++){var s=t.graphics[n];if(s.visible){var a={},o=null;if(s.symbol?o=s.symbol:t.renderer&&t.renderer.getSymbol&&(o=t.renderer.getSymbol(s),s.symbol=o),!o)continue;r.push(o);for(var l=0;l<r.length-1;l++)if(r[l]==o){a.symbolID=r[l].id,o.id=a.symbolID,r.pop();break}if(void 0==a.symbolID){var c=r.length-1;r[c]instanceof esri.symbol.TextSymbol?r[c]=e.essentials.utilities.PrintUtilities.adjustTextSymbol(s,t.id):r[c]instanceof esri.symbol.PictureMarkerSymbol&&(r[c]=e.essentials.utilities.PrintUtilities.adjustPictureMarkerSymbol(s)),a.symbolID=(r.length-1).toString(),r[a.symbolID].id=a.symbolID}a.geometry=s.geometry,i.push({elements:[a],opacity:t.opacity})}}},t.CURRENT_EXTENT="currentExtent",t.CUSTOM_EXTENT="customExtent",t.FULL_EXTENT="fullExtent",t.INITIAL_EXTENT="initialExtent",t}();t.ReportParameters=i}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){var i=function(t){function i(i){t.call(this,i),this.description=null,this.displayName=null,this.extensions=[],this.id=null,this.visible=null,this.maximumResolution=300,this.properties=null,this.site=null,this.supportedMapScales=[],this.supportedOutputFormats=[],this.supportedResolutions=[],this.supportsEmailNotification=!1,this.textFields=[],this.grids=[],this.type=e.essentials.ReportType.MAP_TEMPLATE_REPORT,this.isDefault=!1,this.defaultMapScale=null,this.defaultMapScaleName=null,this.defaultResolution=null,this.defaultGrid=null,this.defaultOutputFormat=null,this._printing=!1,this._onPrintComplete=null,this._onPrintError=null,this.extensions=[],this.properties=[],this.supportedMapScales=[],this.supportedOutputFormats=[],this.supportedResolutions=[],this.textFields=[]}return __extends(i,t),i.prototype.isPrinting=function(){return this._printing},i.prototype.print=function(t,i,r){var n=this;if(this.isPrinting())r&&r(new Error("Template already printing"));else{this._onPrintComplete=i,this._onPrintError=r,this._printing=!0;var s=new e.essentials.exportMap.ExportMapParameters;s.reportParameters=t,new e.essentials.exportMap.ExportMapTask(this).generateMapImageUrl(s).then(function(e){return n._printRestComplete(e)},function(e){return n._printRestError(e)})}},i.prototype._configureObject=function(t,i){if(void 0===t||void 0===t.id||void 0===t.displayName)throw new Error("Incorrect print template object returned from initialization");if(this.description=void 0===t.description?this.description:t.description,this.displayName=t.displayName,this.id=t.id,this.visible=void 0===t.visible||t.visible,this.mainMapWidth=t.mainMapWidth,this.mainMapHeight=t.mainMapHeight,this.maximumResolution=void 0===t.maximumResolution?this.maximumResolution:t.maximumResolution,this.supportedMapScales=void 0===t.supportedScales?this.supportedMapScales:t.supportedScales,this.supportedOutputFormats=void 0===t.supportedOutputFormats?this.supportedOutputFormats:t.supportedOutputFormats,this.supportedResolutions=void 0===t.supportedResolutions?this.supportedResolutions:t.supportedResolutions,this.supportsEmailNotification=!!t.supportsEmailNotification,this.textFields=void 0===t.textFields?this.textFields:t.textFields,this.grids=void 0===t.grids?this.grids:t.grids,i&&(this.isInitialized=!0),this.properties=e._getProperties(t.properties),this.extensions=e._getExtensions(t.extensions),this.isDefault=void 0===t.isDefault?this.isDefault:t.isDefault,this.defaultMapScaleName=void 0===t.defaultMapScale?null:t.defaultMapScale,this.defaultMapScaleName)for(s=0;s<this.supportedMapScales.length;s++)this.defaultMapScaleName===this.supportedMapScales[s].displayName&&(this.defaultMapScale=this.supportedMapScales[s]);var r=void 0===t.defaultResolution?null:t.defaultResolution;if(r)for(s=0;s<this.supportedResolutions.length;s++)r===this.supportedResolutions[s].displayName&&(this.defaultResolution=this.supportedResolutions[s]);var n=void 0===t.defaultGrid?null:t.defaultGrid;if(n)for(var s=0;s<this.grids.length;s++)n===this.grids[s].displayName&&(this.defaultGrid=this.grids[s]);this.defaultOutputFormat=void 0===t.defaultOutputFormat?this.defaultOutputFormat:t.defaultOutputFormat},i.prototype._printRestComplete=function(e){this._printing=!1;var t=null;e?e.error&&(t=e.error):t=new Error("Unexpected Error"),t?this._onPrintError&&this._onPrintError(t):this._onPrintComplete&&this._onPrintComplete(e)},i.prototype._printRestError=function(e){this._printing=!1,this._onPrintError&&this._onPrintError(e)},i}(t.AsyncInitializable);t.PrintTemplate=i}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){var i=function(t){function i(e){t.call(this,e),this.displayName=null,this.extensions=[],this.extent=null,this.id=null,this.properties={},this.site=null}return __extends(i,t),i.prototype.navigateTo=function(){if(this.site){var e=this.site.essentialsMap;e&&e.extentManager.setExtentWithPriority(this.extent,10)}},i.prototype._configureObject=function(t,i){if(void 0===t||void 0===t.id||void 0==t.displayName||void 0===t.extent)throw new Error("Incorrect named extent object returned from initialization");this.id=t.id,this.displayName=t.displayName,this.extent=new esri.geometry.Extent(t.extent),this.properties=e._getProperties(t.properties),this.extensions=e._getExtensions(t.extensions)},i}(t.AsyncInitializable);t.NamedExtent=i}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){var i=function(t){function i(e){t.call(this,e),this.displayName=null,this.extensions=[],this.id=null,this.properties={},this.geoprocessorType=null,this.geoprocessorUrl=null,this.site=null}return __extends(i,t),i.prototype._configureObject=function(t){if(void 0===t.id||void 0===t.displayName||void 0===t.connectionString)throw new Error("Incorrect geoprocessing endpoint object returned from initialization");this.id=t.id,this.displayName=t.displayName,this.geoprocessorType=t.geoprocessorType||t.serviceType,this._processConnectionString(t.connectionString),this.properties=e._getProperties(t.properties),this.extensions=e._getExtensions(t.extensions)},i.prototype._processConnectionString=function(t){var i=e.essentials.ServiceHelper.extractConnectionStringValue;if(this.geoprocessorType!==e.essentials.GeoprocessingEndpointType.ARCGIS_GEOPROCESSOR)throw new Error("Unknown geoprocessor type '"+this.geoprocessorType+"'");var r=i(t,"url");r&&r.length>0&&(this.geoprocessorUrl=r)},i}(t.AsyncInitializable);t.GeoprocessingEndpoint=i}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){!function(e){e.ARCGIS_GEOPROCESSOR="ArcGisGeoprocessor"}(e.GeoprocessingEndpointType||(e.GeoprocessingEndpointType={}))}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){var i=function(t){function i(e){t.call(this,e),this.displayName=null,this.extensions=[],this.id=null,this.properties={},this.geometryServiceType=null,this.geometryServiceUrl=null,this.geometryServiceToken=null,this.site=null}return __extends(i,t),i.prototype._configureObject=function(t){if(void 0===t.id||void 0===t.displayName||void 0===t.connectionString)throw new Error("Incorrect geometry endpoint object returned from initialization");this.id=t.id,this.displayName=t.displayName,this.geometryServiceType=t.serviceType,this._processConnectionString(t.connectionString),this.properties=e._getProperties(t.properties),this.extensions=e._getExtensions(t.extensions)},i.prototype._processConnectionString=function(t){var i=e.essentials.ServiceHelper.extractConnectionStringValue;if(this.geometryServiceType===e.essentials.GeometryEndpointType.ARCGIS_GEOMETRY){var r=i(t,"url");r&&r.length>0&&(this.geometryServiceUrl=r),this.geometryServiceToken=i(t,"token")}else console.error("Unknown geometry service type '"+this.geometryServiceType+"'")},i}(t.AsyncInitializable);t.GeometryEndpoint=i}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){!function(e){e.ARCGIS_GEOMETRY="ArcGisGeometry"}(e.GeometryEndpointType||(e.GeometryEndpointType={}))}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){var t=function(){function e(){}return e.extractConnectionStringValue=function(e,t){if(e.length>0){var i=e.match("(^|;)[s]*"+t+"=([^;]*)");return null!==i?i[2]:""}return""},e}();e.ServiceHelper=t}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){var i=function(t){function i(e){t.call(this,e),this.bingProperties=null,this.displayName=null,this.extensions=[],this.id=null,this.properties={},this.geocoderType=null,this.geocoderUrl=null,this.geocoderToken=null,this.includeInGlobalSearch=!1,this.iconUri=null,this.isDefaultReverseGeocoder=!1,this.site=null,this.parameters=[],this.globalSearchKey=null,this.isDefaultBatchGeocoder=!1}return __extends(i,t),i.prototype._configureObject=function(t){if(!(t.hasOwnProperty("id")&&t.hasOwnProperty("displayName")&&t.hasOwnProperty("serviceType")&&t.hasOwnProperty("connectionString")&&t.hasOwnProperty("globalSearchKey")&&t.hasOwnProperty("parameters")))throw new Error("Incorrect geocoding endpoint object returned from initialization");this.id=t.id,this.displayName=t.displayName,this.iconUri=t.iconUri,this.geocoderType=t.serviceType,this.includeInGlobalSearch=t.includeInGlobalSearch,this.isDefaultReverseGeocoder=t.isDefaultReverseGeocoder,this.globalSearchKey=t.globalSearchKey,this.isDefaultBatchGeocoder=t.isDefaultBatchGeocoder,this._processConnectionString(t.connectionString),this.properties=e._getProperties(t.properties),this.extensions=e._getExtensions(t.extensions),this.parameters=t.parameters},i.prototype._processConnectionString=function(t){var i=e.essentials.ServiceHelper.extractConnectionStringValue;if(this.geocoderType===e.essentials.GeocodingEndpointType.BING_GEOCODER){this.bingProperties={};var r=i(t,"key");r&&r.length>0&&(this.bingProperties.bingMapsKey=r),(r=i(t,"culture"))&&r.length>0&&(this.bingProperties.culture=r)}else if(this.geocoderType===e.essentials.GeocodingEndpointType.ARCGIS_GEOCODER){var n=i(t,"url");n&&n.length>0&&(this.geocoderUrl=n),this.geocoderToken=i(t,"token")}else console.error("Unknown geocoder type '"+this.geocoderType+"'")},i}(t.AsyncInitializable);t.GeocodingEndpoint=i}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){!function(e){e.ARCGIS_GEOCODER="ArcGisGeocoder",e.BING_GEOCODER="BingGeocoder"}(e.GeocodingEndpointType||(e.GeocodingEndpointType={}))}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){!function(e){var t=function(){function t(){}return t.equals=function(t,i){return!(!t||!i||t!==i&&!e.StringUtilities.endsWith(t,this.separator+i))},t.lookUp=function(t,i){if(t&&i){var r=0,n=null;for(r=0;r<t.length;++r)if((n=t[r]).id===i)return n;for(r=0;r<t.length;++r)if(n=t[r],e.StringUtilities.endsWith(n.id,this.separator+i))return n}return null},t.separator="-",t}();e.SiteResourceIdComparer=t}(e.utilities||(e.utilities={}))}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){var t=function(){function e(){this.finished=!1,this.id=(new Date).valueOf().toString(),this.scripts=[]}return e.getCurrent=function(){var e=window.security;return e&&!e.finished?e:null},e.beginRefresh=function(t){if(null!=e.getCurrent())return!1;var i=new e;return i.site=t,!!i.getExpirationNoticeUrl()&&(!!i.getRefreshUrl()&&(window.security=i,i.openFrame(),!0))},e.cancel=function(){var t=e.getCurrent();return t&&t.finish()},e.prototype.openSystemBrowser=function(){var e=this,t=this.getRefreshUrl()+"&app="+this.site.signInRedirectUri+"&token_type=fragment",i=/GeocortexApp\.iOS/.test(navigator.userAgent)?"_system":"_blank",r=function(){var t=location.hash;if(t.length>0&&t.startsWith("#gcx-")){window.removeEventListener?window.removeEventListener("popstate",r,!1):window.detachEvent&&window.detachEvent("onpopstate",r);var i=t.substring(5);e.sendRequest(e.site.url+"?f=json&callback=security.updateSitePrincipal&token="+i)}};window.addEventListener?window.addEventListener("popstate",r,!1):window.attachEvent&&window.attachEvent("onpopstate",r),window.open(t,i)},e.prototype.openFrame=function(){var e=this;this.frame=document.createElement("iframe"),this.frame.name="SignInHelper",this.frame.style.display="none",document.body.appendChild(this.frame),/\bGeocortexApp\b/.test(navigator.userAgent)?this.frame.src="SignInHelper.html":(window.open("SignInHelper.html","SignInHelper"),window.setTimeout(function(){return e.openPopup()},15e3))},e.prototype.openPopup=function(){this.finished||(this.sendRequest(this.getExpirationNoticeUrl()+"?f=json&part=_html&callback=security.showContent"),window.open("SignInHelper.html","_blank"))},e.prototype.getExpirationNoticeUrl=function(){return this.site.principal&&this.site.principal.urls?this.site.principal.urls.expirationNotice:null},e.prototype.getRefreshUrl=function(){return this.site.principal&&this.site.principal.urls?this.site.principal.urls.refresh:null},e.prototype.sendRequest=function(e){if(!this.finished){var t=document.createElement("script");t.style.display="none",document.body.appendChild(t),this.scripts.push(t),t.type="text/javascript",t.src=e+"&rid="+this.id}},e.prototype.showContent=function(e){return!this.finished&&(e.rid==this.id&&(this.dialog&&this.dialog.parentNode&&this.dialog.parentNode.removeChild(this.dialog),this.dialog=document.createElement("div"),this.dialog.innerHTML=e.content,document.body.appendChild(this.dialog),!0))},e.prototype.handleSignIn=function(e,t){if(this.finished)return null;if(!(e.length>0&&e.startsWith("#gcx-"))){var i="";return null==this.site.principal.urls.referrer&&(i="&app="+encodeURIComponent(t)),this.getRefreshUrl()+i+"&token_type=fragment"}var r=e.substring(5);return this.sendRequest(this.site.url+"?f=json&callback=security.updateSitePrincipal&token="+r),null},e.prototype.finish=function(){if(this.finished)return!1;for(this.finished=!0;this.scripts.length>0;){var e=this.scripts.pop();e.parentNode.removeChild(e)}return this.dialog&&this.dialog.parentNode&&this.dialog.parentNode.removeChild(this.dialog),this.frame&&this.frame.parentNode&&this.frame.parentNode.removeChild(this.frame),!0},e.prototype.updateSitePrincipal=function(e){return!this.finished&&(e.rid==this.id&&(this.finish(),this.site.updatePrincipal(e.principal),console.log("Updated Principal (Refresh Successful)"),!0))},e.prototype.useSystemBrowser=function(){return!1},e}();e.SecurityHelper=t}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){var i=function(i){function r(e,r){i.call(this,e),this.currentVersion=null,this.dataProvider=null,this.deepInitialize=!1,this.displayName=null,this.documentStore=new t.documents.DocumentStore,this.updateInterval=null,this.essentialsMap=null,this.extensions=[],this.geocodingEndpoints=[],this.geometryEndpoints=[],this.geoprocessingEndpoints=[],this.layerListRestEndpoint=null,this.hasGeocodingEndpoints=!1,this.hasGeometryEndpoints=!1,this.hasGeoprocessingEndpoints=!1,this.hasNamedExtents=!1,this.hasNorthArrow=!1,this.hasTimeSliders=!1,this.hasOverviewMap=!1,this.hasPrintTemplates=!1,this.hasViewers=!1,this.hasVirtualDirectory=!1,this.hasWorkflows=!1,this.hasSearchTables=!1,this.hasWebMaps=!1,this.id=null,this.namedExtents=[],this.overviewMap=null,this.printTemplates=[],this.properties={},this.timeSliders=[],this.trustedUrls=[],this.layerCatalogs=[],this.serviceLayersLoaded=!1,this.url=null,this.workflows=[],this.searchTables=[],this.timeZoneId=null,this.displayTimeZoneId=null,this.webMapsInfo={layerTypes:null,webMaps:[]},this.configPreprocessor=null,this.onLayerLoad=null,this.onLayerLoadError=null,this.onServiceLayersLoaded=function(){},this.onSignIn=null,this.onSignOut=null,this.onUserSignInCancelled=null,this.principal={isAuthenticated:!1,label:null,identities:[],policy:{},urls:{},tokens:{arcgis:{},geocortex:{},site:null}},this._geocodingEndpointsInitialized=!1,this._geometryEndpointsInitialized=!1,this._geoprocessingEndpointsInitialized=!1,this._kmlServiceInitialized=!1,this._mapInitialized=!1,this._namedExtentsInitialized=!1,this._overviewMapInitialized=!1,this._printTemplatesInitialized=!1,this._workflowsInitialized=!1,this._searchTablesInitialized=!1,this._timeSlidersInitialized=!1,this._webMapsInitialized=!1,this._initializedHandlerCalled=!1,this._signInEnabled=!1,this._signOutEnabled=!1,this._tokenIntervalHandle=null,this._serviceTokenRefresh=null,this._serviceTokensStale=!1,this.originalUrl=e,this.url=t.utilities.UrlUtilities.simplify(e),this._esriMap=r}return __extends(r,i),r.prototype.initialize=function(){var e=this;this._detectAndConfigureCors().then(function(){e._initialize()})},r.prototype.getResourceById=function(t,i){return e.essentials.utilities.SiteResourceIdComparer.lookUp(t,i)},r.prototype.findWorkflowById=function(e){return this.getResourceById(this.workflows,e)},r.prototype.findPrintTemplateById=function(e){return this.getResourceById(this.printTemplates,e)},r.prototype.getFeatureServices=function(){var t=[];if(!this.essentialsMap)return t;for(var i=0;i<this.essentialsMap.mapServices.length;i++){var r=this.essentialsMap.mapServices[i];r instanceof e.essentials.FeatureLayerService&&t.push(r)}return t},r.prototype.getMap=function(){return this._esriMap},r.prototype.getEssentialsVersion=function(){var e=3;if(this.currentVersion){var t=this.currentVersion.split(".");if(t.length>=2){var i=t[0]+"."+t[1];e=parseFloat(i)}}return e},r.prototype.getDefaultBatchGeocoder=function(){var t=e.framework.utils.ArrayUtils.firstOrDefault(this.geocodingEndpoints,function(e){return e.isDefaultBatchGeocoder});return!t&&this.geocodingEndpoints.length>0&&(t=this.geocodingEndpoints[0]),t},r.prototype.search=function(i,r,n,s){var a=this;r&&r(i);try{var o=this.url+"/search",l={};i&&i.toJson&&(l=i.toJson(this.getMap(),this.essentialsMap));var c=e.encodeJson(dojo.mixin({f:"json"},l))}catch(e){return void(s&&s(e))}c.hasOwnProperty("layers")&&c.layers&&e.request({url:o,content:c,load:function(e){var r=new t.SearchResults;r.queryParams=i,e?a._parseSearchResponse(r,e):r.error=new Error("Unexpected Error"),r.error&&s&&s(r.error),n&&n(r)},error:function(e){s&&s(e)},callbackParamName:"CallBack"})},r.prototype._parseSearchResponse=function(e,t){if(!t)throw new Error("_parseSearchResponse: required jsonObject argument was not supplied.");if(t.hasOwnProperty("error")&&t.error&&t.error.message)e.error=new Error(t.error.message);else if(t.hasOwnProperty("ResponseStatus")&&t.ResponseStatus&&t.ResponseStatus.ErrorCode)e.error=new Error(t.ResponseStatus.Message),e.error.name=t.ResponseStatus.ErrorCode;else if(t.hasOwnProperty("features")){var i=this._createFeatureSets(t.features,e.queryParams.returnHighlights);for(var r in i)i.hasOwnProperty(r)&&e.results.push(i[r])}},r.prototype._createFeatureSets=function(e,i){for(var r={},n=0;n<e.length;n++){var s=e[n],a=s.hasOwnProperty("mapServiceId")?s.mapServiceId:null,o=s.hasOwnProperty("layerId")?s.layerId:null,l=this.essentialsMap.findMapServiceById(a),c=l?l.findLayerOrTableById(o):null;if(c){var u=this._createFeature(s,c,i);r.hasOwnProperty(c.url)||(r[c.url]=new t.SearchResultSet({layer:c})),r[c.url].features.push(u)}}return r},r.prototype._createFeature=function(e,i,r){if(!e)throw new Error("_createSearchFeature: required jsonFeature argument was not supplied.");var n=this._jObjectToGraphic(e),s=new t.SearchResultFeature(n,i);return r&&this._assignHighlights(s,e),s},r.prototype._jObjectToGraphic=function(e){if(!e)throw new Error("_jObjectToGraphic: required jobject argument was not supplied.");var t=null;e.hasOwnProperty("geometry")&&e.geometry&&(t=esri.geometry.fromJson(e.geometry))&&t.spatialReference&&!e.geometry.spatialReference&&(t.spatialReference=new esri.SpatialReference(4326));var i={};return e.hasOwnProperty("attributes")&&e.attributes&&(i=JSON.parse(JSON.stringify(e.attributes))),new esri.Graphic(t,null,i,null)},r.prototype._assignHighlights=function(e,t){if(!e)throw new Error("_assignHighlights: required feature argument was not supplied.");if(!t)throw new Error("_assignHighlights: required jobject argument was not supplied.");var i={};t.hasOwnProperty("highlights")&&t.highlights&&(i=JSON.parse(JSON.stringify(t.highlights))),e.highlights=i},r.prototype._initAsyncCollection=function(t,i,r,n){if(t&&r&&n)for(var s=0;t&&s<t.length;s++)r[s]=new n(this.url+"/"+i+"/"+t[s].id),r[s].site=this,r[s]._configureObject(t[s]),!0===this.deepInitialize&&n!==e.essentials.Workflow&&(r[s].isInitialized=!0);this._siteInitializeUpdate()},r.prototype._initAsyncCollectionErrorHandler=function(e,t){e(),this._initializationFailedHandler(t),this._siteInitializeUpdate()},r.prototype._initGeocodingEndpointsHandler=function(t){this._geocodingEndpointsInitialized=!0,t&&this._initAsyncCollection(t.geocodingEndpoints,"geocoding",this.geocodingEndpoints,e.essentials.GeocodingEndpoint)},r.prototype._initGeometryEndpointsHandler=function(t){this._geometryEndpointsInitialized=!0,t&&this._initAsyncCollection(t.geometryEndpoints,"geometry",this.geometryEndpoints,e.essentials.GeometryEndpoint)},r.prototype._initKmlEndpointHandler=function(t){if(this._kmlServiceInitialized=!0,t&&t.connectionString){var i=e.essentials.ServiceHelper.extractConnectionStringValue(t.connectionString,"url");i&&(esri.config.defaults.kmlService=i)}},r.prototype.getLayerCatalog=function(t,i,r,n){var s=this.url+"/catalog/layercatalog/getcatalog";i();e.request({url:s,content:{f:"json"},load:function(e){r(e)},error:n,callbackParamName:"CallBack"})},r.prototype.getLayerCatalogDetails=function(t,i,r,n){var s=this.url+"/catalog/layercatalog/getcatalogdetails",a={};a.ids=t.ids.join(),a.f="json",i();e.request({url:s,content:a,load:function(e){r(e)},error:n,callbackParamName:"CallBack"})},r.prototype.getOfflineBasemaps=function(t,i){void 0===i&&(i=function(){});var r=this.url+"/offlinebasemaps";if("function"!=typeof t)throw new Error("loadComplete must be a function.");e.request({url:r,content:{f:"json"},load:function(e){e.error?i(new Error(e.error.message)):e.basemaps?t(e.basemaps):i(new Error("Unexpected result: "+JSON.stringify(e)))},error:i,callbackParamName:"CallBack"})},r.prototype._initGeoprocessingEndpointsHandler=function(t){this._geoprocessingEndpointsInitialized=!0,t&&this._initAsyncCollection(t.geoprocessingEndpoints,"geoprocessing",this.geoprocessingEndpoints,e.essentials.GeoprocessingEndpoint)},r._getTokenFromFragment=function(){var e=window.location.href,t=e.indexOf("#gcx-");if(t>=0){var i=e.substring(t+5);return window.location.replace("#"),i}return null},r._addQueryParameter=function(e,t){var i=e.split("#",2);e=i[0];var r=i.length>1?i[1]:"";return e+(e.indexOf("?")>-1?"&":"?")+t+r},r.prototype.canSignIn=function(){return this._signInEnabled&&!!this.principal&&!!this.principal.urls.signIn&&!this.principal.isAuthenticated&&!!this.principal.policy&&this.principal.policy.issuers.length>0},r.prototype._signIn=function(e,t){e||(e=this.principal),t||(t=e.urls.signIn),void 0===e.policy&&(e.policy={});var i=e.policy.hints;i&&(t=r._addQueryParameter(t,i)),t=r._addQueryParameter(t,"token_type=fragment"),this.signInRedirectUri&&t.indexOf("app=")<0?t=r._addQueryParameter(t,"app="+encodeURIComponent(this.signInRedirectUri)):!e.urls.referrer&&t.indexOf("app=")<0&&(t=r._addQueryParameter(t,"app="+encodeURIComponent(window.location.toString()))),this.onSignIn&&this.onSignIn({url:t}),window.addEventListener&&window.addEventListener("popstate",function(){location.hash.startsWith("#gcx-")&&location.reload()},!1),window.location.assign(t)},r.prototype.signIn=function(e){this._signIn(this.principal,e)},r.prototype.canSignOut=function(){return this._signOutEnabled&&!!this.principal&&this.principal.isAuthenticated&&!!this.principal.urls.signOut},r.prototype.signOut=function(){this.onSignOut&&this.onSignOut();var e=this.principal.urls.signOut;this.signOutRedirectUri?e=r._addQueryParameter(e,"app="+encodeURIComponent(this.signOutRedirectUri)):this._signOutRedirectUrl&&(e=r._addQueryParameter(e,"app="+encodeURIComponent(this._signOutRedirectUrl))),window.location.assign(e)},r.prototype.getTokenFromPrincipal=function(i,r){var n=null;if(r===t.MapServiceType.DYNAMIC?n=this.principal.tokens.arcgis:r===t.MapServiceType.FEATURE?n=this.principal.tokens.arcgis:r===t.MapServiceType.IMAGE?n=this.principal.tokens.arcgis:r===t.MapServiceType.TILED?n=this.principal.tokens.arcgis:r===t.MapServiceType.WEBTILED?n=this.principal.tokens.arcgis:r===t.MapServiceType.VECTORTILE?n=this.principal.tokens.arcgis:r===esri.IdentityManagerBase?n=this.principal.tokens.arcgis:r===e.essentials.Site&&((h={})[this.url]=this.principal.tokens.site,n=h),!n)return null;i=i.toLowerCase();var s=document.createElement("a");s.href=i.toLowerCase();var a=s.protocol,o=s.hostname,l=s.port;i=s.href;for(var c in n){var u=c.toLowerCase();if(o==u)return n[c];if(o.endsWith("."+u))return n[c];try{if(s.href=a+"://"+u,s.port=l,i.startsWith(s.href))return n[c]}catch(e){}try{if(s.href=u,i.startsWith(s.href))return n[c]}catch(e){}}return null;var h},r.prototype._updateDefaultToken=function(e){if("string"==typeof e){var i=this.url,r=Math.max(i.indexOf("?"),i.indexOf("#"));r>=0&&(i=i.substr(0,r)),i=/^(.*?)\/*$/.exec(i)[1],t.RestHelperHTTPService.setDefaultToken(e,i+"/../../")}},r.prototype._detectAndConfigureCors=function(){var e=new dojo.Deferred;if(window.geocortexDisableEssentialsCorsDetection)return e.resolve(),e;var i=t.utilities.UrlUtilities.getUrlComponents(this.url),r=t.utilities.UrlUtilities.getUrlComponents(window.location.href);if(i.origin===r.origin)return e.resolve(),e;var n=(/(.*\/+)sites\/+[^\/]*\/?$/i.exec(this.url)||[])[1];if(n){var s=n+"info?f=json";dojo.xhrGet({url:s}).then(function(t){esri.config.defaults.io.corsEnabledServers.push(i.host),e.resolve()},function(t){e.resolve()})}else e.resolve();return e},r.prototype._initialize=function(){var t=this;if(!this.isInitialized&&!this._initializing){var i=r._getTokenFromFragment();if(this._updateDefaultToken(i),!i){var n=function(){if(window.removeEventListener?window.removeEventListener("popstate",n,!1):window.detachEvent&&window.detachEvent("onpopstate",n),!t.isInitialized&&t._initializing){var i=r._getTokenFromFragment();i&&(t._updateDefaultToken(i),e.request({url:t.url,content:{f:"json",deep:t.deepInitialize},load:dojo.hitch(t,t._verifySiteDependencies),error:dojo.hitch(t,t._initSiteErrorHandler),callbackParamName:"CallBack"}))}};window.addEventListener?window.addEventListener("popstate",n,!1):window.attachEvent&&window.attachEvent("onpopstate",n)}this._initializedHandlerCalled=!1,this._initializing=!0,e.request({url:this.url,content:{f:"json",deep:this.deepInitialize},load:dojo.hitch(this,this._verifySiteDependencies),error:dojo.hitch(this,this._initSiteErrorHandler),callbackParamName:"CallBack"})}},r.prototype._initMapHandler=function(e){this._mapInitialized=!0,null!==e&&null!==e.site&&e.loadServiceLayersInMap(e.site.getMap()),this._siteInitializeUpdate()},r.prototype._initMapErrorHandler=function(e){this._mapInitialized=!0,this._initializationFailedHandler(e),this._siteInitializeUpdate()},r.prototype._initNamedExtentsHandler=function(t){this._namedExtentsInitialized=!0,t&&this._initAsyncCollection(t.namedExtents,"namedextents",this.namedExtents,e.essentials.NamedExtent)},r.prototype._initTimeSlidersHandler=function(t){this._timeSlidersInitialized=!0,t&&this._initAsyncCollection(t.timeSliders,"timesliders",this.timeSliders,e.essentials.TimeSliderProfile)},r.prototype._initOverviewMapHandler=function(){this._overviewMapInitialized=!0,this._siteInitializeUpdate()},r.prototype._initOverviewMapErrorHandler=function(e){this._overviewMapInitialized=!0,this._initializationFailedHandler(e),this._siteInitializeUpdate()},r.prototype._initPrintTemplatesHandler=function(t){var i=this,r=0;this._printTemplatesInitialized=!0,t.printTemplates.length>0&&null!=t.printTemplates[0].visible?this._initAsyncCollection(t.printTemplates,"printtemplates",this.printTemplates,e.essentials.PrintTemplate):t.printTemplates.forEach(function(n){e.request({url:i.url+"/printtemplates/"+n.id,content:{f:"json"},load:function(n){r++,t.printTemplates.forEach(function(e){e.id===n.id&&(e.visible=n.visible)}),r===t.printTemplates.length&&i._initAsyncCollection(t.printTemplates,"printtemplates",i.printTemplates,e.essentials.PrintTemplate)},callbackParamName:"CallBack"})})},r.prototype.updateServiceTokensIfStale=function(){if(!this._serviceTokensStale){var e=new dojo.Deferred;return e.resolve(),e}return this._getUpdatedServiceTokens()},r.prototype._getUpdatedServiceTokens=function(){if(0===this.updateInterval){var t=new dojo.Deferred;return t.resolve(),t}return this._serviceTokenRefresh?this._serviceTokenRefresh:(this._serviceTokenRefresh=new dojo.Deferred,e.request({url:this.url+"/update",content:{f:"json"},load:dojo.hitch(this,this._processServiceTokensHandler),error:dojo.hitch(this,this._processServiceTokensErrorHandler),callbackParamName:"CallBack"}),this._serviceTokenRefresh)},r.prototype._processServiceTokensHandler=function(e){var t=this;e&&e.mapServiceTokens&&this._updateServiceTokens(this.essentialsMap,e.mapServiceTokens),e&&e.overviewMapServiceTokens&&this._updateServiceTokens(this.overviewMap,e.overviewMapServiceTokens),e.geocodingServiceTokens&&e.geocodingServiceTokens.forEach(function(e){var i=t.geocodingEndpoints.filter(function(t){return t.id===e.id})[0];i&&(i.geocoderToken=e.token,dojo.publish("ServiceTokenRefreshed",{serviceUrl:i.geocoderUrl,token:e.token}))}),e.geometryServiceTokens&&e.geometryServiceTokens.forEach(function(e){var i=t.geometryEndpoints.filter(function(t){return t.id===e.id})[0];i&&(i.geometryServiceToken=e.token,dojo.publish("ServiceTokenRefreshed",{serviceUrl:i.geometryServiceUrl,token:e.token}))}),this._serviceTokenRefresh.resolve(),this._serviceTokenRefresh=null,this._serviceTokensStale=!1},r.prototype._processServiceTokensErrorHandler=function(e){throw this._serviceTokenRefresh.reject(e),this._serviceTokenRefresh=null,this._serviceTokensStale=!0,dojo.publish("ServiceTokenRefreshError",{error:e}),e},r.prototype._updateServiceTokens=function(e,t){if(e&&t)for(var i=0;t&&i<t.length;i++){var r=e.findMapServiceById(t[i].id);r&&r._updateServiceToken(t[i].token)}},r.prototype._updateServiceTokensFromPrincipal=function(e){if(e&&e.mapServices)for(var t=0;t<e.mapServices.length;t++){var i=e.mapServices[t];if(i&&i.serviceUrl){var r=this.getTokenFromPrincipal(i.serviceUrl,esri.IdentityManagerBase);r&&i._updateServiceToken(r)}}},r.prototype._refreshPrincipal=function(){var e=this,i={site:this,handled:!1,resumeRefresh:function(){return t.SecurityHelper.beginRefresh(e)},suspendRefresh:function(){return t.SecurityHelper.cancel()}};dojo.publish("geocortex_sessionExpiring",i),i.handled||i.resumeRefresh()},r.prototype._refreshPrincipalAt=function(e,t){var i=this;if(!e)return!1;var r=new Date(e).valueOf();isNaN(r)&&(console.log("_refreshPrincipalAt: Date parse failed, most likely due to ECMAScript 5 support only. Using alternate method."),r=Date.parse(e),console.log("_refreshPrincipalAt: Parsed '"+e+"' as raw value '"+r.toString()+"'."));var n=r-(new Date).valueOf()-t;return n=Math.max(1e4,n),window.setTimeout(function(){return i._refreshPrincipal()},n),!0},r.prototype.updatePrincipal=function(e){this.principal=e,this._refreshPrincipalAt(e.expiry,3e5),this._updateDefaultToken(this.principal.tokens.site),this.principal.tokens&&this.principal.tokens.arcgis&&(this._updateServiceTokensFromPrincipal(this.essentialsMap),this._updateServiceTokensFromPrincipal(this.overviewMap))},r.prototype._getCredential=function(e,t){var i=this.getTokenFromPrincipal(e,esri.IdentityManagerBase),r=new dojo.Deferred;if(i){var n=new esri.Credential;n.token=i,n.server=this._getCredentialServer(e),r.resolve(n)}else r.reject(new Error("No token available for service {0}".format(e)));return r},r.prototype._getCredentialServer=function(e){var t=e.toLowerCase(),i=t.indexOf("/rest/services");return-1===i&&(i=t.indexOf("/sharing")),-1===i&&"/"===t.substr(-1)&&(i=t.length-1),i>-1?e.substring(0,i):e},r.prototype._hookGetCredential=function(){var e=this;esri.IdentityManagerBase.prototype.getCredential=function(t,i){try{return e._getCredential(t,i)}catch(e){console.log("Error getting site credential: "+e);var r=new dojo.Deferred;return r.reject(e),r}}},r.prototype._initSiteHandler=function(i){var r=this;if(this._hookGetCredential(),!i)throw new Error("Incorrect site object returned from initialization");if(this.configPreprocessor&&(this.configPreprocessor(i),this.configPreprocessor=null),i.contentPolicy&&(e.framework.utils.isNullOrUndefined(i.contentPolicy.trustedUrls)?this.trustedUrls=[]:this.trustedUrls=i.contentPolicy.trustedUrls),i.layerCatalogs)if(0==i.layerCatalogs.length)this.layerCatalogs=[];else for(var n=0;n<i.layerCatalogs.length;n++)this.layerCatalogs[n]=new e.essentials.LayerCatalog(i.layerCatalogs[n].siteId);if(i.principal){var s=i.principal;if(void 0===s.policy&&(s.policy={}),s.policy.authenticate&&!s.isAuthenticated)return void this._signIn(s);this.principal=s,s.isAuthenticated&&dojo.publish("geocortex_authenticationSucceeded",[{username:s.label,token:s.tokens.site}]),this._refreshPrincipalAt(this.principal.expiry,3e5)}else if(i.arcGisPortalAuthentication&&i.arcGisPortalAuthentication.clientID){var a=i.arcGisPortalAuthentication;if(this.arcGisPortalSecurityContext=new t.ArcGisPortalSecurityContext(a.url,a.domains,a.clientID),!this.arcGisPortalSecurityContext.initiate()){if(this.arcGisPortalSecurityContext.error)if(this.arcGisPortalSecurityContext.error.code==t.OAuth2Error.ACCESS_DENIED_ERROR_CODE)this.onUserSignInCancelled&&this.onUserSignInCancelled({tryAgainAction:dojo.hitch(this,function(){t.OAuth2Client.redirectToLogOnPage(this.arcGisPortalSecurityContext.getLogOnUrl(),this.arcGisPortalSecurityContext.clientId)})});else{var o=new Error;o.name=this.arcGisPortalSecurityContext.error.code,o.message=this.arcGisPortalSecurityContext.error.description,this._initializationFailedHandler(o)}return}t.RestHelperHTTPService.arcGisPortalToken=this.arcGisPortalSecurityContext.tokenResult}this.hasGeocodingEndpoints=!!i.hasGeocodingEndpoints,this.hasGeometryEndpoints=!!i.hasGeometryEndpoints,this.hasGeoprocessingEndpoints=!!i.hasGeoprocessingEndpoints,this.hasNamedExtents=!!i.hasNamedExtents,this.hasNorthArrow=!!i.hasNorthArrow,this.hasTimeSliders=!!i.hasTimeSliders,this.hasOverviewMap=!!i.hasOverviewMap,this.hasPrintTemplates=!!i.hasPrintTemplates,this.hasViewers=!!i.hasViewers,this.hasVirtualDirectory=!!i.hasVirtualDirectory,this.hasWorkflows=!!i.hasWorkflows,this.hasSearchTables=!!i.hasSearchTables,this.hasWebMaps=!!i.hasWebMaps,this.dataProvider=i.dataProvider,this.displayName=i.displayName,this.id=i.id,this._signInEnabled=!!i.signInEnabled,this._signOutEnabled=!!i.signOutEnabled,this._signOutRedirectUrl=i.signOutRedirectUrl,this.timeZoneId=i.timeZoneId,this.displayTimeZoneId=i.displayTimeZoneId,void 0===i.currentVersion?this.currentVersion="3.0":this.currentVersion=i.currentVersion,i.hasOwnProperty("updateInterval")?(this.updateInterval=parseInt(i.updateInterval),isNaN(this.updateInterval)&&(this.updateInterval=0)):this.updateInterval=0;var l=e.essentials.RestHelperHTTPService.getAuthenticationControlBlockStore().find(this.url);l&&setInterval(function(){(new e.essentials.RestHelperHTTPService)._requestToken(l)},Math.max(6e4,60*e.essentials.RestHelper.tokenDurationMinutes*1e3-12e4)),this.updateInterval>0&&(this._tokenIntervalHandle=setInterval(function(){r._getUpdatedServiceTokens()},Math.max(60,1e3*this.updateInterval))),this.properties=e._getProperties(i.properties),this.extensions=e._getExtensions(i.extensions),this.essentialsMap=new e.essentials.Map(this.originalUrl+"/map"),this.essentialsMap.site=this,dojo.connect(this.essentialsMap,"onInitialized",dojo.hitch(this,this._initMapHandler)),dojo.connect(this.essentialsMap,"onInitializationFailed",dojo.hitch(this,this._initMapErrorHandler)),this.hasOverviewMap&&(this.overviewMap=new e.essentials.Map(this.originalUrl+"/overviewmap"),this.overviewMap.site=this,dojo.connect(this.overviewMap,"onInitialized",dojo.hitch(this,this._initOverviewMapHandler)),dojo.connect(this.overviewMap,"onInitializationFailed",dojo.hitch(this,this._initOverviewMapErrorHandler))),i.map&&i.map.layerList&&(this.layerListRestEndpoint=i.map.layerList),!this.deepInitialize||this.getEssentialsVersion()<3.3||void 0===i.map?(this.essentialsMap.initialize(),this.hasOverviewMap?this.overviewMap.initialize():this._overviewMapInitialized=!0,i.hasKmlServiceEndpoint?e.request({url:this.url+"/kmlService",content:{f:"json"},load:dojo.hitch(this,this._initKmlEndpointHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._kmlServiceInitialized=!0})),callbackParamName:"CallBack"}):this._kmlServiceInitialized=!0,this.hasGeocodingEndpoints?e.request({url:this.url+"/geocoding",content:{f:"json"},load:dojo.hitch(this,this._initGeocodingEndpointsHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._geocodingEndpointsInitialized=!0})),callbackParamName:"CallBack"}):this._geocodingEndpointsInitialized=!0,this.hasGeometryEndpoints?e.request({url:this.url+"/geometry",content:{f:"json"},load:dojo.hitch(this,this._initGeometryEndpointsHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._geometryEndpointsInitialized=!0})),callbackParamName:"CallBack"}):this._geometryEndpointsInitialized=!0,this.hasGeoprocessingEndpoints?e.request({url:this.url+"/geoprocessing",content:{f:"json"},load:dojo.hitch(this,this._initGeoprocessingEndpointsHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._geoprocessingEndpointsInitialized=!0})),callbackParamName:"CallBack"}):this._geoprocessingEndpointsInitialized=!0,this.hasNamedExtents?e.request({url:this.url+"/namedextents",content:{f:"json"},load:dojo.hitch(this,this._initNamedExtentsHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._namedExtentsInitialized=!0})),callbackParamName:"CallBack"}):this._namedExtentsInitialized=!0,this.hasPrintTemplates?e.request({url:this.url+"/printtemplates",content:{f:"json"},load:dojo.hitch(this,this._initPrintTemplatesHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._printTemplatesInitialized=!0})),callbackParamName:"CallBack"}):this._printTemplatesInitialized=!0,this.hasSearchTables?e.request({url:this.url+"/searchtables",content:{f:"json"},load:dojo.hitch(this,this._initSearchTablesHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._searchTablesInitialized=!0})),callbackParamName:"CallBack"}):this._searchTablesInitialized=!0,this.hasTimeSliders?e.request({url:this.url+"/timesliders",content:{f:"json"},load:dojo.hitch(this,this._initTimeSlidersHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._timeSlidersInitialized=!0})),callbackParamName:"CallBack"}):this._timeSlidersInitialized=!0,this.hasWorkflows?e.request({url:this.url+"/workflows",content:{f:"json"},load:dojo.hitch(this,this._initWorkflowsHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._workflowsInitialized=!0})),callbackParamName:"CallBack"}):this._workflowsInitialized=!0,this.hasWebMaps?e.request({url:this.url+"/webmaps",content:{f:"json"},load:dojo.hitch(this,this._initWebMapHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._webMapsInitialized=!0})),callbackParamName:"CallBack"}):this._webMapsInitialized=!0):(this._initGeocodingEndpointsHandler(i),this._initGeometryEndpointsHandler(i),this._initGeoprocessingEndpointsHandler(i),this._initTimeSlidersHandler(i),this._initKmlEndpointHandler(i.kmlServiceEndpoint),this.essentialsMap.initialize(i.map),this._initNamedExtentsHandler(i),i.overviewMap?this.overviewMap.initialize(i.overviewMap):(this._overviewMapInitialized=!0,this._siteInitializeUpdate()),this._initPrintTemplatesHandler(i),this._initWorkflowsHandler(i),this._initSearchTablesHandler(i),this._initWebMapHandler(i)),this.documentStore.initialize(this),this._siteInitializeUpdate()},r.prototype._initSiteErrorHandler=function(e){var t=e,i=t.principal;!i||i.isAuthenticated||403!=t.code?(i&&i.isAuthenticated&&403==t.code&&i.urls.signOut&&(this._signOutEnabled=!0,this.principal=i),this._geocodingEndpointsInitialized=!0,this._geometryEndpointsInitialized=!0,this._geoprocessingEndpointsInitialized=!0,this._kmlServiceInitialized=!0,this._namedExtentsInitialized=!0,this._printTemplatesInitialized=!0,this._workflowsInitialized=!0,this._searchTablesInitialized=!0,this._timeSlidersInitialized=!0,this._initializationFailedHandler(e),this._siteInitializeUpdate()):this._signIn(i)},r.prototype._initWorkflowsHandler=function(t){this._workflowsInitialized=!0,t&&this._initAsyncCollection(t.workflows,"workflows",this.workflows,e.essentials.Workflow)},r.prototype._initSearchTablesHandler=function(t){this._searchTablesInitialized=!0,t&&this._initAsyncCollection(t.searchTables,"searchTables",this.searchTables,e.essentials.SearchTable)},r.prototype._initWebMapHandler=function(t){this._webMapsInitialized=!0,t&&t.webMapsInfo&&(this.webMapsInfo.layerTypes=t.webMapsInfo.layerTypes,this._initAsyncCollection(t.webMapsInfo.webMaps,"webmaps",this.webMapsInfo.webMaps,e.essentials.WebMapReference))},r.prototype._siteInitializeUpdate=function(){this._geocodingEndpointsInitialized&&this._geometryEndpointsInitialized&&this._geoprocessingEndpointsInitialized&&this._kmlServiceInitialized&&this._mapInitialized&&this._namedExtentsInitialized&&this._overviewMapInitialized&&this._printTemplatesInitialized&&this._workflowsInitialized&&this._searchTablesInitialized&&this._timeSlidersInitialized&&this._webMapsInitialized&&(this._initializedHandlerCalled||(this._initializedHandlerCalled=!0,this._initializedHandler(this)))},r.prototype._verifySiteDependencies=function(e){e&&e.hasFeatureLayers?dojo.addOnLoad(dojo.hitch(this,function(){this._initSiteHandler(e)})):this._initSiteHandler(e)},r}(t.AsyncInitializable);t.Site=i}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){var t=function(){function t(){}return t.processClientSideTokens=function(i,r){var n="";if(""!==r){var s="";i&&i.url&&(s=i.url),n=t._replaceToken("SiteRestUrl",r,s),n=t._replaceToken("VirtualDirectoryUrl",n,s+"/virtualdirectory");var a=window.location.href.substring(0,window.location.href.lastIndexOf("/"));n=t._replaceToken("HostUri",n,a);var o=s.substring(0,s.lastIndexOf("/sites/"))+"/virtualdirectory";n=t._replaceToken("RestVirtualDirectoryUrl",n,o);var l=e.RestHelperHTTPService.token;n=t._replaceToken("RestToken",n,l)}return n},t.validateDynamicDefinition=function(e){if(!e||!e.trim())throw new Error("The JSON string cannot be null, empty nor merely whitespace!");var i=t.getJsonObjectFromJsonString(e);if(i){if(null==i.source)throw"The source is required!";if(null==i.source.type)throw"The type is required!";if("mapLayer"==i.source.type){if(null==i.source.mapLayerId)throw"The mapLayerId is required for the mapLayer type!"}else{if("dataLayer"!=i.source.type)throw"The type '"+i.source.type.toString()+"' is not supported!";if(null==i.source.dataSource)throw"The dataSource is required for the dataLayer type!"}}},t.getJsonObjectFromJsonString=function(e){return JSON.parse(e)},t.getLayerSourceFromJsonObject=function(e){if("mapLayer"==e.type)return new esri.layers.LayerMapSource(e);var t=new esri.layers.LayerDataSource;switch(e.dataSource.type){case"table":t.dataSource=new esri.layers.TableDataSource(e.dataSource);break;case"queryTable":t.dataSource=new esri.layers.QueryDataSource(e.dataSource);break;case"raster":t.dataSource=new esri.layers.RasterDataSource(e.dataSource);break;case"joinTable":t.dataSource=new esri.layers.JoinDataSource(e.dataSource);break;default:throw"The type '"+e.type.toString()+"' not supported!"}return t},t.getDynamicLayerInfoFromJson=function(e,i){var r;t.validateDynamicDefinition(e);var n=t.getJsonObjectFromJsonString(e);if(n){if(r=new esri.layers.DynamicLayerInfo,n.id)r.id=n.id;else{if(null==i)throw"The Layer's ID is missing or invalid!";r.id=parseInt(i,10)}r.source=this.getLayerSourceFromJsonObject(n.source),null!=n.minScale&&(r.minScale=n.minScale),r.minScale<=0&&(r.minScale=1/0),null!=n.maxScale&&(r.maxScale=n.maxScale)}return r},t.getDynamicExpressionFromJson=function(e){var i;t.validateDynamicDefinition(e);var r=t.getJsonObjectFromJsonString(e);return r&&r.definitionExpression&&(i=r.definitionExpression),i},t.getLayerDrawingOptionsFromJson=function(e){var i;t.validateDynamicDefinition(e);var r,n=t.getJsonObjectFromJsonString(e);if(n&&n.drawingInfo){switch(r=dojo.clone(n.drawingInfo),i=new esri.layers.LayerDrawingOptions,r.renderer.type){case"simple":i.renderer=new esri.renderer.SimpleRenderer(r.renderer);break;case"uniqueValue":i.renderer=new esri.renderer.UniqueValueRenderer(r.renderer);break;case"classBreaks":i.renderer=new esri.renderer.ClassBreaksRenderer(r.renderer);break;default:throw"The type '"+r.renderer.type.toString()+"' not supported!"}if(r.labelingInfo&&r.labelingInfo instanceof Array){var s=r.labelingInfo;void 0===r.showLabels&&(r.showLabels=!0);for(var a=0;a<s.length;a++){var o=new esri.layers.LabelClass(s[a]);i.labelingInfo||(i.labelingInfo=[]),i.labelingInfo.push(o)}}i.transparency=r.transparency,i.scaleSymbols=r.scaleSymbols,i.showLabels=r.showLabels}return i},t._replaceToken=function(e,t,i){return t?t.replace("{"+e+"}",i):t},t._createRestParametersFromQuery=function(e){var i={};return e&&((i=e.toJson()).spatialRel=t._convertSpatialRelationshipToDotnet(i.spatialRel)),i},t._convertSpatialRelationshipToDotnet=function(e){switch(e){case esri.tasks.Query.SPATIAL_REL_CONTAINS:return"esriSpatialRelContains";case esri.tasks.Query.SPATIAL_REL_CROSSES:return"esriSpatialRelCrosses";case esri.tasks.Query.SPATIAL_REL_ENVELOPEINTERSECTS:return"esriSpatialRelEnvelopeIntersects";case esri.tasks.Query.SPATIAL_REL_INDEXINTERSECTS:return"esriSpatialRelIndexIntersects";case esri.tasks.Query.SPATIAL_REL_INTERSECTS:return"esriSpatialRelIntersects";case esri.tasks.Query.SPATIAL_REL_OVERLAPS:return"esriSpatialRelOverlaps";case esri.tasks.Query.SPATIAL_REL_RELATION:return"esriSpatialRelRelation";case esri.tasks.Query.SPATIAL_REL_TOUCHES:return"esriSpatialRelTouches";case esri.tasks.Query.SPATIAL_REL_WITHIN:return"esriSpatialRelWithin"}throw new Error("Unknown rel: "+e)},t._convertSpatialRelationshipFromDotnetIndex=function(e){switch(e){case 1:return esri.tasks.Query.SPATIAL_REL_CONTAINS;case 2:return esri.tasks.Query.SPATIAL_REL_CROSSES;case 3:return esri.tasks.Query.SPATIAL_REL_ENVELOPEINTERSECTS;case 4:return esri.tasks.Query.SPATIAL_REL_INDEXINTERSECTS;case 0:return esri.tasks.Query.SPATIAL_REL_INTERSECTS;case 5:return esri.tasks.Query.SPATIAL_REL_OVERLAPS;case 8:return esri.tasks.Query.SPATIAL_REL_RELATION;case 6:return esri.tasks.Query.SPATIAL_REL_TOUCHES;case 7:return esri.tasks.Query.SPATIAL_REL_WITHIN}throw new Error("Unknown rel: "+e)},t.tokenDurationMinutes=20,t}();e.RestHelper=t}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){var i=function(){return function(t,i){this.encodeUriReplacementValues=t.encodeUriReplacementValues,this.target=t.target,this.text=t.text,this.toolTip=t.toolTip;var r=null;i&&i.mapService&&i.mapService.essentialsMap&&(r=i.mapService.essentialsMap.site),this.uri=e.essentials.RestHelper.processClientSideTokens(r,t.uri),this.iconUri=e.essentials.RestHelper.processClientSideTokens(r,t.iconUri),this.layer=i}}();t.FeatureHyperlink=i}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){var i=function(i){function r(e){i.call(this,e),this.description=null,this.displayName=null,this.extensions=[],this.id=null,this.visible=!1,this.layer=null,this.properties={},this.supportedMapScales=[],this.supportedOutputFormats=[],this.supportedResolutions=[],this.textFields=[],this._running=!1,this._onRunReportComplete=null,this._onRunReportError=null}return __extends(r,i),r.prototype.isRunning=function(){return this._running},r.prototype.run=function(i,r,n,s){var a=this;if(this.isRunning()){if(s){var o=new Error("Report already running");o.name="ReportAlreadyRunning",s(o)}}else{this._running=!0;try{this._onRunReportComplete=n,this._onRunReportError=s;var l=new t.exportMap.ExportMapTask(this),c=new t.exportMap.ExportMapParameters;c.reportParameters=r,i&&(c.queryParameters=e.essentials.RestHelper._createRestParametersFromQuery(i)),l.generateMapImageUrl(c).then(function(e){return a._runRestComplete(e)},function(e){return a._runRestError(e)})}catch(o){if(this._running=!1,!this._onRunReportError)throw o;this._onRunReportError(o)}}},r.prototype._configureObject=function(t,i){if(void 0===t.id||void 0===t.displayName)throw new Error("Incorrect report object returned from initialization");this.id=t.id,this.visible=void 0===t.visible||t.visible,this.supportedOutputFormats=t.supportedOutputFormats,this.supportedResolutions=t.supportedResolutions,this.supportedMapScales=t.supportedScales,this.textFields=t.textFields,this.description=t.description,this.displayName=t.displayName,i&&(this.isInitialized=!0),this.properties=e._getProperties(t.properties),this.extensions=e._getExtensions(t.extensions)},r.prototype._runRestComplete=function(e){this._running=!1;var t=null;e?e.error&&(t=e.error):t=new Error("No results"),t&&this._onRunReportError&&this._onRunReportError(t),e&&this._onRunReportComplete&&this._onRunReportComplete(e)},r.prototype._runRestError=function(e){this._running=!1,this._onRunReportError&&this._onRunReportError(e)},r}(t.AsyncInitializable);t.Report=i}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){!function(e){e.LAYER_TEMPLATE_REPORT="Layer Template Report",e.MAP_TEMPLATE_REPORT="Map Template Report"}(e.ReportType||(e.ReportType={}))}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){var t=function(){function e(){}return e.UNKNOWN=0,e.FEATURE_LAYER=1,e.RASTER_LAYER=2,e.GROUP_LAYER=3,e.GEO_RSS_LAYER=4,e.TABLE_LAYER=5,e}();e.LayerType=t}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){var t=function(){function e(){}return e.esriFieldTypeSmallInteger="esriFieldTypeSmallInteger",e.esriFieldTypeInteger="esriFieldTypeInteger",e.esriFieldTypeSingle="esriFieldTypeSingle",e.esriFieldTypeDouble="esriFieldTypeDouble",e.esriFieldTypeString="esriFieldTypeString",e.esriFieldTypeDate="esriFieldTypeDate",e.esriFieldTypeOID="esriFieldTypeOID",e.esriFieldTypeGeometry="esriFieldTypeGeometry",e.esriFieldTypeBlob="esriFieldTypeBlob",e.esriFieldTypeRaster="esriFieldTypeRaster",e.esriFieldTypeGUID="esriFieldTypeGUID",e.esriFieldTypeGlobalID="esriFieldTypeGlobalID",e.esriFieldTypeXML="esriFieldTypeXML",e}();e.EsriFieldTypes=t;var i=function(){function e(){}return e.essentialsFieldTypeSmallInteger="Int16",e.essentialsFieldTypeInteger="Int32",e.essentialsFieldTypeSingle="Single",e.essentialsFieldTypeDouble="Double",e.essentialsFieldTypeString="String",e.essentialsFieldTypeDate="DateTime",e.essentialsFieldTypeGUID="Guid",e.essentialsFieldTypeObject="Object",e}();e.EssentialsFieldTypes=i;var r=function(){function r(e){if(this.layer=null,!e||!e.layer)throw new Error("Layer is required.");this.layer=e.layer,this.alias=e.alias,this.dataType=e.dataType,this.displayName=e.displayName,this.focusField=!!e.focusField,this.hyperlinkLabel=e.hyperlinkLabel,this.name=e.name,this.searchable=!!e.searchable,this.visible=!!e.visible,this.format=e.format}return r.prototype.toJson=function(){return{alias:this.alias,dataType:this.dataType,displayName:this.displayName,focusField:this.focusField,hyperlinkLabel:this.hyperlinkLabel,name:this.name,searchable:this.searchable,visible:this.visible,format:this.format}},r.convertFromEsriType=function(e){if(!e||0!==e.indexOf("esriFieldType"))return e;switch(e){case t.esriFieldTypeGeometry:case t.esriFieldTypeBlob:case t.esriFieldTypeRaster:return i.essentialsFieldTypeObject;case t.esriFieldTypeDate:return i.essentialsFieldTypeDate;case t.esriFieldTypeDouble:return i.essentialsFieldTypeDouble;case t.esriFieldTypeGlobalID:return i.essentialsFieldTypeGUID;case t.esriFieldTypeInteger:case t.esriFieldTypeOID:return i.essentialsFieldTypeInteger;case t.esriFieldTypeSingle:return i.essentialsFieldTypeSingle;case t.esriFieldTypeSmallInteger:return i.essentialsFieldTypeSmallInteger;case t.esriFieldTypeGUID:case t.esriFieldTypeString:case t.esriFieldTypeXML:default:return i.essentialsFieldTypeString}},r.convertToEsriFieldType=function(i){switch(i){case e.EssentialsFieldTypes.essentialsFieldTypeObject:return t.esriFieldTypeBlob;case e.EssentialsFieldTypes.essentialsFieldTypeDate:return t.esriFieldTypeDate;case e.EssentialsFieldTypes.essentialsFieldTypeDouble:return t.esriFieldTypeDouble;case e.EssentialsFieldTypes.essentialsFieldTypeGUID:return t.esriFieldTypeGlobalID;case e.EssentialsFieldTypes.essentialsFieldTypeInteger:return t.esriFieldTypeInteger;case e.EssentialsFieldTypes.essentialsFieldTypeSingle:return t.esriFieldTypeSingle;case e.EssentialsFieldTypes.essentialsFieldTypeSmallInteger:return t.esriFieldTypeSmallInteger;case e.EssentialsFieldTypes.essentialsFieldTypeString:default:return t.esriFieldTypeString}},r}();e.Field=r}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){var i=function(){function i(i,r){this.encodeUriReplacementValues=i.encodeUriReplacementValues,this.target=i.target,this.text=i.text,this.toolTip=i.toolTip;var n=null;r instanceof t.Layer?(this.layer=r,this.layer.mapService&&(this.mapService=this.layer.mapService)):r instanceof t.MapService&&(this.mapService=r),this.mapService&&this.mapService.essentialsMap&&(n=this.mapService.essentialsMap.site),this.uri=e.essentials.RestHelper.processClientSideTokens(n,i.uri),this.iconUri=e.essentials.RestHelper.processClientSideTokens(n,i.iconUri)}return i.prototype.toJson=function(){return{encodeUriReplacementValues:this.encodeUriReplacementValues,iconUri:this.iconUri,target:this.target,text:this.text,toolTip:this.toolTip,uri:this.uri}},i}();t.LayerHyperlink=i}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){var i=function(i){function r(t){i.call(this,t),this.allowSymbolization=!1,this.canToggleLabels=!1,this.charts=[],this.configuredVisible=!1,this.dataLinks=[],this.dataProvider=null,this.defaultVisibility=!1,this.displayField=null,this.displayName=null,this.defaultDateFormat=null,this.defaultNumberFormat=null,this.description=null,this.drawIndex=null,this.dynamicDefinition=null,this.extensions=[],this.featureBorderColor=null,this.featureBorderWidth=null,this.featureDescription=null,this.featureFillColor=null,this.featureHyperlinks=[],this.featureLabel=null,this.featureLongDescription=null,this.featureType="None",this.featureZoomFactor=null,this.featureZoomScale=null,this.fields=[],this.fullExtent=null,this.hasAttachments=!1,this.hasDataLinks=!1,this.hasReports=!1,this.iconUri=null,this.id=null,this.identifiable=!1,this.identifiableAtAllScales=!1,this.includeInLayerList=!0,this.includeInLegend=!0,this.isDynamic=!1,this.isExpanded=!1,this.isUserCreated=!1,this.catalogId=null,this.layerHyperlinks=[],this.legendUrl=null,this.mapService=null,this.maxScale=0,this.minScale=0,this.name=null,this.parentLayerId=null,this.primaryKeyField=null,this.properties={},this.queryable=!1,this.relationships=[],this.reports=[],this.searchable=!1,this.showFeatureHyperlinks="ShowAll",this.showLabels=!0,this.showMapTips=!1,this.snappable=!1,this.snappingEnabled=!1,this.supportsIdentify=!1,this.supportsQuery=!1,this.styleName=null,this.styles=[],this.subLayerIds=[],this.timeZoneId=null,this.type=e.essentials.LayerType.UNKNOWN,this.visibleStateForRefresh=e.essentials.RefreshVisibility.DEFAULT,this.wmsLayerName=null,this.inActiveTheme=!0,this.layerThemeSettings=[],this._visible=!1,this._featureLayerPromise=null,this._timeInfo=null,this._gcxTimeInfo=null,this.setInActiveTheme(!0)}return __extends(r,i),r.prototype.getFeatureLayer=function(){var e=this;if(!this._featureLayerPromise)if(this.mapService.serviceUrl&&this.mapService.serviceUrl.endsWith("/MapServer"))this._featureLayerPromise=new Promise(function(t,i){e.mapService._getLayersInfo().then(function(r){var n=null;if(r&&r.layers){if(r.layers.forEach(function(t){e.id!==t.id.toString()||(n=new esri.layers.FeatureLayer({layerDefinition:t}))}),!n&&r.tables&&r.tables.forEach(function(t){e.id!==t.id.toString()||(n=new esri.layers.FeatureLayer({layerDefinition:t}))}),n)return void t(n);if(e.isDynamic&&e.mapService&&e.mapService.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer){var s=e.mapService.serviceLayer;if(s.dynamicLayerInfos){var a=null;for(var o in s.dynamicLayerInfos)if(s.dynamicLayerInfos.hasOwnProperty(o)&&s.dynamicLayerInfos[o].id==parseInt(e.id)){a=s.dynamicLayerInfos[o].source;break}if(a)var l=e.mapService.serviceUrl+"/dynamicLayer",c=e.mapService.serviceToken?l+"?token="+e.mapService.serviceToken:l,u=(n=new esri.layers.FeatureLayer(c,{source:a})).on("load",function(e){u.remove(),h.remove(),t(n)}),h=n.on("error",function(e){u.remove(),h.remove();var t=e.error&&e.error.message?e.error.message:"Could not determine underlying error.";i(new Error("Could not create a Feature Layer from the given dynamic layer source. Reason: {0}".format(t)))});else i(new Error("Could not find LayerSource for the given dynamic layer."))}}}})});else{var i;(i=this.mapService.serviceLayer instanceof esri.layers.FeatureLayer?this.mapService.serviceLayer:new esri.layers.FeatureLayer(this.getLayerUrl())).loaded?this._featureLayerPromise=Promise.resolve(i):this._featureLayerPromise=new Promise(function(r,n){var s=i.on("load",function(){if(s.remove(),a.remove(),e.wmsLayerName)for(var n=e.fields,o=i.fields.length-1;o>=0;o--){var l=i.fields[o];"gml:id"===l.name&&i.fields.splice(o,1),l.type=t.Field.convertToEsriFieldType(n[o].dataType)}r(i)}),a=i.on("error",function(e){s.remove(),a.remove(),n(e)})})}return this._featureLayerPromise},r.prototype.getRelatedFeatureLayer=function(t,i,r){var n=new dojo.Deferred,s=function(t){e.deferredResolve(n,t),"function"==typeof i&&i(t)},a=this._getRelation(t);if(!a){var o=new Error("Relation not found: "+t);return n&&-1==n.fired&&n.resolve(o),"function"==typeof r&&r(o),n}var l=this.getLayerUrl(),c=l.substring(0,l.lastIndexOf("/")+1)+a.relatedTableId;this.mapService&&this.mapService.serviceToken&&(c+=c.indexOf("?")>-1?"&token=":"?token=",c+=encodeURIComponent(this.mapService.serviceToken)),void 0===esri.getProxyRule(c)&&null!==this.mapService.proxyUrl&&esri.addProxyRule({urlPrefix:c,proxyUrl:this.mapService.proxyUrl});var u=new esri.layers.FeatureLayer(c,{mode:esri.layers.FeatureLayer.MODE_SELECTION,outFields:["*"]});return u.loaded?s(u):dojo.connect(u,"onLoad",dojo.hitch(this,s)),dojo.connect(u,"onError",dojo.hitch(this,function(e){n&&-1==n.fired&&n.resolve(e),"function"==typeof r&&r(e)})),n},r.prototype.areAllAncestorsVisible=function(){for(var e=this.mapService.findLayerById(this.parentLayerId);null!==e&&void 0!==e;){if(!e.isVisible())return!1;e=this.mapService.findLayerById(e.parentLayerId)}return!0},r.prototype.getLayerUrl=function(){if(this.mapService&&this.mapService.serviceUrl){if("FeatureLayer"===this.mapService.drawingBehavior)return this.mapService.serviceUrl;if("WMS"===this.mapService.mapServiceType){var e=this.mapService.url+"/layers/"+this.id,i=t.RestHelperHTTPService.getTokenForScope(this.mapService.url);return i&&(e+=e.indexOf("?")>-1?"&token=":"?token=",e+=encodeURIComponent(i)),e}return this.mapService.serviceUrl+"/"+this.id}return null},r.prototype.getFieldByName=function(e){if(this.fields&&this.fields.length>0){if(!this._fieldLookup){this._fieldLookup={};for(var t=0;t<this.fields.length;t++){var i=this.fields[t];this._fieldLookup[i.name]=i}}return this._fieldLookup[e]}return null},r.prototype.isVisible=function(){return this._visible},r.prototype.setVisibility=function(t,i){if(this.mapService){switch(this.mapService.mapServiceType){case e.essentials.MapServiceType.DYNAMIC:case e.essentials.MapServiceType.FEATURE:case e.essentials.MapServiceType.WMS:case e.essentials.MapServiceType.WMTS:case e.essentials.MapServiceType.GEORSS:case e.essentials.MapServiceType.KML:case e.essentials.MapServiceType.TILED:this._visible=t;break;default:this._visible=!0}this.mapService._setVisibility(this.id,this._visible,i)}},r.prototype.setInActiveTheme=function(e){this.inActiveTheme=e,dojo.publish("LayerInActiveThemeChangedEvent",this)},r.prototype.findReportById=function(t){return e.essentials.utilities.SiteResourceIdComparer.lookUp(this.reports,t)},r.prototype.withinScaleRange=function(e){return!!(0==this.maxScale&&this.minScale==1/0||isNaN(this.maxScale)&&isNaN(this.minScale))||(null==e&&(e=this.mapService.essentialsMap.calculateScale()),this.maxScale<e&&e<this.minScale)},r.prototype._configureDataLinks=function(t,i,r){for(var n=0;t&&n<t.length;n++){var s=this.dataLinks[n]=new e.essentials.DataLink(this.url+"/datalinks/"+t[n].id);s.layer=this,s._configureObject(t[n],i)}},r.prototype._idIsUnique=function(e){if(this.mapService&&e){var t=[];if(dojo.forEach(this.mapService.layers,function(e){t.push(e.id)}),t.indexOf(e)<0)return!0}return!1},r.prototype._getUniqueId=function(){if(this.mapService){var e=[];if(dojo.forEach(this.mapService.layers,function(t){e.push(t.id)}),e.length>0){var t=Math.max.apply(null,e);return(++t).toString()}}return"0"},r.prototype.createFromDefinition=function(e){this._createFrom(e)},r.prototype._createFrom=function(t){if(this.defaultVisibility=t.defaultVisibility,this.configuredVisible=t.visible,this.displayName=t.displayName||t.name,this.description=t.description,this.featureDescription=t.featureDescription,t.hasOwnProperty("featureLongDescription")?this.featureLongDescription=t.featureLongDescription:this.featureLongDescription=t.featureDescription,this.featureLabel=t.featureLabel,this.featureType=t.featureType,this.featureZoomScale=t.featureZoomScale,this.featureZoomFactor=t.featureZoomFactor,this.hasDataLinks=t.hasDataLinks,this.hasReports=t.hasReports,this.hasAttachments=t.hasAttachments,t.hasOwnProperty("id")?this.id=t.id:this.id=this._getUniqueId(),this.name=t.name,this.wmsLayerName=t.nativeID,this.parentLayerId=t.parentLayerId,this.subLayerIds=t.subLayerIds,this._visible=t.visible,this.styleName=t.styleName,this.legendUrl=t.legendUrl,this.isDynamic=t.isDynamic,this.dynamicDefinition=t.dynamicDefinition,this.dataProvider=t.dataProvider,this.defaultDateFormat=t.defaultDateFormat,this.defaultNumberFormat=t.defaultNumberFormat,this.timeZoneId=t.timeZoneId,t.fullExtent&&(this.fullExtent=new esri.geometry.Extent(t.fullExtent)),t.hasOwnProperty("drawIndex")&&(this.drawIndex=t.drawIndex),t.hasOwnProperty("identifiable")&&(this.identifiable=t.identifiable),t.hasOwnProperty("includeInLayerList")&&(this.includeInLayerList=t.includeInLayerList),t.hasOwnProperty("includeInLegend")&&(this.includeInLegend=t.includeInLegend),t.hasOwnProperty("featureBorderColor")&&(this.featureBorderColor=t.featureBorderColor,this.featureBorderColor&&this.featureBorderColor.length>=4&&this.featureBorderColor[3]>=1&&(this.featureBorderColor[3]/=255)),t.hasOwnProperty("featureBorderWidth")&&(this.featureBorderWidth=t.featureBorderWidth),t.hasOwnProperty("featureFillColor")&&(this.featureFillColor=t.featureFillColor,this.featureFillColor&&this.featureFillColor.length>=4&&this.featureFillColor[3]>=1&&(this.featureFillColor[3]/=255)),t.hasOwnProperty("minScale")&&!isNaN(t.minScale)&&0!=t.minScale?this.minScale=t.minScale:this.minScale=1/0,t.hasOwnProperty("maxScale")&&!isNaN(t.maxScale)?this.maxScale=t.maxScale:this.maxScale=0,this.mapService&&null!=this.mapService.minScale&&!isNaN(this.mapService.minScale)&&(this.minScale=Math.min(this.minScale,this.mapService.minScale)),this.mapService&&null!=this.mapService.maxScale&&!isNaN(this.mapService.maxScale)&&(this.maxScale=Math.max(this.maxScale,this.mapService.maxScale)),t.hasOwnProperty("queryable")&&(this.queryable=t.queryable),t.hasOwnProperty("searchable")&&(this.searchable=t.searchable),t.hasOwnProperty("snappable")&&(this.snappable=t.snappable),t.hasOwnProperty("snappingEnabled")&&(this.snappingEnabled=t.snappingEnabled),t.hasOwnProperty("showFeatureHyperlinks")&&(this.showFeatureHyperlinks=t.showFeatureHyperlinks),t.hasOwnProperty("canToggleLabels")&&(this.canToggleLabels=t.canToggleLabels),t.hasOwnProperty("showLabels")&&(this.showLabels=t.showLabels),t.hasOwnProperty("showMapTips")&&(this.showMapTips=t.showMapTips),t.hasOwnProperty("supportsIdentify")&&(this.supportsIdentify=t.supportsIdentify),t.hasOwnProperty("supportsQuery")&&(this.supportsQuery=t.supportsQuery),t.hasOwnProperty("layerHyperlinks"))for(i=0;i<t.layerHyperlinks.length;i++)this.layerHyperlinks[i]=new e.essentials.LayerHyperlink(t.layerHyperlinks[i],this);if(void 0!==t.type&&(this.type=this._layerTypeStringToEssentialsLayerType(t.type)),t.fields)for(var i=0;i<t.fields.length;i++){var r=t.fields[i],n={layer:this,dataType:e.essentials.Field.convertFromEsriType(r.type||r.dataType),alias:r.alias,displayName:r.displayName||r.alias||r.name,name:r.name,searchable:!0,visible:!0,focusField:!1,hyperlinkLabel:null,format:r.format};r.hasOwnProperty("searchable")&&(n.searchable=r.searchable),r.hasOwnProperty("visible")&&(n.visible=r.visible),this.fields[i]=new e.essentials.Field(n)}this.primaryKeyField=this.getFieldByName(t.primaryKeyField),this.displayField=this.getFieldByName(t.displayField),t.properties&&(this.catalogId=e._getProperties(t.properties).layerCatalogLookupId),this.isInitialized=!0},r.prototype._configureObject=function(i,r){if(void 0===i||void 0===i.name||void 0===i.id||void 0===i.hasDataLinks)throw new Error("Incorrect layer object returned from initialization");this.allowSymbolization=i.allowSymbolization,this.defaultVisibility=i.defaultVisibility,this.configuredVisible=i.visible,this.displayName=i.displayName,this.description=i.description,this.featureDescription=i.featureDescription,i.hasOwnProperty("featureLongDescription")?this.featureLongDescription=i.featureLongDescription:this.featureLongDescription=i.featureDescription,this.featureLabel=i.featureLabel,this.featureType=void 0===i.featureType?this.featureType:i.featureType,this.featureZoomScale=void 0===i.featureZoomScale?this.featureZoomScale:i.featureZoomScale,this.featureZoomFactor=void 0===i.featureZoomFactor?this.featureZoomFactor:i.featureZoomFactor,this.hasDataLinks=i.hasDataLinks,this.hasReports=i.hasReports,this.hasAttachments=i.hasAttachments,this.id=i.id,this.name=i.name,this.wmsLayerName=i.nativeID,this.parentLayerId=i.parentLayerId,this.subLayerIds=i.subLayerIds,this.styleName=i.styleName,this.legendUrl=i.legendUrl,this.isDynamic=void 0===i.isDynamic?this.isDynamic:i.isDynamic,this.dynamicDefinition=i.dynamicDefinition,this.dataProvider=i.dataProvider,this.defaultDateFormat=i.defaultDateFormat,this.defaultNumberFormat=i.defaultNumberFormat,this.timeZoneId=i.timeZoneId,this._timeInfo=i.timeInfo?i.timeInfo:null,i.fullExtent&&(this.fullExtent=new esri.geometry.Extent(i.fullExtent));var n=null;if(this.mapService&&this.mapService.essentialsMap&&(n=this.mapService.essentialsMap.site),this.iconUri=e.essentials.RestHelper.processClientSideTokens(n,i.iconUri),i.hasOwnProperty("includeInLayerList")&&(this.includeInLayerList=i.includeInLayerList),null!=this.mapService.essentialsMap.layerThemesInfo.startupThemeId&&this.includeInLayerList?this._visible=!1:this._visible=void 0===i.initiallyVisible?!!i.visible:!!i.initiallyVisible,i.themeSettings&&i.themeSettings.length)for(var s=0;s<i.themeSettings.length;s++){var a=i.themeSettings[s],o=this.mapService.essentialsMap.layerThemesInfo.getTheme(a.themeID);if(o){var l=void 0==a.visible?this.configuredVisible:a.visible;this.layerThemeSettings.push(new t.LayerThemeSetting(o,l)),o.id===this.mapService.essentialsMap.layerThemesInfo.startupThemeId&&this.includeInLayerList&&(this._visible=void 0===a.initiallyVisible?l:a.initiallyVisible)}}i.hasOwnProperty("drawIndex")&&(this.drawIndex=i.drawIndex),i.hasOwnProperty("featureBorderColor")&&(this.featureBorderColor=i.featureBorderColor,this.featureBorderColor&&this.featureBorderColor.length>=4&&this.featureBorderColor[3]>=1&&(this.featureBorderColor[3]/=255)),i.hasOwnProperty("featureBorderWidth")&&(this.featureBorderWidth=i.featureBorderWidth),i.hasOwnProperty("featureFillColor")&&(this.featureFillColor=i.featureFillColor,this.featureFillColor&&this.featureFillColor.length>=4&&this.featureFillColor[3]>=1&&(this.featureFillColor[3]/=255)),i.hasOwnProperty("identifiable")&&(this.identifiable=i.identifiable),i.hasOwnProperty("includeInLegend")&&(this.includeInLegend=i.includeInLegend),i.hasOwnProperty("minScale")&&!isNaN(i.minScale)&&0!=i.minScale?this.minScale=i.minScale:this.minScale=1/0,i.hasOwnProperty("maxScale")&&!isNaN(i.maxScale)?this.maxScale=i.maxScale:this.maxScale=0,this.mapService&&null!=this.mapService.minScale&&!isNaN(this.mapService.minScale)&&(this.minScale=Math.min(this.minScale,this.mapService.minScale)),this.mapService&&null!=this.mapService.maxScale&&!isNaN(this.mapService.maxScale)&&(this.maxScale=Math.max(this.maxScale,this.mapService.maxScale)),i.hasOwnProperty("queryable")&&(this.queryable=i.queryable),i.hasOwnProperty("searchable")&&(this.searchable=i.searchable),i.hasOwnProperty("showFeatureHyperlinks")&&(this.showFeatureHyperlinks=i.showFeatureHyperlinks),i.hasOwnProperty("canToggleLabels")&&(this.canToggleLabels=i.canToggleLabels),i.hasOwnProperty("showLabels")&&(this.showLabels=i.showLabels),i.hasOwnProperty("showMapTips")&&(this.showMapTips=i.showMapTips),i.hasOwnProperty("snappable")&&(this.snappable=i.snappable),i.hasOwnProperty("snappingEnabled")&&(this.snappingEnabled=i.snappingEnabled),i.hasOwnProperty("supportsIdentify")&&(this.supportsIdentify=i.supportsIdentify),i.hasOwnProperty("supportsQuery")&&(this.supportsQuery=i.supportsQuery),void 0!==i.type&&(this.type=this._layerTypeStringToEssentialsLayerType(i.type)),this.type==e.essentials.LayerType.GROUP_LAYER&&i.hasOwnProperty("isExpanded")&&(this.isExpanded=i.isExpanded);var c;if(i.featureHyperlinks)for(c=0;c<i.featureHyperlinks.length;c++)this.featureHyperlinks[c]=new e.essentials.FeatureHyperlink(i.featureHyperlinks[c],this);if(i.fields)for(c=0;c<i.fields.length;c++)i.fields[c].layer=this,this.fields[c]=new e.essentials.Field(i.fields[c]);if(i.relationships)for(c=0;c<i.relationships.length;c++)i.relationships[c].displayName&&(i.relationships[c].name=i.relationships[c].displayName),i.relationships[c].id=parseInt(i.relationships[c].id),i.relationships[c].relatedTableId=parseInt(i.relationships[c].relatedTableId),this.relationships.push(i.relationships[c]);if(i.hasOwnProperty("layerHyperlinks"))for(c=0;c<i.layerHyperlinks.length;c++)this.layerHyperlinks[c]=new e.essentials.LayerHyperlink(i.layerHyperlinks[c],this);if(i.hasOwnProperty("charts")&&e.charting&&dojo.isObject(e.charting.configuration.ChartDefinition))for(c=0;c<i.charts.length;c++)this.charts.push(new e.essentials.LayerChart(i.charts[c],this));if(i.styles&&i.styles.length)for(c=0;c<i.styles.length;c++){var u=i.styles[c],h=u.definition;h&&this.styles.push(new t.LayerStyle(h,u.displayName,u.id))}this.primaryKeyField=this.getFieldByName(i.primaryKeyField),this.displayField=this.getFieldByName(i.displayField),this._configureDataLinks(i.dataLinks,r,n),this._configureReports(i.reports,r),r&&(this.isInitialized=!0),this.properties=e._getProperties(i.properties),this.extensions=e._getExtensions(i.extensions)},r.prototype.toJson=function(){return{id:this.id,name:this.name,url:this.url,defaultVisibility:this.defaultVisibility,visible:this.configuredVisible,displayName:this.displayName,description:this.description,featureDescription:this.featureDescription,featureLongDescription:this.featureLongDescription,featureLabel:this.featureLabel,featureType:this.featureType,featureZoomScale:this.featureZoomScale,featureZoomFactor:this.featureZoomFactor,hasDataLinks:this.hasDataLinks,hasReports:this.hasReports,hasAttachments:this.hasAttachments,nativeID:this.wmsLayerName,parentLayerId:this.parentLayerId,subLayerIds:(this.subLayerIds||[]).slice(),styleName:this.styleName,legendUrl:this.legendUrl,isDynamic:this.isDynamic,dynamicDefinition:this.dynamicDefinition,dataProvider:this.dataProvider,defaultDateFormat:this.defaultDateFormat,defaultNumberFormat:this.defaultNumberFormat,fullExtent:this.fullExtent?this.fullExtent.toJson():void 0,drawIndex:this.drawIndex,identifiable:this.identifiable,includeInLayerList:this.includeInLayerList,includeInLegend:this.includeInLegend,featureBorderColor:this.featureBorderColor,featureBorderWidth:this.featureBorderWidth,featureFillColor:this.featureFillColor,minScale:this.minScale===1/0?0:this.minScale,maxScale:this.maxScale,queryable:this.queryable,searchable:this.searchable,snappable:this.snappable,snappingEnabled:this.snappingEnabled,showFeatureHyperlinks:this.showFeatureHyperlinks,canToggleLabels:this.canToggleLabels,showLabels:this.showLabels,showMapTips:this.showMapTips,supportsIdentify:this.supportsIdentify,supportsQuery:this.supportsQuery,layerHyperlinks:this.layerHyperlinks.map(function(e){return e.toJson()}),type:this._essentialsLayerTypeToLayerTypeString(this.type),fields:this.fields.map(function(e){return e.toJson()}),primaryKeyField:this.primaryKeyField?this.primaryKeyField.name:void 0,displayField:this.displayField?this.displayField.name:void 0,catalogId:this.catalogId?this.catalogId:void 0}},r.prototype._configureReports=function(t,i){for(var r=0;t&&r<t.length;r++)this.reports[r]=new e.essentials.Report(this.url+"/reports/"+t[r].id),this.reports[r].layer=this,this.mapService&&this.mapService.essentialsMap&&this.mapService.essentialsMap.site&&(this.reports[r].site=this.mapService.essentialsMap.site),this.reports[r]._configureObject(t[r],i)},r.prototype.getLayerTimeInfo=function(){var i=this;if(!this.mapService||!this.mapService.isTimeAware)return null;if(this._gcxTimeInfo)return this._gcxTimeInfo;var r=function(e){if(e)return i._timeInfo=e,i._gcxTimeInfo=t.MapService.getGcxTimeInfo(i._timeInfo),i._gcxTimeInfo};this._timeInfo?r(this._timeInfo):function(){if(i.mapService.serviceLayer&&i.mapService.serviceLayer.url){var t=i.mapService.serviceLayer.url+"/"+i.id;e.request({url:t,content:{f:"json"},load:function(e){return r(e.timeInfo)},error:function(e){console.log((e.message,e.message))},callbackParamName:"CallBack"})}}()},r.prototype.getObjectIdFieldName=function(){var e=null;return this.primaryKeyField&&(e=this.primaryKeyField.name),e},r.prototype._layerTypeStringToEssentialsLayerType=function(t){return"FeatureLayer"==t||"DynamicFeatureLayer"==t?e.essentials.LayerType.FEATURE_LAYER:"GroupLayer"==t||"AnnotationLayer"==t?e.essentials.LayerType.GROUP_LAYER:"RasterLayer"==t?e.essentials.LayerType.RASTER_LAYER:"GeoRssLayer"==t?e.essentials.LayerType.GEO_RSS_LAYER:"TableLayer"==t?e.essentials.LayerType.TABLE_LAYER:e.essentials.LayerType.UNKNOWN},r.prototype._essentialsLayerTypeToLayerTypeString=function(t){switch(t){case e.essentials.LayerType.FEATURE_LAYER:return"FeatureLayer";case e.essentials.LayerType.GROUP_LAYER:return"GroupLayer";case e.essentials.LayerType.RASTER_LAYER:return"RasterLayer";case e.essentials.LayerType.GEO_RSS_LAYER:return"GeoRssLayer";default:return"Unknown"}},r.prototype._getRelation=function(e){"string"==typeof e&&(e=parseInt(e));for(var t=0;t<this.relationships.length;t++)if(this.relationships[t].id==e)return this.relationships[t];return null},r.prototype.getDefinitionExpression=function(t){var i=null,r=parseInt(this.id);if(t)if(t instanceof esri.layers.ArcGISDynamicMapServiceLayer){var n=t.layerDefinitions;n&&n[r]&&(i=n[r])}else if(t instanceof esri.layers.FeatureLayer){var s=t.getDefinitionExpression();s&&(i=s)}return i||this.dynamicDefinition&&(i=e.essentials.RestHelper.getDynamicExpressionFromJson(this.dynamicDefinition)),i},r.prototype._createDynamicLayerInfo=function(){var t=null;return this.isDynamic&&(t=e.essentials.RestHelper.getDynamicLayerInfoFromJson(this.dynamicDefinition,this.id),this.minScale<1/0&&(t.minScale=this.minScale),this.maxScale>0&&(t.maxScale=this.maxScale)),t},r.prototype.getLayerDrawingOptions=function(){var t=null;return this.isDynamic&&(t=e.essentials.RestHelper.getLayerDrawingOptionsFromJson(this.dynamicDefinition)),t},r.prototype.getLayerThemeSettings=function(e){for(var t=0;t<this.layerThemeSettings.length;t++){var i=this.layerThemeSettings[t];if(i.theme===e||i.theme.id===e)return i}return null},r.prototype._syncProgramaticallyChangedLayerVisibility=function(e){this._visible=e},r}(t.AsyncInitializable);t.Layer=i}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){var t=function(){return function(){this.featureField=null,this.id=null,this.name=null,this.type=null}}();e.DataLinkParameter=t}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){var i=function(t){function i(e){t.call(this,e),this.displayName=null,this.extensions=[],this.id=null,this.visible=null,this.isOneToOne=!1,this.layer=null,this.parameters=[],this.searches=[],this.properties={},this._numDataLinkingRequests=0}return __extends(i,t),i.prototype.isDataLinking=function(){return!!this._numDataLinkingRequests},i.prototype.performDataLinking=function(t,i,r){var n=this,s=function(e){r&&r(new Error(e))};!t&&this.parameters.length>0&&s("No FeatureSetParameters provided");for(var a=this.url+"/link",o=null,l=0;l<this.parameters.length;l++){for(var c=this.parameters[l],u="",h=0;h<t.features.length;h++){var p=t.features[h],d=p.attributes[c.featureField];if(!d&&this.layer&&this.layer.fields){for(var f,y=0;y<this.layer.fields.length;y++){var m=this.layer.fields[y];if(m.name===c.featureField){f=m;break}}if(f){var g;f.alias&&f.alias in p.attributes?g=f.alias:f.displayName&&f.displayName in p.attributes&&(g=f.displayName),g&&g in p.attributes&&p.attributes[g]}}u+=(0===u.length?"":",")+(d?this._prepParamValue(d):" ")}u&&u.length>0&&((o=null===o?{}:o)[c.id]=u)}if(o){var v=e.encodeJson(dojo.mixin({f:"json"},o));this._numDataLinkingRequests++;e.request({url:a,content:v,load:function(e){n._numDataLinkingRequests--,!e&&r&&r(new Error("No results")),e.error&&r&&r(e.error),i&&i(n._parseConvertDates(e.results))},error:function(e){n._numDataLinkingRequests--,r&&r(e)},callbackParamName:"CallBack"})}else s("Missing Feature Fields.")},i.prototype._configureObject=function(t,i){if(void 0===t||void 0===t.displayName||void 0===t.parameters)throw new Error("Incorrect data link object returned from initialization");if(this.displayName=t.displayName,this.id=t.id,this.visible=void 0===t.visible||t.visible,this.isOneToOne=!!t.isOneToOne,this.parameters=t.parameters,this.searches=t.searches,this.searches)for(var r=0,n=this.searches.length;r<n;r++)this.searches[r].dataLink=this;i&&(this.isInitialized=!0),this.properties=e._getProperties(t.properties),this.extensions=e._getExtensions(t.extensions)},i.prototype._parseConvertDates=function(e){for(var t in e)if(e.hasOwnProperty(t)){var i=e[t];if("string"==typeof i){if(i.length>6&&"/Date("===i.substring(0,6)){i=parseInt(i.substring(6));var r=new Date(i);e[t]=r}}else"object"==typeof i&&(e[t]=this._parseConvertDates(i))}return e},i.prototype._prepParamValue=function(e){var t="";return"number"==typeof e?t=e.toString():"string"==typeof e&&(t=e.replace(/,/g,"\\,")),t},i}(t.AsyncInitializable);t.DataLink=i}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){!function(e){!function(e){e.AUTHOR_DESCRIPTION="author.description",e.AUTHOR_ISSUER_TITLE="author.issuerTitle",e.AUTHOR_TITLE="author.title",e.DESCRIPTION="description",e.EDITOR_DESCRIPTION="editor.description",e.EDITOR_ISSUER_TITLE="editor.issuerTitle",e.EDITOR_TITLE="editor.title",e.FILE_TYPE="fileType",e.GRANT_TOKEN="grants.token",e.ISSUER_TITLE="issuerTitle",e.TAGS="tags",e.TIME_CREATION="timeOfCreation",e.TIME_LAST_ACCESS="timeOfLastAccess",e.TIME_LAST_MODIFICATION="timeOfLastModification",e.TITLE="title"}(e.DocumentField||(e.DocumentField={}));!function(e){e.BLOB="application/octet-stream",e.JSON="application/json",e.TEXT="text/plain",e.XML="application/xml"}(e.ContentType||(e.ContentType={}));!function(e){e.BLOB="blob",e.JSON="json",e.TEXT="text",e.XML="xml"}(e.DocumentFormat||(e.DocumentFormat={}));!function(e){e.FROZEN="frozen",e.OWNER="owner",e.READER="reader",e.WRITER="writer",e.READER_LINK="readerLink",e.WRITER_LINK="writerLink",e.GLOBAL_CREATE="global_create",e.GLOBAL_READER="global_reader",e.GLOBAL_WRITER="global_writer"}(e.GrantKind||(e.GrantKind={}));!function(e){e.PUBLIC="public",e.USER="user"}(e.GrantID||(e.GrantID={}));!function(e){e.LINK="link",e.ROLE="role",e.USER="user",e.POLICY="policy"}(e.MonikerKind||(e.MonikerKind={}));!function(e){e.RANGES="ranges",e.SPATIAL_DISJOINT="spatialDisjoint",e.SPATIAL_INTERSECTS="spatialIntersects",e.SPATIAL_WITHIN="spatialWithin",e.MATCHES="matches",e.VALUES="values"}(e.FilterMethod||(e.FilterMethod={}));!function(e){e.REQUIRE="require",e.EXCLUDE="exclude",e.INCLUDE="include"}(e.FilterType||(e.FilterType={}))}(e.documents||(e.documents={}))}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){!function(i){i.LINK_QUERY_STRING_KEY="link";var r=function(){function r(){this._initializeDeferred=new dojo.Deferred,this.supported=!1,this.isInitialized=!1,this.self=[],this.userMonikers=[],this.policyMonikers=[],this.userFilter={}}return r.prototype.initialize=function(e){this._site=e;var i=/^(.*?)(\/*)$/.exec(e.originalUrl)[1];return this._rootUrl=t.utilities.UrlUtilities.simplify(i+"/../../documents"),this.supported=e.getEssentialsVersion()>=4.05,this.onInitializeAttempt()},r.prototype.onInitialized=function(){return this._initializeDeferred.promise},r.prototype.onInitializeAttempt=function(){var t=this;if(this._initializeAttemptThenable)return this._initializeAttemptThenable;if(!this.supported){var i=new Error("The Document Store is not supported in the current version of Essentials.");return this._initializeDeferred.reject(i),this._initializeAttemptThenable=(new dojo.Deferred).reject(i)}return this._initializeAttemptThenable=e.request({url:this._rootUrl+"/self",content:{f:"json"},handleAs:"json"},{usePost:!1}).then(r._processError).then(function(e){t._processSelf(e),t.isInitialized=!0,t._initializeDeferred.resolve()}).then(null,function(e){throw t._initializeAttemptThenable=null,e})},r.prototype.getRootUrl=function(){return this._verifySupported(),this._rootUrl+"/"},r.prototype.canCreate=function(){return this.userMonikers.length>0},r.prototype.hasPolicyGrant=function(e){return this.policyMonikers.some(function(t){return t.grants.some(e)})},r.prototype.add=function(e){var t=this,r={document:dojo.mixin({},e)};void 0!==e.content&&(r.json=e.content,delete r.document.content);var n=i.BatchRequestBuilder.writeDocument(r);return this.perform(n,!0).then(function(e){return e.document}).then(function(e){return t._processDocument(e)})},r.prototype.addFromFormData=function(e){throw new Error("Not implemented.")},r.prototype.addFromForm=function(e){throw new Error("Not implemented.")},r.prototype.getById=function(e,t,n){var s=this;if(void 0===t&&(t=!1),void 0===n&&(n=i.DocumentFormat.JSON),this._verifyDocId(e),t){var a=i.BatchRequestBuilder.readDocument(e,n);return this.perform(a).then(function(e){return r._processReadDocumentResponse(e,n)}).then(function(e){return s._processDocument(e)})}var o=i.BatchRequestBuilder.peekDocument(e);return this.perform(o).then(function(e){return e.document}).then(function(e){return s._processDocument(e)})},r.prototype.getContentUrl=function(e){throw new Error("Not implemented.")},r.prototype.updateById=function(e,t){var r=this;this._verifyDocId(e),t.timeOfLastModification||(t.timeOfLastModification=null),t.editor||(t.editor=null);var n=[];for(var s in t)t.hasOwnProperty(s)&&n.push(s);if(void 0!==t.content){var a={json:t.content};delete t.content,a.document=dojo.mixin({id:e,updates:n},t);var o=i.BatchRequestBuilder.writeDocument(a);return this.perform(o,!0).then(function(e){return e.document}).then(function(e){return r._processDocument(e)})}var l=dojo.mixin({id:e,updates:n},t),c=i.BatchRequestBuilder.updateDocument(l);return this.perform(c,!0).then(function(e){return e.document}).then(function(e){return r._processDocument(e)})},r.prototype.deleteById=function(e){var t=this;this._verifyDocId(e);var r=i.BatchRequestBuilder.deleteDocument(e);return this.perform(r,!0).then(function(e){return e.document}).then(function(e){return t._processDocument(e)})},r.prototype.query=function(e){var t=this,n=dojo.mixin({},e);n.sort&&n.sort.forEach(function(e,t,i){r.matchesFilterFields.some(function(t){return t===e})&&(i[t]="{0}_exact".format(e))}),n.sortDescending&&n.sortDescending.forEach(function(e,t,i){r.matchesFilterFields.some(function(t){return t===e})&&(i[t]="{0}_exact".format(e))});var s=i.BatchRequestBuilder.searchDocuments(n);return this.perform(s).then(function(e){return Array.isArray(e.matchingDocuments.results)&&e.matchingDocuments.results.forEach(function(e){return t._processDocument(e.entity)}),e.matchingDocuments})},r.prototype.perform=function(t,i){var n=this;if(void 0===i&&(i=!1),!t.action)throw new Error("The Document Store batch request does not contain an action");var s=t.action;return"perform"!==s&&delete t.action,this._guestLink&&(t.link=this._guestLink),t.f="json",this.onInitializeAttempt().then(function(){return n._verifySupported()}).then(function(){return e.request({url:n._rootUrl+"/"+s,content:e.encodeJson(t),handleAs:"json"},{usePost:i})}).then(r._processError)},r.prototype.isOwner=function(e){return!e||!e.access||e.access.change},r.prototype.isReadOnly=function(e){return!(!e||!e.access)&&(!!e.access.view&&!e.access.edit&&!e.access.change)},r.prototype.isPublic=function(e){return!!(e&&e.id&&e.grants)&&e.grants.some(function(e){return e.globalId===i.GrantID.PUBLIC&&(!1===e.revoke||!0===e.assert)})},r.prototype.setGuestLink=function(e){this._guestLink=e},r._processError=function(e){if(e.error)throw e.error;return e},r.prototype._processDocument=function(e){return e.timeOfCreation&&(e.timeOfCreation=new Date(e.timeOfCreation)),e.timeOfLastAccess&&(e.timeOfLastAccess=new Date(e.timeOfLastAccess)),e.timeOfLastModification&&(e.timeOfLastModification=new Date(e.timeOfLastModification)),e.timeOfDeletion&&(e.timeOfDeletion=new Date(e.timeOfDeletion)),e.timeOfExpiration&&(e.timeOfExpiration=new Date(e.timeOfExpiration)),e.access&&!e.access.monikerIds&&(e.access.monikerIds=this.userMonikers.map(function(e){return e.id})),e},r._processReadDocumentResponse=function(e,t){var i=e.content.document;return i.content=e.content[t],i},r.prototype._processSelf=function(e){if(this.self=e.monikers,this.userMonikers=e.monikers.filter(function(e){return e.kind===i.MonikerKind.USER}),this.policyMonikers=e.monikers.filter(function(e){return e.kind===i.MonikerKind.POLICY}),this.userMonikers.length>0){var t=this.userMonikers.map(function(e){return{string:"{0}|{1}".format(i.GrantKind.OWNER,e.globalId)}});this.userFilter={field:i.DocumentField.GRANT_TOKEN,method:i.FilterMethod.VALUES,range:t}}},r.prototype._verifyDocId=function(e){if(!e)throw new Error("The Document ID must be set.");if(/[/?#\s]/.test(e))throw new Error("The Document ID '{0}' contains illegal characters.".format(e))},r.prototype._verifySupported=function(){if(!this.supported)throw new Error("The Document Store is not supported in the current version of Essentials.")},r.matchesFilterFields=[i.DocumentField.TITLE,i.DocumentField.DESCRIPTION,i.DocumentField.ISSUER_TITLE,i.DocumentField.AUTHOR_TITLE,i.DocumentField.AUTHOR_DESCRIPTION,i.DocumentField.AUTHOR_ISSUER_TITLE,i.DocumentField.EDITOR_TITLE,i.DocumentField.EDITOR_DESCRIPTION,i.DocumentField.EDITOR_ISSUER_TITLE],r}();i.DocumentStore=r}(t.documents||(t.documents={}))}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){!function(e){!function(e){e.cloneDocument=function(e,t,i){return{action:"cloneDocument",id:e,document:t,createOnly:i}},e.createDocument=function(e,t){return{action:"createDocument",document:e,streamId:t}},e.createMoniker=function(e,t){return{action:"createMoniker",moniker:e,createOnly:t}},e.deleteDocument=function(e){return{action:"deleteDocument",id:e}},e.deleteMoniker=function(e){return{action:"deleteMoniker",id:e}},e.describe=function(e){return{action:"describe",streamId:e}},e.generateLinks=function(e){return{action:"generateLinks",count:e}},e.modifyDocument=function(e,t){return{action:"modifyDocument",document:e,streamId:t}},e.openDocument=function(e,t,i){return{action:"openDocument",id:e,streamId:t,startPosition:i}},e.peekDocument=function(e,t){return void 0===t&&(t=!1),{action:"peekDocument",id:e,throwIfMissing:t}},e.peekDocumentAccess=function(e){return{action:"peekDocumentAccess",id:e}},e.peekMoniker=function(e,t){return{action:"peekMoniker",id:e,throwIfMissing:t}},e.peekMonikerAccess=function(e){return{action:"peekMonikerAccess",id:e}},e.previewDocument=function(e,t){return{action:"previewDocument",id:e,streamId:t}},e.previewMoniker=function(e,t){return{action:"previewMoniker",id:e,streamId:t}},e.readDocument=function(e,t){return{action:"readDocument",id:e,format:t}},e.restoreDocument=function(e){return{action:"restoreDocument",globalId:e}},e.restoreMoniker=function(e){return{action:"restoreMoniker",globalId:e}},e.resumeDocument=function(e,t){return{action:"resumeDocument",globalId:e,streamId:t}},e.scrub=function(e){return{action:"scrub",scrubOptions:e}},e.searchDocuments=function(e){return{action:"searchDocuments",documentQuery:e}},e.searchMonikers=function(e){return{action:"searchMonikers",monikerQuery:e}},e.searchRoles=function(e){return{action:"searchRoles",searchClause:e}},e.searchUsers=function(e){return{action:"searchUsers",searchClause:e}},e.self=function(){return{action:"self"}},e.touchDocument=function(e,t,i){return{action:"touchDocument",id:e,modify:t,throwIfMissing:i}},e.updateDocument=function(e){return{action:"updateDocument",document:e}},e.updateMoniker=function(e){return{action:"updateMoniker",moniker:e}},e.writeDocument=function(e){return{action:"writeDocument",content:e}}}(e.BatchRequestBuilder||(e.BatchRequestBuilder={}))}(e.documents||(e.documents={}))}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){var t=function(){return function(e,t){void 0===t&&(t="Png"),this.defaultOutputFormat=t,this.allowIncludeGeoreferenceData=e}}();e.ExportMapImageOptions=t}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){!function(e){!function(e){e.PRODUCTION="Production"}(e.BingEnvironment||(e.BingEnvironment={}))}(e.exportMap||(e.exportMap={}))}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){var t=function(){function e(e,t,i,r){void 0===r&&(r=!1),this.rendererJson=e,this.displayName=t,this.id=i,this.enabled=r}return e.prototype.getRenderer=function(){var e=esri.renderer.fromJson(JSON.parse(this.rendererJson));return e instanceof esri.renderer.Renderer||console.error("Layer Style: '{0}'. Could not create a valid renderer from the stored JSON string: '{1}'".format(this.displayName,this.rendererJson)),e},e.prototype.setRenderer=function(e){e instanceof esri.renderer.Renderer?this.rendererJson=JSON.stringify(e.toJson()):esri.renderer.fromJson(JSON.parse(e))instanceof esri.renderer.Renderer?this.rendererJson=e:console.error("Layer Style: '{0}'. Supplied JSON string could not be used to create a valid renderer: '{1}'".format(this.displayName,e))},e.prototype.isSimple=function(){return"simple"===JSON.parse(this.rendererJson).type},e}();e.LayerStyle=t}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){var t=function(){return function(e){this.siteId=e}}();e.LayerCatalog=t}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){var i=function(t){function i(e){t.call(this,e),this.displayName=null,this.parameters=[],this.id=null,this.site=null,this.featureDescription=null,this.featureLabel=null,this.featureLongDescription=null,this.iconUri=null,this.includeInGlobalSearch=!1,this._searching=!1,this._onSearchingComplete=null,this._onSearchingError=null}return __extends(i,t),i.prototype._configureObject=function(t,i){if(void 0===t||void 0===t.id||void 0==t.displayName)throw new Error("Incorrect search table object returned from initialization");this.id=t.id,this.displayName=t.displayName,this.parameters=t.parameters,this.featureDescription=t.featureDescription,this.featureLabel=t.featureLabel,this.featureLongDescription=t.featureLongDescription,this.iconUri=e.essentials.RestHelper.processClientSideTokens(this.site,t.iconUri),this.includeInGlobalSearch=t.includeInGlobalSearch},i.prototype.isSearching=function(){return this._searching},i.prototype.performSearch=function(t,i,r){var n=this,s=function(e){n._searching=!1,r&&r(new Error(e))};t||s("No searchParameters provided"),this.isSearching()&&s("Currently performing a search"),this._searching=!0,this._onSearchingComplete=dojo.hitch(this,i),this._onSearchingError=dojo.hitch(this,r);var a=this.url+"/search",o="";for(var l in t)t.hasOwnProperty(l)&&(o+=(o?"&":"")+l+"="+t[l]);a+="?"+o,e.request({url:a,content:{f:"json"},handleAs:"json",load:dojo.hitch(this,this._searchRestComplete),error:dojo.hitch(this,this._searchRestError),callbackParamName:"CallBack"})},i.prototype._searchRestComplete=function(e){this._searching=!1,!e&&this._onSearchingError&&this._onSearchingError(new Error("No results")),e.error&&this._onSearchingError&&this._onSearchingError(e.error),this._onSearchingComplete&&this._onSearchingComplete(new esri.tasks.FeatureSet(e))},i.prototype._searchRestError=function(e){this._searching=!1,this._onSearchingError&&this._onSearchingError(e)},i}(t.AsyncInitializable);t.SearchTable=i}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){var t=function(){return function(){this.name=null,this.type=null}}();e.SearchTableParameter=t}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){!function(e){e[e.Extent=0]="Extent",e[e.Cumulative=1]="Cumulative",e[e.Instant=2]="Instant"}(e.TimeSliderMode||(e.TimeSliderMode={}));e.TimeSliderMode}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){var i=function(i){function r(e){i.call(this,e)}return __extends(r,i),r.prototype._configureObject=function(i,r){this.id=i.id,this.displayName=i.displayName,this.description=i.description,this.mode=t.TimeSliderMode[i.mode],this.displayFormat=i.displayFormat,this.timeExtent={startTime:t.utilities.StringUtilities.getDateFromRestDateString(i.startTime),endTime:t.utilities.StringUtilities.getDateFromRestDateString(i.endTime)},this.initialTimeExtent={startTime:t.utilities.StringUtilities.getDateFromRestDateString(i.initialStartTime),endTime:t.utilities.StringUtilities.getDateFromRestDateString(i.initialEndTime)},this.timeInterval=i.timeInterval,this.timeIntervalUnit=t.EssentialsTimeUnits[i.timeIntervalUnit],this.snapToTimeIntervals=i.snapToTimeIntervals,this.properties=e._getProperties(i.properties),this.extensions=e._getExtensions(i.extensions)},r}(t.AsyncInitializable);t.TimeSliderProfile=i}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){var t=function(){function e(){}return e.UNIT_CENTURIES="esriTimeUnitsCenturies",e.UNIT_DAYS="esriTimeUnitsDays",e.UNIT_DECADES="esriTimeUnitsDecades",e.UNIT_HOURS="esriTimeUnitsHours",e.UNIT_MILLISECONDS="esriTimeUnitsMilliseconds",e.UNIT_MINUTES="esriTimeUnitsMinutes",e.UNIT_MONTHS="esriTimeUnitsMonths",e.UNIT_SECONDS="esriTimeUnitsSeconds",e.UNIT_WEEKS="esriTimeUnitsWeeks",e.UNIT_YEARS="esriTimeUnitsYears",e.UNIT_UNKNOWN="esriTimeUnitsUnknown",e}();e.TimeUnits=t;var i=function(){function e(){}return e.Century=t.UNIT_CENTURIES,e.Day=t.UNIT_DAYS,e.Decade=t.UNIT_DECADES,e.Hour=t.UNIT_HOURS,e.MilliSecond=t.UNIT_MILLISECONDS,e.Minute=t.UNIT_MINUTES,e.Month=t.UNIT_MONTHS,e.Second=t.UNIT_SECONDS,e.Week=t.UNIT_WEEKS,e.Year=t.UNIT_YEARS,e}();e.EssentialsTimeUnits=i}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){!function(i){var r=function(){function i(){this.initialized=!1,this.supported=!1}return i.prototype.initialize=function(e){this._site=e,this._rootUrl=t.utilities.UrlUtilities.resolveUrl(e.url,"/../../../connections",!0),this.supported=e.getEssentialsVersion()>=4.05,this.initialized=!0},i.prototype.getRootUrl=function(){return this._rootUrl},i.prototype.suggestHints=function(e){var t={f:"json",term:e};return this.sendRequest("suggest",t).then(function(e){return e.hints})},i.prototype.findServices=function(e,t){var i=this,r={f:"json",term:e,whitelistOnly:!0};return t&&(r=dojo.mixin(r,t)),this.sendRequest("find",r).then(function(e){return Array.isArray(e.results)&&e.results.forEach(function(e){return i._processItem(e)}),e.results})},i.prototype.expandService=function(e){var t=this,i=this._getConnectionId(e),r={f:"json",providerName:e.serviceProviderName,url:e.url};return this.sendRequest(i+"/expand",r).then(function(e){return t._processItem(e)})},i.prototype.realizeMapService=function(e,t){var i=this,r=this._getConnectionId(e),n={f:"json",providerName:e.serviceProviderName,url:e.url,sr:t,itemId:e.id||"null"};return this.sendRequest(r+"/realize",n).then(function(t){return i._processMapService(t,e)})},i.prototype.sendRequest=function(i,r){var n=this;return e.framework.SimplePromise.resolve(null).then(function(){return n._verifyInitialized()}).then(function(){return n._verifySupported()}).then(function(){return r.f=r.f||"json",e.request({url:t.utilities.UrlUtilities.resolveUrl(n._rootUrl,i),content:e.encodeJson(r),handleAs:"json"})}).then(this._processError)},i.prototype._getConnectionId=function(e){return e.connection&&null!=e.connection.id?e.connection.id:"none"},i.prototype._processError=function(e){if(e&&e.error)throw e.error;return e},i.prototype._processItem=function(e){if(!e.thumbnailUrl){var i=this._getConnectionId(e)+"/preview?f=json&providerName="+e.serviceProviderName+"&url="+e.url;e.thumbnailUrl=t.utilities.UrlUtilities.resolveUrl(this._rootUrl,i)}if(e.children)for(var r=0,n=e.children;r<n.length;r++){var s=n[r];this._processItem(s)}return e},i.prototype._processMapService=function(i,r){var n,s=this._site,a=s.essentialsMap,o=r.url;if(i.drawingBehavior===e.essentials.DrawingBehavior.FEATURE_LAYER){if(!dojo.isObject(esri.layers.FeatureLayer))throw new Error("This Javascript application must // dojo.require the esri.layers.FeatureLayer package in order to use a site with feature layers");n=new t.FeatureLayerService(o)}else if(i.drawingBehavior===e.essentials.DrawingBehavior.GEORSS_LAYER){if(!dojo.isObject(esri.layers.GraphicsLayer))throw new Error("This Javascript application must // dojo.require the esri.layers.GraphicsLayer package in order to use a site with GeoRSS layers");n=new e.essentials.GeoRssLayerService(o)}else if(i.drawingBehavior===e.essentials.DrawingBehavior.KML_SERVICE){if(!dojo.isObject(esri.layers.KMLLayer))throw new Error("This Javascript application must // dojo.require the esri.layers.KMLLayer package in order to use a site with KML layers");n=new e.essentials.KmlService(o)}else n=new t.MapService(o);n.essentialsMap=a,n.initialize(i);for(var l=0,c=n.layers;l<c.length;l++){var u=c[l];if(u.isUserCreated=!0,u.includeInLayerList=!0,u.includeInLegend=!0,u.site=s,u.configuredVisible=!0,n.supportsLayerVisibility()?u.setVisibility(!0):u._visible=!0,u.subLayerIds&&u.subLayerIds.length>0)u.supportsIdentify=u.supportsQuery=u.identifiable=u.queryable=!1;else{u.identifiable=u.supportsIdentify,u.queryable=u.supportsQuery,u.searchable=!0,u.showMapTips=!0;var h=n.serviceLayer,p=h instanceof esri.layers.GraphicsLayer||h instanceof esri.layers.ArcGISDynamicMapServiceLayer;u.snappable=p,u.snappingEnabled=p}}return n},i.prototype._verifySupported=function(){if(!this.supported)throw new Error("Service Discovery is not supported in the current version of Geocortex Essentials.")},i.prototype._verifyInitialized=function(){if(!this.initialized)throw new Error("The Service Discovery client is not initialized yet.")},i}();i.SiteServiceDiscoveryProvider=r}(t.serviceDiscovery||(t.serviceDiscovery={}))}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){!function(e){!function(e){e.WEBTILED="WebTiledLayer",e.BINGAERIAL="BingMapsAerial",e.BINGAERIALLABELS="BingMapsAerialWithLabels",e.BINGROADS="BingMapsRoad",e.BINGHYBRID="BingMapsHybrid"}(e.ExportMapTypes||(e.ExportMapTypes={}))}(e.exportMap||(e.exportMap={}))}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){!function(i){var r=function(){function r(e){if(this.resource=null,this._esriMap=null,this._essentialsRestUrl=null,this._site=null,this._internalLayerIdsToRemove=["snapping_graphics","snapping_helper_graphics"],this._populateFromResource(e),!this._esriMap||!this._essentialsRestUrl)throw new Error("Unable to create ExportMapTask from the resource.")}return r.prototype._populateFromResource=function(e){e instanceof t.Map?(this._esriMap=e.getMap(),this._essentialsRestUrl=e.url+"/export",this._site=e.site):e instanceof t.PrintTemplate?(this._esriMap=e.site.getMap(),this._essentialsRestUrl=e.url+"/print",this._site=e.site):e instanceof t.Report&&(this._esriMap=e.site.getMap(),this._essentialsRestUrl=e.url+"/run",this._site=e.site)},r.prototype.generateMapImageUrl=function(t){var i=this,r=new dojo.Deferred;return this._marshalContent(t).then(function(t){var n={url:i._essentialsRestUrl,content:t,load:r.resolve,error:r.reject,callbackParamName:"CallBack"};e.request(n)}),r},r.prototype._getWebMap=function(e,t,i){var r=new esri.tasks.PrintTemplate;r.outScale=i;for(var n=[],s=0,a=t.graphicsLayerIds;s<a.length;s++){var o=a[s];1===(u=t.getLayer(o)).opacity&&(u.setOpacity(.999),n.push(u))}try{return e._getPrintDefinition(t,r)}finally{for(var l=0,c=n;l<c.length;l++){var u=c[l];u.setOpacity(1)}}},r.prototype._getPrintingObjectForEssentials=function(e){var t=new dojo.Deferred,i=new esri.tasks.PrintTask("http://3275ec4b-ad36-465e-97e9-a20acaae8d53/",{async:!1}),r=null;try{r=this._getWebMap(i,this._esriMap,e)}catch(e){t.reject(new Error("Could not create ExportContext definition. {0} Verify that subroutines have not changed.".format(e&&e.message?e.message:"Unable to determine cause.")))}return r?(this._removeInternalLayers(r),this._handleFeatureLayers(r),this._handleDynamicLayerDefs(r),this._cleanOutVisibility(r),this._handleWebTiledLayers(r),this._handleLayersAttribution(r,this._esriMap),this._handleHeatmapRenderer(r,this._esriMap),this._handleClusters(r,this._esriMap),this._adjustMeasurementsMarkup(r),this._adjustPlotCoordinatesMarkup(r),this._removeAttributes(r),this._adjustText(r),this._setServiceVisibilities(r),this._adjustPlotCoordinatesMarkupOrder(r),this._finalizePrintingContext(r),this._convertSymbolsToBase64(r).then(function(e){return t.resolve(e)},function(e){return t.reject(new Error("Converting symbols to base64 failed: {0}".format(e&&e.message?e.message:"Unable to determine cause")))})):t.reject(new Error("ExportContext definition was empty")),t},r.prototype._removeInternalLayers=function(e){for(var t=e.operationalLayers.length-1;t>=0;t--){var i=e.operationalLayers[t].id;i&&(this._internalLayerIdsToRemove.indexOf(i)>-1&&e.operationalLayers.splice(t,1))}},r.prototype._convertSymbolsToBase64=function(e){for(var i=new dojo.Deferred,r=[],n={},s=0;s<e.operationalLayers.length;s++){var a=e.operationalLayers[s];if(a.featureCollection&&a.featureCollection.layers)for(var o=0;o<a.featureCollection.layers.length;o++){var l=a.featureCollection.layers[o];if(l.featureSet&&l.featureSet.features)for(var c=0;c<l.featureSet.features.length;c++){var u=l.featureSet.features[c];if(u&&u.symbol&&"esriPMS"===u.symbol.type){var h=u.symbol;h.url&&r.push(h)}}}}if(Modernizr&&Modernizr.canvas){for(var p=[],s=0;s<r.length;s++){var d=r[s].url;if(d&&(!n.hasOwnProperty(d)&&!r[s].imageData)){n[d]={url:null,data:null};var f=t.utilities.PrintUtilities.getImageAsBase64(d);p.push(f)}}t.utilities.PromiseUtilities.settle(p).then(function(s){s.forEach(function(e){if(e.isFulfilled()){var i=e.value();i&&i.url&&i.data&&(n[i.url]={data:i.data})}else{var s=e.reason();s&&s.url&&(n[s.url]={url:t.utilities.UrlUtilities.simplify(d)})}for(var a=0;a<r.length;a++){var o=r[a],l=n[o.url];l&&(l.data?(o.imageData=l.data,delete o.url):l.url&&(o.url=l.url)),o.yoffset&&(o.yoffset=-1*o.yoffset)}}),i.resolve(e)})}else{for(s=0;s<r.length;s++)(d=r[s].url)&&(r[s].url=t.utilities.UrlUtilities.simplify(d));i.resolve(e)}return i},r.prototype._adjustMeasurementsMarkup=function(e){var t=this._getLayer(e,"_measurement");t&&t.id&&this._adjustSvgSymbols(t)},r.prototype._adjustPlotCoordinatesMarkup=function(e){var t=this._getLayer(e,"_coordinates");t&&t.id&&this._adjustSvgSymbols(t)},r.prototype._adjustPlotCoordinatesMarkupOrder=function(e){var t=this._getLayer(e,"_coordinates");if(t&&t.featureCollection&&t.featureCollection.layers)for(var i=null,r=null,n=0;n<t.featureCollection.layers.length;n++){var s=t.featureCollection.layers[n];if(s.layerDefinition&&("pointLayer"===s.layerDefinition.name?i=s:"textLayer"===s.layerDefinition.name&&(r=s)),i&&r){if(i.featureSet&&i.featureSet.features&&i.featureSet.features.length>0&&r.featureSet&&r.featureSet.features&&r.featureSet.features.length>0&&r.featureSet.features.length/i.featureSet.features.length==1.5){for(var a=[];i.featureSet.features.length>0;)a.push(r.featureSet.features.pop()),a.push(r.featureSet.features.pop()),a.push(r.featureSet.features.pop()),a.push(i.featureSet.features.pop()),a.push(i.featureSet.features.pop());i.featureSet.features=a.reverse()}break}}},r.prototype._getLayer=function(e,t){for(var i=0;i<e.operationalLayers.length;i++){var r=e.operationalLayers[i];if(r&&r.id&&r.id.indexOf(t)>-1&&r.featureCollection&&r.featureCollection.layers)return r}},r.prototype._adjustSvgSymbols=function(e){for(var t=e.id,i=[],r=this._esriMap.getLayer(t).graphics.filter(function(e){return!("simplemarkersymbol"!=e.symbol.type||!e.visible)}),n=0;n<r.length;n++)i.push(r[n].toJson());for(n=0;n<e.featureCollection.layers.length;n++)if("pointLayer"===e.featureCollection.layers[n].layerDefinition.name){e.featureCollection.layers[n].featureSet.features=i;break}},r.prototype._adjustText=function(e){for(var i=0;i<e.operationalLayers.length;i++){var r=e.operationalLayers[i];if(r&&r.id&&r.featureCollection&&r.featureCollection.layers){for(var n=!1,s=0;s<r.featureCollection.layers.length;s++){var a=r.featureCollection.layers[s];if(a&&a.layerDefinition&&"textLayer"===a.layerDefinition.name){n=!0;break}}if(!n)continue;var o=r.id,l=[],c=this._esriMap.getLayer(o);if(c&&c.graphics){for(var u=c.graphics.filter(function(e){return!(!("textsymbol"==e.symbol.type||e.symbol instanceof esri.symbol.TextSymbol)||!e.visible)}),h=0;h<u.length;h++){var p=u[h],d=t.utilities.PrintUtilities.adjustTextSymbol(p,c.id);if(d){var f=new esri.Graphic(p.toJson());f.symbol=d,l.push(f.toJson())}}for(h=0;h<r.featureCollection.layers.length;h++)"textLayer"===r.featureCollection.layers[h].layerDefinition.name&&(r.featureCollection.layers[h].featureSet.features=l)}}}},r.prototype._setServiceVisibilities=function(e){if(e.operationalLayers)for(var t=e.operationalLayers,i=0;i<t.length;i++){var r=t[i],n=this._esriMap.getLayer(r.id);r&&(r.visibility=!n||n.visible)}},r.prototype._handleDynamicLayerDefs=function(e){if(this._site&&e.operationalLayers)for(var t=e.operationalLayers,i=0;i<t.length;i++){var r=t[i].id,n=this._site.essentialsMap.findMapServiceById(r);if(n&&n.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer){var s=t[i],a=n.serviceLayer;if(!s)continue;if(s.layers){for(var o=[],l=s.layers,c=0;c<l.length;c++){var u=l[c];if(u&&(u.id||0===u.id)){var h=u.id,p={id:h,name:u.name,geometryType:u.geometryType?u.geometryType:null};if(u.layerDefinition&&((u.layerDefinition.drawingInfo||u.layerDefinition.source)&&(p.layerDefinition||(p.layerDefinition={}),p.layerDefinition.drawingInfo=u.layerDefinition.drawingInfo,p.layerDefinition.source=u.layerDefinition.source),u.layerDefinition.definitionExpression&&(p.layerDefinition?p.layerDefinition.definitionExpression=u.layerDefinition.definitionExpression:p.layerDef=u.layerDefinition.definitionExpression)),h||0===h){var d=n.findLayerById(h.toString());d&&d.displayName&&p.layerDefinition&&(p.layerDefinition.displayName=d.displayName)}o.push(p)}}s.layers=o}a.gdbVersion&&(s.gdbVersion=a.gdbVersion),s.visibleLayers=n.serviceLayer.visibleLayers,s.visibility=!0}}},r.prototype._handleFeatureLayers=function(e){if(this._site&&e.operationalLayers)for(var t=e.operationalLayers,i=0;i<t.length;i++){var r=t[i].id,n=this._site.essentialsMap.findMapServiceById(r);if(n&&n.serviceLayer instanceof esri.layers.FeatureLayer){var s=n.serviceLayer,a=t[i],o={id:r,opacity:a.opacity,visibility:!0,url:a.url,minScale:a.minScale?a.minScale:0,maxScale:a.maxScale?a.maxScale:0};s.gdbVersion&&(o.gdbVersion=s.gdbVersion),a.layerDefinition?(a.layerDefinition.drawingInfo&&(o.drawingInfo=a.layerDefinition.drawingInfo),a.layerDefinition.definitionExpression&&(o.where=a.layerDefinition.definitionExpression)):o.where=s.getDefinitionExpression(),o.featureCollection=a.featureCollection,t[i]=o}}},r.prototype._cleanOutVisibility=function(e){if(e.operationalLayers)for(var t=e.operationalLayers,i=0;i<t.length;i++)if(t[i].visibleLayers)for(var r=0;r<t[i].visibleLayers.length;r++)if(-1==t[i].visibleLayers[r]){t[i].visibleLayers.splice(r,1);break}},r.prototype._handleWebTiledLayers=function(e){if(e.operationalLayers)for(var t=e.operationalLayers,r=0;r<t.length;r++)t[r].type===i.ExportMapTypes.WEBTILED?t[r]={id:t[r].id,opacity:t[r].opacity,visibility:!0}:t[r].type!==i.ExportMapTypes.BINGAERIAL&&t[r].type!==i.ExportMapTypes.BINGAERIALLABELS&&t[r].type!==i.ExportMapTypes.BINGHYBRID&&t[r].type!==i.ExportMapTypes.BINGROADS||(t[r].type===i.ExportMapTypes.BINGAERIALLABELS&&(t[r].type=i.ExportMapTypes.BINGHYBRID),t[r]={id:t[r].id,opacity:t[r].opacity,visibility:!0,type:t[r].type,token:t[r].key,serverType:i.BingEnvironment.PRODUCTION})},r.prototype._handleLayersAttribution=function(e,t){var i=t.layerIds.concat(t.graphicsLayerIds),r=new RegExp(".*mapservices/([^/]*)/Attribution[^/]*");e.operationalLayers.forEach(function(e){for(var n in i)if(i.hasOwnProperty(n)){var s=i[n];if(e.id===s){var a=t.getLayer(s);if(a.hasAttributionData&&a.attributionDataUrl){var o=r.exec(a.attributionDataUrl);if(o&&o.length>1){var l=o[1];e.mapServiceId=l}}else!a.layerId||e.id.indexOf("-")>-1||(e.mapServiceId=a.layerId);break}}})},r.prototype._handleHeatmapRenderer=function(e,t){t.layerIds.concat(t.graphicsLayerIds).forEach(function(i){var r=t.getLayer(i);if(r.visible&&void 0!==r.renderer&&r.renderer instanceof esri.renderer.HeatmapRenderer)for(var n=r.minScale?r.minScale:0,s=r.maxScale?r.maxScale:0,a=r.getDefinitionExpression()?r.getDefinitionExpression():"",o=r.gdbVersion?r.gdbVersion:"",l=r.renderer.toJson(),c=r.url,u=r.renderer.field?r.renderer.field:"",h={renderer:l},p={type:"HeatMap",id:i,opacity:1,minScale:n,maxScale:s,where:a,gdbVersion:o,url:c,layerDefinition:{name:r.name,geometryType:"esriGeometryPoint",displayField:u},drawingInfo:h},d=0;d<e.operationalLayers.length;d++)if(e.operationalLayers[d].id.startsWith("null_image")){e.operationalLayers[d]=p;break}})},r.prototype._handleClusters=function(e,t){var i=t.layerIds.concat(t.graphicsLayerIds),r=[];e.operationalLayers.forEach(function(e,t,i){e.id.endsWith("-cluster")&&r.push(e.id)}),r.forEach(function(t){for(var i=0;i<e.operationalLayers.length;++i)if(e.operationalLayers[i].id===t){e.operationalLayers.splice(i,1);break}}),i.forEach(function(i){var r=t.getLayer(i);if(r.id.endsWith("-cluster")&&r.visible&&void 0!==r.renderer&&r.renderer instanceof esri.renderer.ClassBreaksRenderer&&r.featureLayer&&r.singleFeatureLayer){for(var n=r.featureLayer,s=n.id,a=r.url,o=r.renderer.attributeField,l=r.clusterRadius.get(),c=r.maxFeaturesInCluster.get(),u=r._clusterLabelColor,h=r.singleFeatureLayer.renderer.toJson(),p=r.renderer.toJson(),d=n.name,f=n.minScale?n.minScale:0,y=n.maxScale?n.maxScale:0,m=n.getDefinitionExpression()?n.getDefinitionExpression():"",g=n.gdbVersion?n.gdbVersion:"",v=0;v<e.operationalLayers.length;++v)if(e.operationalLayers[v].id===s){null===n.renderer&&e.operationalLayers.splice(v,1);break}if(0==r.singleFeatureLayer.graphics.length){var w={type:"Cluster",id:i,opacity:1,minScale:f,maxScale:y,where:m,gdbVersion:g,url:a,layerDefinition:{name:d,geometryType:"esriGeometryPoint",displayField:o},drawingInfo:{renderer:p,singleSymbolRenderer:h,labelColor:u,distance:l,maxFeaturesInCluster:c}};e.operationalLayers.splice(v,0,w)}}})},r.prototype._removeAttributes=function(e){if(e.operationalLayers)for(var t=0;t<e.operationalLayers.length;t++){var i=e.operationalLayers[t];if(i&&i.featureCollection&&i.featureCollection.layers)for(var r=0;r<i.featureCollection.layers.length;r++){var n=i.featureCollection.layers[r];if((!(n&&n.layerDefinition&&n.layerDefinition.drawingInfo&&n.layerDefinition.drawingInfo.renderer)||"uniqueValue"!==n.layerDefinition.drawingInfo.renderer.type&&"classBreaks"!==n.layerDefinition.drawingInfo.renderer.type)&&(n&&n.featureSet&&n.featureSet.features))for(var s=0;s<n.featureSet.features.length;s++){var a=n.featureSet.features[s];a&&a.attributes&&delete a.attributes}}}},r.prototype._finalizePrintingContext=function(e){this._fixMapServiceIds(e,this._esriMap,this._site)},r.prototype._fixMapServiceIds=function(e,t,i){if(e.operationalLayers&&t&&i)for(var r=e.operationalLayers,n=0;n<r.length;n++){var s=r[n].id,a=t.getLayer(s);if(a&&(a instanceof esri.layers.WMSLayer||a instanceof esri.layers.TiledMapServiceLayer)){for(var o=null,l=0;l<i.essentialsMap.mapServices.length;l++)if(i.essentialsMap.mapServices[l].serviceLayer==a){o=i.essentialsMap.mapServices[l];break}o&&(r[n].id=o.id)}}},r.prototype._marshalContent=function(t){var i,r=this,n=new dojo.Deferred;return t.reportParameters&&t.reportParameters.scale&&(i=parseFloat(t.reportParameters.scale.scale)),this._getPrintingObjectForEssentials(i).then(function(i){var s={f:"json",if:"WebMap,blankMap"};if(r._site&&(i.product="Geocortex Essentials "+r._site.currentVersion,r._site.displayTimeZoneId&&(s.displayTimeZoneId=r._site.displayTimeZoneId)),t.reportParameters){var a=t.reportParameters;if(i.mapOptions||(i.mapOptions={extent:null}),delete i.mapOptions.scale,a.scale){var o=parseFloat(a.scale.scale);o&&!isNaN(o)&&(i.mapOptions.scale=o)}a.targetSpatialReference&&(i.mapOptions.spatialReference=a.targetSpatialReference),a.extentType==e.essentials.ReportParameters.CURRENT_EXTENT&&r._esriMap?i.mapOptions.extent=r._esriMap.extent:a.extentType==e.essentials.ReportParameters.FULL_EXTENT&&r._site&&r._site.essentialsMap?i.mapOptions.extent=r._site.essentialsMap.fullExtent:a.extentType==e.essentials.ReportParameters.INITIAL_EXTENT&&r._site&&r._site.essentialsMap?i.mapOptions.extent=r._site.essentialsMap.initialExtent:a.extentType==e.essentials.ReportParameters.CUSTOM_EXTENT&&a.customExtent&&(i.mapOptions.extent=a.customExtent);var l={dpi:null,outputSize:[]};if(a.imageWidth?l.outputSize[0]=a.imageWidth:l.outputSize[0]=r._esriMap.width,a.imageHeight?l.outputSize[1]=a.imageHeight:l.outputSize[1]=r._esriMap.height,a.resolution?l.dpi=a.resolution.dpi:l.dpi=96,i.exportOptions=l,a.grid&&a.grid.id){var c={grid:a.grid.id};i.layoutOptions=c}if(a.fields&&a.fields.length>0)for(var u=0;u<a.fields.length;u++)s[a.fields[u].id]=a.fields[u].value;a.outputFormat&&(s.outputFormat=a.outputFormat),a.featureIds&&(s.featureIDs=a.featureIds.join(",")),a.includeGeoreferenceData&&(s.georef=a.includeGeoreferenceData),a.includeData&&(s.of=s.of?s.of+",includeData":"includeData")}t.queryParameters&&(s=dojo.mixin(t.queryParameters,s)).geometry&&(s.geometry=JSON.stringify(s.geometry)),t.operationParameters&&(s=dojo.mixin(t.operationParameters,s)),a.notificationEmailAddress&&(s.emailAddress=a.notificationEmailAddress),s.data=JSON.stringify(i),n.resolve(s)},function(e){return n.reject(new Error("Failed to serialize ExportContext content: {0}".format(e&&e.message?e.message:"Unable to determine cause")))}),n},r}();i.ExportMapTask=r}(t.exportMap||(t.exportMap={}))}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){!function(e){var t=function(){function e(){this.state={fulfilled:!1,rejected:!1}}return e.prototype.fulfill=function(e){this.state.fulfilled=!0,this.state.value=e},e.prototype.reject=function(e){this.state.rejected=!0,this.state.reason=e},e.prototype.isFulfilled=function(){return this.state.fulfilled},e.prototype.isRejected=function(){return this.state.rejected},e.prototype.isPending=function(){return!this.state.fulfilled&&!this.state.rejected},e.prototype.value=function(){return this.state.value},e.prototype.reason=function(){return this.state.reason},e}(),i=function(){function e(){}return e.settle=function(t){if(dojo.isArray(t))return e._settleImpl(t);if(t.then)return t.then(function(t){return e._settleImpl(t)});throw new Error("Unknown parameter type.  Must be an array of promises or a promise of array of promises.")},e._settleImpl=function(e){var i,r=new dojo.Deferred,n=e.map(function(e){var r=new t;return e&&"function"==typeof e.then?e.then(function(e){r.fulfill(e),i&&i()},function(e){r.reject(e),i&&i()}):r.fulfill(e),r});return(i=function(){n.every(function(e){return!e.isPending()})&&r.resolve(n)})(),r.promise},e}();e.PromiseUtilities=i}(e.utilities||(e.utilities={}))}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){var t=function(){return function(){}}();e.EssentialsLayerInfo=t}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){!function(e){function t(){}var i=function(){function e(){}return e.prototype.select=function(t){var i=this,r=new e;return r._subscribe=function(e){var r=!0,n={onNext:function(i){if(r)try{e.onNext(t(i))}catch(t){r=!1,e.onError(t)}},onError:function(t){r&&(r=!1,e.onError(t))},onCompleted:function(){r&&(r=!1,e.onCompleted())}},s=i._subscribe(n);return r?s:(s.dispose(),{dispose:function(){}})},r},e.prototype._subscribe=function(e){return{dispose:t}},e.prototype.subscribe=function(e,i,r){if(arguments.length>1){n={onNext:e||t,onError:i||t,onCompleted:r||t};return this._subscribe(n)}if(e instanceof Function){if(e.length>1){n={onNext:function(t){return e(t)},onError:function(t){return e(void 0,t)},onCompleted:function(){return e()}};return this._subscribe(n)}var n={onNext:e,onError:i||t,onCompleted:r||t};return this._subscribe(n)}return e?this._subscribe(e):this._subscribe({onNext:t,onError:t,onCompleted:t})},e}();e.AnonymousObservable=i}(e.Rx||(e.Rx={}))}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(t){!function(i){function r(e,t){u||((c=document.head.getElementsByTagName("base")[0])||((c=document.createElement("base")).setAttribute("href",window.location.href),document.head.appendChild(c)),u=document.createElement("a"));try{var i=c.getAttribute("href");c.setAttribute("href",e),u.setAttribute("href",t),t=u.href}finally{c.setAttribute("href",i)}return t}function n(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];for(var r=e.length,n=0;n<t.length;n++){var s=e.indexOf(t[n]);s>=0&&s<r&&(r=s)}return s}function s(e){var t=n(e,"?","!","#");return{query:e.substring(0,t),tail:e.substring(t)}}var a=function(){function e(){}return e.prototype.toString=function(){return this.message},e}();i.ServiceRequestError=a,a.prototype.message="An error occurred while performing the operation.",a.prototype.details=new Array,a.prototype.name="ServiceRequestError";var o=function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t}(a);i.ServiceRequestAbortedError=o,o.prototype.message="The request was aborted.",o.prototype.name="ServiceRequestAbortedError";var l=function(){function i(){}return i.prototype.start=function(){try{this.promise=t.request(this),this.valid?this.registration=this.servicePoint.cancellationToken.register(this.error.bind(this)):this.promise.cancel()}catch(e){this.error(e)}},i.prototype.load=function(e){try{if(this.member){var t=e[this.member];if(t)for(var i=0;i<t.length&&this.valid;i++)this.observer.onNext(t[i])}else this.valid&&this.observer.onNext(e);this.complete()}catch(e){this.error(e)}},i.prototype.error=function(t){this.valid&&(this.valid=!1,this.promise.cancel(),this.registration.dispose(),this.observer.onError(e||new o))},i.prototype.complete=function(){this.valid&&(this.valid=!1,this.promise.cancel(),this.registration.dispose(),this.observer.onCompleted())},i.prototype.dispose=function(){this.valid&&(this.valid=!1,this.promise.cancel(),this.registration.dispose())},i}();l.prototype.handleAs="json",l.prototype.valid=!0,l.prototype.registration={dispose:function(){}};var c,u,h=function(){function e(){}return e.prototype.formatQuery=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];var n=s(e.format.apply(e,t));return r(this.baseAddress,n.query)+n.tail},e.prototype.getRequest=function(e,t){var r=function(e){this.observer=e,this.start()};(r.prototype=new l).servicePoint=this,r.prototype.query=e,r.prototype.member=t;var n=new i.Rx.AnonymousObservable;return n._subscribe=function(e){return new r(e)},n},e}();i.ServicePoint=h,h.prototype.baseAddress=window.location.href,h.prototype.cancellationToken={dispose:function(){},register:function(e){return this}}}(t.essentials||(t.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){var t=function(){function e(){this.extent=null,this.maxResults=50,this.contains=!0,this.returnGeometry=!1,this.returnHighlights=!1,this.returnIdsOnly=!1,this.returnCountOnly=!1,this.searchText=null,this.outSpatialReference=null}return e.prototype.toJson=function(e,t){if(!e||!t)throw new Error("Search query parameter creation is missing a main map.");var i={searchText:this.searchText,contains:this.contains,returnGeometry:this.returnGeometry,returnHighlights:this.returnHighlights,returnIdsOnly:this.returnIdsOnly,returnCountOnly:this.returnCountOnly};this.extent&&(i.envelope="{0},{1},{2},{3}".format(this.extent.xmin,this.extent.ymin,this.extent.xmax,this.extent.ymax)),(this.returnGeometry||this.extent)&&this.outSpatialReference&&(i.outSR=this.outSpatialReference.toJson()),this.maxResults>0&&(i.maxResults=this.maxResults);var r=this.searchLayers;return r&&0!=r.length||(r=t.allLayers()),i.layers=this._getServiceStrings(r),i},e.prototype._getServiceStrings=function(e){for(var t="",i={},r=0;r<e.length;r++){var n=e[r];if(n&&n.searchable&&n.mapService&&n.mapService.instantSearch){var s=n.mapService.id;i.hasOwnProperty(s)||(i[s]=[]),i[s].push(n.id)}}for(var a in i)i.hasOwnProperty(a)&&(t+=0===t.length?"":";",t+="{0}(include:{1})".format(a,i[a].join(",")));return t},e}();e.SearchQuery=t}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){var t=function(){return function(e){this.features=[],this.layer=null,e&&e.hasOwnProperty("features")&&(this.features=e.features),e&&e.hasOwnProperty("layer")&&(this.layer=e.layer)}}();e.SearchResultSet=t}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){var t=function(){return function(e,t){this.esriFeature=null,this.layer=null,this.highlights={},this.esriFeature=e,this.layer=t}}();e.SearchResultFeature=t}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){!function(t){var i=function(){function t(e){this.service=e}return t.prototype.postProcess=function(e){e.thumbnailUrl||(e.thumbnailUrl=this.service.formatQuery("connections/{0}/preview?f=json&providerName={1}&url={2}",e.connection.id,e.serviceProviderName,e.url));for(var t in e.children)this.postProcess(e.children[t]);return e},t.prototype.findServices=function(e){var t=this.postProcess.bind(this.postProcess),i=this.service.formatQuery("connections/find?f=json&term={0}",e);return this.service.getRequest(i,"results").select(t)},t.prototype.expandService=function(e,t,i){if(1==arguments.length){var r=e;e=r.connection.id,t=r.serviceProviderName,i=r.url}var n=this.postProcess.bind(this.postProcess),s=this.service.formatQuery("connections/{0}/expand?f=json&providerName={1}&url={2}",e,t,i);return this.service.getRequest(s,null).select(n)},t.prototype.suggestHints=function(e){var t=this.service.formatQuery("connections/suggest?f=json&term={0}",e);return this.service.getRequest(t,"hints")},t.prototype.realizeMapService=function(t,i,r,n){if(1==arguments.length){var s=t;t=s.connection.id,i=s.serviceProviderName,r=s.url}var a=this.service.formatQuery("connections/{0}/realize?f=json&providerName={1}&url={2}&sr={3}",t,i,r,n);return this.service.getRequest(a,null).select(function(t){if(t.serviceType.indexOf("FeatureLayer")>=0){var i=new e.FeatureLayerService(r);return i._configureObject(t,!0),i}var n=new e.MapService(r);return n._configureObject(t,!0),n})},t}();t.ServiceDiscoveryServicePoint=i}(e.serviceDiscovery||(e.serviceDiscovery={}))}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){!function(e){var t=function(){function e(){}return e.simplify=function(e){var t=document.createElement("a");t.href=e;var i=t.href,r=i.charAt(i.length-1);return"/"!==r&&"\\"!==r||(i=i.substr(0,i.length-1)),i},e.getUrlComponents=function(e){var t=document.createElement("a");return t.href=e,{host:t.host,hostname:t.hostname,protocol:t.protocol,port:t.port,query:t.search,hash:t.hash,path:t.pathname,origin:t.protocol+"//"+t.host}},e.resolveUrl=function(t,i,r){void 0===r&&(r=!1);var n=""+t+(t.endsWith("/")?"":"/")+i;return r&&(n=e.simplify(n)),n},e}();e.UrlUtilities=t}(e.utilities||(e.utilities={}))}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){!function(t){var i=function(){return function(){this.operationParameters=null,this.reportParameters=null,this.queryParameters=null,this.operationParameters={},this.reportParameters=new e.ReportParameters}}();t.ExportMapParameters=i}(e.exportMap||(e.exportMap={}))}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){!function(t){var i=function(t){function i(i,r){t.call(this,i,r),this.formItemType="MarkdownFormItem",this.plainText=i?new Observable(e.forms.getElementText(i,"PlainText")):new Observable("")}return __extends(i,t),i.prototype._render=function(){return e.forms.renderFormItem(this)},i}(t.AbstractFormItem);t.MarkdownFormItem=i}(t.items||(t.items={}))}(e.forms||(e.forms={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){var t=function(){return function(e,t){this.runtimeTypeName=null,this.runtimeTypeName=e||null,this.value=t||null}}();e.ArgumentValueWrapper=t}(e.workflow||(e.workflow={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){!function(t){var i=function(){function t(){}return t.createFeatureLayerFromCsv=function(t,i){var r=new dojo.Deferred;if(!t)return r.resolve(null),r;var n=new dojox.data.CsvStore({url:t.url,separator:t.columnDelimiter||","});return n.fetch({onComplete:function(s,a){var o,l,c=0,u=t.layerDefinition,h={layerDefinition:u,featureSet:{features:[],geometryType:"esriGeometryPoint"}},p=null,d=null;i&&(p=i.lowerBound||0,d=i.upperBound||s.length),(p||d)&&(s=s.slice(p,d)),dojo.forEach(s,function(e,i){0===i&&t.locationInfo&&(o=t.locationInfo.latitudeFieldName,l=t.locationInfo.longitudeFieldName);n.getIdentity(e);var r=n.getAttributes(e),s={};dojo.forEach(r,function(t){var i=Number(n.getValue(e,t));isNaN(i)?s[t]=n.getValue(e,t):s[t]=i}),s.__OBJECTID=c,c++;var a=parseFloat(s[o]),u=parseFloat(s[l]);if(!isNaN(a)&&!isNaN(u)){var p={geometry:new esri.geometry.Point(u,a).toJson(),attributes:s};h.featureSet.features.push(p)}});var f=new esri.layers.FeatureLayer(h),y=null;u&&u.drawingInfo&&u.drawingInfo.renderer&&u.drawingInfo.renderer.symbol&&"esriPMS"===u.drawingInfo.renderer.symbol.type&&(y=u.drawingInfo.renderer.symbol),null!=y&&(f.renderer.symbol.imageData=y.imageData,f.renderer.symbol.url=y.url),t.title&&(f.name=t.title),f.layerId=t.id||e.framework.utils.alphaNumericToken(),r.resolve(f)}}),r},t.decomposeFeatureLayerUrl=function(e){var t=/(.+?)\/([0-9]*)(\?.*)?$/g.exec(e);return{serviceUrl:t[1],layerId:parseInt(t[2]),queryString:t[3]}},t}();t.LayerUtilities=i}(t.utilities||(t.utilities={}))}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){var t=function(){return function(){this.error=null,this.results=[],this.queryParams=null}}();e.SearchResults=t}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){!function(e){var t=function(){return function(){this.id=null,this.displayName=null,this.entries=null,this.type=null,this.entries=[]}}();e.CatalogEntry=t}(e.catalog||(e.catalog={}))}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){!function(e){var t=function(){return function(){this.ids=null,this.ids=[]}}();e.LayerCatalogDetailsParams=t}(e.catalog||(e.catalog={}))}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){!function(e){var t=function(){return function(){}}();e.LayerCatalogParams=t}(e.catalog||(e.catalog={}))}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){!function(e){var t=function(){return function(){this.mapServiceId=null,this.entries=null,this.entries=[]}}();e.LayerCatalogDetail=t}(e.catalog||(e.catalog={}))}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){var t=function(){function e(){}return e.DEFAULT="Default",e.SHOW="Show",e.HIDE="Hide",e}();e.RefreshVisibility=t}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){!function(e){var t=function(){function e(){}return e.adjustTextSymbol=function(e,t){if(e&&e.symbol instanceof esri.symbol.TextSymbol){var i=function(e,t){t.font.size=void 0!=e.font.size&&"number"==typeof e.font.size?Math.round(e.font.size)+"px":e.font.size,t.x=e.x,t.y=e.y,t.xoffset=e.xoffset,t.yoffset=e.yoffset,t.align=e.align,t.angle=e.angle,t.color.hasOwnProperty("a")&&(t.color.a=e.color.a>=0&&e.color.a<=1?255*e.color.a:e.color.a)},r=new esri.symbol.TextSymbol(e.symbol.toJson());if(r.color=new esri.Color({r:e.symbol.color.r,g:e.symbol.color.g,b:e.symbol.color.b,a:e.symbol.color.a}),i(e.symbol,r),r.toJson&&"function"==typeof r.toJson){var n=r.toJson;r.toJson=function(){var e=n.call(r);return i(r,e),e}}var s=null,a=null;if(t){var o=document.getElementById(t+"_layer"),l=null;(l=document.createElementNS("http://www.w3.org/2000/svg","text")).setAttributeNS(null,"font-size",r.font.size),l.setAttributeNS(null,"font-family",r.font.family),l.setAttributeNS(null,"visibility","hidden"),l.textContent=r.text,o.appendChild(l);var c=l.getBBox();a=null===a?c.height:a,s=null===s?l.getComputedTextLength():s,o.removeChild(l)}else{var u=document.body,h=document.createElement("div"),p={fontFamily:r.font.family,fontSize:r.font.size,fontWeight:r.font.weight,padding:"0",position:"absolute",lineHeight:"1",visibility:"hidden"};for(var d in p)h.style[d]=p[d];h.appendChild(document.createTextNode(r.text)),u.appendChild(h),s=h.clientWidth,a=h.clientHeight,u.removeChild(h)}if(r.xoffset=0===r.angle?r.xoffset:0,r.yoffset=0===r.angle?r.yoffset:0,(e.measurementId||e.coordinateId)&&e.attributes&&e.attributes.numberOfLines){if(e.measurementId?r.xoffset=-(s/2+a/4):r.xoffset=-(s/4+a/2),r.yoffset=e.attributes.numberOfLines&&1==e.attributes.numberOfLines?a/2:r.yoffset,"start"==r.verticalAlignment&&e.attributes.numberOfLines&&e.attributes.numberOfLines>1){var f=e.attributes.numberOfLines;r.yoffset=r.yoffset-.5*a/2+a*f/2}}else{switch(r.verticalAlignment){case"top":break;case"middle":r.yoffset+=a/2;break;default:r.yoffset+=.75*a}e.attributes&&e.attributes.customVerticalAlignment&&"middle"===e.attributes.customVerticalAlignment&&(r.xoffset=0,r.yoffset=0,r.yoffset+=Math.ceil(a/2));var y=r.horizontalAlignment||r.align||null;if(y)switch(y){case esri.symbol.TextSymbol.ALIGN_MIDDLE:case"center":case"justify":r.xoffset-=Math.ceil(s/2),e.coordinateId||(r.xoffset-=Math.ceil(a/4));break;case esri.symbol.TextSymbol.ALIGN_END:case"right":r.xoffset-=s}}return r}return null},e.adjustPictureMarkerSymbol=function(e){if(e&&e.symbol instanceof esri.symbol.PictureMarkerSymbol){var t=new esri.symbol.PictureMarkerSymbol(e.symbol.toJson());if(t.toJson&&"function"==typeof t.toJson){var i=t.toJson;t.toJson=function(){var e,r,n=i.call(t);return n.color=[0,0,0,255],isNaN(e=parseInt(t.width,10))||isNaN(r=parseInt(t.height,10))||(n.width=e,n.height=r,n.xoffset=isNaN(parseInt(n.xoffset))?e/2:n.xoffset+e/2,n.yoffset=isNaN(parseInt(n.yoffset))?r/2:n.yoffset-r/2),n}}return t}return null},e.getImageAsBase64=function(e,t){void 0===t&&(t="image/png");var i=new dojo.Deferred,r=document.createElement("canvas"),n=r.getContext("2d"),s=new Image;return s.onload=function(){r.height=s.height,r.width=s.width,n.drawImage(s,0,0);try{var a=r.toDataURL(t);i.resolve({url:e,data:a.replace(/^data:image\/(png|jpg);base64,/,"")})}catch(t){i.reject({url:e,error:t})}},s.onerror=function(t){i.reject({url:e,error:new Error("Failed to download image.")})},s.src=e,i},e}();e.PrintUtilities=t}(e.utilities||(e.utilities={}))}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){var t=function(){function e(){}return e.prototype.toJson=function(){return JSON.stringify(this)},e}();e.EssentialsFeatureSet=t}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){var i=function(){function t(t,i){this.layer=null,e.charting&&dojo.isObject(e.charting.configuration.ChartDefinition)&&(t&&(this.id=t.id,this.displayName=t.displayName,this.defaultChart=t.defaultChart,this.chartFeatureType=t.chartFeatureType,this.chartDefinition=new e.charting.configuration.ChartDefinition(t.chartDefinition),this.chartDefinition.id=this.id,this.chartDefinition.displayName=this.displayName),i&&(this.layer=i,this._setFieldDisplayNames(this.chartDefinition,i)))}return t.prototype._setFieldDisplayNames=function(t,i){if(i&&t){for(var r={},n=0;n<i.fields.length;n++){var s=i.fields[n];s&&(r[s.name]=s.displayName)}t.category.field.sourceType==e.charting.ChartFieldSourceType.Field&&(t.category.field.displayName=r[t.category.field.name]||t.category.field.name);for(var a=0;a<t.series.length;a++){var o=t.series[a];o&&o.field.sourceType==e.charting.ChartFieldSourceType.Field&&(o.field.displayName=r[o.field.name]||o.field.name)}}},t}();t.LayerChart=i}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){var t=function(){return function(e,t,i,r){this.label=new Observable(e),this.value=new Observable(t),this.isDefault=new Observable(r||!1),this.causesValidation=new Observable(i)}}();e.FormButton=t}(e.forms||(e.forms={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){!function(t){!function(t){var i=function(){function t(t){this.message=e.forms.getElementText(t,"Message")}return t.prototype.validate=function(e){throw new Error("Abstract method")},t}();t.ValidationItem=i}(t.validation||(t.validation={}))}(t.items||(t.items={}))}(e.forms||(e.forms={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){!function(t){var i=function(t){function i(i,r){var n=this;t.call(this,i,r),this.formItemType="CheckBoxFormItem",i?(this.text=new Observable(e.forms.getElementText(i,"Text")),this.checked=new Observable(e.forms._parseBoolean(e.forms.getElementText(i,"Checked"))),this.textLocation=new Observable(e.forms.getElementText(i,"TextLocation"))):(this.text=new Observable(""),this.checked=new Observable(!1),this.textLocation=new Observable("Right")),this.checked.bind(null,function(e){return n._notifyResultChanged()})}return __extends(i,t),i.prototype.getResult=function(){return new e.forms.items.FormItemResult(this.argumentName.get(),this.checked.get())},i.prototype._render=function(){return e.forms.renderFormItem(this)},i}(t.AbstractFormItem);t.CheckBoxFormItem=i}(t.items||(t.items={}))}(e.forms||(e.forms={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){var t=function(){return function(e,t,i,r,n,s){this.instanceId=e,this.status=t,this.pendingExternalActivities=i,this.outputs=r,this.workflowData=n,this.instanceData=s}}();e.WorkflowState=t}(e.workflow||(e.workflow={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){var i=function(){function t(e,t,i,r){this.activityComplete=null,this._dispatcher=e,this._pendingIndex=t,this._workflow=i,this._workflowState=r}return t.prototype.dispatcher=function(){return this._dispatcher},t.prototype.workflow=function(){return this._workflow},t.prototype.getDisplayName=function(){return this._workflowState?this._workflowState.pendingExternalActivities[this._pendingIndex].displayName:""},t.prototype.getInputNames=function(){var e=[];if(this._workflowState)for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].inputs,i=0;i<t.length;i++)e.push(t[i].name);return e},t.prototype.getInputNamesByType=function(e){var t=[];if(this._workflowState)for(var i=this._workflowState.pendingExternalActivities[this._pendingIndex].inputs,r=0;r<i.length;r++)0===i[r].typeName.indexOf(e)&&t.push(i[r].name);return t},t.prototype.getOutputNames=function(){var e=[];if(this._workflowState)for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].outputs,i=0;i<t.length;i++)e.push(t[i].name);return e},t.prototype.getOutputNamesByType=function(e){var t=[];if(this._workflowState)for(var i=this._workflowState.pendingExternalActivities[this._pendingIndex].outputs,r=0;r<i.length;r++)0===i[r].typeName.indexOf(e)&&t.push(i[r].name);return t},t.prototype.getSite=function(){return null!=this._workflow?this._workflow.site:null},t.prototype.getEsriMap=function(){return null!=this._workflow&&null!=this._workflow.site?this._workflow.site.getMap():null},t.prototype.getValue=function(e){if(this._workflowState)for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].inputs,i=0;i<t.length;i++)if(t[i].name==e)return t[i].value;return null},t.prototype.getOutputValue=function(e){if(this._workflowState)for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].outputs,i=0;i<t.length;i++)if(t[i].name==e)return t[i].value;return null},t.prototype.getJsonValue=function(e){for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].inputs,i=0;i<t.length;i++)if(t[i].name==e)return JSON.stringify(t[i].value);return null},t.prototype.getOutputJsonValue=function(e){if(this._workflowState)for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].outputs,i=0;i<t.length;i++)if(t[i].name==e){var r=t[i].value;return r&&1===r.length&&(r=r[0]),JSON.stringify(r)}return null},t.prototype.setValue=function(t,i,r){if(this._workflowState){var n=!1,s=this._workflowState.pendingExternalActivities[this._pendingIndex].outputs,a=this._getRuntimeType(i);i&&i instanceof e.workflow.ArgumentValueWrapper&&(a=i.runtimeTypeName,i=i.value);for(var o=0;o<s.length;o++)if(s[o].name==t){n=!0,(l=s[o])&&(l.value=i,null!=a&&(l.runtimeTypeName=a));break}if(!n&&r){a||(a="System.Object");var l=new e.workflow.ArgumentInfo;l.isRequired=!1,l.name=t,l.value=i,l.typeName=a,l.runtimeTypeName=a,this._workflowState.pendingExternalActivities[this._pendingIndex].outputs.push(l)}}},t.prototype.getActivityTypeName=function(){var e="";if(this._workflowState&&(e=this._workflowState.pendingExternalActivities[this._pendingIndex].typeName)){var t=e.indexOf("`");t>=0&&(e=e.substring(0,t))}return e},t.prototype.getActivityExternalId=function(){return this._workflowState?this._workflowState.pendingExternalActivities[this._pendingIndex].externalId:""},t.prototype.getInputArgumentTypeName=function(e){if(this._workflowState)for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].inputs,i=0;i<t.length;i++)if(t[i].name==e)return t[i].typeName;return""},t.prototype.getInputArgumentRuntimeTypeName=function(e){for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].inputs,i=0;i<t.length;i++)if(t[i].name==e)return t[i].runtimeTypeName;return""},t.prototype.completeActivity=function(){if(this._workflowState){var t=this._workflowState.pendingExternalActivities[this._pendingIndex];if(t.isComplete)return;var i=this;"debugger"==this.getActivityExternalId()||t&&t.debug?e.workflow.DefaultActivityHandlers.showDebug(this,!1,function(){i._completeActivityInternal()}):this._completeActivityInternal()}},t.prototype.abortActivity=function(){if(this._workflowState){var e=this._workflowState.pendingExternalActivities[this._pendingIndex];e.isAborted=!0,this._workflowState.status="Aborted: "+e.displayName}null!=this._dispatcher&&this._dispatcher.activityAbort(this)},t.prototype._completeActivityInternal=function(){if(this._workflowState){var t=this._workflowState.pendingExternalActivities[this._pendingIndex];t.isComplete=!0,null!=this._dispatcher&&this._dispatcher.activityComplete(this),t.inputs=null;var i=this._workflowState.pendingExternalActivities[this._pendingIndex].syncToken,r=!0;if(""!=i)for(var n=this._workflowState.pendingExternalActivities,s=0;s<n.length;s++)if(n[s].syncToken==i&&!n[s].isComplete){r=!1;break}r&&(e.workflow.WorkflowControllerProxy._executeWorkflow(this._workflow,this._dispatcher,this._workflowState,null,this),dojo.isFunction(this.activityComplete)&&this.activityComplete(this))}},t.prototype._getRuntimeType=function(e){var t="System.Object";return e&&("function"==typeof e.isInstanceOf?e.isInstanceOf(esri.geometry.Extent)?t="ESRI.ArcGIS.Client.Geometry.Envelope":e.isInstanceOf(esri.geometry.Extent)?t="ESRI.ArcGIS.Client.Geometry.Envelope":e.isInstanceOf(esri.geometry.Point)?t="ESRI.ArcGIS.Client.Geometry.MapPoint":e.isInstanceOf(esri.geometry.Multipoint)?t="ESRI.ArcGIS.Client.Geometry.MultiPoint":e.isInstanceOf(esri.geometry.Polygon)?t="ESRI.ArcGIS.Client.Geometry.Polygon":e.isInstanceOf(esri.geometry.Polyline)?t="ESRI.ArcGIS.Client.Geometry.Polyline":e.isInstanceOf(esri.geometry.Geometry)?t="ESRI.ArcGIS.Client.Geometry.Geometry":e.isInstanceOf(esri.layers.LayerDataSource)?t="ESRI.ArcGIS.Client.LayerDataSource":e.isInstanceOf(esri.layers.LayerMapSource)&&(t="ESRI.ArcGIS.Client.LayerMapSource"):"string"==typeof e?t="System.String":"number"==typeof e?t="System.Double":"boolean"==typeof e?t="System.Boolean":"object"==typeof e&&(t="function"==typeof e.getMonth?"System.DateTime":"System.Object")),t},t}();t.ActivityContext=i}(e.workflow||(e.workflow={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){!function(t){t.startWorkflow=function(e,i,r){t._executeWorkflow(e,i,null,r,null)},t._executeWorkflow=function(t,i,r,n,s){var a={};if(null==t){var o=new Error("workflow cannot be null");if(null!=i)return void i.handleError(o,null);throw o}var l=t.url+"/run";if(n&&(e.workflow.WorkflowControllerProxy._preProcessArguments(n),a.inargs=JSON.stringify(n)),null!=r){for(var c=r.pendingExternalActivities,u=0;u<c.length;u++)e.workflow.WorkflowControllerProxy._preProcessArguments(c[u].outputs);a.workflow=JSON.stringify(r)}a=e.encodeJson(dojo.mixin({f:"json"},a)),null!=i&&(i.isBusy=!0),i.webRequestBegin(l,t),e.request({url:l,content:a,load:dojo.hitch(this,function(r){i.webRequestComplete(l,t),e.workflow.WorkflowControllerProxy._processWorkflowResults(r,t,i)}),error:dojo.hitch(this,function(e){if(null==i)throw e;i.isBusy=!1,i.handleError(e,s)}),callbackParamName:"CallBack"},{usePost:!0})},t._processWorkflowResults=function(t,i,r){if(null!=r&&(r.isBusy=!1),t)if(t.error){var n=new Error("Error running workflow: "+t.error.message);e.workflow.WorkflowControllerProxy._handleErrorInternal(r,n)}else{var s=new e.workflow.WorkflowState(t.instanceId,t.status,e.workflow.WorkflowControllerProxy._getExternalActivities(t.pendingExternalActivities),e.workflow.WorkflowControllerProxy._getArguments(t.outputs),t.workflowData,t.instanceData);if("Completed"==s.status)null!=r&&r.workflowComplete(s.outputs,i);else if("WaitingForExternalActivities"==s.status){var a=s.pendingExternalActivities;if(null!=a)for(var o=0;o<a.length;o++){var l=new e.workflow.ActivityContext(r,o,i,s);null!=r&&r.activityBegin(l);var c=a[o];e.workflow.WorkflowControllerProxy._preProcessArguments(c.inputs);try{"debugger"===l.getActivityExternalId()||c&&c.debug?e.workflow.DefaultActivityHandlers.showDebug(l,!0,function(){e.workflow.WorkflowControllerProxy._dispatch(l)}):e.workflow.WorkflowControllerProxy._dispatch(l)}catch(n){e.workflow.WorkflowControllerProxy._handleErrorInternal(r,n,l)}}}}},t._handleErrorInternal=function(e,t,i){if(null==e)throw t;e.handleError(t,i||null)},t._preProcessArguments=function(t){if(null!=t)for(var i=0;i<t.length;i++){var r=function(e){var t=e,i=e.indexOf(",");return i>0&&(t=e.substring(0,i)),t},n=r(t[i].runtimeTypeName);if(t[i].value=e.workflow.WorkflowControllerProxy._getObjectFromJsonWithType(t[i].value,n),null==t[i].value){var s=r(t[i].typeName);t[i].value=e.workflow.WorkflowControllerProxy._getObjectFromJsonWithType(t[i].value,s)}}},t._getObjectFromJsonWithType=function(e,t){var i=e;switch(t){case"ESRI.ArcGIS.Client.Tasks.FeatureSet":var r=e;if(null!=r){var n=new esri.tasks.FeatureSet(r);n.features=n.features||[],i=n}break;case"ESRI.ArcGIS.Client.Geometry.Geometry":case"ESRI.ArcGIS.Client.Geometry.Envelope":case"ESRI.ArcGIS.Client.Geometry.MapPoint":case"ESRI.ArcGIS.Client.Geometry.MultiPoint":case"ESRI.ArcGIS.Client.Geometry.Polygon":case"ESRI.ArcGIS.Client.Geometry.Polyline":var s=e;if(null!=s){var a=esri.geometry.fromJson(s);a&&a.spatialReference&&!s.spatialReference&&(a.spatialReference=null),i=a}break;case"ESRI.ArcGIS.Client.Geometry.SpatialReference":var o=e;null!=o&&(i=new esri.SpatialReference(o));break;case"ESRI.ArcGIS.Client.LayerMapSource":(l=e)&&(i=new esri.layers.LayerMapSource(l));break;case"ESRI.ArcGIS.Client.LayerDataSource":var l=e;l&&(i=new esri.layers.LayerDataSource(l));break;case"ESRI.ArcGIS.Client.TimeExtent":if(e instanceof Array){var c=e;if(c.length>0){var u=new Date(c[0]),h=c.length>1?new Date(c[1]):u;i=new esri.TimeExtent(u,h)}}break;case"System.DateTime":e instanceof Date&&(i="/Date("+e.getTime()+")/")}return i},t._getExternalActivities=function(t){var i=[];if(null!=t)for(var r=0;r<t.length;r++){var n=t[r],s=new e.workflow.ExternalActivityInfo;s._configureObject(n),i[r]=s}return i},t._getArguments=function(t){var arguments=[];if(null!=t)for(var i=0;i<t.length;i++){var r=t[i],n=new e.workflow.ArgumentInfo;n._configureObject(r),arguments[i]=n}return arguments},t._dispatch=function(e){if(null==e.dispatcher())throw new Error("Unhandled activity: "+e.getActivityTypeName());e.dispatcher().dispatch(e)}}(t.WorkflowControllerProxy||(t.WorkflowControllerProxy={}))}(e.workflow||(e.workflow={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){var i=function(){function t(e,t,i){this.display=e,this.value=t,this.typeName=i}return t.prototype.getValue=function(){var t=this.value;return null!=this.typeName&&(t=e.workflow.WorkflowControllerProxy._getObjectFromJsonWithType(t,this.typeName)),null!=this.value&&void 0!==this.value.__type&&delete t.__type,t},t}();t.DataItem=i}(e.forms||(e.forms={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){!function(t){t.initDataItemsFormItem=function(t,i,r){if(t.dataItems=new ObservableCollection,i){var n=e.forms.getElement(i,"DataItems");if(null!=n)for(var s=0;s<n.childNodes.length;s++){var a=n.childNodes[s],o=new e.forms.DataItem(e.forms.getElementText(a,"Display"),e.forms.getElementText(a,"Value"),e.forms.getElementText(a,"TypeName"));null!=o&&t.dataItems.addItem(o)}}if(r){var l=r.inputData;if(l&&l.hasOwnProperty(t.itemID.get())){var c=l[t.itemID.get()];t.dataItems.addItems(c)}}}}(t.items||(t.items={}))}(e.forms||(e.forms={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){!function(t){var i=function(){function t(t,i,r){if(this.cascadingEvent=new e.framework.events.Event("cascadingEvent"),this.isBusy=new Observable(!1),this._queryId=0,t.queryTaskRunner||(t.queryTaskRunner=this),t.queryTaskRunner!==this)throw new Error("FormItem in the constructor must be the QueryTaskFormItem containing the QueryTaskRunner");this.formItem=t,i?(this.queryDisplayOutputField=new Observable(e.forms.getElementText(i,"QueryDisplayOutputField")),this.queryValueOutputField=new Observable(e.forms.getElementText(i,"QueryValueOutputField")),this.queryServiceUrl=new Observable(e.forms.getElementText(i,"QueryServiceUrl")),this.queryWhereClause=new Observable(e.forms.getElementText(i,"QueryWhereClause")),this.filterByInputGeometry=new Observable(e.forms._parseBoolean(e.forms.getElementText(i,"FilterByInputGeometry"))),this.queryCascadingID=new Observable(e.forms.getElementText(i,"QueryCascadingID")),this.proxyUrl=new Observable(e.forms.getElementText(i,"ProxyUrl")),this.token=new Observable(e.forms.getElementText(i,"Token")),e.forms.getElementText(i,"LayerSourceJson")&&(this.layerSourceJson=new Observable(e.forms.getElementText(i,"LayerSourceJson")))):(this.queryDisplayOutputField=new Observable(null),this.queryValueOutputField=new Observable(null),this.queryServiceUrl=new Observable(null),this.queryWhereClause=new Observable(null),this.filterByInputGeometry=new Observable(!1),this.queryCascadingID=new Observable(null),this.proxyUrl=new Observable(null),this.token=new Observable(null)),t.formDefinition&&t.formDefinition.map(t);var n=this.queryCascadingID.get();null!=n&&""!=n&&t.formDefinition.addCascading(n,t,function(e){e?this.queryTaskRunner.performQuery(e):(this.clearDataItems(),this.triggerCascading(null))}),t.isBusy||(t.isBusy=new Observable(!1)),t.isBusy.sync(this.isBusy)}return t.prototype.triggerCascading=function(e){this.cascadingEvent.publish(e)},t.prototype.isQueryable=function(){return null!=this.queryServiceUrl.get()&&""!==dojo.trim(this.queryServiceUrl.get())&&null!=this.queryWhereClause.get()&&""!==dojo.trim(this.queryWhereClause.get())&&null!=this.queryDisplayOutputField.get()&&""!==dojo.trim(this.queryDisplayOutputField.get())},t.prototype.performQuery=function(t,i){var r=this;if(this.isQueryable()&&(this.formItem.dataItems.clear(),null!=t)){var n=null;this.filterByInputGeometry.get()&&null!=this.formItem.formDefinition&&this.formItem.formDefinition.inputGeometry&&(n=this.formItem.formDefinition.inputGeometry);var s=this.queryServiceUrl.get();this.proxyUrl.get()&&void 0===esri.getProxyRule(s)&&esri.addProxyRule({proxyUrl:this.proxyUrl.get(),urlPrefix:s}),this.token&&this.token.get()&&(s+=(dojo.indexOf(s,"?")>=0?"&":"?")+"token="+this.token.get());var a;if(this.layerSourceJson&&this.layerSourceJson.get()){var o=e.essentials.RestHelper.getJsonObjectFromJsonString(this.layerSourceJson.get()),l={source:e.essentials.RestHelper.getLayerSourceFromJsonObject(o)};a=new esri.tasks.QueryTask(s,l)}else a=new esri.tasks.QueryTask(s);var c=new esri.tasks.Query;c.returnGeometry=!1,c.geometry=n,c.outFields=[],c.where=this._getWhereClause(t),c.outFields.push(this.queryDisplayOutputField.get()),null!=this.queryValueOutputField.get()&&""!=dojo.trim(this.queryValueOutputField.get())&&this.queryValueOutputField.get()!=this.queryDisplayOutputField.get()&&c.outFields.push(this.queryValueOutputField.get()),c.outFields.every(function(e){return-1!==e.indexOf(".")})||(c.returnDistinctValues=!0),this.isBusy.set(!0),++this._queryId,function(){var t=r._queryId;a.execute(c,function(n){var s=[];if(t==r._queryId){for(var a=0;a<n.features.length;++a){var o=n.features[a].attributes,l=null;null!=r.queryDisplayOutputField.get()&&(l=o[r.queryDisplayOutputField.get().trim()]);var c;c=null!=r.queryValueOutputField.get()&&""!=dojo.trim(r.queryValueOutputField.get())&&r.queryValueOutputField.get()!=r.queryDisplayOutputField.get()?o[r.queryValueOutputField.get().trim()]:l,s.push(new e.forms.DataItem(l,c,null))}if(s.sort(function(e,t){return e.display<t.display?-1:1}),r.formatCallback){var u=e.essentials.EsriFieldTypes.esriFieldTypeString;if(n.fields){var h=n.fields.filter(function(e){return e.name===r.queryDisplayOutputField.get()})[0];h&&(u=h.type)}s.forEach(function(e){e.display=r.formatCallback(e.display,u)})}r.formItem.prepareForResults&&r.formItem.prepareForResults();for(var p={},d=[],f=0;f<s.length;++f){var y=s[f],m=function(e){return e.display+"-"+e.value}(y);p.hasOwnProperty(m)||(p[m]=!0,d.push(y))}r.formItem.dataItems.addItems(d),r.isBusy.set(!1);var g=null;r.formItem.dataItems.getLength()>0&&(g=r.formItem.dataItems.getAt(0)),!0===i&&r.triggerCascading(null==g?null:g.value),r.formItem.handleResultsComplete&&r.formItem.handleResultsComplete()}})}()}},t.prototype._getWhereClause=function(e){var t=this,i=this.queryWhereClause.get();return i=i.replace(/{1:([a-zA-Z0-9]+)(:[a-zA-Z0-9]+)?}/g,function(e,i,r){var n=t.formItem.formDefinition.getFormItemById(i);if(!n)return"{unknown form item "+i+"}";var s=n.getResult().value;if(!r)return s;if(":SQL"===r)return t._escapeForWhere(s);var a=/:[fF](\d+)/.exec(r);return a?parseFloat(s).toFixed(+a[1]):"{unknown format clause "+r+"}"}),i=i.format(this._escapeForWhere(e))},t.prototype._escapeForWhere=function(e){return e&&"number"==typeof e&&(e=e.toString()),(e||"").replace(/\'/g,"''")},t}();t.QueryTaskRunner=i}(t.items||(t.items={}))}(e.forms||(e.forms={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){!function(t){var i=function(i){function r(r,n){var s=this;if(i.call(this,r,n),this._defaultSet=!1,this.selectText=new Observable,this.selected=new Observable,this.defaultSelectedValue=new Observable,this.isBusy=new Observable(!1),this.formItemType="ComboBoxFormItem",t.initLabelContainer(this,r,n),t.initDataItemsFormItem(this,r,n),this.queryTaskRunner=new t.QueryTaskRunner(this,r,n),r){var a=e.forms.getElementText(r,"SelectText");a&&this.selectText.set(a);var o=e.forms.getElementText(r,"SelectedValue");o&&this.defaultSelectedValue.set(o)}this.selected.bind(null,function(e){return s._notifyResultChanged()}),this.prepareForResults(),this.queryTaskRunner.isQueryable()||this._selectDefaultValue();var l=this.queryTaskRunner.queryCascadingID.get();null!=l&&""!=l||this.queryTaskRunner.performQuery("")}return __extends(r,i),r.prototype.clearDataItems=function(){this.dataItems.clear(),this.selected.set(null),this._defaultSet=!1},r.prototype._hasRealDataItem=function(){return null!=this.selected.get()},r.prototype.triggerCascading=function(e){null!=this.selected.get()&&e||this.queryTaskRunner.cascadingEvent.publish(null);var t=this.selected.get();null===t&&(t=e),null===t||void 0===t?this.queryTaskRunner.cascadingEvent.publish(null):this.queryTaskRunner.cascadingEvent.publish(t.value)},r.prototype.prepareForResults=function(){if(this.selectText.get()){var t=this.selectText.get(),i=new e.forms.DataItem(t,"",null);this.dataItems.insertItem(0,i)}},r.prototype.handleResultsComplete=function(){this._defaultSet||(this._selectDefaultValue(),null!=this.selected.get()&&(this._defaultSet=!0,this.triggerCascading(this.selected.get())))},r.prototype.getResult=function(){if(null==this.selected.get())return new e.forms.items.FormItemResult(this.argumentName.get(),null);var t=this.selected.get();return t?new e.forms.items.FormItemResult(this.argumentName.get(),t.getValue()):new e.forms.items.FormItemResult(this.argumentName.get(),null)},r.prototype._addOption=function(t,i){this.dataItems.addItem(new e.forms.DataItem(t,i))},r.prototype._selectDefaultValue=function(){var e=dojo.filter(this.dataItems.getItems(),dojo.hitch(this,function(e){return!!this.defaultSelectedValue.get()&&e.value+""==this.defaultSelectedValue.get()+""}));e.length>0?this.selected.set(e[0]):this.dataItems.length()>0&&this.selected.set(this.dataItems.getAt(0))},r.prototype._render=function(){return e.forms.renderFormItem(this)},r}(t.AbstractFormItem);t.ComboBoxFormItem=i}(t.items||(t.items={}))}(e.forms||(e.forms={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){!function(t){var i=function(i){function r(r,n){var s=this;if(i.call(this,r,n),this.initialTime=new Observable,this.nullable=new Observable(!1),this.timeFormat=new Observable,this.jQueryPickerTimeAsInfoMsg=new Observable(!1),this.formItemType="TimePickerFormItem",t.initLabelContainer(this,r,n),r){for(var a=!0,o=r.getElementsByTagNameNS?r.getElementsByTagNameNS("http://schemas.datacontract.org/2004/07/Geocortex.Forms.Client.Items.Validation","ValidationItem"):r.getElementsByTagName("ValidationItem"),l=0;l<o.length;l++){var c=o[l].getAttributeNS("http://www.w3.org/2001/XMLSchema-instance","type");if(c&&c.indexOf("RequiredValidationItem")>=0){a=!1;break}}this.nullable.set(a);var u=e.forms.getElementText(r,"jQueryPickerTimeAsInfoMsg");u&&this.jQueryPickerTimeAsInfoMsg.set("true"===u);var h=e.forms.getElementText(r,"InitialTime");(null===e.forms.getElementText(r,"InitializeWithCurrentTime")?!h:"true"===e.forms.getElementText(r,"InitializeWithCurrentTime"))?this.initialTime.set(new Date):h?(e.framework.utils.DateUtils.containsTimezone(h)||(h+=e.framework.utils.DateUtils.getTimezoneString()),this.initialTime.set(Date.fromISO(h)),this.timeFormat.set(e.forms.getElementText(r,"TimeFormat"))):this.initialTime.set(null)}else this.timeFormat.set("LongTime"),this.initialTime.set(new Date);this.time=new Observable(this.initialTime.get()),this.time.bind(null,function(e){return s._notifyResultChanged()})}return __extends(r,i),r.prototype.getResult=function(){var t=this.time.get();return t&&(t=new Date(t.toString()),t="/Date({0})/".format(t.getTime())),new e.forms.items.FormItemResult(this.argumentName.get(),t)},r.prototype._render=function(){return e.forms.renderFormItem(this)},r}(t.AbstractFormItem);t.TimePickerFormItem=i}(t.items||(t.items={}))}(e.forms||(e.forms={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){!function(t){var i=function(i){function r(r,n){var s=this;i.call(this,r,n),this.nullable=new Observable(!1),this.formItemType="DatePickerFormItem",t.initLabelContainer(this,r,n);var a=!0;if(r){for(var o=!0,l=r.getElementsByTagNameNS?r.getElementsByTagNameNS("http://schemas.datacontract.org/2004/07/Geocortex.Forms.Client.Items.Validation","ValidationItem"):r.getElementsByTagName("ValidationItem"),c=0;c<l.length;c++){var u=l[c].getAttributeNS("http://www.w3.org/2001/XMLSchema-instance","type");if(u&&u.indexOf("RequiredValidationItem")>=0){o=!1;break}}this.nullable.set(o),this.dateFormat=new Observable(e.forms.getElementText(r,"DateFormat")),this.includeTimePicker=new Observable("true"===e.forms.getElementText(r,"IncludeTimePicker"));var h=null;this.includeTimePicker.get()&&(this.timePickerItem=new t.TimePickerFormItem(e.forms.getElement(r,"TimePickerItem")),h=this.timePickerItem.initialTime.get());var p=e.forms.getElementText(r,"InitialDate");if(a=null===e.forms.getElementText(r,"InitializeWithCurrentDate")?!p:"true"===e.forms.getElementText(r,"InitializeWithCurrentDate"),p){if(e.framework.utils.DateUtils.containsTimezone(p)){var d=Math.max(p.lastIndexOf("Z"),p.lastIndexOf("+"),p.lastIndexOf("-"));d>0&&(p=p.substring(0,d))}p+=e.framework.utils.DateUtils.getTimezoneString()}var f=null;(a||p)&&(f=new Date(p)),f&&!isNaN(f.getTime())?(f.getTimezoneOffset()!=e.framework.utils.DateUtils.getTimezoneOffset()&&f.setTime(f.getTime()-6e4*(e.framework.utils.DateUtils.getTimezoneOffset()-f.getTimezoneOffset())),h&&(f.setHours(h.getHours()),f.setMinutes(h.getMinutes()),f.setSeconds(h.getSeconds())),this.initialDate=new Observable(f)):this.initialDate=new Observable(h)}else this.dateFormat=new Observable,this.initialDate=new Observable(null),this.includeTimePicker=new Observable(!1);if(a){var y=new Date;this.includeTimePicker.get()||(y.setHours(0),y.setMinutes(0),y.setSeconds(0)),this.date=new Observable(y),this.initialDate.set(y)}else this.date=new Observable(this.initialDate.get());this.date.bind(null,function(e){return s._notifyResultChanged()})}return __extends(r,i),r.prototype.getResult=function(){var t=this.date.get(),i=null===t?null:new Date(t.toString());if(i)if(isNaN(i.getTime()))i=this.initialDate.get();else{var r=0,n=!this.attached_pickerType||!this.attached_pickerType.get||this.attached_pickerType.get().toLowerCase().indexOf("native")>-1;t instanceof Date||this.includeTimePicker.get()||!n||(r=6e4*i.getTimezoneOffset()),i="/Date({0})/".format(i.getTime()+r)}return new e.forms.items.FormItemResult(this.argumentName.get(),i)},r.prototype._render=function(){return e.forms.renderFormItem(this)},r}(t.AbstractFormItem);t.DatePickerFormItem=i}(t.items||(t.items={}))}(e.forms||(e.forms={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){!function(t){var i=function(i){function r(r,n){var s=this;i.call(this,r,n),this.files=new ObservableCollection,this.formItemType="FilePickerFormItem",this.isSupported=new Observable("undefined"!=typeof FileReader&&this._isFileInputSupported()),r?(this.acceptFileTypes=new Observable(e.forms.getElementText(r,"AcceptFileTypes")),this.allowMultiple=new Observable(e.forms._parseBoolean(e.forms.getElementText(r,"AllowMultiple")))):(this.acceptFileTypes=new Observable(null),this.allowMultiple=new Observable(!1)),t.initLabelContainer(this,r,n),this.files.bind(null,function(e){return s._notifyResultChanged()})}return __extends(r,i),r.prototype.clear=function(){this.files.clear(),this.refresh()},r.prototype.getResult=function(){for(var i=[],r=0;r<this.files.getLength();++r){var n=this.files.getAt(r);n&&i.push(n)}var s=new e.workflow.ArgumentValueWrapper("System.Collections.Generic.List`1[[Geocortex.Forms.Client.FileItem, Geocortex.EssentialsWpfApi]]",i),a=new t.FormItemResult(this.argumentName.get(),s,!0);return a.isList=!0,a},r.prototype._render=function(){return e.forms.renderFormItem(this)},r.prototype._isFileInputSupported=function(){if(navigator.userAgent.match(/(Android (1.0|1.1|1.5|1.6|2.0|2.1))|(Windows Phone (OS 7|8.0))|(XBLWP)|(ZuneWP)|(w(eb)?OSBrowser)|(webOS)|(Kindle\/(1.0|2.0|2.5|3.0))/))return!1;var e=document.createElement("input");return e.type="file",!e.disabled},r}(t.AbstractFormItem);t.FilePickerFormItem=i}(t.items||(t.items={}))}(e.forms||(e.forms={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){!function(t){var i=function(t){function i(i,r){if(t.call(this,i,r),this.formItems=new ObservableCollection,this.formItemType="ContainerFormItem",i){this.orientation=new Observable(e.forms.getElementText(i,"Orientation")),this.description=new Observable(e.forms.getElementText(i,"Description")),this.maxWidth=new Observable(parseInt(e.forms.getElementText(i,"MaxWidth"))),this.visibleControlID=new Observable(e.forms.getElementText(i,"VisibleControlID")),this.visibleControlValue=new Observable(e.forms.getElementText(i,"VisibleControlValue"));var n=e.forms.getElement(i,"FormItems");if(null!=n)for(var s=0;s<n.childNodes.length;s++){var a=e.forms.items._processFormItem(n.childNodes[s],this.formDefinition);if(null!=a){this.formItems.addItem(a);var o=this;a.refresh=function(){var e=o.formItems.indexOf(this);e>=0&&(o.formItems.removeAt(e),o.formItems.insertItem(e,this))}}}}else this.orientation=new Observable("Vertical"),this.description=new Observable(""),this.maxWidth=new Observable(NaN),this.visibleControlID=new Observable(""),this.visibleControlValue=new Observable("")}return __extends(i,t),i.prototype.validate=function(){var e=[];if(this.isVisible.get()&&null!=this.formItems)for(var t=0;t<this.formItems.getLength();++t){var i=this.formItems.getAt(t);if(i.isVisible.get())for(var r=i.validate(),n=0;n<r.length;++n)e.push(r[n])}return e},i.prototype._getResults=function(){for(var e=[],t=0;t<this.formItems.getLength();++t){var r=this.formItems.getAt(t);if(r.isVisible.get())if(r instanceof i){var n=r._getResults();if(null!=n)for(var s=0;s<n.length;++s)e.push(n[s])}else{var a=r.getResult();null!=a&&e.push(a)}}return e},i.prototype._destroy=function(){for(var e=this.formItems.length()-1;e>=0;e--)this.formItems.getAt(e)._destroy();this.formItems.clear()},i.prototype._render=function(){return e.forms.renderFormItem(this)},i.prototype.getFormItemById=function(e){for(var t=0,i=this.formItems.length();t<i;t++){var r=this.formItems.getAt(t);if(r.itemID.get()===e)return r;if(r.getFormItemById&&(r=r.getFormItemById(e)))return r}return null},i.prototype.applyVisibility=function(e){if(e){var t=!1,i=e.getResult();if(null!==i&&null!==i.value){var r=this.visibleControlValue.get();if(r)if(i.isList){var n=i.value;if(n)for(var s=0;s<n.length;s++)if(n[s].toString()===r){t=!0;break}}else t=!0===i.value||!1===i.value?i.value.toString().toUpperCase()===r.toUpperCase():i.value.toString()===r;else!0===i.value&&(t=!0)}this.isVisible.set(t)}},i.prototype.getDisplayName=function(){return null},i}(t.AbstractFormItem);t.ContainerFormItem=i}(t.items||(t.items={}))}(e.forms||(e.forms={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){!function(t){var i=function(t){function i(i,r){t.call(this,i,r),this.formItemType="GroupBoxFormItem",this.header=i?new Observable(e.forms.getElementText(i,"Header")):new Observable(null)}return __extends(i,t),i.prototype._render=function(){return e.forms.renderFormItem(this)},i.prototype.getDisplayName=function(){return this.header.get()},i}(t.ContainerFormItem);t.GroupBoxFormItem=i}(t.items||(t.items={}))}(e.forms||(e.forms={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){!function(t){var i=function(t){function i(i,r){var n=this;t.call(this,i,r),this.wasClicked=new Observable(!1),this.formItemType="HyperlinkFormItem",i?(this.hyperlinkText=new Observable(e.forms.getElementText(i,"HyperlinkText")),this.target=new Observable(e.forms.getElementText(i,"Target")),this.uri=new Observable(e.forms.getElementText(i,"Uri"))):(this.hyperlinkText=new Observable("Hyperlink"),this.target=new Observable("_blank"),this.uri=new Observable("")),this.wasClicked.bind(null,function(e){return n._notifyResultChanged()})}return __extends(i,t),i.prototype.getResult=function(){return new e.forms.items.FormItemResult(this.argumentName.get(),this.wasClicked.get(),this.wasClicked.get())},i.prototype._render=function(){return e.forms.renderFormItem(this)},i}(t.AbstractFormItem);t.HyperlinkFormItem=i}(t.items||(t.items={}))}(e.forms||(e.forms={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){!function(t){var i=function(t){function i(i,r){if(t.call(this,i,r),this.formItemType="ImageFormItem",i){this.source=new Observable(e.forms.getElementText(i,"Source")),this.width=new Observable(e.forms.getElementText(i,"Width")),this.height=new Observable(e.forms.getElementText(i,"Height"));var n=this.width.get(),s=this.height.get();n&&s?parseInt(n)>parseInt(s)?this.height.set("auto"):this.width.set("auto"):(this.width=new Observable("auto"),this.height=new Observable("auto"))}else this.source=new Observable(""),this.width=new Observable("auto"),this.height=new Observable("auto")}return __extends(i,t),i.prototype._render=function(){return e.forms.renderFormItem(this)},i}(t.AbstractFormItem);t.ImageFormItem=i}(t.items||(t.items={}))}(e.forms||(e.forms={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){!function(t){var i=function(i){function r(r,n){var s=this;if(i.call(this,r,n),this.selection=new ObservableCollection,this.selectedValues=new ObservableCollection,this._selectedValuesLookup=null,this.isBusy=new Observable(!1),this.formItemType="ListBoxFormItem",t.initLabelContainer(this,r,n),t.initDataItemsFormItem(this,r,n),this.size=new Observable(6),r){this.maxHeight=new Observable(parseInt(e.forms.getElementText(r,"MaxHeight"))),this.selectionMode=new Observable(e.forms.getElementText(r,"SelectionMode"));var a=e.forms.getElementText(r,"Size");if(a){var o=parseInt(a);o>0&&this.size.set(o)}var l=e.forms.getElement(r,"SelectedValues");if(l){this._selectedValuesLookup={};var c;for(c=0;c<l.childNodes.length;c++){var u=l.childNodes[c].textContent;this.selectedValues.addItem(u),this._selectedValuesLookup[u+""]=!0}this._setDefaults(),0===this.selection.length()&&0!==this.dataItems.getItems().length&&this.selection.addItem(this.dataItems.getAt(0))}}else this.label=new e.forms.items.LabelFormItem(null,this.formDefinition),this.maxHeight=new Observable(NaN),this.selectionMode=new Observable("Single");this.queryTaskRunner=new t.QueryTaskRunner(this,r,n),this.queryTaskRunner.queryCascadingID.get()||this.queryTaskRunner.performQuery(""),this.selection.bind(null,function(e){setTimeout(function(){s._notifyResultChanged()},0)})}return __extends(r,i),r.prototype.clearDataItems=function(){this.dataItems.clear()},r.prototype._setDefaults=function(){for(var e=0;e<this.dataItems.getItems().length;e++){var t=this.dataItems.getAt(e);this._selectedValuesLookup[t.value.toString()]&&this.selection.addItem(t)}},r.prototype.handleResultsComplete=function(){this._setDefaults()},r.prototype.triggerCascading=function(e){null!=this.selection&&e||this.queryTaskRunner.cascadingEvent.publish(null);var t=null;null!=this.selection&&(t=this.selection.getAt(0)),null==t&&null!=e&&(t=e),null==t?this.queryTaskRunner.cascadingEvent.publish(null):this.queryTaskRunner.cascadingEvent.publish(t.value)},r.prototype.getResult=function(){var e=null;if("single"==this.selectionMode.get().toLowerCase())return this.selection.getLength()>0&&(e=(n=this.selection.getAt(0))?n.getValue():null),new t.FormItemResult(this.argumentName.get(),e,!0);for(var i=[],r=0;r<this.selection.getLength();++r){var n=this.selection.getAt(r);(e=n?n.getValue():null)&&i.push(e)}return e=new t.FormItemResult(this.argumentName.get(),i,!0),e.isList=!0,e},r.prototype._render=function(){return e.forms.renderFormItem(this)},r}(t.AbstractFormItem);t.ListBoxFormItem=i}(t.items||(t.items={}))}(e.forms||(e.forms={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){!function(t){var i=function(i){function r(t,n){var s=this;i.call(this,t,n),this.formItemType="RadioButtonFormItem",t?(this.text=new Observable(e.forms.getElementText(t,"Text")),this.checked=new Observable(e.forms._parseBoolean(e.forms.getElementText(t,"Checked"))),this.textLocation=new Observable(e.forms.getElementText(t,"TextLocation")),this.groupName=new Observable(e.forms.getElementText(t,"GroupName"))):(this.text=new Observable(null),this.checked=new Observable(!1),this.textLocation=new Observable("Right"),this.groupName=new Observable(null)),this.checked.bind(null,function(e){e&&r._findButtonsInGroup(s.groupName.get(),s.formDefinition.containerFormItem).forEach(function(e){e!==s&&e.checked.set(!1)}),s._notifyResultChanged()})}return __extends(r,i),r.prototype.getResult=function(){var t=this.__getRadioValueClosure,i=!!t&&t();return new e.forms.items.FormItemResult(this.argumentName.get(),i)},r.prototype._render=function(){return e.forms.renderFormItem(this)},r._findButtonsInGroup=function(e,i){var n=[];return i&&i.formItems.get().forEach(function(i){i instanceof r?i.groupName.get()===e&&n.push(i):i instanceof t.ContainerFormItem&&r._findButtonsInGroup(e,i).forEach(function(e){return n.push(e)})}),n},r}(t.AbstractFormItem);t.RadioButtonFormItem=i}(t.items||(t.items={}))}(e.forms||(e.forms={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){!function(t){var i=function(i){function r(r,n){i.call(this,r,n),this.isBusy=new Observable(!1),this.formItemType="AutoCompleteBoxFormItem",r?(this.minimumPrefixLength=new Observable(parseInt(e.forms.getElementText(r,"MinimumPrefixLength"))),this.minimumPopulateDelay=new Observable(parseInt(e.forms.getElementText(r,"MinimumPopulateDelay")))):(this.minimumPrefixLength=new Observable(3),this.minimumPopulateDelay=new Observable(200)),t.initDataItemsFormItem(this,r,n),this.queryTaskRunner=new t.QueryTaskRunner(this,r,n)}return __extends(r,i),r.prototype.clearDataItems=function(){this.dataItems.clear()},r}(t.TextBoxFormItem);t.AutoCompleteBoxFormItem=i}(t.items||(t.items={}))}(e.forms||(e.forms={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){!function(e){!function(e){var t=function(){return function(e,t){this.isValid=e,this.errorMessage=t}}();e.ValidationResult=t}(e.validation||(e.validation={}))}(e.items||(e.items={}))}(e.forms||(e.forms={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){var t=function(){return function(){this.fileName=null,this.fileDataBase64=null,this.fileSize=0,this.fileType=null}}();e.FileItem=t}(e.forms||(e.forms={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){!function(t){!function(t){var i=function(t){function i(i){t.call(this,i),this.totalFileSize=parseInt(e.forms.getElementText(i,"TotalFileSize"))}return __extends(i,t),i.prototype.validate=function(t){if(t instanceof e.workflow.ArgumentValueWrapper&&t.value&&t.value instanceof Array){for(var i=0,r=0;r<t.value.length;++r){var n=t.value[r];n&&n instanceof e.forms.FileItem&&(i+=n.fileSize)}if(i>this.totalFileSize)return new e.forms.items.validation.ValidationResult(!1,this.message)}return new e.forms.items.validation.ValidationResult(!0,null)},i}(t.ValidationItem);t.FileSizeValidationItem=i}(t.validation||(t.validation={}))}(t.items||(t.items={}))}(e.forms||(e.forms={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){!function(t){!function(t){var i=function(t){function i(i){t.call(this,i),this.minimumValue=parseFloat(e.forms.getElementText(i,"MinimumValue")),this.maximumValue=parseFloat(e.forms.getElementText(i,"MaximumValue"))}return __extends(i,t),i.prototype.validate=function(t){if(null===t||void 0===t||""===t)return new e.forms.items.validation.ValidationResult(!0,null);var i=parseFloat(t);return null==i||isNaN(i)||i<this.minimumValue||i>this.maximumValue?new e.forms.items.validation.ValidationResult(!1,this.message):new e.forms.items.validation.ValidationResult(!0,null)},i}(t.ValidationItem);t.NumericRangeValidationItem=i}(t.validation||(t.validation={}))}(t.items||(t.items={}))}(e.forms||(e.forms={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){!function(t){!function(t){var i=function(t){function i(i){t.call(this,i),this.expression=e.forms.getElementText(i,"Expression"),this.ignoreCase=e.forms._parseBoolean(e.forms.getElementText(i,"IgnoreCase"))}return __extends(i,t),i.prototype.validate=function(t){if(null===t||void 0===t||""===t)return new e.forms.items.validation.ValidationResult(!0,null);var i="",r=this.expression;this.ignoreCase&&(i+="i"),'^(?(")(".+?"@)|(([0-9a-zA-Z]((\\.(?!\\.))|[-!#\\$%&\'\\*\\+/=\\?\\^`\\{\\}\\|~\\w])*)(?<=[0-9a-zA-Z])@))(?(\\[)(\\[(\\d{1,3}\\.){3}\\d{1,3}\\])|(([0-9a-zA-Z][-\\w]*[0-9a-zA-Z]\\.)+[a-zA-Z]{2,6}))$'==this.expression&&(r="^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,4}$");var n=null;try{n=new RegExp(r,i)}catch(e){}return null==n||n.test(t)?new e.forms.items.validation.ValidationResult(!0,null):new e.forms.items.validation.ValidationResult(!1,this.message)},i}(t.ValidationItem);t.RegexValidationItem=i}(t.validation||(t.validation={}))}(t.items||(t.items={}))}(e.forms||(e.forms={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){!function(t){!function(t){var i=function(t){function i(e){t.call(this,e)}return __extends(i,t),i.prototype.validate=function(t){var i=!0,r=null;return(void 0===t||null===t||"string"==typeof t&&""===dojo.trim(t)||void 0!==t.length&&t.length<=0||t.value&&dojo.isArray(t.value)&&0===t.value.length)&&(i=!1,r=this.message),new e.forms.items.validation.ValidationResult(i,r)},i}(t.ValidationItem);t.RequiredValidationItem=i}(t.validation||(t.validation={}))}(t.items||(t.items={}))}(e.forms||(e.forms={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){function t(e,t){var i=e.getElementsByTagName(t);if(i.length>=1){for(n=0;n<i.length;n++)if(i[n].parentNode===e)return i[n]}else if(e.childNodes.length>0){var r=e.childNodes[0].prefix;if(""!=r&&(i=e.getElementsByTagName(r+":"+t)).length>=1)for(var n=0;n<i.length;n++)if(i[n].parentNode===e)return i[n]}return null}e.getElement=t,e.getElementText=function(e,i){var r=t(e,i);return r?dojox.xml.parser.textContent(r):null},e.getAttributeValue=function(e,t){if(null!=e)for(var i=0;i<e.attributes.length;i++)if(e.attributes[i].name==t)return e.attributes[i].value;return null},e._parseBoolean=function(e){if(null!=e)switch(e.toLowerCase()){case"true":case"yes":case"1":return!0;case"false":case"no":case"0":case null:return!1;default:return Boolean(e)}return!1},e.renderFormItem=function(e){throw new Error("This abstract function must be implemented by your UI system")}}(e.forms||(e.forms={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){!function(i){function r(e){var t="";if(null!=e&&null!=e.attributes)for(var i=0;i<e.attributes.length;i++)if(String(e.attributes[i].nodeName).indexOf("type")>=0){var r=e.attributes[i].nodeValue,n=r.indexOf(":");n>=0&&n+1<r.length&&(r=r.substr(n+1)),t=r;break}return t}i._processFormItem=function(t,i){var n=null;switch(r(t)){case"AutoCompleteBoxFormItem":n=new e.forms.items.AutoCompleteBoxFormItem(t,i);break;case"CheckBoxFormItem":n=new e.forms.items.CheckBoxFormItem(t,i);break;case"ContainerFormItem":n=new e.forms.items.ContainerFormItem(t,i);break;case"ComboBoxFormItem":n=new e.forms.items.ComboBoxFormItem(t,i);break;case"DatePickerFormItem":n=new e.forms.items.DatePickerFormItem(t,i);break;case"FilePickerFormItem":n=new e.forms.items.FilePickerFormItem(t,i);break;case"GroupBoxFormItem":n=new e.forms.items.GroupBoxFormItem(t,i);break;case"HyperlinkFormItem":n=new e.forms.items.HyperlinkFormItem(t,i);break;case"ImageFormItem":n=new e.forms.items.ImageFormItem(t,i);break;case"ListBoxFormItem":n=new e.forms.items.ListBoxFormItem(t,i);break;case"MarkdownFormItem":n=new e.forms.items.MarkdownFormItem(t,i);break;case"RadioButtonFormItem":n=new e.forms.items.RadioButtonFormItem(t,i);break;case"TextAreaFormItem":n=new e.forms.items.TextAreaFormItem(t,i);break;case"TextBoxFormItem":n=new e.forms.items.TextBoxFormItem(t,i);break;case"TimePickerFormItem":n=new e.forms.items.TimePickerFormItem(t,i)}return n.dataItems&&null!=i&&null!=i.inputData&&i.inputData.hasOwnProperty(n.itemID)&&n.dataItems.addItems(i.inputData.item(n.itemID)),n},i._processValidationItem=function(e){var i=null;switch(r(e)){case"NumericRangeValidationItem":i=new t.items.validation.NumericRangeValidationItem(e);break;case"RequiredValidationItem":i=new t.items.validation.RequiredValidationItem(e);break;case"RegexValidationItem":i=new t.items.validation.RegexValidationItem(e);break;case"FileSizeValidationItem":i=new t.items.validation.FileSizeValidationItem(e)}return i},i._getType=r}(t.items||(t.items={}))}(e.forms||(e.forms={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){var i=function(){function t(t,i,r){this.version=null,this.inputData=null,this.containerFormItem=null,this.inputGeometry=null,this.knownTypes=null,this._formManager=null,this._version=1.1,this._formContainer=null,this._cascadingMap=null,this._controlMap=null,this.knownTypes=[],this.inputData=i,this.version=this._version,this._controlMap={},this._cascadingMap={};var n=null;if(t&&(n=dojox.xml.parser.parse(t)),r&&(this.inputGeometry=r),null!=n){var s=n.documentElement,a=e.forms.getElementText(s,"Version");if(parseFloat(a)>this._version)throw new Error("Form version "+a+" is incompatible with current API version "+this._version);this.title=new Observable(e.forms.getElementText(s,"Title")),this.maxWidth=new Observable(parseInt(e.forms.getElementText(s,"MaxWidth"))),this.maxHeight=new Observable(parseInt(e.forms.getElementText(s,"MaxHeight")));var o=e.forms.getElement(s,"KnownTypes");if(null!=o)for(c=0;c<o.childNodes.length;c++)this.knownTypes.push(o.childNodes[c].firstChild.data);this.containerFormItem=new e.forms.items.ContainerFormItem(e.forms.getElement(s,"ContainerFormItem"),this)}else this.containerFormItem=new e.forms.items.ContainerFormItem(null,this),this.containerFormItem.itemID=new Observable("Group1"),this.title=new Observable(""),this.maxWidth=new Observable(NaN),this.maxHeight=new Observable(NaN);for(var l in this._cascadingMap)if(this._cascadingMap.hasOwnProperty(l))for(var c=0;c<this._cascadingMap[l].length;++c){var u=this._cascadingMap[l][c];this._controlMap[l].queryTaskRunner.cascadingEvent.subscribe(u.formItem,u.handler)}}return t.prototype.addCascading=function(e,t,i){0==this._cascadingMap.hasOwnProperty(e)&&(this._cascadingMap[e]=[]),this._cascadingMap[e].push({formItem:t,handler:i})},t.prototype.map=function(e){this._controlMap[e.itemID.get()]=e},t.prototype.render=function(e){},t.prototype.validate=function(){return this.containerFormItem.validate()},t.prototype.getResults=function(){return this.containerFormItem._getResults()},t.prototype.destroy=function(){this.containerFormItem._destroy()},t.prototype.getFormItemById=function(e){return this.containerFormItem.getFormItemById(e)},t}();t.FormDefinition=i}(e.forms||(e.forms={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){!function(t){t.getPropertyIgnoreCase=function(e,t){for(var i in e)if(e.hasOwnProperty(i)&&i.toLowerCase()===t.toLowerCase())return i;return null},t.handleReport=function(i){var r=i.getValue("MapServiceId"),n=i.getValue("LayerId"),s=i.getValue("LayerName"),a=i.getValue("ReportId"),o=null,l=i.getSite();if(l&&r&&(n||s)&&a){var c=t.findMapServiceById(l,r);if(c){var u=null;n?u=c.findLayerById(n):s&&(u=c.findLayerByName(s)),null!=u&&(o=u.findReportById(a))}}if(o){var h=new esri.tasks.Query,p=new e.essentials.ReportParameters,d=i.getValue("ShowOpenReport"),f=i.getValue("Geometry"),y=i.getValue("OutSpatialReference"),m=i.getValue("Text"),g=i.getValue("Where"),v=i.getValue("OutputFormat"),w=i.getValue("Resolution"),b=i.getValue("CustomExtent"),S=i.getValue("SpatialRelationship"),x=i.getValue("ReportExtentType"),I=i.getValue("NotificationEmailAddress"),_=i.getValue("TextFields");if(x||(x=e.essentials.ReportParameters.CURRENT_EXTENT),p.extentType=x,v&&(p.outputFormat=v),o.textFields)for(var E in o.textFields)if(o.textFields.hasOwnProperty(E)){var T=o.textFields[E],L=function(e){var t=null;if(_&&e)for(var i=0;i<_.length;i++){var r=_[i];if(r.Key===e.displayName||"tf_"+r.Key===e.id||r.Key===e.id){t=r;break}}return t}(T);null!=L?p.fields.push(new e.essentials.TextField(T.id,T.displayName,L.Value,T.multiline)):p.fields.push(T)}I&&(p.notificationEmailAddress=I),w&&(p.resolution=w),b&&(p.customExtent=b),h.spatialRelationship=e.essentials.RestHelper._convertSpatialRelationshipFromDotnetIndex(S),f&&(h.geometry=f),y&&(h.outSpatialReference=y),m&&(h.text=m),g&&(h.where=g),o.run(h,p,function(e){var t=e?e.href:null;d&&t&&t.length>0&&i.dispatcher().handleOpenReportUrl(t,i),i.setValue("ResultUrl",t),i.completeActivity()},function(e){i.dispatcher().handleError(new Error("Error running report '"+e.message+"'"),i)})}else i.dispatcher().handleError(new Error("Cannot find report '"+a+"'"),i)},t.showDebug=function(t,i,r){var n=new e.forms.FormDefinition;n.maxHeight.set(600),n.maxWidth.set(500);var s;if(i?(n.title.set("Debug - Input Arguments for "+t.getDisplayName()),n.containerFormItem.description.set("Input Arguments:"),s=t.getInputNames()):(n.title.set("Debug - Output Arguments for "+t.getDisplayName()),n.containerFormItem.description.set("Output Arguments:"),s=t.getOutputNames()),null!=s&&s.length>0)for(var a=0;a<s.length;a++){var o,l=s[a];(o=i?t.getValue(l):t.getOutputValue(l))&&"object"==typeof o&&(o=i?t.getJsonValue(l):t.getOutputJsonValue(l));var c;!o||String(o).length<100&&-1==String(o).indexOf("\n")?c=new e.forms.items.TextBoxFormItem(null,n):(c=new e.forms.items.TextAreaFormItem(null,n)).textboxHeight.set(100),c.label=new e.forms.items.LabelFormItem(null,n),c.text.set(o),c.textboxWidth.set(300),c.label.text.set(l),c.readOnly.set(!0),n.containerFormItem.formItems.addItem(c)}var u=t.dispatcher();u&&"function"==typeof u._showDebugHandler?u._showDebugHandler(n,r):r&&r()},t.handleGetBrowserUrl=function(e){e.setValue("Url",window.location.href),e.completeActivity()},t.handleExternalDelay=function(e){var t=e.getValue("Milliseconds");if(null==t)throw new Error("External Delay: required Milliseconds argument was not supplied.");setTimeout(function(){e.completeActivity()},t)},t.handleGetExternalTimeInfo=function(e){var t=new Date;e.setValue("UtcOffset",-6e4*t.getTimezoneOffset()),e.completeActivity()},t.handleWaitForGeoprocessorJobComplete=function(t){var i=t.getValue("GeoprocessorUrl"),r=(t.getValue("Token"),t.getValue("ProxyURL"),t.getValue("UpdateDelay")),n=t.getValue("JobId"),s=!1;if(!i)throw new Error("GeoprocessorUrl parameter is missing.");if(!n)throw new Error("JobId parameter is missing.");var a=new esri.tasks.Geoprocessor(i);r>0&&a.setUpdateDelay(r),dojo.connect(a,"onError",function(i){t.setValue("Result",e.workflow.DefaultActivityHandlers._getJobStatusCode(esri.tasks.JobInfo.STATUS_FAILED)),t.completeActivity()}),dojo.connect(a,"onStatusUpdate",function(i){if(!s){var o=i.jobStatus;o==esri.tasks.JobInfo.STATUS_CANCELLED||o==esri.tasks.JobInfo.STATUS_DELETED||o==esri.tasks.JobInfo.STATUS_FAILED||o==esri.tasks.JobInfo.STATUS_SUCCEEDED||o==esri.tasks.JobInfo.STATUS_TIMED_OUT?(s=!0,t.setValue("Result",e.workflow.DefaultActivityHandlers._getJobStatusCode(o)),t.completeActivity()):window.setTimeout(function(){a.checkJobStatus(n)},r)}}),a.checkJobStatus(n)},t._getJobStatusCode=function(e){switch(e){case"esriJobNew":return 0;case"esriJobSubmitted":return 1;case"esriJobWaiting":return 2;case"esriJobExecuting":return 3;case"esriJobSucceeded":return 4;case"esriJobFailed":return 5;case"esriJobTimedOut":return 6;case"esriJobCancelling":return 7;case"esriJobCancelled":return 8;case"esriJobDeleting":return 9;case"esriJobDeleted":return 10;default:return-1}},t.handleGetLayerInfoByProperty=function(t){if(!t)throw new Error("Get Map Service Info: required context was not supplied.");var i=t.getValue("PropertyName");if(null==i)throw new Error("Provide a Property Name: No property name available.");var r=t.getSite();if(!r)throw new Error("Set Layer Visibility: No site available.");for(var n=[],s=r.essentialsMap.mapServices,a={mapServiceUrl:"",mapServiceId:"",token:"",isVisible:!1,isDynamic:!1,propertyValue:null,id:"",name:"",displayName:"",layerUrl:""},o=null,l=0;l<s.length;l++)for(var c=s[l].layers.concat(s[l].tables),u=0;u<c.length;u++)if(void 0!=c[u].properties[i]){if(a.mapServiceUrl=s[l].serviceUrl,a.mapServiceId=s[l].id,a.token=s[l].serviceToken,a.isVisible=c[u].isVisible(),a.isDynamic=c[u].isDynamic,a.propertyValue=c[u].properties[i],a.id=c[u].id,a.name=c[u].name,a.displayName=c[u].displayName,s[l].mapServiceType===e.essentials.MapServiceType.FEATURE?a.layerUrl=a.mapServiceUrl:a.layerUrl=a.mapServiceUrl+"/"+(a.isDynamic?"dynamicLayer":a.id),a.isDynamic){var h=s[0].serviceLayer;if(h&&h.dynamicLayerInfos)for(var p=0;p<h.dynamicLayerInfos.length;p++)if((o=h.dynamicLayerInfos[p])&&o.id.toString()===a.id){o.source&&(a.layerSourceJson=JSON.stringify(o.source.toJson()));break}}n.push(a),a={mapServiceUrl:"",mapServiceId:"",token:"",isVisible:!1,isDynamic:!1,propertyValue:null,id:"",name:"",displayName:"",layerUrl:""}}t.setValue("LayersInfo",n),t.completeActivity()}}(t.DefaultActivityHandlers||(t.DefaultActivityHandlers={}))}(e.workflow||(e.workflow={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){!function(e){e.handleAlert=function(e){e.getValue("Title");var t=e.getValue("Text");alert(t),e.completeActivity()},e.handleConfirm=function(e){var t=e.getValue("Text"),i=confirm(t);null==i&&(i=!1),e.setValue("Result",i),e.completeActivity()},e.handlePrompt=function(e){var t=e.getValue("Description"),i=e.getValue("DefaultText"),r=prompt(t,i);e.setValue("Result",r),e.completeActivity()}}(e.DefaultActivityHandlers||(e.DefaultActivityHandlers={}))}(e.workflow||(e.workflow={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){!function(e){e.handleSetLayerProperty=function(t){var i=t.getValue("MapServiceId"),r=t.getValue("LayerId"),n=t.getValue("LayerName"),s=t.getValue("PropertyName"),a=t.getValue("Value");if(!i)throw new Error("Set Layer Property: required MapServiceId argument was not supplied.");if(!r&&!n)throw new Error("Set Layer Property: a LayerId or a LayerName argument must be supplied.");var o=t.getSite();if(!o)throw new Error("Set Layer Property: No site available.");var l=e.findMapServiceById(o,i);if(!l||!l.serviceLayer)throw new Error("Set Layer Property: Unable to find map service with ID '"+i+"'");var c=null;if(!(c=r?l.findLayerById(r):l.findLayerByName(n)))throw new Error("Set Layer Property: Unable to find layer with Name '"+n+"' or ID '"+r+"'.");var u=e.getPropertyIgnoreCase(c,s);if(u)c[u]=a;else{if(!(u=e.getPropertyIgnoreCase(c.properties,s)))throw new Error("Set Layer Property: Layer does not support the property '"+s+"'.");c.properties[u]=a}t.completeActivity()},e.handleGetLayerProperty=function(t){var i=t.getValue("MapServiceId"),r=t.getValue("LayerId"),n=t.getValue("LayerName"),s=t.getValue("PropertyName");if(!i)throw new Error("Get Layer Property: required MapServiceId argument was not supplied.");if(!r&&!n)throw new Error("Get Layer Property: a LayerId or a LayerName argument must be supplied.");var a=t.getSite();if(!a)throw new Error("Get Layer Property: No site available.");var o=e.findMapServiceById(a,i);if(!o||!o.serviceLayer)throw new Error("Get Layer Property: Unable to find map service with ID '"+i+"'");var l=null;if(!(l=r?o.findLayerById(r):o.findLayerByName(n)))throw new Error("Get Layer Property: Unable to find layer with Name '"+n+"' or ID '"+r+"'.");var c=e.getPropertyIgnoreCase(l,s);if(c)t.setValue("Value",l[c]);else{if(!(c=e.getPropertyIgnoreCase(l.properties,s)))throw new Error("Get Layer Property: Layer does not support the property '"+s+"'.");t.setValue("Value",l.properties[c])}t.completeActivity()},e.handleGetLayerVisibility=function(t){var i=t.getValue("MapServiceId"),r=t.getValue("LayerId"),n=t.getValue("LayerName"),s=t.getValue("EffectiveVisibility");if(!i)throw new Error("Get Layer Visibility: required MapServiceId argument was not supplied.");if(!r&&!n)throw new Error("Get Layer Visibility: a LayerId or a LayerName argument must be supplied.");var a=t.getSite();if(!a)throw new Error("Get Layer Visibility: No site available.");var o=e.findMapServiceById(a,i);if(!o)throw new Error("Get Layer Visibility: Unable to find map service with ID '"+i+"'");var l=null;if(r?l=o.findLayerById(r):n&&(l=o.findLayerByName(n)),!l)throw new Error("Get Layer Visibility: Unable to find layer with ID '"+r+"' in map service with ID '"+i+"'");var c=l.isVisible();if(s&&(c=!1,l.isVisible()&&o.isVisible()&&l.withinScaleRange(null)))for(var u=o.getVisibleLayers(),h=0;h<u.length;h++)if(u[h]==l.id){c=!0;break}t.setValue("Visible",c),t.completeActivity()},e.handleSetLayerVisibility=function(t){var i=t.getValue("MapServiceId"),r=t.getValue("LayerId"),n=t.getValue("LayerName"),s=t.getValue("Visible");if(!i)throw new Error("Set Layer Visibility: required MapServiceId argument was not supplied.");if(!r&&!n)throw new Error("Set Layer Visibility: a LayerId or a LayerName argument must be supplied.");if(null===s)throw new Error("Set Layer Visibility: required Visible argument was not supplied.");var a=t.getSite();if(!a)throw new Error("Set Layer Visibility: No site available.");var o=e.findMapServiceById(a,i);if(!o)throw new Error("Set Layer Visibility: Unable to find map service with ID '"+i+"'");var l=null;if(r){if(!(l=o.findLayerById(r)))throw new Error("Set Layer Visibility: Unable to find layer with ID '"+r+"' in map service with ID '"+i+"'")}else{if(!n)throw new Error("Set Layer Visibility: must define layer ID or name");if(!(l=o.findLayerByName(n)))throw new Error("Set Layer Visibility: Unable to find layer with name '"+n+"' in map service with ID '"+i+"'")}l.setVisibility(s),t.completeActivity()},e.handleGetLayerDefinition=function(t){var i=t.getValue("MapServiceId"),r=t.getValue("LayerId"),n=t.getValue("LayerName");if(!i)throw new Error("Get Layer Definition: required MapServiceId argument was not supplied.");if(!r&&!n)throw new Error("Get Layer Definition: a LayerId or a LayerName argument must be supplied.");var s=null,a=t.getSite();if(a){var o=e.findMapServiceById(a,i);if(o&&o.serviceLayer){if(!r&&n){var l=o.findLayerByName(n);if(!l)throw new Error("Set Layer Definition: Unable to find layer with Name '"+n+"'.");r=l.id}o.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer?o.serviceLayer.layerDefinitions&&(s=o.serviceLayer.layerDefinitions[parseInt(r)]):o.serviceLayer instanceof esri.layers.FeatureLayer&&(s=o.serviceLayer.getDefinitionExpression())}}t.setValue("Definition",s),t.completeActivity()},e.handleSetLayerDefinition=function(t){var i=t.getValue("MapServiceId"),r=t.getValue("LayerId"),n=t.getValue("LayerName"),s=t.getValue("Definition");if(!i)throw new Error("Set Layer Definition: required MapServiceId argument was not supplied.");if(!r&&!n)throw new Error("Set Layer Definition: a LayerId or a LayerName argument must be supplied.");var a=t.getSite();if(!a)throw new Error("Set Layer Visibility: No site available.");var o=e.findMapServiceById(a,i);if(!o||!o.serviceLayer)throw new Error("Set Layer Definition: Unable to find map service with ID '"+i+"'");if(!r&&n){var l=o.findLayerByName(n);if(!l)throw new Error("Set Layer Definition: Unable to find layer with Name '"+n+"'.");r=l.id}if(o.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer){var c=o.serviceLayer;c.layerDefinitions||(c.layerDefinitions=[]),c.layerDefinitions[parseInt(r)]=s,c.setLayerDefinitions(c.layerDefinitions,!0)}else{if(!(o.serviceLayer instanceof esri.layers.FeatureLayer))throw new Error("Set Layer Definition: Map service type does not support layer definitions.");o.serviceLayer.setDefinitionExpression(s)}t.completeActivity()},e.handleGetGraphicsLayerContent=function(e){var t=e.getValue("GraphicsLayerId"),i=e.getValue("GeometryType"),r=null;null!==i&&(0===i?r="extent":1===i?r="multipoint":2===i?r="point":3===i?r="polygon":4===i&&(r="polyline"));var n=e.getEsriMap();if(null!=n&&null!=n.graphicsLayerIds)for(var s=0;s<n.graphicsLayerIds.length;s++)if(t==n.graphicsLayerIds[s]){var a=n.getLayer(n.graphicsLayerIds[s]);if(null!=a&&null!=a.graphics){for(var o=new esri.tasks.FeatureSet,l=0;l<a.graphics.length;l++){var c=a.graphics[l];if(null!==r){if(null===c.geometry)continue;if(r!==c.geometry.type)continue}var u=new esri.Graphic(c.geometry,null,c.attributes,null);o.features.push(u)}e.setValue("Features",o)}break}e.completeActivity()},e.handleUpdateGraphicsLayer=function(t){var i=t.getValue("GraphicsLayerId"),r=!!t.getValue("RemoveAllFeatures"),n=t.getValue("FeatureSet"),s=t.getValue("RendererJson"),a=t.getEsriMap();if(null==a)throw new Error("Update Graphics Layer: No map available.");var o=!1,l=e.findMapServiceByMap(a,i);if(l){if(!(l instanceof esri.layers.GraphicsLayer))throw new Error("Update Graphics Layer: The layer '"+i+"' is not a GraphicsLayer")}else l=new esri.layers.GraphicsLayer({id:i}),o=!0;try{if(l.suspend(),r&&l.clear(),n&&n.features)for(var c=n.features.length-1;c>=0;--c)l.add(n.features[c]);s&&(l.renderer=esri.renderer.fromJson(JSON.parse(s))),o&&a.addLayer(l)}finally{l.resume()}t.completeActivity()}}(e.DefaultActivityHandlers||(e.DefaultActivityHandlers={}))}(e.workflow||(e.workflow={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){!function(t){function i(t,i){return i&&t&&t.essentialsMap&&t.essentialsMap.mapServices?e.essentials.utilities.SiteResourceIdComparer.lookUp(t.essentialsMap.mapServices,i):null}function r(t,i){if(!t||!i)return null;if(null!=t.layerIds)for(r=0;r<t.layerIds.length;r++)if(null!=(n=t.getLayer(t.layerIds[r]))&&e.essentials.utilities.SiteResourceIdComparer.equals(n.id,i))return n;if(null!=t.graphicsLayerIds)for(var r=0;r<t.graphicsLayerIds.length;r++){var n=t.getLayer(t.graphicsLayerIds[r]);if(null!=n&&e.essentials.utilities.SiteResourceIdComparer.equals(n.id,i))return n}return null}t.findMapServiceById=i,t.findMapServiceByMap=r,t.handleRemoveMapService=function(e){var t=e.getValue("MapServiceId"),i=e.getEsriMap();if(null==i)throw new Error("Remove Map Service: No map available.");var n=r(i,t);if(n){i.removeLayer(n);var s=e.getSite();s&&s.essentialsMap&&s.essentialsMap.mapServices&&s.essentialsMap.removeServiceLayer(n)}e.completeActivity()},t.handleSetImageServiceInfo=function(e){var t=e.getValue("ImageServiceId"),i=e.getValue("BandIds"),n=e.getValue("MosaicRule"),s=e.getValue("RenderingRule"),a=e.getEsriMap();if(null==a)throw new Error("Set Image Service Info: No map available.");require(["esri/layers/RasterFunction"],function(o){var l=r(a,t);if(l instanceof esri.layers.ArcGISImageServiceLayer){var c=l;if(i&&c.setBandIds(i,!0),n){var u=new esri.layers.MosaicRule(n);u.method||(u=c.defaultMosaicRule),c.setMosaicRule(u,!0)}if(s){var h=new esri.layers.RasterFunction(s);h.functionName||(h=null),c.setRenderingRule(h,!0)}c.refresh()}e.completeActivity()})},t.handleSetMapServiceVisibility=function(e){var t=e.getValue("MapServiceId"),n=e.getValue("Visible");if(null==t)throw new Error("Set Map Service Visibility: required MapServiceId argument was not supplied.");if(null==n)throw new Error("Set Map Service Visibility: required Visible argument was not supplied.");var s=e.getEsriMap(),a=e.getSite();if(null==s)throw new Error("Set Map Service Visibility: No map available.");var o=null;if(null==(o=r(s,t)))throw new Error("Set Map Service Visibility: Unable to find map service with ID '"+t+"'");if(o.setVisibility(n),e.completeActivity(),a&&t){var l=i(a,t);dojo.publish("MapServiceVisibilityChangedEvent",l)}},t.handleGetMapServiceInfo=function(e){if(!e)throw new Error("Get Map Service Info: required context was not supplied.");var t=e.getValue("MapServiceId"),n=e.getValue("LayerName");if(null==t)throw new Error("Get Map Service Info: required MapServiceId argument was not supplied.");var s=null,a=null,o=null,l=null,c=!1,u=e.getEsriMap();if(null==u)throw new Error("Get Map Service Info: No map available.");var h=e.getSite(),p=null,d=null;if(null!=h&&null!=h.essentialsMap&&null!=(d=i(h,t))&&(p=d.serviceLayer,s=d.serviceUrl,a=d.findServiceToken(),c=d.isVisible()),null==p&&(p=r(u,t))&&(s=p.url,"boolean"==typeof p.visible&&(c=p.visible)),null!=n){var f=!1;if(p.supportsDynamicLayers&&p.dynamicLayerInfos)for(var y=p.dynamicLayerInfos,m=0;m<y.length;m++)if((g=y[m]).name===n||"{0}".format(g.id)===n){f=!0,o="dynamicLayer",l=g.source;break}if(!f&&p.layerInfos)for(var y=p.layerInfos,m=0;m<y.length;m++){var g=y[m];if(null!=g&&null!=g.id&&g.name==n){f=!0,o=g.id;break}}if(!f&&d){var v=d.findLayerOrTableByName(n);v&&(f=!0,o=v.id)}}e.setValue("MapServiceUrl",s),e.setValue("Token",a),e.setValue("LayerId",o),e.setValue("Source",l),e.setValue("Visible",c),e.completeActivity()},t.handleSetMapServiceProperty=function(e){var t="Set Map Service Property",i=e.getValue("MapServiceId"),n=e.getValue("PropertyName"),s=e.getValue("Value");if(!i)throw new Error("{0}: required MapServiceId argument was not supplied.".format(t));if(!n)throw new Error("{0}: required PropertyName argument was not supplied.".format(t));var a=e.getEsriMap();if(!a)throw new Error("{0}: no map available.".format(t));var o=r(a,i);if(!o)throw new Error("{0}: unable to find map service with ID '{1}'.".format(t,i));if("gdbversion"===n.toLowerCase())if(o instanceof esri.layers.FeatureLayer){if(!o.isDataVersioned)throw new Error("{0}: map service with ID '{1}' is not versioned.".format(t,i));o.setGDBVersion(s)}else{if(!(o instanceof esri.layers.ArcGISDynamicMapServiceLayer))throw new Error("{0}: map service with ID '{1}' does not support GDB version.".format(t,i));o.setGDBVersion(s)}else if("visible"===n.toLowerCase())o.setVisibility(s);else{n="set"+n.toLowerCase();var l=null;for(var c in o)if(c.toLowerCase()===n){l=c;break}if(!l)throw new Error("{0}: map service property '{1}' does not exist.".format(t,n));o[l](s)}e.completeActivity()}}(t.DefaultActivityHandlers||(t.DefaultActivityHandlers={}))}(e.workflow||(e.workflow={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){!function(e){e.handleGetCurrentPosition=function(e){if(!navigator.geolocation)return e.setValue("ErrorCode",2),e.setValue("ErrorMessage","Geolocation is not supported."),void e.completeActivity();var t={enableHighAccuracy:e.getValue("EnableHighAccuracy"),timeout:e.getValue("Timeout")||2e4,maximumAge:e.getValue("MaximumAge")};navigator.geolocation.getCurrentPosition(function(t){e.setValue("Latitude",t.coords.latitude),e.setValue("Longitude",t.coords.longitude),e.setValue("Altitude",t.coords.altitude),e.setValue("Accuracy",t.coords.accuracy),e.setValue("AltitudeAccuracy",t.coords.altitudeAccuracy),e.setValue("Heading",t.coords.heading),e.setValue("Speed",t.coords.speed),e.setValue("Timestamp",t.timestamp),e.completeActivity()},function(t){e.setValue("ErrorCode",t.code),e.setValue("ErrorMessage",t.message),e.completeActivity()},t)},e.handleGetPhoto=function(e){if(!navigator.camera)return e.setValue("Message","camera is not supported."),void e.completeActivity();var t={quality:e.getValue("Quality"),destinationType:e.getValue("DestinationType"),sourceType:e.getValue("SourceType"),allowEdit:e.getValue("AllowEdit"),encodingType:e.getValue("EncodingType"),targetWidth:e.getValue("TargetWidth"),targetHeight:e.getValue("TargetHeight")};navigator.camera.getPicture(function(t){e.setValue("ImageData",t),e.completeActivity()},function(t){e.setValue("Message",t),e.completeActivity()},t)}}(e.DefaultActivityHandlers||(e.DefaultActivityHandlers={}))}(e.workflow||(e.workflow={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){var i=function(){function t(t,i){if(this._mapService=null,this._mapService=t,this._mapService.mapServiceType!=e.essentials.MapServiceType.WMS&&this._mapService.mapServiceType!=e.essentials.MapServiceType.DYNAMIC)throw new Error("LayerVisibilityEventManager: Only Dynamic and WMS Layer types supported.");var r=this;dojo.require("dojo.aspect"),dojo.aspect.before(i,"setVisibleLayers",function(e,t){return r.beforeESRIsetVisibleLayers(e,t)}),dojo.aspect.after(i,"setVisibleLayers",function(e,t,i){r.afterESRIsetVisibleLayers(e,t,i)},!0)}return t.prototype.beforeESRIsetVisibleLayers=function(t,i){var r=[],n=[];if(void 0===i&&(i=!1),t.InternallyChangedLayer){var s=t.InternallyChangedLayer;return void 0!=s.mapServiceId&&void 0!=s.layerId&&void 0!=s.visibility&&r.push(s),l=[t,i,r]}if(this._mapService.mapServiceType==e.essentials.MapServiceType.DYNAMIC)n=dojo.clone(t);else if(this._mapService.mapServiceType==e.essentials.MapServiceType.WMS)for(var a=0;t&&a<t.length;a++){var o=this._findWmsLayerIdFromName(t[a]);if(!o||null===o){var l=[t,i,r];return console.error("WARNING: LayerVisibilityEventManager could not find layer corresponding to WMS name ["+t[a]+"] Possible Invalid configuration"),l}n.push(o.toString())}if(t&&this._mapService.mapServiceType==e.essentials.MapServiceType.DYNAMIC&&1===t.length&&"-1"==t[0]){for(var c=0;c<this._mapService.layers.length;c++){p=this._mapService.layers[c].id;r.push({mapServiceId:this._mapService.id,layerId:p.toString(),visibility:!1}),this._mapService.findLayerById(p)._syncProgramaticallyChangedLayerVisibility(!1)}return l=[t,i,r]}(t&&0===t.length||this._mapService.mapServiceType==e.essentials.MapServiceType.DYNAMIC&&1===t.length&&""===t[0])&&(n=this._mapService.getDefaultVisibleLayers());for(var u=this._getAllCurrentlyVisibleLayers(),h=0;u&&h<u.length;h++){var p=u[h];n&&n.indexOf(p.toString())<0&&(y=this._mapService.findLayerById(p))&&(r.push({mapServiceId:this._mapService.id,layerId:p.toString(),visibility:!1}),y._syncProgramaticallyChangedLayerVisibility(!1))}var d=this._mapService.getVisibleLayers();if(n&&n.length>0)for(var f=0;f<n.length;f++)if(this._mapService.mapServiceType==e.essentials.MapServiceType.DYNAMIC&&isNaN(parseInt(n[f]))&&(n[f]="0"),d&&d.indexOf(n[f].toString())<0){var y=this._mapService.findLayerById(n[f]);y&&(y.subLayerIds&&y.subLayerIds.length>0&&(this._deleteItemWithId(n[f],r),this._recursivelyUpdateSublayerVisibility(y,!0,r)),r.push({mapServiceId:this._mapService.id,layerId:n[f].toString(),visibility:!0}),y._syncProgramaticallyChangedLayerVisibility(!0),y.parentLayerId&&null!==y.parentLayerId&&void 0!==y.parentLayerId&&this._recursivelyUpdateAncestorVisibility(y,n,r))}return l=[t,i,r]},t.prototype.afterESRIsetVisibleLayers=function(e,t,i){i&&i.length>0&&dojo.publish("LayerVisibilityChange",new Array(i))},t.prototype._recursivelyUpdateAncestorVisibility=function(e,t,i){if(e&&e.parentLayerId&&null!==e.parentLayerId&&void 0!==e.parentLayerId){var r=this._mapService.findLayerById(e.parentLayerId);r.isVisible()||(this._deleteItemWithId(e.parentLayerId,i),r._syncProgramaticallyChangedLayerVisibility(!0),i.push({mapServiceId:this._mapService.id,layerId:e.parentLayerId.toString(),visibility:!0})),this._recursivelyUpdateAncestorVisibility(r,t,i)}},t.prototype._recursivelyUpdateSublayerVisibility=function(e,t,i){if(e.subLayerIds&&e.subLayerIds.length>0)for(var r=0;r<e.subLayerIds.length;r++){var n=this._mapService.findLayerById(e.subLayerIds[r]),s=n.id;n._syncProgramaticallyChangedLayerVisibility(t),this._deleteItemWithId(s,i),i.push({mapServiceId:this._mapService.id,layerId:s.toString(),visibility:t}),n.subLayerIds&&n.subLayerIds.length>0&&this._recursivelyUpdateSublayerVisibility(n,t,i)}},t.prototype._getAllCurrentlyVisibleLayers=function(){for(var e=[],t=0;t<this._mapService.layers.length;t++){var i=this._mapService.layers[t];i.isVisible()&&e.push(i.id.toString())}return e},t.prototype._findWmsLayerIdFromName=function(e){for(var t=0;t<this._mapService.layers.length;t++){var i=this._mapService.layers[t];if(e==i.wmsLayerName)return i.id}return null},t.prototype._deleteItemWithId=function(e,t){for(var i=0;i<t.length;i++)t[i].layerId==e&&t.splice(i,1)},t}();t.LayerVisibilityEventManager=i}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){!function(e){e.DYNAMIC="Dynamic",e.TILED="Tiled",e.IMAGE="Image",e.BING="Bing",e.FEATURE="Feature",e.WMS="WMS",e.WMTS="WMTS",e.GEORSS="GeoRss",e.WEBTILED="WebTiled",e.VECTORTILE="VectorTile",e.KML="Kml",e.GRAPHICS="Graphics",e.LABEL="Label",e.STREAM="Stream",e.CSV="Csv",e.MAPIMAGE="MapImage",e.UNKNOWN="Unknown"}(e.MapServiceType||(e.MapServiceType={}))}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){!function(e){e.OPERATIONAL="Operational",e.BASE="Base"}(e.MapServiceFunction||(e.MapServiceFunction={}))}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){!function(e){e.MAP_SERVICE="MapService",e.FEATURE_LAYER="FeatureLayer",e.GEORSS_LAYER="GeoRssLayer",e.KML_SERVICE="KmlService",e.GeoRSS_LAYER=e.GEORSS_LAYER}(e.DrawingBehavior||(e.DrawingBehavior={}))}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){!function(e){e.IGNORE="Ignore",e.WARN="Warn",e.ERROR="Error"}(e.FailureAction||(e.FailureAction={}))}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){var i=function(){function t(e,t,i){this.layerThemesInfo=e;var r="object"==typeof t?t:null;this._configureLayerTheme(r,t,i)}return t.prototype._configureLayerTheme=function(t,i,r){this.id=t?t.id:i,this.isDefaultTheme=null===this.id,this.isActive=!1,this.displayName=t?t.displayName:r,this.extensions=e._getExtensions(t?t.extensions:null),this.properties=t?t.properties:null},t.prototype.applyToMap=function(){var t=this;if(void 0==this.layerThemesInfo)throw new Error("Could not apply theme '{0}' to the map because the LayerThemesInfo property is not set on this LayerTheme.".format(this.displayName));var i=this.layerThemesInfo,r=i.map;if(void 0==r)throw new Error("Failed to apply theme '{0}' to map because the Map property is not set on the LayerThemesInfo object.".format(this.displayName));this.isActive=!0,(i.activeTheme&&i.activeTheme!==this||!i.activeTheme)&&(i.activeTheme&&(i.previousTheme=i.activeTheme,i.previousTheme.isActive=!1),i.activeTheme=this),i.themeChangeInProgress=!0,i.layerThemeChangingEvent({currTheme:i.activeTheme,prevTheme:i.previousTheme});for(var n=function(e,t){void 0===t&&(t=!1),e.setInActiveTheme(!0),a(e,e.configuredVisible,t)},s=function(e,i){void 0===i&&(i=!1);var r=e.getLayerThemeSettings(t.id);e.setInActiveTheme(null!=r);var n=!1;null!=r&&(n=void 0!=r.visible?r.visible:e.configuredVisible),a(e,n,i)},a=function(t,i,r){if(void 0===r&&(r=!1),t instanceof e.essentials.Layer){var n=t;if(n.mapService.supportsLayerVisibility())n.mapService.essentialsMap.site.getEssentialsVersion()>=4.02&&n.type===e.essentials.LayerType.GROUP_LAYER&&(i=!0);else if(1!==n.mapService.layers.length||!n.inActiveTheme||n.mapService.includeInLayerList)return}t.isUserCreated||t.setVisibility(i,r)},o=0;o<r.mapServices.length;o++){var l=r.mapServices[o],c=l.supportsLayerVisibility();this.isDefaultTheme?n(l):s(l);for(var u=0;u<l.layers.length;u++){var h=l.layers[u];this.isDefaultTheme?n(h,c):s(h,c)}c&&l.refresh()}r.refreshFilteredCollections(),i.themeChangeInProgress=!1,i.layerThemeChangedEvent({currTheme:i.activeTheme,prevTheme:i.previousTheme})},t}();t.LayerTheme=i}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){var t=function(){return function(e,t){this.theme=e,this.visible=t}}();e.LayerThemeSetting=t}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){var t=function(){function e(e){this.layerThemeChangedEvent=function(e){},this.themeChangeInProgress=!1,this.layerThemeChangingEvent=function(e){},this.layerThemesConfigured=!1,this.allowDefault=!1,this.themes=[],this.map=e}return e.prototype.applyTheme=function(e){if(this.layerThemesConfigured){var t=this.getTheme(e);t?t.applyToMap():console.log("Error: Theme with ID '{0}' could not be found and was not activated.".format(e))}else console.log("Warning: No layer themes have been configured by the essentials administrator.")},e.prototype.getTheme=function(e,t){if(void 0===t&&(t=!1),this.layerThemesConfigured)for(var i=0;i<this.themes.length;i++){if(this.themes[i].id===e)return this.themes[i];if(t&&this.themes[i].displayName.toLowerCase()===e.toLowerCase())return this.themes[i]}return null},e}();e.LayerThemesInfo=t}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){var t=function(e){function t(){e.apply(this,arguments),this.updateInterval=null,this.serviceLayer=null,this.mapSpatialReference=null}return __extends(t,e),t.prototype._configureObject=function(t,i){if(void 0===t)throw new Error("Incorrect map service object returned from initialization");this.updateInterval=t.updateInterval,e.prototype._configureObject.call(this,t,i)},t.prototype._createServiceLayer=function(){var e=this;this.essentialsMap&&(this.essentialsMap.site,this.mapSpatialReference=this.essentialsMap.initialExtent.spatialReference);var t={id:this.id,outSR:this.mapSpatialReference};this.serviceLayer=new esri.layers.KMLLayer(this.serviceUrl,t),this._initiallyVisible?this.serviceLayer.show():this.serviceLayer.hide(),this.serviceLayer._options=t,this.attributionDataUrl&&""!==this.attributionDataUrl?(this.serviceLayer.attributionDataUrl=this.attributionDataUrl,this.serviceLayer.hasAttributionData=!0):this.hasAttributionData&&(this.serviceLayer.attributionDataUrl=this.url+"/Attribution",this.serviceLayer.hasAttributionData=!0);var i=this.serviceLayer.on("load",function(t){i.remove(),e.serviceLayer.setOpacity(e.configuredOpacity),e._initializeKmlLayers()});this.serviceLayer.on("error",function(t){return e._layerLoadErrorHandler(t)}),this.serviceLayer.setOpacity(this.configuredOpacity),this.updateInterval&&!isNaN(this.updateInterval)&&this.serviceLayer.setRefreshInterval(this.updateInterval)},t.prototype._updateStartHandler=function(){this._initializeKmlLayers()},t.prototype._initializeKmlLayers=function(){for(var e=this.serviceLayer.getLayers(),t=0;t<e.length;t++)if(e[t]instanceof esri.layers.FeatureLayer){var i=e[t];i.layerId=+this.id,i.name=this.displayName,i.displayField="name",e[t].spatialReference=this.mapSpatialReference}},t}(e.MapService);e.KmlService=t}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(e){!function(e){var t={};e.handleGetExternalValue=function(e){var i=e.getValue("Key");if(null!=i){var r=t[i];void 0===r&&(r=null),e.setValue("Value",r)}e.completeActivity()},e.handleSetExternalValue=function(e){var i=e.getValue("Key"),r=e.getValue("Value");null!=i&&(t[i]=r),e.completeActivity()}}(e.CacheActivityHandlers||(e.CacheActivityHandlers={}))}(e.workflow||(e.workflow={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){var i=function(){function t(e,t,i,r,n,s,a){this.isBusy=!1,this._drawObjectContext=null,this._registeredActivityHandlers={},this._registeredExternalIdHandlers={},this.handleUnhandledActivityErrorFunction=null,this.handleOpenReportUrlFunction=null,this.defaultFormContainerId="form-container-outer",this.defaultFormContentId="form-container",this._handleErrorFunction=e||null,this._activityBeginFunction=t||null,this._activityCompleteFunction=i||null,this._workflowAbortFunction=n||null,this._workflowCompleteFunction=r||null,this._webRequestBeginFunction=s||null,this._webRequestCompleteFunction=a||null,this.registerDefaultHandlers()}return t.prototype.registerDefaultHandlers=function(){this.registerActivityHandler("Geocortex.Workflow.Activities.Alert",e.workflow.DefaultActivityHandlers.handleAlert),this.registerActivityHandler("Geocortex.Workflow.Activities.CaptureGeometry",e.workflow.DefaultActivityHandlers.handleCaptureGeometry),this.registerActivityHandler("Geocortex.Workflow.Activities.Confirm",e.workflow.DefaultActivityHandlers.handleConfirm),this.registerActivityHandler("Geocortex.Workflow.Activities.ExportMap",e.workflow.DefaultActivityHandlers.handleExportMap),this.registerActivityHandler("Geocortex.Workflow.Activities.ExternalDelay",e.workflow.DefaultActivityHandlers.handleExternalDelay),this.registerActivityHandler("Geocortex.Workflow.Activities.GetBrowserUrl",e.workflow.DefaultActivityHandlers.handleGetBrowserUrl),this.registerActivityHandler("Geocortex.Workflow.Activities.GetCurrentPosition",e.workflow.DefaultActivityHandlers.handleGetCurrentPosition),this.registerActivityHandler("Geocortex.Workflow.Activities.GetExternalTimeInfo",e.workflow.DefaultActivityHandlers.handleGetExternalTimeInfo),this.registerActivityHandler("Geocortex.Workflow.Activities.GetExternalValue",e.workflow.CacheActivityHandlers.handleGetExternalValue),this.registerActivityHandler("Geocortex.Workflow.Activities.GetGraphicsLayerContent",e.workflow.DefaultActivityHandlers.handleGetGraphicsLayerContent),this.registerActivityHandler("Geocortex.Workflow.Activities.GetLayerDefinition",e.workflow.DefaultActivityHandlers.handleGetLayerDefinition),this.registerActivityHandler("Geocortex.Workflow.Activities.GetLayerInfoByProperty",e.workflow.DefaultActivityHandlers.handleGetLayerInfoByProperty),this.registerActivityHandler("Geocortex.Workflow.Activities.GetLayerProperty",e.workflow.DefaultActivityHandlers.handleGetLayerProperty),this.registerActivityHandler("Geocortex.Workflow.Activities.GetLayerVisibility",e.workflow.DefaultActivityHandlers.handleGetLayerVisibility),this.registerActivityHandler("Geocortex.Workflow.Activities.GetMapExtent",e.workflow.DefaultActivityHandlers.handleGetMapExtent),this.registerActivityHandler("Geocortex.Workflow.Activities.GetMapInfo",e.workflow.DefaultActivityHandlers.handleGetMapInfo),this.registerActivityHandler("Geocortex.Workflow.Activities.GetMapServiceInfo",e.workflow.DefaultActivityHandlers.handleGetMapServiceInfo),this.registerActivityHandler("Geocortex.Workflow.Activities.GetPhoto",e.workflow.DefaultActivityHandlers.handleGetPhoto),this.registerActivityHandler("Geocortex.Workflow.Activities.PrintMap",e.workflow.DefaultActivityHandlers.handlePrintMap),this.registerActivityHandler("Geocortex.Workflow.Activities.Prompt",e.workflow.DefaultActivityHandlers.handlePrompt),this.registerActivityHandler("Geocortex.Workflow.Activities.RefreshMap",e.workflow.DefaultActivityHandlers.handleRefreshMap),this.registerActivityHandler("Geocortex.Workflow.Activities.RemoveMapService",e.workflow.DefaultActivityHandlers.handleRemoveMapService),this.registerActivityHandler("Geocortex.Workflow.Activities.Report",e.workflow.DefaultActivityHandlers.handleReport),this.registerActivityHandler("Geocortex.Workflow.Activities.SetExternalValue",e.workflow.CacheActivityHandlers.handleSetExternalValue),this.registerActivityHandler("Geocortex.Workflow.Activities.SetLayerDefinition",e.workflow.DefaultActivityHandlers.handleSetLayerDefinition),this.registerActivityHandler("Geocortex.Workflow.Activities.SetLayerProperty",e.workflow.DefaultActivityHandlers.handleSetLayerProperty),this.registerActivityHandler("Geocortex.Workflow.Activities.SetLayerVisibility",e.workflow.DefaultActivityHandlers.handleSetLayerVisibility),this.registerActivityHandler("Geocortex.Workflow.Activities.SetMapExtent",e.workflow.DefaultActivityHandlers.handleSetMapExtent),this.registerActivityHandler("Geocortex.Workflow.Activities.SetMapServiceVisibility",e.workflow.DefaultActivityHandlers.handleSetMapServiceVisibility),this.registerActivityHandler("Geocortex.Workflow.Activities.UpdateGraphicsLayer",e.workflow.DefaultActivityHandlers.handleUpdateGraphicsLayer),this.registerActivityHandler("Geocortex.Workflow.Activities.WaitForGeoprocessorJobComplete",e.workflow.DefaultActivityHandlers.handleWaitForGeoprocessorJobComplete),this.registerActivityHandler("Geocortex.Workflow.Activities.SetImageServiceInfo",e.workflow.DefaultActivityHandlers.handleSetImageServiceInfo),this.registerActivityHandler("Geocortex.Workflow.Activities.SetMapServiceProperty",e.workflow.DefaultActivityHandlers.handleSetMapServiceProperty),this.registerExternalIdHandler("IntersectLayers",e.workflow.DefaultActivityHandlers.handleIntersectLayers),this.registerExternalIdHandler("GetPhoto",e.workflow.DefaultActivityHandlers.handleGetPhoto)},t.prototype.canHandleActivity=function(e){if(!e){var t=new Error("Null ActivityContext passed to canHandleActivity.");this.handleError(t,e)}if(null!=e.getActivityExternalId()&&null!=this._registeredExternalIdHandlers[e.getActivityExternalId()])return!0;var i=e.getActivityTypeName();return!(null==i||!this._registeredActivityHandlers[i])},t.prototype.registerExternalIdHandler=function(e,t){if(null!=e&&null!=t)this._registeredExternalIdHandlers[e]=t;else{var i=new Error("Null externalId or handler passed to registerExternalIdHandler.");this.handleError(i,null)}},t.prototype.registerActivityHandler=function(e,t){if(null!=e&&null!=t)this._registeredActivityHandlers[e]=t;else{var i=new Error("Null activityTypeName or handler passed to registerActivityHandler.");this.handleError(i,null)}},t.prototype.dispatch=function(e){if(null!=e){var t=e.getActivityTypeName(),i=e.getActivityExternalId();if(this.canHandleActivity(e)){if(null!=i&&null!=this._registeredExternalIdHandlers[i]&&(r=this._registeredExternalIdHandlers[i])(e,this),null!=t&&this._registeredActivityHandlers[t]){var r=this._registeredActivityHandlers[t];r(e,this)}}else{n=new Error("Unknown activity type '"+t+"' or external ID '"+i+"' encountered.");this.handleUnhandledActivityErrorFunction(n,e)}}else{var n=new Error("Null ActivityContext passed to dispatch.");this.handleError(n,e)}},t.prototype.handleError=function(e,t){null!=this._handleErrorFunction&&this._handleErrorFunction(e,t)},t.prototype.handleUnhandledActivityError=function(e,t){null!=this.handleUnhandledActivityErrorFunction?this.handleUnhandledActivityErrorFunction(e,t):this.handleError(e,t)},t.prototype.handleOpenReportUrl=function(e,t){if(null!=this.handleOpenReportUrlFunction)this.handleOpenReportUrlFunction(e,t);else window.open(e)},t.prototype.webRequestBegin=function(e,t){null!=this._webRequestBeginFunction&&this._webRequestBeginFunction(e,t)},t.prototype.webRequestComplete=function(e,t){null!=this._webRequestCompleteFunction&&this._webRequestCompleteFunction(e,t)},t.prototype.abortMapBasedActivity=function(){if(this._drawObjectContext){if(!this._drawObjectContext.toolbar||!this._drawObjectContext.drawEvent||!this._drawObjectContext.activityContext)return!1;this._drawObjectContext.toolbar.deactivate(),dojo.disconnect(this._drawObjectContext.drawEvent),this._drawObjectContext.activityContext.abortActivity(),this._drawObjectContext=null}return!0},t.prototype.setDrawObjectContext=function(e){this._drawObjectContext=e},t.prototype.activityBegin=function(e){null!=this._activityBeginFunction&&this._activityBeginFunction(e)},t.prototype.activityComplete=function(e){null!=this._activityCompleteFunction&&this._activityCompleteFunction(e)},t.prototype.activityAbort=function(e){this.workflowAbort(e,e.workflow())},t.prototype.workflowComplete=function(e,t){null!=this._workflowCompleteFunction&&this._workflowCompleteFunction(e,t)},t.prototype.workflowAbort=function(e,t){null!=this._workflowAbortFunction&&this._workflowAbortFunction(e,t)},t}();t.DefaultActivityDispatcher=i}(e.workflow||(e.workflow={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){var i=function(){function t(t,i,r,n,s,a,o,l){this._defaultActivityDispatcher=new e.workflow.DefaultActivityDispatcher,this._drawObjectContext=null,this.isBusy=null,this._dispatchFunction=t||null,this._handleErrorFunction=i||null,this._activityBeginFunction=r||null,this._activityCompleteFunction=n||null,this._workflowCompleteFunction=s||null,this._workflowAbortFunction=a||null,this._webRequestBeginFunction=o||null,this._webRequestCompleteFunction=l||null}return t.prototype.dispatch=function(e){this._defaultActivityDispatcher.canHandleActivity(e)?this._defaultActivityDispatcher.dispatch(e):null!=this._dispatchFunction&&this._dispatchFunction(e)},t.prototype.handleError=function(e,t){null!=this._handleErrorFunction&&this._handleErrorFunction(e,t)},t.prototype.abortMapBasedActivity=function(){if(this._drawObjectContext){if(!this._drawObjectContext.toolbar||!this._drawObjectContext.drawEvent||!this._drawObjectContext.activityContext)return!1;this._drawObjectContext.toolbar.deactivate(),dojo.disconnect(this._drawObjectContext.drawEvent),this._drawObjectContext.activityContext.abortActivity(),this._drawObjectContext=null}return!0},t.prototype.setDrawObjectContext=function(e){this._drawObjectContext=e},t.prototype.activityBegin=function(e){null!=this._activityBeginFunction&&this._activityBeginFunction(e)},t.prototype.activityComplete=function(e){null!=this._activityCompleteFunction&&this._activityCompleteFunction(e)},t.prototype.activityAbort=function(e){this.workflowAbort(e,e.workflow())},t.prototype.webRequestBegin=function(e,t){null!=this._webRequestBeginFunction&&this._webRequestBeginFunction(e,t)},t.prototype.webRequestComplete=function(e,t){null!=this._webRequestCompleteFunction&&this._webRequestCompleteFunction(e,t)},t.prototype.workflowComplete=function(e,t){null!=this._workflowCompleteFunction&&this._workflowCompleteFunction(e,t)},t.prototype.workflowAbort=function(e,t){null!=this._workflowAbortFunction&&this._workflowAbortFunction(e,t)},t.prototype.handleOpenReportUrl=function(e,t){window.open(e)},t}();t.SimpleActivityDispatcher=i}(e.workflow||(e.workflow={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){!function(t){t._pickSupported=function(e,t){if(!e||e.length<=0)return null;if(t)for(var i=t.toUpperCase(),r=0;r<e.length;r++){var n=e[r];if(n&&n.toUpperCase()===i)return e[r]}return e[0]},t.handleIntersectLayers=function(t){var i,r,n,s=[],a=[],o=[],l=[],c=null,u=null,h=null,p=null,d=!1,f=null,y=-1,m=t.getValue("InputLayers");if(m&&m.length>0)for(n=0;n<m.length;n++)(y=m[n].lastIndexOf("\\\\"))>=0&&(m[n]=m[n].substring(y+"\\\\".length));else t.dispatcher().handleError(new Error("Intersect Layers: no input layers provided."),t);for((c=t.getSite())||t.dispatcher().handleError(new Error("Intersect Layers: no site available."),t),(u=c.essentialsMap)||t.dispatcher().handleError(new Error("Intersect Layers: no map available."),t),(!u.mapServices||u.mapServices.length<=0)&&t.dispatcher().handleError(new Error("Intersect Layers: no map service is configured for the map."),t),i=0;i<u.mapServices.length;i++){h=u.mapServices[i].layers,f=[];var g=m.length,v="";for(h.forEach(function(e){v=e.name;for(var t=0;t<g;++t)if(v===m[t]){f.push(e);break}}),r=0;r<f.length;r++){switch(p=f[r],d=!1,p.type){case e.essentials.LayerType.FEATURE_LAYER:a.push(p.name),d=!0;break;case e.essentials.LayerType.GROUP_LAYER:o.push(p.name),d=!0;break;case e.essentials.LayerType.RASTER_LAYER:l.push(p.name),d=!0}d&&s.push(p.name)}}t.setValue("OutputLayers",s),t.setValue("FeatureLayers",a),t.setValue("GroupLayers",o),t.setValue("RasterLayers",l),t.completeActivity()},t.handleExportMap=function(t){var i=t.getValue("TargetSpatialReference"),r=t.getValue("CustomExtent"),n=t.getValue("Resolution"),s=t.getValue("OutputFormat"),a=t.getValue("Scale"),o=t.getValue("ImageHeight"),l=t.getValue("ImageWidth"),c=t.getValue("UseTransparentBackground"),u=null,h=null,p=null,d=null;(u=t.getSite())||t.dispatcher().handleError(new Error("Export Map: no site available."),t),(h=u.getMap())||t.dispatcher().handleError(new Error("Export Map: no map available."),t),(p=u.essentialsMap)||t.dispatcher().handleError(new Error("Export Map: no map available."),t),(d=new e.essentials.ReportParameters).outputFormat=e.workflow.MapActivityHandlers._pickSupported(p.supportedExportFormats,s),n&&(d.resolution=new e.essentials.Resolution("",n)),a&&(d.scale=new e.essentials.Scale("",a)),d.imageHeight=o||h.height,d.imageWidth=l||h.width,r&&(d.customExtent=r),d.extentType=r?e.essentials.ReportParameters.CUSTOM_EXTENT:e.essentials.ReportParameters.CURRENT_EXTENT,d.useTransparentBackground=c,i&&(d.targetSpatialReference=i),h&&d.populateMapGraphicsLayers(h),p.exportMap(d,function(e){var i=e?e.href:null;t.setValue("ResultUrl",i),t.completeActivity()},function(e){t.dispatcher().handleError(new Error("Error exporting map '"+e.message+"'"),t)})},t.handlePrintMap=function(t){var i=t.getValue("TargetSpatialReference"),r=t.getValue("TextFields"),n=t.getValue("CustomExtent"),s=t.getValue("NotificationEmailAddress"),a=t.getValue("Resolution"),o=t.getValue("OutputFormat"),l=t.getValue("Scale"),c=t.getValue("PrintTemplateId"),u=t.getValue("GridId"),h=null;(h=t.getSite())||t.dispatcher().handleError(new Error("Print Map: no site available."),t),h.getMap()||t.dispatcher().handleError(new Error("Print Map: no map available."),t);var p=h.findPrintTemplateById(c);p||t.dispatcher().handleError(new Error("Print Map: unable to find print template '"+c+"'."),t),p.isPrinting()&&t.dispatcher().handleError(new Error("Print Map: unable to perform print operation because print template '"+c+"' is busy."),t);var d=new e.essentials.ReportParameters;if(d.outputFormat=e.workflow.MapActivityHandlers._pickSupported(p.supportedOutputFormats,o),a&&(d.resolution=new e.essentials.Resolution("",a)),l&&(d.scale=new e.essentials.Scale("",l)),s&&(d.notificationEmailAddress=s),n&&(d.customExtent=n),d.extentType=n?e.essentials.ReportParameters.CUSTOM_EXTENT:e.essentials.ReportParameters.CURRENT_EXTENT,i&&(d.targetSpatialReference=i),p.textFields&&p.textFields.length>0&&r)for(var f=0;f<r.length;f++)if(r[f])for(var y=0;y<p.textFields.length;y++)if(r[f].Key===p.textFields[y].displayName){var m=new e.essentials.TextField(p.textFields[y].id,"",r[f].Value,!1);d.fields.push(m)}if(u){var g=dojo.filter(p.grids,function(e){return e.id==u});g.length>0&&(d.grid=g[0])}p.print(d,function(e){var i=e?e.href:null;t.setValue("ResultUrl",i),t.completeActivity()},function(e){t.dispatcher().handleError(new Error("Error printing map '"+e.message+"'"),t)})}}(t.MapActivityHandlers||(t.MapActivityHandlers={}))}(e.workflow||(e.workflow={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){!function(t){t.handleIntersectLayers=function(t){e.workflow.MapActivityHandlers.handleIntersectLayers(t)},t.handleExportMap=function(t){e.workflow.MapActivityHandlers.handleExportMap(t)},t.handlePrintMap=function(t){e.workflow.MapActivityHandlers.handlePrintMap(t)},t.handleRefreshMap=function(t){var i=t.getValue("MapServiceId");if(null==t.getEsriMap())throw new Error("Refresh Map: no map available.");var r=function(e){var t=e.serviceLayer;if("function"==typeof t.refresh)if("boolean"==typeof t.disableClientCaching){var i=t.disableClientCaching;t.disableClientCaching=!0,t.refresh(),t.disableClientCaching=i}else t.refresh()},n=t.workflow().site.essentialsMap.mapServices;if(i){var s=e.essentials.utilities.SiteResourceIdComparer.lookUp(n,i);s&&r(s)}else dojo.forEach(n,function(e){r(e)});t.completeActivity()},t.handleGetMapExtent=function(e){var t=e.getEsriMap();if(null==t)throw new Error("Get Map Extent: No map available.");e.setValue("Extent",t.extent),e.completeActivity()},t.handleGetMapInfo=function(e){var t=e.getEsriMap();if(null==t)throw new Error("Get Map Info: No map available.");e.setValue("Extent",t.extent),e.setValue("Scale",esri.geometry.getScale(t)),e.setValue("SpatialReference",t.spatialReference),e.setValue("Height",t.height),e.setValue("Width",t.width);var i=[];null!=t.layerIds&&(i=i.concat(t.layerIds)),null!=t.graphicsLayerIds&&(i=i.concat(t.graphicsLayerIds)),e.setValue("MapServiceIds",i),e.completeActivity()},t.handleSetMapExtent=function(e){var t=e.getValue("Extent");if(null==t)throw new Error("Set Map Extent: required Extent argument was not supplied.");var i=e.getEsriMap();if(null==i)throw new Error("Set Map Extent: No map available.");t.spatialReference&&(t.spatialReference.wkid||t.spatialReference.wkt)||(t.spatialReference=i.spatialReference);var r=e.getSite();r&&r.essentialsMap?r.essentialsMap.extentManager.setExtentWithPriority(t,10):i.setExtent(t),e.completeActivity()},t.handleCaptureGeometry=function(e){function t(t,r,n){n.deactivate(),dojo.disconnect(r),i.setDrawObjectContext(null),e.setValue("Result",t),e.completeActivity()}var i=e.dispatcher();if(!i.abortMapBasedActivity())throw new Error("Could not deactivate current map based activity.");var r=e.getValue("CaptureType"),n=e.getEsriMap();if(null==n)throw new Error("Capture Geometry: No map available.");if("function"!=typeof esri.toolbars.Draw)throw new Error('dojo.require("esri.toolbars.draw") must be added to your client code to use CaptureGeometry activity.');var s=new esri.toolbars.Draw(n),a=dojo.connect(s,"onDrawEnd",dojo.hitch(a,function(e){t(e,a,s)})),o=!0,l=function(e){var i;switch(e){case 0:i=esri.toolbars.Draw.EXTENT;break;case 1:i=esri.toolbars.Draw.FREEHAND_POLYGON;break;case 2:i=esri.toolbars.Draw.FREEHAND_POLYLINE;break;case 3:i=esri.toolbars.Draw.LINE;break;case 4:i=esri.toolbars.Draw.POINT;break;case 5:i=esri.toolbars.Draw.MULTI_POINT;break;case 6:i=esri.toolbars.Draw.POLYGON;break;case 7:i=esri.toolbars.Draw.POLYLINE;break;case 8:t(n.extent,a,s),o=!1;break;default:i=esri.toolbars.Draw.EXTENT}return i}(r);o&&s.activate(l),i.setDrawObjectContext({activityContext:e,toolbar:s,drawEvent:a})}}(t.DefaultActivityHandlers||(t.DefaultActivityHandlers={}))}(e.workflow||(e.workflow={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){!function(t){t.parseObject=function(t){if(t)try{if(3===t.nodeType||4===t.nodeType){var i=String.prototype.trim?t.nodeValue.trim():dojo.string.trim(t.nodeValue);return 0===i.length?null:i}if(1===t.nodeType){var r={},n=0;dojo.forEach(t.attributes,function(e){r[e.nodeName]=e.nodeValue});var s=t.childNodes;return dojo.forEach(s,function(t){var i=e.essentials.xmlUtils.parseObject(t);i&&(n++,r[t.nodeName]?(!1===dojo.isArray(r[t.nodeName])&&(r[t.nodeName]=[r[t.nodeName]]),r[t.nodeName].push(i)):r[t.nodeName]=i)}),1===n&&r["#text"]?r["#text"]:1===n&&r["#cdata-section"]?r["#cdata-section"]:r}}catch(e){throw new Error("Unable to parse XML object: "+e.toString())}return null},t.getAllNodes=function(e){var t=new dojo.NodeList;if(dojo.isIE)for(var i=e.childNodes,r=0;r<i.length;r++)t.push(i[r]);else t=dojo.query("*",e);return t},t.getNodes=function(e,t,i){var r=new dojo.NodeList;if(dojo.isIE){var n=i.getElementsByTagName(e);dojo.forEach(n,function(e,i,n){var s=e.getElementsByTagName(t);dojo.forEach(s,function(e,t,i){r.push(e)})})}else r=dojo.query(e+" > "+t,i);return r},t.getValue=function(e,t){if(e){var i=e;if(dojo.isString(e)){var r=e.split(" > ");i=this.getNodes(r[0],r[1],t)[0]}return i.firstChild&&i.firstChild.nodeValue?i.firstChild.nodeValue:"Node not valid"}return"No Value"},t.getAttribute=function(e,t){if(e){if(dojo.isIE){for(var i=0;i<e.attributes.length;i++)if(e.attributes[i].nodeName==t)return e.attributes[i].nodeValue;return null}return e.getAttribute(t)}return"No Value"}}(t.xmlUtils||(t.xmlUtils={}))}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){var i=function(){return function(t,i){this.error=i,this.resultObject=t,t&&(this.rawJson=e.encodeJson(t))}}();t.RestEndpointResult=i}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){var i=function(){function t(){this._activeEndpointRequest=!1,this._onRequestComplete=null,this._onRequestError=null}return t.prototype.getCustomRestEndpoint=function(t,i,r,n,s){this._activeEndpointRequest?this._onEndpointRequestError(new Error("An operation is already in progress.")):(this._activeEndpointRequest=!0,this._onRequestComplete=r,this._onRequestError=n,e.request({url:t,content:i,load:dojo.hitch(this,this._onEndpointRequestComplete),error:dojo.hitch(this,this._onEndpointRequestError),callbackParamName:"CallBack"},s))},t.prototype._onEndpointRequestComplete=function(t){this._activeEndpointRequest=!1;try{t||(t={error:new Error("Expected results")}),t.error&&this._onRequestError&&this._onRequestError(t.error)}finally{this._onRequestComplete&&this._onRequestComplete(new e.essentials.RestEndpointResult(t,t.error))}},t.prototype._onEndpointRequestError=function(t){this._activeEndpointRequest=!1;try{this._onRequestError&&this._onRequestError(t)}finally{this._onRequestComplete&&this._onRequestComplete(new e.essentials.RestEndpointResult(null,t))}},t}();t.RestUtility=i}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));var geocortex;!function(e){!function(t){var i=function(t){function i(e){t.call(this,e),this._colorSet=!1,this._layerLoadCompleted=null,this.color=null,this.feedUrl=null,this.feedImageUri=null,this.updateInterval=null,this.pictureSymbol=null,this.markerSymbol=null,this.geoRssLayer=null,this.mapSpatialReference=null,this.geometryService=null}return __extends(i,t),i.prototype._configureObject=function(e,r){if(void 0===e)throw new Error("Incorrect map service object returned from initialization");i.webMercatorSref=new esri.SpatialReference({wkid:102100}),i.wgs84Sref=new esri.SpatialReference({wkid:4326}),this.feedImageUri=e.feedImageUri,this.updateInterval=e.updateInterval,this.geoRssLayer=new esri.layers.GraphicsLayer({opacity:e.opacity,id:e.id,visible:e.visible}),dojo.connect(this.geoRssLayer,"onError",this,this._layerLoadErrorHandler),e.color&&(this.color=e.color,this._colorSet=!0,this.color.length>3&&(this.color[3]=this.color[3]/255)),t.prototype._configureObject.call(this,e,r),this.attributionDataUrl&&""!==this.attributionDataUrl?(this.geoRssLayer.attributionDataUrl=this.attributionDataUrl,this.geoRssLayer.hasAttributionData=!0):this.hasAttributionData&&(this.geoRssLayer.attributionDataUrl=this.url+"/Attribution",this.geoRssLayer.hasAttributionData=!0)},i.prototype._createServiceLayer=function(){var t=null;if(this.essentialsMap&&(t=this.essentialsMap.site,this.mapSpatialReference=this.essentialsMap.initialExtent.spatialReference),this.feedImageUri?(this.feedImageUri=e.essentials.RestHelper.processClientSideTokens(t,this.feedImageUri),this.pictureSymbol=new esri.symbol.PictureMarkerSymbol(this.feedImageUri,25,25)):this.markerSymbol=new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE,15,new esri.symbol.SimpleLineSymbol,new esri.Color(this.color)),this.feedUrl=this.serviceUrl,this._loadFeed(),this.updateInterval&&!isNaN(this.updateInterval)){var i=this;this._layerLoadCompleted=!1;var r=setInterval(function(){i._layerLoadCompleted&&i._loadFeed(),i._layerLoadCompleted=!1},1e3*this.updateInterval);dojo.connect(window,"onunload",function(){clearInterval(r)})}this.serviceLayer=this.geoRssLayer},i.prototype._loadFeed=function(){esri.config.defaults.io.proxyUrl&&esri.request({url:this.serviceUrl,content:{},handleAs:"xml",load:dojo.hitch(this,this._handleFeed),error:function(e){e&&e.message&&"string"==typeof e.message&&alert(e.message)}})},i.prototype._handleFeed=function(t){var i=this._getFeedRoot(t);if(i){var r=i.nodeName,n=e.essentials.xmlUtils.getAttribute(i,"xml:base"),s=[],a=null;if("feed"===r?a=e.essentials.xmlUtils.getNodes("feed","entry",t):"rdf"===r?a=e.essentials.xmlUtils.getNodes("rdf","item",t):"rss"===r&&(a=e.essentials.xmlUtils.getNodes("channel","item",t)),a){var o=this.pictureSymbol||this.markerSymbol;a.forEach(dojo.hitch(this,function(t,i,a){var l,c,u,h=null;if(e.essentials.xmlUtils.getAllNodes(t).forEach(dojo.hitch(this,function(t,i,s){t.nodeName&&("title"===t.nodeName&&(l=t.firstChild.nodeValue),"feed"===r?"summary"===t.nodeName&&(u=t.firstChild.nodeValue):"description"===t.nodeName&&(u=t.firstChild.nodeValue),"link"===t.nodeName&&(c="feed"===r?(n||"")+e.essentials.xmlUtils.getAttribute(t,"href"):(n||"")+t.firstChild.nodeValue),"georss:where"===t.nodeName&&(h=this._getGMLGRSSPoint(t)),"georss:point"===t.nodeName&&(h=this._getSimpleGRSSPoint(t)),"geo:lat"===t.nodeName&&(h=this._getW3CGRSSPoint(t)))})),h){var p={title:l,content:u,link:c};s.push(new esri.Graphic(h,o,p,null))}})),this.mapSpatialReference&&this._projectShapes(s,this.mapSpatialReference)}}},i.prototype._projectShapes=function(e,t){if(e&&t){for(var r=!1,n=i.webMercatorSref.wkid,s=i.wgs84Sref.wkid,a=0;a<e.length;a++){var o=e[a],l=null;o.geometry&&o.geometry.spatialReference.wkid!==t.wkid&&(t.wkid===n&&o.geometry.spatialReference.wkid===s?l=esri.geometry.geographicToWebMercator(o.geometry):t.wkid===s&&o.geometry.spatialReference.wkid===n?l=esri.geometry.webMercatorToGeographic(o.geometry):(l=esri.geometry.geographicToWebMercator(o.geometry),r=!0),o.geometry=l)}if(r){var c=[],u=this.geometryServiceUrl||this._getDefaultGeometryServiceUrl(),h=this.geometryServiceUrl?null:this._getDefaultGeometryServiceToken();null!==h&&(u+=(u.indexOf("?")>-1?"&token=":"?token=")+encodeURIComponent(h)),this.geometryService=new esri.tasks.GeometryService(u),dojo.forEach(e,function(e){c.push(e.geometry)});var p=new esri.tasks.ProjectParameters;return p.geometries=c,p.outSR=t,void this.geometryService.project(p,dojo.hitch(this,function(t){for(var i=0;i<t.length;i++)e[i].geometry=t[i];this._publishLayer(e)}),this._projectionError)}}this._publishLayer(e)},i.prototype._publishLayer=function(e){if(this.geoRssLayer){this.geoRssLayer.clear(),dojo.forEach(e,dojo.hitch(this,function(e){this.geoRssLayer.add(e)})),this.geoRssLayer.redraw();var t={esriLayer:this.geoRssLayer};dojo.publish("geoRssLayerLoaded",[t]),this._layerLoadCompleted=!0}},i.prototype._projectionError=function(e){},i.prototype._getSimpleGRSSPoint=function(e){var t=e.firstChild.nodeValue.split(" ");return new esri.geometry.Point(parseFloat(t[1]),parseFloat(t[0]),i.wgs84Sref)},i.prototype._getGMLGRSSPoint=function(e){var t=this._getNonTextNodeChild(e),r=this._getNonTextNodeChild(t).firstChild.nodeValue.split(" ");return new esri.geometry.Point(parseFloat(r[1]),parseFloat(r[0]),i.wgs84Sref)},i.prototype._getNonTextNodeChild=function(e){for(var t=e.childNodes,i=0;i<t.length;i++)if(3!==t[i].nodeType)return t[i]},i.prototype._getW3CGRSSPoint=function(e){if(!e.nextSibling)return null;var t=e.nextSibling;"#text"===e.nextSibling.nodeName&&(t=e.nextSibling.nextSibling);var r=e.firstChild.nodeValue,n=t.firstChild.nodeValue;return new esri.geometry.Point(parseFloat(n),parseFloat(r),i.wgs84Sref)},i.prototype._getFeedRoot=function(e){if(!e)throw new Error("The GeoRSS service at "+this.feedUrl+" returned an invalid response.");for(var t=e.childNodes,i=0;i<t.length;i++)if(t[i]&&"xml"!==t[i].nodeName.substring(0,3))return t[i];return null},i.webMercatorSref=null,i.wgs84Sref=null,i}(t.MapService);t.GeoRssLayerService=i}(e.essentials||(e.essentials={}))}(geocortex||(geocortex={}));