/* --------------------------------------------------
Javascript Only Barcode_Reader (JOB) V1.6 by Eddie Larsson <https://github.com/EddieLa/BarcodeReader>

This software is provided under the MIT license, http://opensource.org/licenses/MIT.
All use of this software must include this
text, including the reference to the creator of the original source code. The
originator accepts no responsibility of any kind pertaining to
use of this software.

Copyright (c) 2013 Eddie Larsson

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.

------------------------ */

function Rotate(a,c,d,e){var f=[];switch(e){case 90:for(e=0;e<c*4;e+=4)for(var g=c*4*(d-1);g>=0;g-=c*4)f.push(a[e+g]),f.push(a[e+g+1]),f.push(a[e+g+2]),f.push(a[e+g+3]);break;case -90:for(e=c*4-4;e>=0;e-=4)for(g=0;g<a.length;g+=c*4)f.push(a[e+g]),f.push(a[e+g+1]),f.push(a[e+g+2]),f.push(a[e+g+3]);break;case 180:for(g=c*4*(d-1);g>=0;g-=c*4)for(e=c*4-4;e>=0;e-=4)f.push(a[e+g]),f.push(a[e+g+1]),f.push(a[e+g+2]),f.push(a[e+g+3])}return new Uint8ClampedArray(f)}
function BoxFilter(a,c,d){for(var e=[],f=[],g=0;g<c;g++){e.push([]);f.push(0);for(var l=0;l<(d+1)*c;l+=c)e[e.length-1].push(a[g+l]),f[f.length-1]+=a[g+l]}for(var m=[],l=0;l<a.length;l+=c){for(g=0;g<c;g++){for(var i=0,j=0,b=g;b>=0;b--)if(i+=f[b],j++,j==d+1)break;for(var n=0,b=g+1;b<c;b++)if(i+=f[b],j++,n++,n==d)break;j*=e[0].length;i/=j;m.push(i)}if(l-d*c>=0)for(b=0;b<e.length;b++)g=e[b].shift(),f[b]-=g;if(l+(d+1)*c<a.length)for(b=0;b<e.length;b++)g=a[b+l+(d+1)*c],e[b].push(g),f[b]+=g}return m}
function Scale(a,c){for(var d=[],e=0;e<a.length;e+=c*8)for(var f=0;f<c*4;f+=8)d.push((a[e+f]+a[e+f+4]+a[e+c*4+f]+a[e+c*4+f+4])/4),d.push((a[e+f+1]+a[e+f+4+1]+a[e+c*4+f+1]+a[e+c*4+f+4+1])/4),d.push((a[e+f+2]+a[e+f+4+2]+a[e+c*4+f+2]+a[e+c*4+f+4+2])/4),d.push(255);return new Uint8ClampedArray(d)}
function IntensityGradient(a,c){for(var d=[],e=Number.MAX_VALUE,f=0;f<a.length;f+=c*4)for(var g=0;g<c*4;g+=4){for(var l=0,m=0,i=1;i<2;i++)g+i*4<c*4&&(l+=Math.abs(a[f+g]-a[f+g+i*4])),f+c*4*i<a.length&&(m+=m+Math.abs(a[f+g]-a[f+g+c*4*i]));l-=m;e=l<e?l:e;d.push(l)}if(e<0)for(i=0;i<d.length;i++)d[i]-=e;return d}
function greyScale(a){for(var c=0;c<a.length;c+=4){var d=0,e=255,d=a[c]>d?a[c]:d,d=a[c+1]>d?a[c+1]:d,d=a[c+2]>d?a[c+2]:d,e=a[c]<e?a[c]:e,e=a[c+1]<e?a[c+1]:e,e=a[c+2]<e?a[c+2]:e;a[c]=a[c+1]=a[c+2]=(d+e)/2}}function histogram(a){for(var c=[],d=0;d<256;d++)c[d]=0;for(d=0;d<a.length;d+=4)c[a[d]]+=1;return c}
function otsu(a,c){for(var d=0,e=1;e<a.length;++e)d+=e*a[e];for(var f=0,g=0,l=0,m,i,j=0,b=l=0,n=0,e=0;e<a.length;++e)if(g+=a[e],g!=0){l=c-g;if(l==0)break;f+=e*a[e];m=f/g;i=(d-f)/l;l=g*l*Math.pow(m-i,2);l>=j&&(b=e,l>j&&(n=e),j=l)}return(b+n)/2}
function CreateImageData(){Image.data=new Uint8ClampedArray(Image.width*Image.height*4);for(var a,c=0;c<Image.height;c++)for(var d=0;d<Image.width;d++)a=c*4*Image.width,Image.data[a+d*4]=Image.table[d][c][0],Image.data[a+d*4+1]=Image.table[d][c][1],Image.data[a+d*4+2]=Image.table[d][c][2],Image.data[a+d*4+3]=Image.table[d][c][3]}
function CreateScanImageData(){ScanImage.data=new Uint8ClampedArray(ScanImage.width*ScanImage.height*4);for(var a,c=0;c<ScanImage.height;c++)for(var d=0;d<ScanImage.width;d++)a=c*4*ScanImage.width,ScanImage.data[a+d*4]=ScanImage.table[d][c][0],ScanImage.data[a+d*4+1]=ScanImage.table[d][c][1],ScanImage.data[a+d*4+2]=ScanImage.table[d][c][2],ScanImage.data[a+d*4+3]=ScanImage.table[d][c][3]}
function CreateTable(){Image.table=[];for(var a=[],c=0;c<Image.width*4;c+=4){for(var a=[],d=c;d<Image.data.length;d+=Image.width*4)a.push([Image.data[d],Image.data[d+1],Image.data[d+2],Image.data[d+3]]);Image.table.push(a)}}function CreateScanTable(){ScanImage.table=[];for(var a=[],c=0;c<ScanImage.width*4;c+=4){for(var a=[],d=c;d<ScanImage.data.length;d+=ScanImage.width*4)a.push([ScanImage.data[d],ScanImage.data[d+1],ScanImage.data[d+2],ScanImage.data[d+3]]);ScanImage.table.push(a)}}
function EnlargeTable(a,c){for(var d=[],e=0;e<Image.width;e++){for(var d=[],f=0;f<Image.height;f++)for(var g=0;g<a;g++)d.push(Image.table[e][f]);Image.table[e]=d.slice()}d=Image.table.slice();for(e=0;e<Image.width;e++)for(g=0;g<c;g++)Image.table[e*c+g]=d[e].slice();Image.width=Image.table.length;Image.height=Image.table[0].length;CreateImageData()}
function ScaleHeight(a){for(var c=[],d=0,e=0,f=0,g=0;g<Image.height-a;g+=a)for(var l=0;l<Image.width;l++){for(var f=e=d=0,m=g;m<g+a;m++)d+=Image.table[l][m][0],e+=Image.table[l][m][1],f+=Image.table[l][m][2];c.push(d/a);c.push(e/a);c.push(f/a);c.push(255)}return new Uint8ClampedArray(c)}function Intersects(a,c){return a[0][0]<=c[0][1]&&c[0][0]<=a[0][1]&&a[1][0]<=c[1][1]&&c[1][0]<=a[1][1]}
function maxLocalization(a,c,d){var e=a,f=[];do{for(var g=c%Image.width,c=(c-g)/Image.width,a=0,l=Image.height,m=0,i=Image.width-1,j=c;j<Image.height-1;j++)if(Image.table[g][j+1][0]==0){l=j;break}for(j=c;j>0;j--)if(Image.table[g][j-1][0]==0){a=j;break}for(var b=g;b<Image.width-1;b++)if(Image.table[b+1][c][0]==0){i=b;break}for(b=g;b>0;b--)if(Image.table[b-1][c][0]==0){m=b;break}for(j=a*Image.width;j<=l*Image.width;j+=Image.width)for(b=m;b<=i;b++)d[j+b]=0;c=[[m,i],[a,l]];for(g=0;g<f.length;g++)if(Intersects(c,
f[g])){f[g][0][1]-f[g][0][0]>c[0][1]-c[0][0]?(f[g][0][0]=f[g][0][0]<c[0][0]?f[g][0][0]:c[0][0],f[g][0][1]=f[g][0][1]>c[0][1]?f[g][0][1]:c[0][1]):(f[g][0][0]=f[g][0][0]<c[0][0]?f[g][0][0]:c[0][0],f[g][0][1]=f[g][0][1]>c[0][1]?f[g][0][1]:c[0][1],f[g][1][0]=c[1][0],f[g][1][1]=c[1][1]);c=[];break}c.length>0&&f.push(c);for(g=c=a=0;g<d.length;g++)d[g]>a&&(a=d[g],c=g)}while(a>e*0.7);return f}
function ImgProcessing(){greyScale(Image.data);for(var a=IntensityGradient(Image.data,Image.width),a=BoxFilter(a,Image.width,15),c=a[0],d=1;d<a.length;d++)c=c>a[d]?a[d]:c;for(var e=0,f=0,g=0,d=0;d<a.length;d++)a[d]=Math.round(a[d]-c),g+=a[d],e<a[d]&&(e=a[d],f=d);g/=a.length;if(g<15){a=BoxFilter(a,Image.width,8);c=a[0];for(d=1;d<a.length;d++)c=c>a[d]?a[d]:c;for(d=f=e=0;d<a.length;d++)a[d]=Math.round(a[d]-c),e<a[d]&&(e=a[d],f=d)}c=[];for(d=0;d<=e;d++)c[d]=0;for(d=0;d<a.length;d++)c[a[d]]+=1;c=otsu(c,
a.length);for(d=0;d<a.length;d++)Image.data[d*4]=a[d]<c?Image.data[d*4+1]=Image.data[d*4+2]=0:Image.data[d*4+1]=Image.data[d*4+2]=255;CreateTable();a=maxLocalization(e,f,a);e=[];for(d=0;d<a.length;d++)e.push({x:a[d][0][0],y:a[d][1][0],width:a[d][0][1]-a[d][0][0],height:a[d][1][1]-a[d][1][0]});e.length>0&&postMessage({result:e,success:"localization"});allTables=[];for(d=0;d<a.length;d++){e=[];for(f=a[d][0][0]*2;f<a[d][0][1]*2;f++){c=[];for(g=a[d][1][0]*2;g<a[d][1][1]*2;g++)c.push([ScanImage.table[f][g][0],
ScanImage.table[f][g][1],ScanImage.table[f][g][2],255]);e.push(c)}if(!(e.length<1))Image.table=e,Image.width=e.length,Image.height=e[0].length,CreateImageData(),allTables.push({table:e,data:new Uint8ClampedArray(Image.data),width:Image.width,height:Image.height})}}function showImage(a,c,d){postMessage({result:a,width:c,height:d,success:"image"})}
function Main(){ImgProcessing();for(var a=[],c=0;c<allTables.length;c++){Image=allTables[c];var d=ScaleHeight(30),e,f=0,g="",l={},m=[];Selection=false;do{e=d.subarray(f,f+Image.width*4);for(var i=[],j=0;j<256;j++)i[j]=0;for(j=0;j<e.length;j+=4){var b=Math.round((e[j]+e[j+1]+e[j+2])/3);i[b]+=1}j=otsu(i,e.length/4);i=j<41?1:j-40;j=j>214?254:j+40;e=yStraighten(e,i,j);Selection=BinaryString(e);Selection.string?(g=Selection.format,e=Selection,Selection=Selection.string,g=="EAN-13"&&(typeof l[Selection]==
"undefined"?(l[Selection]={count:1,correction:e.correction},m.push(Selection)):(l[Selection].count+=1,l[Selection].correction+=e.correction),Selection=false)):Selection=false;f+=Image.width*4}while(!Selection&&f<d.length);Selection&&g!="EAN-13"&&a.push({Format:g,Value:Selection});g=="EAN-13"&&(Selection=false);if(!Selection){EnlargeTable(4,2);f=0;d=ScaleHeight(20);do{e=d.subarray(f,f+Image.width*4);i=[];for(j=0;j<256;j++)i[j]=0;for(j=0;j<e.length;j+=4)b=Math.round((e[j]+e[j+1]+e[j+2])/3),i[b]+=1;
j=otsu(i,e.length/4);i=j<40?0:j-40;j=j>215?255:j+40;e=yStraighten(e,i,j);Selection=BinaryString(e);Selection.string?(g=Selection.format,e=Selection,Selection=Selection.string,g=="EAN-13"&&(typeof l[Selection]=="undefined"?(l[Selection]={count:1,correction:e.correction},m.push(Selection)):(l[Selection].count+=1,l[Selection].correction+=e.correction),Selection=false)):Selection=false;f+=Image.width*4}while(!Selection&&f<d.length);if(g=="EAN-13"){var d={},n;for(n in l)l[n].correction/=l[n].count,f=l[n].correction,
f-=l[n].count,f+=m.indexOf(n),d[n]=f;l=Number.POSITIVE_INFINITY;m="";for(n in d)d[n]<l&&(l=d[n],m=n);Selection=l<11?m:false}Selection&&a.push({Format:g,Value:Selection})}if(a.length>0&&!Multiple)break}return a}
function yStraighten(a,c,d){for(var e=0,f=new Uint8ClampedArray(Image.width*(d-c+1)*4),g=0;g<f.length;g++)f[g]=255;for(g=0;g<Image.width*4;g+=4){c=d;e=(a[g]+a[g+1]+a[g+2])/3;g<Image.width*4-4&&(e+=(a[g+4]+a[g+5]+a[g+6])/3,e/=2);for(var l=g;l<f.length;l+=Image.width*4)e<c&&(f[l]=f[l+1]=f[l+2]=0),c--}return f}
function CheckEan13(a,c){if(c){if(a.length!=5)return false}else if(a.length!=3)return false;for(var d=0,e=0;e<a.length;e++)d+=a[e];d/=a.length;for(e=0;e<a.length;e++)if(a[e]/d<0.5||a[e]/d>1.5)return false;return true}function TwoOfFiveStartEnd(a){if(a.length<5||a.length>6)return false;for(var c=0,d=[0,0],e=0;e<a.length;e++)a[e]>c&&(c=a[e],d[0]=e);for(e=c=0;e<a.length;e++)e!=d[0]&&a[e]>c&&(c=a[e],d[1]=e);return d[0]+d[1]==2}
function CheckInterleaved(a,c){for(var d=0,e=0;e<a.length;e++)d+=a[e];d/=4;if(c){if(a.length!=4)return false;e=0}else{if(a.length!=3)return false;for(var f=0,g,e=0;e<a.length;e++)a[e]>f&&(f=a[e],g=e);if(g!=0)return false;if(a[0]/d<1.5||a[0]/d>2.5)return false;e=1}for(;e<a.length;e++)if(a[e]/d<0.5||a[e]/d>1.5)return false;return true}
function BinaryConfiguration(a,c){var d=[],e=[],f=0,g,l;if(c=="Code128"||c=="Code93"){l=6;g=a[0];c=="Code128"&&(g/=2);for(f=0;f<a.length;f++)if(a[f]>g*6){a.splice(f,a.length);break}do a.length==7&&c=="Code128"?d.push(a.splice(0,a.length)):d.push(a.splice(0,l)),c=="Code93"&&a.length<6&&a.splice(0,l);while(a.length>0)}if(c=="Code39"){l=9;g=a[0];for(f=0;f<a.length;f++)if(a[f]>g*5){a.splice(f,a.length);break}do d.push(a.splice(0,l)),a.splice(0,1);while(a.length>0)}if(c=="EAN-13"){l=4;g=a[0];for(f=e=0;f<
a.length;f++)if(a[f]>g*6){a.splice(f,a.length);break}CheckEan13(a.splice(0,3),false)&&e++;f=0;do d.push(a.splice(0,l)),f++,f==6&&CheckEan13(a.splice(0,5),true)&&e++;while(d.length<12&&a.length>0);CheckEan13(a.splice(0,3),false)&&e++;if(e<2)return[]}if(c=="2Of5"){l=5;g=a[0]/2;for(f=0;f<a.length;f++)if(a[f]>g*5){a.splice(f,a.length);break}f=a.splice(0,6);d.push(f);do{e=[];for(f=0;f<l;f++)e.push(a.splice(0,1)[0]),a.splice(0,1);d.push(e);a.length==5&&d.push(a.splice(0,5))}while(a.length>0)}if(c=="Inter2Of5"){l=
5;g=a[0];for(f=0;f<a.length;f++)if(a[f]>g*5){a.splice(f,a.length);break}d.push(a.splice(0,4));g=[];do{e=[];g=[];for(f=0;f<l;f++)e.push(a.splice(0,1)[0]),g.push(a.splice(0,1)[0]);d.push(e);d.push(g);a.length==3&&d.push(a.splice(0,3))}while(a.length>0)}if(c=="Codabar"){l=7;g=a[0];for(f=0;f<a.length;f++)if(a[f]>g*5){a.splice(f,a.length);break}do d.push(a.splice(0,l)),a.splice(0,1);while(a.length>0)}return d}
function BinaryString(a){for(var c=[],d=[],e=255,f=0,g,l=0;l<a.length-Image.width*4;l+=Image.width*4){for(var d=a.subarray(l,l+Image.width*4),c=[],m=0;d[m]==255;)m+=4;for(;m<d.length;){f=0;for(e=d[m];d[m]==e&&m<d.length;)f++,m+=4;c.push(f)}c.length>2&&c[0]<=c[1]/10&&c.splice(0,2);e=c.slice();f=false;for(m=0;m<FormatPriority.length;m++){var c=e.slice(),i,j,c=BinaryConfiguration(c,FormatPriority[m]);if(FormatPriority[m]=="2Of5"||FormatPriority[m]=="Inter2Of5")i=c.splice(0,1)[0],j=c.splice(c.length-
1,1)[0];d=Distribution(c,FormatPriority[m]);FormatPriority[m]=="EAN-13"?(c=d.data,corrections=d.correction):c=d;if(typeof c!="undefined"){if(c.length>4||FormatPriority[m]=="Code39"&&c.length>2)if(FormatPriority[m]=="Code128")CheckCode128(c)&&(c=DecodeCode128(c),f=true);else if(FormatPriority[m]=="Code93")CheckCode93(c)&&(c=DecodeCode93(c),f=true);else if(FormatPriority[m]=="Code39")CheckCode39(c)&&(c=DecodeCode39(c),f=true);else if(FormatPriority[m]=="EAN-13"){if((d=DecodeEAN13(c))&&d.length===13)c=
d,f=true}else if(FormatPriority[m]=="2Of5"||FormatPriority[m]=="Inter2Of5"){if(FormatPriority[m]=="2Of5"){if(typeof i!="undefined"&&!TwoOfFiveStartEnd(i,true))continue;if(typeof j!="undefined"&&!TwoOfFiveStartEnd(j,false))continue}if(FormatPriority[m]=="Inter2Of5"){if(typeof i!="undefined"&&!CheckInterleaved(i,true))continue;if(typeof j!="undefined"&&!CheckInterleaved(j,false))continue}if(d=Decode2Of5(c))c=d,f=true}else if(FormatPriority[m]=="Codabar"&&(d=DecodeCodaBar(c)))c=d,f=true;if(f){g=FormatPriority[m];
g=="Inter2Of5"&&(g="Interleaved 2 of 5");g=="2Of5"&&(g="Standard 2 of 5");break}}}if(f)break}return g=="Code128"?typeof c.string==="string"?c:{string:false}:typeof c==="string"?g=="EAN-13"?{string:c,format:g,correction:corrections}:{string:c,format:g}:{string:false}}
function Distribution(a,c){var c=availableFormats.indexOf(c),d=0,e=[],f,g,l;c===0?(g=11,f=6,l=4):c===1?(g=9,f=6,l=4):c===2?(g=12,f=9):c===3?(g=7,l=f=4):c==6&&(f=7);for(var m=0;m<a.length;m++){var i=a[m],j=0,b=j=0,n=[];if(c==6){if(i.length!=7)return[];if(m==0||m==a.length-1){for(var j=[[0,0],[0,0]],h=[0,0],b=0;b<i.length;b++)if(b%2==0)i[b]>h[0]&&(h[0]=i[b],h[1]=b);else if(i[b]>j[0][0]){j[0][0]=i[b];var k=j[0][1];j[0][1]=b;b=k-1}else i[b]>j[1][0]&&b!=j[0][1]&&(j[1][0]=i[b],j[1][1]=b);if(SecureCodabar){k=
j[0][0]+j[1][0]+h[0];k/=3;for(var o=[j[0][0],j[1][0],h[0]],b=0;b<o.length;b++)if(o[b]/k>1.5||o[b]/k<0.5)return[];for(b=k=0;b<i.length;b++)b==h[1]||b==j[0][1]||b==j[1][1]||(k+=i[b]);k/=4;for(b=0;b<i.length;b++)if(!(b==h[1]||b==j[0][1]||b==j[1][1]))if(i[b]/k>1.5||i[b]/k<0.5)return[]}for(b=0;b<i.length;b++)b==h[1]||b==j[0][1]||b==j[1][1]?n.push(1):n.push(0)}else{h=[0,0];j=[0,0];for(b=0;b<i.length;b++)b%2==0?i[b]>h[0]&&(h[0]=i[b],h[1]=b):i[b]>j[0]&&(j[0]=i[b],j[1]=b);if(h[0]/j[0]>1.55){h=[h,[0,0],[0,
0]];for(b=0;b<i.length;b++)b%2==0&&(i[b]>h[1][0]&&b!=h[0][1]?(h[1][0]=i[b],k=h[1][1],h[1][1]=b,b=k-1):i[b]>h[2][0]&&b!=h[0][1]&&b!=h[1][1]&&(h[2][0]=i[b],h[2][1]=b));if(SecureCodabar){k=h[0][0]+h[1][0]+h[2][0];k/=3;for(b=0;b<h.length;b++)if(h[b][0]/k>1.5||h[b][0]/k<0.5)return[];for(b=k=0;b<i.length;b++)b==h[0][1]||b==h[1][1]||b==h[2][1]||(k+=i[b]);k/=4;for(b=0;b<i.length;b++)if(!(b==h[0][1]||b==h[1][1]||b==h[2][1]))if(i[b]/k>1.5||i[b]/k<0.5)return[]}for(b=0;b<i.length;b++)b==h[0][1]||b==h[1][1]||
b==h[2][1]?n.push(1):n.push(0)}else{if(SecureCodabar){k=h[0]+j[0];k/=2;if(h[0]/k>1.5||h[0]/k<0.5)return[];if(j[0]/k>1.5||j[0]/k<0.5)return[];for(b=k=0;b<i.length;b++)b==h[1]||b==j[1]||(k+=i[b]);k/=5;for(b=0;b<i.length;b++)if(!(b==h[1]||b==j[1]))if(i[b]/k>1.5||i[b]/k<0.5)return[]}for(b=0;b<i.length;b++)b==h[1]||b==j[1]?n.push(1):n.push(0)}}e.push(n)}else if(c==4||c==5){h=[[0,0],[0,0]];for(b=0;b<i.length;b++){if(!isFinite(i[b]))return[];i[b]>h[0][0]&&(h[0][0]=i[b],k=h[0][1],h[0][1]=b,b=k-1);i[b]>h[1][0]&&
b!=h[0][1]&&(h[1][0]=i[b],h[1][1]=b)}if(Secure2Of5){k=h[0][0]+h[1][0];k/=2;if(h[0][0]/k>1.3||h[0][0]/k<0.7)return[];if(h[1][0]/k>1.3||h[1][0]/k<0.7)return[];for(b=k=0;b<i.length;b++)b==h[0][1]||b==h[1][1]||(k+=i[b]);k/=3;for(b=0;b<i.length;b++)if(!(b==h[0][1]||b==h[1][1]))if(i[b]/k>1.3||i[b]/k<0.7)return[]}for(b=0;b<i.length;b++)b==h[0][1]||b==h[1][1]?n.push(1):n.push(0);e.push(n)}else{for(;b<f;)j+=i[b],b++;if(c===2){h=[[0,0],[0,0]];j=[0,0];for(b=0;b<i.length;b++)b%2==0?(i[b]>h[0][0]&&(h[0][0]=i[b],
k=h[0][1],h[0][1]=b,b=k),i[b]>h[1][0]&&b!=h[0][1]&&(h[1][0]=i[b],h[1][1]=b)):i[b]>j[0]&&(j[0]=i[b],j[1]=b);if(j[0]/h[0][0]>1.5&&j[0]/h[1][0]>1.5){h=[[0,0],[0,0]];for(b=0;b<i.length;b++)b%2!=0&&(i[b]>h[0][0]&&b!=j[1]&&(h[0][0]=i[b],k=h[0][1],h[0][1]=b,b=k),i[b]>h[1][0]&&b!=h[0][1]&&b!=j[1]&&(h[1][0]=i[b],h[1][1]=b))}k=h[0][0]+h[1][0]+j[0];k/=3;if(h[0][0]/k>1.6||h[0][0]/k<0.4)return[];if(h[1][0]/k>1.6||h[1][0]/k<0.4)return[];if(j[0]/k>1.6||j[0]/k<0.4)return[];for(b=k=0;b<i.length;b++)b==h[0][1]||b==
h[1][1]||b==j[1]||(k+=i[b]);k/=6;for(b=0;b<i.length;b++)if(!(b==h[0][1]||b==h[1][1]||b==j[1]))if(i[b]/k>1.6||i[b]/k<0.4)return[];for(b=0;b<i.length;b++)b==h[0][1]||b==h[1][1]||b==j[1]?n.push(2):n.push(1);e.push(n)}else if(c==3){h=[[0,0],[0,0],[0,0]];for(b=0;b<i.length;b++)i[b]>h[0][0]&&(h[0][0]=i[b],k=h[0][1],h[0][1]=b,b=k),i[b]>h[1][0]&&b!=h[0][1]&&(h[1][0]=i[b],k=h[1][1],h[1][1]=b,b=k),i[b]>h[2][0]&&b!=h[0][1]&&b!=h[1][1]&&(h[2][0]=i[b],h[2][1]=b);if(h[0][0]/h[1][0]>=3){for(b=k=0;b<i.length;b++)b!=
h[0][1]&&(k+=i[b]);k/=3;for(b=0;b<i.length;b++)if(b!=h[0][1]&&(i[b]/k<0.02||i[b]/k>3))return{data:[],correction:0};if(h[0][0]/k<2.2||h[0][0]/k>6)return{data:[],correction:0};for(b=0;b<i.length;b++)b==h[0][1]?n.push(4):n.push(1)}else if(h[0][0]/h[2][0]>2){k=h[0][0]+h[1][0];k/=5;if(h[0][0]/(k*3)<0.02||h[0][0]/(k*3)>3)return{data:[],correction:0};if(h[1][0]/(k*2)<0.02||h[1][0]/(k*2)>3)return{data:[],correction:0};for(b=k=0;b<i.length;b++)b==h[0][1]||b==h[1][1]||(k+=i[b]);k/=2;for(b=0;b<i.length;b++)if(!(b==
h[0][1]||b==h[1][1]))if(i[b]/k<0.02||i[b]/k>3)return{data:[],correction:0};for(b=0;b<i.length;b++)b==h[0][1]?n.push(3):b==h[1][1]?n.push(2):n.push(1)}else{if(h[0][1]%2==h[1][1]%2&&h[0][1]%2==h[2][1]%2){k=h[0][1]%2;h[2]=[0,0];for(b=0;b<i.length;b++)b%2!=k&&i[b]>h[2][0]&&(h[2][0]=i[b],h[2][1]=b)}k=h[0][0]+h[1][0]+h[2][0];k/=3;for(b=0;b<h.length;b++)if(h[b][0]/k<0.02||h[b][0]/k>3)return{data:[],correction:0};for(b=o=0;b<i.length;b++)b==h[0][1]||b==h[1][1]||b==h[2][1]||(o=i[b]);if(k/o<0.02||k/o>3)return{data:[],
correction:0};for(b=0;b<i.length;b++)b==h[0][1]||b==h[1][1]||b==h[2][1]?n.push(2):n.push(1)}e.push(n);for(b=0;b<n.length;b++)d+=Math.abs(n[b]-i[b]/j*g)}else{for(b=0;b<f;)n.push(i[b]/j*g),b++;for(b=0;b<f;)n[b]=n[b]>l?l:n[b],n[b]=n[b]<1?1:n[b],n[b]=Math.round(n[b]),b++;if(c==3){for(b=k=0;b<n.length;b++)k+=n[b];if(k>7){for(b=o=h=0;b<n.length;b++)n[b]>h&&(h=n[b],o=b);n[o]=h-(k-7)}}if(c==3)for(b=0;b<n.length;b++)d+=Math.abs(n[b]-i[b]/j*g);e.push(n)}}}return c==3?{data:e,correction:d}:e}
function CheckCode128(a){var c=a[a.length-2].join(""),c=Code128Encoding.value.indexOf(c);if(c==-1)return false;var d=Code128Encoding.value.indexOf(a[0].join(""));if(d==-1)return false;var e=Code128Encoding[a[0].join("")];if(typeof e=="undefined")return false;if(e!="A"&&e!="B"&&e!="C")return false;for(e=1;e<a.length-2;e++)if(d+=Code128Encoding.value.indexOf(a[e].join(""))*e,Code128Encoding.value.indexOf(a[e].join(""))===-1)return false;return d%103===c}
function Decode2Of5(a){for(var c="",d=0;d<a.length;d++){if(TwoOfFiveEncoding.indexOf(a[d].join(""))==-1)return false;c+=TwoOfFiveEncoding.indexOf(a[d].join(""))}return c}
function DecodeCodaBar(a){var c="",d=a[0].join(""),e=a[a.length-1].join("");if(!(CodaBarEncoding[d]=="A"||CodaBarEncoding[d]=="B"||CodaBarEncoding[d]=="C"||CodaBarEncoding[d]=="D"))return false;if(!(CodaBarEncoding[e]=="A"||CodaBarEncoding[e]=="B"||CodaBarEncoding[e]=="C"||CodaBarEncoding[e]=="D"))return false;for(d=1;d<a.length-1;d++){if(typeof CodaBarEncoding[a[d].join("")]=="undefined")return false;c+=CodaBarEncoding[a[d].join("")]}return c}
function DecodeEAN13(a){if(a.length!=12)return false;for(var c=a.slice(0,6),d=false,e=a.slice(6,a.length),a=0;a<c.length;a++)if(c[a]=c[a].join(""),c[a].length!=4){d=true;break}if(d)return false;for(a=0;a<e.length;a++)if(e[a]=e[a].join(""),e[a].length!=4){d=true;break}if(d)return false;for(var f=[],a=0;a<c.length;a++)if(typeof EAN13Encoding.L[c[a]]!="undefined")f.push("L");else if(typeof EAN13Encoding.G[c[a]]!="undefined")f.push("G");else{d=true;break}if(d)return false;var g=[];if(typeof EAN13Encoding.formats[f.join("")]==
"undefined")return false;g.push(EAN13Encoding.formats[f.join("")]);for(a=0;a<c.length;a++){if(typeof EAN13Encoding[f[a]][c[a]]=="undefined"){d=true;break}g.push(EAN13Encoding[f[a]][c[a]])}if(d)return false;for(a=0;a<e.length;a++){if(typeof EAN13Encoding.R[e[a]]=="undefined"){d=true;break}g.push(EAN13Encoding.R[e[a]])}if(d)return false;c=3;d=0;for(a=g.length-2;a>=0;a--)d+=g[a]*c,c=c==3?1:3;return g[g.length-1]==(10-d%10)%10?g.join(""):false}
function CheckCode93(a){var c=a[a.length-3].join(""),d=a[a.length-2].join(""),e=true;if(typeof Code93Encoding[c]=="undefined")return false;if(typeof Code93Encoding[d]=="undefined")return false;for(var c=Code93Encoding[c].value,f=1,g=0,l=a.length-4;l>0;l--){e=typeof Code93Encoding[a[l].join("")]==="undefined"?false:e;if(!e)break;g+=Code93Encoding[a[l].join("")].value*f;f++;f>20&&(f=1)}var f=g%47,m=f===c;if(!m)return false;if(!e)return false;g=f;f=2;c=Code93Encoding[d].value;for(l=a.length-4;l>0;l--){e=
typeof Code93Encoding[a[l].join("")]==="undefined"?false:e;if(!e)break;g+=Code93Encoding[a[l].join("")].value*f;f++;f>15&&(f=1)}return g%47===c&&m}
function CheckCode39(a){var c=true;if(typeof Code39Encoding[a[0].join("")]=="undefined")return false;if(Code39Encoding[a[0].join("")].character!="*")return false;if(typeof Code39Encoding[a[a.length-1].join("")]=="undefined")return false;if(Code39Encoding[a[a.length-1].join("")].character!="*")return false;for(var d=1;d<a.length-1;d++)if(typeof Code39Encoding[a[d].join("")]=="undefined"){c=false;break}return c}
function DecodeCode39(a){for(var c="",d=false,e="",f="",g=1;g<a.length-1;g++)e=Code39Encoding[a[g].join("")].character,(e=="$"||e=="/"||e=="+"||e=="%")&&g+1<a.length-1?(d=true,f=e):d?(typeof ExtendedEncoding[f+e]!="undefined"&&(c+=ExtendedEncoding[f+e]),d=false):c+=e;return c}
function DecodeCode93(a){for(var c="",d=false,e="",f="",g=1;g<a.length-3;g++)e=Code93Encoding[a[g].join("")].character,e=="($)"||e=="(/)"||e=="(+)"||e=="(%)"?(d=true,f=e[1]):d?(typeof ExtendedEncoding[f+e]!="undefined"&&(c+=ExtendedEncoding[f+e]),d=false):c+=e;return c}
function DecodeCode128(a){for(var c=Code128Encoding[a[0].join("")],d,e="Code128",f="",g=1;g<a.length-2;g++)switch(d=Code128Encoding[a[g].join("")][c],d){case "FNC1":g==1&&(e="GS1-128");case "FNC2":case "FNC3":case "FNC4":break;case "SHIFT_B":g++;f+=Code128Encoding[a[g].join("")].B;break;case "SHIFT_A":g++;f+=Code128Encoding[a[g].join("")].A;break;case "Code_A":c="A";break;case "Code_B":c="B";break;case "Code_C":c="C";break;default:f+=d}return{string:f,format:e}}TwoOfFiveEncoding="00110,10001,01001,11000,00101,10100,01100,00011,10010,01010".split(",");
Code128Encoding={212222:{A:" ",B:" ",C:"00"},222122:{A:"!",B:"!",C:"01"},222221:{A:'"',B:'"',C:"02"},121223:{A:"#",B:"#",C:"03"},121322:{A:"$",B:"$",C:"04"},131222:{A:"%",B:"%",C:"05"},122213:{A:"&",B:"&",C:"06"},122312:{A:"'",B:"'",C:"07"},132212:{A:"(",B:"(",C:"08"},221213:{A:")",B:")",C:"09"},221312:{A:"*",B:"*",C:"10"},231212:{A:"+",B:"+",C:"11"},112232:{A:",",B:",",C:"12"},122132:{A:"-",B:"-",C:"13"},122231:{A:".",B:".",C:"14"},113222:{A:"/",B:"/",C:"15"},123122:{A:"0",B:"0",C:"16"},123221:{A:"1",
B:"1",C:"17"},223211:{A:"2",B:"2",C:"18"},221132:{A:"3",B:"3",C:"19"},221231:{A:"4",B:"4",C:"20"},213212:{A:"5",B:"5",C:"21"},223112:{A:"6",B:"6",C:"22"},312131:{A:"7",B:"7",C:"23"},311222:{A:"8",B:"8",C:"24"},321122:{A:"9",B:"9",C:"25"},321221:{A:":",B:":",C:"26"},312212:{A:";",B:";",C:"27"},322112:{A:"<",B:"<",C:"28"},322211:{A:"=",B:"=",C:"29"},212123:{A:">",B:">",C:"30"},212321:{A:"?",B:"?",C:"31"},232121:{A:"@",B:"@",C:"32"},111323:{A:"A",B:"A",C:"33"},131123:{A:"B",B:"B",C:"34"},131321:{A:"C",
B:"C",C:"35"},112313:{A:"D",B:"D",C:"36"},132113:{A:"E",B:"E",C:"37"},132311:{A:"F",B:"F",C:"38"},211313:{A:"G",B:"G",C:"39"},231113:{A:"H",B:"H",C:"40"},231311:{A:"I",B:"I",C:"41"},112133:{A:"J",B:"J",C:"42"},112331:{A:"K",B:"K",C:"43"},132131:{A:"L",B:"L",C:"44"},113123:{A:"M",B:"M",C:"45"},113321:{A:"N",B:"N",C:"46"},133121:{A:"O",B:"O",C:"47"},313121:{A:"P",B:"P",C:"48"},211331:{A:"Q",B:"Q",C:"49"},231131:{A:"R",B:"R",C:"50"},213113:{A:"S",B:"S",C:"51"},213311:{A:"T",B:"T",C:"52"},213131:{A:"U",
B:"U",C:"53"},311123:{A:"V",B:"V",C:"54"},311321:{A:"W",B:"W",C:"55"},331121:{A:"X",B:"X",C:"56"},312113:{A:"Y",B:"Y",C:"57"},312311:{A:"Z",B:"Z",C:"58"},332111:{A:"[",B:"[",C:"59"},314111:{A:"\\",B:"\\",C:"60"},221411:{A:"]",B:"]",C:"61"},431111:{A:"^",B:"^",C:"62"},111224:{A:"_",B:"_",C:"63"},111422:{A:"NUL",B:"`",C:"64"},121124:{A:"SOH",B:"a",C:"65"},121421:{A:"STX",B:"b",C:"66"},141122:{A:"ETX",B:"c",C:"67"},141221:{A:"EOT",B:"d",C:"68"},112214:{A:"ENQ",B:"e",C:"69"},112412:{A:"ACK",B:"f",C:"70"},
122114:{A:"BEL",B:"g",C:"71"},122411:{A:"BS",B:"h",C:"72"},142112:{A:"HT",B:"i",C:"73"},142211:{A:"LF",B:"j",C:"74"},241211:{A:"VT",B:"k",C:"75"},221114:{A:"FF",B:"l",C:"76"},413111:{A:"CR",B:"m",C:"77"},241112:{A:"SO",B:"n",C:"78"},134111:{A:"SI",B:"o",C:"79"},111242:{A:"DLE",B:"p",C:"80"},121142:{A:"DC1",B:"q",C:"81"},121241:{A:"DC2",B:"r",C:"82"},114212:{A:"DC3",B:"s",C:"83"},124112:{A:"DC4",B:"t",C:"84"},124211:{A:"NAK",B:"u",C:"85"},411212:{A:"SYN",B:"v",C:"86"},421112:{A:"ETB",B:"w",C:"87"},
421211:{A:"CAN",B:"x",C:"88"},212141:{A:"EM",B:"y",C:"89"},214121:{A:"SUB",B:"z",C:"90"},412121:{A:"ESC",B:"{",C:"91"},111143:{A:"FS",B:"|",C:"92"},111341:{A:"GS",B:"}",C:"93"},131141:{A:"RS",B:"~",C:"94"},114113:{A:"US",B:"DEL",C:"95"},114311:{A:"FNC3",B:"FNC3",C:"96"},411113:{A:"FNC2",B:"FNC2",C:"97"},411311:{A:"SHIFT_B",B:"SHIFT_A",C:"98"},113141:{A:"Code_C",B:"Code_C",C:"99"},114131:{A:"Code_B",B:"FNC4",C:"Code_B"},311141:{A:"FNC4",B:"Code_A",C:"Code_A"},411131:{A:"FNC1",B:"FNC1",C:"FNC1"},211412:"A",
211214:"B",211232:"C",233111:{A:"STOP",B:"STOP",C:"STOP"},value:"212222,222122,222221,121223,121322,131222,122213,122312,132212,221213,221312,231212,112232,122132,122231,113222,123122,123221,223211,221132,221231,213212,223112,312131,311222,321122,321221,312212,322112,322211,212123,212321,232121,111323,131123,131321,112313,132113,132311,211313,231113,231311,112133,112331,132131,113123,113321,133121,313121,211331,231131,213113,213311,213131,311123,311321,331121,312113,312311,332111,314111,221411,431111,111224,111422,121124,121421,141122,141221,112214,112412,122114,122411,142112,142211,241211,221114,413111,241112,134111,111242,121142,121241,114212,124112,124211,411212,421112,421211,212141,214121,412121,111143,111341,131141,114113,114311,411113,411311,113141,114131,311141,411131,211412,211214,211232,233111".split(",")};
Code93Encoding={131112:{value:0,character:"0"},111213:{value:1,character:"1"},111312:{value:2,character:"2"},111411:{value:3,character:"3"},121113:{value:4,character:"4"},121212:{value:5,character:"5"},121311:{value:6,character:"6"},111114:{value:7,character:"7"},131211:{value:8,character:"8"},141111:{value:9,character:"9"},211113:{value:10,character:"A"},211212:{value:11,character:"B"},211311:{value:12,character:"C"},221112:{value:13,character:"D"},221211:{value:14,character:"E"},231111:{value:15,
character:"F"},112113:{value:16,character:"G"},112212:{value:17,character:"H"},112311:{value:18,character:"I"},122112:{value:19,character:"J"},132111:{value:20,character:"K"},111123:{value:21,character:"L"},111222:{value:22,character:"M"},111321:{value:23,character:"N"},121122:{value:24,character:"O"},131121:{value:25,character:"P"},212112:{value:26,character:"Q"},212211:{value:27,character:"R"},211122:{value:28,character:"S"},211221:{value:29,character:"T"},221121:{value:30,character:"U"},222111:{value:31,
character:"V"},112122:{value:32,character:"W"},112221:{value:33,character:"X"},122121:{value:34,character:"Y"},123111:{value:35,character:"Z"},121131:{value:36,character:"-"},311112:{value:37,character:"."},311211:{value:38,character:" "},321111:{value:39,character:"$"},112131:{value:40,character:"/"},113121:{value:41,character:"+"},211131:{value:42,character:"%"},121221:{value:43,character:"($)"},312111:{value:44,character:"(%)"},311121:{value:45,character:"(/)"},122211:{value:46,character:"(+)"},
111141:{value:-1,character:"*"}};
Code39Encoding={111221211:{value:0,character:"0"},211211112:{value:1,character:"1"},112211112:{value:2,character:"2"},212211111:{value:3,character:"3"},111221112:{value:4,character:"4"},211221111:{value:5,character:"5"},112221111:{value:6,character:"6"},111211212:{value:7,character:"7"},211211211:{value:8,character:"8"},112211211:{value:9,character:"9"},211112112:{value:10,character:"A"},112112112:{value:11,character:"B"},212112111:{value:12,character:"C"},111122112:{value:13,character:"D"},211122111:{value:14,
character:"E"},112122111:{value:15,character:"F"},111112212:{value:16,character:"G"},211112211:{value:17,character:"H"},112112211:{value:18,character:"I"},111122211:{value:19,character:"J"},211111122:{value:20,character:"K"},112111122:{value:21,character:"L"},212111121:{value:22,character:"M"},111121122:{value:23,character:"N"},211121121:{value:24,character:"O"},112121121:{value:25,character:"P"},111111222:{value:26,character:"Q"},211111221:{value:27,character:"R"},112111221:{value:28,character:"S"},
111121221:{value:29,character:"T"},221111112:{value:30,character:"U"},122111112:{value:31,character:"V"},222111111:{value:32,character:"W"},121121112:{value:33,character:"X"},221121111:{value:34,character:"Y"},122121111:{value:35,character:"Z"},121111212:{value:36,character:"-"},221111211:{value:37,character:"."},122111211:{value:38,character:" "},121212111:{value:39,character:"$"},121211121:{value:40,character:"/"},121112121:{value:41,character:"+"},111212121:{value:42,character:"%"},121121211:{value:-1,
character:"*"}};
ExtendedEncoding={"/A":"!","/B":'"',"/C":"#","/D":"$","/E":"%","/F":"&","/G":"'","/H":"(","/I":")","/J":"*","/K":"+","/L":",","/O":"/","/Z":":","%F":";","%G":"<","%H":"=","%I":">","%J":"?","%K":"[","%L":"\\","%M":"]","%N":"^","%O":"_","+A":"a","+B":"b","+C":"c","+D":"d","+E":"e","+F":"f","+G":"g","+H":"h","+I":"i","+J":"j","+K":"k","+L":"l","+M":"m","+N":"n","+O":"o","+P":"p","+Q":"q","+R":"r","+S":"s","+T":"t","+U":"u","+V":"v","+W":"w","+X":"x","+Y":"y","+Z":"z","%P":"{","%Q":"|","%R":"|","%S":"~"};
CodaBarEncoding={11:"0",110:"1",1001:"2",11E5:"3",10010:"4",1000010:"5",100001:"6",100100:"7",11E4:"8",1001E3:"9",1100:"-",11E3:"$",1000101:":",1010001:"/",1010100:".",11111:"+",11010:"A",1011:"B",101001:"C",1110:"D"};
EAN13Encoding={L:{3211:0,2221:1,2122:2,1411:3,1132:4,1231:5,1114:6,1312:7,1213:8,3112:9},G:{1123:0,1222:1,2212:2,1141:3,2311:4,1321:5,4111:6,2131:7,3121:8,2113:9},R:{3211:0,2221:1,2122:2,1411:3,1132:4,1231:5,1114:6,1312:7,1213:8,3112:9},formats:{LLLLLL:0,LLGLGG:1,LLGGLG:2,LLGGGL:3,LGLLGG:4,LGGLLG:5,LGGGLL:6,LGLGLG:7,LGLGGL:8,LGGLGL:9}};
self.onmessage=function(a){ScanImage={data:new Uint8ClampedArray(a.data.scan),width:a.data.scanWidth,height:a.data.scanHeight};switch(a.data.rotation){case 8:ScanImage.data=Rotate(ScanImage.data,ScanImage.width,ScanImage.height,-90);var c=a.data.scanWidth;ScanImage.width=ScanImage.height;ScanImage.height=c;break;case 6:ScanImage.data=Rotate(ScanImage.data,ScanImage.width,ScanImage.height,90);c=a.data.scanWidth;ScanImage.width=ScanImage.height;ScanImage.height=c;break;case 3:ScanImage.data=Rotate(ScanImage.data,
ScanImage.width,ScanImage.height,180)}Image={data:Scale(ScanImage.data,ScanImage.width,ScanImage.height),width:ScanImage.width/2,height:ScanImage.height/2};a.data.postOrientation&&postMessage({result:Image,success:"orientationData"});availableFormats="Code128,Code93,Code39,EAN-13,2Of5,Inter2Of5,Codabar".split(",");FormatPriority=[];c="Code128,Code93,Code39,EAN-13,2Of5,Inter2Of5,Codabar".split(",");Multiple=Secure2Of5=SecureCodabar=true;if(typeof a.data.multiple!="undefined")Multiple=a.data.multiple;
if(typeof a.data.decodeFormats!="undefined")c=a.data.decodeFormats;for(a=0;a<c.length;a++)FormatPriority.push(c[a]);CreateTable();CreateScanTable();a=Main();a.length>0?postMessage({result:a,success:true}):postMessage({result:a,success:false})};
