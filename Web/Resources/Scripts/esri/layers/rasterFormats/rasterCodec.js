// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.27/esri/copyright.txt for details.
//>>built
define("esri/layers/rasterFormats/rasterCodec","require dojo/_base/declare dojo/_base/lang dojo/_base/Deferred ../PixelBlock ./LercCodec ./Lerc2Codec ./JpgPlus ./Png ./Raw ./TiffDecoder".split(" "),function(B,C,w,x,m,y,z,u,v,t,A){return{validPixelTypes:"U1 U2 U4 U8 U16 U32 S8 S16 S32 F32".split(" "),supportedFormats:"lerc jpeg jpg jpgpng png png8 png24 png32 bip bsq tiff".split(" "),_isPlatformLittleEndian:function(){var a=new ArrayBuffer(4),b=new Uint8Array(a);(new Uint32Array(a))[0]=1;return 1===
b[0]}(),decode:function(a,b){if(void 0===b||null===b)throw"missing decode options";var e,c;b.format&&(e=b.format.toUpperCase());"BSQ"!==e&&"BIP"!==e&&(e=this._getFormat(a));c=b.decodeFunc;if(void 0===c||null===c)c=this._getFormatDecoderDfd(e);return c(a,b)},_getFormatDecoderDfd:function(a){var b=null;switch(a){case "LERC":b=this._decodeLerc;break;case "LERC2":b=this._decodeLerc2;break;case "JPEG":b=this._decodeJpeg;break;case "PNG":b=this._decodePng;break;case "BSQ":b=this._decodeBsq;break;case "BIP":b=
this._decodeBip;break;case "TIFF":b=this._decodeTiff;break;default:b=function(a,b){throw"The raster format is not supported";}}b=w.hitch(this,b);return function(a,c){var d=new x;c.isPoint&&c.width&&(c.width++,c.height++);a=b(a,c);c.isPoint&&c.width&&(this._interpolatePointGrid(a),c.width--,c.height--);d.resolve(a);return d}.bind(this)},_getFormat:function(a){a=new Uint8Array(a,0,10);var b="";if(255===a[0]&&216===a[1])b="JPEG";else if(137===a[0]&&80===a[1]&&78===a[2]&&71===a[3])b="PNG";else if(67===
a[0]&&110===a[1]&&116===a[2]&&90===a[3]&&73===a[4]&&109===a[5]&&97===a[6]&&103===a[7]&&101===a[8]&&32===a[9])b="LERC";else if(76===a[0]&&101===a[1]&&114===a[2]&&99===a[3]&&50===a[4]&&32===a[5])b="LERC2";else if(-1<String.fromCharCode.apply(null,a).toLowerCase().indexOf("error"))b="ERROR";else if(73===a[0]&&73===a[1]&&42===a[2]&&0===a[3]||77===a[0]&&77===a[1]&&0===a[2]&&42===a[3])b="TIFF";return b},_validateDecodeParams:function(a){if(!a.height||Math.floor(a.height)!==a.height)throw"Height not provided.";
if(!a.width||Math.floor(a.width)!==a.width)throw"Width not provided.";},_decodeJpeg:function(a,b){if(!u)throw"The jpeg decoder module is not loaded.";this._validateDecodeParams(b);a=(new u).decode(a);if(!this._verifyResult(a,b))throw"The decoded image dimensions are incorrect.";b=new m({width:a.width,height:a.height,pixels:a.pixels,pixelType:"U8",mask:a.mask,statistics:null});b.calculateStatistics();return b},_decodePng:function(a,b){if(!v)throw"The png decoder module is not loaded.";this._validateDecodeParams(b);
a=new Uint8Array(a);var e=new v(a);a=new Uint8Array(b.width*b.height*4);e.copyToImageData(a,e.decodePixels());for(var c=e=0,d,c=new Uint8Array(b.width*b.height),e=0;e<b.width*b.height;e++)c[e]=a[4*e+3];for(var h=new m({width:b.width,height:b.height,pixels:[],pixelType:"U8",mask:c,statistics:[]}),e=0;3>e;e++){d=new Uint8Array(b.width*b.height);for(c=0;c<b.width*b.height;c++)d[c]=a[4*c+e];h.addData({pixels:d})}h.calculateStatistics();return h},_decodeBsq:function(a,b){if(!t)throw"The bsq decoder module is not loaded.";
this._validateDecodeParams(b);var e=b.noDataValue;b.pixelType=this._getpixelTypeAndNoData(b.pixelType);a=t.decodeBSQ(a,{bandCount:b.planes,width:b.width,height:b.height,pixelType:b.pixelType,noDataValue:e});b=new m({width:b.width,height:b.height,pixels:a.pixels,pixelType:b.pixelType,mask:a.maskData,statistics:null});b.calculateStatistics();return b},_decodeBip:function(a,b){this._validateDecodeParams(b);var e=b.noDataValue;b.pixelType=this._getpixelTypeAndNoData(b.pixelType);a=t.decodeBIP(a,{bandCount:b.planes,
width:b.width,height:b.height,pixelType:b.pixelType,noDataValue:e});b=new m({width:b.width,height:b.height,pixels:a.pixels,pixelType:b.pixelType,mask:a.maskData,statistics:null});b.calculateStatistics();return b},_decodeTiff:function(a,b){this._validateDecodeParams(b);b.pixelType=this._getpixelTypeAndNoData(b.pixelType);a=A.decode(a);a=new m({width:a.width,height:a.height,pixels:a.pixels,pixelType:a.pixelType,mask:a.maskData,statistics:null});a.calculateStatistics();return a},_decodeLerc:function(a,
b){if(!this._isPlatformLittleEndian)throw"lerc decoder is not supported on big endian platform";this._validateDecodeParams(b);var e=b.noDataValue;b.pixelType=this._getpixelTypeAndNoData(b.pixelType);for(var c=0,d,h=0,k,l=a.byteLength-10;h<l;){var n=y.decode(a,{inputOffset:h,encodedMaskData:d,returnMask:0===c?!0:!1,returnEncodedMask:0===c?!0:!1,returnFileInfo:!0,pixelType:b.pixelType,noDataValue:e}),h=n.fileInfo.eofOffset;0===c&&(d=n.encodedMaskData,k=new m({width:b.width,height:b.height,pixels:[],
pixelType:b.pixelType,mask:n.maskData,statistics:[]}));c++;if(!this._verifyResult(n,b))throw"The decoded image dimensions are incorrect";k.addData({pixels:n.pixelData,statistics:{minValue:n.minValue,maxValue:n.maxValue,noDataValue:n.noDataValue}})}return k},_decodeLerc2:function(a,b){if(!this._isPlatformLittleEndian)throw"lerc2 decoder is not supported on big endian platform";this._validateDecodeParams(b);b.pixelType=this._getpixelTypeAndNoData(b.pixelType);for(var e=0,c,d,h,k=0,l,n=a.byteLength-
10,g=[],f;k<n;){d=z.decode(a,{inputOffset:k,maskData:c,returnFileInfo:!0});k=d.fileInfo.eofOffset;0===e&&(h=d.fileInfo.numValidPixel,c=d.maskData,l=new m({width:b.width,height:b.height,pixels:[],dimCount:d.dimCount||1,pixelType:d.fileInfo.pixelType,mask:d.maskData,statistics:[]}));d.fileInfo.mask&&0<d.fileInfo.mask.numBytes&&g.push(d.maskData);e++;if(!this._verifyResult(d,b))throw"The decoded image dimensions are incorrect";l.addData({pixels:d.pixelData,statistics:{minValue:d.minValue,maxValue:d.maxValue,
noDataValue:d.noDataValue,dimStats:d.dimStats}})}if(1<g.length){b=l.width*l.height;l.bandMasks=g;c=new Uint8Array(b);c.set(g[0]);for(h=1;h<g.length;h++)for(f=g[h],a=0;a<b;a++)c[a]&=f[a];for(a=h=0;a<b;a++)h+=f[a];l.mask=c}l.validPixelCount=h;return l},_interpolatePointGrid:function(a,b){var e=a.pixels;if(e&&0!==e.length){var c=e.length,d=a.width,h=a.mask,k=d-1,l=a.height-1,n=[],g,f,q,m,r,p;if(0===(null==b?1:b)){for(b=0;b<c;b++){q=e[b];m=new q.constructor(k*l);for(g=0;g<l;g++)for(p=g*d,f=0;f<k;f++)m[g*
k+f]=q[p+f];n.push(m)}if(h)for(r=new Uint8Array(k*l),g=0;g<l;g++)for(p=g*d,f=0;f<k;f++)r[g*k+f]=h[p+f]}else{for(b=0;b<c;b++){q=e[b];m=new q.constructor(k*l);for(g=0;g<l;g++)for(p=g*d,f=0;f<k;f++)m[g*k+f]=(q[p+f]+q[p+f+1]+q[p+d+f]+q[p+d+f+1])/4;n.push(m)}if(h)for(r=new Uint8Array(k*l),g=0;g<l;g++)for(p=g*d,f=0;f<k;f++)r[g*k+f]=Math.min.apply(null,[h[p+f],h[p+f+1],h[p+d+f],h[p+d+f+1]])}a.width=k;a.height=l;a.mask=r;a.pixels=n;return a}},_getpixelTypeAndNoData:function(a){return"U1"===a||"U2"===a||"U4"===
a||"U8"===a?"U8":a},_verifyResult:function(a,b){return a.height!==b.height||a.width!==b.width?!1:!0}}});