var geocortex;!function(t){var e;!function(t){var e=function(){function t(t,e,i,n,o,r){if(this.STORAGE_TEXTFILE_NAME="AnalyticsEventsText",this.STORAGE_ZIPFILE_NAME="AnalyticsEventsZip",this.STORAGE_ANALYTICS_GUID="InsightWorkstationGuid",this.ERROR_MSG_LOCAL_STORAGE_NOT_SUPPORTED="Geocortex Analytics Event Relay cannot run because the current browser does not support local storage in HTML5.",this.ERROR_MSG_LOCAL_STORAGE_EXCEPTION="Exception occurred while saving temporary data to the browser's local storage; the maximum allowed space is used up. No further events will be collected until the data is sent to Analytics or the browser storage is cleared.",this._enabled=!0,this._isInit=!1,this._localStorageAvailable=!0,this._isIE=!1,this._tempEventCollection=[],"undefined"==typeof Storage)return console.log(this.ERROR_MSG_LOCAL_STORAGE_NOT_SUPPORTED),void(this._enabled=!1);var s;if(r&&0!==r.length)s=r;else{var a=window.location.pathname;a=a.replace(a.substr(a.lastIndexOf("/")+1),""),s="//"+window.location.host+a+"Resources/Scripts"}if("undefined"!=typeof require)require({packages:[{name:"jszip",location:s,main:"jszip"}]},["jszip"],function(t){JSZip=t});else{var l=document.getElementsByTagName("head")[0],c=document.createElement("script");c.type="text/javascript",c.src="Resources/Scripts/jszip.js",l.appendChild(c)}this._isIE=this._detectIE(),i?this._siteId=i:this._siteId=e,this._viewerId=t,n?this._endpointUrl=n:this._endpointUrl=window.location.protocol+"//"+window.location.host+"/Geocortex/Analytics/ClientRelay",o?this._transmissionInterval=1e3*o:this._transmissionInterval=3e4,this._timerDuration=this._transmissionInterval,this._sessionId=this._generateGuid(),this._workstationId=this._getWorkstationId()}return t.prototype.setupMap=function(t){var e=this;null==this._map&&(this._map=t,t.loaded?this._initializeMapEvents():t.on("load",function(){e._initializeMapEvents()}))},t.prototype.logEvent=function(t,e){t&&e&&(e.type=t,this._queueData(e))},t.prototype.isInit=function(){return this._isInit},t.prototype.init=function(t,e){var i=this;this.isInit()||(e||(e="1.0"),this._logStartupEvent(t,e),this._dataTransmissionTimer=setTimeout(function(){i._sendDataToClientRelay(i._endpointUrl)},this._timerDuration),this._isInit=!0)},t.prototype._initializeMapEvents=function(){var t=this,e=new esri.layers.LOD;if(e.level=this._map.getLevel(),e.scale=this._map.getScale(),null!=e.level&&e.level>=0)for(var i=this._map.getLayersVisibleAtScale(),n=0;n<i.length;n++){var o=i[n];if(o instanceof esri.layers.ArcGISTiledMapServiceLayer&&o.tileInfo.lods.length>e.level){e.resolution=o.tileInfo.lods[e.level].resolution;break}}this._logExtentChange(this._map.extent,e),this._map.on("extent-change",function(e){return t._logExtentChange(e.extent,e.lod)});for(var r=0;r<this._map.layerIds.length;r++){var s=this._map.getLayer(this._map.layerIds[r]);s.on("visibility-change",function(e){return t._logVisibilityChange(e)})}this._map.on("layer-add",function(e){null!=e.layer.layerInfos&&e.layer.on("visibility-change",function(e){return t._logVisibilityChange(e)})})},t.prototype._logStartupEvent=function(t,e){var i=this._browserDimensions(),n={viewerType:t,viewerVersion:e,siteID:this._siteId,appVersion:navigator.appVersion,appName:navigator.appName,userAgent:navigator.userAgent,browserWidth:i.width,browserHeight:i.height,screenWidth:screen.width,screenHeight:screen.height};this.logEvent("StartUp",n)},t.prototype._logExtentChange=function(t,e){var i={xMax:t.xmax,xMin:t.xmin,yMax:t.ymax,yMin:t.ymin,spatialReference:t.spatialReference};null!=e&&(i.resolution=e.resolution,i.scale=e.scale),this.logEvent("MapExtent",i)},t.prototype._logVisibilityChange=function(t){var e={mapServiceURL:t.target.url,visible:t.visible};this.logEvent("VisibleMapService",e)},t.prototype._queueData=function(t){var e=this;this._enabled!==!1&&this._localStorageAvailable!==!1&&(t.timestamp=this._generateTimestamp(),t.sessionID=this._sessionId,t.workstationID=this._workstationId,t.siteURL=this._siteId,t.viewerID=this._viewerId,this._tempEventCollection.push(t),null==this._writeToStorageTimeoutToken&&(this._writeToStorageTimeoutToken=setTimeout(function(){return e._writeToStorage()},5e3)))},t.prototype._writeToStorage=function(){var t=this;if(null!=this._tempEventCollection&&0!==this._tempEventCollection.length){if(null!=this._writeToStorageTimeoutToken&&(clearTimeout(this._writeToStorageTimeoutToken),this._writeToStorageTimeoutToken=null),!this._isInit)return void(this._writeToStorageTimeoutToken=setTimeout(function(){return t._writeToStorage()},5e3));for(var e=localStorage,i=e.getItem(this.STORAGE_TEXTFILE_NAME),n=0,o=this._tempEventCollection.length;n<o;n++){var r,s=this._tempEventCollection[n];try{r=JSON.stringify(s)}catch(t){continue}i=this._isIE?(null!=i?i+"%0D%0A":"")+encodeURI(r):(null!=i?i+"\r\n":"")+r}try{e.setItem(this.STORAGE_TEXTFILE_NAME,i),this._localStorageAvailable||(this._localStorageAvailable=!0)}catch(t){return console.log(this.ERROR_MSG_LOCAL_STORAGE_EXCEPTION),void(this._localStorageAvailable=!1)}2*i.length/1024>100&&this._compressEvents(),this._tempEventCollection=[]}},t.prototype._compressEvents=function(){if(this._localStorageAvailable!==!1&&"undefined"!=typeof JSZip){var t=localStorage,e=t.getItem(this.STORAGE_TEXTFILE_NAME);if(null!=e){var i=t.getItem(this.STORAGE_ZIPFILE_NAME);if(null!=i&&2*i.length/1024>3e3)return void(this._localStorageAvailable=!1);this._isIE&&(null!=i&&(i=decodeURI(i)),e=decodeURI(e));var n;n=null!=i?new JSZip(i):new JSZip,n.file(this._generateGuid(),e),t.removeItem(this.STORAGE_TEXTFILE_NAME);var o=n.generate({compression:"DEFLATE",compressionOptions:{level:9},type:"string"});this._isIE&&(o=encodeURI(o));try{t.setItem(this.STORAGE_ZIPFILE_NAME,o),this._localStorageAvailable=!0}catch(t){return console.log(this.ERROR_MSG_LOCAL_STORAGE_EXCEPTION),void(this._localStorageAvailable=!1)}}}},t.prototype._sendDataToClientRelay=function(t){var e=this;if(this._enabled!==!1&&"undefined"!=typeof JSZip){this._compressEvents();var i=localStorage.getItem(this.STORAGE_ZIPFILE_NAME);if(null==i)return void e._resetDataTransmissionTimer(e);this._isIE&&(i=decodeURI(i));var n=new JSZip(i),o=n.generate({compression:"DEFLATE",compressionOptions:{level:9}});$.ajax({type:"POST",url:t,data:o,error:function(){e._timerDuration<=9e5?e._timerDuration=2*e._timerDuration:e._timerDuration<18e5&&(e._timerDuration=18e5),e._resetDataTransmissionTimer(e)},success:function(){localStorage.removeItem(e.STORAGE_ZIPFILE_NAME),e._localStorageAvailable=!0,e._timerDuration=e._transmissionInterval,e._resetDataTransmissionTimer(e)},processData:!1,contentType:"multipart/form-data"})}},t.prototype._resetDataTransmissionTimer=function(t){clearTimeout(t._dataTransmissionTimer),t._dataTransmissionTimer=null,t._dataTransmissionTimer=setTimeout(function(){t._sendDataToClientRelay(t._endpointUrl)},t._timerDuration)},t.prototype._getWorkstationId=function(){var t=this.STORAGE_ANALYTICS_GUID,e=localStorage.getItem(t);return"undefined"!=typeof e&&null!=e||(e=this._generateGuid(),localStorage.setItem(t,e)),e},t.prototype._generateGuid=function(){var t;t="undefined"!=typeof performance&&"undefined"!=typeof performance.now?performance.now():(new Date).getTime();var e="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var i=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"===e?i:3&i|8).toString(16)});return e},t.prototype._generateTimestamp=function(){return Date.prototype.toISOString?(new Date).toISOString():void!function(){function t(t){var e=String(t);return 1===e.length&&(e="0"+e),e}Date.prototype.toISOString=function(){return this.getUTCFullYear()+"-"+t(this.getUTCMonth()+1)+"-"+t(this.getUTCDate())+"T"+t(this.getUTCHours())+":"+t(this.getUTCMinutes())+":"+t(this.getUTCSeconds())+"."+String((this.getUTCMilliseconds()/1e3).toFixed(3)).slice(2,5)+"Z"}}()},t.prototype._detectIE=function(){var t=window.navigator.userAgent,e=t.indexOf("MSIE ");if(e>0)return!0;var i=t.indexOf("Trident/");if(i>0)return!0;var n=t.indexOf("Edge/");return n>0},t.prototype._browserDimensions=function(){var t=0,e=0;return"number"==typeof window.innerWidth?(t=window.innerWidth,e=window.innerHeight):document.documentElement&&(document.documentElement.clientWidth||document.documentElement.clientHeight)?(t=document.documentElement.clientWidth,e=document.documentElement.clientHeight):document.body&&(document.body.clientWidth||document.body.clientHeight)&&(t=document.body.clientWidth,e=document.body.clientHeight),{width:t,height:e}},t}();t.EventRelay=e}(e=t.analytics||(t.analytics={}))}(geocortex||(geocortex={}));