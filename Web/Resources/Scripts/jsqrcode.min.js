/*
  Ported to JavaScript by Lazar Laszlo 2011 
  lazarsoft@gmail.com, www.lazarsoft.info
*/

/*
*
* Copyright 2007 ZXing authors
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/

GridSampler={checkAndNudgePoints:function(d,a){for(var c=qrcode.width,b=qrcode.height,e=true,g=0;g<a.length&&e;g+=2){var f=Math.floor(a[g]),h=Math.floor(a[g+1]);if(f<-1||f>c||h<-1||h>b)throw"Error.checkAndNudgePoints ";e=false;f==-1?(a[g]=0,e=true):f==c&&(a[g]=c-1,e=true);h==-1?(a[g+1]=0,e=true):h==b&&(a[g+1]=b-1,e=true)}e=true;for(g=a.length-2;g>=0&&e;g-=2){f=Math.floor(a[g]);h=Math.floor(a[g+1]);if(f<-1||f>c||h<-1||h>b)throw"Error.checkAndNudgePoints ";e=false;f==-1?(a[g]=0,e=true):f==c&&(a[g]=
c-1,e=true);h==-1?(a[g+1]=0,e=true):h==b&&(a[g+1]=b-1,e=true)}}};
GridSampler.sampleGrid3=function(d,a,c){for(var b=new BitMatrix(a),e=Array(a<<1),g=0;g<a;g++){for(var f=e.length,h=g+0.5,i=0;i<f;i+=2)e[i]=(i>>1)+0.5,e[i+1]=h;c.transformPoints1(e);GridSampler.checkAndNudgePoints(d,e);try{for(i=0;i<f;i+=2){var j=Math.floor(e[i])*4+Math.floor(e[i+1])*qrcode.width*4,m=d[Math.floor(e[i])+qrcode.width*Math.floor(e[i+1])];qrcode.imagedata.data[j]=m?255:0;qrcode.imagedata.data[j+1]=m?255:0;qrcode.imagedata.data[j+2]=0;qrcode.imagedata.data[j+3]=255;m&&b.set_Renamed(i>>
1,g)}}catch(k){throw"Error.checkAndNudgePoints";}}return b};GridSampler.sampleGridx=function(d,a,c,b,e,g,f,h,i,j,m,k,q,o,l,n,v,w){c=PerspectiveTransform.quadrilateralToQuadrilateral(c,b,e,g,f,h,i,j,m,k,q,o,l,n,v,w);return GridSampler.sampleGrid3(d,a,c)};function ECB(d,a){this.count=d;this.dataCodewords=a;this.__defineGetter__("Count",function(){return this.count});this.__defineGetter__("DataCodewords",function(){return this.dataCodewords})}
function ECBlocks(d,a,c){this.ecCodewordsPerBlock=d;this.ecBlocks=c?[a,c]:Array(a);this.__defineGetter__("ECCodewordsPerBlock",function(){return this.ecCodewordsPerBlock});this.__defineGetter__("TotalECCodewords",function(){return this.ecCodewordsPerBlock*this.NumBlocks});this.__defineGetter__("NumBlocks",function(){for(var b=0,e=0;e<this.ecBlocks.length;e++)b+=this.ecBlocks[e].length;return b});this.getECBlocks=function(){return this.ecBlocks}}
function Version(d,a,c,b,e,g){this.versionNumber=d;this.alignmentPatternCenters=a;this.ecBlocks=[c,b,e,g];d=0;a=c.ECCodewordsPerBlock;c=c.getECBlocks();for(b=0;b<c.length;b++)e=c[b],d+=e.Count*(e.DataCodewords+a);this.totalCodewords=d;this.__defineGetter__("VersionNumber",function(){return this.versionNumber});this.__defineGetter__("AlignmentPatternCenters",function(){return this.alignmentPatternCenters});this.__defineGetter__("TotalCodewords",function(){return this.totalCodewords});this.__defineGetter__("DimensionForVersion",
function(){return 17+4*this.versionNumber});this.buildFunctionPattern=function(){var b=this.DimensionForVersion,e=new BitMatrix(b);e.setRegion(0,0,9,9);e.setRegion(b-8,0,8,9);e.setRegion(0,b-8,9,8);for(var c=this.alignmentPatternCenters.length,a=0;a<c;a++)for(var d=this.alignmentPatternCenters[a]-2,g=0;g<c;g++)a==0&&(g==0||g==c-1)||a==c-1&&g==0||e.setRegion(this.alignmentPatternCenters[g]-2,d,5,5);e.setRegion(6,9,1,b-17);e.setRegion(9,6,b-17,1);this.versionNumber>6&&(e.setRegion(b-11,0,3,6),e.setRegion(0,
b-11,6,3));return e};this.getECBlocksForLevel=function(b){return this.ecBlocks[b.ordinal()]}}Version.VERSION_DECODE_INFO=[31892,34236,39577,42195,48118,51042,55367,58893,63784,68472,70749,76311,79154,84390,87683,92361,96236,102084,102881,110507,110734,117786,119615,126325,127568,133589,136944,141498,145311,150283,152622,158308,161089,167017];Version.VERSIONS=buildVersions();Version.getVersionForNumber=function(d){if(d<1||d>40)throw"ArgumentException";return Version.VERSIONS[d-1]};
Version.getProvisionalVersionForDimension=function(d){if(d%4!=1)throw"Error getProvisionalVersionForDimension";try{return Version.getVersionForNumber(d-17>>2)}catch(a){throw"Error getVersionForNumber";}};
Version.decodeVersionInformation=function(d){for(var a=4294967295,c=0,b=0;b<Version.VERSION_DECODE_INFO.length;b++){var e=Version.VERSION_DECODE_INFO[b];if(e==d)return this.getVersionForNumber(b+7);e=FormatInformation.numBitsDiffering(d,e);e<a&&(c=b+7,a=e)}return a<=3?this.getVersionForNumber(c):null};
function buildVersions(){return[new Version(1,[],new ECBlocks(7,new ECB(1,19)),new ECBlocks(10,new ECB(1,16)),new ECBlocks(13,new ECB(1,13)),new ECBlocks(17,new ECB(1,9))),new Version(2,[6,18],new ECBlocks(10,new ECB(1,34)),new ECBlocks(16,new ECB(1,28)),new ECBlocks(22,new ECB(1,22)),new ECBlocks(28,new ECB(1,16))),new Version(3,[6,22],new ECBlocks(15,new ECB(1,55)),new ECBlocks(26,new ECB(1,44)),new ECBlocks(18,new ECB(2,17)),new ECBlocks(22,new ECB(2,13))),new Version(4,[6,26],new ECBlocks(20,
new ECB(1,80)),new ECBlocks(18,new ECB(2,32)),new ECBlocks(26,new ECB(2,24)),new ECBlocks(16,new ECB(4,9))),new Version(5,[6,30],new ECBlocks(26,new ECB(1,108)),new ECBlocks(24,new ECB(2,43)),new ECBlocks(18,new ECB(2,15),new ECB(2,16)),new ECBlocks(22,new ECB(2,11),new ECB(2,12))),new Version(6,[6,34],new ECBlocks(18,new ECB(2,68)),new ECBlocks(16,new ECB(4,27)),new ECBlocks(24,new ECB(4,19)),new ECBlocks(28,new ECB(4,15))),new Version(7,[6,22,38],new ECBlocks(20,new ECB(2,78)),new ECBlocks(18,new ECB(4,
31)),new ECBlocks(18,new ECB(2,14),new ECB(4,15)),new ECBlocks(26,new ECB(4,13),new ECB(1,14))),new Version(8,[6,24,42],new ECBlocks(24,new ECB(2,97)),new ECBlocks(22,new ECB(2,38),new ECB(2,39)),new ECBlocks(22,new ECB(4,18),new ECB(2,19)),new ECBlocks(26,new ECB(4,14),new ECB(2,15))),new Version(9,[6,26,46],new ECBlocks(30,new ECB(2,116)),new ECBlocks(22,new ECB(3,36),new ECB(2,37)),new ECBlocks(20,new ECB(4,16),new ECB(4,17)),new ECBlocks(24,new ECB(4,12),new ECB(4,13))),new Version(10,[6,28,50],
new ECBlocks(18,new ECB(2,68),new ECB(2,69)),new ECBlocks(26,new ECB(4,43),new ECB(1,44)),new ECBlocks(24,new ECB(6,19),new ECB(2,20)),new ECBlocks(28,new ECB(6,15),new ECB(2,16))),new Version(11,[6,30,54],new ECBlocks(20,new ECB(4,81)),new ECBlocks(30,new ECB(1,50),new ECB(4,51)),new ECBlocks(28,new ECB(4,22),new ECB(4,23)),new ECBlocks(24,new ECB(3,12),new ECB(8,13))),new Version(12,[6,32,58],new ECBlocks(24,new ECB(2,92),new ECB(2,93)),new ECBlocks(22,new ECB(6,36),new ECB(2,37)),new ECBlocks(26,
new ECB(4,20),new ECB(6,21)),new ECBlocks(28,new ECB(7,14),new ECB(4,15))),new Version(13,[6,34,62],new ECBlocks(26,new ECB(4,107)),new ECBlocks(22,new ECB(8,37),new ECB(1,38)),new ECBlocks(24,new ECB(8,20),new ECB(4,21)),new ECBlocks(22,new ECB(12,11),new ECB(4,12))),new Version(14,[6,26,46,66],new ECBlocks(30,new ECB(3,115),new ECB(1,116)),new ECBlocks(24,new ECB(4,40),new ECB(5,41)),new ECBlocks(20,new ECB(11,16),new ECB(5,17)),new ECBlocks(24,new ECB(11,12),new ECB(5,13))),new Version(15,[6,26,
48,70],new ECBlocks(22,new ECB(5,87),new ECB(1,88)),new ECBlocks(24,new ECB(5,41),new ECB(5,42)),new ECBlocks(30,new ECB(5,24),new ECB(7,25)),new ECBlocks(24,new ECB(11,12),new ECB(7,13))),new Version(16,[6,26,50,74],new ECBlocks(24,new ECB(5,98),new ECB(1,99)),new ECBlocks(28,new ECB(7,45),new ECB(3,46)),new ECBlocks(24,new ECB(15,19),new ECB(2,20)),new ECBlocks(30,new ECB(3,15),new ECB(13,16))),new Version(17,[6,30,54,78],new ECBlocks(28,new ECB(1,107),new ECB(5,108)),new ECBlocks(28,new ECB(10,
46),new ECB(1,47)),new ECBlocks(28,new ECB(1,22),new ECB(15,23)),new ECBlocks(28,new ECB(2,14),new ECB(17,15))),new Version(18,[6,30,56,82],new ECBlocks(30,new ECB(5,120),new ECB(1,121)),new ECBlocks(26,new ECB(9,43),new ECB(4,44)),new ECBlocks(28,new ECB(17,22),new ECB(1,23)),new ECBlocks(28,new ECB(2,14),new ECB(19,15))),new Version(19,[6,30,58,86],new ECBlocks(28,new ECB(3,113),new ECB(4,114)),new ECBlocks(26,new ECB(3,44),new ECB(11,45)),new ECBlocks(26,new ECB(17,21),new ECB(4,22)),new ECBlocks(26,
new ECB(9,13),new ECB(16,14))),new Version(20,[6,34,62,90],new ECBlocks(28,new ECB(3,107),new ECB(5,108)),new ECBlocks(26,new ECB(3,41),new ECB(13,42)),new ECBlocks(30,new ECB(15,24),new ECB(5,25)),new ECBlocks(28,new ECB(15,15),new ECB(10,16))),new Version(21,[6,28,50,72,94],new ECBlocks(28,new ECB(4,116),new ECB(4,117)),new ECBlocks(26,new ECB(17,42)),new ECBlocks(28,new ECB(17,22),new ECB(6,23)),new ECBlocks(30,new ECB(19,16),new ECB(6,17))),new Version(22,[6,26,50,74,98],new ECBlocks(28,new ECB(2,
111),new ECB(7,112)),new ECBlocks(28,new ECB(17,46)),new ECBlocks(30,new ECB(7,24),new ECB(16,25)),new ECBlocks(24,new ECB(34,13))),new Version(23,[6,30,54,74,102],new ECBlocks(30,new ECB(4,121),new ECB(5,122)),new ECBlocks(28,new ECB(4,47),new ECB(14,48)),new ECBlocks(30,new ECB(11,24),new ECB(14,25)),new ECBlocks(30,new ECB(16,15),new ECB(14,16))),new Version(24,[6,28,54,80,106],new ECBlocks(30,new ECB(6,117),new ECB(4,118)),new ECBlocks(28,new ECB(6,45),new ECB(14,46)),new ECBlocks(30,new ECB(11,
24),new ECB(16,25)),new ECBlocks(30,new ECB(30,16),new ECB(2,17))),new Version(25,[6,32,58,84,110],new ECBlocks(26,new ECB(8,106),new ECB(4,107)),new ECBlocks(28,new ECB(8,47),new ECB(13,48)),new ECBlocks(30,new ECB(7,24),new ECB(22,25)),new ECBlocks(30,new ECB(22,15),new ECB(13,16))),new Version(26,[6,30,58,86,114],new ECBlocks(28,new ECB(10,114),new ECB(2,115)),new ECBlocks(28,new ECB(19,46),new ECB(4,47)),new ECBlocks(28,new ECB(28,22),new ECB(6,23)),new ECBlocks(30,new ECB(33,16),new ECB(4,17))),
new Version(27,[6,34,62,90,118],new ECBlocks(30,new ECB(8,122),new ECB(4,123)),new ECBlocks(28,new ECB(22,45),new ECB(3,46)),new ECBlocks(30,new ECB(8,23),new ECB(26,24)),new ECBlocks(30,new ECB(12,15),new ECB(28,16))),new Version(28,[6,26,50,74,98,122],new ECBlocks(30,new ECB(3,117),new ECB(10,118)),new ECBlocks(28,new ECB(3,45),new ECB(23,46)),new ECBlocks(30,new ECB(4,24),new ECB(31,25)),new ECBlocks(30,new ECB(11,15),new ECB(31,16))),new Version(29,[6,30,54,78,102,126],new ECBlocks(30,new ECB(7,
116),new ECB(7,117)),new ECBlocks(28,new ECB(21,45),new ECB(7,46)),new ECBlocks(30,new ECB(1,23),new ECB(37,24)),new ECBlocks(30,new ECB(19,15),new ECB(26,16))),new Version(30,[6,26,52,78,104,130],new ECBlocks(30,new ECB(5,115),new ECB(10,116)),new ECBlocks(28,new ECB(19,47),new ECB(10,48)),new ECBlocks(30,new ECB(15,24),new ECB(25,25)),new ECBlocks(30,new ECB(23,15),new ECB(25,16))),new Version(31,[6,30,56,82,108,134],new ECBlocks(30,new ECB(13,115),new ECB(3,116)),new ECBlocks(28,new ECB(2,46),
new ECB(29,47)),new ECBlocks(30,new ECB(42,24),new ECB(1,25)),new ECBlocks(30,new ECB(23,15),new ECB(28,16))),new Version(32,[6,34,60,86,112,138],new ECBlocks(30,new ECB(17,115)),new ECBlocks(28,new ECB(10,46),new ECB(23,47)),new ECBlocks(30,new ECB(10,24),new ECB(35,25)),new ECBlocks(30,new ECB(19,15),new ECB(35,16))),new Version(33,[6,30,58,86,114,142],new ECBlocks(30,new ECB(17,115),new ECB(1,116)),new ECBlocks(28,new ECB(14,46),new ECB(21,47)),new ECBlocks(30,new ECB(29,24),new ECB(19,25)),new ECBlocks(30,
new ECB(11,15),new ECB(46,16))),new Version(34,[6,34,62,90,118,146],new ECBlocks(30,new ECB(13,115),new ECB(6,116)),new ECBlocks(28,new ECB(14,46),new ECB(23,47)),new ECBlocks(30,new ECB(44,24),new ECB(7,25)),new ECBlocks(30,new ECB(59,16),new ECB(1,17))),new Version(35,[6,30,54,78,102,126,150],new ECBlocks(30,new ECB(12,121),new ECB(7,122)),new ECBlocks(28,new ECB(12,47),new ECB(26,48)),new ECBlocks(30,new ECB(39,24),new ECB(14,25)),new ECBlocks(30,new ECB(22,15),new ECB(41,16))),new Version(36,
[6,24,50,76,102,128,154],new ECBlocks(30,new ECB(6,121),new ECB(14,122)),new ECBlocks(28,new ECB(6,47),new ECB(34,48)),new ECBlocks(30,new ECB(46,24),new ECB(10,25)),new ECBlocks(30,new ECB(2,15),new ECB(64,16))),new Version(37,[6,28,54,80,106,132,158],new ECBlocks(30,new ECB(17,122),new ECB(4,123)),new ECBlocks(28,new ECB(29,46),new ECB(14,47)),new ECBlocks(30,new ECB(49,24),new ECB(10,25)),new ECBlocks(30,new ECB(24,15),new ECB(46,16))),new Version(38,[6,32,58,84,110,136,162],new ECBlocks(30,new ECB(4,
122),new ECB(18,123)),new ECBlocks(28,new ECB(13,46),new ECB(32,47)),new ECBlocks(30,new ECB(48,24),new ECB(14,25)),new ECBlocks(30,new ECB(42,15),new ECB(32,16))),new Version(39,[6,26,54,82,110,138,166],new ECBlocks(30,new ECB(20,117),new ECB(4,118)),new ECBlocks(28,new ECB(40,47),new ECB(7,48)),new ECBlocks(30,new ECB(43,24),new ECB(22,25)),new ECBlocks(30,new ECB(10,15),new ECB(67,16))),new Version(40,[6,30,58,86,114,142,170],new ECBlocks(30,new ECB(19,118),new ECB(6,119)),new ECBlocks(28,new ECB(18,
47),new ECB(31,48)),new ECBlocks(30,new ECB(34,24),new ECB(34,25)),new ECBlocks(30,new ECB(20,15),new ECB(61,16)))]}
function PerspectiveTransform(d,a,c,b,e,g,f,h,i){this.a11=d;this.a12=b;this.a13=f;this.a21=a;this.a22=e;this.a23=h;this.a31=c;this.a32=g;this.a33=i;this.transformPoints1=function(b){for(var e=b.length,c=this.a11,a=this.a12,d=this.a13,g=this.a21,f=this.a22,h=this.a23,i=this.a31,x=this.a32,y=this.a33,r=0;r<e;r+=2){var s=b[r],t=b[r+1],u=d*s+h*t+y;b[r]=(c*s+g*t+i)/u;b[r+1]=(a*s+f*t+x)/u}};this.transformPoints2=function(b,e){for(var c=b.length,a=0;a<c;a++){var d=b[a],g=e[a],f=this.a13*d+this.a23*g+this.a33;
b[a]=(this.a11*d+this.a21*g+this.a31)/f;e[a]=(this.a12*d+this.a22*g+this.a32)/f}};this.buildAdjoint=function(){return new PerspectiveTransform(this.a22*this.a33-this.a23*this.a32,this.a23*this.a31-this.a21*this.a33,this.a21*this.a32-this.a22*this.a31,this.a13*this.a32-this.a12*this.a33,this.a11*this.a33-this.a13*this.a31,this.a12*this.a31-this.a11*this.a32,this.a12*this.a23-this.a13*this.a22,this.a13*this.a21-this.a11*this.a23,this.a11*this.a22-this.a12*this.a21)};this.times=function(b){return new PerspectiveTransform(this.a11*
b.a11+this.a21*b.a12+this.a31*b.a13,this.a11*b.a21+this.a21*b.a22+this.a31*b.a23,this.a11*b.a31+this.a21*b.a32+this.a31*b.a33,this.a12*b.a11+this.a22*b.a12+this.a32*b.a13,this.a12*b.a21+this.a22*b.a22+this.a32*b.a23,this.a12*b.a31+this.a22*b.a32+this.a32*b.a33,this.a13*b.a11+this.a23*b.a12+this.a33*b.a13,this.a13*b.a21+this.a23*b.a22+this.a33*b.a23,this.a13*b.a31+this.a23*b.a32+this.a33*b.a33)}}
PerspectiveTransform.quadrilateralToQuadrilateral=function(d,a,c,b,e,g,f,h,i,j,m,k,q,o,l,n){d=this.quadrilateralToSquare(d,a,c,b,e,g,f,h);return this.squareToQuadrilateral(i,j,m,k,q,o,l,n).times(d)};
PerspectiveTransform.squareToQuadrilateral=function(d,a,c,b,e,g,f,h){dy2=h-g;dy3=a-b+g-h;return dy2==0&&dy3==0?new PerspectiveTransform(c-d,e-c,d,b-a,g-b,a,0,0,1):(dx1=c-e,dx2=f-e,dx3=d-c+e-f,dy1=b-g,denominator=dx1*dy2-dx2*dy1,a13=(dx3*dy2-dx2*dy3)/denominator,a23=(dx1*dy3-dx3*dy1)/denominator,new PerspectiveTransform(c-d+a13*c,f-d+a23*f,d,b-a+a13*b,h-a+a23*h,a,a13,a23,1))};PerspectiveTransform.quadrilateralToSquare=function(d,a,c,b,e,g,f,h){return this.squareToQuadrilateral(d,a,c,b,e,g,f,h).buildAdjoint()};
function DetectorResult(d,a){this.bits=d;this.points=a}
function Detector(d){this.image=d;this.resultPointCallback=null;this.sizeOfBlackWhiteBlackRun=function(a,c,b,e){var d=Math.abs(e-c)>Math.abs(b-a);if(d)var f=a,a=c,c=f,f=b,b=e,e=f;for(var h=Math.abs(b-a),i=Math.abs(e-c),j=-h>>1,m=c<e?1:-1,k=a<b?1:-1,q=0,o=a,f=c;o!=b;o+=k){var l=d?f:o,n=d?o:f;q==1?this.image[l+n*qrcode.width]&&q++:this.image[l+n*qrcode.width]||q++;if(q==3)return e=o-a,c=f-c,Math.sqrt(e*e+c*c);j+=i;if(j>0){if(f==e)break;f+=m;j-=h}}a=b-a;c=e-c;return Math.sqrt(a*a+c*c)};this.sizeOfBlackWhiteBlackRunBothWays=
function(a,c,b,e){var d=this.sizeOfBlackWhiteBlackRun(a,c,b,e),f=1,b=a-(b-a);b<0?(f=a/(a-b),b=0):b>=qrcode.width&&(f=(qrcode.width-1-a)/(b-a),b=qrcode.width-1);e=Math.floor(c-(e-c)*f);f=1;e<0?(f=c/(c-e),e=0):e>=qrcode.height&&(f=(qrcode.height-1-c)/(e-c),e=qrcode.height-1);b=Math.floor(a+(b-a)*f);d+=this.sizeOfBlackWhiteBlackRun(a,c,b,e);return d-1};this.calculateModuleSizeOneWay=function(a,c){var b=this.sizeOfBlackWhiteBlackRunBothWays(Math.floor(a.X),Math.floor(a.Y),Math.floor(c.X),Math.floor(c.Y)),
e=this.sizeOfBlackWhiteBlackRunBothWays(Math.floor(c.X),Math.floor(c.Y),Math.floor(a.X),Math.floor(a.Y));return isNaN(b)?e/7:isNaN(e)?b/7:(b+e)/14};this.calculateModuleSize=function(a,c,b){return(this.calculateModuleSizeOneWay(a,c)+this.calculateModuleSizeOneWay(a,b))/2};this.distance=function(a,c){xDiff=a.X-c.X;yDiff=a.Y-c.Y;return Math.sqrt(xDiff*xDiff+yDiff*yDiff)};this.computeDimension=function(a,c,b,e){c=Math.round(this.distance(a,c)/e);a=Math.round(this.distance(a,b)/e);a=(c+a>>1)+7;switch(a&
3){case 0:a++;break;case 2:a--;break;case 3:throw"Error";}return a};this.findAlignmentInRegion=function(a,c,b,e){var d=Math.floor(e*a),e=Math.max(0,c-d),c=Math.min(qrcode.width-1,c+d);if(c-e<a*3)throw"Error";var f=Math.max(0,b-d),b=Math.min(qrcode.height-1,b+d);return(new AlignmentPatternFinder(this.image,e,f,c-e,b-f,a,this.resultPointCallback)).find()};this.createTransform=function(a,c,b,e,d){d-=3.5;var f,h,i;e!=null?(f=e.X,e=e.Y,h=i=d-3):(f=c.X-a.X+b.X,e=c.Y-a.Y+b.Y,h=i=d);return PerspectiveTransform.quadrilateralToQuadrilateral(3.5,
3.5,d,3.5,h,i,3.5,d,a.X,a.Y,c.X,c.Y,f,e,b.X,b.Y)};this.sampleGrid=function(a,c,b){return GridSampler.sampleGrid3(a,b,c)};this.processFinderPatternInfo=function(a){var c=a.TopLeft,b=a.TopRight,a=a.BottomLeft,e=this.calculateModuleSize(c,b,a);if(e<1)throw"Error";var d=this.computeDimension(c,b,a,e),f=Version.getProvisionalVersionForDimension(d),h=f.DimensionForVersion-7,i=null;if(f.AlignmentPatternCenters.length>0){h=1-3/h;f=Math.floor(c.X+h*(b.X-c.X+a.X-c.X));for(h=Math.floor(c.Y+h*(b.Y-c.Y+a.Y-c.Y));;){i=
this.findAlignmentInRegion(e,f,h,4);break}}e=this.sampleGrid(this.image,this.createTransform(c,b,a,i,d),d);return new DetectorResult(e,i==null?[a,c,b]:[a,c,b,i])};this.detect=function(){return this.processFinderPatternInfo((new FinderPatternFinder).findFinderPattern(this.image))}}
var FORMAT_INFO_MASK_QR=21522,FORMAT_INFO_DECODE_LOOKUP=[[21522,0],[20773,1],[24188,2],[23371,3],[17913,4],[16590,5],[20375,6],[19104,7],[30660,8],[29427,9],[32170,10],[30877,11],[26159,12],[25368,13],[27713,14],[26998,15],[5769,16],[5054,17],[7399,18],[6608,19],[1890,20],[597,21],[3340,22],[2107,23],[13663,24],[12392,25],[16177,26],[14854,27],[9396,28],[8579,29],[11994,30],[11245,31]],BITS_SET_IN_HALF_BYTE=[0,1,1,2,1,2,2,3,1,2,2,3,2,3,3,4];
function FormatInformation(d){this.errorCorrectionLevel=ErrorCorrectionLevel.forBits(d>>3&3);this.dataMask=d&7;this.__defineGetter__("ErrorCorrectionLevel",function(){return this.errorCorrectionLevel});this.__defineGetter__("DataMask",function(){return this.dataMask});this.GetHashCode=function(){return this.errorCorrectionLevel.ordinal()<<3|dataMask};this.Equals=function(a){return this.errorCorrectionLevel==a.errorCorrectionLevel&&this.dataMask==a.dataMask}}
FormatInformation.numBitsDiffering=function(d,a){d^=a;return BITS_SET_IN_HALF_BYTE[d&15]+BITS_SET_IN_HALF_BYTE[URShift(d,4)&15]+BITS_SET_IN_HALF_BYTE[URShift(d,8)&15]+BITS_SET_IN_HALF_BYTE[URShift(d,12)&15]+BITS_SET_IN_HALF_BYTE[URShift(d,16)&15]+BITS_SET_IN_HALF_BYTE[URShift(d,20)&15]+BITS_SET_IN_HALF_BYTE[URShift(d,24)&15]+BITS_SET_IN_HALF_BYTE[URShift(d,28)&15]};
FormatInformation.decodeFormatInformation=function(d){var a=FormatInformation.doDecodeFormatInformation(d);return a!=null?a:FormatInformation.doDecodeFormatInformation(d^FORMAT_INFO_MASK_QR)};FormatInformation.doDecodeFormatInformation=function(d){for(var a=4294967295,c=0,b=0;b<FORMAT_INFO_DECODE_LOOKUP.length;b++){var e=FORMAT_INFO_DECODE_LOOKUP[b],g=e[0];if(g==d)return new FormatInformation(e[1]);g=this.numBitsDiffering(d,g);g<a&&(c=e[1],a=g)}return a<=3?new FormatInformation(c):null};
function ErrorCorrectionLevel(d,a,c){this.ordinal_Renamed_Field=d;this.bits=a;this.name=c;this.__defineGetter__("Bits",function(){return this.bits});this.__defineGetter__("Name",function(){return this.name});this.ordinal=function(){return this.ordinal_Renamed_Field}}ErrorCorrectionLevel.forBits=function(d){if(d<0||d>=FOR_BITS.length)throw"ArgumentException";return FOR_BITS[d]};
var L=new ErrorCorrectionLevel(0,1,"L"),M=new ErrorCorrectionLevel(1,0,"M"),Q=new ErrorCorrectionLevel(2,3,"Q"),H=new ErrorCorrectionLevel(3,2,"H"),FOR_BITS=[M,L,H,Q];
function BitMatrix(d,a){a||(a=d);if(d<1||a<1)throw"Both dimensions must be greater than 0";this.width=d;this.height=a;var c=d>>5;(d&31)!=0&&c++;this.rowSize=c;this.bits=Array(c*a);for(c=0;c<this.bits.length;c++)this.bits[c]=0;this.__defineGetter__("Width",function(){return this.width});this.__defineGetter__("Height",function(){return this.height});this.__defineGetter__("Dimension",function(){if(this.width!=this.height)throw"Can't call getDimension() on a non-square matrix";return this.width});this.get_Renamed=
function(b,e){return(URShift(this.bits[e*this.rowSize+(b>>5)],b&31)&1)!=0};this.set_Renamed=function(b,e){this.bits[e*this.rowSize+(b>>5)]|=1<<(b&31)};this.flip=function(b,e){this.bits[e*this.rowSize+(b>>5)]^=1<<(b&31)};this.clear=function(){for(var b=this.bits.length,e=0;e<b;e++)this.bits[e]=0};this.setRegion=function(b,e,c,a){if(e<0||b<0)throw"Left and top must be nonnegative";if(a<1||c<1)throw"Height and width must be at least 1";c=b+c;a=e+a;if(a>this.height||c>this.width)throw"The region must fit inside the matrix";
for(;e<a;e++)for(var d=e*this.rowSize,i=b;i<c;i++)this.bits[d+(i>>5)]|=1<<(i&31)}}function DataBlock(d,a){this.numDataCodewords=d;this.codewords=a;this.__defineGetter__("NumDataCodewords",function(){return this.numDataCodewords});this.__defineGetter__("Codewords",function(){return this.codewords})}
DataBlock.getDataBlocks=function(d,a,c){if(d.length!=a.TotalCodewords)throw"ArgumentException";for(var b=a.getECBlocksForLevel(c),c=0,e=b.getECBlocks(),a=0;a<e.length;a++)c+=e[a].Count;for(var c=Array(c),g=0,f=0;f<e.length;f++)for(var h=e[f],a=0;a<h.Count;a++){var i=h.DataCodewords,j=b.ECCodewordsPerBlock+i;c[g++]=new DataBlock(i,Array(j))}a=c[0].codewords.length;for(e=c.length-1;e>=0;){if(c[e].codewords.length==a)break;e--}e++;b=a-b.ECCodewordsPerBlock;for(a=h=0;a<b;a++)for(f=0;f<g;f++)c[f].codewords[a]=
d[h++];for(f=e;f<g;f++)c[f].codewords[b]=d[h++];i=c[0].codewords.length;for(a=b;a<i;a++)for(f=0;f<g;f++)c[f].codewords[f<e?a:a+1]=d[h++];return c};
function BitMatrixParser(d){var a=d.Dimension;if(a<21||(a&3)!=1)throw"Error BitMatrixParser";this.bitMatrix=d;this.parsedFormatInfo=this.parsedVersion=null;this.copyBit=function(c,b,e){return this.bitMatrix.get_Renamed(c,b)?e<<1|1:e<<1};this.readFormatInformation=function(){if(this.parsedFormatInfo!=null)return this.parsedFormatInfo;for(var c=0,b=0;b<6;b++)c=this.copyBit(b,8,c);c=this.copyBit(7,8,c);c=this.copyBit(8,8,c);c=this.copyBit(8,7,c);for(b=5;b>=0;b--)c=this.copyBit(8,b,c);this.parsedFormatInfo=
FormatInformation.decodeFormatInformation(c);if(this.parsedFormatInfo!=null)return this.parsedFormatInfo;for(var e=this.bitMatrix.Dimension,c=0,a=e-8,b=e-1;b>=a;b--)c=this.copyBit(b,8,c);for(b=e-7;b<e;b++)c=this.copyBit(8,b,c);this.parsedFormatInfo=FormatInformation.decodeFormatInformation(c);if(this.parsedFormatInfo!=null)return this.parsedFormatInfo;throw"Error readFormatInformation";};this.readVersion=function(){if(this.parsedVersion!=null)return this.parsedVersion;var c=this.bitMatrix.Dimension,
b=c-17>>2;if(b<=6)return Version.getVersionForNumber(b);for(var b=0,e=c-11,a=5;a>=0;a--)for(var d=c-9;d>=e;d--)b=this.copyBit(d,a,b);this.parsedVersion=Version.decodeVersionInformation(b);if(this.parsedVersion!=null&&this.parsedVersion.DimensionForVersion==c)return this.parsedVersion;b=0;for(d=5;d>=0;d--)for(a=c-9;a>=e;a--)b=this.copyBit(d,a,b);this.parsedVersion=Version.decodeVersionInformation(b);if(this.parsedVersion!=null&&this.parsedVersion.DimensionForVersion==c)return this.parsedVersion;throw"Error readVersion";
};this.readCodewords=function(){var a=this.readFormatInformation(),b=this.readVersion(),e=this.bitMatrix.Dimension;DataMask.forReference(a.DataMask).unmaskBitMatrix(this.bitMatrix,e);for(var a=b.buildFunctionPattern(),d=true,f=Array(b.TotalCodewords),h=0,i=0,j=0,m=e-1;m>0;m-=2){m==6&&m--;for(var k=0;k<e;k++)for(var q=d?e-1-k:k,o=0;o<2;o++)a.get_Renamed(m-o,q)||(j++,i<<=1,this.bitMatrix.get_Renamed(m-o,q)&&(i|=1),j==8&&(f[h++]=i,i=j=0));d^=1}if(h!=b.TotalCodewords)throw"Error readCodewords";return f}}
DataMask={};DataMask.forReference=function(d){if(d<0||d>7)throw"System.ArgumentException";return DataMask.DATA_MASKS[d]};function DataMask000(){this.unmaskBitMatrix=function(d,a){for(var c=0;c<a;c++)for(var b=0;b<a;b++)this.isMasked(c,b)&&d.flip(b,c)};this.isMasked=function(d,a){return(d+a&1)==0}}function DataMask001(){this.unmaskBitMatrix=function(d,a){for(var c=0;c<a;c++)for(var b=0;b<a;b++)this.isMasked(c,b)&&d.flip(b,c)};this.isMasked=function(d){return(d&1)==0}}
function DataMask010(){this.unmaskBitMatrix=function(d,a){for(var c=0;c<a;c++)for(var b=0;b<a;b++)this.isMasked(c,b)&&d.flip(b,c)};this.isMasked=function(d,a){return a%3==0}}function DataMask011(){this.unmaskBitMatrix=function(d,a){for(var c=0;c<a;c++)for(var b=0;b<a;b++)this.isMasked(c,b)&&d.flip(b,c)};this.isMasked=function(d,a){return(d+a)%3==0}}
function DataMask100(){this.unmaskBitMatrix=function(d,a){for(var c=0;c<a;c++)for(var b=0;b<a;b++)this.isMasked(c,b)&&d.flip(b,c)};this.isMasked=function(d,a){return(URShift(d,1)+a/3&1)==0}}function DataMask101(){this.unmaskBitMatrix=function(d,a){for(var c=0;c<a;c++)for(var b=0;b<a;b++)this.isMasked(c,b)&&d.flip(b,c)};this.isMasked=function(d,a){var c=d*a;return(c&1)+c%3==0}}
function DataMask110(){this.unmaskBitMatrix=function(d,a){for(var c=0;c<a;c++)for(var b=0;b<a;b++)this.isMasked(c,b)&&d.flip(b,c)};this.isMasked=function(d,a){var c=d*a;return((c&1)+c%3&1)==0}}function DataMask111(){this.unmaskBitMatrix=function(d,a){for(var c=0;c<a;c++)for(var b=0;b<a;b++)this.isMasked(c,b)&&d.flip(b,c)};this.isMasked=function(d,a){return((d+a&1)+d*a%3&1)==0}}
DataMask.DATA_MASKS=[new DataMask000,new DataMask001,new DataMask010,new DataMask011,new DataMask100,new DataMask101,new DataMask110,new DataMask111];
function ReedSolomonDecoder(d){this.field=d;this.decode=function(a,c){for(var b=new GF256Poly(this.field,a),e=Array(c),d=0;d<e.length;d++)e[d]=0;for(var f=true,d=0;d<c;d++){var h=b.evaluateAt(this.field.exp(d));e[e.length-1-d]=h;h!=0&&(f=false)}if(!f){d=new GF256Poly(this.field,e);b=this.runEuclideanAlgorithm(this.field.buildMonomial(c,1),d,c);d=b[1];b=this.findErrorLocations(b[0]);e=this.findErrorMagnitudes(d,b,false);for(d=0;d<b.length;d++){f=a.length-1-this.field.log(b[d]);if(f<0)throw"ReedSolomonException Bad error location";
a[f]=GF256.addOrSubtract(a[f],e[d])}}};this.runEuclideanAlgorithm=function(a,c,b){if(a.Degree<c.Degree)var e=a,a=c,c=e;for(var e=this.field.One,d=this.field.Zero,f=this.field.Zero,h=this.field.One;c.Degree>=Math.floor(b/2);){var i=a,j=e,m=f,a=c,e=d,f=h;if(a.Zero)throw"r_{i-1} was zero";c=i;h=this.field.Zero;for(d=this.field.inverse(a.getCoefficient(a.Degree));c.Degree>=a.Degree&&!c.Zero;)var i=c.Degree-a.Degree,k=this.field.multiply(c.getCoefficient(c.Degree),d),h=h.addOrSubtract(this.field.buildMonomial(i,
k)),c=c.addOrSubtract(a.multiplyByMonomial(i,k));d=h.multiply1(e).addOrSubtract(j);h=h.multiply1(f).addOrSubtract(m)}b=h.getCoefficient(0);if(b==0)throw"ReedSolomonException sigmaTilde(0) was zero";b=this.field.inverse(b);a=h.multiply2(b);b=c.multiply2(b);return[a,b]};this.findErrorLocations=function(a){var c=a.Degree;if(c==1)return Array(a.getCoefficient(1));for(var b=Array(c),e=0,d=1;d<256&&e<c;d++)a.evaluateAt(d)==0&&(b[e]=this.field.inverse(d),e++);if(e!=c)throw"Error locator degree does not match number of roots";
return b};this.findErrorMagnitudes=function(a,c,b){for(var e=c.length,d=Array(e),f=0;f<e;f++){for(var h=this.field.inverse(c[f]),i=1,j=0;j<e;j++)f!=j&&(i=this.field.multiply(i,GF256.addOrSubtract(1,this.field.multiply(c[j],h))));d[f]=this.field.multiply(a.evaluateAt(h),this.field.inverse(i));b&&(d[f]=this.field.multiply(d[f],h))}return d}}
function GF256Poly(d,a){if(a==null||a.length==0)throw"System.ArgumentException";this.field=d;var c=a.length;if(c>1&&a[0]==0){for(var b=1;b<c&&a[b]==0;)b++;if(b==c)this.coefficients=d.Zero.coefficients;else{this.coefficients=Array(c-b);for(c=0;c<this.coefficients.length;c++)this.coefficients[c]=0;for(c=0;c<this.coefficients.length;c++)this.coefficients[c]=a[b+c]}}else this.coefficients=a;this.__defineGetter__("Zero",function(){return this.coefficients[0]==0});this.__defineGetter__("Degree",function(){return this.coefficients.length-
1});this.__defineGetter__("Coefficients",function(){return this.coefficients});this.getCoefficient=function(b){return this.coefficients[this.coefficients.length-1-b]};this.evaluateAt=function(b){if(b==0)return this.getCoefficient(0);var a=this.coefficients.length;if(b==1){for(var c=b=0;c<a;c++)b=GF256.addOrSubtract(b,this.coefficients[c]);return b}for(var d=this.coefficients[0],c=1;c<a;c++)d=GF256.addOrSubtract(this.field.multiply(b,d),this.coefficients[c]);return d};this.addOrSubtract=function(b){if(this.field!=
b.field)throw"GF256Polys do not have same GF256 field";if(this.Zero)return b;if(b.Zero)return this;var a=this.coefficients,b=b.coefficients;if(a.length>b.length)var c=a,a=b,b=c;for(var c=Array(b.length),h=b.length-a.length,i=0;i<h;i++)c[i]=b[i];for(i=h;i<b.length;i++)c[i]=GF256.addOrSubtract(a[i-h],b[i]);return new GF256Poly(d,c)};this.multiply1=function(b){if(this.field!=b.field)throw"GF256Polys do not have same GF256 field";if(this.Zero||b.Zero)return this.field.Zero;for(var a=this.coefficients,
c=a.length,b=b.coefficients,d=b.length,i=Array(c+d-1),j=0;j<c;j++)for(var m=a[j],k=0;k<d;k++)i[j+k]=GF256.addOrSubtract(i[j+k],this.field.multiply(m,b[k]));return new GF256Poly(this.field,i)};this.multiply2=function(b){if(b==0)return this.field.Zero;if(b==1)return this;for(var a=this.coefficients.length,c=Array(a),d=0;d<a;d++)c[d]=this.field.multiply(this.coefficients[d],b);return new GF256Poly(this.field,c)};this.multiplyByMonomial=function(b,a){if(b<0)throw"System.ArgumentException";if(a==0)return this.field.Zero;
for(var c=this.coefficients.length,d=Array(c+b),i=0;i<d.length;i++)d[i]=0;for(i=0;i<c;i++)d[i]=this.field.multiply(this.coefficients[i],a);return new GF256Poly(this.field,d)};this.divide=function(b){if(this.field!=b.field)throw"GF256Polys do not have same GF256 field";if(b.Zero)throw"Divide by 0";for(var a=this.field.Zero,c=this,d=this.field.inverse(b.getCoefficient(b.Degree));c.Degree>=b.Degree&&!c.Zero;)var i=c.Degree-b.Degree,j=this.field.multiply(c.getCoefficient(c.Degree),d),m=b.multiplyByMonomial(i,
j),i=this.field.buildMonomial(i,j),a=a.addOrSubtract(i),c=c.addOrSubtract(m);return[a,c]}}
function GF256(d){this.expTable=Array(256);this.logTable=Array(256);for(var a=1,c=0;c<256;c++)this.expTable[c]=a,a<<=1,a>=256&&(a^=d);for(c=0;c<255;c++)this.logTable[this.expTable[c]]=c;d=Array(1);d[0]=0;this.zero=new GF256Poly(this,Array(d));d=Array(1);d[0]=1;this.one=new GF256Poly(this,Array(d));this.__defineGetter__("Zero",function(){return this.zero});this.__defineGetter__("One",function(){return this.one});this.buildMonomial=function(b,a){if(b<0)throw"System.ArgumentException";if(a==0)return zero;
for(var c=Array(b+1),d=0;d<c.length;d++)c[d]=0;c[0]=a;return new GF256Poly(this,c)};this.exp=function(b){return this.expTable[b]};this.log=function(b){if(b==0)throw"System.ArgumentException";return this.logTable[b]};this.inverse=function(b){if(b==0)throw"System.ArithmeticException";return this.expTable[255-this.logTable[b]]};this.multiply=function(b,a){return b==0||a==0?0:b==1?a:a==1?b:this.expTable[(this.logTable[b]+this.logTable[a])%255]}}GF256.QR_CODE_FIELD=new GF256(285);
GF256.DATA_MATRIX_FIELD=new GF256(301);GF256.addOrSubtract=function(d,a){return d^a};Decoder={};Decoder.rsDecoder=new ReedSolomonDecoder(GF256.QR_CODE_FIELD);Decoder.correctErrors=function(d,a){for(var c=d.length,b=Array(c),e=0;e<c;e++)b[e]=d[e]&255;c=d.length-a;try{Decoder.rsDecoder.decode(b,c)}catch(g){throw g;}for(e=0;e<a;e++)d[e]=b[e]};
Decoder.decode=function(d){for(var a=new BitMatrixParser(d),d=a.readVersion(),c=a.readFormatInformation().ErrorCorrectionLevel,a=a.readCodewords(),a=DataBlock.getDataBlocks(a,d,c),b=0,e=0;e<a.length;e++)b+=a[e].NumDataCodewords;for(var b=Array(b),g=0,f=0;f<a.length;f++){var e=a[f],h=e.Codewords,i=e.NumDataCodewords;Decoder.correctErrors(h,i);for(e=0;e<i;e++)b[g++]=h[e]}return new QRCodeDataBlockReader(b,d.VersionNumber,c.Bits)};
qrcode={imagedata:null,width:0,height:0,qrCodeSymbol:null,debug:false,maxImgSize:1048576,sizeOfDataLengthInfo:[[10,9,8,8],[12,11,16,10],[14,13,16,12]],callback:null};
qrcode.decode=function(d){if(arguments.length==0){var a=document.getElementById("qr-canvas"),c=a.getContext("2d");qrcode.width=a.width;qrcode.height=a.height;qrcode.imagedata=c.getImageData(0,0,qrcode.width,qrcode.height);qrcode.result=qrcode.process(c);qrcode.callback!=null&&qrcode.callback(qrcode.result);return qrcode.result}else{var b=new Image;b.onload=function(){var a=document.createElement("canvas"),c=a.getContext("2d"),d=b.height,h=b.width;b.width*b.height>qrcode.maxImgSize&&(h=b.width/b.height,
d=Math.sqrt(qrcode.maxImgSize/h),h*=d);a.width=h;a.height=d;c.drawImage(b,0,0,a.width,a.height);qrcode.width=a.width;qrcode.height=a.height;try{qrcode.imagedata=c.getImageData(0,0,a.width,a.height)}catch(i){qrcode.result="Cross domain image reading not supported in your browser! Save it to your computer then drag and drop the file!";qrcode.callback!=null&&qrcode.callback(qrcode.result);return}try{qrcode.result=qrcode.process(c)}catch(j){console.log(j),qrcode.result="error decoding QR Code"}qrcode.callback!=
null&&qrcode.callback(qrcode.result)};b.src=d}};qrcode.isUrl=function(d){return/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/.test(d)};qrcode.decode_url=function(d){var a="";try{a=escape(d)}catch(c){console.log(c),a=d}d="";try{d=decodeURIComponent(a)}catch(b){console.log(b),d=a}return d};qrcode.decode_utf8=function(d){return qrcode.isUrl(d)?qrcode.decode_url(d):d};
qrcode.process=function(d){(new Date).getTime();var a=qrcode.grayScaleToBitmap(qrcode.grayscale());if(qrcode.debug){for(var c=0;c<qrcode.height;c++)for(var b=0;b<qrcode.width;b++){var e=b*4+c*qrcode.width*4;qrcode.imagedata.data[e]=a[b+c*qrcode.width]?0:0;qrcode.imagedata.data[e+1]=a[b+c*qrcode.width]?0:0;qrcode.imagedata.data[e+2]=a[b+c*qrcode.width]?255:0}d.putImageData(qrcode.imagedata,0,0)}a=(new Detector(a)).detect();qrcode.debug&&d.putImageData(qrcode.imagedata,0,0);d=Decoder.decode(a.bits).DataByte;
a="";for(c=0;c<d.length;c++)for(b=0;b<d[c].length;b++)a+=String.fromCharCode(d[c][b]);(new Date).getTime();return qrcode.decode_utf8(a)};qrcode.getPixel=function(d,a){if(qrcode.width<d)throw"point error";if(qrcode.height<a)throw"point error";point=d*4+a*qrcode.width*4;return p=(qrcode.imagedata.data[point]*33+qrcode.imagedata.data[point+1]*34+qrcode.imagedata.data[point+2]*33)/100};
qrcode.binarize=function(d){for(var a=Array(qrcode.width*qrcode.height),c=0;c<qrcode.height;c++)for(var b=0;b<qrcode.width;b++){var e=qrcode.getPixel(b,c);a[b+c*qrcode.width]=e<=d?true:false}return a};
qrcode.getMiddleBrightnessPerArea=function(d){for(var a=Math.floor(qrcode.width/4),c=Math.floor(qrcode.height/4),b=Array(4),e=0;e<4;e++){b[e]=Array(4);for(var g=0;g<4;g++)b[e][g]=[0,0]}for(e=0;e<4;e++)for(g=0;g<4;g++){b[g][e][0]=255;for(var f=0;f<c;f++)for(var h=0;h<a;h++){var i=d[a*g+h+(c*e+f)*qrcode.width];i<b[g][e][0]&&(b[g][e][0]=i);i>b[g][e][1]&&(b[g][e][1]=i)}}d=Array(4);for(a=0;a<4;a++)d[a]=Array(4);for(e=0;e<4;e++)for(g=0;g<4;g++)d[g][e]=Math.floor((b[g][e][0]+b[g][e][1])/2);return d};
qrcode.grayScaleToBitmap=function(d){for(var a=qrcode.getMiddleBrightnessPerArea(d),c=a.length,b=Math.floor(qrcode.width/c),e=Math.floor(qrcode.height/c),g=Array(qrcode.height*qrcode.width),f=0;f<c;f++)for(var h=0;h<c;h++)for(var i=0;i<e;i++)for(var j=0;j<b;j++)g[b*h+j+(e*f+i)*qrcode.width]=d[b*h+j+(e*f+i)*qrcode.width]<a[h][f]?true:false;return g};
qrcode.grayscale=function(){for(var d=Array(qrcode.width*qrcode.height),a=0;a<qrcode.height;a++)for(var c=0;c<qrcode.width;c++){var b=qrcode.getPixel(c,a);d[c+a*qrcode.width]=b}return d};function URShift(d,a){return d>=0?d>>a:(d>>a)+(2<<~a)}Array.prototype.remove=function(d,a){var c=this.slice((a||d)+1||this.length);this.length=d<0?this.length+d:d;return this.push.apply(this,c)};var MIN_SKIP=3,MAX_MODULES=57,INTEGER_MATH_SHIFT=8,CENTER_QUORUM=2;
qrcode.orderBestPatterns=function(d){function a(b,a){xDiff=b.X-a.X;yDiff=b.Y-a.Y;return Math.sqrt(xDiff*xDiff+yDiff*yDiff)}var c=a(d[0],d[1]),b=a(d[1],d[2]),e=a(d[0],d[2]);b>=c&&b>=e?(b=d[0],c=d[1],e=d[2]):e>=b&&e>=c?(b=d[1],c=d[0],e=d[2]):(b=d[2],c=d[0],e=d[1]);if(function(b,a,c){var d=a.x,a=a.y;return(c.x-d)*(b.y-a)-(c.y-a)*(b.x-d)}(c,b,e)<0)var g=c,c=e,e=g;d[0]=c;d[1]=b;d[2]=e};
function FinderPattern(d,a,c){this.x=d;this.y=a;this.count=1;this.estimatedModuleSize=c;this.__defineGetter__("EstimatedModuleSize",function(){return this.estimatedModuleSize});this.__defineGetter__("Count",function(){return this.count});this.__defineGetter__("X",function(){return this.x});this.__defineGetter__("Y",function(){return this.y});this.incrementCount=function(){this.count++};this.aboutEquals=function(b,a,c){return Math.abs(a-this.y)<=b&&Math.abs(c-this.x)<=b?(b=Math.abs(b-this.estimatedModuleSize),
b<=1||b/this.estimatedModuleSize<=1):false}}function FinderPatternInfo(d){this.bottomLeft=d[0];this.topLeft=d[1];this.topRight=d[2];this.__defineGetter__("BottomLeft",function(){return this.bottomLeft});this.__defineGetter__("TopLeft",function(){return this.topLeft});this.__defineGetter__("TopRight",function(){return this.topRight})}
function FinderPatternFinder(){this.image=null;this.possibleCenters=[];this.hasSkipped=false;this.crossCheckStateCount=[0,0,0,0,0];this.resultPointCallback=null;this.__defineGetter__("CrossCheckStateCount",function(){this.crossCheckStateCount[0]=0;this.crossCheckStateCount[1]=0;this.crossCheckStateCount[2]=0;this.crossCheckStateCount[3]=0;this.crossCheckStateCount[4]=0;return this.crossCheckStateCount});this.foundPatternCross=function(d){for(var a=0,c=0;c<5;c++){var b=d[c];if(b==0)return false;a+=
b}if(a<7)return false;a=Math.floor((a<<INTEGER_MATH_SHIFT)/7);c=Math.floor(a/2);return Math.abs(a-(d[0]<<INTEGER_MATH_SHIFT))<c&&Math.abs(a-(d[1]<<INTEGER_MATH_SHIFT))<c&&Math.abs(3*a-(d[2]<<INTEGER_MATH_SHIFT))<3*c&&Math.abs(a-(d[3]<<INTEGER_MATH_SHIFT))<c&&Math.abs(a-(d[4]<<INTEGER_MATH_SHIFT))<c};this.centerFromEnd=function(d,a){return a-d[4]-d[3]-d[2]/2};this.crossCheckVertical=function(d,a,c,b){for(var e=this.image,g=qrcode.height,f=this.CrossCheckStateCount,h=d;h>=0&&e[a+h*qrcode.width];)f[2]++,
h--;if(h<0)return NaN;for(;h>=0&&!e[a+h*qrcode.width]&&f[1]<=c;)f[1]++,h--;if(h<0||f[1]>c)return NaN;for(;h>=0&&e[a+h*qrcode.width]&&f[0]<=c;)f[0]++,h--;if(f[0]>c)return NaN;for(h=d+1;h<g&&e[a+h*qrcode.width];)f[2]++,h++;if(h==g)return NaN;for(;h<g&&!e[a+h*qrcode.width]&&f[3]<c;)f[3]++,h++;if(h==g||f[3]>=c)return NaN;for(;h<g&&e[a+h*qrcode.width]&&f[4]<c;)f[4]++,h++;return f[4]>=c?NaN:5*Math.abs(f[0]+f[1]+f[2]+f[3]+f[4]-b)>=2*b?NaN:this.foundPatternCross(f)?this.centerFromEnd(f,h):NaN};this.crossCheckHorizontal=
function(d,a,c,b){for(var e=this.image,g=qrcode.width,f=this.CrossCheckStateCount,h=d;h>=0&&e[h+a*qrcode.width];)f[2]++,h--;if(h<0)return NaN;for(;h>=0&&!e[h+a*qrcode.width]&&f[1]<=c;)f[1]++,h--;if(h<0||f[1]>c)return NaN;for(;h>=0&&e[h+a*qrcode.width]&&f[0]<=c;)f[0]++,h--;if(f[0]>c)return NaN;for(h=d+1;h<g&&e[h+a*qrcode.width];)f[2]++,h++;if(h==g)return NaN;for(;h<g&&!e[h+a*qrcode.width]&&f[3]<c;)f[3]++,h++;if(h==g||f[3]>=c)return NaN;for(;h<g&&e[h+a*qrcode.width]&&f[4]<c;)f[4]++,h++;return f[4]>=
c?NaN:5*Math.abs(f[0]+f[1]+f[2]+f[3]+f[4]-b)>=b?NaN:this.foundPatternCross(f)?this.centerFromEnd(f,h):NaN};this.handlePossibleCenter=function(d,a,c){var b=d[0]+d[1]+d[2]+d[3]+d[4],c=this.centerFromEnd(d,c),a=this.crossCheckVertical(a,Math.floor(c),d[2],b);if(!isNaN(a)&&(c=this.crossCheckHorizontal(Math.floor(c),Math.floor(a),d[2],b),!isNaN(c))){for(var d=b/7,b=false,e=this.possibleCenters.length,g=0;g<e;g++){var f=this.possibleCenters[g];if(f.aboutEquals(d,a,c)){f.incrementCount();b=true;break}}b||
(c=new FinderPattern(c,a,d),this.possibleCenters.push(c),this.resultPointCallback!=null&&this.resultPointCallback.foundPossibleResultPoint(c));return true}return false};this.selectBestPatterns=function(){var d=this.possibleCenters.length;if(d<3)throw"Couldn't find enough finder patterns";if(d>3){for(var a=0,c=0,b=0;b<d;b++){var e=this.possibleCenters[b].EstimatedModuleSize;a+=e;c+=e*e}var g=a/d;this.possibleCenters.sort(function(b,a){var c=Math.abs(a.EstimatedModuleSize-g),d=Math.abs(b.EstimatedModuleSize-
g);return c<d?-1:c==d?0:1});b=Math.sqrt(c/d-g*g);d=Math.max(0.2*g,b);for(b=0;b<this.possibleCenters.length&&this.possibleCenters.length>3;b++)Math.abs(this.possibleCenters[b].EstimatedModuleSize-g)>d&&(this.possibleCenters.remove(b),b--)}this.possibleCenters.length>3&&this.possibleCenters.sort(function(b,a){return b.count>a.count?-1:b.count<a.count?1:0});return[this.possibleCenters[0],this.possibleCenters[1],this.possibleCenters[2]]};this.findRowSkip=function(){var d=this.possibleCenters.length;if(d<=
1)return 0;for(var a=null,c=0;c<d;c++){var b=this.possibleCenters[c];if(b.Count>=CENTER_QUORUM)if(a==null)a=b;else return this.hasSkipped=true,Math.floor((Math.abs(a.X-b.X)-Math.abs(a.Y-b.Y))/2)}return 0};this.haveMultiplyConfirmedCenters=function(){for(var d=0,a=0,c=this.possibleCenters.length,b=0;b<c;b++){var e=this.possibleCenters[b];e.Count>=CENTER_QUORUM&&(d++,a+=e.EstimatedModuleSize)}if(d<3)return false;for(var d=a/c,g=0,b=0;b<c;b++)e=this.possibleCenters[b],g+=Math.abs(e.EstimatedModuleSize-
d);return g<=0.05*a};this.findFinderPattern=function(d){this.image=d;var a=qrcode.height,c=qrcode.width,b=Math.floor(3*a/(4*MAX_MODULES));b<MIN_SKIP&&(b=MIN_SKIP);for(var e=false,g=Array(5),f=b-1;f<a&&!e;f+=b){g[0]=0;g[1]=0;g[2]=0;g[3]=0;for(var h=g[4]=0,i=0;i<c;i++)if(d[i+f*qrcode.width])(h&1)==1&&h++,g[h]++;else if((h&1)==0)if(h==4)if(this.foundPatternCross(g)){if(h=this.handlePossibleCenter(g,f,i))b=2,this.hasSkipped?e=this.haveMultiplyConfirmedCenters():(h=this.findRowSkip(),h>g[2]&&(f+=h-g[2]-
b,i=c-1));else{do i++;while(i<c&&!d[i+f*qrcode.width]);i--}h=0;g[0]=0;g[1]=0;g[2]=0;g[3]=0;g[4]=0}else g[0]=g[2],g[1]=g[3],g[2]=g[4],g[3]=1,g[4]=0,h=3;else g[++h]++;else g[h]++;if(this.foundPatternCross(g)&&(h=this.handlePossibleCenter(g,f,c)))b=g[0],this.hasSkipped&&(e=haveMultiplyConfirmedCenters())}d=this.selectBestPatterns();qrcode.orderBestPatterns(d);return new FinderPatternInfo(d)}}
function AlignmentPattern(d,a,c){this.x=d;this.y=a;this.count=1;this.estimatedModuleSize=c;this.__defineGetter__("EstimatedModuleSize",function(){return this.estimatedModuleSize});this.__defineGetter__("Count",function(){return this.count});this.__defineGetter__("X",function(){return Math.floor(this.x)});this.__defineGetter__("Y",function(){return Math.floor(this.y)});this.incrementCount=function(){this.count++};this.aboutEquals=function(b,a,c){return Math.abs(a-this.y)<=b&&Math.abs(c-this.x)<=b?
(b=Math.abs(b-this.estimatedModuleSize),b<=1||b/this.estimatedModuleSize<=1):false}}
function AlignmentPatternFinder(d,a,c,b,e,g,f){this.image=d;this.possibleCenters=[];this.startX=a;this.startY=c;this.width=b;this.height=e;this.moduleSize=g;this.crossCheckStateCount=[0,0,0];this.resultPointCallback=f;this.centerFromEnd=function(b,a){return a-b[2]-b[1]/2};this.foundPatternCross=function(b){for(var a=this.moduleSize,c=a/2,d=0;d<3;d++)if(Math.abs(a-b[d])>=c)return false;return true};this.crossCheckVertical=function(b,a,c,d){var e=this.image,f=qrcode.height,g=this.crossCheckStateCount;
g[0]=0;g[1]=0;g[2]=0;for(var l=b;l>=0&&e[a+l*qrcode.width]&&g[1]<=c;)g[1]++,l--;if(l<0||g[1]>c)return NaN;for(;l>=0&&!e[a+l*qrcode.width]&&g[0]<=c;)g[0]++,l--;if(g[0]>c)return NaN;for(l=b+1;l<f&&e[a+l*qrcode.width]&&g[1]<=c;)g[1]++,l++;if(l==f||g[1]>c)return NaN;for(;l<f&&!e[a+l*qrcode.width]&&g[2]<=c;)g[2]++,l++;return g[2]>c?NaN:5*Math.abs(g[0]+g[1]+g[2]-d)>=2*d?NaN:this.foundPatternCross(g)?this.centerFromEnd(g,l):NaN};this.handlePossibleCenter=function(b,a,c){var d=b[0]+b[1]+b[2],c=this.centerFromEnd(b,
c),a=this.crossCheckVertical(a,Math.floor(c),2*b[1],d);if(!isNaN(a)){for(var b=(b[0]+b[1]+b[2])/3,d=this.possibleCenters.length,e=0;e<d;e++)if(this.possibleCenters[e].aboutEquals(b,a,c))return new AlignmentPattern(c,a,b);c=new AlignmentPattern(c,a,b);this.possibleCenters.push(c);this.resultPointCallback!=null&&this.resultPointCallback.foundPossibleResultPoint(c)}return null};this.find=function(){for(var a=this.startX,e=this.height,f=a+b,g=c+(e>>1),k=[0,0,0],q=0;q<e;q++){var o=g+((q&1)==0?q+1>>1:-(q+
1>>1));k[0]=0;k[1]=0;k[2]=0;for(var l=a;l<f&&!d[l+qrcode.width*o];)l++;for(var n=0;l<f;){if(d[l+o*qrcode.width])if(n==1)k[n]++;else if(n==2){if(this.foundPatternCross(k)&&(n=this.handlePossibleCenter(k,o,l),n!=null))return n;k[0]=k[2];k[1]=1;k[2]=0;n=1}else k[++n]++;else n==1&&n++,k[n]++;l++}if(this.foundPatternCross(k)&&(n=this.handlePossibleCenter(k,o,f),n!=null))return n}if(this.possibleCenters.length!=0)return this.possibleCenters[0];throw"Couldn't find enough alignment patterns";}}
function QRCodeDataBlockReader(d,a,c){this.blockPointer=0;this.bitPointer=7;this.dataLength=0;this.blocks=d;this.numErrorCorrectionCode=c;if(a<=9)this.dataLengthMode=0;else if(a>=10&&a<=26)this.dataLengthMode=1;else if(a>=27&&a<=40)this.dataLengthMode=2;this.getNextBits=function(b){var a=0;if(b<this.bitPointer+1){for(var c=0,a=0;a<b;a++)c+=1<<a;c<<=this.bitPointer-b+1;a=(this.blocks[this.blockPointer]&c)>>this.bitPointer-b+1;this.bitPointer-=b;return a}else if(b<this.bitPointer+1+8){for(var d=0,a=
0;a<this.bitPointer+1;a++)d+=1<<a;a=(this.blocks[this.blockPointer]&d)<<b-(this.bitPointer+1);this.blockPointer++;a+=this.blocks[this.blockPointer]>>8-(b-(this.bitPointer+1));this.bitPointer-=b%8;if(this.bitPointer<0)this.bitPointer=8+this.bitPointer;return a}else if(b<this.bitPointer+1+16){for(a=c=d=0;a<this.bitPointer+1;a++)d+=1<<a;d=(this.blocks[this.blockPointer]&d)<<b-(this.bitPointer+1);this.blockPointer++;var h=this.blocks[this.blockPointer]<<b-(this.bitPointer+1+8);this.blockPointer++;for(a=
0;a<b-(this.bitPointer+1+8);a++)c+=1<<a;c<<=8-(b-(this.bitPointer+1+8));a=d+h+((this.blocks[this.blockPointer]&c)>>8-(b-(this.bitPointer+1+8)));this.bitPointer-=(b-8)%8;if(this.bitPointer<0)this.bitPointer=8+this.bitPointer;return a}else return 0};this.NextMode=function(){return this.blockPointer>this.blocks.length-this.numErrorCorrectionCode-2?0:this.getNextBits(4)};this.getDataLength=function(b){for(var a=0;;){if(b>>a==1)break;a++}return this.getNextBits(qrcode.sizeOfDataLengthInfo[this.dataLengthMode][a])};
this.getRomanAndFigureString=function(b){var a=0,c="",d="0,1,2,3,4,5,6,7,8,9,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z, ,$,%,*,+,-,.,/,:".split(",");do if(b>1){var a=this.getNextBits(11),h=a%45;c+=d[Math.floor(a/45)];c+=d[h];b-=2}else b==1&&(a=this.getNextBits(6),c+=d[a],b-=1);while(b>0);return c};this.getFigureString=function(b){var a=0,c="";do b>=3?(a=this.getNextBits(10),a<100&&(c+="0"),a<10&&(c+="0"),b-=3):b==2?(a=this.getNextBits(7),a<10&&(c+="0"),b-=2):b==1&&(a=this.getNextBits(4),
b-=1),c+=a;while(b>0);return c};this.get8bitByteArray=function(b){var a=0,c=[];do a=this.getNextBits(8),c.push(a),b--;while(b>0);return c};this.getKanjiString=function(b){var a=0,c="";do{var a=getNextBits(13),a=(a/192<<8)+a%192,d=0,d=a+33088<=40956?a+33088:a+49472;c+=String.fromCharCode(d);b--}while(b>0);return c};this.__defineGetter__("DataByte",function(){var b=[];do{var a=this.NextMode();if(a==0)if(b.length>0)break;else throw"Empty data block";if(a!=1&&a!=2&&a!=4&&a!=8)throw"Invalid mode: "+a+
" in (block:"+this.blockPointer+" bit:"+this.bitPointer+")";dataLength=this.getDataLength(a);if(dataLength<1)throw"Invalid data length: "+dataLength;switch(a){case 1:for(var a=this.getFigureString(dataLength),c=Array(a.length),d=0;d<a.length;d++)c[d]=a.charCodeAt(d);b.push(c);break;case 2:a=this.getRomanAndFigureString(dataLength);c=Array(a.length);for(d=0;d<a.length;d++)c[d]=a.charCodeAt(d);b.push(c);break;case 4:a=this.get8bitByteArray(dataLength);b.push(a);break;case 8:a=this.getKanjiString(dataLength),
b.push(a)}}while(1);return b})}onmessage=function(d){var a,c;qrcode.imagedata=d.data.imageData;qrcode.width=d.data.width||256;qrcode.height=d.data.height||256;try{c=true,a=qrcode.process()}catch(b){c=false,a=b.toString()}self.postMessage({result:a,success:c})};
