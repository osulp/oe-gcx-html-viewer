var geocortex;
(function(f){(function(f){var m=function(){function d(b,a,c,d,g,l,h,e){this.STORAGE_TEXTFILE_NAME="AnalyticsEventsText";this.STORAGE_ZIPFILE_NAME="AnalyticsEventsZip";this.STORAGE_ANALYTICS_GUID="InsightWorkstationGuid";this.ERROR_MSG_LOCAL_STORAGE_NOT_SUPPORTED="Geocortex Event Relay cannot run because the current browser does not support local storage in HTML5.";this.ERROR_MSG_LOCAL_STORAGE_EXCEPTION="Exception occurred while saving temporary data to the browser's local storage; the maximum allowed space allowed be used up. No further events will be collected until the data is sent to Insight or the browser cache is cleared.";this._localStorageAvailable=
!0;this._isIE=!1;this._dataTransmissionTimer=null;var f=this;this._tempEventCollection=[];if("undefined"===typeof Storage)console.log(this.ERROR_MSG_LOCAL_STORAGE_NOT_SUPPORTED),this._enabled=!1;else{e&&0!==e.length||(e=window.location.pathname,e=e.replace(e.substr(e.lastIndexOf("/")+1),""),e="//"+window.location.host+e+"Resources/Scripts");if("undefined"!==typeof require)require({packages:[{name:"jszip",location:e,main:"jszip"}]},["jszip"],function(a){JSZip=a});else{e=document.getElementsByTagName("head")[0];
var k=document.createElement("script");k.type="text/javascript";k.src="Resources/Scripts/jszip.js";e.appendChild(k)}this._isIE=this._detectIE();this._siteId=d?d:c;this._viewerId=a;this._endpointUrl=l?l:window.location.protocol+"//"+window.location.host+"/Geocortex/Analytics/ClientRelay";this._timerDuration=this._transmissionInterval=h?1E3*h:3E4;g||(g="1.0");this._sessionId=this._generateGuid();this._workstationId=this._getWorkstationId();this._logStartupEvent(c,b,g);this._dataTransmissionTimer=setTimeout(function(){f._sendDataToClientRelay(f._endpointUrl)},
f._timerDuration)}}d.prototype.setupMap=function(b){var a=this;if(null==this._map)if(this._map=b,b.loaded)this._initializeMapEvents();else b.on("load",function(){a._initializeMapEvents()})};d.prototype.logEvent=function(b,a){b&&a&&(a.type=b,this._queueData(a))};d.prototype._initializeMapEvents=function(){var b=this,a=new esri.layers.LOD;a.level=this._map.getLevel();a.scale=this._map.getScale();if(null!=a.level&&0<=a.level)for(var c=this._map.getLayersVisibleAtScale(),d=0;d<c.length;d++){var g=c[d];
if(g instanceof esri.layers.ArcGISTiledMapServiceLayer&&g.tileInfo.lods.length>a.level){a.resolution=g.tileInfo.lods[a.level].resolution;break}}this._logExtentChange(this._map.extent,a);this._map.on("extent-change",function(a){return b._logExtentChange(a.extent,a.lod)});for(a=0;a<this._map.layerIds.length;a++)this._map.getLayer(this._map.layerIds[a]).on("visibility-change",function(a){return b._logVisibilityChange(a)});this._map.on("layer-add",function(a){if(null!=a.layer.layerInfos)a.layer.on("visibility-change",
function(a){return b._logVisibilityChange(a)})})};d.prototype._logStartupEvent=function(b,a,c){b={viewerType:a,viewerVersion:c,siteID:b,appVersion:navigator.appVersion,appName:navigator.appName,userAgent:navigator.userAgent,browserWidth:$(window).width(),browserHeight:$(window).height(),screenWidth:screen.width,screenHeight:screen.height};this.logEvent("StartUp",b)};d.prototype._logExtentChange=function(b,a){var c={xMax:b.xmax,xMin:b.xmin,yMax:b.ymax,yMin:b.ymin,spatialReference:b.spatialReference};
null!=a&&(c.resolution=a.resolution,c.scale=a.scale);this.logEvent("MapExtent",c)};d.prototype._logVisibilityChange=function(b){this.logEvent("VisibleMapService",{mapServiceURL:b.target.url,visible:b.visible})};d.prototype._queueData=function(b){var a=this;!1!==this._enabled&&!1!==this._localStorageAvailable&&(b.timestamp=this._generateTimestamp(),b.sessionID=this._sessionId,b.workstationID=this._workstationId,b.siteURL=this._siteId,b.viewerID=this._viewerId,this._tempEventCollection.push(b),null==
this._writeToStorageTimeoutToken&&(this._writeToStorageTimeoutToken=setTimeout(function(){return a._writeToStorage()},5E3)))};d.prototype._writeToStorage=function(){if(null!=this._tempEventCollection&&0!==this._tempEventCollection.length){for(var b=localStorage,a=b.getItem(this.STORAGE_TEXTFILE_NAME),c=0,d=this._tempEventCollection.length;c<d;c++){var g=this._tempEventCollection[c],f;try{f=JSON.stringify(g)}catch(h){continue}a=this._isIE?(null!=a?a+"%0D%0A":"")+encodeURI(f):(null!=a?a+"\r\n":"")+
f}try{b.setItem(this.STORAGE_TEXTFILE_NAME,a),this._localStorageAvailable||(this._localStorageAvailable=!0)}catch(e){console.log(this.ERROR_MSG_LOCAL_STORAGE_EXCEPTION);this._localStorageAvailable=!1;return}100<2*a.length/1024&&this._compressEvents();this._tempEventCollection=[];clearTimeout(this._writeToStorageTimeoutToken);this._writeToStorageTimeoutToken=null}};d.prototype._compressEvents=function(){if(!1!==this._localStorageAvailable&&"undefined"!==typeof JSZip){var b=localStorage,a=b.getItem(this.STORAGE_TEXTFILE_NAME);
if(null!=a){var c=b.getItem(this.STORAGE_ZIPFILE_NAME);if(null!=c&&3E3<2*c.length/1024)this._localStorageAvailable=!1;else{this._isIE&&(null!=c&&(c=decodeURI(c)),a=decodeURI(a));c=null!=c?new JSZip(c):new JSZip;c.file(this._generateGuid(),a);b.removeItem(this.STORAGE_TEXTFILE_NAME);a=c.generate({compression:"DEFLATE",compressionOptions:{level:9},type:"string"});this._isIE&&(a=encodeURI(a));try{b.setItem(this.STORAGE_ZIPFILE_NAME,a),this._localStorageAvailable=!0}catch(d){console.log(this.ERROR_MSG_LOCAL_STORAGE_EXCEPTION),
this._localStorageAvailable=!1}}}}};d.prototype._sendDataToClientRelay=function(b){var a=this;if(!1!==this._enabled&&"undefined"!==typeof JSZip){this._compressEvents();var c=localStorage.getItem(this.STORAGE_ZIPFILE_NAME);null==c?a._resetDataTransmissionTimer(a):(this._isIE&&(c=decodeURI(c)),c=(new JSZip(c)).generate({compression:"DEFLATE",compressionOptions:{level:9}}),$.ajax({type:"POST",url:b,data:c,error:function(){9E5>=a._timerDuration?a._timerDuration*=2:18E5>a._timerDuration&&(a._timerDuration=
18E5);a._resetDataTransmissionTimer(a)},success:function(){localStorage.removeItem(a.STORAGE_ZIPFILE_NAME);a._localStorageAvailable=!0;a._timerDuration=a._transmissionInterval;a._resetDataTransmissionTimer(a)},processData:!1,contentType:"multipart/form-data"}))}};d.prototype._resetDataTransmissionTimer=function(b){clearTimeout(b._dataTransmissionTimer);b._dataTransmissionTimer=null;b._dataTransmissionTimer=setTimeout(function(){b._sendDataToClientRelay(b._endpointUrl)},b._timerDuration)};d.prototype._getWorkstationId=
function(){var b=this.STORAGE_ANALYTICS_GUID,a=localStorage.getItem(b);if("undefined"===typeof a||null==a)a=this._generateGuid(),localStorage.setItem(b,a);return a};d.prototype._generateGuid=function(){var b;b="undefined"!==typeof performance&&"undefined"!==typeof performance.now?performance.now():(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var c=(b+16*Math.random())%16|0;b=Math.floor(b/16);return("x"===a?c:c&3|8).toString(16)})};d.prototype._generateTimestamp=
function(){if(Date.prototype.toISOString)return(new Date).toISOString();(function(){function b(a){a=String(a);1===a.length&&(a="0"+a);return a}Date.prototype.toISOString=function(){return this.getUTCFullYear()+"-"+b(this.getUTCMonth()+1)+"-"+b(this.getUTCDate())+"T"+b(this.getUTCHours())+":"+b(this.getUTCMinutes())+":"+b(this.getUTCSeconds())+"."+String((this.getUTCMilliseconds()/1E3).toFixed(3)).slice(2,5)+"Z"}})()};d.prototype._detectIE=function(){var b=window.navigator.userAgent;return 0<b.indexOf("MSIE ")||
0<b.indexOf("Trident/")||0<b.indexOf("Edge/")?!0:!1};return d}();f.EventRelay=m})(f.insight||(f.insight={}))})(geocortex||(geocortex={}));geocortex.framework.notifyLibraryDownload("EventRelay");
