var geocortex;
(function(d){(function(d){var m=function(){function c(b,a,f,c,g,l,d,e){this.STORAGE_TEXTFILE_NAME="InsightEventsText";this.STORAGE_ZIPFILE_NAME="InsightEventsZip";this.STORAGE_INSIGHT_GUID="InsightWorkstationGuid";this.ERROR_MSG_LOCAL_STORAGE_NOT_SUPPORTED="Geocortex Event Relay cannot run because the current browser does not support local storage in HTML5.";this.ERROR_MSG_LOCAL_STORAGE_EXCEPTION="Exception occurred while saving temporary data to the browser's local storage; the maximum allowed space allowed be used up. No further events will be collected until the data is sent to Insight or the browser cache is cleared.";this._localStorageAvailable=
!0;this._dataTransmissionTimer=null;var h=this;if("undefined"===typeof Storage)console.log(this.ERROR_MSG_LOCAL_STORAGE_NOT_SUPPORTED),this._enabled=!1;else{e&&0!==e.length||(e=window.location.pathname,e=e.replace(e.substr(e.lastIndexOf("/")+1),""),e="//"+window.location.host+e+"Resources/Scripts");if("undefined"!==typeof require)require({packages:[{name:"jszip",location:e,main:"jszip"}]},["jszip"],function(b){JSZip=b});else{e=document.getElementsByTagName("head")[0];var k=document.createElement("script");
k.type="text/javascript";k.src="Resources/Scripts/jszip.js";e.appendChild(k)}this._siteId=c?c:f;this._viewerId=a;this._endpointUrl=l?l:window.location.protocol+"//"+window.location.host+"/Geocortex/Insight/Insight/ClientRelay";this._timerDuration=this._transmissionInterval=d?1E3*d:3E4;g||(g="1.0");this._sessionId=this._generateGuid();this._workstationId=this._getWorkstationId();this._logStartupEvent(f,b,g);this._dataTransmissionTimer=setTimeout(function(){h._sendDataToClientRelay(h._endpointUrl)},
h._timerDuration)}}c.prototype.setupMap=function(b){var a=this;if(null==this._map)if(this._map=b,b.loaded)this._initializeMapEvents();else b.on("load",function(){a._initializeMapEvents()})};c.prototype.logEvent=function(b,a){b&&a&&(a.type=b,this._queueData(a))};c.prototype._initializeMapEvents=function(){var b=this,a=new esri.layers.LOD;a.level=this._map.getLevel();a.scale=this._map.getScale();if(null!=a.level&&0<=a.level)for(var f=this._map.getLayersVisibleAtScale(),c=0;c<f.length;c++){var d=f[c];
if(d instanceof esri.layers.ArcGISTiledMapServiceLayer&&d.tileInfo.lods.length>a.level){a.resolution=d.tileInfo.lods[a.level].resolution;break}}this._logExtentChange(this._map.extent,a);this._map.on("extent-change",function(a){return b._logExtentChange(a.extent,a.lod)});for(a=0;a<this._map.layerIds.length;a++)this._map.getLayer(this._map.layerIds[a]).on("visibility-change",function(a){b._logVisibilityChange(a)});this._map.on("layer-add",function(a){if(null!=a.layer.layerInfos)a.layer.on("visibility-change",
function(a){b._logVisibilityChange(a)})})};c.prototype._logStartupEvent=function(b,a,c){b={viewerType:a,viewerVersion:c,siteID:b,appVersion:navigator.appVersion,appName:navigator.appName,userAgent:navigator.userAgent,browserWidth:$(window).width(),browserHeight:$(window).height(),screenWidth:screen.width,screenHeight:screen.height};this.logEvent("StartUp",b)};c.prototype._logExtentChange=function(b,a){var c={xMax:b.xmax,xMin:b.xmin,yMax:b.ymax,yMin:b.ymin,spatialReference:b.spatialReference};null!=
a&&(c.resolution=a.resolution,c.scale=a.scale);this.logEvent("MapExtent",c)};c.prototype._logVisibilityChange=function(b){this.logEvent("VisibleMapService",{mapServiceURL:b.target.url,visible:b.visible})};c.prototype._queueData=function(b){if(!1!==this._enabled&&!1!==this._localStorageAvailable){b.timestamp=this._generateTimestamp();b.sessionID=this._sessionId;b.workstationID=this._workstationId;b.siteURL=this._siteId;b.viewerID=this._viewerId;var a;try{a=JSON.stringify(b)}catch(c){return}b=localStorage.getItem(this.STORAGE_TEXTFILE_NAME);
b=null!=b?this._decodeString(b)+"\r\n"+a:a;try{localStorage.setItem(this.STORAGE_TEXTFILE_NAME,this._encodeString(b)),this._localStorageAvailable=!0}catch(d){console.log(this.ERROR_MSG_LOCAL_STORAGE_EXCEPTION);this._localStorageAvailable=!1;return}100<2*b.length/1024&&this._compressEvents()}};c.prototype._compressEvents=function(){if(!1!==this._localStorageAvailable&&"undefined"!==typeof JSZip){var b=localStorage.getItem(this.STORAGE_TEXTFILE_NAME);if(null!=b){var b=this._decodeString(b),a;a=localStorage.getItem(this.STORAGE_ZIPFILE_NAME);
a=null!=a?new JSZip(this._decodeString(a)):new JSZip;a.file(this._generateGuid(),b);localStorage.removeItem(this.STORAGE_TEXTFILE_NAME);b=a.generate({compression:"DEFLATE",compressionOptions:{level:9},type:"string"});try{localStorage.setItem(this.STORAGE_ZIPFILE_NAME,this._encodeString(b)),this._localStorageAvailable=!0}catch(c){console.log(this.ERROR_MSG_LOCAL_STORAGE_EXCEPTION),this._localStorageAvailable=!1}}}};c.prototype._encodeString=function(b){return encodeURI(b)};c.prototype._decodeString=
function(b){return decodeURI(b)};c.prototype._sendDataToClientRelay=function(b){var a=this;if(!1!==this._enabled&&"undefined"!==typeof JSZip){this._compressEvents();var c=localStorage.getItem(this.STORAGE_ZIPFILE_NAME);null==c?a._resetDataTransmissionTimer(a):(c=(new JSZip(this._decodeString(c))).generate({compression:"DEFLATE",compressionOptions:{level:9}}),$.ajax({type:"POST",url:b,data:c,error:function(){9E5>=a._timerDuration?a._timerDuration*=2:18E5>a._timerDuration&&(a._timerDuration=18E5);a._resetDataTransmissionTimer(a)},
success:function(){localStorage.removeItem(a.STORAGE_ZIPFILE_NAME);a._localStorageAvailable=!0;a._timerDuration=a._transmissionInterval;a._resetDataTransmissionTimer(a)},processData:!1,contentType:"multipart/form-data"}))}};c.prototype._resetDataTransmissionTimer=function(b){clearInterval(b._dataTransmissionTimer);b._dataTransmissionTimer=null;b._dataTransmissionTimer=setTimeout(function(){b._sendDataToClientRelay(b._endpointUrl)},b._timerDuration)};c.prototype._getWorkstationId=function(){var b=
this.STORAGE_INSIGHT_GUID,a=localStorage.getItem(b);if("undefined"===typeof a||null==a)a=this._generateGuid(),localStorage.setItem(b,a);return a};c.prototype._generateGuid=function(){var b;b="undefined"!==typeof performance&&"undefined"!==typeof performance.now?performance.now():(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var c=(b+16*Math.random())%16|0;b=Math.floor(b/16);return("x"===a?c:c&3|8).toString(16)})};c.prototype._generateTimestamp=function(){if(Date.prototype.toISOString)return(new Date).toISOString();
(function(){function b(a){a=String(a);1===a.length&&(a="0"+a);return a}Date.prototype.toISOString=function(){return this.getUTCFullYear()+"-"+b(this.getUTCMonth()+1)+"-"+b(this.getUTCDate())+"T"+b(this.getUTCHours())+":"+b(this.getUTCMinutes())+":"+b(this.getUTCSeconds())+"."+String((this.getUTCMilliseconds()/1E3).toFixed(3)).slice(2,5)+"Z"}})()};return c}();d.EventRelay=m})(d.insight||(d.insight={}))})(geocortex||(geocortex={}));
