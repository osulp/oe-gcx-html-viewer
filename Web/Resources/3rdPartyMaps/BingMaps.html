<!DOCTYPE html>
<html>

<head>
    <title>Bing Maps</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <link href="3rdParty.css" rel="stylesheet" type="text/css" />
    <style>
        /* Bing's dashboard is on the right side and covers up the GVH linked maps controls */
        .integration-panel-actions {
            left: 0;
            right: auto;
        }
    </style>

    <script src="../Scripts/Bridge.js"></script>
    <script src="ThirdPartyMap.js"></script>
    <script type="text/javascript">
        var map;
        var currentZoom = 10;
        var isReady = false;

        /**
         * Gets the current position of the Bing map.
         */
        function getMapViewpointParams() {
            var pos = map.getCenter();
            var scale = thirdPartyMap.zoomLevelToScale(map.getZoom());

            return {
                center: {
                    x: pos.longitude,
                    y: pos.latitude
                },
                scale: scale,
                heading: map.getHeading()
            };
        }

        /**
         * Updates the Bing map to match the viewer.
         */
        function handleViewerPositionUpdatedEvent(arg) {
            if (!isReady) {
                // Add handlers after we have received our first position
                Microsoft.Maps.Events.addHandler(map, 'viewchangeend', function () {
                    thirdPartyMap.handleViewpointChanged();
                });
                isReady = true;
            }

            currentZoom = thirdPartyMap.scaleToZoomLevel(arg.scale);
            map.setView({
                center: new Microsoft.Maps.Location(arg.position.y, arg.position.x),
                zoom: currentZoom
            });
        }

        /**
         * Updates the Bing map to match the viewpoint indicator position.
         */
        function handleViewpointIndicatorUpdatedEvent(arg) {
            map.setView({
                animate: false,
                center: new Microsoft.Maps.Location(arg.y, arg.x)
            });
        }

        var thirdPartyMap = new geocortex.essentialsHtmlViewer.integration.ThirdPartyMap("bingMaps",
            initializeMap,
            getMapViewpointParams,
            handleViewerPositionUpdatedEvent,
            handleViewpointIndicatorUpdatedEvent);

        /**
         * Initializes the Bing map.
         */
        function initializeMap() {
            var bingApiKey = "";

            var location = new Microsoft.Maps.Location(0, 0);
            var mapOptions = {
                credentials: bingApiKey,
                center: location,
                mapTypeId: Microsoft.Maps.MapTypeId.birdseye,
                zoom: currentZoom
            };

            map = new Microsoft.Maps.Map(document.getElementById("map-container"), mapOptions);
        }
    </script>

    <script type="text/javascript" src="//www.bing.com/api/maps/mapcontrol?callback=initializeMap" async defer></script>
</head>

<body>
    <ul class="integration-panel-actions">
        <li class="panel-action-button">
            <button class="viewpoint-indicator viewpoint-indicator-bing" title="Viewpoint Indicator"></button>
        </li>
        <li class="panel-action-button">
            <button id="centerButton" class="center-map" title="Center this map to the viewer"></button>
        </li>
        <li class="panel-action-button">
            <button id="syncButton" class="sync-toggle-off" title="Synchronize Maps"></button>
        </li>
        <li class="panel-action-button">
            <button id="dockButton" class="window-popout" title="Open in new window"></button>
        </li>
        <li class="panel-action-button">
            <button id="closeButton" class="window-close" title="Close this map view"></button>
        </li>
    </ul>
    <div id="map-container" class="map-container"></div>
</body>

</html>
